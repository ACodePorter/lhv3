import{k as e,L as Nt,r as o,u as Lt,l as ea,E as ta,m as Oa,n as sa,B as Ya,o as Ra,p as dt,N as Ba,q as Ea,R as qa}from"./react-vendor-fc50561f.js";import{L as yt,M as Tt,B as A,G as Va,z as Yt,C as Ha,D as aa,F as ra,H as hs,I as ss,R as Ka,J as Ht,K as Rt,N as G,O as g,P as re,Q as le,T as Ua,U as Wa,V as Ga,W as Ja,X as mt,Y as It,Z as q,$ as Xt,a0 as M,a1 as be,a2 as L,a3 as ke,a4 as na,a5 as Ot,a6 as Kt,a7 as ze,a8 as Cs,a9 as ls,aa as je,ab as Me,ac as Mt,ad as Za,ae as h,af as Qa,ag as Xa,ah as er,ai as Ut,aj as tr,ak as la,al as oa,am as ms,an as ia,ao as xs,ap as fs,aq as gs,ar as ys,as as js,at as bs,au as sr,av as ar,aw as rr,ax as vs,ay as nr,az as _s,aA as kt,aB as nt,aC as lr,aD as ye,aE as Oe,aF as Bt,aG as es,aH as ca,aI as da,aJ as Ss,aK as ua,aL as wt,aM as ps,aN as or,aO as ws,aP as ir,aQ as zs,aR as cr,aS as dr,aT as pa,aU as ur,aV as Xe,aW as ha,aX as ma,aY as pr}from"./vendor-5bf346f2.js";import{M as hr}from"./monaco-ce22cc97.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const m of document.querySelectorAll('link[rel="modulepreload"]'))v(m);new MutationObserver(m=>{for(const _ of m)if(_.type==="childList")for(const $ of _.addedNodes)$.tagName==="LINK"&&$.rel==="modulepreload"&&v($)}).observe(document,{childList:!0,subtree:!0});function l(m){const _={};return m.integrity&&(_.integrity=m.integrity),m.referrerPolicy&&(_.referrerPolicy=m.referrerPolicy),m.crossOrigin==="use-credentials"?_.credentials="include":m.crossOrigin==="anonymous"?_.credentials="omit":_.credentials="same-origin",_}function v(m){if(m.ep)return;m.ep=!0;const _=l(m);fetch(m.href,_)}})();const xa={token:{colorPrimary:"#1890ff",borderRadius:8,colorBgContainer:"#ffffff",fontSize:12,fontSizeSM:11,fontSizeLG:14,fontSizeXL:16},components:{Table:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Card:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Button:{borderRadius:6,fontSize:12},Typography:{fontSize:12},Form:{fontSize:12},Input:{fontSize:12},Select:{fontSize:12},Menu:{fontSize:12}}},{Header:mr}=Yt,{useToken:xr}=Ha,fr=()=>{const{token:n}=xr(),r=[{key:"/",icon:e.jsx(aa,{}),label:e.jsx(Nt,{to:"/",children:"首页"})},{key:"/data",icon:e.jsx(ra,{}),label:e.jsx(Nt,{to:"/data",children:"数据管理"})},{key:"/strategy",icon:e.jsx(hs,{}),label:e.jsx(Nt,{to:"/strategy",children:"策略编辑"})},{key:"/backtest",icon:e.jsx(yt,{}),label:e.jsx(Nt,{to:"/backtest",children:"回测分析"})},{key:"/optimization",icon:e.jsx(ss,{}),label:e.jsx(Nt,{to:"/optimization",children:"参数优化"})}];return e.jsxs(mr,{style:{background:n.colorBgContainer,padding:"0 24px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx("div",{className:"header-nav-logo",children:e.jsxs(Nt,{to:"/",style:{color:n.colorPrimary,fontSize:"18px",fontWeight:"bold",display:"flex",alignItems:"center"},children:[e.jsx(yt,{style:{marginRight:"8px",fontSize:"24px"}}),"量化交易系统"]})}),e.jsx(Tt,{className:"header-nav-menu",mode:"horizontal",selectedKeys:[window.location.pathname],style:{flex:1,marginLeft:"40px",borderBottom:"none"},items:r}),e.jsx("div",{children:e.jsx(A,{icon:e.jsx(Va,{}),type:"text",href:"https://github.com/yourusername/quant-trading-system",target:"_blank",rel:"noopener noreferrer",children:"GitHub"})})]})},{Sider:gr}=Yt,yr=()=>{const[n,r]=o.useState(!1),l=Lt(),v=ea(),m=[{key:"/",icon:e.jsx(aa,{}),label:"首页"},{key:"/data",icon:e.jsx(ra,{}),label:"数据管理"},{key:"/strategy",icon:e.jsx(hs,{}),label:"策略编辑"},{key:"/ai-investment",icon:e.jsx(Ka,{}),label:"AI实时投资跑数"},{key:"backtest",icon:e.jsx(yt,{}),label:"回测管理",children:[{key:"/backtest",icon:e.jsx(yt,{}),label:"回测分析"},{key:"/backtest/history",icon:e.jsx(Ht,{}),label:"回测历史"}]},{key:"/optimization",icon:e.jsx(ss,{}),label:"参数优化"}],_=$=>{l($.key)};return e.jsxs(gr,{collapsible:!0,collapsed:n,onCollapse:$=>r($),style:{background:"#fff"},width:200,children:[e.jsx("div",{className:"logo",style:{visibility:n?"hidden":"visible"},children:"量化交易系统"}),e.jsx(Tt,{theme:"light",mode:"inline",selectedKeys:[v.pathname],items:m,onClick:_})]})};var jr=Object.defineProperty,br=Object.defineProperties,vr=Object.getOwnPropertyDescriptors,Ms=Object.getOwnPropertySymbols,_r=Object.prototype.hasOwnProperty,Sr=Object.prototype.propertyIsEnumerable,As=(n,r,l)=>r in n?jr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,Ls=(n,r)=>{for(var l in r||(r={}))_r.call(r,l)&&As(n,l,r[l]);if(Ms)for(var l of Ms(r))Sr.call(r,l)&&As(n,l,r[l]);return n},wr=(n,r)=>br(n,vr(r));const $t=o.memo(({option:n,loading:r=!1,height:l=400,lazyLoad:v=!0,threshold:m=.1,style:_,onChartReady:$,data:D,symbol:f,className:k,notMerge:F=!1,opts:J={renderer:"canvas"},onEvents:H})=>{const[he,$e]=o.useState(!v),[te,W]=o.useState(null),oe=o.useRef(null),b=o.useRef(null),U=o.useMemo(()=>(Z,Ie)=>{const Le=[];for(let ce=0,qe=Ie.length;ce<qe;ce++){if(ce<Z-1){Le.push("-");continue}let ee=0;for(let De=0;De<Z;De++)ee+=Ie[ce-De].close;Le.push((ee/Z).toFixed(2))}return Le},[]),y=o.useMemo(()=>!D||D.length===0?{}:{backgroundColor:"#fff",title:{text:f,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:D.map(Z=>Z.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:D.map(Z=>Z.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:D.map(Z=>[Z.open,Z.close,Z.low,Z.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:U(5,D),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:U(10,D),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:D.map((Z,Ie)=>[Ie,Z.volume,Z.close>Z.open?1:-1])}]},[D,f,U]),Ye=o.useMemo(()=>{const Z=n||y;return!Z||Object.keys(Z).length===0?{}:wr(Ls({},Z),{animation:!1,progressive:1e3,progressiveThreshold:3e3,useUTC:!0})},[n,y]);o.useEffect(()=>{if(!v||he)return;const Z=oe.current;if(Z)return b.current=new IntersectionObserver(Ie=>{var Le;const[ce]=Ie;ce.isIntersecting&&($e(!0),(Le=b.current)==null||Le.disconnect())},{threshold:m}),b.current.observe(Z),()=>{var Ie;(Ie=b.current)==null||Ie.disconnect()}},[v,he,m]);const me=Z=>{W(Z),$==null||$(Z)};return v&&!he?e.jsx("div",{ref:oe,style:Ls({height:l,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#fafafa",border:"1px dashed #d9d9d9"},_),children:e.jsxs("div",{style:{textAlign:"center",color:"#999"},children:[e.jsx("div",{children:"图表懒加载中..."}),e.jsx("div",{style:{fontSize:"12px",marginTop:"4px"},children:"滚动到此处将自动加载"})]})}):e.jsx("div",{ref:oe,style:_,children:e.jsx(Rt,{spinning:r,tip:"图表加载中...",children:e.jsx(ta,{className:k,option:Ye,style:{height:l},onChartReady:me,notMerge:F,opts:J,onEvents:H})})})});$t.displayName="OptimizedChart";const{Title:kr,Paragraph:$r}=It,Ir=o.memo(()=>{const n=o.useMemo(()=>[{name:"上证指数",value:3536.24,change:.84,color:"#f5222d"},{name:"深证成指",value:14672.16,change:1.26,color:"#f5222d"},{name:"创业板指",value:3213.84,change:1.78,color:"#f5222d"},{name:"恒生指数",value:26386.25,change:-.13,color:"#52c41a"}],[]),r=o.useMemo(()=>[{id:1,name:"移动平均交叉策略",symbol:"AAPL",return:12.5,date:"2023-09-15"},{id:2,name:"RSI策略",symbol:"MSFT",return:8.3,date:"2023-09-14"},{id:3,name:"MACD策略",symbol:"GOOGL",return:-2.1,date:"2023-09-13"},{id:4,name:"布林带策略",symbol:"AMZN",return:5.7,date:"2023-09-12"}],[]),l=o.useMemo(()=>({title:{text:"策略绩效比较",left:"center"},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{data:["移动平均交叉","RSI策略","MACD策略","布林带策略","沪深300"],bottom:10},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:["1月","2月","3月","4月","5月","6月","7月","8月","9月"]},yAxis:{type:"value",name:"累计收益率(%)",axisLabel:{formatter:"{value}%"}},series:[{name:"移动平均交叉",type:"line",data:[0,2.3,5.8,9.2,12.5,15.1,18.6,22.4,25.2]},{name:"RSI策略",type:"line",data:[0,1.5,3.8,6.2,8.5,10.1,12.6,14.4,16.2]},{name:"MACD策略",type:"line",data:[0,-1.3,1.8,3.2,5.5,8.1,10.6,13.4,15.2]},{name:"布林带策略",type:"line",data:[0,3.3,2.8,5.2,8.5,12.1,15.6,18.4,21.2]},{name:"沪深300",type:"line",data:[0,1.3,2.8,3.2,2.5,4.1,5.6,4.4,6.2],lineStyle:{type:"dashed"}}]}),[]),v=o.useMemo(()=>({title:{text:"最优资产配置",left:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:10,data:["股票","债券","商品","外汇","现金"]},series:[{name:"资产配置",type:"pie",radius:["50%","70%"],avoidLabelOverlap:!1,label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:"18",fontWeight:"bold"}},labelLine:{show:!1},data:[{value:45,name:"股票"},{value:25,name:"债券"},{value:15,name:"商品"},{value:10,name:"外汇"},{value:5,name:"现金"}]}]}),[]);return e.jsxs("div",{children:[e.jsx(kr,{level:2,children:"仪表盘"}),e.jsx($r,{children:"欢迎使用量化交易系统，您可以在这里查看市场概况和您的策略表现。"}),e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:6,children:e.jsx(re,{children:e.jsx(le,{title:"本月最佳策略",value:"移动平均交叉",prefix:e.jsx(Ua,{}),valueStyle:{color:"#3f8600"}})})}),e.jsx(g,{span:6,children:e.jsx(re,{children:e.jsx(le,{title:"最佳策略收益",value:25.2,precision:2,valueStyle:{color:"#3f8600"},prefix:e.jsx(Wa,{}),suffix:"%"})})}),e.jsx(g,{span:6,children:e.jsx(re,{children:e.jsx(le,{title:"最差策略收益",value:-2.1,precision:2,valueStyle:{color:"#cf1322"},prefix:e.jsx(Ga,{}),suffix:"%"})})}),e.jsx(g,{span:6,children:e.jsx(re,{children:e.jsx(le,{title:"策略总数",value:8,prefix:e.jsx(Ja,{})})})})]}),e.jsxs(G,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(g,{span:12,children:e.jsx(re,{title:"主要市场指数",extra:e.jsx(A,{type:"link",children:"查看更多"}),children:e.jsx(mt,{dataSource:n,renderItem:m=>e.jsxs(mt.Item,{children:[e.jsx(mt.Item.Meta,{title:m.name}),e.jsx("div",{children:m.value}),e.jsxs("div",{style:{color:m.color,marginLeft:"16px"},children:[m.change>0?"+":"",m.change,"%"]})]})})})}),e.jsx(g,{span:12,children:e.jsx(re,{title:"最近的回测",extra:e.jsx(A,{type:"link",children:"查看全部"}),children:e.jsx(mt,{dataSource:r,renderItem:m=>e.jsxs(mt.Item,{children:[e.jsx(mt.Item.Meta,{title:m.name,description:`${m.symbol} | ${m.date}`}),e.jsxs("div",{style:{color:m.return>0?"#3f8600":"#cf1322",fontWeight:"bold"},children:[m.return>0?"+":"",m.return,"%"]})]})})})})]}),e.jsxs(G,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(g,{span:16,children:e.jsx(re,{title:"策略绩效比较",extra:e.jsx(A,{type:"link",icon:e.jsx(yt,{}),children:"详细分析"}),children:e.jsx("div",{className:"chart-container",children:e.jsx($t,{option:l,style:{height:"100%"}})})})}),e.jsx(g,{span:8,children:e.jsx(re,{title:"最优资产配置",children:e.jsx("div",{className:"chart-container",children:e.jsx($t,{option:v,style:{height:"100%"}})})})})]})]})});var Dt=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});const as=()=>Dt(void 0,null,function*(){try{const n=yield q.get("/api/data/stocks");return n.data&&Array.isArray(n.data)?n.data.map(r=>({id:r.id.toString(),symbol:r.symbol,name:r.name,type:r.type||"未知",exchange:r.exchange,source_id:r.source_id,data_count:r.data_count||0,last_updated:r.last_updated,first_date:r.first_date,last_date:r.last_date})):[]}catch(n){throw console.error("获取交易品种列表失败:",n),n}}),fa=()=>Dt(void 0,null,function*(){try{const n=yield q.get("/api/data/list");return n.data&&Array.isArray(n.data)?n.data:[]}catch(n){throw console.error("获取数据源列表失败:",n),n}}),Dr=n=>Dt(void 0,null,function*(){try{const r=yield q.get(`/api/data/chart/${n}`);return r.data&&r.data.data?r.data:{data:[]}}catch(r){throw console.error("获取图表数据失败:",r),r}});function Cr(n){return Dt(this,null,function*(){try{console.log("保存策略数据:",JSON.stringify(n,null,2));let r;if(n.id?r=yield q.put(`/api/strategies/${n.id}`,n):r=yield q.post("/api/strategies",n),console.log("策略保存响应:",r.data),r.data&&r.data.status==="success")return r.data.data;if(r.data)return r.data;throw new Error("保存策略失败，返回数据格式错误")}catch(r){throw console.error("保存策略时发生错误:",r),r}})}const Vt=()=>Dt(void 0,null,function*(){try{const n=yield q.get("/api/strategies");return n.data&&n.data.data?n.data.data:[]}catch(n){throw console.error("获取策略列表失败:",n),n}}),Ns=n=>Dt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略数据")}catch(r){throw console.error(`获取策略(ID:${n})详情失败:`,r),r}}),ga=n=>Dt(void 0,null,function*(){try{yield q.delete(`/api/strategies/${n}`)}catch(r){throw console.error(`删除策略(ID:${n})失败:`,r),r}}),zr=n=>Dt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/templates/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略模板数据")}catch(r){throw console.error(`获取策略模板(ID:${n})详情失败:`,r),r}}),Mr=n=>Dt(void 0,null,function*(){try{const r=yield q.get(`/api/data/stock/${n}/date-range`);if(r.data)return r.data;throw new Error("未找到股票日期范围数据")}catch(r){throw console.error(`获取股票(ID:${n})日期范围失败:`,r),r}}),Ps=(n,r,l=30)=>{const v=new Date;v.setTime(v.getTime()+l*24*60*60*1e3),document.cookie=`${n}=${r};expires=${v.toUTCString()};path=/`},Fs=n=>{const r=n+"=",l=document.cookie.split(";");for(let v=0;v<l.length;v++){let m=l[v];for(;m.charAt(0)===" ";)m=m.substring(1,m.length);if(m.indexOf(r)===0)return m.substring(r.length,m.length)}return null},Je={setPageSize:n=>{Ps("data_management_page_size",n.toString())},getPageSize:(n=15)=>{const r=Fs("data_management_page_size");return r?parseInt(r,10):n},setCurrentPage:n=>{Ps("data_management_current_page",n.toString())},getCurrentPage:(n=1)=>{const r=Fs("data_management_current_page");return r?parseInt(r,10):n}};function Ar(n,r){const[l,v]=o.useState(n);return o.useEffect(()=>{const m=setTimeout(()=>{v(n)},r);return()=>{clearTimeout(m)}},[n,r]),l}var Lr=Object.defineProperty,Nr=Object.defineProperties,Pr=Object.getOwnPropertyDescriptors,ts=Object.getOwnPropertySymbols,ya=Object.prototype.hasOwnProperty,ja=Object.prototype.propertyIsEnumerable,Ts=(n,r,l)=>r in n?Lr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,Gt=(n,r)=>{for(var l in r||(r={}))ya.call(r,l)&&Ts(n,l,r[l]);if(ts)for(var l of ts(r))ja.call(r,l)&&Ts(n,l,r[l]);return n},Os=(n,r)=>Nr(n,Pr(r)),Fr=(n,r)=>{var l={};for(var v in n)ya.call(n,v)&&r.indexOf(v)<0&&(l[v]=n[v]);if(n!=null&&ts)for(var v of ts(n))r.indexOf(v)<0&&ja.call(n,v)&&(l[v]=n[v]);return l};const At=o.memo(n=>{var r=n,{virtualScroll:l=!1,itemHeight:v=54,maxHeight:m=400,dataSource:_=[],columns:$=[]}=r,D=Fr(r,["virtualScroll","itemHeight","maxHeight","dataSource","columns"]);const f=o.useMemo(()=>$.map(J=>Os(Gt({},J),{ellipsis:J.ellipsis!==!1})),[$]),k=o.useMemo(()=>_||[],[_]),F=o.useMemo(()=>Gt({size:"middle",scroll:{x:"max-content",y:m},pagination:Gt({showSizeChanger:!0,showQuickJumper:!0,showTotal:(J,H)=>`第 ${H[0]}-${H[1]} 条，共 ${J} 条`},D.pagination)},D),[m,D]);return e.jsx("div",{className:"optimized-table-container",children:e.jsx(Xt,Os(Gt({},F),{columns:f,dataSource:k,className:`optimized-table ${D.className||""}`}))})});At.displayName="OptimizedTable";var Tr=Object.defineProperty,Or=Object.defineProperties,Yr=Object.getOwnPropertyDescriptors,Ys=Object.getOwnPropertySymbols,Rr=Object.prototype.hasOwnProperty,Br=Object.prototype.propertyIsEnumerable,Rs=(n,r,l)=>r in n?Tr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,Bs=(n,r)=>{for(var l in r||(r={}))Rr.call(r,l)&&Rs(n,l,r[l]);if(Ys)for(var l of Ys(r))Br.call(r,l)&&Rs(n,l,r[l]);return n},Es=(n,r)=>Or(n,Yr(r)),ut=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});const{Title:Er,Text:qr}=It,{Option:lt}=Me,ba=o.memo(({onSelect:n})=>{const r=o.useMemo(()=>[{label:"最近7天",days:7},{label:"最近30天",days:30},{label:"最近90天",days:90},{label:"最近180天",days:180},{label:"最近1年",days:365},{label:"最近2年",days:730},{label:"最近3年",days:1095},{label:"最近4年",days:1460},{label:"最近5年",days:1825},{label:"最近10年",days:3650},{label:"今年",type:"year"},{label:"去年",type:"lastYear"},{label:"本月",type:"month"},{label:"上月",type:"lastMonth"}],[]),l=o.useCallback(v=>{const m=M();let _,$;v.type==="year"?(_=m.startOf("year").format("YYYY-MM-DD"),$=m.format("YYYY-MM-DD")):v.type==="lastYear"?(_=m.subtract(1,"year").startOf("year").format("YYYY-MM-DD"),$=m.subtract(1,"year").endOf("year").format("YYYY-MM-DD")):v.type==="month"?(_=m.startOf("month").format("YYYY-MM-DD"),$=m.format("YYYY-MM-DD")):v.type==="lastMonth"?(_=m.subtract(1,"month").startOf("month").format("YYYY-MM-DD"),$=m.subtract(1,"month").endOf("month").format("YYYY-MM-DD")):(_=m.subtract(v.days,"day").format("YYYY-MM-DD"),$=m.format("YYYY-MM-DD")),n(_,$)},[n]);return e.jsx(be,{wrap:!0,children:r.map((v,m)=>e.jsx(A,{size:"small",onClick:()=>l(v),children:v.label},m))})});ba.displayName="DateRangePresets";const qs=(n,r)=>{const l=[];for(let v=0,m=r.length;v<m;v++){if(v<n-1){l.push("-");continue}let _=0;for(let $=0;$<n;$++)_+=r[v-$].close;l.push((_/n).toFixed(2))}return l},va=o.memo(()=>{const[n,r]=o.useState([]),[l,v]=o.useState([]),[m,_]=o.useState(!1),[$,D]=o.useState(!1),[f,k]=o.useState([]),[F]=L.useForm(),[J,H]=o.useState("fetch"),[he,$e]=o.useState(!1),[te,W]=o.useState(!1),oe=o.useRef(!1),[b,U]=o.useState({current:Je.getCurrentPage(),pageSize:Je.getPageSize(),total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(x,p)=>`第 ${p[0]}-${p[1]} 条，共 ${x} 条`,pageSizeOptions:["10","15","20","50","100"]}),[y,Ye]=o.useState(!1),[me,Z]=o.useState(null),[Ie,Le]=o.useState([]),[ce,qe]=o.useState(!1),[ee,De]=o.useState("");Ar(ee,300);const pe=o.useCallback((...x)=>ut(void 0,[...x],function*(p=Je.getCurrentPage(),j=Je.getPageSize()){_(!0);try{const B=(yield as()).map(K=>{var Se;return{id:K.id.toString(),symbol:K.symbol,name:K.name,type:K.type||"未知",exchange:K.exchange,records:K.data_count||0,source:((Se=K.source_id)==null?void 0:Se.toString())||"未知",last_updated:K.last_updated?new Date(K.last_updated).toLocaleString():"未知",first_date:K.first_date||void 0,last_date:K.last_date||void 0}});U(K=>Es(Bs({},K),{current:p,pageSize:j,total:B.length})),r(B)}catch(Y){console.error("获取数据列表失败:",Y),h.error("获取数据列表失败，请检查网络连接")}finally{_(!1)}}),[]),Re=o.useCallback(()=>ut(void 0,null,function*(){try{const x=yield fa();if(v(x),J==="fetch"){const p=x.find(j=>j.name==="AkShare抓取");p&&F.setFieldsValue({source_id:p.id})}else if(J==="upload"){const p=x.find(j=>j.name==="用户上传");p&&F.setFieldsValue({source_id:p.id})}}catch(x){console.error("获取数据源列表失败:",x),h.error("获取数据源列表失败")}}),[J,F]),xt=o.useCallback(x=>{const{current:p,pageSize:j}=x;Je.setCurrentPage(p),Je.setPageSize(j),pe(p,j)},[pe]),Ze=o.useCallback(x=>ut(void 0,null,function*(){_(!0);try{const p=yield q.get(`/api/data/download/${x}`,{responseType:"blob"}),j=window.URL.createObjectURL(new Blob([p.data])),Y=document.createElement("a");Y.href=j;const B=p.headers["content-disposition"];let K="stock_data.csv";if(B){const Se=B.match(/filename="?(.+)"?/);Se&&Se.length===2&&(K=Se[1])}Y.setAttribute("download",K),document.body.appendChild(Y),Y.click(),document.body.removeChild(Y),h.success("数据下载成功")}catch(p){console.error("下载失败:",p),h.error("下载失败，请重试")}finally{_(!1)}}),[]),[Ce,Ne]=o.useState([]),Ve=o.useCallback((x,p)=>ut(void 0,null,function*(){var j,Y,B;Ne(K=>K.includes(x)?K:[...K,x]);try{const Se=(j=(yield q.post(`/api/data/update/${x}/async`)).data)==null?void 0:j.task_id;if(!Se){h.error("任务提交失败：未返回任务ID"),Ne(Te=>Te.filter(Ge=>Ge!==x));return}h.success(p?`${p}：更新任务已启动`:"更新任务已启动");const Ue=()=>ut(void 0,null,function*(){var Te,Ge;try{const We=yield q.get(`/api/data/update-tasks/${Se}`),t=(Te=We.data)==null?void 0:Te.status,a=(Ge=We.data)==null?void 0:Ge.message;t==="completed"?(h.success(a||(p?`${p} 更新完成`:"更新完成")),clearInterval(Fe),yield pe(b.current,b.pageSize),Ne(d=>d.filter(u=>u!==x))):t==="failed"&&(h.error(a||(p?`${p} 更新失败`:"更新失败")),clearInterval(Fe),Ne(d=>d.filter(u=>u!==x)))}catch(We){console.error("查询任务状态失败:",We)}}),Fe=window.setInterval(Ue,2e3)}catch(K){console.error("提交异步更新失败:",K);const Se=(B=(Y=K.response)==null?void 0:Y.data)==null?void 0:B.detail;h.error(Se||"提交异步更新失败"),Ne(Ue=>Ue.filter(Fe=>Fe!==x))}}),[pe,b.current,b.pageSize]),it=o.useMemo(()=>[{title:"代码",dataIndex:"symbol",key:"symbol",width:100},{title:"名称",dataIndex:"name",key:"name",width:120},{title:"类型",dataIndex:"type",key:"type",width:80,render:x=>e.jsx(ke,{color:"blue",children:x})},{title:"交易所",dataIndex:"exchange",key:"exchange",width:80},{title:"记录数",dataIndex:"records",key:"records",width:80,sorter:(x,p)=>x.records-p.records},{title:"数据时间范围",key:"date_range",width:200,render:(x,p)=>p.first_date&&p.last_date?e.jsx("div",{children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:[p.first_date," 至 ",p.last_date]})}):e.jsx("span",{style:{color:"#999"},children:"暂无数据"})},{title:"数据源",dataIndex:"source",key:"source",width:100},{title:"最后更新",dataIndex:"last_updated",key:"last_updated",width:150},{title:"操作",key:"action",width:360,render:(x,p)=>e.jsxs(be,{size:"small",children:[e.jsx(A,{type:"primary",icon:e.jsx(na,{}),size:"small",onClick:()=>Ze(p.id),children:"下载"}),e.jsx(A,{icon:e.jsx(yt,{}),size:"small",onClick:()=>at(p),children:"K线图"}),e.jsx(A,{icon:e.jsx(Ot,{}),size:"small",loading:Ce.includes(p.id),disabled:Ce.includes(p.id),onClick:()=>Ve(p.id,p.symbol),children:"更新"}),e.jsx(A,{danger:!0,icon:e.jsx(Kt,{}),size:"small",onClick:()=>et(p.id),children:"删除"})]})}],[Ve,Ce]),ft={onRemove:()=>{k([])},beforeUpload:x=>(Pe(x)&&k([x]),!1),fileList:f},et=o.useCallback(x=>ut(void 0,null,function*(){ze.confirm({title:"确认删除",content:"此操作将永久删除该数据，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>ut(void 0,null,function*(){var p;_(!0);try{const j=yield q.delete(`/api/data/delete/${x}`);j.data&&j.data.status==="success"?(h.success(j.data.message||"删除成功"),pe()):h.error(((p=j.data)==null?void 0:p.message)||"删除失败")}catch(j){console.error("删除失败:",j),h.error("删除失败，请重试")}finally{_(!1)}})})}),[pe]),at=o.useCallback(x=>ut(void 0,null,function*(){Z(x),Ye(!0),qe(!0);try{const p=yield Dr(x.id);console.log("API响应数据:",p);const j=p.data||p||[];console.log("处理后的数据:",j),Le(j)}catch(p){console.error("获取图表数据失败:",p),h.error("获取图表数据失败")}finally{qe(!1)}}),[]),Pe=x=>{const p=x.type==="text/csv"||x.name&&x.name.endsWith(".csv");return p||h.error("只能上传CSV文件!"),p},ct=x=>ut(void 0,null,function*(){var p,j,Y,B;if(f.length===0){h.error("请选择要上传的文件");return}const K=new FormData;K.append("file",f[0]);const Se=new URLSearchParams({symbol:x.symbol,name:x.name,type:x.type,source_id:((p=x.source_id)==null?void 0:p.toString())||""});x.exchange&&Se.append("exchange",x.exchange);const Ue=`/api/data/upload?${Se.toString()}`;_(!0);try{const Fe=yield q.post(Ue,K,{headers:{"Content-Type":"multipart/form-data"}});Fe.data&&Fe.data.status==="success"?(h.success(Fe.data.message||"上传成功"),D(!1),F.resetFields(),k([]),pe(b.current,b.pageSize)):h.error(((j=Fe.data)==null?void 0:j.message)||"上传失败")}catch(Fe){console.error("上传失败:",Fe);const Te=(B=(Y=Fe.response)==null?void 0:Y.data)==null?void 0:B.detail;Te?typeof Te=="object"?h.error(JSON.stringify(Te)):h.error(Te):h.error("上传失败，请重试")}finally{_(!1)}}),Ke=x=>ut(void 0,null,function*(){var p,j,Y;$e(!0);try{const B={symbol:x.symbol,name:x.name,type:x.type,source_id:x.source_id,start_date:x.start_date?x.start_date.format("YYYY-MM-DD"):void 0,end_date:x.end_date?x.end_date.format("YYYY-MM-DD"):void 0},K=yield q.post("/api/data/fetch",B,{headers:{"Content-Type":"application/json"}});K.data&&K.data.status==="success"?(h.success(K.data.message||"数据抓取成功"),D(!1),F.resetFields(),pe(b.current,b.pageSize)):h.error(((p=K.data)==null?void 0:p.message)||"数据抓取失败")}catch(B){console.error("数据抓取失败:",B);const K=(Y=(j=B.response)==null?void 0:j.data)==null?void 0:Y.detail;K?typeof K=="object"?h.error(JSON.stringify(K)):h.error(K):h.error("数据抓取失败，请重试")}finally{$e(!1)}}),I=o.useCallback(()=>{ze.confirm({title:"一键更新确认",content:"确定要更新所有股票的最新数据吗？此操作可能需要较长时间。",okText:"确定更新",cancelText:"取消",onOk:()=>ut(void 0,null,function*(){var x,p,j;W(!0);try{const B=(x=(yield q.post("/api/data/update-all/async")).data)==null?void 0:x.task_id;if(!B){h.error("任务提交失败：未返回任务ID"),W(!1);return}h.success("一键更新任务已启动");const K=()=>ut(void 0,null,function*(){var Ue,Fe,Te,Ge;try{const We=yield q.get(`/api/data/update-all-tasks/${B}`),t=(Ue=We.data)==null?void 0:Ue.status,a=(Fe=We.data)==null?void 0:Fe.message,d=(Te=We.data)==null?void 0:Te.processed,u=(Ge=We.data)==null?void 0:Ge.total;typeof d=="number"&&typeof u=="number"&&h.info(`一键更新进度：${d}/${u}`,1),t==="completed"?(clearInterval(Se),W(!1),h.success(a||"一键更新完成"),yield pe(b.current,b.pageSize)):t==="failed"&&(clearInterval(Se),W(!1),h.error(a||"一键更新失败"))}catch(We){console.error("查询一键更新任务状态失败:",We)}}),Se=window.setInterval(K,2e3)}catch(Y){console.error("一键更新任务提交失败:",Y);const B=(j=(p=Y.response)==null?void 0:p.data)==null?void 0:j.detail;h.error(B||"一键更新任务提交失败"),W(!1)}})})},[pe]);return o.useEffect(()=>{oe.current||(oe.current=!0,pe(),Re())},[pe,Re]),e.jsxs("div",{className:"data-management",children:[e.jsxs(re,{children:[e.jsxs(G,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[e.jsx(g,{children:e.jsx(Er,{level:4,children:"市场数据管理"})}),e.jsx(g,{children:e.jsxs(be,{children:[e.jsx(A,{type:"primary",icon:e.jsx(Cs,{}),onClick:()=>D(!0),children:"添加数据"}),e.jsx(A,{type:"primary",icon:e.jsx(Ot,{}),loading:te,onClick:I,style:{backgroundColor:"#52c41a",borderColor:"#52c41a"},children:"一键更新"}),e.jsx(A,{icon:e.jsx(Ot,{}),onClick:()=>pe(b.current,b.pageSize),children:"刷新列表"})]})})]}),e.jsx(Rt,{spinning:m,children:e.jsx(At,{columns:it,dataSource:n,rowKey:"id",bordered:!0,size:"middle",pagination:b,onChange:xt})})]}),e.jsxs(ze,{title:"市场数据管理",open:$,onCancel:()=>D(!1),footer:null,width:600,children:[e.jsx("div",{style:{marginBottom:20,textAlign:"center"},children:e.jsxs(ls.Group,{value:J,onChange:x=>{if(H(x.target.value),F.resetFields(),x.target.value==="fetch"){const p=l.find(j=>j.name==="AkShare抓取");p&&F.setFieldsValue({source_id:p.id})}else if(x.target.value==="upload"){const p=l.find(j=>j.name==="用户上传");p&&F.setFieldsValue({source_id:p.id})}},buttonStyle:"solid",children:[e.jsx(ls.Button,{value:"fetch",children:"自动抓取"}),e.jsx(ls.Button,{value:"upload",children:"手动上传"})]})}),e.jsxs(L,{form:F,layout:"vertical",onFinish:J==="fetch"?Ke:ct,children:[J==="fetch"&&e.jsxs(e.Fragment,{children:[e.jsx(L.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(je,{placeholder:"例如: AAPL, 600519, TSLA"})}),e.jsx(L.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(je,{placeholder:"例如: 苹果公司, 贵州茅台"})}),e.jsx(L.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Me,{placeholder:"选择类型",children:[e.jsx(lt,{value:"A股",children:"A股"}),e.jsx(lt,{value:"港股",children:"港股"}),e.jsx(lt,{value:"美股",children:"美股"}),e.jsx(lt,{value:"期货",children:"期货"}),e.jsx(lt,{value:"指数",children:"指数"}),e.jsx(lt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(L.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Me,{placeholder:"选择数据源",disabled:!0,children:l.filter(x=>x.name==="AkShare抓取").map(x=>e.jsx(lt,{value:x.id,children:x.name},x.id))})}),e.jsxs(L.Item,{label:"日期范围",children:[e.jsx(ba,{onSelect:(x,p)=>{F.setFieldsValue({start_date:M(x),end_date:M(p)})}}),e.jsxs(G,{gutter:8,children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"start_date",noStyle:!0,children:e.jsx(Mt,{placeholder:"选择开始日期",style:{width:"100%"},format:"YYYY-MM-DD"})})}),e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"end_date",noStyle:!0,children:e.jsx(Mt,{placeholder:"选择结束日期",style:{width:"100%"},format:"YYYY-MM-DD"})})})]})]}),e.jsx(L.Item,{children:e.jsxs(be,{children:[e.jsx(A,{type:"primary",htmlType:"submit",loading:he,icon:e.jsx(Ot,{}),children:"开始抓取"}),e.jsx(A,{onClick:()=>D(!1),children:"取消"})]})})]}),J==="upload"&&e.jsxs(e.Fragment,{children:[e.jsx(L.Item,{name:"file",label:"数据文件",rules:[{required:!0,message:"请选择要上传的CSV文件"}],children:e.jsxs(Za,Es(Bs({},ft),{children:[e.jsx(A,{icon:e.jsx(Cs,{}),children:"选择CSV文件"}),e.jsx(qr,{type:"secondary",style:{marginLeft:8},children:"仅支持CSV格式的数据文件"})]}))}),e.jsx(L.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(je,{placeholder:"例如: AAPL, 600000.SH"})}),e.jsx(L.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(je,{placeholder:"例如: 苹果公司, 浦发银行"})}),e.jsx(L.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Me,{placeholder:"选择类型",children:[e.jsx(lt,{value:"A股",children:"A股"}),e.jsx(lt,{value:"港股",children:"港股"}),e.jsx(lt,{value:"美股",children:"美股"}),e.jsx(lt,{value:"期货",children:"期货"}),e.jsx(lt,{value:"指数",children:"指数"}),e.jsx(lt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(L.Item,{name:"exchange",label:"交易所",children:e.jsx(je,{placeholder:"例如: NYSE, SSE"})}),e.jsx(L.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Me,{placeholder:"选择数据源",disabled:!0,children:l.filter(x=>x.name==="用户上传").map(x=>e.jsx(lt,{value:x.id,children:x.name},x.id))})}),e.jsx(L.Item,{children:e.jsxs(be,{children:[e.jsx(A,{type:"primary",htmlType:"submit",loading:m,children:"上传数据"}),e.jsx(A,{onClick:()=>D(!1),children:"取消"})]})})]})]})]}),e.jsx(ze,{title:me?`${me.name}(${me.symbol}) K线图`:"K线图",open:y,onCancel:()=>Ye(!1),footer:null,width:800,children:e.jsx(Rt,{spinning:ce,children:Ie.length>0?e.jsx("div",{style:{height:"500px",width:"100%"},children:e.jsx(ta,{option:{backgroundColor:"#fff",title:{text:me==null?void 0:me.symbol,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:Ie.map(x=>x.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:Ie.map(x=>x.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:Ie.map(x=>[x.open,x.close,x.low,x.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:qs(5,Ie),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:qs(10,Ie),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:Ie.map((x,p)=>[p,x.volume,x.close>x.open?1:-1])}]},style:{height:"100%",width:"100%"},opts:{renderer:"canvas"}})}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx("p",{children:"暂无数据可供显示"})})})})]})});va.displayName="DataManagement";var jt=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});const{Title:Vr,Paragraph:Hr}=It,{confirm:Kr}=ze,Ur=()=>{const n=ea();Lt();const[r,l]=o.useState("visual"),[v,m]=o.useState(`# 策略示例：移动平均线交叉策略
import pandas as pd
import numpy as np
import talib

def initialize(context):
    """初始化策略参数"""
    context.params = {
        'symbol': '000300.SH',
        'short_period': 20,
        'long_period': 60
    }

def handle_data(context, data):
    """处理每个交易日的数据"""
    params = context.params
    df = data[params['symbol']]
    
    # 计算移动平均线
    df['short_ma'] = talib.SMA(df['close'], timeperiod=params['short_period'])
    df['long_ma'] = talib.SMA(df['close'], timeperiod=params['long_period'])
    
    # 生成交易信号
    df['signal'] = 0
    # 短均线上穿长均线，买入信号
    df.loc[(df['short_ma'] > df['long_ma']) & (df['short_ma'].shift(1) <= df['long_ma'].shift(1)), 'signal'] = 1
    # 短均线下穿长均线，卖出信号
    df.loc[(df['short_ma'] < df['long_ma']) & (df['short_ma'].shift(1) >= df['long_ma'].shift(1)), 'signal'] = -1
    
    return df['signal']
`),[_]=L.useForm(),[$,D]=o.useState([]),[f,k]=o.useState(!1),[F,J]=o.useState(null);o.useState(!1);const[H,he]=o.useState([]),[$e,te]=o.useState(!1),[W,oe]=o.useState(""),[b,U]=o.useState([]),[y,Ye]=o.useState(!1),[me,Z]=o.useState([{label:"移动平均线交叉策略",value:"ma_cross"},{label:"布林带策略",value:"bbands"},{label:"RSI策略",value:"rsi"},{label:"MACD策略",value:"macd"},{label:"趋势跟踪策略",value:"trend_following"},{label:"双均线策略",value:"dual_ma"}]),[Ie,Le]=o.useState({}),[ce,qe]=o.useState(!1),[ee,De]=o.useState(!1),pe=()=>new URLSearchParams(n.search).get("id"),[Re,xt]=o.useState(!1);o.useEffect(()=>{(()=>jt(void 0,null,function*(){if(Re){const j=pe();j&&(!F||F.id!==j)&&(yield Ce(j));return}xt(!0);try{yield Promise.all([Ne(),ft()]),yield Ze()}catch(j){console.error("初始化数据加载失败:",j),h.error("数据加载失败，请刷新页面重试")}}))()},[n.search,Re]);const Ze=()=>jt(void 0,null,function*(){if(!$e){te(!0);try{const j=(yield Vt()).filter(B=>!B.is_template);he(j),console.log("加载到策略列表:",j.length,"个策略");const Y=pe();Y?(!F||F.id!==Y)&&(yield Ce(Y)):j.length>0&&!F&&(yield Ve(j[0]))}catch(p){console.error("获取策略列表失败:",p),h.error("获取策略列表失败")}finally{te(!1)}}}),Ce=p=>jt(void 0,null,function*(){const j={strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"};if(p)try{k(!0);const Y=yield Ns(p);J(Y),Y.code&&(l("code"),m(Y.code));const B={strategyName:Y.name,description:Y.description,template:Y.template||"ma_cross"};Y.parameters&&(console.log("加载策略参数:",Y.parameters),Object.assign(B,Y.parameters)),console.log("设置表单值:",B),_.setFieldsValue(B)}catch(Y){console.error("加载策略详情失败:",Y),h.error("加载策略详情失败"),_.setFieldsValue(j)}finally{k(!1)}else _.setFieldsValue(j)}),Ne=()=>jt(void 0,null,function*(){if($.length>0)return $;k(!0);try{const p=yield as();return D(p),p}catch(p){console.error("获取股票列表失败:",p)}finally{k(!1)}return[]}),Ve=p=>jt(void 0,null,function*(){if(p.id)try{k(!0);const j=yield Ns(p.id);J(j),j.code?(l("code"),m(j.code)):l("visual");const Y={strategyName:j.name,description:j.description,template:j.template||"ma_cross"};j.parameters&&(console.log("加载策略参数:",j.parameters),Object.assign(Y,j.parameters)),console.log("设置表单值:",Y),_.setFieldsValue(Y),window.history.replaceState(null,"",`?id=${p.id}`)}catch(j){console.error("加载策略详情失败:",j),h.error("加载策略详情失败")}finally{k(!1)}}),it=p=>{Kr({title:"确定要删除这个策略吗?",icon:e.jsx(tr,{}),content:"此操作不可撤销，删除后数据将无法恢复。",okText:"是的，删除",okType:"danger",cancelText:"取消",onOk(){return jt(this,null,function*(){try{yield ga(p.id),h.success("策略删除成功"),F&&F.id===p.id&&(J(null),_.resetFields(),_.setFieldsValue({strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"}),window.history.replaceState(null,"",window.location.pathname)),$e||jt(this,null,function*(){const B=(yield Vt()).filter(K=>!K.is_template);he(B)})}catch(j){console.error("删除策略失败:",j),h.error("删除策略失败")}})}})};H.filter(p=>{var j,Y;return((j=p.name)==null?void 0:j.toLowerCase().includes(W.toLowerCase()))||((Y=p.description)==null?void 0:Y.toLowerCase().includes(W.toLowerCase()))});const ft=()=>jt(void 0,null,function*(){if(me.length>0&&me[0].value!=="ma_cross")return me;try{const j=(yield Vt()).filter(Y=>Y.is_template).map(Y=>({label:Y.name,value:Y.id}));if(j.length>0)return Z(j),j}catch(p){console.error("获取策略模板失败:",p)}return me}),et=p=>jt(void 0,null,function*(){try{const j=yield zr(p);j&&(_.setFieldsValue({name:`自定义${j.name}`,description:j.description,code:j.code}),j.parameters&&Le(j.parameters),h.success("模板加载成功"))}catch{h.error("加载模板失败")}}),at=p=>{et(p)},Pe={name:"",description:"",code:""},ct=p=>{qe(!0),Cr(p).then(j=>jt(void 0,null,function*(){if(h.success("策略保存成功"),j&&(J(j),window.history.replaceState(null,"",`?id=${j.id}`),!$e)){const B=(yield Vt()).filter(K=>!K.is_template);he(B)}})).catch(j=>{h.error("保存策略失败: "+j.message)}).finally(()=>{qe(!1)})},Ke=()=>{De(!0),setTimeout(()=>{h.success("策略测试成功"),De(!1)},1500)},I=p=>{_.resetFields(),h.success("已重置为"+p+"模板")},x=()=>[{key:"mine",label:"我的策略",children:e.jsx(mt,{itemLayout:"horizontal",dataSource:H,loading:$e,renderItem:p=>e.jsx(mt.Item,{className:"strategy-list-item",actions:[e.jsx(A,{type:"link",size:"small",onClick:()=>Ve(p),children:"编辑"},"edit"),e.jsx(A,{type:"link",danger:!0,size:"small",onClick:()=>it(p),children:"删除"},"delete")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:p.name}),e.jsx("div",{className:"strategy-desc",children:p.description})]})})})},{key:"templates",label:"策略模板",children:e.jsx(mt,{itemLayout:"horizontal",dataSource:b,loading:y,renderItem:p=>e.jsx(mt.Item,{className:"strategy-list-item",actions:[e.jsx(A,{type:"link",size:"small",onClick:()=>at(p.id),children:"使用"},"use")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:p.name}),e.jsx("div",{className:"strategy-desc",children:p.description})]})})})}];return e.jsxs("div",{className:"strategy-builder",children:[e.jsxs("div",{className:"page-header",style:{marginBottom:"20px"},children:[e.jsx(Vr,{level:2,children:"策略构建器"}),e.jsx(Hr,{children:"创建和测试您的交易策略"})]}),e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:18,children:e.jsx(re,{title:"策略编辑器",bordered:!1,className:"editor-card",children:e.jsxs(L,{form:_,layout:"vertical",initialValues:Pe,onFinish:ct,children:[e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"name",label:"策略名称",rules:[{required:!0,message:"请输入策略名称"},{max:50,message:"策略名称不能超过50个字符"}],children:e.jsx(je,{placeholder:"请输入策略名称"})})}),e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"description",label:"策略描述",rules:[{max:200,message:"策略描述不能超过200个字符"}],children:e.jsx(je.TextArea,{placeholder:"请输入策略描述",autoSize:{minRows:1,maxRows:3}})})})]}),e.jsx(L.Item,{name:"code",label:"策略代码",rules:[{required:!0,message:"请输入策略代码"}],children:e.jsx(Oa,{height:"450px",extensions:[Qa()],onChange:p=>_.setFieldsValue({code:p})})}),e.jsx(L.Item,{children:e.jsxs(be,{children:[e.jsx(A,{type:"primary",htmlType:"submit",loading:ce,children:"保存策略"}),e.jsx(A,{type:"default",onClick:Ke,loading:ee,children:"测试策略"}),e.jsx(Xa,{overlay:e.jsxs(Tt,{children:[e.jsx(Tt.Item,{onClick:()=>I("basic"),children:"基础策略模板"},"basic"),e.jsx(Tt.Item,{onClick:()=>I("technical"),children:"技术指标策略"},"technical"),e.jsx(Tt.Item,{onClick:()=>I("empty"),children:"空白策略"},"empty")]}),children:e.jsxs(A,{children:["重置模板 ",e.jsx(er,{})]})})]})})]})})}),e.jsx(g,{span:6,children:e.jsx(re,{title:"策略库",bordered:!1,className:"strategy-library-card",style:{marginBottom:"16px",height:"300px"},children:e.jsx(Ut,{defaultActiveKey:"mine",items:x()})})})]})]})};var _t=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});const St="http://localhost:8001/api",Wr=n=>_t(void 0,null,function*(){var r;try{const l={};n&&(l.name=n);const v=yield q.get(`${St}/strategies`,{params:l});if(v.data&&v.data.status==="success")return v.data.data||[];throw new Error(((r=v.data)==null?void 0:r.message)||"获取策略列表失败")}catch(l){return h.error(`获取策略列表错误: ${l.message}`),[]}}),Gr=n=>_t(void 0,null,function*(){var r;try{const l=yield q.get(`${St}/strategies/${n}`);if(l.data&&l.data.status==="success")return l.data.data;throw new Error(((r=l.data)==null?void 0:r.message)||"获取策略详情失败")}catch(l){return h.error(`获取策略详情错误: ${l.message}`),null}}),Jr=n=>_t(void 0,null,function*(){var r;try{const l=yield q.post(`${St}/strategies`,n);if(l.data&&l.data.status==="success")return h.success("策略创建成功"),l.data.data;throw new Error(((r=l.data)==null?void 0:r.message)||"创建策略失败")}catch(l){return h.error(`创建策略错误: ${l.message}`),null}}),Zr=(n,r)=>_t(void 0,null,function*(){var l;try{const v=yield q.put(`${St}/strategies/${n}`,r);if(v.data&&v.data.status==="success")return h.success("策略更新成功"),v.data.data;throw new Error(((l=v.data)==null?void 0:l.message)||"更新策略失败")}catch(v){return h.error(`更新策略错误: ${v.message}`),null}}),Qr=(n,r,l)=>_t(void 0,null,function*(){var v;try{const m={code:n,data:r||[],parameters:l||{}},_=yield q.post(`${St}/strategies/test`,m);if(_.data&&_.data.status==="success")return _.data.data;throw new Error(((v=_.data)==null?void 0:v.message)||"测试策略失败")}catch(m){return h.error(`测试策略错误: ${m.message}`),{error:m.message}}}),Vs=(n,r,l,v,...m)=>_t(void 0,[n,r,l,v,...m],function*(_,$,D,f,k=1e5,F={},J=.0015,H=.001,he="database",$e=[]){var te;try{const W={strategy_id:_,symbol:$,start_date:D,end_date:f,initial_capital:k,parameters:F,commission_rate:J,slippage_rate:H,data_source:he,features:$e},oe=yield q.post(`${St}/strategies/backtest`,W);if(oe.data&&oe.data.status==="success")return oe.data.data;throw new Error(((te=oe.data)==null?void 0:te.message)||"策略回测失败")}catch(W){return h.error(`策略回测错误: ${W.message}`),{error:W.message}}}),Xr=(n,r,l,v,...m)=>_t(void 0,[n,r,l,v,...m],function*(_,$,D,f,k=1e5,F={},J=.0015,H=.001,he="database",$e=[]){var te;try{const W={strategy_id:_,symbol:$,start_date:D,end_date:f,initial_capital:k,parameters:F,commission_rate:J,slippage_rate:H,data_source:he,features:$e,force_refresh:!0},oe=yield q.post(`${St}/strategies/backtest`,W);if(oe.data&&oe.data.status==="success")return oe.data.data;throw new Error(((te=oe.data)==null?void 0:te.message)||"策略回测失败")}catch(W){return h.error(`策略回测错误: ${W.message}`),{error:W.message}}}),en=(n,r,l,v,...m)=>_t(void 0,[n,r,l,v,...m],function*(_,$,D,f,k=1e5,F={},J=.0015,H=.001,he="database",$e=[],te="normal"){var W;try{const oe=te==="high"?1:0,b={strategy_id:_.toString(),symbol:$,start_date:D,end_date:f,initial_capital:k,parameters:F,commission_rate:J,slippage_rate:H,data_source:he,features:$e,priority:oe},U=yield q.post(`${St}/async/backtest/submit`,b);if(U.data&&U.data.task_id)return U.data;throw new Error(((W=U.data)==null?void 0:W.message)||"提交异步回测任务失败")}catch(oe){throw h.error(`提交异步回测任务错误: ${oe.message}`),oe}}),tn=n=>_t(void 0,null,function*(){try{return(yield q.get(`${St}/async/backtest/status/${n}`)).data}catch(r){throw h.error(`获取任务状态错误: ${r.message}`),r}}),sn=n=>_t(void 0,null,function*(){try{return(yield q.get(`${St}/async/backtest/result/${n}`)).data}catch(r){throw h.error(`获取回测结果错误: ${r.message}`),r}});var an=Object.defineProperty,rn=Object.defineProperties,nn=Object.getOwnPropertyDescriptors,Hs=Object.getOwnPropertySymbols,ln=Object.prototype.hasOwnProperty,on=Object.prototype.propertyIsEnumerable,Ks=(n,r,l)=>r in n?an(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,Jt=(n,r)=>{for(var l in r||(r={}))ln.call(r,l)&&Ks(n,l,r[l]);if(Hs)for(var l of Hs(r))on.call(r,l)&&Ks(n,l,r[l]);return n},Zt=(n,r)=>rn(n,nn(r)),gt=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});M.extend(la);M.extend(oa);M.tz.setDefault("Asia/Shanghai");ms([xs,fs,gs,ys,js,bs,sr,ar,rr,vs,nr,_s]);ia.locale("zh-cn");const{Title:cn,Paragraph:dn}=It,{Option:Pt}=Me,un=()=>{var n;const r=Lt(),[l,v]=o.useState(!1),[m,_]=o.useState(!1),[$,D]=o.useState(1e5),[f,k]=o.useState(.15),[F,J]=o.useState(.1),[H,he]=o.useState([]),[$e,te]=o.useState(!1),[W,oe]=o.useState(1),[b,U]=o.useState("MA交叉策略"),[y,Ye]=o.useState(null),[me,Z]=o.useState([M().subtract(1,"year").startOf("day"),M().endOf("day")]),[Ie,Le]=o.useState([]),[ce,qe]=o.useState([]),[ee,De]=o.useState([]),[pe,Re]=o.useState([]),[xt,Ze]=o.useState([]),[Ce,Ne]=o.useState({totalReturn:0,annualReturn:0,sharpeRatio:0,maxDrawdown:0,winRate:0,profitFactor:0,alpha:0,beta:0}),[Ve,it]=o.useState([]),[ft,et]=o.useState(null),[at,Pe]=o.useState([]),[ct,Ke]=o.useState([]),I=o.useRef(null),x=o.useRef(!1),[p,j]=o.useState({}),[Y,B]=o.useState(!1),[K,Se]=o.useState([]),[Ue,Fe]=o.useState(null),[Te,Ge]=o.useState(!1),[We,t]=o.useState([]),[a,d]=o.useState(!1),[u,C]=o.useState(!1),[z,P]=o.useState(""),[X,se]=o.useState(""),[S,de]=o.useState(!1),[ve,ie]=o.useState(null),[_e,R]=o.useState(""),[Q,Ae]=o.useState(0),[He,rt]=o.useState(null),ue=s=>typeof s!="string"?String(s):s.includes("T")?s.split("T")[0]:s.includes(" ")?s.split(" ")[0]:/^\d{4}-\d{2}-\d{2}$/.test(s)?s:s.substring(0,10),Qe=o.useCallback(s=>{if(!s||s.length===0)return[];const w=s.map((c,O)=>({key:O.toString(),date:ue(c.date),symbol:(y==null?void 0:y.symbol)||"",direction:c.action==="BUY"?"买入":"卖出",entryPrice:c.action==="BUY"?c.price:void 0,exitPrice:c.action==="SELL"?c.price:void 0,shares:c.shares,value:c.value,profitLoss:c.profit||0,returnPct:(c.profit_percent||0)*100,duration:c.holding_days||0,beforeCash:c.before_cash,afterCash:c.after_cash,beforeEquity:c.before_equity,afterEquity:c.after_equity,trigger_reason:c.trigger_reason,available_capital:c.available_capital,allocated_capital:c.allocated_capital,position_size:c.position_size,cumulative_position_ratio:c.cumulative_position_ratio,currentShares:0,currentAvgCost:0})).slice().sort((c,O)=>new Date(c.date).getTime()-new Date(O.date).getTime());let N=0,ae=0;return w.forEach(c=>{if(c.direction==="买入"){const O=c.entryPrice||0;ae+=c.shares*O,N+=c.shares}else if(c.direction==="卖出"){if(N>0){const O=c.shares/N;ae*=1-O}N-=c.shares}c.currentShares=N,c.currentAvgCost=N>0?ae/N:0}),w.sort((c,O)=>new Date(O.date).getTime()-new Date(c.date).getTime())},[y]),rs=()=>gt(void 0,null,function*(){var s,i;if(!ft||!m){h.error("没有可保存的回测结果");return}if(!z.trim()){h.error("请输入回测名称");return}C(!0);try{const w=me[0].format("YYYY-MM-DD"),N=me[1].format("YYYY-MM-DD"),ae=yield Vs(W,y.symbol,w,N,$,{save_backtest:!0,backtest_name:z,backtest_description:X,parameters:p},f,F,"database",[]);if(ae.error){h.error(`保存失败: ${ae.error}`);return}ae.saved?(h.success("回测保存成功！"),d(!1),P(""),se(""),ze.confirm({title:"保存成功",content:"回测已成功保存，是否查看回测历史？",okText:"查看历史",cancelText:"继续回测",onOk:()=>{r("/backtest/history")}})):h.error("保存失败，请重试")}catch(w){console.error("保存回测失败:",w),h.error(((i=(s=w.response)==null?void 0:s.data)==null?void 0:i.detail)||"保存失败，请重试")}finally{C(!1)}}),Et=o.useCallback(()=>{console.log("清理轮询定时器，当前pollingIntervalRef.current:",Be.current),Be.current&&(clearInterval(Be.current),Be.current=null,rt(null),console.log("轮询定时器已清理"))},[]);o.useEffect(()=>()=>{Be.current&&(clearInterval(Be.current),Be.current=null)},[]);const Be=o.useRef(null),ks=o.useCallback(s=>gt(void 0,null,function*(){try{const i=yield tn(s);if(console.log("任务状态:",i),R(i.status),Ae(i.progress||0),i.status==="completed"){console.log("任务已完成，准备清理轮询"),Be.current&&(console.log("立即清理轮询定时器，ID:",Be.current),clearInterval(Be.current),Be.current=null,rt(null));try{let w;if(i.result&&Object.keys(i.result).length>0?(console.log("从状态响应中获取结果，避免额外请求"),w=i.result):(console.log("状态响应中无结果，发起结果请求"),w=yield sn(s)),console.log("异步回测结果:",w),w&&w.status==="error")console.error("回测执行失败:",w.message),h.error(`回测失败: ${w.message}`);else{const N=w.data||w;console.log("提取的回测数据:",N),ns(N),h.success("异步回测完成")}}catch(w){console.error("获取回测结果失败:",w),h.error(`获取回测结果失败: ${w.message}`)}te(!1),ie(null)}else i.status==="failed"&&(console.log("任务失败，准备清理轮询"),Be.current&&(console.log("立即清理轮询定时器，ID:",Be.current),clearInterval(Be.current),Be.current=null,rt(null)),te(!1),ie(null),h.error(`异步回测失败: ${i.error||"未知错误"}`))}catch(i){console.error("获取任务状态失败:",i)}}),[]),ns=o.useCallback(s=>{var i,w,N,ae;if(s.error){h.error(`回测失败: ${s.error}`);return}if(console.log("回测结果:",s),console.log("回测结果关键字段:"),console.log("- total_return:",s.total_return),console.log("- annual_return:",s.annual_return),console.log("- sharpe_ratio:",s.sharpe_ratio),console.log("- max_drawdown:",s.max_drawdown),console.log("- win_rate:",s.win_rate),console.log("- profit_factor:",s.profit_factor),console.log("- trades 数量:",(i=s.trades)==null?void 0:i.length),console.log("- equity_curve 数量:",(w=s.equity_curve)==null?void 0:w.length),console.log("- drawdowns 数量:",(N=s.drawdowns)==null?void 0:N.length),s.trades||(s.trades=[],console.warn("未找到交易记录，设置为空数组")),s.equity_curve||(s.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),s.drawdowns||(s.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),Ne({totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0,alpha:(s.alpha||0)*100,beta:s.beta||0}),console.log("处理后的性能指标:",{totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0}),et(s),s.trades&&s.trades.length>0){const we=Qe(s.trades);qe(we),Pe(we)}else qe([]),Pe([]);if(s.equity_curve&&s.equity_curve.length>0){console.log("处理权益曲线数据:",s.equity_curve[0]);const we=s.equity_curve.map(O=>({date:ue(O.date),equity:O.equity}));Re(we),Ke(we);const c=s.equity_curve.map(O=>{const xe=ue(O.date),fe=Number(O.open)||0,E=Number(O.close)||0,T=Number(O.low)||0,V=Number(O.high)||0,ne=Number(O.volume)||0;return[xe,fe,E,T,V,ne]});console.log("K线数据示例(前3条):",c.slice(0,3)),De(c)}else Re([]),Ke([]),De([]);if(s.drawdowns&&s.drawdowns.length>0){const we=s.drawdowns.map(c=>({date:ue(c.date),drawdown:(c.drawdown||0)*100}));Ze(we)}else Ze([]);_(!0),(ae=I.current)==null||ae.scrollIntoView({behavior:"smooth"})},[ue,y]),_a=o.useCallback(()=>gt(void 0,null,function*(){if(!W||!y||!me[0]||!me[1]){h.error("请选择策略、交易品种和回测周期");return}te(!0),et(null),_(!1);try{const s=me[0].format("YYYY-MM-DD"),i=me[1].format("YYYY-MM-DD");if(S){console.log("使用异步模式提交回测任务");const w=yield en(W,y.symbol,s,i,$,{save_backtest:!1,parameters:p},f,F,"database",[],"normal");console.log("异步任务提交成功:",w),ie(w.task_id),R("pending"),Ae(0);const N=setInterval(()=>{ks(w.task_id)},2e3);Be.current=N,rt(N),h.info("回测任务已提交，正在后台执行...")}else{console.log("使用同步模式执行回测");const w=yield Vs(W,y.symbol,s,i,$,{save_backtest:!1,parameters:p},f,F,"database",[]);ns(w),(()=>{h.success("回测完成")})(),te(!1)}}catch(s){console.error("回测执行失败:",s),h.error(`回测失败: ${s.message||"未知错误"}`),te(!1),ie(null),Et()}}),[W,y,me,$,f,F,p,S,ns,ks,Et]),Sa=o.useCallback(()=>gt(void 0,null,function*(){var s,i,w,N;if(!W||!y||!me[0]||!me[1]){h.error("请选择策略、交易品种和回测周期");return}te(!0),et(null),_(!1);try{const ae=me[0].format("YYYY-MM-DD"),we=me[1].format("YYYY-MM-DD"),c=yield Xr(W,y.symbol,ae,we,$,{save_backtest:!1,parameters:p},f,F,"database",[]);if(c.error){h.error(`强制刷新回测失败: ${c.error}`);return}if(console.log("强制刷新回测结果:",c),console.log("回测结果关键字段:"),console.log("- total_return:",c.total_return),console.log("- annual_return:",c.annual_return),console.log("- sharpe_ratio:",c.sharpe_ratio),console.log("- max_drawdown:",c.max_drawdown),console.log("- win_rate:",c.win_rate),console.log("- profit_factor:",c.profit_factor),console.log("- trades 数量:",(s=c.trades)==null?void 0:s.length),console.log("- equity_curve 数量:",(i=c.equity_curve)==null?void 0:i.length),console.log("- drawdowns 数量:",(w=c.drawdowns)==null?void 0:w.length),c.trades||(c.trades=[],console.warn("未找到交易记录，设置为空数组")),c.equity_curve||(c.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),c.drawdowns||(c.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),Ne({totalReturn:(c.total_return||0)*100,annualReturn:(c.annual_return||0)*100,sharpeRatio:c.sharpe_ratio||0,maxDrawdown:(c.max_drawdown||0)*100,winRate:(c.win_rate||0)*100,profitFactor:c.profit_factor||0,alpha:(c.alpha||0)*100,beta:c.beta||0}),console.log("处理后的性能指标:",{totalReturn:(c.total_return||0)*100,annualReturn:(c.annual_return||0)*100,sharpeRatio:c.sharpe_ratio||0,maxDrawdown:(c.max_drawdown||0)*100,winRate:(c.win_rate||0)*100,profitFactor:c.profit_factor||0}),et(c),c.trades&&c.trades.length>0){const xe=Qe(c.trades);qe(xe),Pe(xe)}else qe([]),Pe([]);if(c.equity_curve&&c.equity_curve.length>0){console.log("处理权益曲线数据:",c.equity_curve[0]);const xe=c.equity_curve.map(E=>({date:ue(E.date),equity:E.equity}));Re(xe),Ke(xe);const fe=c.equity_curve.map(E=>{const T=ue(E.date),V=Number(E.open)||0,ne=Number(E.close)||0,ge=Number(E.low)||0,tt=Number(E.high)||0,ot=Number(E.volume)||0;return[T,V,ne,ge,tt,ot]});console.log("K线数据示例(前3条):",fe.slice(0,3)),De(fe)}else Re([]),Ke([]),De([]);if(c.drawdowns&&c.drawdowns.length>0){const xe=c.drawdowns.map(fe=>({date:ue(fe.date),drawdown:(fe.drawdown||0)*100}));Ze(xe)}else Ze([]);_(!0),(N=I.current)==null||N.scrollIntoView({behavior:"smooth"}),(()=>{h.success("强制刷新回测完成")})()}catch(ae){console.error("强制刷新回测执行失败:",ae),h.error(`强制刷新回测失败: ${ae.message||"未知错误"}`)}finally{te(!1)}}),[W,y,me,$,f,F,ue,qe,Pe,De,Re,Ke,Ze,_,et,Ne,te]),wa=()=>{const s=y?`${y.name} (${y.symbol}) K线图与交易信号`:"K线图与交易信号";let i=[],w=[];if(!ee||ee.length===0)return console.warn("K线数据为空，无法生成图表"),{title:{text:s,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};if(ce.length>0&&ee.length>0){if(console.log("准备标记交易信号，总交易记录：",ce.length),console.log("K线数据样本:",ee.slice(0,3)),ee.length>0){const E=ee[0][0];console.log("K线日期格式示例:",{original:E,type:typeof E,split:typeof E=="string"?E.split("T"):null})}if(ce.length>0){const E=ce[0].date;console.log("交易记录日期格式示例:",{original:E,type:typeof E,split:typeof E=="string"?E.split("T"):null,split2:typeof E=="string"?E.split(" "):null})}const c=new Map,O=new Map;ee.forEach((E,T)=>{const V=ue(E[0]);c.set(V,T),O.set(V,[Number(E[1]),Number(E[2]),Number(E[3]),Number(E[4])])}),console.log("日期索引映射创建完成，共计:",c.size),console.log("日期映射示例:",Array.from(c.entries()).slice(0,3));const xe=ce.filter(E=>E.direction==="买入");console.log("买入记录:",xe.length),i=xe.map(E=>{const T=ue(E.date),V=c.get(T),ne=E.entryPrice||0;return V===void 0||ne<=0?(console.warn(`未找到买入日期 ${T} 对应的K线索引或价格无效`),null):(console.log(`买入日期匹配成功: ${T} -> 索引 ${V}, 价格 ${ne}`),{name:"买入",value:[V,ne],xAxis:V,yAxis:ne,itemStyle:{color:"#f64034"}})}).filter(E=>E!==null);const fe=ce.filter(E=>E.direction==="卖出");console.log("卖出记录:",fe.length),w=fe.map(E=>{const T=ue(E.date),V=c.get(T),ne=E.exitPrice||0,ge=E.profitLoss||0;if(E.returnPct,V===void 0||ne<=0)return console.warn(`未找到卖出日期 ${T} 对应的K线索引或价格无效`),null;console.log(`卖出日期匹配成功: ${T} -> 索引 ${V}, 价格 ${ne}, 盈亏 ${ge}`);const tt=ge>=0?"#f64034":"#00b46a";return{name:"卖出",value:[V,ne],xAxis:V,yAxis:ne,itemStyle:{color:tt}}}).filter(E=>E!==null),console.log(`成功生成买入信号: ${i.length}/${xe.length}`),console.log(`成功生成卖出信号: ${w.length}/${fe.length}`)}const N=ee.map(c=>c[0]);let ae=[];ae=[...i.map(c=>(c.value[0],{name:"买入点",coord:[c.value[0],c.value[1]],value:c.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...w.map(c=>({name:"卖出点",coord:[c.value[0],c.value[1]],value:c.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...i.map(c=>{const O=c.value[0],fe=ee[O][4]*1.1;return{name:"买入标签",coord:[c.value[0],fe],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...w.map(c=>{const O=c.value[0],xe=i.some(T=>{const V=T.value[0],ne=ue(ee[V][0]),ge=ue(ee[O][0]);return ne===ge}),fe=ee[O][4],E=xe?fe*1.2:fe*1.1;return{name:"卖出标签",coord:[c.value[0],E],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];const we=[...i.map(c=>({name:"买入价格",coord:[c.value[0],c.value[1]*1.03],symbol:"none",label:{show:!0,formatter:`¥${c.value[1].toFixed(2)}`,fontSize:12,color:"#f64034",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"top",distance:8}})),...w.map(c=>{const O=c.value[0],xe=ee[O][0],fe=ce.find(ge=>ge.direction==="卖出"&&ue(ge.date)===ue(xe)),E=fe&&fe.profitLoss||0,T=fe&&fe.returnPct||0,V=E>=0?`+${E.toFixed(2)}`:`${E.toFixed(2)}`,ne=T>=0?`+${T.toFixed(2)}%`:`${T.toFixed(2)}%`;return{name:"卖出价格",coord:[c.value[0],c.value[1]*.97],symbol:"none",label:{show:!0,formatter:fe?`¥${c.value[1].toFixed(2)}
${V}(${ne})`:`¥${c.value[1].toFixed(2)}`,fontSize:12,color:"#00b46a",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"bottom",distance:8}}})];return{title:{text:s,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(c){let O="";if(Array.isArray(c)){const xe=c[0].axisValue;O=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${xe}</div>`,c.forEach(V=>{if(V.seriesName==="K线"){if(V.value&&V.value.length>=4){const ne=Number(V.value[1])||0,ge=Number(V.value[2])||0,tt=Number(V.value[3])||0,ot=Number(V.value[4])||0,st=ge>=ne?"#f64034":"#00b46a";O+=`<div style="color:${st};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${st};">${ne.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${st};">${ge.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${st};">${tt.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${st};">${ot.toFixed(2)}</span><br/>
                  </div>`}}else if(V.seriesName&&V.seriesName.startsWith("MA")&&V.value!=="-"){const ge={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[V.seriesName]||V.color;try{const tt=typeof V.value=="number"?parseFloat(V.value.toString()).toFixed(3):parseFloat(V.value||"0").toFixed(3);O+=`<div style="color:${ge};font-weight:bold;display:inline-block;margin-right:15px;">${V.seriesName}：${tt}</div>`}catch(tt){console.warn("格式化MA值出错:",tt),O+=`<div style="color:${ge};font-weight:bold;display:inline-block;margin-right:15px;">${V.seriesName}：0</div>`}}});const fe=ue(xe),E=ce.find(V=>V.direction==="买入"&&ue(V.date)===fe),T=ce.find(V=>V.direction==="卖出"&&ue(V.date)===fe);if((E||T)&&(O+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),E){const V=E.entryPrice||0,ne=E.trigger_reason||"未记录原因";O+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${V.toFixed(2)}<br/>
                原因：${ne}
              </div>`}if(T){const V=T.exitPrice||0,ne=T.profitLoss||0,ge=T.returnPct||0,tt=T.trigger_reason||"未记录原因",ot=ne>=0?`+${ne.toFixed(2)}`:`${ne.toFixed(2)}`,st=ge>=0?`+${ge.toFixed(2)}%`:`${ge.toFixed(2)}%`;O+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${V.toFixed(2)}<br/>
                盈亏：${ot} (${st})<br/>
                原因：${tt}
              </div>`}}return O}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:N,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"},min:function(c){return Math.min(0,$*.8)},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:ee.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:ae,animation:!1,z:10}},{name:"价格标签",type:"scatter",data:[],markPoint:{symbol:"none",data:we,animation:!1,z:9}},{name:"MA5",type:"line",data:Wt(5,ee.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Wt(10,ee.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Wt(20,ee.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Wt(30,ee.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}};function Wt(s,i){if(!i||!Array.isArray(i)||i.length===0)return console.warn(`计算MA${s}失败: 数据无效`),[];console.log(`MA${s}计算 - 输入数据示例:`,i.length>0?i.slice(0,3):"无数据");const w=[];for(let N=0;N<i.length;N++){if(N<s-1){w.push("-");continue}let ae=0,we=0;for(let c=0;c<s;c++){const O=i[N-c];if(O&&O.length>=4){const xe=Number(O[1]);!isNaN(xe)&&xe>0&&(ae+=xe,we++)}}we>0?w.push((ae/we).toFixed(2)):w.push("-")}return w.length>0&&console.log(`MA${s}计算结果示例:`,w.slice(0,5)),w}const ka=[{title:"日期",dataIndex:"date",key:"date",sorter:(s,i)=>{const w=new Date(s.date),N=new Date(i.date);return w.getTime()-N.getTime()}},{title:"方向",dataIndex:"direction",key:"direction",filters:[{text:"买入",value:"买入"},{text:"卖出",value:"卖出"}],onFilter:(s,i)=>i.direction===s,render:s=>e.jsx(ke,{color:s==="买入"?"red":"green",children:s})},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:s=>e.jsx(ye,{title:s||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:s||"未记录"})})},{title:"期初资金",dataIndex:"beforeCash",key:"beforeCash",sorter:(s,i)=>s.beforeCash-i.beforeCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"afterCash",key:"afterCash",sorter:(s,i)=>s.afterCash-i.afterCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"入场价",dataIndex:"entryPrice",key:"entryPrice",sorter:(s,i)=>{const w=s.entryPrice||0,N=i.entryPrice||0;return w-N},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"出场价",dataIndex:"exitPrice",key:"exitPrice",sorter:(s,i)=>{const w=s.exitPrice||0,N=i.exitPrice||0;return w-N},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(s,i)=>s.shares-i.shares,render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前持仓(股)",dataIndex:"currentShares",key:"currentShares",sorter:(s,i)=>(s.currentShares||0)-(i.currentShares||0),render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前摊薄成本(元)",dataIndex:"currentAvgCost",key:"currentAvgCost",sorter:(s,i)=>(s.currentAvgCost||0)-(i.currentAvgCost||0),render:s=>{const i=parseFloat(s)||0;return i>0?i.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"-"}},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(s,i)=>s.value-i.value,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"盈亏",dataIndex:"profitLoss",key:"profitLoss",sorter:(s,i)=>s.profitLoss-i.profitLoss,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2)]}):e.jsx("span",{style:{color:"#52c41a"},children:i.toFixed(2)})}},{title:"收益率(%)",dataIndex:"returnPct",key:"returnPct",sorter:(s,i)=>s.returnPct-i.returnPct,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00%"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2),"%"]}):e.jsxs("span",{style:{color:"#52c41a"},children:[i.toFixed(2),"%"]})}},{title:"持仓天数",dataIndex:"duration",key:"duration",sorter:(s,i)=>s.duration-i.duration},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(s,i)=>(s.position_size||0)-(i.position_size||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(s,i)=>(s.cumulative_position_ratio||0)-(i.cumulative_position_ratio||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}}],$a=()=>{if(console.log("生成权益曲线图表, 数据长度:",pe.length),!pe||pe.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const s=pe.filter(T=>T&&T.date&&T.equity!==void 0&&!isNaN(Number(T.equity)));if(s.length===0)return console.error("权益曲线数据无效:",pe.slice(0,3)),{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};console.log("有效数据点数量:",s.length),console.log("权益曲线数据范围:",s.length>0?`${s[0].date}(${s[0].equity}) ~ ${s[s.length-1].date}(${s[s.length-1].equity})`:"无数据");let i=[],w=[];const N=new Map;s.forEach((T,V)=>{const ne=ue(T.date);N.set(ne,V)}),ce.length>0&&(console.log("准备在权益曲线上标记交易点，总交易记录：",ce.length),ce.forEach(T=>{const V=ue(T.date),ne=N.get(V);if(ne!==void 0){const ge={name:T.direction==="买入"?"买入点":"卖出点",value:s[ne].equity,xAxis:ne,yAxis:s[ne].equity,itemStyle:{color:T.direction==="买入"?"#f64034":"#00b46a"}};T.direction==="买入"?i.push(ge):w.push(ge)}}));let ae=-1,we=-1,c=0,O="",xe="",fe=0,E=0;if(s.length>0&&Ce.maxDrawdown>0){let T=s[0].equity,V=0,ne=0;for(let ge=1;ge<s.length;ge++)s[ge].equity>T?(T=s[ge].equity,ne=ge):(V=(T-s[ge].equity)/T*100,V>c&&(c=V,ae=ne,we=ge,O=s[ne].date,xe=s[ge].date,fe=T,E=s[ge].equity));console.log(`最大回测区间索引: ${ae} - ${we}`),console.log(`最大回测: ${c.toFixed(2)}%, 从 ${O} 到 ${xe}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(T){if(Array.isArray(T)&&T.length>0){const ne=T[0].axisValue,ge=T[0].data;for(let ot=0;ot<T.length;ot++)if(T[ot].componentType==="markArea")return`最大回撤: ${c.toFixed(2)}%<br/>
                        开始日期: ${O}<br/>
                        最高点: ¥${fe.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${xe}<br/>
                        最低点: ¥${E.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let tt="";for(let ot=0;ot<T.length;ot++){const st=T[ot];if(st.seriesName==="买入点"||st.seriesName==="卖出点"){const Ta=ue(ne),Ds=ce.find(qt=>ue(qt.date)===Ta&&(st.seriesName==="买入点"&&qt.direction==="买入"||st.seriesName==="卖出点"&&qt.direction==="卖出"));if(Ds){const qt=Ds.trigger_reason||"未记录原因";tt=`<br/><span style="color:${st.color}">● ${st.seriesName}</span>`,tt+=`<br/><span style="color:#555; font-size:12px">原因: ${qt}</span>`}else tt=`<br/><span style="color:${st.color}">● ${st.seriesName}</span>`;break}}return`${ne}<br/>策略收益: ¥${parseFloat(ge).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${tt}`}const V=T.value;return`${T.name}: ¥${parseFloat(V).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:s.map(T=>T.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:s.map(T=>T.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new da(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...i.map(T=>({name:"买入点",coord:[T.xAxis,T.yAxis],value:T.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...w.map(T=>({name:"卖出点",coord:[T.xAxis,T.yAxis],value:T.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${c.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[ae>=0&&we>=0?[{name:"最大回撤开始",xAxis:ae,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:we,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:s.map(()=>$),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:$,label:{formatter:"初始资金: ¥"+$.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(T){return`初始资金: ¥${$.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},Ia=()=>gt(void 0,null,function*(){try{const s=yield Wr();if(console.log("从后端获取的策略列表:",s),s&&s.length>0)if(it(s),!s.some(i=>i.id===W))oe(s[0].id||1),U(s[0].name||"移动平均线交叉策略");else{const i=s.find(w=>w.id===W);i&&U(i.name)}else h.error("未找到策略列表，请先创建策略")}catch(s){console.error("获取策略列表失败:",s),h.error("获取策略列表失败，请检查网络连接")}});o.useEffect(()=>{x.current||(x.current=!0,Da(),Pa(),Ia())},[]),o.useEffect(()=>{Ve.length>0&&W&&Is(W)},[Ve,W]);const $s=s=>gt(void 0,null,function*(){Ye(s);try{const i=yield Mr(s.id);if(i.first_date&&i.last_date){const w=M(i.first_date).startOf("day"),N=M(i.last_date).endOf("day");Z([w,N]),h.success(`已自动设置回测周期：${i.first_date} 至 ${i.last_date}`)}}catch(i){console.error("获取股票日期范围失败:",i),h.warning("无法获取该股票的数据日期范围，请手动设置回测周期")}}),Da=()=>gt(void 0,null,function*(){te(!0);try{const s=yield as();he(s),s.length>0&&(yield $s(s[0]))}catch(s){console.error("获取股票列表失败:",s)}finally{te(!1)}}),Is=s=>gt(void 0,null,function*(){try{const i=yield q.get(`/api/optimization/strategies/${s}/parameter-spaces`);if(i.data&&i.data.status==="success"){Se(i.data.data);const w={};i.data.data.forEach(N=>{(N.parameter_type==="int"||N.parameter_type==="float")&&(w[N.parameter_name]=N.min_value)}),j(w)}}catch(i){console.error("加载参数空间失败:",i),Se([]),j({})}}),Ca=()=>{B(!0)},za=()=>{B(!1),h.success("参数设置已保存")},Ma=()=>{const s={};K.forEach(i=>{(i.parameter_type==="int"||i.parameter_type==="float")&&(s[i.parameter_name]=i.min_value)}),j(s),h.success("参数已重置为默认值")},Aa=()=>gt(void 0,null,function*(){try{const s=yield q.get(`/api/optimization/strategies/${W}/best-parameters`);s.data&&s.data.status==="success"&&s.data.data.length>0?(t(s.data.data),Ge(!0)):h.warning("该策略暂无优化结果，请先进行参数优化")}catch(s){console.error("获取优化结果失败:",s),h.error("获取优化结果失败，请检查网络连接")}}),La=s=>{var i;j(s.best_parameters),Ge(!1),B(!1),h.success(`已导入优化结果: ${s.job_name} (得分: ${(i=s.best_score)==null?void 0:i.toFixed(4)})`)},Na=s=>{oe(s);const i=Ve.find(w=>w.id===s);i&&(U(i.name),Fe(i)),Is(s)},Pa=()=>gt(void 0,null,function*(){try{const s=yield fa();Le(s)}catch(s){console.error("获取数据源列表失败:",s)}}),Fa=()=>[{key:"1",label:e.jsxs("span",{children:[e.jsx(yt,{}),"绩效分析"]}),children:e.jsx(G,{gutter:16,children:e.jsx(g,{span:24,style:{marginBottom:16},children:e.jsx($t,{option:$a(),style:{height:500}})})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(yt,{}),"K线与交易信号"]}),children:e.jsx(G,{gutter:16,children:e.jsx(g,{span:24,children:e.jsx(re,{title:y?`${y.name} (${y.symbol})交易图表`:"交易图表",extra:e.jsxs(be,{children:[e.jsx(A,{type:"primary",size:"small",onClick:()=>{const s=document.querySelector(".kline-chart");if(s){const i=s.__echarts__;i&&i.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(A,{size:"small",onClick:()=>{if(ce.length>0&&ee.length>0){const s=new Map;ee.forEach((w,N)=>{const ae=ue(w[0]);s.set(ae,N)});const i=[];if(ce.forEach(w=>{const N=ue(w.date),ae=s.get(N);ae!==void 0&&i.push(ae)}),console.log("找到的交易日期索引:",i),i.length>0){const w=Math.max(0,Math.min(...i)-10),N=Math.min(ee.length-1,Math.max(...i)+10),ae=w/ee.length*100,we=N/ee.length*100;console.log(`设置缩放范围: ${ae.toFixed(2)}% - ${we.toFixed(2)}%`);const c=document.querySelector(".kline-chart");if(c){const O=c.__echarts__;O&&(O.dispatchAction({type:"dataZoom",start:ae,end:we}),(fe=>{h.success(`已聚焦到交易区域，共显示 ${fe} 个交易点`)})(i.length))}}else(()=>{h.info("未找到交易信号对应的K线数据点")})()}else(()=>{h.info("没有交易记录或K线数据")})()},children:"聚焦交易"}),e.jsx(ye,{title:"只显示有交易的区域",children:e.jsx(Oe,{})})]}),children:e.jsx($t,{className:"kline-chart",option:wa(),style:{height:600},notMerge:!0,opts:{renderer:"canvas"},onEvents:{click:s=>{if(s.componentType==="markPoint"){const w=s.name==="买入",N=s.data.coord[0],ae=ee[N][0],we=w?"买入":"卖出",c=ce.find(O=>O.direction===we&&ue(O.date)===ue(ae));if(console.log(`点击了${we}标记，日期: ${ae}`,c),c){const O=c,xe=w?"买入详情":"卖出详情",fe=e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"日期:"})," ",O.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"价格:"})," ",w?O.entryPrice:O.exitPrice]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数量:"})," ",O.shares.toLocaleString()," 股"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"金额:"})," ",O.value.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),!w&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏:"})," ",O.profitLoss>=0?"+":"",O.profitLoss.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"收益率:"})," ",O.returnPct>=0?"+":"",O.returnPct.toFixed(2),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"持仓天数:"})," ",O.duration," 天"]})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易前资金:"})," ",O.beforeCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易后资金:"})," ",O.afterCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"触发原因:"})," ",O.trigger_reason||"未记录原因"]})]});ze.info({title:xe,content:fe,width:400})}else((xe,fe)=>{h.info(`未找到匹配的${xe}交易记录，日期: ${fe}`)})(we,ae)}}}})})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Oe,{}),"交易明细"]}),children:e.jsx(At,{dataSource:ce,columns:ka,pagination:{pageSize:10},scroll:{x:!0}})}];return e.jsxs("div",{children:[e.jsx(cn,{level:2,children:"回测分析"}),e.jsx(dn,{children:"回测您的交易策略，分析策略表现并优化参数。"}),e.jsx(re,{children:e.jsx(Rt,{spinning:$e,children:e.jsxs(L,{layout:"vertical",children:[e.jsxs(G,{gutter:24,children:[e.jsx(g,{span:8,children:e.jsx(L.Item,{label:"策略选择",required:!0,children:e.jsxs(je.Group,{compact:!0,children:[e.jsx(Me,{value:b,onChange:(s,i)=>{Na(Number(i.key))},placeholder:"选择策略",style:{width:"calc(100% - 80px)"},size:"middle",children:Ve.map(s=>e.jsx(Pt,{value:s.name,children:s.name},s.id))}),e.jsx(A,{type:"primary",ghost:!0,onClick:Ca,style:{width:"80px"},icon:e.jsx(ss,{}),size:"middle",children:"参数"})]})})}),e.jsx(g,{span:8,children:e.jsx(L.Item,{label:"交易品种",required:!0,children:e.jsx(Me,{value:y==null?void 0:y.symbol,onChange:s=>gt(void 0,null,function*(){const i=H.find(w=>w.symbol===s);i&&(yield $s(i))}),placeholder:"选择交易品种",children:H.map(s=>{var i;return e.jsxs(Pt,{value:s.symbol,children:[s.name," (",s.symbol,") - ",((i=Ie.find(w=>w.id===s.source_id))==null?void 0:i.name)||"未知数据源"]},s.id)})})})}),e.jsx(g,{span:8,children:e.jsx(L.Item,{label:"回测周期",required:!0,children:e.jsx(Mt.RangePicker,{value:me,onChange:s=>{s&&s[0]&&s[1]&&Z([s[0].startOf("day"),s[1].endOf("day")])},style:{width:"100%"},placeholder:["开始日期","结束日期"],format:"YYYY-MM-DD",allowClear:!1,disabledDate:s=>s&&s>M().endOf("day"),presets:[{label:"Last 7 days",value:[M().subtract(7,"day"),M()]},{label:"Last 30 days",value:[M().subtract(30,"day"),M()]},{label:"Last 3 months",value:[M().subtract(3,"month"),M()]},{label:"Last 6 months",value:[M().subtract(6,"month"),M()]},{label:"Last 1 year",value:[M().subtract(1,"year"),M()]},{label:"Last 3 years",value:[M().subtract(3,"year"),M()]},{label:"Last 5 years",value:[M().subtract(5,"year"),M()]},{label:"Last 7 years",value:[M().subtract(7,"year"),M()]},{label:"Last 10 years",value:[M().subtract(10,"year"),M()]}]})})})]}),e.jsxs(G,{gutter:24,children:[e.jsx(g,{span:6,children:e.jsx(L.Item,{label:"初始资金",children:e.jsx(kt,{value:$,onChange:s=>D(Number(s)||1e5),formatter:s=>`¥ ${s}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:s=>{if(s){const i=parseFloat(s.replace(/\¥\s?|(,*)/g,""));return isNaN(i)?$:i}return $},style:{width:"100%"}})})}),e.jsx(g,{span:6,children:e.jsx(L.Item,{label:"手续费率(%)",children:e.jsx(kt,{value:f,onChange:s=>k(Number(s)||.15),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(g,{span:6,children:e.jsx(L.Item,{label:"滑点(%)",children:e.jsx(kt,{value:F,onChange:s=>J(Number(s)||.1),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(g,{span:6,children:e.jsx(L.Item,{label:"基准",children:e.jsxs(Me,{defaultValue:"SPY",placeholder:"选择基准",children:[e.jsx(Pt,{value:"SPY",children:"标普500ETF"}),e.jsx(Pt,{value:"QQQ",children:"纳斯达克ETF"}),e.jsx(Pt,{value:"DIA",children:"道琼斯ETF"})]})})})]}),y&&e.jsx(nt,{message:`已选择数据源: ${((n=Ie.find(s=>s.id===y.source_id))==null?void 0:n.name)||"未知"}`,description:`回测将使用与数据管理中相同的数据源获取 ${y.symbol} 的历史数据`,type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(L.Item,{label:"执行模式",children:e.jsxs(be,{children:[e.jsx(lr,{checked:S,onChange:de,checkedChildren:"异步",unCheckedChildren:"同步"}),e.jsx(ye,{title:S?"异步模式：任务在后台执行，可以处理大数据量回测":"同步模式：立即返回结果，适合快速回测",children:e.jsx(Oe,{style:{color:"#aaa"}})}),S&&ve&&e.jsxs(ke,{color:_e==="completed"?"green":_e==="failed"?"red":"blue",children:["任务状态: ",_e==="pending"?"等待中":_e==="running"?"执行中":_e==="completed"?"已完成":_e==="failed"?"失败":_e,_e==="running"&&` (${Q}%)`]})]})}),e.jsx(L.Item,{children:e.jsxs(be,{children:[e.jsx(A,{type:"primary",icon:e.jsx(Bt,{}),loading:l,onClick:_a,children:S?"提交异步回测":"运行回测"}),e.jsx(A,{type:"default",icon:e.jsx(Bt,{}),loading:l,onClick:Sa,title:"强制刷新：清除缓存并重新运行回测",disabled:S,children:"强制刷新"})]})})]})})}),m&&e.jsxs(e.Fragment,{children:[e.jsx(es,{}),e.jsxs(re,{children:[e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["总收益率 ",e.jsx(ye,{title:"总收益率=最终资金/初始资金-1，反映策略总体收益情况",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ce.totalReturn,precision:2,valueStyle:{color:Ce.totalReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(ye,{title:"年化收益率=（总收益率+1）^(365/天数)-1，反映策略年化增长速度",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ce.annualReturn,precision:2,valueStyle:{color:Ce.annualReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(ye,{title:"最大回撤=历史最高点到最低点的最大跌幅，衡量风险",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Math.abs(Ce.maxDrawdown),precision:2,valueStyle:{color:"#52c41a"},suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(ye,{title:"夏普比率=（年化收益率-无风险利率）/年化波动率，衡量单位风险收益",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ce.sharpeRatio,precision:2})})]}),e.jsx(G,{gutter:16,style:{marginTop:16},children:e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["胜率 ",e.jsx(ye,{title:"胜率=盈利交易次数/总交易次数",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ce.winRate,precision:2,suffix:"%"})})}),e.jsxs(G,{gutter:16,style:{marginTop:24},children:[e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(ye,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ce.profitFactor||0,precision:2})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["Alpha ",e.jsx(ye,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ce.alpha||0,precision:2,suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["Beta ",e.jsx(ye,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ce.beta||0,precision:2})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["交易次数 ",e.jsx(ye,{title:"策略在回测期间的总交易次数",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:ce.length})})]}),e.jsx(es,{}),e.jsx(Ut,{defaultActiveKey:"1",items:Fa()}),e.jsxs("div",{style:{textAlign:"right",marginTop:16},children:[e.jsx(A,{icon:e.jsx(na,{}),style:{marginRight:8},children:"导出报告"}),e.jsx(A,{icon:e.jsx(ca,{}),type:"primary",onClick:()=>{const s=new Date,i=s.toISOString().slice(0,10).replace(/-/g,""),w=s.toTimeString().slice(0,5).replace(":",""),N=`${(y==null?void 0:y.symbol)||"UNKNOWN"}_v${i}_${w}`;P(N),d(!0)},disabled:!m,children:"保存回测"})]})]})]}),e.jsx(ze,{title:"保存回测",open:a,onOk:rs,onCancel:()=>{d(!1),P(""),se("")},confirmLoading:u,okText:"保存",cancelText:"取消",children:e.jsxs(L,{layout:"vertical",children:[e.jsx(L.Item,{label:"回测名称",required:!0,help:"请输入一个描述性的回测名称",children:e.jsx(je,{placeholder:"例如：MA交叉策略_AAPL_2024年回测",value:z,onChange:s=>P(s.target.value)})}),e.jsx(L.Item,{label:"回测描述",help:"可选：添加回测的详细描述",children:e.jsx(je.TextArea,{placeholder:"例如：使用移动平均线交叉策略对AAPL进行回测，包含仓位控制...",value:X,onChange:s=>se(s.target.value),rows:3})}),e.jsx(nt,{message:"保存信息",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"策略："}),b]}),e.jsxs("p",{children:[e.jsx("strong",{children:"股票："}),y==null?void 0:y.symbol," (",y==null?void 0:y.name,")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"回测期间："}),me[0].format("YYYY-MM-DD")," 至 ",me[1].format("YYYY-MM-DD")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"初始资金："}),"$",$.toLocaleString()]}),Object.keys(p).length>0&&e.jsxs("p",{children:[e.jsx("strong",{children:"策略参数："}),"短期均线 ",p.short_window||5,"天, 长期均线 ",p.long_window||20,"天"]})]}),type:"info",showIcon:!0})]})}),e.jsxs(ze,{title:"策略参数设置",open:Y,onOk:za,onCancel:()=>B(!1),width:800,children:[e.jsx(nt,{message:`当前策略: ${(Ue==null?void 0:Ue.name)||b}`,description:(Ue==null?void 0:Ue.description)||"策略参数配置",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(L,{layout:"vertical",children:[K.length>0?e.jsx(G,{gutter:16,children:K.map((s,i)=>e.jsx(g,{span:12,children:e.jsx(L.Item,{label:`${s.parameter_name}${s.description?` (${s.description})`:""}`,help:s.description,children:s.parameter_type==="int"?e.jsx(kt,{value:p[s.parameter_name]||s.min_value,onChange:w=>j(N=>Zt(Jt({},N),{[s.parameter_name]:w})),min:s.min_value,max:s.max_value,step:s.step_size,style:{width:"100%"}}):s.parameter_type==="float"?e.jsx(kt,{value:p[s.parameter_name]||s.min_value,onChange:w=>j(N=>Zt(Jt({},N),{[s.parameter_name]:w})),min:s.min_value,max:s.max_value,step:s.step_size,precision:2,style:{width:"100%"}}):s.parameter_type==="choice"?e.jsx(Me,{value:p[s.parameter_name]!==void 0?p[s.parameter_name]:s.choices&&s.choices.length>0?s.choices[0]:void 0,onChange:w=>j(N=>Zt(Jt({},N),{[s.parameter_name]:w})),style:{width:"100%"},children:(s.choices||[]).map((w,N)=>e.jsx(Pt,{value:w,children:typeof w=="boolean"?w?"true":"false":String(w)},N))}):e.jsx(je,{value:p[s.parameter_name]||"",onChange:w=>j(N=>Zt(Jt({},N),{[s.parameter_name]:w.target.value})),placeholder:`请输入${s.parameter_name}`})})},s.parameter_name))}):e.jsx(nt,{message:"暂无参数配置",description:"该策略暂未配置参数空间，将使用默认参数进行回测",type:"warning",showIcon:!0}),K.length>0&&e.jsx(nt,{message:"参数说明",description:e.jsx("div",{children:K.map((s,i)=>e.jsxs("p",{children:[e.jsxs("strong",{children:[s.parameter_name,"："]}),s.description,s.parameter_type==="int"||s.parameter_type==="float"?` (范围: ${s.min_value} - ${s.max_value}, 步长: ${s.step_size})`:s.parameter_type==="choice"?` (选项: ${(s.choices||[]).map(w=>typeof w=="boolean"?w?"true":"false":String(w)).join(", ")})`:""]},i))}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(be,{children:[e.jsx(A,{onClick:Ma,children:"重置默认值"}),e.jsx(A,{type:"dashed",onClick:Aa,children:"从优化导入"})]})]})]}),e.jsxs(ze,{title:"选择优化结果",open:Te,onCancel:()=>Ge(!1),width:800,footer:null,children:[e.jsx(nt,{message:"选择要导入的优化结果",description:"以下是从参数优化中获得的最佳参数配置，按优化得分排序",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("div",{style:{maxHeight:400,overflowY:"auto"},children:We.map((s,i)=>{var w;return e.jsxs(re,{size:"small",style:{marginBottom:8},hoverable:!0,onClick:()=>La(s),children:[e.jsxs(G,{gutter:16,align:"middle",children:[e.jsx(g,{span:16,children:e.jsxs("div",{children:[e.jsx("strong",{children:s.job_name}),e.jsxs("div",{style:{fontSize:"12px",color:"#666",marginTop:4},children:[s.description&&`${s.description} • `,"完成时间: ",s.completed_at?M.utc(s.completed_at).tz("Asia/Shanghai").format("YYYY/MM/DD HH:mm:ss"):"未知"]})]})}),e.jsx(g,{span:4,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"14px",fontWeight:"bold",color:"#1890ff"},children:(w=s.best_score)==null?void 0:w.toFixed(4)}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:s.objective_function})]})}),e.jsx(g,{span:4,children:e.jsx("div",{style:{textAlign:"center"},children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:["试验次数: ",s.total_trials]})})})]}),e.jsxs("div",{style:{marginTop:8,fontSize:"12px"},children:[e.jsx("strong",{children:"关键参数:"}),e.jsxs("div",{style:{marginTop:4,maxHeight:"40px",overflow:"hidden"},children:[Object.entries(s.best_parameters||{}).slice(0,3).map(([N,ae])=>e.jsxs(ke,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[N==="short_window"?"短期":N==="long_window"?"长期":N==="min_reversal_points"?"反转点":N==="lookback_period"?"回望期":N==="signal_strength_threshold"?"信号阈值":N==="batch_count"?"批次数":N==="stop_loss_ratio"?"止损":N==="take_profit_ratio"?"止盈":N,": ",typeof ae=="number"?ae.toFixed(1):String(ae)]},N)),Object.keys(s.best_parameters||{}).length>3&&e.jsxs(ke,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",Object.keys(s.best_parameters||{}).length-3,"个"]})]})]})]},s.job_id)})}),We.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"40px 0",color:"#999"},children:"暂无优化结果"})]})]})},pn=o.memo(un);var hn=Object.defineProperty,mn=Object.defineProperties,xn=Object.getOwnPropertyDescriptors,Us=Object.getOwnPropertySymbols,fn=Object.prototype.hasOwnProperty,gn=Object.prototype.propertyIsEnumerable,Ws=(n,r,l)=>r in n?hn(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,Qt=(n,r)=>{for(var l in r||(r={}))fn.call(r,l)&&Ws(n,l,r[l]);if(Us)for(var l of Us(r))gn.call(r,l)&&Ws(n,l,r[l]);return n},os=(n,r)=>mn(n,xn(r)),pt=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});M.extend(la);M.extend(oa);M.tz.setDefault("Asia/Shanghai");const{Title:yn,Text:Ee}=It,{Option:Ct}=Me,{TabPane:Gs}=Ut,jn=()=>{const[n,r]=o.useState([]),[l,v]=o.useState(null),[m,_]=o.useState([]),[$,D]=o.useState([]),[f,k]=o.useState(!1),F=o.useRef(!1),[J]=L.useForm(),[H,he]=o.useState(!1),[$e,te]=o.useState(!1),[W,oe]=o.useState(!1),[b,U]=o.useState(null),[y,Ye]=o.useState(null),[me,Z]=o.useState(!1),[Ie,Le]=o.useState([]),[ce,qe]=o.useState(!1),[ee,De]=o.useState([]),[pe,Re]=o.useState({}),[xt,Ze]=o.useState([]),[Ce,Ne]=o.useState(!1),Ve=o.useCallback(()=>{const t=n.find(z=>z.id===l),a=(t==null?void 0:t.name)||"策略优化",u=J.getFieldsValue().symbol||"AAPL",C=M().format("YYYYMMDD");return`${u}_${C}_${a}`},[l,n,J]),it=o.useCallback(()=>{if(!Ce){const t=Ve();J.setFieldValue("name",t)}},[Ce,Ve,J]),ft=()=>pt(void 0,null,function*(){try{const t=yield q.get("/api/strategies");t.data&&t.data.data&&r(t.data.data)}catch(t){console.error("加载策略列表失败:",t),h.error("加载策略列表失败")}}),et=()=>pt(void 0,null,function*(){try{const t=yield q.get("/api/data/stocks");if(t.data&&Array.isArray(t.data)){const a=t.data.map(d=>({symbol:d.symbol,name:d.name}));Ze(a)}}catch(t){console.error("加载股票列表失败:",t),Ze([{symbol:"AAPL",name:"Apple Inc."},{symbol:"TSLA",name:"Tesla Inc."},{symbol:"MSFT",name:"Microsoft Corporation"},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"AMZN",name:"Amazon.com Inc."}])}}),at=t=>pt(void 0,null,function*(){try{const a=yield q.get(`/api/data/stock/symbol/${t}/date-range`);if(a.data&&a.data.status==="success"){const{min_date:d,max_date:u}=a.data.data;Re({min_date:d,max_date:u}),d&&u&&J.setFieldsValue({start_date:M(d),end_date:M(u)})}}catch(a){console.error("获取股票数据范围失败:",a)}}),Pe=t=>{const a=M();let d,u=a;switch(t){case"recent1y":d=a.subtract(1,"year");break;case"recent3y":d=a.subtract(3,"year");break;case"recent5y":d=a.subtract(5,"year");break;case"recent6y":d=a.subtract(6,"year");break;case"recent7y":d=a.subtract(7,"year");break;case"recent8y":d=a.subtract(8,"year");break;case"recent9y":d=a.subtract(9,"year");break;case"recent10y":d=a.subtract(10,"year");break;case"full":pe.min_date&&pe.max_date?(d=M(pe.min_date),u=M(pe.max_date)):d=a.subtract(5,"year");break;default:d=a.subtract(1,"year")}J.setFieldsValue({start_date:d,end_date:u})},ct=t=>pt(void 0,null,function*(){try{const a=yield q.get(`/api/optimization/strategies/${t}/parameter-spaces`);a.data&&a.data.status==="success"&&_(a.data.data)}catch(a){console.error("加载参数空间失败:",a)}}),Ke=t=>pt(void 0,null,function*(){var a;try{k(!0);const d=t?{strategy_id:t}:{},u=yield q.get("/api/optimization/jobs",{params:d});if(u.data&&u.data.status==="success"){const C=Array.isArray((a=u.data.data)==null?void 0:a.jobs)?u.data.data.jobs:[];D(C),h.success("刷新成功")}else D([]),h.warning("没有找到优化任务")}catch(d){console.error("加载优化任务失败:",d),D([]),h.error("加载优化任务失败")}finally{k(!1)}}),I=t=>{v(t),ct(t),Ke(t)},x=()=>{_([...m,{parameter_name:"",parameter_type:"float",min_value:0,max_value:1,step_size:.1,description:""}])},p=t=>{_(m.filter((a,d)=>d!==t))},j=(t,a,d)=>{const u=[...m];u[t]=os(Qt({},u[t]),{[a]:d}),_(u)},Y=t=>{if(!Array.isArray(t))return!1;const a=t.map(C=>typeof C=="string"?C.toLowerCase():C),d=a.includes(!0)||a.includes("true"),u=a.includes(!1)||a.includes("false");return a.length===2&&d&&u},B=()=>pt(void 0,null,function*(){if(!l){h.error("请先选择策略");return}try{k(!0),yield q.post(`/api/optimization/strategies/${l}/parameter-spaces`,m),h.success("参数空间保存成功"),he(!1)}catch(t){console.error("保存参数空间失败:",t),h.error("保存参数空间失败")}finally{k(!1)}}),K=()=>pt(void 0,null,function*(){var t;if(!l){h.error("请先选择策略");return}try{k(!0);const a=yield q.get(`/api/optimization/strategies/${l}/parameter-spec`),d=((t=a==null?void 0:a.data)==null?void 0:t.data)||[];if(!Array.isArray(d)||d.length===0){h.warning("未识别到策略参数");return}const u=[];for(const P of d){const X=P==null?void 0:P.name,se=P==null?void 0:P.type,S=P==null?void 0:P.default;if(!(!X||!se))if(se==="integer"){const de=typeof S=="number"?S:typeof S=="string"?parseFloat(S):10;let ve=Math.floor((isNaN(de)?10:de)*.5),ie=Math.ceil((isNaN(de)?10:de)*1.5);ve<1&&(ve=1),ie<=ve&&(ie=ve+1),u.push({parameter_name:X,parameter_type:"int",min_value:ve,max_value:ie,step_size:1,description:"自动识别（±50%范围）"})}else if(se==="float"){const de=typeof S=="number"?S:typeof S=="string"?parseFloat(S):1,ve=isNaN(de)?1:de;let ie=ve*.5,_e=ve*1.5;_e<=ie&&(_e=ie+(Math.abs(ve)||1));const R=Math.max(1e-4,Math.abs(ve)*.1||.1);u.push({parameter_name:X,parameter_type:"float",min_value:Number(ie.toFixed(6)),max_value:Number(_e.toFixed(6)),step_size:Number(R.toFixed(6)),description:"自动识别（±50%范围）"})}else if(se==="boolean")u.push({parameter_name:X,parameter_type:"choice",choices:[!0,!1],description:"自动识别（布尔类型）"});else if(se==="string")u.push({parameter_name:X,parameter_type:"choice",choices:typeof S<"u"?[S]:[],description:"自动识别（字符串类型，请手动设置备选项）"});else continue}if(u.length===0){h.warning("未识别到可优化的数值型参数");return}const C=new Map((m||[]).map(P=>[P.parameter_name,P])),z=u.map(P=>{const X=C.get(P.parameter_name);if(X){const se=!!X.description&&String(X.description).trim().length>0;return os(Qt({},P),{description:se?X.description:P.description})}return P});for(const[P,X]of C.entries())z.some(se=>se.parameter_name===P)||z.push(X);_(z),h.success(`已自动识别 ${u.length} 个参数，请完善范围后保存`)}catch(a){console.error("自动识别策略参数失败:",a),h.error("自动识别策略参数失败")}finally{k(!1)}}),Se=t=>pt(void 0,null,function*(){try{k(!0),U(t),console.log("🔍 开始获取试验列表:",t.name);const a=performance.now();try{console.log("📊 尝试获取轻量级试验摘要...");const z=yield q.get(`/api/optimization/jobs/${t.id}/trials-summary`),P=performance.now();if(console.log(`✅ 轻量级试验摘要耗时: ${(P-a).toFixed(0)}ms`),z.data&&z.data.status==="success"){console.log(`📊 获取到 ${z.data.data.length} 个试验摘要`),Le(z.data.data),Z(!0);return}}catch(z){console.warn("⚠️ 轻量级摘要API失败，使用完整数据:",z)}console.log("📋 获取完整试验数据...");const d=performance.now(),u=yield q.get(`/api/optimization/jobs/${t.id}/trials`),C=performance.now();console.log(`📊 完整试验数据耗时: ${(C-d).toFixed(0)}ms`),u.data&&u.data.status==="success"?(console.log(`📊 获取到 ${u.data.data.length} 个完整试验结果`),Le(u.data.data),Z(!0)):h.error("获取试验数据失败")}catch(a){console.error("获取试验数据失败:",a),h.error("获取试验数据失败")}finally{k(!1)}}),Ue=(t,a=!1)=>pt(void 0,null,function*(){var d,u;try{if(t.status==="running"&&!a){h.error("运行中的任务不能删除，请先停止任务");return}const C=a?`/api/optimization/jobs/${t.id}?force=true`:`/api/optimization/jobs/${t.id}`,z=yield q.delete(C);z.data&&z.data.status==="success"?(h.success(z.data.message||"删除成功"),yield Ke()):h.error("删除失败")}catch(C){console.error("删除优化任务失败:",C);const z=((u=(d=C.response)==null?void 0:d.data)==null?void 0:u.detail)||C.message||"删除失败";h.error(z)}}),Fe=t=>pt(void 0,null,function*(){try{k(!0),U(t),console.log("🚀 开始获取任务详情:",t.name);const a=performance.now();if(t.best_parameters&&t.status==="completed"&&t.optimization_config){try{console.log("📊 尝试获取轻量级性能指标...");const X=yield q.get(`/api/optimization/jobs/${t.id}/best-performance`);if(X.data&&X.data.status==="success"){const se=performance.now();console.log(`✅ 使用轻量级API，耗时: ${(se-a).toFixed(0)}ms`);const S=X.data.data,de={total_return:S.total_return,annual_return:S.annual_return,sharpe_ratio:S.sharpe_ratio,max_drawdown:S.max_drawdown,win_rate:S.win_rate,profit_factor:S.profit_factor,alpha:S.alpha,beta:S.beta,total_trades:S.total_trades,parameters:S.parameters,fromOptimization:!0,isLightweight:!0};Ye(de),oe(!0),k(!1);return}}catch(X){console.warn("⚠️ 轻量级API失败，尝试完整数据:",X)}try{console.log("📊 尝试获取完整回测结果...");const X=yield q.get(`/api/optimization/jobs/${t.id}/trials`);if(X.data&&X.data.status==="success"&&X.data.data.length>0){const se=X.data.data[0];if(se.backtest_results){const S=performance.now();console.log(`✅ 使用完整缓存结果，耗时: ${(S-a).toFixed(0)}ms`);const de=os(Qt({},se.backtest_results),{fromOptimization:!0});Ye(de),oe(!0),k(!1);return}else console.warn("⚠️ 最佳试验没有缓存的回测结果")}}catch(X){console.warn("❌ 无法获取优化试验数据，将重新运行回测:",X)}console.log("🔄 缓存未命中，重新运行回测...");const d=performance.now(),u=t.optimization_config.backtest_config,C={strategy_id:t.strategy_id,parameters:t.best_parameters,symbol:u.symbol,start_date:u.start_date,end_date:u.end_date,initial_capital:u.initial_capital};console.log("📋 回测请求参数:",C);const z=yield q.post("/api/strategies/backtest",C),P=performance.now();console.log(`⏱️ 重新回测耗时: ${(P-d).toFixed(0)}ms`),z.data&&z.data.status==="success"?Ye(z.data.data):(console.error("回测失败:",z.data),h.error("回测失败，无法获取详细结果"))}else t.status==="completed"&&h.warning("优化配置信息不完整，无法重现回测结果");oe(!0)}catch(a){console.error("获取任务详情失败:",a),h.error("获取任务详情失败")}finally{k(!1)}}),Te=t=>pt(void 0,null,function*(){if(!l){h.error("请先选择策略");return}if(m.length===0){h.error("请先配置参数空间");return}try{k(!0);const a={strategy_id:l,name:t.name,description:t.description,parameter_spaces:m,objective_function:t.objective_function,n_trials:t.n_trials,timeout:t.timeout,backtest_config:{symbol:t.symbol,start_date:t.start_date.format("YYYY-MM-DD"),end_date:t.end_date.format("YYYY-MM-DD"),initial_capital:t.initial_capital}};yield q.post("/api/optimization/optimize",a),h.success("优化任务已启动"),te(!1),J.resetFields(),Ke(l)}catch(a){console.error("启动优化任务失败:",a),h.error("启动优化任务失败")}finally{k(!1)}}),Ge=t=>pt(void 0,null,function*(){try{if(k(!0),t.backtest_results&&t.backtest_results.logs&&t.backtest_results.logs.length>0){console.log("📋 使用当前记录中的日志"),De(t.backtest_results.logs),qe(!0);return}console.log("🔍 获取完整试验数据以获取日志...");const a=yield q.get(`/api/optimization/jobs/${b==null?void 0:b.id}/trials`);if(a.data&&a.data.status==="success"){const u=a.data.data.find(C=>C.trial_number===t.trial_number||C.id===t.id||C.parameters&&t.parameters&&JSON.stringify(C.parameters)===JSON.stringify(t.parameters));u&&u.backtest_results&&u.backtest_results.logs?(console.log(`📋 找到完整试验数据，日志条数: ${u.backtest_results.logs.length}`),De(u.backtest_results.logs),qe(!0)):h.warning("该试验暂无日志数据")}else h.error("获取试验日志失败")}catch(a){console.error("获取试验日志失败:",a),h.error("获取试验日志失败")}finally{k(!1)}}),We=[{title:"ID",dataIndex:"id",key:"id",width:50,align:"center"},{title:"任务名称",dataIndex:"name",key:"name",width:160,ellipsis:!0},{title:"策略",dataIndex:"strategy_id",key:"strategy",width:120,ellipsis:{showTitle:!1},render:t=>{const a=n.find(d=>d.id===t);return a?e.jsx(ye,{title:a.name,placement:"topLeft",children:e.jsx(ke,{color:"blue",style:{margin:0,maxWidth:"100px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"inline-block",cursor:"pointer"},children:a.name})}):e.jsx(Ee,{type:"secondary",style:{fontSize:"12px"},children:"未知策略"})}},{title:"状态",dataIndex:"status",key:"status",width:70,align:"center",render:t=>{const d={running:{color:"processing",text:"运行中"},completed:{color:"success",text:"已完成"},failed:{color:"error",text:"失败"},cancelled:{color:"default",text:"已取消"}}[t]||{color:"default",text:t};return e.jsx(ke,{color:d.color,children:d.text})}},{title:"进度",dataIndex:"progress",key:"progress",width:90,render:(t,a)=>{const d=`${a.completed_trials}/${a.total_trials}`,u=`${t.toFixed(1)}%`;return e.jsx(ye,{title:e.jsxs("div",{children:[e.jsxs("div",{children:["已完成试验: ",a.completed_trials]}),e.jsxs("div",{children:["总试验数: ",a.total_trials]}),e.jsxs("div",{children:["完成进度: ",t.toFixed(1),"%"]})]}),placement:"topLeft",children:e.jsxs("div",{style:{width:"80px",textAlign:"center"},children:[e.jsx(or,{percent:t,size:"small",style:{marginBottom:"1px"},showInfo:!1}),e.jsxs("div",{style:{fontSize:"10px",color:"#666",lineHeight:"1.2"},children:[d," (",u,")"]})]})})}},{title:"最佳得分",dataIndex:"best_score",key:"best_score",width:100,align:"center",render:(t,a)=>{if(!t)return"-";const u={sharpe_ratio:"夏普比率",total_return:"总收益率",annual_return:"年化收益率"}[a.objective_function]||"得分";return e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",color:"#1890ff"},children:t.toFixed(4)}),e.jsx(Ee,{type:"secondary",style:{fontSize:"11px"},children:u})]})}},{title:"交易配置",dataIndex:"optimization_config",key:"trading_config",width:110,align:"center",render:t=>{if(!t||!t.backtest_config)return"-";const{symbol:a,initial_capital:d}=t.backtest_config;return e.jsxs("div",{children:[e.jsx(ke,{color:"green",style:{marginBottom:"2px"},children:a}),e.jsxs("div",{style:{fontSize:"11px",color:"#666"},children:["¥",(d==null?void 0:d.toLocaleString())||"N/A"]})]})}},{title:"回测时间段",dataIndex:"optimization_config",key:"date_range",width:140,render:t=>{if(!t||!t.backtest_config)return"-";const{start_date:a,end_date:d}=t.backtest_config;return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a}),e.jsx("div",{style:{fontSize:"10px",color:"#999",margin:"2px 0"},children:"至"}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:d})]})}},{title:"最佳参数",dataIndex:"best_parameters",key:"best_parameters",width:200,render:t=>{if(!t)return"-";const a=Object.entries(t),d=3,u=a.slice(0,d),C=a.length-d;return e.jsxs("div",{style:{maxHeight:"60px",overflow:"hidden"},children:[u.map(([z,P])=>e.jsxs(ke,{color:"blue",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[z==="short_window"?"短期":z==="long_window"?"长期":z==="min_reversal_points"?"反转点":z==="lookback_period"?"回望期":z==="signal_strength_threshold"?"信号阈值":z==="batch_count"?"批次数":z==="stop_loss_ratio"?"止损":z==="take_profit_ratio"?"止盈":z,": ",typeof P=="number"?P.toFixed(2):P]},z)),C>0&&e.jsxs(ke,{color:"default",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",C,"个"]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:140,render:t=>{const a=M.utc(t).tz("Asia/Shanghai");return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px"},children:a.format("YYYY-MM-DD")}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a.format("HH:mm:ss")})]})}},{title:"操作",key:"action",width:100,align:"center",render:(t,a)=>{const d=M.utc(a.created_at).tz("Asia/Shanghai"),u=a.status==="running"&&M().diff(d,"hour")>=1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx(A,{type:"link",icon:e.jsx(ws,{}),onClick:()=>Fe(a),size:"small",disabled:a.status!=="completed",style:{padding:"2px 8px",height:"auto",fontSize:"12px"},children:"查看回测"}),e.jsx(A,{type:"link",onClick:()=>Se(a),size:"small",disabled:a.status!=="completed",style:{color:"#1890ff",padding:"2px 8px",height:"auto",fontSize:"12px"},children:"其他回测"}),e.jsx(ir,{title:"确认删除",description:u?`检测到异常状态，确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`:`确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`,onConfirm:()=>Ue(a,u),okText:"确定",cancelText:"取消",disabled:a.status==="running"&&!u,placement:"top",children:e.jsx(A,{danger:!0,size:"small",disabled:a.status==="running"&&!u,icon:e.jsx(Kt,{}),style:Qt({padding:"2px 8px",height:"auto",fontSize:"12px"},u&&{borderColor:"#ff7875",color:"#ff7875"}),children:u?"强制删除":"删除"})})]})}}];return o.useEffect(()=>{F.current||(F.current=!0,ft(),Ke(),et(),at("AAPL"))},[]),e.jsxs("div",{style:{padding:"16px",height:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs(re,{style:{marginBottom:"16px",flexShrink:0},children:[e.jsx(yn,{level:3,style:{margin:"0 0 16px 0"},children:"策略参数优化"}),e.jsxs(G,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(g,{span:8,children:e.jsx(Me,{placeholder:"选择策略",style:{width:"100%"},value:l,onChange:I,children:n.map(t=>e.jsx(Ct,{value:t.id,children:t.name},t.id))})}),e.jsx(g,{span:16,children:e.jsxs(be,{children:[e.jsx(A,{icon:e.jsx(ss,{}),onClick:()=>he(!0),disabled:!l,children:"配置参数空间"}),e.jsx(A,{type:"primary",icon:e.jsx(Bt,{}),onClick:()=>{te(!0),Ne(!1),setTimeout(()=>it(),100)},disabled:!l||m.length===0,children:"启动优化"}),e.jsx(A,{icon:e.jsx(Ss,{}),onClick:()=>{console.log("刷新按钮被点击"),Ke(l||void 0)},children:"刷新"})]})})]})]}),e.jsx(re,{title:"优化任务列表",style:{flex:1,display:"flex",flexDirection:"column",minHeight:0},styles:{body:{flex:1,padding:"16px",display:"flex",flexDirection:"column",minHeight:0}},children:e.jsx(At,{columns:We,dataSource:$,rowKey:"id",loading:f,size:"small",scroll:{x:1200,y:"calc(100vh - 320px)"},pagination:{pageSize:Je.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条记录`,size:"small",onChange:(t,a)=>{Je.setCurrentPage(t),Je.setPageSize(a||20)},onShowSizeChange:(t,a)=>{Je.setPageSize(a)}},style:{flex:1}})}),e.jsxs(ze,{title:"配置参数空间",open:H,onOk:B,onCancel:()=>he(!1),width:900,confirmLoading:f,children:[e.jsx(nt,{message:"MA交叉策略参数优化指南",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"short_window"}),": 短期移动平均线周期，建议范围 3-15天"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"long_window"}),": 长期移动平均线周期，建议范围 10-60天"]}),e.jsx("p",{children:"注意：短期周期必须小于长期周期"})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(A,{type:"dashed",onClick:x,icon:e.jsx(ua,{}),block:!0,children:"添加参数"})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsxs(be,{children:[e.jsx(A,{type:"link",onClick:()=>{_([{parameter_name:"short_window",parameter_type:"int",min_value:3,max_value:15,step_size:1,description:"短期移动平均线周期"},{parameter_name:"long_window",parameter_type:"int",min_value:10,max_value:60,step_size:5,description:"长期移动平均线周期"}])},children:"📊 使用MA策略推荐配置"}),e.jsx(A,{type:"link",onClick:K,children:"🔎 自动识别策略参数"})]})}),m.map((t,a)=>e.jsx(re,{size:"small",style:{marginBottom:"8px"},children:e.jsxs(G,{gutter:[8,8],children:[e.jsx(g,{span:4,children:e.jsx(je,{placeholder:"参数名",value:t.parameter_name,onChange:d=>j(a,"parameter_name",d.target.value)})}),e.jsx(g,{span:3,children:e.jsxs(Me,{value:t.parameter_type==="choice"&&Y(t.choices)?"boolean":t.parameter_type,onChange:d=>{const u=String(d);u==="boolean"?(j(a,"parameter_type","choice"),j(a,"choices",[!0,!1]),t.description||j(a,"description","布尔类型")):j(a,"parameter_type",u)},style:{width:"100%"},children:[e.jsx(Ct,{value:"int",children:"整数"}),e.jsx(Ct,{value:"float",children:"小数"}),e.jsx(Ct,{value:"choice",children:"选择"}),e.jsx(Ct,{value:"boolean",children:"布尔"})]})}),t.parameter_type!=="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(g,{span:3,children:e.jsx(kt,{placeholder:"最小值",value:t.min_value,onChange:d=>j(a,"min_value",d),style:{width:"100%"}})}),e.jsx(g,{span:3,children:e.jsx(kt,{placeholder:"最大值",value:t.max_value,onChange:d=>j(a,"max_value",d),style:{width:"100%"}})})]}),t.parameter_type==="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(g,{span:6,children:e.jsx(Me,{mode:"tags",style:{width:"100%"},placeholder:"备选项（输入后回车添加）",value:(t.choices||[]).map(d=>typeof d=="boolean"?d?"true":"false":String(d)),onChange:d=>{const u=d.map(C=>{if(typeof C=="string"){const z=C.trim();if(z.toLowerCase()==="true")return!0;if(z.toLowerCase()==="false")return!1;const P=Number(z);return isNaN(P)?z:P}return C});j(a,"choices",u)}})}),e.jsx(g,{span:3,children:e.jsx(A,{onClick:()=>j(a,"choices",[!0,!1]),style:{width:"100%"},children:"填充布尔(True/False)"})})]}),e.jsx(g,{span:4,children:e.jsx(je,{placeholder:"描述",value:t.description,onChange:d=>j(a,"description",d.target.value)})}),e.jsx(g,{span:2,children:e.jsx(A,{type:"text",danger:!0,icon:e.jsx(Kt,{}),onClick:()=>p(a)})})]})},a))]}),e.jsxs(ze,{title:"启动参数优化",open:$e,onOk:()=>J.submit(),onCancel:()=>te(!1),width:700,confirmLoading:f,children:[e.jsx(nt,{message:"优化说明",description:"系统将自动测试不同参数组合，找到最优的策略参数。建议先用较少试验次数快速测试。",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(L,{form:J,onFinish:Te,layout:"vertical",children:[e.jsx(L.Item,{name:"name",label:"任务名称",rules:[{required:!0,message:"请输入任务名称"}],children:e.jsx(je,{placeholder:"如: AAPL_20240101_MA策略优化",onChange:t=>{t.target.value!==Ve()?Ne(!0):Ne(!1)}})}),e.jsx(L.Item,{name:"description",label:"任务描述",children:e.jsx(je.TextArea,{placeholder:"描述此次优化的目的和预期...",rows:2})}),e.jsxs(G,{gutter:[16,16],children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"objective_function",label:"优化目标",initialValue:"sharpe_ratio",children:e.jsxs(Me,{children:[e.jsx(Ct,{value:"sharpe_ratio",children:"夏普比率 (推荐)"}),e.jsx(Ct,{value:"total_return",children:"总收益率"}),e.jsx(Ct,{value:"annual_return",children:"年化收益率"})]})})}),e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"n_trials",label:"试验次数",initialValue:50,extra:"建议: 快速测试50次，详细优化100-200次",children:e.jsx(kt,{min:10,max:1e3,style:{width:"100%"}})})})]}),e.jsxs(G,{gutter:[16,16],children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"symbol",label:"交易品种",rules:[{required:!0,message:"请选择交易品种"}],initialValue:"AAPL",children:e.jsx(Me,{placeholder:"选择股票代码",showSearch:!0,filterOption:(t,a)=>{var d,u;return((d=a==null?void 0:a.label)!=null?d:"").toLowerCase().includes(t.toLowerCase())||((u=a==null?void 0:a.value)!=null?u:"").toLowerCase().includes(t.toLowerCase())},onChange:t=>{t&&(at(t),it())},options:xt.map(t=>({value:t.symbol,label:`${t.symbol} - ${t.name}`}))})})}),e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"initial_capital",label:"初始资金",initialValue:1e5,children:e.jsx(kt,{min:1e3,style:{width:"100%"},formatter:t=>`¥ ${t}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:t=>t==null?void 0:t.replace(/¥\s?|(,*)/g,"")})})})]}),e.jsx(L.Item,{label:"快捷时间选择",children:e.jsxs(be,{wrap:!0,children:[e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent1y"),children:"最近1年"}),e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent3y"),children:"最近3年"}),e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent5y"),children:"最近5年"}),e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent6y"),children:"最近6年"}),e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent7y"),children:"最近7年"}),e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent8y"),children:"最近8年"}),e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent9y"),children:"最近9年"}),e.jsx(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("recent10y"),children:"最近10年"}),pe.min_date&&pe.max_date&&e.jsxs(A,{size:"small",icon:e.jsx(wt,{}),onClick:()=>Pe("full"),type:"primary",children:["全部数据 (",pe.min_date," ~ ",pe.max_date,")"]})]})}),e.jsxs(G,{gutter:[16,16],children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"start_date",label:"开始日期",rules:[{required:!0,message:"请选择开始日期"}],initialValue:M("2023-01-01"),children:e.jsx(Mt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择开始日期"})})}),e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"end_date",label:"结束日期",rules:[{required:!0,message:"请选择结束日期"}],initialValue:M("2024-12-31"),children:e.jsx(Mt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择结束日期"})})})]}),e.jsx(nt,{message:"注意事项",description:e.jsxs("ul",{style:{margin:0,paddingLeft:"20px"},children:[e.jsx("li",{children:"确保已配置参数空间"}),e.jsx("li",{children:"优化过程可能需要几分钟到几小时"}),e.jsx("li",{children:"可以在任务列表中查看进度"})]}),type:"warning",showIcon:!0})]})]}),e.jsx(ze,{title:"优化任务详情",open:W,onCancel:()=>{oe(!1),U(null),Ye(null)},footer:null,width:1e3,children:b&&e.jsxs("div",{children:[e.jsx(nt,{message:`任务状态: ${b.status==="completed"?"已完成":b.status}`,type:b.status==="completed"?"success":"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(Ut,{defaultActiveKey:"1",children:[e.jsxs(Gs,{tab:"基本信息",children:[e.jsxs(G,{gutter:[16,16],children:[e.jsxs(g,{span:12,children:[e.jsx(Ee,{strong:!0,children:"任务名称: "}),e.jsx(Ee,{children:b.name})]}),e.jsxs(g,{span:12,children:[e.jsx(Ee,{strong:!0,children:"优化目标: "}),e.jsx(Ee,{children:b.objective_function==="sharpe_ratio"?"夏普比率":b.objective_function==="total_return"?"总收益率":b.objective_function==="annual_return"?"年化收益率":"未知"})]}),e.jsxs(g,{span:12,children:[e.jsx(Ee,{strong:!0,children:"试验次数: "}),e.jsxs(Ee,{children:[b.completed_trials,"/",b.total_trials]})]}),e.jsxs(g,{span:12,children:[e.jsx(Ee,{strong:!0,children:"最佳得分: "}),e.jsx(Ee,{children:b.best_score?b.best_score.toFixed(4):"-"})]})]}),b.optimization_config&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Ee,{strong:!0,children:"回测配置:"}),e.jsxs(G,{gutter:[16,8],style:{marginTop:"8px"},children:[e.jsxs(g,{span:12,children:[e.jsx(Ee,{type:"secondary",children:"交易品种: "}),e.jsx(ke,{color:"green",children:b.optimization_config.backtest_config.symbol})]}),e.jsxs(g,{span:12,children:[e.jsx(Ee,{type:"secondary",children:"初始资金: "}),e.jsxs(ke,{color:"blue",children:["¥",b.optimization_config.backtest_config.initial_capital.toLocaleString()]})]}),e.jsxs(g,{span:12,children:[e.jsx(Ee,{type:"secondary",children:"开始日期: "}),e.jsx(ke,{children:b.optimization_config.backtest_config.start_date})]}),e.jsxs(g,{span:12,children:[e.jsx(Ee,{type:"secondary",children:"结束日期: "}),e.jsx(ke,{children:b.optimization_config.backtest_config.end_date})]})]})]}),b.best_parameters&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Ee,{strong:!0,children:"最优参数组合:"}),e.jsx("div",{style:{marginTop:"8px",maxHeight:"120px",overflowY:"auto"},children:Object.entries(b.best_parameters).map(([t,a])=>e.jsxs(ke,{color:"blue",style:{marginBottom:"4px",marginRight:"4px",fontSize:"11px",padding:"2px 6px"},children:[t==="short_window"?"短期均线":t==="long_window"?"长期均线":t==="min_reversal_points"?"反转点数":t==="lookback_period"?"回望周期":t==="min_price_change"?"最小价格变化":t==="signal_strength_threshold"?"信号强度阈值":t==="max_trading_range"?"最大交易范围":t==="batch_count"?"分批次数":t==="batch_interval"?"分批间隔":t==="position_size_per_batch"?"分批仓位":t==="stop_loss_ratio"?"止损比例":t==="take_profit_ratio"?"止盈比例":t==="rsi_oversold"?"RSI超卖":t==="rsi_overbought"?"RSI超买":t==="volume_threshold"?"成交量阈值":t==="max_extremums"?"最大极值点":t==="min_extremum_distance"?"极值点距离":t,": ",typeof a=="number"?a.toFixed(2):a]},t))})]})]},"1"),e.jsx(Gs,{tab:"回测结果",children:y?e.jsxs("div",{children:[e.jsxs(G,{gutter:[16,16],children:[e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"总收益率",value:y.total_return*100,precision:2,suffix:"%",valueStyle:{color:y.total_return>=0?"#3f8600":"#cf1322"}})})}),e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"年化收益率",value:y.annual_return*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"最大回撤",value:y.max_drawdown*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"夏普比率",value:y.sharpe_ratio,precision:3,valueStyle:{color:y.sharpe_ratio>=1?"#3f8600":"#cf1322"}})})})]}),e.jsxs(G,{gutter:[16,16],style:{marginTop:"16px"},children:[e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"胜率",value:y.win_rate*100,precision:2,suffix:"%",valueStyle:{color:y.win_rate>=.5?"#3f8600":"#cf1322"}})})}),e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"盈亏比",value:y.profit_factor,precision:2,valueStyle:{color:y.profit_factor>=1?"#3f8600":"#cf1322"}})})}),e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"交易次数",value:y.trades?y.trades.length:0,valueStyle:{color:"#1890ff"}})})}),e.jsx(g,{span:6,children:e.jsx(re,{size:"small",children:e.jsx(le,{title:"Alpha",value:y.alpha,precision:4,valueStyle:{color:y.alpha>=0?"#3f8600":"#cf1322"}})})})]}),e.jsx(nt,{message:"参数说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"夏普比率"}),": 风险调整后收益，",">"," 1.0为优秀，",">"," 2.0为卓越"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"胜率"}),": 盈利交易占总交易的比例，",">"," 50%为良好"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏比"}),": 平均盈利/平均亏损，",">"," 1.0表示盈利大于亏损"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Alpha"}),": 相对于市场的超额收益，",">"," 0表示跑赢市场"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]}):e.jsx("div",{style:{textAlign:"center",padding:"40px"},children:e.jsx(Ee,{type:"secondary",children:"加载回测结果中..."})})},"2")]})]})}),e.jsx(ze,{title:"所有回测试验结果",open:me,onCancel:()=>{Z(!1),Le([]),U(null)},footer:null,width:1e3,children:b&&e.jsxs("div",{children:[e.jsx(nt,{message:`任务: ${b.name} - 共${Ie.length}个试验，按得分降序排列`,type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx(At,{dataSource:Ie,rowKey:t=>t.id||t.trial_number||Math.random(),pagination:!1,size:"small",scroll:{y:400},columns:[{title:"排名",key:"rank",width:60,render:(t,a,d)=>{const u=a.rank||d+1;return e.jsx(ke,{color:u===1?"gold":u===2?"silver":u===3?"orange":"default",children:u})}},{title:"得分",dataIndex:"objective_value",key:"objective_value",width:100,render:t=>e.jsx(Ee,{strong:!0,style:{color:"#1890ff"},children:t?t.toFixed(4):"-"}),sorter:(t,a)=>(t.objective_value||0)-(a.objective_value||0),defaultSortOrder:"descend"},{title:"参数组合",dataIndex:"parameters",key:"parameters",width:200,render:t=>e.jsx("div",{children:Object.entries(t||{}).map(([a,d])=>e.jsxs(ke,{color:"blue",style:{marginBottom:"2px"},children:[a==="short_window"?"短期":a==="long_window"?"长期":a,": ",d]},a))})},{title:"年化收益",dataIndex:"annual_return",key:"annual_return",width:90,render:t=>{if(t==null)return"-";const a=t>=0?"#3f8600":"#cf1322";return e.jsxs(Ee,{style:{color:a,fontWeight:"bold"},children:[(t*100).toFixed(1),"%"]})}},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",width:90,render:t=>t==null?"-":e.jsxs(Ee,{style:{color:"#3f8600",fontWeight:"bold"},children:[(Math.abs(t)*100).toFixed(1),"%"]})},{title:"交易次数",dataIndex:"total_trades",key:"total_trades",width:80,render:t=>e.jsx(Ee,{type:"secondary",children:t||0})},{title:"执行时间",dataIndex:"execution_time",key:"execution_time",width:80,render:t=>e.jsx(Ee,{type:"secondary",children:t?`${(t*1e3).toFixed(0)}ms`:"-"})},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:150,render:t=>t?M.utc(t).tz("Asia/Shanghai").format("HH:mm:ss"):"-"},{title:"日志",key:"logs",width:80,render:(t,a)=>e.jsx(ye,{title:"查看日志",children:e.jsx(A,{type:"text",size:"small",icon:e.jsx(ps,{}),onClick:()=>Ge(a),style:{color:"#1890ff"}})})}]}),e.jsx(nt,{message:"说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"排名"}),": 按优化目标得分排序，金牌为最佳结果"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"得分"}),": ",b.objective_function==="sharpe_ratio"?"夏普比率":b.objective_function==="total_return"?"总收益率":b.objective_function==="annual_return"?"年化收益率":"优化目标","得分"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"参数组合"}),": 该试验使用的策略参数"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]})}),e.jsx(ze,{title:"试验日志",open:ce,onCancel:()=>qe(!1),footer:null,width:800,style:{top:20},children:e.jsx("div",{style:{maxHeight:"600px",overflow:"auto"},children:ee&&ee.length>0?e.jsx("div",{style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px"},children:ee.map((t,a)=>{var d;const u=C=>{switch(C==null?void 0:C.toUpperCase()){case"ERROR":return"#ff4d4f";case"WARNING":return"#faad14";case"DEBUG":return"#722ed1";case"INFO":default:return"#1890ff"}};return e.jsxs("div",{style:{marginBottom:"4px",padding:"2px 4px",backgroundColor:"#f5f5f5",borderRadius:"2px"},children:[e.jsx("span",{style:{color:"#666",marginRight:"8px"},children:t.timestamp?M(t.timestamp).format("HH:mm:ss.SSS"):""}),e.jsxs("span",{style:{color:u(t.level),fontWeight:"bold",marginRight:"8px",minWidth:"60px",display:"inline-block"},children:["[",((d=t.level)==null?void 0:d.toUpperCase())||"INFO","]"]}),e.jsx("span",{style:{color:"#333"},children:t.message})]},a)})}):e.jsx("div",{style:{textAlign:"center",padding:"40px",color:"#999"},children:"暂无日志数据"})})})]})},bn=o.memo(jn);var Ft=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});const{RangePicker:vn}=Mt,{Option:bt}=Me,Js=["你是一个专注于股票量化交易的金融大模型，充当价格预测引擎。","","你的任务是根据输入的K线数据、账户状态和最近成交记录，预测下一根K线的收盘价。","","要求：","1）只能输出一个数字，不要任何文字、解释、符号或单位；","2）数字应为合理的价格水平，不为负数，尽量接近当前价格量级；","3）可以保留2到6位小数；","4）充分利用给出的周期、买入/卖出阈值、止损和止盈参数来判断趋势和风险；","5）只使用输入的数据进行推断，不要编造外部信息或新闻；","6）如果历史数据较少，也要给出尽可能稳健的预测，而不是报错。"].join(`
`),_n=()=>{const[n]=L.useForm(),[r,l]=o.useState([]),[v,m]=o.useState(!1),[_,$]=o.useState(!1),[D,f]=o.useState(null),[k,F]=o.useState([]),[J,H]=o.useState(!1),[he,$e]=o.useState({}),[te,W]=o.useState({}),[oe,b]=o.useState([]),[U,y]=o.useState([]),[Ye,me]=o.useState(!1),[Z,Ie]=o.useState("deepseek"),[Le,ce]=o.useState(""),[qe,ee]=o.useState(!1),[De,pe]=o.useState(!1),Re=L.useWatch("data_source",n)||"database",xt=o.useMemo(()=>Re==="database"?[{value:"1d",label:"日线"}]:[{value:"1m",label:"1分钟"},{value:"5m",label:"5分钟"},{value:"15m",label:"15分钟"},{value:"30m",label:"30分钟"},{value:"60m",label:"60分钟"}],[Re]),Ze=()=>Ft(void 0,null,function*(){m(!0);try{const I=yield q.get("/api/ai-investment/runs");l(I.data||[])}catch(I){h.error((I==null?void 0:I.message)||"获取AI投资运行列表失败")}finally{m(!1)}}),Ce=I=>Ft(void 0,null,function*(){H(!0);try{const x=yield q.get(`/api/ai-investment/run/${I.id}/records`);F(x.data||[])}catch(x){h.error((x==null?void 0:x.message)||"获取AI投资交易明细失败")}finally{H(!1)}}),Ne=I=>Ft(void 0,null,function*(){ee(!0);try{const p=(yield q.get("/api/ai-investment/prompt-settings",{params:{model_type:I}})).data||[];p.length>0?ce(p[0].system_prompt||""):ce(Js)}catch(x){h.error((x==null?void 0:x.message)||"加载AI提示词失败"),ce(Js)}finally{ee(!1)}});o.useEffect(()=>{Ze(),Ne(Z),(()=>Ft(void 0,null,function*(){me(!0);try{const x=yield as();y(x)}catch{}finally{me(!1)}}))()},[]),o.useEffect(()=>{Re==="database"?n.setFieldsValue({frequency:"1d"}):n.setFieldsValue({frequency:"1m"})},[Re,n]),o.useEffect(()=>{Ne(Z)},[Z]);const Ve=()=>Ft(void 0,null,function*(){var I,x,p,j,Y;try{const B=yield n.validateFields(),K=B.symbol,Se=B.timeRange,Ue=B.models||[];if(!K||!Se||Ue.length===0){h.warning("请填写股票代码、时间范围并选择至少一个模型");return}const Fe=Se[0].toDate().toISOString(),Te=Se[1].toDate().toISOString(),Ge=B.data_source||"database",We=B.frequency||(Ge==="database"?"1d":"1m"),t={name:B.name||void 0,symbol:K,start_time:Fe,end_time:Te,data_source:Ge,frequency:We,models:Ue,initial_capital:B.initial_capital||1e5,buy_threshold:(I=B.buy_threshold)!=null?I:.002,sell_threshold:(x=B.sell_threshold)!=null?x:-.002,stop_loss_pct:(p=B.stop_loss_pct)!=null?p:.05,take_profit_pct:(j=B.take_profit_pct)!=null?j:.1,window:B.window||20};$(!0);const a=yield q.post("/api/ai-investment/run",t);if(a.data&&a.data.status==="success"){h.success("AI实时投资回放完成");const d=a.data;$e(d.metrics||{}),W(d.equity_curves||{}),b(d.price_series||[]),yield Ze()}else h.error(((Y=a.data)==null?void 0:Y.message)||"AI投资回放失败")}catch(B){if(B!=null&&B.errorFields)return;h.error((B==null?void 0:B.message)||"AI投资回放执行失败")}finally{$(!1)}}),it=()=>Ft(void 0,null,function*(){if(!Z){h.warning("请选择需要配置提示词的模型");return}if(!Le||!Le.trim()){h.warning("请输入系统提示词内容");return}pe(!0);try{yield q.post("/api/ai-investment/prompt-settings",{model_type:Z,scene:"ai_investment",system_prompt:Le}),h.success("提示词已保存")}catch(I){h.error((I==null?void 0:I.message)||"保存提示词失败")}finally{pe(!1)}}),ft=I=>{f(I),Ce(I)},et=[{title:"名称",dataIndex:"name",key:"name",width:200,ellipsis:!0},{title:"股票代码",dataIndex:"symbol",key:"symbol",width:100},{title:"模型",dataIndex:"models",key:"models",width:140,render:I=>e.jsx(be,{size:"small",children:(I||[]).map(x=>e.jsx(ke,{children:x},x))})},{title:"状态",dataIndex:"status",key:"status",width:100,render:I=>e.jsx(ke,{color:I==="completed"?"green":"blue",children:I})},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:180,render:I=>I?M(I).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:180,render:I=>I?M(I).format("YYYY-MM-DD HH:mm:ss"):"-"}],at=[{title:"时间",dataIndex:"timestamp",key:"timestamp",render:I=>I?M(I).format("YYYY-MM-DD HH:mm"):"-"},{title:"模型",dataIndex:"model_type",key:"model_type"},{title:"预测价格",dataIndex:"predicted_price",key:"predicted_price",render:I=>I.toFixed(4)},{title:"实际价格",dataIndex:"actual_price",key:"actual_price",render:I=>I.toFixed(4)},{title:"操作",dataIndex:"action",key:"action"},{title:"持仓",dataIndex:"position",key:"position",render:I=>I.toFixed(2)},{title:"单笔收益",dataIndex:"pnl",key:"pnl",render:I=>I.toFixed(2)},{title:"累计收益",dataIndex:"cumulative_pnl",key:"cumulative_pnl",render:I=>I.toFixed(2)},{title:"账户权益",dataIndex:"equity",key:"equity",render:I=>I.toFixed(2)}],Pe=o.useMemo(()=>{const I=[],x=[];return Object.keys(te||{}).forEach(p=>{const Y=(te[p]||[]).map(B=>M(B.date).format("YYYY-MM-DD HH:mm"));Y.length>x.length&&x.splice(0,x.length,...Y)}),Object.keys(te||{}).forEach(p=>{const Y=(te[p]||[]).map(B=>B.equity);I.push({type:"line",name:p,data:Y,smooth:!0})}),{tooltip:{trigger:"axis"},legend:{top:0},grid:{left:50,right:30,top:40,bottom:50},xAxis:{type:"category",data:x},yAxis:{type:"value",scale:!0},series:I}},[te]),ct=o.useMemo(()=>{const I=oe.map(p=>M(p.date).format("YYYY-MM-DD HH:mm")),x=oe.map(p=>p.close);return{tooltip:{trigger:"axis"},grid:{left:50,right:30,top:40,bottom:50},xAxis:{type:"category",data:I},yAxis:{type:"value",scale:!0},series:[{type:"line",name:"价格",data:x,smooth:!0}]}},[oe]),Ke=o.useMemo(()=>{const I=[];return Object.keys(he||{}).forEach(x=>{const p=he[x];I.push(e.jsx(g,{span:6,children:e.jsxs(re,{size:"small",title:x,children:[e.jsx(le,{title:"总收益率",value:p.total_return*100,precision:2,suffix:"%"}),e.jsx(le,{title:"最大回撤",value:p.max_drawdown*100,precision:2,suffix:"%"}),e.jsx(le,{title:"夏普比率",value:p.sharpe_ratio,precision:2})]})},x))}),I},[he]);return e.jsxs("div",{children:[e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:16,children:e.jsx(re,{title:e.jsxs(be,{children:[e.jsx(Bt,{}),"AI实时投资跑数配置"]}),children:e.jsxs(L,{form:n,layout:"vertical",initialValues:{data_source:"database",frequency:"1d",initial_capital:1e5,buy_threshold:.002,sell_threshold:-.002,stop_loss_pct:.05,take_profit_pct:.1,window:20},children:[e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"name",label:"运行名称",children:e.jsx(je,{placeholder:"可选，例如：AAPL-日内回放"})})}),e.jsx(g,{span:12,children:Re==="database"?e.jsx(L.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请选择股票代码"}],children:e.jsx(Me,{showSearch:!0,placeholder:"从市场数据管理中选择股票",loading:Ye,optionFilterProp:"children",filterOption:(I,x)=>{var p;return String((p=x==null?void 0:x.children)!=null?p:"").toLowerCase().includes(I.toLowerCase())},children:U.map(I=>e.jsxs(bt,{value:I.symbol,children:[I.symbol,"（",I.name,"）"]},I.id))})}):e.jsx(L.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(je,{placeholder:"例如：HK.00700"})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"timeRange",label:"时间范围",rules:[{required:!0,message:"请选择时间范围"}],children:e.jsx(vn,{showTime:!0,style:{width:"100%"},presets:[{label:"最近一周",value:[M().subtract(7,"day"),M()]},{label:"最近一月",value:[M().subtract(1,"month"),M()]},{label:"最近一年",value:[M().subtract(1,"year"),M()]},{label:"最近3年",value:[M().subtract(3,"year"),M()]},{label:"最近5年",value:[M().subtract(5,"year"),M()]}],disabledDate:I=>I&&I>M().endOf("day")})})}),e.jsx(g,{span:12,children:e.jsx(L.Item,{name:"models",label:"AI模型",rules:[{required:!0,message:"请选择至少一个模型"}],children:e.jsxs(Me,{mode:"multiple",placeholder:"支持多选，用于模型对比或加权",children:[e.jsx(bt,{value:"qwen",children:"千问"}),e.jsx(bt,{value:"kimi",children:"Kimi"}),e.jsx(bt,{value:"deepseek",children:"DeepSeek"})]})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:8,children:e.jsx(L.Item,{name:"data_source",label:"数据源",children:e.jsxs(Me,{children:[e.jsx(bt,{value:"database",children:"市场数据管理(日线)"}),e.jsx(bt,{value:"futu",children:"富途 OpenAPI 实时"})]})})}),e.jsx(g,{span:8,children:e.jsx(L.Item,{name:"frequency",label:"数据频率",children:e.jsx(Me,{children:xt.map(I=>e.jsx(bt,{value:I.value,children:I.label},I.value))})})}),e.jsx(g,{span:8,children:e.jsx(L.Item,{name:"initial_capital",label:"初始资金",children:e.jsx(je,{type:"number",min:0})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:6,children:e.jsx(L.Item,{name:"buy_threshold",label:"买入阈值(预测涨幅)",children:e.jsx(je,{type:"number",step:"0.001"})})}),e.jsx(g,{span:6,children:e.jsx(L.Item,{name:"sell_threshold",label:"卖出阈值(预测跌幅)",children:e.jsx(je,{type:"number",step:"0.001"})})}),e.jsx(g,{span:6,children:e.jsx(L.Item,{name:"stop_loss_pct",label:"止损比例",children:e.jsx(je,{type:"number",step:"0.01"})})}),e.jsx(g,{span:6,children:e.jsx(L.Item,{name:"take_profit_pct",label:"止盈比例",children:e.jsx(je,{type:"number",step:"0.01"})})})]}),e.jsx(G,{gutter:16,children:e.jsx(g,{span:6,children:e.jsx(L.Item,{name:"window",label:"模型窗口长度",children:e.jsx(je,{type:"number",min:2})})})}),e.jsx(G,{justify:"end",children:e.jsx(g,{children:e.jsx(A,{type:"primary",icon:e.jsx(Bt,{}),loading:_,onClick:Ve,children:"启动AI跑数"})})})]})})}),e.jsx(g,{span:8,children:e.jsx(re,{title:e.jsxs(be,{children:[e.jsx(yt,{}),"历史运行"]}),children:e.jsx(Xt,{rowKey:"id",loading:v,dataSource:r,columns:et,size:"small",scroll:{x:!0},pagination:{pageSize:5},onRow:I=>({onClick:()=>ft(I)})})})})]}),e.jsx(G,{gutter:16,style:{marginTop:16},children:e.jsx(g,{span:24,children:e.jsxs(re,{title:"AI提示词设置",children:[e.jsx(G,{gutter:16,children:e.jsx(g,{span:8,children:e.jsxs(be,{children:[e.jsx("span",{children:"选择模型"}),e.jsxs(Me,{style:{minWidth:160},value:Z,onChange:I=>Ie(I),children:[e.jsx(bt,{value:"deepseek",children:"DeepSeek"}),e.jsx(bt,{value:"qwen",children:"千问"}),e.jsx(bt,{value:"kimi",children:"Kimi"})]})]})})}),e.jsx(G,{style:{marginTop:16},children:e.jsx(g,{span:24,children:e.jsx(je.TextArea,{value:Le,onChange:I=>ce(I.target.value),autoSize:{minRows:4,maxRows:20},style:{whiteSpace:"pre-wrap"},placeholder:"请输入系统提示词，将作为大模型的系统角色描述"})})}),e.jsx(G,{justify:"end",style:{marginTop:16},children:e.jsx(g,{children:e.jsxs(be,{children:[e.jsx(A,{onClick:()=>Ne(Z),loading:qe,children:"重新加载"}),e.jsx(A,{type:"primary",loading:De,onClick:it,children:"保存提示词"})]})})})]})})}),e.jsxs(G,{gutter:16,style:{marginTop:16},children:[e.jsx(g,{span:12,children:e.jsx(re,{title:"价格与权益曲线",children:e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:24,style:{marginBottom:16},children:e.jsx($t,{option:ct,style:{height:260}})}),e.jsx(g,{span:24,children:e.jsx($t,{option:Pe,style:{height:260}})})]})})}),e.jsx(g,{span:12,children:e.jsx(re,{title:"模型绩效对比",children:e.jsx(G,{gutter:16,children:Ke})})})]}),e.jsx(G,{gutter:16,style:{marginTop:16},children:e.jsx(g,{span:24,children:e.jsx(re,{title:"交易明细",children:e.jsx(Xt,{rowKey:(I,x)=>`${I.model_type}-${I.timestamp}-${x}`,loading:J,dataSource:k,columns:at,size:"small",pagination:{pageSize:10},scroll:{x:1200}})})})})]})};var Zs=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});const{Title:Sn,Text:is}=It,wn=()=>{const n=Lt(),[r,l]=o.useState([]),[v,m]=o.useState(!1),_=o.useRef(!1),$=()=>Zs(void 0,null,function*(){m(!0);try{const H=yield Vt();console.log("获取到的策略数据:",H),l(H)}catch{h.error("获取策略列表失败")}finally{m(!1)}});o.useEffect(()=>{_.current||(_.current=!0,$())},[]);const D=()=>{n("/strategy/edit")},f=H=>{H&&n(`/strategy/edit/${H}`)},k=H=>Zs(void 0,null,function*(){if(H)try{yield ga(H),h.success("策略删除成功"),$()}catch{h.error("删除策略失败")}}),F=H=>{H&&n(`/backtest?strategy=${H}`)},J=()=>v?e.jsx(Rt,{tip:"加载中..."}):r.length===0?e.jsx(zs,{description:"暂无策略",image:zs.PRESENTED_IMAGE_SIMPLE}):e.jsx(mt,{className:"strategy-list",itemLayout:"horizontal",dataSource:r,renderItem:H=>e.jsxs(mt.Item,{className:"strategy-list-item",style:{padding:"16px",borderRadius:"8px",backgroundColor:"#f9f9f9",marginBottom:"12px",display:"flex",justifyContent:"space-between"},children:[e.jsxs("div",{style:{flex:1,overflow:"hidden"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"8px"},children:e.jsx(is,{strong:!0,style:{fontSize:"16px",marginRight:"8px"},children:H.name})}),e.jsx(is,{type:"secondary",style:{display:"block",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:H.description||"无描述"}),H.updated_at&&e.jsxs(is,{type:"secondary",style:{fontSize:"12px"},children:["最后更新: ",new Date(H.updated_at).toLocaleString()]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center"},children:e.jsxs(be,{children:[e.jsx(A,{type:"primary",icon:e.jsx(cr,{}),onClick:()=>F(H.id),children:"回测"}),e.jsx(A,{icon:e.jsx(dr,{}),onClick:()=>f(H.id),children:"编辑"}),e.jsx(A,{danger:!0,icon:e.jsx(Kt,{}),onClick:()=>k(H.id),children:"删除"})]})})]},H.id)});return e.jsx("div",{style:{padding:"20px"},children:e.jsxs(re,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx(Sn,{level:4,style:{margin:0},children:"策略构建器"}),e.jsx(A,{type:"primary",icon:e.jsx(ua,{}),onClick:D,children:"创建新策略"})]}),e.jsx(es,{}),J()]})})};var cs=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});const{Title:kn,Text:ds}=It,{TextArea:$n}=je,Qs=()=>{const{id:n}=sa(),r=Lt(),[l]=L.useForm(),[v,m]=o.useState(""),[_,$]=o.useState(!1),[D,f]=o.useState(!1),[k,F]=o.useState(!0),[J,H]=o.useState(""),he=`from .strategy_template import StrategyTemplate
import pandas as pd
import numpy as np
import logging

logger = logging.getLogger(__name__)

class MyStrategy(StrategyTemplate):
    """
    我的自定义策略
    """
    
    def __init__(self, parameters=None):
        """初始化策略"""
        default_params = {
            # 在这里定义策略参数和默认值
        }
        
        # 合并用户参数与默认参数
        if parameters:
            default_params.update(parameters)
            
        super().__init__("我的策略", default_params)
        
    def generate_signals(self) -> pd.DataFrame:
        """
        生成交易信号
        
        Returns:
            包含信号的DataFrame，包括:
            - signal: 交易信号 (1: 买入, -1: 卖出, 0: 不操作)
            - trigger_reason: 信号触发原因
        """
        if self.data is None or self.data.empty:
            logger.warning("未设置数据或数据为空，无法生成信号")
            return pd.DataFrame()
        
        # 获取数据
        df = self.data.copy()
        
        # 添加交易信号
        df['signal'] = 0
        df['trigger_reason'] = ''
        
        # TODO: 实现您的交易逻辑
        
        # 使用log函数记录策略执行过程（可选）
        self.log("开始生成交易信号", "INFO")
        self.log(f"数据行数: {len(df)}", "DEBUG")
        
        # 示例: 当价格上涨超过2%时买入
        price_change = df['close'].pct_change() * 100
        buy_signal = price_change > 2
        df.loc[buy_signal, 'signal'] = 1
        df.loc[buy_signal, 'trigger_reason'] = "价格上涨超过2%"
        
        # 记录买入信号数量
        buy_count = buy_signal.sum()
        if buy_count > 0:
            self.log(f"生成买入信号 {buy_count} 个", "INFO")
        
        # 示例: 当价格下跌超过2%时卖出
        sell_signal = price_change < -2
        df.loc[sell_signal, 'signal'] = -1
        df.loc[sell_signal, 'trigger_reason'] = "价格下跌超过2%"
        
        # 记录卖出信号数量
        sell_count = sell_signal.sum()
        if sell_count > 0:
            self.log(f"生成卖出信号 {sell_count} 个", "INFO")
        
        self.log("交易信号生成完成", "INFO")
        
        return df
`;o.useEffect(()=>{n?(F(!1),$e(parseInt(n))):m(he)},[n]);const $e=b=>cs(void 0,null,function*(){$(!0);try{const U=yield Gr(b);U&&(l.setFieldsValue({name:U.name,description:U.description,parameters:U.parameters||{}}),m(U.code||he),H(U.template||""))}catch{h.error("获取策略详情失败")}finally{$(!1)}}),te=()=>cs(void 0,null,function*(){try{const b=yield l.validateFields();$(!0);const U=b.parameters&&typeof b.parameters=="object"?b.parameters:{},y={name:b.name,description:b.description,code:v,parameters:U,template:J};let Ye;k?Ye=yield Jr(y):n&&(Ye=yield Zr(parseInt(n),y)),Ye&&(h.success(`策略${k?"创建":"更新"}成功`),k&&Ye.id&&(r(`/strategy/edit/${Ye.id}`),F(!1)))}catch(b){b.message?h.error(b.message):h.error(`策略${k?"创建":"更新"}失败`)}finally{$(!1)}}),W=()=>cs(void 0,null,function*(){f(!0);try{const b=l.getFieldsValue(),U=b.parameters&&typeof b.parameters=="object"?b.parameters:{},y=yield Qr(v,[],U);y&&!y.error?ze.success({title:"策略代码验证通过",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码语法正确，可以正常运行。"}),y.signals&&e.jsxs("p",{children:["测试生成了 ",y.signals.length," 条数据记录。"]})]})}):ze.error({title:"策略代码验证失败",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码存在问题，详细错误信息："}),e.jsx("pre",{style:{maxHeight:"300px",overflow:"auto"},children:y.error||"未知错误"})]})})}catch{h.error("测试策略代码失败")}finally{f(!1)}}),oe=()=>{r("/strategy")};return e.jsx("div",{style:{padding:"20px"},children:e.jsx(Rt,{spinning:_,tip:"加载中...",children:e.jsx(re,{children:e.jsxs(G,{gutter:[16,16],children:[e.jsx(g,{span:24,children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsxs(be,{children:[e.jsx(A,{icon:e.jsx(pa,{}),onClick:oe,children:"返回"}),e.jsx(kn,{level:4,style:{margin:0},children:k?"创建新策略":"编辑策略"})]}),e.jsxs(be,{children:[e.jsx(A,{type:"primary",icon:e.jsx(ca,{}),onClick:te,loading:_,children:"保存"}),e.jsx(A,{icon:e.jsx(Bt,{}),onClick:W,loading:D,children:"测试"})]})]})}),e.jsx(g,{span:24,children:e.jsxs(L,{form:l,layout:"vertical",children:[e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:12,children:e.jsx(L.Item,{label:"策略名称",name:"name",rules:[{required:!0,message:"请输入策略名称"}],children:e.jsx(je,{placeholder:"请输入策略名称"})})}),e.jsx(g,{span:12,children:e.jsx(L.Item,{label:"策略描述",name:"description",children:e.jsx($n,{rows:1,placeholder:"请输入策略描述"})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:8,children:e.jsx(L.Item,{label:"分批建仓批次数 (batch_count)",name:["parameters","batch_count"],initialValue:1,children:e.jsx(je,{type:"number",min:1})})}),e.jsx(g,{span:8,children:e.jsx(L.Item,{label:"批次间隔条数 (batch_interval_bars)",name:["parameters","batch_interval_bars"],initialValue:1,children:e.jsx(je,{type:"number",min:1})})}),e.jsx(g,{span:8,children:e.jsx(L.Item,{label:"批次权重 (batch_weights)",name:["parameters","batch_weights"],tooltip:"可输入逗号分隔的数字，例如: 0.5,0.3,0.2（若为空则均分）",children:e.jsx(je,{placeholder:"例如: 0.5,0.3,0.2 或 留空"})})})]})]})}),e.jsxs(g,{span:24,children:[e.jsx(es,{orientation:"left",children:e.jsxs(be,{children:[e.jsx(hs,{}),e.jsx(ds,{strong:!0,children:"策略代码"})]})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(nt,{message:"💡 策略日志功能",description:e.jsxs("div",{children:[e.jsxs("p",{children:["您可以在策略中使用 ",e.jsx("code",{children:"self.log(message, level)"})," 函数记录执行过程："]}),e.jsxs("ul",{style:{marginBottom:0},children:[e.jsxs("li",{children:[e.jsx("code",{children:'self.log("信息内容", "INFO")'})," - 记录一般信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("调试信息", "DEBUG")'})," - 记录调试信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("警告信息", "WARNING")'})," - 记录警告信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("错误信息", "ERROR")'})," - 记录错误信息"]})]}),e.jsx("p",{style:{marginTop:"8px",marginBottom:0},children:e.jsx(ds,{type:"secondary",children:'日志将在回测历史的"控制台"按钮中查看，帮助您调试和监控策略执行过程。'})})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}})}),e.jsx("div",{style:{border:"1px solid #d9d9d9",borderRadius:"2px"},children:e.jsx(hr,{width:"100%",height:"600",language:"python",theme:"vs-dark",value:v,onChange:m,options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,folding:!0,lineNumbers:"on",rulers:[80,120],minimap:{enabled:!0}}})}),e.jsx("div",{style:{marginTop:"8px"},children:e.jsx(ds,{type:"secondary",children:"注意：策略代码必须继承自StrategyTemplate基类，并实现generate_signals方法。"})})]})]})})})})};var zt=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});ms([xs,fs,gs,ys,js,bs,vs,_s]);const{Title:Pn,Text:vt}=It,ht=n=>typeof n!="string"?String(n):n.includes("T")?n.split("T")[0]:n.includes(" ")?n.split(" ")[0]:n,In=o.memo(()=>{var n,r,l,v,m,_,$,D,f;const k=Lt(),[F,J]=o.useState(!1),[H,he]=o.useState([]),[$e,te]=o.useState([]),[W,oe]=o.useState("all"),[b,U]=o.useState(!1),[y,Ye]=o.useState(null),[me,Z]=o.useState(!1),[Ie,Le]=o.useState("performance"),[ce,qe]=o.useState(0),ee=o.useRef(null),De=o.useRef(null),[pe,Re]=o.useState(!1),xt=o.useRef(!1),Ze=[{title:"日期",dataIndex:"date",key:"date",sorter:(t,a)=>{const d=new Date(t.date),u=new Date(a.date);return d.getTime()-u.getTime()}},{title:"方向",dataIndex:"action",key:"action",filters:[{text:"买入",value:"BUY"},{text:"卖出",value:"SELL"}],onFilter:(t,a)=>a.action===t,render:t=>{const a=t==="BUY"?"买入":t==="SELL"?"卖出":t;return e.jsx(ke,{color:t==="BUY"?"red":"green",children:a})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:t=>e.jsx(ye,{title:t||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:t||"未记录"})})},{title:"期初资金",dataIndex:"before_cash",key:"before_cash",sorter:(t,a)=>t.before_cash-a.before_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"after_cash",key:"after_cash",sorter:(t,a)=>t.after_cash-a.after_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"价格",dataIndex:"price",key:"price",sorter:(t,a)=>{const d=t.price||0,u=a.price||0;return d-u},render:t=>{const a=parseFloat(t);return isNaN(a)?"-":a.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(t,a)=>t.shares-a.shares,render:t=>(parseInt(t)||0).toLocaleString()},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(t,a)=>t.value-a.value,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"手续费",dataIndex:"commission",key:"commission",sorter:(t,a)=>t.commission-a.commission,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(t,a)=>(t.position_size||0)-(a.position_size||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(t,a)=>(t.cumulative_position_ratio||0)-(a.cumulative_position_ratio||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}}],[Ce,Ne]=o.useState(!1),[Ve,it]=o.useState(null),[ft,et]=o.useState(!1),[at]=L.useForm(),[Pe,ct]=o.useState(!1),[Ke,I]=o.useState([]),x=()=>zt(void 0,null,function*(){J(!0);try{const t=yield q.get("/api/backtest-status/list");he(t.data),te(t.data)}catch(t){console.error("获取回测列表失败:",t),h.error("获取回测列表失败")}finally{J(!1)}}),p=()=>zt(void 0,null,function*(){if(H.length===0){h.warning("没有可更新的回测记录");return}ze.confirm({title:"批量更新到最新K线",content:`确定要将所有 ${H.length} 个回测记录更新到最新的K线日期吗？此操作可能需要较长时间。`,okText:"确定更新",cancelText:"取消",onOk:()=>zt(void 0,null,function*(){var t,a;Re(!0);let d=0,u=0;const C=[];try{for(const z of H)try{const P=yield q.post(`/api/backtest-status/${z.id}/update`,{update_to_date:null});P.data.status==="success"?(d++,console.log(`成功更新回测: ${z.name}`)):(u++,C.push({name:z.name,error:P.data.message||"更新失败"}),console.error(`更新回测失败: ${z.name}`,P.data.message))}catch(P){u++,C.push({name:z.name,error:((a=(t=P.response)==null?void 0:t.data)==null?void 0:a.detail)||P.message||"网络错误"}),console.error(`更新回测失败: ${z.name}`,P)}h.success(`批量更新完成！成功更新 ${d} 个回测，失败 ${u} 个`),x(),u>0&&ze.info({title:"更新结果详情",content:e.jsxs("div",{children:[e.jsxs("p",{children:["成功更新: ",d," 个"]}),e.jsxs("p",{children:["更新失败: ",u," 个"]}),C.length>0&&e.jsxs("div",{children:[e.jsx("p",{children:"失败项目:"}),e.jsx("ul",{children:C.map((z,P)=>e.jsxs("li",{children:[z.name,": ",z.error]},P))})]})]}),width:500})}catch(z){console.error("批量更新失败:",z),h.error("批量更新失败，请重试")}finally{Re(!1)}})})}),j=t=>zt(void 0,null,function*(){Z(!0);try{const a=yield q.get(`/api/backtest-status/${t}`);if(a.data.status==="success"){const d=a.data.data;d.results&&d.results.trades&&(d.results.trades=d.results.trades.sort((u,C)=>new Date(C.date).getTime()-new Date(u.date).getTime())),d.trade_records&&(d.trade_records=d.trade_records.sort((u,C)=>new Date(C.date).getTime()-new Date(u.date).getTime())),Ye(d),U(!0)}else h.error("获取回测详情失败")}catch(a){console.error("获取回测详情失败:",a),h.error("获取回测详情失败")}finally{Z(!1)}}),Y=t=>zt(void 0,null,function*(){ze.confirm({title:"确认删除",content:"此操作将永久删除该回测记录，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>zt(void 0,null,function*(){try{const a=yield q.delete(`/api/backtest-status/${t}`);a.data.status==="success"?(h.success("删除成功"),x()):h.error(a.data.message||"删除失败")}catch(a){console.error("删除回测失败:",a),h.error("删除失败，请重试")}})})}),B=t=>{it(t),at.setFieldsValue({new_name:t.name,new_description:t.description||"",update_to_date:null}),Ne(!0)},K=t=>{ct(!0),I([]),q.get(`/api/backtest-status/${t.id}`).then(a=>{if(a.data&&a.data.status==="success"){const u=(a.data.data||{}).logs||[];I(u)}else{const d=t.logs||[];I(d)}}).catch(a=>{console.error("获取日志失败:",a),h.error("获取日志失败");const d=t.logs||[];I(d)})},Se=()=>zt(void 0,null,function*(){var t,a,d;if(Ve)try{const u=yield at.validateFields();et(!0);const C={new_name:u.new_name,new_description:u.new_description||"",update_to_date:u.update_to_date?u.update_to_date.format("YYYY-MM-DD"):void 0},z=yield q.post(`/api/backtest-status/${Ve.id}/update`,C);if(z.data.status==="success"){h.success("回测更新成功！"),Ne(!1),at.resetFields(),x();const P=z.data.data;ze.success({title:"更新成功",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"新回测名称:"})," ",P.new_backtest_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"更新日期范围:"})," ",P.update_range.start_date," 至 ",P.update_range.end_date]}),P.performance_metrics&&e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("strong",{children:"性能指标:"})}),e.jsxs("ul",{children:[e.jsxs("li",{children:["总收益率: ",(P.performance_metrics.total_return*100).toFixed(2),"%"]}),e.jsxs("li",{children:["最大回撤: ",(P.performance_metrics.max_drawdown*100).toFixed(2),"%"]}),e.jsxs("li",{children:["夏普比率: ",((t=P.performance_metrics.sharpe_ratio)==null?void 0:t.toFixed(2))||"N/A"]})]})]})]}),okText:"确定"})}else h.error(z.data.message||"更新失败")}catch(u){console.error("更新回测失败:",u),h.error(((d=(a=u.response)==null?void 0:a.data)==null?void 0:d.detail)||"更新失败，请重试")}finally{et(!1)}}),Ue=[{title:"ID",dataIndex:"id",key:"id",width:60,fixed:"left",align:"center"},{title:"回测名称",dataIndex:"name",key:"name",width:180,fixed:"left",ellipsis:!0,render:t=>e.jsx(ye,{title:t,placement:"topLeft",children:e.jsx(vt,{strong:!0,style:{color:"#1890ff"},children:t})})},{title:"策略",dataIndex:"strategy_name",key:"strategy_name",width:120,ellipsis:!0,render:t=>e.jsx(ye,{title:t||"未知策略",placement:"topLeft",children:e.jsx(ke,{color:"blue",children:t||"未知"})})},{title:"自定义参数",key:"parameters",width:150,ellipsis:!0,render:(t,a)=>{const d=a.parameters;if(!d||Object.keys(d).length===0)return e.jsx(vt,{style:{color:"#999"},children:"-"});const u=d.parameters||{},C=Object.keys(u).length;if(C===0)return e.jsx(vt,{style:{color:"#999"},children:"-"});const P=Object.entries(u).slice(0,2).map(([se,S])=>`${se}:${S}`).join(", "),X=C>2?`${P}...`:P;return e.jsx(ye,{title:e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:"8px"},children:"策略参数:"}),Object.entries(u).map(([se,S])=>e.jsxs("div",{style:{marginBottom:"4px"},children:[e.jsxs("span",{style:{color:"#1890ff"},children:[se,":"]})," ",String(S)]},se))]}),placement:"topLeft",children:e.jsx(vt,{style:{color:"#722ed1",fontSize:"12px"},children:X})})}},{title:"股票",dataIndex:"instruments",key:"instruments",width:80,align:"center",render:t=>e.jsx(ke,{color:"green",children:t.join(", ")})},{title:"回测期间",key:"date_range",width:160,align:"center",render:(t,a)=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:M(a.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#999"},children:["至 ",M(a.end_date).format("YYYY-MM-DD")]})]})},{title:"状态",dataIndex:"status",key:"status",width:80,align:"center",render:t=>{const d={running:{text:"运行中",color:"processing"},completed:{text:"已完成",color:"success"},failed:{text:"失败",color:"error"}}[t]||{text:t,color:"default"};return e.jsx(ke,{color:d.color,children:d.text})}},{title:"年化收益率",key:"annual_return",width:100,align:"right",render:(t,a)=>{var d;const u=(d=a.performance_metrics)==null?void 0:d.annual_return;if(u!==void 0){const C=u>=0?"#ff4d4f":"#52c41a",z=u*100;return e.jsxs(vt,{style:{color:C,fontWeight:"bold"},children:[z>=0?"+":"",z.toFixed(1),"%"]})}return e.jsx(vt,{style:{color:"#999"},children:"-"})}},{title:"最大回撤",key:"max_drawdown",width:100,align:"right",render:(t,a)=>{var d;const u=(d=a.performance_metrics)==null?void 0:d.max_drawdown;if(u!==void 0){const C=Math.floor(u*100*100)/100;return e.jsxs(vt,{style:{color:"#ff4d4f",fontWeight:"bold"},children:[C.toFixed(1),"%"]})}return e.jsx(vt,{style:{color:"#999"},children:"-"})}},{title:"最近一次交易时间",key:"last_trade_time",width:160,align:"center",render:(t,a)=>{const d=a.trade_records||[];if(d.length===0)return e.jsx(vt,{style:{color:"#999"},children:"-"});const u=d[d.length-1],C=u==null?void 0:u.date,z=u==null?void 0:u.action,P=u==null?void 0:u.price;if(!C)return e.jsx(vt,{style:{color:"#999"},children:"-"});const X=z==="BUY"?"买入":z==="SELL"?"卖出":z||"未知",se=z==="BUY"?"#ff4d4f":z==="SELL"?"#52c41a":"#999";return e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:M(C).format("MM-DD")}),e.jsx("div",{style:{color:se,fontWeight:"bold",marginTop:"2px"},children:X}),P&&e.jsxs("div",{style:{color:"#666",fontSize:"11px",marginTop:"1px"},children:["$",parseFloat(P).toFixed(2)]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:120,align:"center",render:t=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{children:M(t).format("MM-DD")}),e.jsx("div",{style:{color:"#999"},children:M(t).format("HH:mm")})]})},{title:"操作",key:"actions",width:180,fixed:"right",render:(t,a)=>e.jsxs(be,{size:"small",children:[e.jsx(ye,{title:"查看详情",children:e.jsx(A,{type:"text",icon:e.jsx(ws,{}),onClick:()=>j(a.id),size:"small",style:{color:"#1890ff"}})}),e.jsx(ye,{title:"历史记录",children:e.jsx(A,{type:"text",icon:e.jsx(Ht,{}),onClick:()=>k(`/backtest-history/${a.id}`),size:"small",style:{color:"#52c41a"}})}),e.jsx(ye,{title:"更新数据",children:e.jsx(A,{type:"text",icon:e.jsx(Ot,{}),onClick:()=>B(a),size:"small",style:{color:"#faad14"}})}),e.jsx(ye,{title:"查看日志",children:e.jsx(A,{type:"text",icon:e.jsx(ps,{}),onClick:()=>K(a),size:"small",style:{color:"#722ed1"}})}),e.jsx(ye,{title:"删除",children:e.jsx(A,{type:"text",danger:!0,icon:e.jsx(Kt,{}),onClick:()=>Y(a.id),size:"small"})})]})}],Fe=(t,a,d)=>{if(!t||t.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const u=t.filter(R=>R&&R.date&&R.equity!==void 0&&!isNaN(Number(R.equity)));if(u.length===0)return{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};let C=[],z=[];const P=new Map;u.forEach((R,Q)=>{const Ae=ht(R.date);P.set(Ae,Q)}),a&&a.length>0&&a.forEach(R=>{const Q=ht(R.date),Ae=P.get(Q);if(Ae!==void 0){const He={name:R.action==="BUY"?"买入点":"卖出点",value:u[Ae].equity,xAxis:Ae,yAxis:u[Ae].equity,itemStyle:{color:R.action==="BUY"?"#f64034":"#00b46a"}};R.action==="BUY"?C.push(He):z.push(He)}});let X=-1,se=-1,S=0,de="",ve="",ie=0,_e=0;if(u.length>0){let R=u[0].equity,Q=0,Ae=0;for(let He=1;He<u.length;He++)u[He].equity>R?(R=u[He].equity,Ae=He):(Q=(R-u[He].equity)/R*100,Q>S&&(S=Q,X=Ae,se=He,de=u[Ae].date,ve=u[He].date,ie=R,_e=u[He].equity));console.log(`最大回撤区间索引: ${X} - ${se}`),console.log(`最大回撤: ${S.toFixed(2)}%, 从 ${de} 到 ${ve}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(R){if(Array.isArray(R)&&R.length>0){const Ae=R[0].axisValue,He=R[0].data;for(let ue=0;ue<R.length;ue++)if(R[ue].componentType==="markArea")return`最大回撤: ${S.toFixed(2)}%<br/>
                        开始日期: ${de}<br/>
                        最高点: ¥${ie.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${ve}<br/>
                        最低点: ¥${_e.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let rt="";for(let ue=0;ue<R.length;ue++){const Qe=R[ue];if(Qe.seriesName==="买入点"||Qe.seriesName==="卖出点"){const rs=ht(Ae),Et=a.find(Be=>ht(Be.date)===rs&&(Qe.seriesName==="买入点"&&Be.action==="BUY"||Qe.seriesName==="卖出点"&&Be.action==="SELL"));if(Et){const Be=Et.trigger_reason||"未记录原因";rt=`<br/><span style="color:${Qe.color}">● ${Qe.seriesName}</span>`,rt+=`<br/><span style="color:#555; font-size:12px">原因: ${Be}</span>`}else rt=`<br/><span style="color:${Qe.color}">● ${Qe.seriesName}</span>`;break}}return`${Ae}<br/>策略收益: ¥${parseFloat(He).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${rt}`}const Q=R.value;return`${R.name}: ¥${parseFloat(Q).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:u.map(R=>R.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:u.map(R=>R.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new da(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...C.map(R=>({name:"买入点",coord:[R.xAxis,R.yAxis],value:R.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...z.map(R=>({name:"卖出点",coord:[R.xAxis,R.yAxis],value:R.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${S.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[X>=0&&se>=0?[{name:"最大回撤开始",xAxis:X,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:se,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:u.map(()=>d),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:d,label:{formatter:"初始资金: ¥"+d.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(R){return`初始资金: ¥${d.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},Te=(t,a)=>{if(!a||!Array.isArray(a)||a.length===0)return console.warn(`计算MA${t}失败: 数据无效`),[];const d=[];for(let u=0;u<a.length;u++){if(u<t-1){d.push("-");continue}let C=0,z=0;for(let P=0;P<t;P++){const X=a[u-P];if(X&&X.length>=4){const se=Number(X[1]);!isNaN(se)&&se>0&&(C+=se,z++)}}z>0?d.push((C/z).toFixed(2)):d.push("-")}return d},Ge=(t,a)=>{var d;const u=`${((d=y==null?void 0:y.instruments)==null?void 0:d[0])||"股票"} K线图与交易信号`;if(!t||t.length===0)return{title:{text:u,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"}}};const C=t.map(S=>[S.date,S.open,S.close,S.low,S.high,S.volume]);let z=[],P=[];if(a&&a.length>0){const S=new Map;C.forEach((ie,_e)=>{const R=ht(ie[0]);S.set(R,_e)}),z=a.filter(ie=>ie.action==="BUY").map(ie=>{const _e=ht(ie.date),R=S.get(_e),Q=ie.price||0;return R===void 0||Q<=0?null:{name:"买入",value:[R,Q],xAxis:R,yAxis:Q,itemStyle:{color:"#f64034"}}}).filter(ie=>ie!==null),P=a.filter(ie=>ie.action==="SELL").map(ie=>{const _e=ht(ie.date),R=S.get(_e),Q=ie.price||0;return R===void 0||Q<=0?null:{name:"卖出",value:[R,Q],xAxis:R,yAxis:Q,itemStyle:{color:"#00b46a"}}}).filter(ie=>ie!==null)}const X=C.map(S=>S[0]);let se=[...z.map(S=>({name:"买入点",coord:[S.value[0],S.value[1]],value:S.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...P.map(S=>({name:"卖出点",coord:[S.value[0],S.value[1]],value:S.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...z.map(S=>{const de=S.value[0],ie=C[de][4]*1.1;return{name:"买入标签",coord:[S.value[0],ie],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...P.map(S=>{const de=S.value[0],ie=C[de][4]*1.2;return{name:"卖出标签",coord:[S.value[0],ie],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];return{title:{text:u,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(S){let de="";if(Array.isArray(S)){const ve=S[0].axisValue;de=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${ve}</div>`,S.forEach(Q=>{if(Q.seriesName==="K线"){if(Q.value&&Q.value.length>=4){const Ae=Number(Q.value[1])||0,He=Number(Q.value[2])||0,rt=Number(Q.value[3])||0,ue=Number(Q.value[4])||0,Qe=He>=Ae?"#f64034":"#00b46a";de+=`<div style="color:${Qe};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${Qe};">${Ae.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${Qe};">${He.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${Qe};">${rt.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${Qe};">${ue.toFixed(2)}</span><br/>
                  </div>`}}else if(Q.seriesName&&Q.seriesName.startsWith("MA")&&Q.value!=="-"){const He={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[Q.seriesName]||Q.color;try{const rt=typeof Q.value=="number"?parseFloat(Q.value.toString()).toFixed(3):parseFloat(Q.value||"0").toFixed(3);de+=`<div style="color:${He};font-weight:bold;display:inline-block;margin-right:15px;">${Q.seriesName}：${rt}</div>`}catch(rt){console.warn("格式化MA值出错:",rt),de+=`<div style="color:${He};font-weight:bold;display:inline-block;margin-right:15px;">${Q.seriesName}：0</div>`}}});const ie=ht(ve),_e=a.find(Q=>Q.action==="BUY"&&ht(Q.date)===ie),R=a.find(Q=>Q.action==="SELL"&&ht(Q.date)===ie);if((_e||R)&&(de+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),_e){const Q=_e.price||0,Ae=_e.trigger_reason||"未记录原因";de+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${Q.toFixed(2)}<br/>
                原因：${Ae}
              </div>`}if(R){const Q=R.price||0,Ae=R.trigger_reason||"未记录原因";de+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${Q.toFixed(2)}<br/>
                原因：${Ae}
              </div>`}}return de}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:X,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:C.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:se,animation:!1,z:10}},{name:"MA5",type:"line",data:Te(5,C.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Te(10,C.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Te(20,C.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Te(30,C.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}},We=o.useMemo(()=>{var t,a,d,u;return[{key:"1",label:e.jsxs("span",{children:[e.jsx(yt,{}),"绩效分析"]}),children:e.jsx(G,{gutter:16,children:e.jsx(g,{span:24,style:{marginBottom:16},children:e.jsx($t,{option:Fe((y==null?void 0:y.equity_curve)||[],((t=y==null?void 0:y.results)==null?void 0:t.trades)||(y==null?void 0:y.trade_records)||[],(y==null?void 0:y.initial_capital)||1e5),style:{height:500},notMerge:!0,opts:{renderer:"canvas"}},`equity-chart-${ce}`)})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(yt,{}),"K线与交易信号"]}),children:e.jsx(G,{gutter:16,children:e.jsx(g,{span:24,children:e.jsx(re,{title:`${((a=y==null?void 0:y.instruments)==null?void 0:a[0])||"股票"}交易图表`,extra:e.jsxs(be,{children:[e.jsx(A,{type:"primary",size:"small",onClick:()=>{const C=document.querySelector(".kline-chart");if(C){const z=C.__echarts__;z&&z.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(A,{size:"small",onClick:()=>{var C;const z=((C=y==null?void 0:y.results)==null?void 0:C.trades)||(y==null?void 0:y.trade_records)||[],P=(y==null?void 0:y.equity_curve)||[];if(z.length>0&&P.length>0){const X=new Map;P.forEach((S,de)=>{const ve=ht(S.date);X.set(ve,de)});const se=[];if(z.forEach(S=>{const de=ht(S.date),ve=X.get(de);ve!==void 0&&se.push(ve)}),se.length>0){const S=Math.max(0,Math.min(...se)-10),de=Math.min(P.length-1,Math.max(...se)+10),ve=S/P.length*100,ie=de/P.length*100,_e=document.querySelector(".kline-chart");if(_e){const R=_e.__echarts__;R&&(R.dispatchAction({type:"dataZoom",start:ve,end:ie}),h.success(`已聚焦到交易区域，共显示 ${se.length} 个交易点`))}}else h.info("未找到交易信号对应的K线数据点")}else h.info("没有交易记录或K线数据")},children:"聚焦交易"}),e.jsx(ye,{title:"只显示有交易的区域",children:e.jsx(Oe,{})})]}),children:e.jsx($t,{className:"kline-chart",option:Ge((y==null?void 0:y.equity_curve)||[],((d=y==null?void 0:y.results)==null?void 0:d.trades)||(y==null?void 0:y.trade_records)||[]),style:{height:600},notMerge:!0,opts:{renderer:"canvas"}},`kline-chart-${ce}`)})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Oe,{}),"交易明细"]}),children:e.jsx(At,{dataSource:((u=y==null?void 0:y.results)==null?void 0:u.trades)||(y==null?void 0:y.trade_records)||[],columns:Ze,rowKey:C=>`trade-${C.date}-${C.action}-${C.price}`,pagination:{pageSize:10},scroll:{x:!0}})}]},[y]);return o.useEffect(()=>{xt.current||(xt.current=!0,x())},[]),o.useEffect(()=>{if(W==="all")te(H);else{const t=H.filter(a=>a.strategy_name===W);te(t)}},[H,W]),o.useEffect(()=>{if(b&&y){const t=setTimeout(()=>{ee.current&&ee.current.getEchartsInstance().resize(),De.current&&De.current.getEchartsInstance().resize(),qe(d=>d+1)},500),a=()=>{ee.current&&ee.current.getEchartsInstance().resize(),De.current&&De.current.getEchartsInstance().resize()};return window.addEventListener("resize",a),()=>{clearTimeout(t),window.removeEventListener("resize",a)}}},[b,y]),e.jsxs("div",{style:{padding:"24px"},children:[e.jsx("style",{children:`
        .table-row-light {
          background-color: #fafafa;
        }
        .table-row-dark {
          background-color: #ffffff;
        }
        .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
          font-weight: 600 !important;
          text-align: center !important;
          white-space: nowrap !important;
        }
        .ant-table-tbody > tr:hover > td {
          background-color: #e6f7ff !important;
        }
        .ant-table-tbody > tr > td {
          padding: 8px 12px !important;
          border-bottom: 1px solid #f0f0f0 !important;
        }
        .ant-table-fixed-left .ant-table-thead > tr > th,
        .ant-table-fixed-right .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
        }
        .ant-table-fixed-left .ant-table-tbody > tr > td,
        .ant-table-fixed-right .ant-table-tbody > tr > td {
          background-color: inherit !important;
        }
      `}),e.jsx(re,{title:e.jsxs(be,{children:[e.jsx(Ht,{}),e.jsx("span",{children:"回测历史"})]}),extra:e.jsxs(be,{size:"middle",children:[e.jsx(be.Compact,{children:e.jsxs(Me,{value:W,onChange:oe,style:{width:180},placeholder:"选择策略筛选",allowClear:!0,size:"middle",suffixIcon:e.jsx(ur,{}),children:[e.jsx(Me.Option,{value:"all",children:"全部策略"}),Array.from(new Set(H.map(t=>t.strategy_name).filter(Boolean))).map(t=>e.jsx(Me.Option,{value:t,children:t},t))]})}),e.jsx(A,{icon:e.jsx(Ot,{}),onClick:p,loading:pe,type:"primary",children:"一键更新到最新K线"}),e.jsx(A,{icon:e.jsx(Ss,{}),onClick:x,loading:F,children:"刷新"})]}),children:e.jsx(At,{columns:Ue,dataSource:$e,rowKey:"id",loading:F,size:"small",bordered:!0,pagination:{pageSize:Je.getPageSize(15),showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,a)=>`第 ${a[0]}-${a[1]} 条，共 ${t} 条`,pageSizeOptions:["10","15","20","50"],size:"small",onChange:(t,a)=>{Je.setCurrentPage(t),Je.setPageSize(a||15)},onShowSizeChange:(t,a)=>{Je.setPageSize(a)}},scroll:{x:1550,y:"calc(100vh - 300px)"},rowClassName:(t,a)=>a%2===0?"table-row-light":"table-row-dark"})}),e.jsx(ze,{title:"回测详情",open:b,onCancel:()=>{U(!1),Le("performance")},footer:null,width:1200,destroyOnClose:!0,afterOpenChange:t=>{t&&setTimeout(()=>{ee.current&&ee.current.getEchartsInstance().resize(),De.current&&De.current.getEchartsInstance().resize()},100)},children:y&&e.jsxs("div",{children:[e.jsxs(Xe,{title:"基本信息",bordered:!0,column:2,style:{marginBottom:24},children:[e.jsx(Xe.Item,{label:"回测名称",children:y.name}),e.jsx(Xe.Item,{label:"策略名称",children:((n=y.strategy_info)==null?void 0:n.name)||"-"}),e.jsxs(Xe.Item,{label:"回测期间",children:[M(y.start_date).format("YYYY-MM-DD")," 至 ",M(y.end_date).format("YYYY-MM-DD")]}),e.jsxs(Xe.Item,{label:"初始资金",children:["$",y.initial_capital.toLocaleString()]}),e.jsx(Xe.Item,{label:"交易标的",children:y.instruments.join(", ")}),e.jsx(Xe.Item,{label:"状态",children:e.jsx(ke,{color:y.status==="completed"?"success":"processing",children:y.status==="completed"?"已完成":"运行中"})})]}),y.performance_metrics&&e.jsxs(re,{title:"性能指标",style:{marginBottom:24},children:[e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["累计收益 ",e.jsx(ye,{title:"回测期间的总收益率",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:((m=(v=(r=y.performance_metrics)==null?void 0:r.total_return)!=null?v:(l=y.results)==null?void 0:l.total_return)!=null?m:0)*100,precision:2,valueStyle:{color:((f=(D=(_=y.performance_metrics)==null?void 0:_.total_return)!=null?D:($=y.results)==null?void 0:$.total_return)!=null?f:0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(ye,{title:"策略的年化收益率",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:(y.performance_metrics.annual_return||0)*100,precision:2,valueStyle:{color:(y.performance_metrics.annual_return||0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(ye,{title:"策略的最大回撤幅度",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.max_drawdown*100,precision:2,valueStyle:{color:"#ff4d4f"},suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(ye,{title:"风险调整后的收益指标",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.sharpe_ratio,precision:2})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["胜率 ",e.jsx(ye,{title:"盈利交易占总交易的比例",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.win_rate*100,precision:2,suffix:"%"})})]}),e.jsxs(G,{gutter:16,style:{marginTop:24},children:[e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(ye,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.profit_factor||0,precision:2})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["Alpha ",e.jsx(ye,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2,suffix:"%"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["Beta ",e.jsx(ye,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2})}),e.jsx(g,{span:6,children:e.jsx(le,{title:e.jsxs("span",{children:["最近一次交易时间 ",e.jsx(ye,{title:"最后一次交易的时间和方向",children:e.jsx(Oe,{style:{fontSize:14,color:"#aaa"}})})]}),value:(()=>{const t=y.trade_records||[];if(t.length===0)return"-";const a=t[t.length-1],d=a==null?void 0:a.date,u=a==null?void 0:a.action,C=a==null?void 0:a.price;if(!d)return"-";const z=u==="BUY"?"买入":u==="SELL"?"卖出":u||"未知",P=C?` @ $${parseFloat(C).toFixed(2)}`:"";return`${M(d).format("MM-DD")} (${z}${P})`})()})})]})]}),e.jsx(Ut,{defaultActiveKey:"1",items:We})]})}),e.jsx(ze,{title:"更新回测数据",open:Ce,onOk:Se,onCancel:()=>{Ne(!1),at.resetFields()},confirmLoading:ft,okText:"更新",cancelText:"取消",width:600,children:e.jsxs(L,{form:at,layout:"vertical",style:{marginTop:16},children:[e.jsx(L.Item,{label:"新回测名称",name:"new_name",rules:[{required:!0,message:"请输入新回测名称"}],children:e.jsx(je,{placeholder:"请输入新回测名称"})}),e.jsx(L.Item,{label:"更新到日期",name:"update_to_date",extra:"留空则自动更新到最新可用数据（通常是昨天）",children:e.jsx(Mt,{style:{width:"100%"},placeholder:"选择更新截止日期（可选）",format:"YYYY-MM-DD"})}),e.jsx(L.Item,{label:"回测描述",name:"new_description",extra:"可选：更新回测的描述信息",children:e.jsx(je.TextArea,{placeholder:"请输入回测描述（可选）",rows:3})}),Ve&&e.jsx(nt,{message:"更新说明",description:e.jsxs("div",{children:[e.jsx("p",{children:"• 将基于原回测的配置（策略、参数、仓位配置等）重新运行回测"}),e.jsxs("p",{children:["• 起始日期保持原回测的起始日期：",Ve.start_date]}),e.jsx("p",{children:"• 结束日期将更新到您选择的日期，如不选择则自动更新到最新可用数据"}),e.jsx("p",{children:"• 将创建新的回测记录，原回测记录保持不变"})]}),type:"info",showIcon:!0,style:{marginBottom:16}})]})}),e.jsx(ze,{title:"策略执行日志",open:Pe,onCancel:()=>ct(!1),footer:[e.jsx(A,{onClick:()=>ct(!1),children:"关闭"},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"500px",overflowY:"auto"},children:Ke.length>0?e.jsx("div",{style:{fontFamily:"monospace",fontSize:"12px"},children:Ke.map((t,a)=>e.jsxs("div",{style:{marginBottom:"8px",padding:"8px 12px",backgroundColor:t.level==="ERROR"?"#fff2f0":t.level==="WARNING"?"#fffbe6":t.level==="DEBUG"?"#f6ffed":"#fafafa",border:`1px solid ${t.level==="ERROR"?"#ffccc7":t.level==="WARNING"?"#ffe58f":t.level==="DEBUG"?"#d9f7be":"#d9d9d9"}`,borderRadius:"4px"},children:[e.jsxs("div",{style:{color:t.level==="ERROR"?"#cf1322":t.level==="WARNING"?"#d46b08":t.level==="DEBUG"?"#52c41a":"#595959",fontWeight:"bold",marginBottom:"4px"},children:["[",t.timestamp,"] ",t.level]}),e.jsx("div",{style:{color:"#262626",whiteSpace:"pre-wrap"},children:t.message})]},a))}):e.jsxs("div",{style:{textAlign:"center",color:"#999",padding:"40px 0"},children:[e.jsx(ps,{style:{fontSize:"48px",marginBottom:"16px"}}),e.jsx("div",{children:"暂无策略执行日志"}),e.jsx("div",{style:{fontSize:"12px",marginTop:"8px"},children:"策略中可以使用 log() 函数记录执行过程"})]})})})]})});var us=(n,r,l)=>new Promise((v,m)=>{var _=f=>{try{D(l.next(f))}catch(k){m(k)}},$=f=>{try{D(l.throw(f))}catch(k){m(k)}},D=f=>f.done?v(f.value):Promise.resolve(f.value).then(_,$);D((l=l.apply(n,r)).next())});ms([xs,fs,gs,ys,js,bs,vs,_s]);const{Title:Xs,Text:Dn}=It,Cn=()=>{const{id:n}=sa(),r=Lt(),[l,v]=o.useState(!1),[m,_]=o.useState(null),[$,D]=o.useState([]),[f,k]=o.useState(!1),[F,J]=o.useState(null),[H,he]=o.useState(!1),$e=()=>us(void 0,null,function*(){if(n){v(!0);try{const b=yield q.get(`/api/backtest-status/${n}`);b.data.status==="success"?_(b.data.data):h.error("获取回测状态失败")}catch(b){console.error("获取回测状态失败:",b),h.error("获取回测状态失败")}finally{v(!1)}}}),te=()=>us(void 0,null,function*(){if(n){v(!0);try{const b=yield q.get(`/api/backtest-status/${n}/history`);D(b.data)}catch(b){console.error("获取回测历史失败:",b),h.error("获取回测历史失败")}finally{v(!1)}}}),W=b=>us(void 0,null,function*(){he(!0);try{const U=$.find(y=>y.id===b);U&&(J(U),k(!0))}catch(U){console.error("获取历史记录详情失败:",U),h.error("获取历史记录详情失败")}finally{he(!1)}}),oe=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:"回测期间",key:"period",render:(b,U)=>e.jsxs("div",{children:[e.jsx("div",{children:M(U.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#666",fontSize:"12px"},children:["至 ",M(U.end_date).format("YYYY-MM-DD")]})]})},{title:"初始资金",dataIndex:"initial_capital",key:"initial_capital",render:b=>`$${b.toLocaleString()}`},{title:"状态",dataIndex:"status",key:"status",render:b=>e.jsx(ke,{color:b==="completed"?"green":b==="running"?"blue":"red",children:b==="completed"?"已完成":b==="running"?"运行中":"失败"})},{title:"收益率",dataIndex:"total_return",key:"total_return",render:b=>e.jsxs("span",{style:{color:b>=0?"#52c41a":"#ff4d4f"},children:[b>=0?"+":"",b.toFixed(2),"%"]})},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:b=>e.jsxs("span",{style:{color:"#ff4d4f"},children:[b.toFixed(2),"%"]})},{title:"操作类型",dataIndex:"operation_type",key:"operation_type",render:b=>e.jsx(ke,{color:b==="create"?"blue":"orange",children:b==="create"?"创建":b==="update"?"更新":"重新运行"})},{title:"创建时间",dataIndex:"created_at",key:"created_at",render:b=>M(b).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",render:(b,U)=>e.jsx(be,{children:e.jsx(A,{type:"link",icon:e.jsx(ws,{}),onClick:()=>W(U.id),loading:H,children:"查看"})})}];return o.useEffect(()=>{$e(),te()},[n]),m?e.jsxs("div",{style:{padding:"24px"},children:[e.jsx(re,{style:{marginBottom:"16px"},children:e.jsxs(be,{children:[e.jsx(A,{icon:e.jsx(pa,{}),onClick:()=>r("/backtest/history"),children:"返回列表"}),e.jsxs(Xs,{level:3,style:{margin:0},children:[e.jsx(Ht,{})," ",m.name," - 历史记录"]})]})}),e.jsx(re,{title:"当前状态概览",style:{marginBottom:"16px"},children:e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:6,children:e.jsx(le,{title:"策略名称",value:m.strategy_name||"未知"})}),e.jsx(g,{span:6,children:e.jsx(le,{title:"回测期间",value:`${M(m.start_date).format("YYYY-MM-DD")} 至 ${M(m.end_date).format("YYYY-MM-DD")}`})}),e.jsx(g,{span:6,children:e.jsx(le,{title:"初始资金",value:`$${m.initial_capital.toLocaleString()}`})}),e.jsx(g,{span:6,children:e.jsx(le,{title:"当前收益率",value:m.total_return,precision:2,suffix:"%",valueStyle:{color:m.total_return>=0?"#52c41a":"#ff4d4f"}})})]})}),e.jsx(re,{title:e.jsxs(be,{children:[e.jsx(Ht,{}),e.jsx("span",{children:"历史记录"})]}),extra:e.jsx(A,{icon:e.jsx(Ss,{}),onClick:te,loading:l,children:"刷新"}),children:e.jsx(Xt,{columns:oe,dataSource:$,rowKey:"id",loading:l,pagination:{pageSize:Je.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:(b,U)=>`第 ${U[0]}-${U[1]} 条，共 ${b} 条`,onChange:(b,U)=>{Je.setCurrentPage(b),Je.setPageSize(U||20)},onShowSizeChange:(b,U)=>{Je.setPageSize(U)}},scroll:{x:1200}})}),e.jsx(ze,{title:"历史记录详情",open:f,onCancel:()=>k(!1),footer:[e.jsx(A,{onClick:()=>k(!1),children:"关闭"},"close")],width:800,children:F&&e.jsxs("div",{children:[e.jsxs(Xe,{bordered:!0,column:2,children:[e.jsx(Xe.Item,{label:"记录ID",children:F.id}),e.jsx(Xe.Item,{label:"操作类型",children:e.jsx(ke,{color:F.operation_type==="create"?"blue":"orange",children:F.operation_type==="create"?"创建":"更新"})}),e.jsxs(Xe.Item,{label:"回测期间",span:2,children:[M(F.start_date).format("YYYY-MM-DD")," 至 ",M(F.end_date).format("YYYY-MM-DD")]}),e.jsxs(Xe.Item,{label:"初始资金",children:["$",F.initial_capital.toLocaleString()]}),e.jsx(Xe.Item,{label:"状态",children:e.jsx(ke,{color:F.status==="completed"?"green":"red",children:F.status==="completed"?"已完成":"失败"})}),e.jsx(Xe.Item,{label:"收益率",children:e.jsxs("span",{style:{color:F.total_return>=0?"#52c41a":"#ff4d4f"},children:[F.total_return>=0?"+":"",F.total_return.toFixed(2),"%"]})}),e.jsx(Xe.Item,{label:"最大回撤",children:e.jsxs("span",{style:{color:"#ff4d4f"},children:[F.max_drawdown.toFixed(2),"%"]})}),e.jsx(Xe.Item,{label:"创建时间",children:M(F.created_at).format("YYYY-MM-DD HH:mm:ss")}),e.jsx(Xe.Item,{label:"完成时间",children:F.completed_at?M(F.completed_at).format("YYYY-MM-DD HH:mm:ss"):"未完成"})]}),F.performance_metrics&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Xs,{level:5,children:"性能指标"}),e.jsxs(G,{gutter:16,children:[e.jsx(g,{span:8,children:e.jsx(le,{title:"累计收益",value:F.total_return!==void 0?F.total_return:(F.performance_metrics.total_return||0)*100,precision:2,suffix:"%"})}),e.jsx(g,{span:8,children:e.jsx(le,{title:"夏普比率",value:F.performance_metrics.sharpe_ratio||0,precision:3})}),e.jsx(g,{span:8,children:e.jsx(le,{title:"波动率",value:F.performance_metrics.volatility||0,precision:2,suffix:"%"})}),e.jsx(g,{span:8,children:e.jsx(le,{title:"胜率",value:F.performance_metrics.win_rate||0,precision:2,suffix:"%"})})]})]})]})})]}):e.jsx("div",{style:{padding:"24px"},children:e.jsx(re,{loading:l,children:e.jsx("div",{style:{textAlign:"center",padding:"50px"},children:e.jsx(Dn,{children:"加载中..."})})})})};const{Content:zn}=Yt,Mn=()=>e.jsx(ha,{locale:ma,theme:xa,children:e.jsx(pr,{children:e.jsx(Ya,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(Yt,{style:{minHeight:"100vh"},children:[e.jsx(fr,{}),e.jsxs(Yt,{children:[e.jsx(yr,{}),e.jsx(Yt,{style:{padding:"24px"},children:e.jsx(zn,{style:{padding:24,margin:0,minHeight:280,background:"#fff",borderRadius:"8px"},children:e.jsxs(Ra,{children:[e.jsx(dt,{path:"/",element:e.jsx(Ba,{to:"/dashboard",replace:!0})}),e.jsx(dt,{path:"/dashboard",element:e.jsx(Ir,{})}),e.jsx(dt,{path:"/data",element:e.jsx(va,{})}),e.jsx(dt,{path:"/strategy",element:e.jsx(wn,{})}),e.jsx(dt,{path:"/strategy/edit",element:e.jsx(Qs,{})}),e.jsx(dt,{path:"/strategy/edit/:id",element:e.jsx(Qs,{})}),e.jsx(dt,{path:"/strategy/builder",element:e.jsx(Ur,{})}),e.jsx(dt,{path:"/backtest",element:e.jsx(pn,{})}),e.jsx(dt,{path:"/backtest/history",element:e.jsx(In,{})}),e.jsx(dt,{path:"/backtest-history/:id",element:e.jsx(Cn,{})}),e.jsx(dt,{path:"/optimization",element:e.jsx(bn,{})}),e.jsx(dt,{path:"/ai-investment",element:e.jsx(_n,{})})]})})})]})]})})})});ia.locale("en-gb");q.defaults.baseURL="http://localhost:8001";Ea.createRoot(document.getElementById("root")).render(e.jsx(qa.StrictMode,{children:e.jsx(ha,{locale:ma,theme:xa,children:e.jsx(Mn,{})})}));
