import{k as e,L as Qt,r as o,u as Zt,l as ba,E as va,m as qa,n as _a,B as Va,o as Ha,p as kt,N as Ka,q as Ua,R as Wa}from"./react-vendor-6f13ff9c.js";import{L as Lt,M as es,B as L,G as Ga,z as as,C as Za,D as wa,F as Sa,H as As,I as js,R as Ja,J as ds,K as rs,N as G,O as y,P as oe,Q as ge,T as Qa,U as Xa,V as er,W as tr,X as Dt,Y as Nt,Z as q,$ as ts,a0 as I,a1 as De,a2 as T,a3 as Pe,a4 as ka,a5 as ss,a6 as ns,a7 as Fe,a8 as Hs,a9 as $s,aa as ke,ab as Ee,ac as Wt,ad as sr,ae as d,af as ar,ag as rr,ah as nr,ai as us,aj as lr,ak as $a,al as Ia,am as Ls,an as Ca,ao as Ps,ap as Fs,aq as Os,ar as Ns,as as Ts,at as Rs,au as or,av as ir,aw as cr,ax as Ys,ay as dr,az as Es,aA as Et,aB as xt,aC as ur,aD as Se,aE as Je,aF as Ut,aG as gs,aH as Da,aI as za,aJ as Bs,aK as Ma,aL as Yt,aM as Ms,aN as pr,aO as qs,aP as hr,aQ as Ks,aR as mr,aS as Us,aT as fr,aU as xr,aV as Aa,aW as gr,aX as pt,aY as La,aZ as Pa,a_ as yr}from"./vendor-7d963d80.js";import{M as jr}from"./monaco-313743a9.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))b(f);new MutationObserver(f=>{for(const _ of f)if(_.type==="childList")for(const D of _.addedNodes)D.tagName==="LINK"&&D.rel==="modulepreload"&&b(D)}).observe(document,{childList:!0,subtree:!0});function l(f){const _={};return f.integrity&&(_.integrity=f.integrity),f.referrerPolicy&&(_.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?_.credentials="include":f.crossOrigin==="anonymous"?_.credentials="omit":_.credentials="same-origin",_}function b(f){if(f.ep)return;f.ep=!0;const _=l(f);fetch(f.href,_)}})();const Fa={token:{colorPrimary:"#1890ff",borderRadius:8,colorBgContainer:"#ffffff",fontSize:12,fontSizeSM:11,fontSizeLG:14,fontSizeXL:16},components:{Table:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Card:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Button:{borderRadius:6,fontSize:12},Typography:{fontSize:12},Form:{fontSize:12},Input:{fontSize:12},Select:{fontSize:12},Menu:{fontSize:12}}},{Header:br}=as,{useToken:vr}=Za,_r=()=>{const{token:n}=vr(),r=[{key:"/",icon:e.jsx(wa,{}),label:e.jsx(Qt,{to:"/",children:"首页"})},{key:"/data",icon:e.jsx(Sa,{}),label:e.jsx(Qt,{to:"/data",children:"数据管理"})},{key:"/strategy",icon:e.jsx(As,{}),label:e.jsx(Qt,{to:"/strategy",children:"策略编辑"})},{key:"/backtest",icon:e.jsx(Lt,{}),label:e.jsx(Qt,{to:"/backtest",children:"回测分析"})},{key:"/optimization",icon:e.jsx(js,{}),label:e.jsx(Qt,{to:"/optimization",children:"参数优化"})}];return e.jsxs(br,{style:{background:n.colorBgContainer,padding:"0 24px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx("div",{className:"header-nav-logo",children:e.jsxs(Qt,{to:"/",style:{color:n.colorPrimary,fontSize:"18px",fontWeight:"bold",display:"flex",alignItems:"center"},children:[e.jsx(Lt,{style:{marginRight:"8px",fontSize:"24px"}}),"量化交易系统"]})}),e.jsx(es,{className:"header-nav-menu",mode:"horizontal",selectedKeys:[window.location.pathname],style:{flex:1,marginLeft:"40px",borderBottom:"none"},items:r}),e.jsx("div",{children:e.jsx(L,{icon:e.jsx(Ga,{}),type:"text",href:"https://github.com/yourusername/quant-trading-system",target:"_blank",rel:"noopener noreferrer",children:"GitHub"})})]})},{Sider:wr}=as,Sr=()=>{const[n,r]=o.useState(!1),l=Zt(),b=ba(),f=[{key:"/",icon:e.jsx(wa,{}),label:"首页"},{key:"/data",icon:e.jsx(Sa,{}),label:"数据管理"},{key:"/strategy",icon:e.jsx(As,{}),label:"策略编辑"},{key:"/ai-investment",icon:e.jsx(Ja,{}),label:"AI实时投资跑数"},{key:"backtest",icon:e.jsx(Lt,{}),label:"回测管理",children:[{key:"/backtest",icon:e.jsx(Lt,{}),label:"回测分析"},{key:"/backtest/history",icon:e.jsx(ds,{}),label:"回测历史"}]},{key:"/optimization",icon:e.jsx(js,{}),label:"参数优化"}],_=D=>{l(D.key)};return e.jsxs(wr,{collapsible:!0,collapsed:n,onCollapse:D=>r(D),style:{background:"#fff"},width:200,children:[e.jsx("div",{className:"logo",style:{visibility:n?"hidden":"visible"},children:"量化交易系统"}),e.jsx(es,{theme:"light",mode:"inline",selectedKeys:[b.pathname],items:f,onClick:_})]})};var kr=Object.defineProperty,$r=Object.defineProperties,Ir=Object.getOwnPropertyDescriptors,Ws=Object.getOwnPropertySymbols,Cr=Object.prototype.hasOwnProperty,Dr=Object.prototype.propertyIsEnumerable,Gs=(n,r,l)=>r in n?kr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,Zs=(n,r)=>{for(var l in r||(r={}))Cr.call(r,l)&&Gs(n,l,r[l]);if(Ws)for(var l of Ws(r))Dr.call(r,l)&&Gs(n,l,r[l]);return n},zr=(n,r)=>$r(n,Ir(r));const Bt=o.memo(({option:n,loading:r=!1,height:l=400,lazyLoad:b=!0,threshold:f=.1,style:_,onChartReady:D,data:z,symbol:j,className:k,notMerge:Y=!1,opts:Q={renderer:"canvas"},onEvents:V})=>{const[$e,Te]=o.useState(!b),[ue,Z]=o.useState(null),pe=o.useRef(null),P=o.useRef(null),O=o.useMemo(()=>(ie,Ye)=>{const Xe=[];for(let ce=0,et=Ye.length;ce<et;ce++){if(ce<ie-1){Xe.push("-");continue}let te=0;for(let Oe=0;Oe<ie;Oe++)te+=Ye[ce-Oe].close;Xe.push((te/ie).toFixed(2))}return Xe},[]),x=o.useMemo(()=>!z||z.length===0?{}:{backgroundColor:"#fff",title:{text:j,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:z.map(ie=>ie.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:z.map(ie=>ie.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:z.map(ie=>[ie.open,ie.close,ie.low,ie.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:O(5,z),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:O(10,z),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:z.map((ie,Ye)=>[Ye,ie.volume,ie.close>ie.open?1:-1])}]},[z,j,O]),Re=o.useMemo(()=>{const ie=n||x;return!ie||Object.keys(ie).length===0?{}:zr(Zs({},ie),{animation:!1,progressive:1e3,progressiveThreshold:3e3,useUTC:!0})},[n,x]);o.useEffect(()=>{if(!b||$e)return;const ie=pe.current;if(ie)return P.current=new IntersectionObserver(Ye=>{var Xe;const[ce]=Ye;ce.isIntersecting&&(Te(!0),(Xe=P.current)==null||Xe.disconnect())},{threshold:f}),P.current.observe(ie),()=>{var Ye;(Ye=P.current)==null||Ye.disconnect()}},[b,$e,f]);const Ie=ie=>{Z(ie),D==null||D(ie)};return b&&!$e?e.jsx("div",{ref:pe,style:Zs({height:l,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#fafafa",border:"1px dashed #d9d9d9"},_),children:e.jsxs("div",{style:{textAlign:"center",color:"#999"},children:[e.jsx("div",{children:"图表懒加载中..."}),e.jsx("div",{style:{fontSize:"12px",marginTop:"4px"},children:"滚动到此处将自动加载"})]})}):e.jsx("div",{ref:pe,style:_,children:e.jsx(rs,{spinning:r,tip:"图表加载中...",children:e.jsx(va,{className:k,option:Re,style:{height:l},onChartReady:Ie,notMerge:Y,opts:Q,onEvents:V})})})});Bt.displayName="OptimizedChart";const{Title:Mr,Paragraph:Ar}=Nt,Lr=o.memo(()=>{const n=o.useMemo(()=>[{name:"上证指数",value:3536.24,change:.84,color:"#f5222d"},{name:"深证成指",value:14672.16,change:1.26,color:"#f5222d"},{name:"创业板指",value:3213.84,change:1.78,color:"#f5222d"},{name:"恒生指数",value:26386.25,change:-.13,color:"#52c41a"}],[]),r=o.useMemo(()=>[{id:1,name:"移动平均交叉策略",symbol:"AAPL",return:12.5,date:"2023-09-15"},{id:2,name:"RSI策略",symbol:"MSFT",return:8.3,date:"2023-09-14"},{id:3,name:"MACD策略",symbol:"GOOGL",return:-2.1,date:"2023-09-13"},{id:4,name:"布林带策略",symbol:"AMZN",return:5.7,date:"2023-09-12"}],[]),l=o.useMemo(()=>({title:{text:"策略绩效比较",left:"center"},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{data:["移动平均交叉","RSI策略","MACD策略","布林带策略","沪深300"],bottom:10},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:["1月","2月","3月","4月","5月","6月","7月","8月","9月"]},yAxis:{type:"value",name:"累计收益率(%)",axisLabel:{formatter:"{value}%"}},series:[{name:"移动平均交叉",type:"line",data:[0,2.3,5.8,9.2,12.5,15.1,18.6,22.4,25.2]},{name:"RSI策略",type:"line",data:[0,1.5,3.8,6.2,8.5,10.1,12.6,14.4,16.2]},{name:"MACD策略",type:"line",data:[0,-1.3,1.8,3.2,5.5,8.1,10.6,13.4,15.2]},{name:"布林带策略",type:"line",data:[0,3.3,2.8,5.2,8.5,12.1,15.6,18.4,21.2]},{name:"沪深300",type:"line",data:[0,1.3,2.8,3.2,2.5,4.1,5.6,4.4,6.2],lineStyle:{type:"dashed"}}]}),[]),b=o.useMemo(()=>({title:{text:"最优资产配置",left:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:10,data:["股票","债券","商品","外汇","现金"]},series:[{name:"资产配置",type:"pie",radius:["50%","70%"],avoidLabelOverlap:!1,label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:"18",fontWeight:"bold"}},labelLine:{show:!1},data:[{value:45,name:"股票"},{value:25,name:"债券"},{value:15,name:"商品"},{value:10,name:"外汇"},{value:5,name:"现金"}]}]}),[]);return e.jsxs("div",{children:[e.jsx(Mr,{level:2,children:"仪表盘"}),e.jsx(Ar,{children:"欢迎使用量化交易系统，您可以在这里查看市场概况和您的策略表现。"}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:6,children:e.jsx(oe,{children:e.jsx(ge,{title:"本月最佳策略",value:"移动平均交叉",prefix:e.jsx(Qa,{}),valueStyle:{color:"#3f8600"}})})}),e.jsx(y,{span:6,children:e.jsx(oe,{children:e.jsx(ge,{title:"最佳策略收益",value:25.2,precision:2,valueStyle:{color:"#3f8600"},prefix:e.jsx(Xa,{}),suffix:"%"})})}),e.jsx(y,{span:6,children:e.jsx(oe,{children:e.jsx(ge,{title:"最差策略收益",value:-2.1,precision:2,valueStyle:{color:"#cf1322"},prefix:e.jsx(er,{}),suffix:"%"})})}),e.jsx(y,{span:6,children:e.jsx(oe,{children:e.jsx(ge,{title:"策略总数",value:8,prefix:e.jsx(tr,{})})})})]}),e.jsxs(G,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(y,{span:12,children:e.jsx(oe,{title:"主要市场指数",extra:e.jsx(L,{type:"link",children:"查看更多"}),children:e.jsx(Dt,{dataSource:n,renderItem:f=>e.jsxs(Dt.Item,{children:[e.jsx(Dt.Item.Meta,{title:f.name}),e.jsx("div",{children:f.value}),e.jsxs("div",{style:{color:f.color,marginLeft:"16px"},children:[f.change>0?"+":"",f.change,"%"]})]})})})}),e.jsx(y,{span:12,children:e.jsx(oe,{title:"最近的回测",extra:e.jsx(L,{type:"link",children:"查看全部"}),children:e.jsx(Dt,{dataSource:r,renderItem:f=>e.jsxs(Dt.Item,{children:[e.jsx(Dt.Item.Meta,{title:f.name,description:`${f.symbol} | ${f.date}`}),e.jsxs("div",{style:{color:f.return>0?"#3f8600":"#cf1322",fontWeight:"bold"},children:[f.return>0?"+":"",f.return,"%"]})]})})})})]}),e.jsxs(G,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(y,{span:16,children:e.jsx(oe,{title:"策略绩效比较",extra:e.jsx(L,{type:"link",icon:e.jsx(Lt,{}),children:"详细分析"}),children:e.jsx("div",{className:"chart-container",children:e.jsx(Bt,{option:l,style:{height:"100%"}})})})}),e.jsx(y,{span:8,children:e.jsx(oe,{title:"最优资产配置",children:e.jsx("div",{className:"chart-container",children:e.jsx(Bt,{option:b,style:{height:"100%"}})})})})]})]})});var qt=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});const bs=()=>qt(void 0,null,function*(){try{const n=yield q.get("/api/data/stocks");return n.data&&Array.isArray(n.data)?n.data.map(r=>({id:r.id.toString(),symbol:r.symbol,name:r.name,type:r.type||"未知",exchange:r.exchange,source_id:r.source_id,data_count:r.data_count||0,last_updated:r.last_updated,first_date:r.first_date,last_date:r.last_date})):[]}catch(n){throw console.error("获取交易品种列表失败:",n),n}}),Oa=()=>qt(void 0,null,function*(){try{const n=yield q.get("/api/data/list");return n.data&&Array.isArray(n.data)?n.data:[]}catch(n){throw console.error("获取数据源列表失败:",n),n}}),Pr=n=>qt(void 0,null,function*(){try{const r=yield q.get(`/api/data/chart/${n}`);return r.data&&r.data.data?r.data:{data:[]}}catch(r){throw console.error("获取图表数据失败:",r),r}});function Fr(n){return qt(this,null,function*(){try{console.log("保存策略数据:",JSON.stringify(n,null,2));let r;if(n.id?r=yield q.put(`/api/strategies/${n.id}`,n):r=yield q.post("/api/strategies",n),console.log("策略保存响应:",r.data),r.data&&r.data.status==="success")return r.data.data;if(r.data)return r.data;throw new Error("保存策略失败，返回数据格式错误")}catch(r){throw console.error("保存策略时发生错误:",r),r}})}const cs=()=>qt(void 0,null,function*(){try{const n=yield q.get("/api/strategies");return n.data&&n.data.data?n.data.data:[]}catch(n){throw console.error("获取策略列表失败:",n),n}}),Js=n=>qt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略数据")}catch(r){throw console.error(`获取策略(ID:${n})详情失败:`,r),r}}),Na=n=>qt(void 0,null,function*(){try{yield q.delete(`/api/strategies/${n}`)}catch(r){throw console.error(`删除策略(ID:${n})失败:`,r),r}}),Or=n=>qt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/templates/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略模板数据")}catch(r){throw console.error(`获取策略模板(ID:${n})详情失败:`,r),r}}),Nr=n=>qt(void 0,null,function*(){try{const r=yield q.get(`/api/data/stock/${n}/date-range`);if(r.data)return r.data;throw new Error("未找到股票日期范围数据")}catch(r){throw console.error(`获取股票(ID:${n})日期范围失败:`,r),r}}),Qs=(n,r,l=30)=>{const b=new Date;b.setTime(b.getTime()+l*24*60*60*1e3),document.cookie=`${n}=${r};expires=${b.toUTCString()};path=/`},Xs=n=>{const r=n+"=",l=document.cookie.split(";");for(let b=0;b<l.length;b++){let f=l[b];for(;f.charAt(0)===" ";)f=f.substring(1,f.length);if(f.indexOf(r)===0)return f.substring(r.length,f.length)}return null},it={setPageSize:n=>{Qs("data_management_page_size",n.toString())},getPageSize:(n=15)=>{const r=Xs("data_management_page_size");return r?parseInt(r,10):n},setCurrentPage:n=>{Qs("data_management_current_page",n.toString())},getCurrentPage:(n=1)=>{const r=Xs("data_management_current_page");return r?parseInt(r,10):n}};function Tr(n,r){const[l,b]=o.useState(n);return o.useEffect(()=>{const f=setTimeout(()=>{b(n)},r);return()=>{clearTimeout(f)}},[n,r]),l}var Rr=Object.defineProperty,Yr=Object.defineProperties,Er=Object.getOwnPropertyDescriptors,ys=Object.getOwnPropertySymbols,Ta=Object.prototype.hasOwnProperty,Ra=Object.prototype.propertyIsEnumerable,ea=(n,r,l)=>r in n?Rr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,hs=(n,r)=>{for(var l in r||(r={}))Ta.call(r,l)&&ea(n,l,r[l]);if(ys)for(var l of ys(r))Ra.call(r,l)&&ea(n,l,r[l]);return n},ta=(n,r)=>Yr(n,Er(r)),Br=(n,r)=>{var l={};for(var b in n)Ta.call(n,b)&&r.indexOf(b)<0&&(l[b]=n[b]);if(n!=null&&ys)for(var b of ys(n))r.indexOf(b)<0&&Ra.call(n,b)&&(l[b]=n[b]);return l};const Gt=o.memo(n=>{var r=n,{virtualScroll:l=!1,itemHeight:b=54,maxHeight:f=400,dataSource:_=[],columns:D=[]}=r,z=Br(r,["virtualScroll","itemHeight","maxHeight","dataSource","columns"]);const j=o.useMemo(()=>D.map(Q=>ta(hs({},Q),{ellipsis:Q.ellipsis!==!1})),[D]),k=o.useMemo(()=>_||[],[_]),Y=o.useMemo(()=>hs({size:"middle",scroll:{x:"max-content",y:f},pagination:hs({showSizeChanger:!0,showQuickJumper:!0,showTotal:(Q,V)=>`第 ${V[0]}-${V[1]} 条，共 ${Q} 条`},z.pagination)},z),[f,z]);return e.jsx("div",{className:"optimized-table-container",children:e.jsx(ts,ta(hs({},Y),{columns:j,dataSource:k,className:`optimized-table ${z.className||""}`}))})});Gt.displayName="OptimizedTable";var qr=Object.defineProperty,Vr=Object.defineProperties,Hr=Object.getOwnPropertyDescriptors,sa=Object.getOwnPropertySymbols,Kr=Object.prototype.hasOwnProperty,Ur=Object.prototype.propertyIsEnumerable,aa=(n,r,l)=>r in n?qr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,ra=(n,r)=>{for(var l in r||(r={}))Kr.call(r,l)&&aa(n,l,r[l]);if(sa)for(var l of sa(r))Ur.call(r,l)&&aa(n,l,r[l]);return n},na=(n,r)=>Vr(n,Hr(r)),$t=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});const{Title:Wr,Text:Gr}=Nt,{Option:bt}=Ee,Ya=o.memo(({onSelect:n})=>{const r=o.useMemo(()=>[{label:"最近7天",days:7},{label:"最近30天",days:30},{label:"最近90天",days:90},{label:"最近180天",days:180},{label:"最近1年",days:365},{label:"最近2年",days:730},{label:"最近3年",days:1095},{label:"最近4年",days:1460},{label:"最近5年",days:1825},{label:"最近10年",days:3650},{label:"今年",type:"year"},{label:"去年",type:"lastYear"},{label:"本月",type:"month"},{label:"上月",type:"lastMonth"}],[]),l=o.useCallback(b=>{const f=I();let _,D;b.type==="year"?(_=f.startOf("year").format("YYYY-MM-DD"),D=f.format("YYYY-MM-DD")):b.type==="lastYear"?(_=f.subtract(1,"year").startOf("year").format("YYYY-MM-DD"),D=f.subtract(1,"year").endOf("year").format("YYYY-MM-DD")):b.type==="month"?(_=f.startOf("month").format("YYYY-MM-DD"),D=f.format("YYYY-MM-DD")):b.type==="lastMonth"?(_=f.subtract(1,"month").startOf("month").format("YYYY-MM-DD"),D=f.subtract(1,"month").endOf("month").format("YYYY-MM-DD")):(_=f.subtract(b.days,"day").format("YYYY-MM-DD"),D=f.format("YYYY-MM-DD")),n(_,D)},[n]);return e.jsx(De,{wrap:!0,children:r.map((b,f)=>e.jsx(L,{size:"small",onClick:()=>l(b),children:b.label},f))})});Ya.displayName="DateRangePresets";const la=(n,r)=>{const l=[];for(let b=0,f=r.length;b<f;b++){if(b<n-1){l.push("-");continue}let _=0;for(let D=0;D<n;D++)_+=r[b-D].close;l.push((_/n).toFixed(2))}return l},Ea=o.memo(()=>{const[n,r]=o.useState([]),[l,b]=o.useState([]),[f,_]=o.useState(!1),[D,z]=o.useState(!1),[j,k]=o.useState([]),[Y]=T.useForm(),[Q,V]=o.useState("fetch"),[$e,Te]=o.useState(!1),[ue,Z]=o.useState(!1),pe=o.useRef(!1),[P,O]=o.useState({current:it.getCurrentPage(),pageSize:it.getPageSize(),total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(S,g)=>`第 ${g[0]}-${g[1]} 条，共 ${S} 条`,pageSizeOptions:["10","15","20","50","100"]}),[x,Re]=o.useState(!1),[Ie,ie]=o.useState(null),[Ye,Xe]=o.useState([]),[ce,et]=o.useState(!1),[te,Oe]=o.useState("");Tr(te,300);const je=o.useCallback((...S)=>$t(void 0,[...S],function*(g=it.getCurrentPage(),v=it.getPageSize()){_(!0);try{const re=(yield bs()).map(J=>{var Ne;return{id:J.id.toString(),symbol:J.symbol,name:J.name,type:J.type||"未知",exchange:J.exchange,records:J.data_count||0,source:((Ne=J.source_id)==null?void 0:Ne.toString())||"未知",last_updated:J.last_updated?new Date(J.last_updated).toLocaleString():"未知",first_date:J.first_date||void 0,last_date:J.last_date||void 0}});O(J=>na(ra({},J),{current:g,pageSize:v,total:re.length})),r(re)}catch(H){console.error("获取数据列表失败:",H),d.error("获取数据列表失败，请检查网络连接")}finally{_(!1)}}),[]),rt=o.useCallback(()=>$t(void 0,null,function*(){try{const S=yield Oa();if(b(S),Q==="fetch"){const g=S.find(v=>v.name==="AkShare抓取");g&&Y.setFieldsValue({source_id:g.id})}else if(Q==="upload"){const g=S.find(v=>v.name==="用户上传");g&&Y.setFieldsValue({source_id:g.id})}}catch(S){console.error("获取数据源列表失败:",S),d.error("获取数据源列表失败")}}),[Q,Y]),zt=o.useCallback(S=>{const{current:g,pageSize:v}=S;it.setCurrentPage(g),it.setPageSize(v),je(g,v)},[je]),ct=o.useCallback(S=>$t(void 0,null,function*(){_(!0);try{const g=yield q.get(`/api/data/download/${S}`,{responseType:"blob"}),v=window.URL.createObjectURL(new Blob([g.data])),H=document.createElement("a");H.href=v;const re=g.headers["content-disposition"];let J="stock_data.csv";if(re){const Ne=re.match(/filename="?(.+)"?/);Ne&&Ne.length===2&&(J=Ne[1])}H.setAttribute("download",J),document.body.appendChild(H),H.click(),document.body.removeChild(H),d.success("数据下载成功")}catch(g){console.error("下载失败:",g),d.error("下载失败，请重试")}finally{_(!1)}}),[]),[Ve,He]=o.useState([]),Ce=o.useCallback((S,g)=>$t(void 0,null,function*(){var v,H,re;He(J=>J.includes(S)?J:[...J,S]);try{const Ne=(v=(yield q.post(`/api/data/update/${S}/async`)).data)==null?void 0:v.task_id;if(!Ne){d.error("任务提交失败：未返回任务ID"),He(Ge=>Ge.filter(nt=>nt!==S));return}d.success(g?`${g}：更新任务已启动`:"更新任务已启动");const st=()=>$t(void 0,null,function*(){var Ge,nt;try{const Me=yield q.get(`/api/data/update-tasks/${Ne}`),t=(Ge=Me.data)==null?void 0:Ge.status,a=(nt=Me.data)==null?void 0:nt.message;t==="completed"?(d.success(a||(g?`${g} 更新完成`:"更新完成")),clearInterval(Be),yield je(P.current,P.pageSize),He(u=>u.filter(h=>h!==S))):t==="failed"&&(d.error(a||(g?`${g} 更新失败`:"更新失败")),clearInterval(Be),He(u=>u.filter(h=>h!==S)))}catch(Me){console.error("查询任务状态失败:",Me)}}),Be=window.setInterval(st,2e3)}catch(J){console.error("提交异步更新失败:",J);const Ne=(re=(H=J.response)==null?void 0:H.data)==null?void 0:re.detail;d.error(Ne||"提交异步更新失败"),He(st=>st.filter(Be=>Be!==S))}}),[je,P.current,P.pageSize]),gt=o.useMemo(()=>[{title:"代码",dataIndex:"symbol",key:"symbol",width:100},{title:"名称",dataIndex:"name",key:"name",width:120},{title:"类型",dataIndex:"type",key:"type",width:80,render:S=>e.jsx(Pe,{color:"blue",children:S})},{title:"交易所",dataIndex:"exchange",key:"exchange",width:80},{title:"记录数",dataIndex:"records",key:"records",width:80,sorter:(S,g)=>S.records-g.records},{title:"数据时间范围",key:"date_range",width:200,render:(S,g)=>g.first_date&&g.last_date?e.jsx("div",{children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:[g.first_date," 至 ",g.last_date]})}):e.jsx("span",{style:{color:"#999"},children:"暂无数据"})},{title:"数据源",dataIndex:"source",key:"source",width:100},{title:"最后更新",dataIndex:"last_updated",key:"last_updated",width:150},{title:"操作",key:"action",width:360,render:(S,g)=>e.jsxs(De,{size:"small",children:[e.jsx(L,{type:"primary",icon:e.jsx(ka,{}),size:"small",onClick:()=>ct(g.id),children:"下载"}),e.jsx(L,{icon:e.jsx(Lt,{}),size:"small",onClick:()=>ft(g),children:"K线图"}),e.jsx(L,{icon:e.jsx(ss,{}),size:"small",loading:Ve.includes(g.id),disabled:Ve.includes(g.id),onClick:()=>Ce(g.id,g.symbol),children:"更新"}),e.jsx(L,{danger:!0,icon:e.jsx(ns,{}),size:"small",onClick:()=>dt(g.id),children:"删除"})]})}],[Ce,Ve]),wt={onRemove:()=>{k([])},beforeUpload:S=>(Ke(S)&&k([S]),!1),fileList:j},dt=o.useCallback(S=>$t(void 0,null,function*(){Fe.confirm({title:"确认删除",content:"此操作将永久删除该数据，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>$t(void 0,null,function*(){var g;_(!0);try{const v=yield q.delete(`/api/data/delete/${S}`);v.data&&v.data.status==="success"?(d.success(v.data.message||"删除成功"),je()):d.error(((g=v.data)==null?void 0:g.message)||"删除失败")}catch(v){console.error("删除失败:",v),d.error("删除失败，请重试")}finally{_(!1)}})})}),[je]),ft=o.useCallback(S=>$t(void 0,null,function*(){ie(S),Re(!0),et(!0);try{const g=yield Pr(S.id);console.log("API响应数据:",g);const v=g.data||g||[];console.log("处理后的数据:",v),Xe(v)}catch(g){console.error("获取图表数据失败:",g),d.error("获取图表数据失败")}finally{et(!1)}}),[]),Ke=S=>{const g=S.type==="text/csv"||S.name&&S.name.endsWith(".csv");return g||d.error("只能上传CSV文件!"),g},yt=S=>$t(void 0,null,function*(){var g,v,H,re;if(j.length===0){d.error("请选择要上传的文件");return}const J=new FormData;J.append("file",j[0]);const Ne=new URLSearchParams({symbol:S.symbol,name:S.name,type:S.type,source_id:((g=S.source_id)==null?void 0:g.toString())||""});S.exchange&&Ne.append("exchange",S.exchange);const st=`/api/data/upload?${Ne.toString()}`;_(!0);try{const Be=yield q.post(st,J,{headers:{"Content-Type":"multipart/form-data"}});Be.data&&Be.data.status==="success"?(d.success(Be.data.message||"上传成功"),z(!1),Y.resetFields(),k([]),je(P.current,P.pageSize)):d.error(((v=Be.data)==null?void 0:v.message)||"上传失败")}catch(Be){console.error("上传失败:",Be);const Ge=(re=(H=Be.response)==null?void 0:H.data)==null?void 0:re.detail;Ge?typeof Ge=="object"?d.error(JSON.stringify(Ge)):d.error(Ge):d.error("上传失败，请重试")}finally{_(!1)}}),tt=S=>$t(void 0,null,function*(){var g,v,H;Te(!0);try{const re={symbol:S.symbol,name:S.name,type:S.type,source_id:S.source_id,start_date:S.start_date?S.start_date.format("YYYY-MM-DD"):void 0,end_date:S.end_date?S.end_date.format("YYYY-MM-DD"):void 0},J=yield q.post("/api/data/fetch",re,{headers:{"Content-Type":"application/json"}});J.data&&J.data.status==="success"?(d.success(J.data.message||"数据抓取成功"),z(!1),Y.resetFields(),je(P.current,P.pageSize)):d.error(((g=J.data)==null?void 0:g.message)||"数据抓取失败")}catch(re){console.error("数据抓取失败:",re);const J=(H=(v=re.response)==null?void 0:v.data)==null?void 0:H.detail;J?typeof J=="object"?d.error(JSON.stringify(J)):d.error(J):d.error("数据抓取失败，请重试")}finally{Te(!1)}}),Ue=o.useCallback(()=>{Fe.confirm({title:"一键更新确认",content:"确定要更新所有股票的最新数据吗？此操作可能需要较长时间。",okText:"确定更新",cancelText:"取消",onOk:()=>$t(void 0,null,function*(){var S,g,v;Z(!0);try{const re=(S=(yield q.post("/api/data/update-all/async")).data)==null?void 0:S.task_id;if(!re){d.error("任务提交失败：未返回任务ID"),Z(!1);return}d.success("一键更新任务已启动");const J=()=>$t(void 0,null,function*(){var st,Be,Ge,nt;try{const Me=yield q.get(`/api/data/update-all-tasks/${re}`),t=(st=Me.data)==null?void 0:st.status,a=(Be=Me.data)==null?void 0:Be.message,u=(Ge=Me.data)==null?void 0:Ge.processed,h=(nt=Me.data)==null?void 0:nt.total;typeof u=="number"&&typeof h=="number"&&d.info(`一键更新进度：${u}/${h}`,1),t==="completed"?(clearInterval(Ne),Z(!1),d.success(a||"一键更新完成"),yield je(P.current,P.pageSize)):t==="failed"&&(clearInterval(Ne),Z(!1),d.error(a||"一键更新失败"))}catch(Me){console.error("查询一键更新任务状态失败:",Me)}}),Ne=window.setInterval(J,2e3)}catch(H){console.error("一键更新任务提交失败:",H);const re=(v=(g=H.response)==null?void 0:g.data)==null?void 0:v.detail;d.error(re||"一键更新任务提交失败"),Z(!1)}})})},[je]);return o.useEffect(()=>{pe.current||(pe.current=!0,je(),rt())},[je,rt]),e.jsxs("div",{className:"data-management",children:[e.jsxs(oe,{children:[e.jsxs(G,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[e.jsx(y,{children:e.jsx(Wr,{level:4,children:"市场数据管理"})}),e.jsx(y,{children:e.jsxs(De,{children:[e.jsx(L,{type:"primary",icon:e.jsx(Hs,{}),onClick:()=>z(!0),children:"添加数据"}),e.jsx(L,{type:"primary",icon:e.jsx(ss,{}),loading:ue,onClick:Ue,style:{backgroundColor:"#52c41a",borderColor:"#52c41a"},children:"一键更新"}),e.jsx(L,{icon:e.jsx(ss,{}),onClick:()=>je(P.current,P.pageSize),children:"刷新列表"})]})})]}),e.jsx(rs,{spinning:f,children:e.jsx(Gt,{columns:gt,dataSource:n,rowKey:"id",bordered:!0,size:"middle",pagination:P,onChange:zt})})]}),e.jsxs(Fe,{title:"市场数据管理",open:D,onCancel:()=>z(!1),footer:null,width:600,children:[e.jsx("div",{style:{marginBottom:20,textAlign:"center"},children:e.jsxs($s.Group,{value:Q,onChange:S=>{if(V(S.target.value),Y.resetFields(),S.target.value==="fetch"){const g=l.find(v=>v.name==="AkShare抓取");g&&Y.setFieldsValue({source_id:g.id})}else if(S.target.value==="upload"){const g=l.find(v=>v.name==="用户上传");g&&Y.setFieldsValue({source_id:g.id})}},buttonStyle:"solid",children:[e.jsx($s.Button,{value:"fetch",children:"自动抓取"}),e.jsx($s.Button,{value:"upload",children:"手动上传"})]})}),e.jsxs(T,{form:Y,layout:"vertical",onFinish:Q==="fetch"?tt:yt,children:[Q==="fetch"&&e.jsxs(e.Fragment,{children:[e.jsx(T.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(ke,{placeholder:"例如: AAPL, 600519, TSLA"})}),e.jsx(T.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(ke,{placeholder:"例如: 苹果公司, 贵州茅台"})}),e.jsx(T.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Ee,{placeholder:"选择类型",children:[e.jsx(bt,{value:"A股",children:"A股"}),e.jsx(bt,{value:"港股",children:"港股"}),e.jsx(bt,{value:"美股",children:"美股"}),e.jsx(bt,{value:"期货",children:"期货"}),e.jsx(bt,{value:"指数",children:"指数"}),e.jsx(bt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(T.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Ee,{placeholder:"选择数据源",disabled:!0,children:l.filter(S=>S.name==="AkShare抓取").map(S=>e.jsx(bt,{value:S.id,children:S.name},S.id))})}),e.jsxs(T.Item,{label:"日期范围",children:[e.jsx(Ya,{onSelect:(S,g)=>{Y.setFieldsValue({start_date:I(S),end_date:I(g)})}}),e.jsxs(G,{gutter:8,children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"start_date",noStyle:!0,children:e.jsx(Wt,{placeholder:"选择开始日期",style:{width:"100%"},format:"YYYY-MM-DD"})})}),e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"end_date",noStyle:!0,children:e.jsx(Wt,{placeholder:"选择结束日期",style:{width:"100%"},format:"YYYY-MM-DD"})})})]})]}),e.jsx(T.Item,{children:e.jsxs(De,{children:[e.jsx(L,{type:"primary",htmlType:"submit",loading:$e,icon:e.jsx(ss,{}),children:"开始抓取"}),e.jsx(L,{onClick:()=>z(!1),children:"取消"})]})})]}),Q==="upload"&&e.jsxs(e.Fragment,{children:[e.jsx(T.Item,{name:"file",label:"数据文件",rules:[{required:!0,message:"请选择要上传的CSV文件"}],children:e.jsxs(sr,na(ra({},wt),{children:[e.jsx(L,{icon:e.jsx(Hs,{}),children:"选择CSV文件"}),e.jsx(Gr,{type:"secondary",style:{marginLeft:8},children:"仅支持CSV格式的数据文件"})]}))}),e.jsx(T.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(ke,{placeholder:"例如: AAPL, 600000.SH"})}),e.jsx(T.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(ke,{placeholder:"例如: 苹果公司, 浦发银行"})}),e.jsx(T.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Ee,{placeholder:"选择类型",children:[e.jsx(bt,{value:"A股",children:"A股"}),e.jsx(bt,{value:"港股",children:"港股"}),e.jsx(bt,{value:"美股",children:"美股"}),e.jsx(bt,{value:"期货",children:"期货"}),e.jsx(bt,{value:"指数",children:"指数"}),e.jsx(bt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(T.Item,{name:"exchange",label:"交易所",children:e.jsx(ke,{placeholder:"例如: NYSE, SSE"})}),e.jsx(T.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Ee,{placeholder:"选择数据源",disabled:!0,children:l.filter(S=>S.name==="用户上传").map(S=>e.jsx(bt,{value:S.id,children:S.name},S.id))})}),e.jsx(T.Item,{children:e.jsxs(De,{children:[e.jsx(L,{type:"primary",htmlType:"submit",loading:f,children:"上传数据"}),e.jsx(L,{onClick:()=>z(!1),children:"取消"})]})})]})]})]}),e.jsx(Fe,{title:Ie?`${Ie.name}(${Ie.symbol}) K线图`:"K线图",open:x,onCancel:()=>Re(!1),footer:null,width:800,children:e.jsx(rs,{spinning:ce,children:Ye.length>0?e.jsx("div",{style:{height:"500px",width:"100%"},children:e.jsx(va,{option:{backgroundColor:"#fff",title:{text:Ie==null?void 0:Ie.symbol,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:Ye.map(S=>S.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:Ye.map(S=>S.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:Ye.map(S=>[S.open,S.close,S.low,S.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:la(5,Ye),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:la(10,Ye),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:Ye.map((S,g)=>[g,S.volume,S.close>S.open?1:-1])}]},style:{height:"100%",width:"100%"},opts:{renderer:"canvas"}})}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx("p",{children:"暂无数据可供显示"})})})})]})});Ea.displayName="DataManagement";var Ft=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});const{Title:Zr,Paragraph:Jr}=Nt,{confirm:Qr}=Fe,Xr=()=>{const n=ba();Zt();const[r,l]=o.useState("visual"),[b,f]=o.useState(`# 策略示例：移动平均线交叉策略
import pandas as pd
import numpy as np
import talib

def initialize(context):
    """初始化策略参数"""
    context.params = {
        'symbol': '000300.SH',
        'short_period': 20,
        'long_period': 60
    }

def handle_data(context, data):
    """处理每个交易日的数据"""
    params = context.params
    df = data[params['symbol']]
    
    # 计算移动平均线
    df['short_ma'] = talib.SMA(df['close'], timeperiod=params['short_period'])
    df['long_ma'] = talib.SMA(df['close'], timeperiod=params['long_period'])
    
    # 生成交易信号
    df['signal'] = 0
    # 短均线上穿长均线，买入信号
    df.loc[(df['short_ma'] > df['long_ma']) & (df['short_ma'].shift(1) <= df['long_ma'].shift(1)), 'signal'] = 1
    # 短均线下穿长均线，卖出信号
    df.loc[(df['short_ma'] < df['long_ma']) & (df['short_ma'].shift(1) >= df['long_ma'].shift(1)), 'signal'] = -1
    
    return df['signal']
`),[_]=T.useForm(),[D,z]=o.useState([]),[j,k]=o.useState(!1),[Y,Q]=o.useState(null);o.useState(!1);const[V,$e]=o.useState([]),[Te,ue]=o.useState(!1),[Z,pe]=o.useState(""),[P,O]=o.useState([]),[x,Re]=o.useState(!1),[Ie,ie]=o.useState([{label:"移动平均线交叉策略",value:"ma_cross"},{label:"布林带策略",value:"bbands"},{label:"RSI策略",value:"rsi"},{label:"MACD策略",value:"macd"},{label:"趋势跟踪策略",value:"trend_following"},{label:"双均线策略",value:"dual_ma"}]),[Ye,Xe]=o.useState({}),[ce,et]=o.useState(!1),[te,Oe]=o.useState(!1),je=()=>new URLSearchParams(n.search).get("id"),[rt,zt]=o.useState(!1);o.useEffect(()=>{(()=>Ft(void 0,null,function*(){if(rt){const v=je();v&&(!Y||Y.id!==v)&&(yield Ve(v));return}zt(!0);try{yield Promise.all([He(),wt()]),yield ct()}catch(v){console.error("初始化数据加载失败:",v),d.error("数据加载失败，请刷新页面重试")}}))()},[n.search,rt]);const ct=()=>Ft(void 0,null,function*(){if(!Te){ue(!0);try{const v=(yield cs()).filter(re=>!re.is_template);$e(v),console.log("加载到策略列表:",v.length,"个策略");const H=je();H?(!Y||Y.id!==H)&&(yield Ve(H)):v.length>0&&!Y&&(yield Ce(v[0]))}catch(g){console.error("获取策略列表失败:",g),d.error("获取策略列表失败")}finally{ue(!1)}}}),Ve=g=>Ft(void 0,null,function*(){const v={strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"};if(g)try{k(!0);const H=yield Js(g);Q(H),H.code&&(l("code"),f(H.code));const re={strategyName:H.name,description:H.description,template:H.template||"ma_cross"};H.parameters&&(console.log("加载策略参数:",H.parameters),Object.assign(re,H.parameters)),console.log("设置表单值:",re),_.setFieldsValue(re)}catch(H){console.error("加载策略详情失败:",H),d.error("加载策略详情失败"),_.setFieldsValue(v)}finally{k(!1)}else _.setFieldsValue(v)}),He=()=>Ft(void 0,null,function*(){if(D.length>0)return D;k(!0);try{const g=yield bs();return z(g),g}catch(g){console.error("获取股票列表失败:",g)}finally{k(!1)}return[]}),Ce=g=>Ft(void 0,null,function*(){if(g.id)try{k(!0);const v=yield Js(g.id);Q(v),v.code?(l("code"),f(v.code)):l("visual");const H={strategyName:v.name,description:v.description,template:v.template||"ma_cross"};v.parameters&&(console.log("加载策略参数:",v.parameters),Object.assign(H,v.parameters)),console.log("设置表单值:",H),_.setFieldsValue(H),window.history.replaceState(null,"",`?id=${g.id}`)}catch(v){console.error("加载策略详情失败:",v),d.error("加载策略详情失败")}finally{k(!1)}}),gt=g=>{Qr({title:"确定要删除这个策略吗?",icon:e.jsx(lr,{}),content:"此操作不可撤销，删除后数据将无法恢复。",okText:"是的，删除",okType:"danger",cancelText:"取消",onOk(){return Ft(this,null,function*(){try{yield Na(g.id),d.success("策略删除成功"),Y&&Y.id===g.id&&(Q(null),_.resetFields(),_.setFieldsValue({strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"}),window.history.replaceState(null,"",window.location.pathname)),Te||Ft(this,null,function*(){const re=(yield cs()).filter(J=>!J.is_template);$e(re)})}catch(v){console.error("删除策略失败:",v),d.error("删除策略失败")}})}})};V.filter(g=>{var v,H;return((v=g.name)==null?void 0:v.toLowerCase().includes(Z.toLowerCase()))||((H=g.description)==null?void 0:H.toLowerCase().includes(Z.toLowerCase()))});const wt=()=>Ft(void 0,null,function*(){if(Ie.length>0&&Ie[0].value!=="ma_cross")return Ie;try{const v=(yield cs()).filter(H=>H.is_template).map(H=>({label:H.name,value:H.id}));if(v.length>0)return ie(v),v}catch(g){console.error("获取策略模板失败:",g)}return Ie}),dt=g=>Ft(void 0,null,function*(){try{const v=yield Or(g);v&&(_.setFieldsValue({name:`自定义${v.name}`,description:v.description,code:v.code}),v.parameters&&Xe(v.parameters),d.success("模板加载成功"))}catch{d.error("加载模板失败")}}),ft=g=>{dt(g)},Ke={name:"",description:"",code:""},yt=g=>{et(!0),Fr(g).then(v=>Ft(void 0,null,function*(){if(d.success("策略保存成功"),v&&(Q(v),window.history.replaceState(null,"",`?id=${v.id}`),!Te)){const re=(yield cs()).filter(J=>!J.is_template);$e(re)}})).catch(v=>{d.error("保存策略失败: "+v.message)}).finally(()=>{et(!1)})},tt=()=>{Oe(!0),setTimeout(()=>{d.success("策略测试成功"),Oe(!1)},1500)},Ue=g=>{_.resetFields(),d.success("已重置为"+g+"模板")},S=()=>[{key:"mine",label:"我的策略",children:e.jsx(Dt,{itemLayout:"horizontal",dataSource:V,loading:Te,renderItem:g=>e.jsx(Dt.Item,{className:"strategy-list-item",actions:[e.jsx(L,{type:"link",size:"small",onClick:()=>Ce(g),children:"编辑"},"edit"),e.jsx(L,{type:"link",danger:!0,size:"small",onClick:()=>gt(g),children:"删除"},"delete")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:g.name}),e.jsx("div",{className:"strategy-desc",children:g.description})]})})})},{key:"templates",label:"策略模板",children:e.jsx(Dt,{itemLayout:"horizontal",dataSource:P,loading:x,renderItem:g=>e.jsx(Dt.Item,{className:"strategy-list-item",actions:[e.jsx(L,{type:"link",size:"small",onClick:()=>ft(g.id),children:"使用"},"use")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:g.name}),e.jsx("div",{className:"strategy-desc",children:g.description})]})})})}];return e.jsxs("div",{className:"strategy-builder",children:[e.jsxs("div",{className:"page-header",style:{marginBottom:"20px"},children:[e.jsx(Zr,{level:2,children:"策略构建器"}),e.jsx(Jr,{children:"创建和测试您的交易策略"})]}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:18,children:e.jsx(oe,{title:"策略编辑器",bordered:!1,className:"editor-card",children:e.jsxs(T,{form:_,layout:"vertical",initialValues:Ke,onFinish:yt,children:[e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"name",label:"策略名称",rules:[{required:!0,message:"请输入策略名称"},{max:50,message:"策略名称不能超过50个字符"}],children:e.jsx(ke,{placeholder:"请输入策略名称"})})}),e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"description",label:"策略描述",rules:[{max:200,message:"策略描述不能超过200个字符"}],children:e.jsx(ke.TextArea,{placeholder:"请输入策略描述",autoSize:{minRows:1,maxRows:3}})})})]}),e.jsx(T.Item,{name:"code",label:"策略代码",rules:[{required:!0,message:"请输入策略代码"}],children:e.jsx(qa,{height:"450px",extensions:[ar()],onChange:g=>_.setFieldsValue({code:g})})}),e.jsx(T.Item,{children:e.jsxs(De,{children:[e.jsx(L,{type:"primary",htmlType:"submit",loading:ce,children:"保存策略"}),e.jsx(L,{type:"default",onClick:tt,loading:te,children:"测试策略"}),e.jsx(rr,{overlay:e.jsxs(es,{children:[e.jsx(es.Item,{onClick:()=>Ue("basic"),children:"基础策略模板"},"basic"),e.jsx(es.Item,{onClick:()=>Ue("technical"),children:"技术指标策略"},"technical"),e.jsx(es.Item,{onClick:()=>Ue("empty"),children:"空白策略"},"empty")]}),children:e.jsxs(L,{children:["重置模板 ",e.jsx(nr,{})]})})]})})]})})}),e.jsx(y,{span:6,children:e.jsx(oe,{title:"策略库",bordered:!1,className:"strategy-library-card",style:{marginBottom:"16px",height:"300px"},children:e.jsx(us,{defaultActiveKey:"mine",items:S()})})})]})]})};var Tt=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});const Rt="http://localhost:8001/api",en=n=>Tt(void 0,null,function*(){var r;try{const l={};n&&(l.name=n);const b=yield q.get(`${Rt}/strategies`,{params:l});if(b.data&&b.data.status==="success")return b.data.data||[];throw new Error(((r=b.data)==null?void 0:r.message)||"获取策略列表失败")}catch(l){return d.error(`获取策略列表错误: ${l.message}`),[]}}),tn=n=>Tt(void 0,null,function*(){var r;try{const l=yield q.get(`${Rt}/strategies/${n}`);if(l.data&&l.data.status==="success")return l.data.data;throw new Error(((r=l.data)==null?void 0:r.message)||"获取策略详情失败")}catch(l){return d.error(`获取策略详情错误: ${l.message}`),null}}),sn=n=>Tt(void 0,null,function*(){var r;try{const l=yield q.post(`${Rt}/strategies`,n);if(l.data&&l.data.status==="success")return d.success("策略创建成功"),l.data.data;throw new Error(((r=l.data)==null?void 0:r.message)||"创建策略失败")}catch(l){return d.error(`创建策略错误: ${l.message}`),null}}),an=(n,r)=>Tt(void 0,null,function*(){var l;try{const b=yield q.put(`${Rt}/strategies/${n}`,r);if(b.data&&b.data.status==="success")return d.success("策略更新成功"),b.data.data;throw new Error(((l=b.data)==null?void 0:l.message)||"更新策略失败")}catch(b){return d.error(`更新策略错误: ${b.message}`),null}}),rn=(n,r,l)=>Tt(void 0,null,function*(){var b;try{const f={code:n,data:r||[],parameters:l||{}},_=yield q.post(`${Rt}/strategies/test`,f);if(_.data&&_.data.status==="success")return _.data.data;throw new Error(((b=_.data)==null?void 0:b.message)||"测试策略失败")}catch(f){return d.error(`测试策略错误: ${f.message}`),{error:f.message}}}),oa=(n,r,l,b,...f)=>Tt(void 0,[n,r,l,b,...f],function*(_,D,z,j,k=1e5,Y={},Q=.0015,V=.001,$e="database",Te=[]){var ue;try{const Z={strategy_id:_,symbol:D,start_date:z,end_date:j,initial_capital:k,parameters:Y,commission_rate:Q,slippage_rate:V,data_source:$e,features:Te},pe=yield q.post(`${Rt}/strategies/backtest`,Z);if(pe.data&&pe.data.status==="success")return pe.data.data;throw new Error(((ue=pe.data)==null?void 0:ue.message)||"策略回测失败")}catch(Z){return d.error(`策略回测错误: ${Z.message}`),{error:Z.message}}}),nn=(n,r,l,b,...f)=>Tt(void 0,[n,r,l,b,...f],function*(_,D,z,j,k=1e5,Y={},Q=.0015,V=.001,$e="database",Te=[]){var ue;try{const Z={strategy_id:_,symbol:D,start_date:z,end_date:j,initial_capital:k,parameters:Y,commission_rate:Q,slippage_rate:V,data_source:$e,features:Te,force_refresh:!0},pe=yield q.post(`${Rt}/strategies/backtest`,Z);if(pe.data&&pe.data.status==="success")return pe.data.data;throw new Error(((ue=pe.data)==null?void 0:ue.message)||"策略回测失败")}catch(Z){return d.error(`策略回测错误: ${Z.message}`),{error:Z.message}}}),ln=(n,r,l,b,...f)=>Tt(void 0,[n,r,l,b,...f],function*(_,D,z,j,k=1e5,Y={},Q=.0015,V=.001,$e="database",Te=[],ue="normal"){var Z;try{const pe=ue==="high"?1:0,P={strategy_id:_.toString(),symbol:D,start_date:z,end_date:j,initial_capital:k,parameters:Y,commission_rate:Q,slippage_rate:V,data_source:$e,features:Te,priority:pe},O=yield q.post(`${Rt}/async/backtest/submit`,P);if(O.data&&O.data.task_id)return O.data;throw new Error(((Z=O.data)==null?void 0:Z.message)||"提交异步回测任务失败")}catch(pe){throw d.error(`提交异步回测任务错误: ${pe.message}`),pe}}),on=n=>Tt(void 0,null,function*(){try{return(yield q.get(`${Rt}/async/backtest/status/${n}`)).data}catch(r){throw d.error(`获取任务状态错误: ${r.message}`),r}}),cn=n=>Tt(void 0,null,function*(){try{return(yield q.get(`${Rt}/async/backtest/result/${n}`)).data}catch(r){throw d.error(`获取回测结果错误: ${r.message}`),r}});var dn=Object.defineProperty,un=Object.defineProperties,pn=Object.getOwnPropertyDescriptors,ia=Object.getOwnPropertySymbols,hn=Object.prototype.hasOwnProperty,mn=Object.prototype.propertyIsEnumerable,ca=(n,r,l)=>r in n?dn(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,ms=(n,r)=>{for(var l in r||(r={}))hn.call(r,l)&&ca(n,l,r[l]);if(ia)for(var l of ia(r))mn.call(r,l)&&ca(n,l,r[l]);return n},fs=(n,r)=>un(n,pn(r)),At=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});I.extend($a);I.extend(Ia);I.tz.setDefault("Asia/Shanghai");Ls([Ps,Fs,Os,Ns,Ts,Rs,or,ir,cr,Ys,dr,Es]);Ca.locale("zh-cn");const{Title:fn,Paragraph:xn}=Nt,{Option:Xt}=Ee,gn=()=>{var n;const r=Zt(),[l,b]=o.useState(!1),[f,_]=o.useState(!1),[D,z]=o.useState(1e5),[j,k]=o.useState(.15),[Y,Q]=o.useState(.1),[V,$e]=o.useState([]),[Te,ue]=o.useState(!1),[Z,pe]=o.useState(1),[P,O]=o.useState("MA交叉策略"),[x,Re]=o.useState(null),[Ie,ie]=o.useState([I().subtract(1,"year").startOf("day"),I().endOf("day")]),[Ye,Xe]=o.useState([]),[ce,et]=o.useState([]),[te,Oe]=o.useState([]),[je,rt]=o.useState([]),[zt,ct]=o.useState([]),[Ve,He]=o.useState({totalReturn:0,annualReturn:0,sharpeRatio:0,maxDrawdown:0,winRate:0,profitFactor:0,alpha:0,beta:0}),[Ce,gt]=o.useState([]),[wt,dt]=o.useState(null),[ft,Ke]=o.useState([]),[yt,tt]=o.useState([]),Ue=o.useRef(null),S=o.useRef(!1),[g,v]=o.useState({}),[H,re]=o.useState(!1),[J,Ne]=o.useState([]),[st,Be]=o.useState(null),[Ge,nt]=o.useState(!1),[Me,t]=o.useState([]),[a,u]=o.useState(!1),[h,M]=o.useState(!1),[A,R]=o.useState(""),[X,ne]=o.useState(""),[w,fe]=o.useState(!1),[be,le]=o.useState(null),[ze,E]=o.useState(""),[ee,qe]=o.useState(0),[Ze,ut]=o.useState(null),xe=s=>typeof s!="string"?String(s):s.includes("T")?s.split("T")[0]:s.includes(" ")?s.split(" ")[0]:/^\d{4}-\d{2}-\d{2}$/.test(s)?s:s.substring(0,10),lt=o.useCallback(s=>{if(!s||s.length===0)return[];const m=s.map((i,N)=>({key:N.toString(),date:xe(i.date),symbol:(x==null?void 0:x.symbol)||"",direction:i.action==="BUY"?"买入":"卖出",entryPrice:i.action==="BUY"?i.price:void 0,exitPrice:i.action==="SELL"?i.price:void 0,shares:i.shares,value:i.value,profitLoss:i.profit||0,returnPct:(i.profit_percent||0)*100,duration:i.holding_days||0,beforeCash:i.before_cash,afterCash:i.after_cash,beforeEquity:i.before_equity,afterEquity:i.after_equity,trigger_reason:i.trigger_reason,available_capital:i.available_capital,allocated_capital:i.allocated_capital,position_size:i.position_size,cumulative_position_ratio:i.cumulative_position_ratio,currentShares:0,currentAvgCost:0})).slice().sort((i,N)=>new Date(i.date).getTime()-new Date(N.date).getTime());let C=0,U=0;return m.forEach(i=>{if(i.direction==="买入"){const N=i.entryPrice||0;U+=i.shares*N,C+=i.shares}else if(i.direction==="卖出"){if(C>0){const N=i.shares/C;U*=1-N}C-=i.shares}i.currentShares=C,i.currentAvgCost=C>0?U/C:0}),m.sort((i,N)=>new Date(N.date).getTime()-new Date(i.date).getTime())},[x]),ls=()=>At(void 0,null,function*(){var s,c;if(!wt||!f){d.error("没有可保存的回测结果");return}if(!A.trim()){d.error("请输入回测名称");return}M(!0);try{const m=Ie[0].format("YYYY-MM-DD"),C=Ie[1].format("YYYY-MM-DD"),U=yield oa(Z,x.symbol,m,C,D,{save_backtest:!0,backtest_name:A,backtest_description:X,parameters:g},j,Y,"database",[]);if(U.error){d.error(`保存失败: ${U.error}`);return}U.saved?(d.success("回测保存成功！"),u(!1),R(""),ne(""),Fe.confirm({title:"保存成功",content:"回测已成功保存，是否查看回测历史？",okText:"查看历史",cancelText:"继续回测",onOk:()=>{r("/backtest/history")}})):d.error("保存失败，请重试")}catch(m){console.error("保存回测失败:",m),d.error(((c=(s=m.response)==null?void 0:s.data)==null?void 0:c.detail)||"保存失败，请重试")}finally{M(!1)}}),Ht=o.useCallback(()=>{console.log("清理轮询定时器，当前pollingIntervalRef.current:",We.current),We.current&&(clearInterval(We.current),We.current=null,ut(null),console.log("轮询定时器已清理"))},[]);o.useEffect(()=>()=>{We.current&&(clearInterval(We.current),We.current=null)},[]);const We=o.useRef(null),ps=o.useCallback(s=>At(void 0,null,function*(){try{const c=yield on(s);if(console.log("任务状态:",c),E(c.status),qe(c.progress||0),c.status==="completed"){console.log("任务已完成，准备清理轮询"),We.current&&(console.log("立即清理轮询定时器，ID:",We.current),clearInterval(We.current),We.current=null,ut(null));try{let m;if(c.result&&Object.keys(c.result).length>0?(console.log("从状态响应中获取结果，避免额外请求"),m=c.result):(console.log("状态响应中无结果，发起结果请求"),m=yield cn(s)),console.log("异步回测结果:",m),m&&m.status==="error")console.error("回测执行失败:",m.message),d.error(`回测失败: ${m.message}`);else{const C=m.data||m;console.log("提取的回测数据:",C),Mt(C),d.success("异步回测完成")}}catch(m){console.error("获取回测结果失败:",m),d.error(`获取回测结果失败: ${m.message}`)}ue(!1),le(null)}else c.status==="failed"&&(console.log("任务失败，准备清理轮询"),We.current&&(console.log("立即清理轮询定时器，ID:",We.current),clearInterval(We.current),We.current=null,ut(null)),ue(!1),le(null),d.error(`异步回测失败: ${c.error||"未知错误"}`))}catch(c){console.error("获取任务状态失败:",c)}}),[]),Mt=o.useCallback(s=>{var c,m,C,U;if(s.error){d.error(`回测失败: ${s.error}`);return}if(console.log("回测结果:",s),console.log("回测结果关键字段:"),console.log("- total_return:",s.total_return),console.log("- annual_return:",s.annual_return),console.log("- sharpe_ratio:",s.sharpe_ratio),console.log("- max_drawdown:",s.max_drawdown),console.log("- win_rate:",s.win_rate),console.log("- profit_factor:",s.profit_factor),console.log("- trades 数量:",(c=s.trades)==null?void 0:c.length),console.log("- equity_curve 数量:",(m=s.equity_curve)==null?void 0:m.length),console.log("- drawdowns 数量:",(C=s.drawdowns)==null?void 0:C.length),s.trades||(s.trades=[],console.warn("未找到交易记录，设置为空数组")),s.equity_curve||(s.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),s.drawdowns||(s.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),He({totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0,alpha:(s.alpha||0)*100,beta:s.beta||0}),console.log("处理后的性能指标:",{totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0}),dt(s),s.trades&&s.trades.length>0){const de=lt(s.trades);et(de),Ke(de)}else et([]),Ke([]);if(s.equity_curve&&s.equity_curve.length>0){console.log("处理权益曲线数据:",s.equity_curve[0]);const de=s.equity_curve.map(N=>({date:xe(N.date),equity:N.equity}));rt(de),tt(de);const i=s.equity_curve.map(N=>{const he=xe(N.date),_e=Number(N.open)||0,K=Number(N.close)||0,B=Number(N.low)||0,W=Number(N.high)||0,me=Number(N.volume)||0;return[he,_e,K,B,W,me]});console.log("K线数据示例(前3条):",i.slice(0,3)),Oe(i)}else rt([]),tt([]),Oe([]);if(s.drawdowns&&s.drawdowns.length>0){const de=s.drawdowns.map(i=>({date:xe(i.date),drawdown:(i.drawdown||0)*100}));ct(de)}else ct([]);_(!0),(U=Ue.current)==null||U.scrollIntoView({behavior:"smooth"})},[xe,x]),vs=o.useCallback(()=>At(void 0,null,function*(){if(!Z||!x||!Ie[0]||!Ie[1]){d.error("请选择策略、交易品种和回测周期");return}ue(!0),dt(null),_(!1);try{const s=Ie[0].format("YYYY-MM-DD"),c=Ie[1].format("YYYY-MM-DD");if(w){console.log("使用异步模式提交回测任务");const m=yield ln(Z,x.symbol,s,c,D,{save_backtest:!1,parameters:g},j,Y,"database",[],"normal");console.log("异步任务提交成功:",m),le(m.task_id),E("pending"),qe(0);const C=setInterval(()=>{ps(m.task_id)},2e3);We.current=C,ut(C),d.info("回测任务已提交，正在后台执行...")}else{console.log("使用同步模式执行回测");const m=yield oa(Z,x.symbol,s,c,D,{save_backtest:!1,parameters:g},j,Y,"database",[]);Mt(m),(()=>{d.success("回测完成")})(),ue(!1)}}catch(s){console.error("回测执行失败:",s),d.error(`回测失败: ${s.message||"未知错误"}`),ue(!1),le(null),Ht()}}),[Z,x,Ie,D,j,Y,g,w,Mt,ps,Ht]),_s=o.useCallback(()=>At(void 0,null,function*(){var s,c,m,C;if(!Z||!x||!Ie[0]||!Ie[1]){d.error("请选择策略、交易品种和回测周期");return}ue(!0),dt(null),_(!1);try{const U=Ie[0].format("YYYY-MM-DD"),de=Ie[1].format("YYYY-MM-DD"),i=yield nn(Z,x.symbol,U,de,D,{save_backtest:!1,parameters:g},j,Y,"database",[]);if(i.error){d.error(`强制刷新回测失败: ${i.error}`);return}if(console.log("强制刷新回测结果:",i),console.log("回测结果关键字段:"),console.log("- total_return:",i.total_return),console.log("- annual_return:",i.annual_return),console.log("- sharpe_ratio:",i.sharpe_ratio),console.log("- max_drawdown:",i.max_drawdown),console.log("- win_rate:",i.win_rate),console.log("- profit_factor:",i.profit_factor),console.log("- trades 数量:",(s=i.trades)==null?void 0:s.length),console.log("- equity_curve 数量:",(c=i.equity_curve)==null?void 0:c.length),console.log("- drawdowns 数量:",(m=i.drawdowns)==null?void 0:m.length),i.trades||(i.trades=[],console.warn("未找到交易记录，设置为空数组")),i.equity_curve||(i.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),i.drawdowns||(i.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),He({totalReturn:(i.total_return||0)*100,annualReturn:(i.annual_return||0)*100,sharpeRatio:i.sharpe_ratio||0,maxDrawdown:(i.max_drawdown||0)*100,winRate:(i.win_rate||0)*100,profitFactor:i.profit_factor||0,alpha:(i.alpha||0)*100,beta:i.beta||0}),console.log("处理后的性能指标:",{totalReturn:(i.total_return||0)*100,annualReturn:(i.annual_return||0)*100,sharpeRatio:i.sharpe_ratio||0,maxDrawdown:(i.max_drawdown||0)*100,winRate:(i.win_rate||0)*100,profitFactor:i.profit_factor||0}),dt(i),i.trades&&i.trades.length>0){const he=lt(i.trades);et(he),Ke(he)}else et([]),Ke([]);if(i.equity_curve&&i.equity_curve.length>0){console.log("处理权益曲线数据:",i.equity_curve[0]);const he=i.equity_curve.map(K=>({date:xe(K.date),equity:K.equity}));rt(he),tt(he);const _e=i.equity_curve.map(K=>{const B=xe(K.date),W=Number(K.open)||0,me=Number(K.close)||0,we=Number(K.low)||0,ht=Number(K.high)||0,St=Number(K.volume)||0;return[B,W,me,we,ht,St]});console.log("K线数据示例(前3条):",_e.slice(0,3)),Oe(_e)}else rt([]),tt([]),Oe([]);if(i.drawdowns&&i.drawdowns.length>0){const he=i.drawdowns.map(_e=>({date:xe(_e.date),drawdown:(_e.drawdown||0)*100}));ct(he)}else ct([]);_(!0),(C=Ue.current)==null||C.scrollIntoView({behavior:"smooth"}),(()=>{d.success("强制刷新回测完成")})()}catch(U){console.error("强制刷新回测执行失败:",U),d.error(`强制刷新回测失败: ${U.message||"未知错误"}`)}finally{ue(!1)}}),[Z,x,Ie,D,j,Y,xe,et,Ke,Oe,rt,tt,ct,_,dt,He,ue]),ws=()=>{const s=x?`${x.name} (${x.symbol}) K线图与交易信号`:"K线图与交易信号";let c=[],m=[];if(!te||te.length===0)return console.warn("K线数据为空，无法生成图表"),{title:{text:s,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};if(ce.length>0&&te.length>0){if(console.log("准备标记交易信号，总交易记录：",ce.length),console.log("K线数据样本:",te.slice(0,3)),te.length>0){const K=te[0][0];console.log("K线日期格式示例:",{original:K,type:typeof K,split:typeof K=="string"?K.split("T"):null})}if(ce.length>0){const K=ce[0].date;console.log("交易记录日期格式示例:",{original:K,type:typeof K,split:typeof K=="string"?K.split("T"):null,split2:typeof K=="string"?K.split(" "):null})}const i=new Map,N=new Map;te.forEach((K,B)=>{const W=xe(K[0]);i.set(W,B),N.set(W,[Number(K[1]),Number(K[2]),Number(K[3]),Number(K[4])])}),console.log("日期索引映射创建完成，共计:",i.size),console.log("日期映射示例:",Array.from(i.entries()).slice(0,3));const he=ce.filter(K=>K.direction==="买入");console.log("买入记录:",he.length),c=he.map(K=>{const B=xe(K.date),W=i.get(B),me=K.entryPrice||0;return W===void 0||me<=0?(console.warn(`未找到买入日期 ${B} 对应的K线索引或价格无效`),null):(console.log(`买入日期匹配成功: ${B} -> 索引 ${W}, 价格 ${me}`),{name:"买入",value:[W,me],xAxis:W,yAxis:me,itemStyle:{color:"#f64034"}})}).filter(K=>K!==null);const _e=ce.filter(K=>K.direction==="卖出");console.log("卖出记录:",_e.length),m=_e.map(K=>{const B=xe(K.date),W=i.get(B),me=K.exitPrice||0,we=K.profitLoss||0;if(K.returnPct,W===void 0||me<=0)return console.warn(`未找到卖出日期 ${B} 对应的K线索引或价格无效`),null;console.log(`卖出日期匹配成功: ${B} -> 索引 ${W}, 价格 ${me}, 盈亏 ${we}`);const ht=we>=0?"#f64034":"#00b46a";return{name:"卖出",value:[W,me],xAxis:W,yAxis:me,itemStyle:{color:ht}}}).filter(K=>K!==null),console.log(`成功生成买入信号: ${c.length}/${he.length}`),console.log(`成功生成卖出信号: ${m.length}/${_e.length}`)}const C=te.map(i=>i[0]);let U=[];U=[...c.map(i=>(i.value[0],{name:"买入点",coord:[i.value[0],i.value[1]],value:i.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...m.map(i=>({name:"卖出点",coord:[i.value[0],i.value[1]],value:i.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...c.map(i=>{const N=i.value[0],_e=te[N][4]*1.1;return{name:"买入标签",coord:[i.value[0],_e],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...m.map(i=>{const N=i.value[0],he=c.some(B=>{const W=B.value[0],me=xe(te[W][0]),we=xe(te[N][0]);return me===we}),_e=te[N][4],K=he?_e*1.2:_e*1.1;return{name:"卖出标签",coord:[i.value[0],K],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];const de=[...c.map(i=>({name:"买入价格",coord:[i.value[0],i.value[1]*1.03],symbol:"none",label:{show:!0,formatter:`¥${i.value[1].toFixed(2)}`,fontSize:12,color:"#f64034",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"top",distance:8}})),...m.map(i=>{const N=i.value[0],he=te[N][0],_e=ce.find(we=>we.direction==="卖出"&&xe(we.date)===xe(he)),K=_e&&_e.profitLoss||0,B=_e&&_e.returnPct||0,W=K>=0?`+${K.toFixed(2)}`:`${K.toFixed(2)}`,me=B>=0?`+${B.toFixed(2)}%`:`${B.toFixed(2)}%`;return{name:"卖出价格",coord:[i.value[0],i.value[1]*.97],symbol:"none",label:{show:!0,formatter:_e?`¥${i.value[1].toFixed(2)}
${W}(${me})`:`¥${i.value[1].toFixed(2)}`,fontSize:12,color:"#00b46a",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"bottom",distance:8}}})];return{title:{text:s,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(i){let N="";if(Array.isArray(i)){const he=i[0].axisValue;N=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${he}</div>`,i.forEach(W=>{if(W.seriesName==="K线"){if(W.value&&W.value.length>=4){const me=Number(W.value[1])||0,we=Number(W.value[2])||0,ht=Number(W.value[3])||0,St=Number(W.value[4])||0,mt=we>=me?"#f64034":"#00b46a";N+=`<div style="color:${mt};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${mt};">${me.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${mt};">${we.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${mt};">${ht.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${mt};">${St.toFixed(2)}</span><br/>
                  </div>`}}else if(W.seriesName&&W.seriesName.startsWith("MA")&&W.value!=="-"){const we={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[W.seriesName]||W.color;try{const ht=typeof W.value=="number"?parseFloat(W.value.toString()).toFixed(3):parseFloat(W.value||"0").toFixed(3);N+=`<div style="color:${we};font-weight:bold;display:inline-block;margin-right:15px;">${W.seriesName}：${ht}</div>`}catch(ht){console.warn("格式化MA值出错:",ht),N+=`<div style="color:${we};font-weight:bold;display:inline-block;margin-right:15px;">${W.seriesName}：0</div>`}}});const _e=xe(he),K=ce.find(W=>W.direction==="买入"&&xe(W.date)===_e),B=ce.find(W=>W.direction==="卖出"&&xe(W.date)===_e);if((K||B)&&(N+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),K){const W=K.entryPrice||0,me=K.trigger_reason||"未记录原因";N+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${W.toFixed(2)}<br/>
                原因：${me}
              </div>`}if(B){const W=B.exitPrice||0,me=B.profitLoss||0,we=B.returnPct||0,ht=B.trigger_reason||"未记录原因",St=me>=0?`+${me.toFixed(2)}`:`${me.toFixed(2)}`,mt=we>=0?`+${we.toFixed(2)}%`:`${we.toFixed(2)}%`;N+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${W.toFixed(2)}<br/>
                盈亏：${St} (${mt})<br/>
                原因：${ht}
              </div>`}}return N}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:C,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"},min:function(i){return Math.min(0,D*.8)},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:te.map(i=>[Number(i[1]),Number(i[2]),Number(i[3]),Number(i[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:U,animation:!1,z:10}},{name:"价格标签",type:"scatter",data:[],markPoint:{symbol:"none",data:de,animation:!1,z:9}},{name:"MA5",type:"line",data:Jt(5,te.map(i=>[Number(i[1]),Number(i[2]),Number(i[3]),Number(i[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Jt(10,te.map(i=>[Number(i[1]),Number(i[2]),Number(i[3]),Number(i[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Jt(20,te.map(i=>[Number(i[1]),Number(i[2]),Number(i[3]),Number(i[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Jt(30,te.map(i=>[Number(i[1]),Number(i[2]),Number(i[3]),Number(i[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}};function Jt(s,c){if(!c||!Array.isArray(c)||c.length===0)return console.warn(`计算MA${s}失败: 数据无效`),[];console.log(`MA${s}计算 - 输入数据示例:`,c.length>0?c.slice(0,3):"无数据");const m=[];for(let C=0;C<c.length;C++){if(C<s-1){m.push("-");continue}let U=0,de=0;for(let i=0;i<s;i++){const N=c[C-i];if(N&&N.length>=4){const he=Number(N[1]);!isNaN(he)&&he>0&&(U+=he,de++)}}de>0?m.push((U/de).toFixed(2)):m.push("-")}return m.length>0&&console.log(`MA${s}计算结果示例:`,m.slice(0,5)),m}const Ss=[{title:"日期",dataIndex:"date",key:"date",sorter:(s,c)=>{const m=new Date(s.date),C=new Date(c.date);return m.getTime()-C.getTime()}},{title:"方向",dataIndex:"direction",key:"direction",filters:[{text:"买入",value:"买入"},{text:"卖出",value:"卖出"}],onFilter:(s,c)=>c.direction===s,render:s=>e.jsx(Pe,{color:s==="买入"?"red":"green",children:s})},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:s=>e.jsx(Se,{title:s||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:s||"未记录"})})},{title:"期初资金",dataIndex:"beforeCash",key:"beforeCash",sorter:(s,c)=>s.beforeCash-c.beforeCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"afterCash",key:"afterCash",sorter:(s,c)=>s.afterCash-c.afterCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"入场价",dataIndex:"entryPrice",key:"entryPrice",sorter:(s,c)=>{const m=s.entryPrice||0,C=c.entryPrice||0;return m-C},render:s=>{const c=parseFloat(s);return isNaN(c)?"-":c.toFixed(2)}},{title:"出场价",dataIndex:"exitPrice",key:"exitPrice",sorter:(s,c)=>{const m=s.exitPrice||0,C=c.exitPrice||0;return m-C},render:s=>{const c=parseFloat(s);return isNaN(c)?"-":c.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(s,c)=>s.shares-c.shares,render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前持仓(股)",dataIndex:"currentShares",key:"currentShares",sorter:(s,c)=>(s.currentShares||0)-(c.currentShares||0),render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前摊薄成本(元)",dataIndex:"currentAvgCost",key:"currentAvgCost",sorter:(s,c)=>(s.currentAvgCost||0)-(c.currentAvgCost||0),render:s=>{const c=parseFloat(s)||0;return c>0?c.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"-"}},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(s,c)=>s.value-c.value,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"盈亏",dataIndex:"profitLoss",key:"profitLoss",sorter:(s,c)=>s.profitLoss-c.profitLoss,render:s=>{const c=parseFloat(s);return isNaN(c)?e.jsx("span",{children:"0.00"}):c>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",c.toFixed(2)]}):e.jsx("span",{style:{color:"#52c41a"},children:c.toFixed(2)})}},{title:"收益率(%)",dataIndex:"returnPct",key:"returnPct",sorter:(s,c)=>s.returnPct-c.returnPct,render:s=>{const c=parseFloat(s);return isNaN(c)?e.jsx("span",{children:"0.00%"}):c>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",c.toFixed(2),"%"]}):e.jsxs("span",{style:{color:"#52c41a"},children:[c.toFixed(2),"%"]})}},{title:"持仓天数",dataIndex:"duration",key:"duration",sorter:(s,c)=>s.duration-c.duration},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(s,c)=>(s.position_size||0)-(c.position_size||0),render:s=>{const c=parseFloat(s);return isNaN(c)||c===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(c*100).toFixed(2),"%"]})}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(s,c)=>(s.cumulative_position_ratio||0)-(c.cumulative_position_ratio||0),render:s=>{const c=parseFloat(s);return isNaN(c)||c===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(c*100).toFixed(2),"%"]})}}],ks=()=>{if(console.log("生成权益曲线图表, 数据长度:",je.length),!je||je.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const s=je.filter(B=>B&&B.date&&B.equity!==void 0&&!isNaN(Number(B.equity)));if(s.length===0)return console.error("权益曲线数据无效:",je.slice(0,3)),{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};console.log("有效数据点数量:",s.length),console.log("权益曲线数据范围:",s.length>0?`${s[0].date}(${s[0].equity}) ~ ${s[s.length-1].date}(${s[s.length-1].equity})`:"无数据");let c=[],m=[];const C=new Map;s.forEach((B,W)=>{const me=xe(B.date);C.set(me,W)}),ce.length>0&&(console.log("准备在权益曲线上标记交易点，总交易记录：",ce.length),ce.forEach(B=>{const W=xe(B.date),me=C.get(W);if(me!==void 0){const we={name:B.direction==="买入"?"买入点":"卖出点",value:s[me].equity,xAxis:me,yAxis:s[me].equity,itemStyle:{color:B.direction==="买入"?"#f64034":"#00b46a"}};B.direction==="买入"?c.push(we):m.push(we)}}));let U=-1,de=-1,i=0,N="",he="",_e=0,K=0;if(s.length>0&&Ve.maxDrawdown>0){let B=s[0].equity,W=0,me=0;for(let we=1;we<s.length;we++)s[we].equity>B?(B=s[we].equity,me=we):(W=(B-s[we].equity)/B*100,W>i&&(i=W,U=me,de=we,N=s[me].date,he=s[we].date,_e=B,K=s[we].equity));console.log(`最大回测区间索引: ${U} - ${de}`),console.log(`最大回测: ${i.toFixed(2)}%, 从 ${N} 到 ${he}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(B){if(Array.isArray(B)&&B.length>0){const me=B[0].axisValue,we=B[0].data;for(let St=0;St<B.length;St++)if(B[St].componentType==="markArea")return`最大回撤: ${i.toFixed(2)}%<br/>
                        开始日期: ${N}<br/>
                        最高点: ¥${_e.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${he}<br/>
                        最低点: ¥${K.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let ht="";for(let St=0;St<B.length;St++){const mt=B[St];if(mt.seriesName==="买入点"||mt.seriesName==="卖出点"){const Ba=xe(me),Vs=ce.find(os=>xe(os.date)===Ba&&(mt.seriesName==="买入点"&&os.direction==="买入"||mt.seriesName==="卖出点"&&os.direction==="卖出"));if(Vs){const os=Vs.trigger_reason||"未记录原因";ht=`<br/><span style="color:${mt.color}">● ${mt.seriesName}</span>`,ht+=`<br/><span style="color:#555; font-size:12px">原因: ${os}</span>`}else ht=`<br/><span style="color:${mt.color}">● ${mt.seriesName}</span>`;break}}return`${me}<br/>策略收益: ¥${parseFloat(we).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${ht}`}const W=B.value;return`${B.name}: ¥${parseFloat(W).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:s.map(B=>B.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:s.map(B=>B.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new za(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...c.map(B=>({name:"买入点",coord:[B.xAxis,B.yAxis],value:B.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...m.map(B=>({name:"卖出点",coord:[B.xAxis,B.yAxis],value:B.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${i.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[U>=0&&de>=0?[{name:"最大回撤开始",xAxis:U,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:de,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:s.map(()=>D),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:D,label:{formatter:"初始资金: ¥"+D.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(B){return`初始资金: ¥${D.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},p=()=>At(void 0,null,function*(){try{const s=yield en();if(console.log("从后端获取的策略列表:",s),s&&s.length>0)if(gt(s),!s.some(c=>c.id===Z))pe(s[0].id||1),O(s[0].name||"移动平均线交叉策略");else{const c=s.find(m=>m.id===Z);c&&O(c.name)}else d.error("未找到策略列表，请先创建策略")}catch(s){console.error("获取策略列表失败:",s),d.error("获取策略列表失败，请检查网络连接")}});o.useEffect(()=>{S.current||(S.current=!0,F(),jt(),p())},[]),o.useEffect(()=>{Ce.length>0&&Z&&ye(Z)},[Ce,Z]);const $=s=>At(void 0,null,function*(){Re(s);try{const c=yield Nr(s.id);if(c.first_date&&c.last_date){const m=I(c.first_date).startOf("day"),C=I(c.last_date).endOf("day");ie([m,C]),d.success(`已自动设置回测周期：${c.first_date} 至 ${c.last_date}`)}}catch(c){console.error("获取股票日期范围失败:",c),d.warning("无法获取该股票的数据日期范围，请手动设置回测周期")}}),F=()=>At(void 0,null,function*(){ue(!0);try{const s=yield bs();$e(s),s.length>0&&(yield $(s[0]))}catch(s){console.error("获取股票列表失败:",s)}finally{ue(!1)}}),ye=s=>At(void 0,null,function*(){try{const c=yield q.get(`/api/optimization/strategies/${s}/parameter-spaces`);if(c.data&&c.data.status==="success"){Ne(c.data.data);const m={};c.data.data.forEach(C=>{(C.parameter_type==="int"||C.parameter_type==="float")&&(m[C.parameter_name]=C.min_value)}),v(m)}}catch(c){console.error("加载参数空间失败:",c),Ne([]),v({})}}),Ae=()=>{re(!0)},se=()=>{re(!1),d.success("参数设置已保存")},ae=()=>{const s={};J.forEach(c=>{(c.parameter_type==="int"||c.parameter_type==="float")&&(s[c.parameter_name]=c.min_value)}),v(s),d.success("参数已重置为默认值")},ve=()=>At(void 0,null,function*(){try{const s=yield q.get(`/api/optimization/strategies/${Z}/best-parameters`);s.data&&s.data.status==="success"&&s.data.data.length>0?(t(s.data.data),nt(!0)):d.warning("该策略暂无优化结果，请先进行参数优化")}catch(s){console.error("获取优化结果失败:",s),d.error("获取优化结果失败，请检查网络连接")}}),at=s=>{var c;v(s.best_parameters),nt(!1),re(!1),d.success(`已导入优化结果: ${s.job_name} (得分: ${(c=s.best_score)==null?void 0:c.toFixed(4)})`)},Le=s=>{pe(s);const c=Ce.find(m=>m.id===s);c&&(O(c.name),Be(c)),ye(s)},jt=()=>At(void 0,null,function*(){try{const s=yield Oa();Xe(s)}catch(s){console.error("获取数据源列表失败:",s)}}),Pt=()=>[{key:"1",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"绩效分析"]}),children:e.jsx(G,{gutter:16,children:e.jsx(y,{span:24,style:{marginBottom:16},children:e.jsx(Bt,{option:ks(),style:{height:500}})})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"K线与交易信号"]}),children:e.jsx(G,{gutter:16,children:e.jsx(y,{span:24,children:e.jsx(oe,{title:x?`${x.name} (${x.symbol})交易图表`:"交易图表",extra:e.jsxs(De,{children:[e.jsx(L,{type:"primary",size:"small",onClick:()=>{const s=document.querySelector(".kline-chart");if(s){const c=s.__echarts__;c&&c.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(L,{size:"small",onClick:()=>{if(ce.length>0&&te.length>0){const s=new Map;te.forEach((m,C)=>{const U=xe(m[0]);s.set(U,C)});const c=[];if(ce.forEach(m=>{const C=xe(m.date),U=s.get(C);U!==void 0&&c.push(U)}),console.log("找到的交易日期索引:",c),c.length>0){const m=Math.max(0,Math.min(...c)-10),C=Math.min(te.length-1,Math.max(...c)+10),U=m/te.length*100,de=C/te.length*100;console.log(`设置缩放范围: ${U.toFixed(2)}% - ${de.toFixed(2)}%`);const i=document.querySelector(".kline-chart");if(i){const N=i.__echarts__;N&&(N.dispatchAction({type:"dataZoom",start:U,end:de}),(_e=>{d.success(`已聚焦到交易区域，共显示 ${_e} 个交易点`)})(c.length))}}else(()=>{d.info("未找到交易信号对应的K线数据点")})()}else(()=>{d.info("没有交易记录或K线数据")})()},children:"聚焦交易"}),e.jsx(Se,{title:"只显示有交易的区域",children:e.jsx(Je,{})})]}),children:e.jsx(Bt,{className:"kline-chart",option:ws(),style:{height:600},notMerge:!0,opts:{renderer:"canvas"},onEvents:{click:s=>{if(s.componentType==="markPoint"){const m=s.name==="买入",C=s.data.coord[0],U=te[C][0],de=m?"买入":"卖出",i=ce.find(N=>N.direction===de&&xe(N.date)===xe(U));if(console.log(`点击了${de}标记，日期: ${U}`,i),i){const N=i,he=m?"买入详情":"卖出详情",_e=e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"日期:"})," ",N.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"价格:"})," ",m?N.entryPrice:N.exitPrice]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数量:"})," ",N.shares.toLocaleString()," 股"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"金额:"})," ",N.value.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),!m&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏:"})," ",N.profitLoss>=0?"+":"",N.profitLoss.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"收益率:"})," ",N.returnPct>=0?"+":"",N.returnPct.toFixed(2),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"持仓天数:"})," ",N.duration," 天"]})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易前资金:"})," ",N.beforeCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易后资金:"})," ",N.afterCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"触发原因:"})," ",N.trigger_reason||"未记录原因"]})]});Fe.info({title:he,content:_e,width:400})}else((he,_e)=>{d.info(`未找到匹配的${he}交易记录，日期: ${_e}`)})(de,U)}}}})})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Je,{}),"交易明细"]}),children:e.jsx(Gt,{dataSource:ce,columns:Ss,pagination:{pageSize:10},scroll:{x:!0}})}];return e.jsxs("div",{children:[e.jsx(fn,{level:2,children:"回测分析"}),e.jsx(xn,{children:"回测您的交易策略，分析策略表现并优化参数。"}),e.jsx(oe,{children:e.jsx(rs,{spinning:Te,children:e.jsxs(T,{layout:"vertical",children:[e.jsxs(G,{gutter:24,children:[e.jsx(y,{span:8,children:e.jsx(T.Item,{label:"策略选择",required:!0,children:e.jsxs(ke.Group,{compact:!0,children:[e.jsx(Ee,{value:P,onChange:(s,c)=>{Le(Number(c.key))},placeholder:"选择策略",style:{width:"calc(100% - 80px)"},size:"middle",children:Ce.map(s=>e.jsx(Xt,{value:s.name,children:s.name},s.id))}),e.jsx(L,{type:"primary",ghost:!0,onClick:Ae,style:{width:"80px"},icon:e.jsx(js,{}),size:"middle",children:"参数"})]})})}),e.jsx(y,{span:8,children:e.jsx(T.Item,{label:"交易品种",required:!0,children:e.jsx(Ee,{value:x==null?void 0:x.symbol,onChange:s=>At(void 0,null,function*(){const c=V.find(m=>m.symbol===s);c&&(yield $(c))}),placeholder:"选择交易品种",children:V.map(s=>{var c;return e.jsxs(Xt,{value:s.symbol,children:[s.name," (",s.symbol,") - ",((c=Ye.find(m=>m.id===s.source_id))==null?void 0:c.name)||"未知数据源"]},s.id)})})})}),e.jsx(y,{span:8,children:e.jsx(T.Item,{label:"回测周期",required:!0,children:e.jsx(Wt.RangePicker,{value:Ie,onChange:s=>{s&&s[0]&&s[1]&&ie([s[0].startOf("day"),s[1].endOf("day")])},style:{width:"100%"},placeholder:["开始日期","结束日期"],format:"YYYY-MM-DD",allowClear:!1,disabledDate:s=>s&&s>I().endOf("day"),presets:[{label:"Last 7 days",value:[I().subtract(7,"day"),I()]},{label:"Last 30 days",value:[I().subtract(30,"day"),I()]},{label:"Last 3 months",value:[I().subtract(3,"month"),I()]},{label:"Last 6 months",value:[I().subtract(6,"month"),I()]},{label:"Last 1 year",value:[I().subtract(1,"year"),I()]},{label:"Last 3 years",value:[I().subtract(3,"year"),I()]},{label:"Last 5 years",value:[I().subtract(5,"year"),I()]},{label:"Last 7 years",value:[I().subtract(7,"year"),I()]},{label:"Last 10 years",value:[I().subtract(10,"year"),I()]}]})})})]}),e.jsxs(G,{gutter:24,children:[e.jsx(y,{span:6,children:e.jsx(T.Item,{label:"初始资金",children:e.jsx(Et,{value:D,onChange:s=>z(Number(s)||1e5),formatter:s=>`¥ ${s}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:s=>{if(s){const c=parseFloat(s.replace(/\¥\s?|(,*)/g,""));return isNaN(c)?D:c}return D},style:{width:"100%"}})})}),e.jsx(y,{span:6,children:e.jsx(T.Item,{label:"手续费率(%)",children:e.jsx(Et,{value:j,onChange:s=>k(Number(s)||.15),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(y,{span:6,children:e.jsx(T.Item,{label:"滑点(%)",children:e.jsx(Et,{value:Y,onChange:s=>Q(Number(s)||.1),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(y,{span:6,children:e.jsx(T.Item,{label:"基准",children:e.jsxs(Ee,{defaultValue:"SPY",placeholder:"选择基准",children:[e.jsx(Xt,{value:"SPY",children:"标普500ETF"}),e.jsx(Xt,{value:"QQQ",children:"纳斯达克ETF"}),e.jsx(Xt,{value:"DIA",children:"道琼斯ETF"})]})})})]}),x&&e.jsx(xt,{message:`已选择数据源: ${((n=Ye.find(s=>s.id===x.source_id))==null?void 0:n.name)||"未知"}`,description:`回测将使用与数据管理中相同的数据源获取 ${x.symbol} 的历史数据`,type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(T.Item,{label:"执行模式",children:e.jsxs(De,{children:[e.jsx(ur,{checked:w,onChange:fe,checkedChildren:"异步",unCheckedChildren:"同步"}),e.jsx(Se,{title:w?"异步模式：任务在后台执行，可以处理大数据量回测":"同步模式：立即返回结果，适合快速回测",children:e.jsx(Je,{style:{color:"#aaa"}})}),w&&be&&e.jsxs(Pe,{color:ze==="completed"?"green":ze==="failed"?"red":"blue",children:["任务状态: ",ze==="pending"?"等待中":ze==="running"?"执行中":ze==="completed"?"已完成":ze==="failed"?"失败":ze,ze==="running"&&` (${ee}%)`]})]})}),e.jsx(T.Item,{children:e.jsxs(De,{children:[e.jsx(L,{type:"primary",icon:e.jsx(Ut,{}),loading:l,onClick:vs,children:w?"提交异步回测":"运行回测"}),e.jsx(L,{type:"default",icon:e.jsx(Ut,{}),loading:l,onClick:_s,title:"强制刷新：清除缓存并重新运行回测",disabled:w,children:"强制刷新"})]})})]})})}),f&&e.jsxs(e.Fragment,{children:[e.jsx(gs,{}),e.jsxs(oe,{children:[e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["总收益率 ",e.jsx(Se,{title:"总收益率=最终资金/初始资金-1，反映策略总体收益情况",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ve.totalReturn,precision:2,valueStyle:{color:Ve.totalReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(Se,{title:"年化收益率=（总收益率+1）^(365/天数)-1，反映策略年化增长速度",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ve.annualReturn,precision:2,valueStyle:{color:Ve.annualReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(Se,{title:"最大回撤=历史最高点到最低点的最大跌幅，衡量风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Math.abs(Ve.maxDrawdown),precision:2,valueStyle:{color:"#52c41a"},suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(Se,{title:"夏普比率=（年化收益率-无风险利率）/年化波动率，衡量单位风险收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ve.sharpeRatio,precision:2})})]}),e.jsx(G,{gutter:16,style:{marginTop:16},children:e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["胜率 ",e.jsx(Se,{title:"胜率=盈利交易次数/总交易次数",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ve.winRate,precision:2,suffix:"%"})})}),e.jsxs(G,{gutter:16,style:{marginTop:24},children:[e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(Se,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ve.profitFactor||0,precision:2})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Alpha ",e.jsx(Se,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ve.alpha||0,precision:2,suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Beta ",e.jsx(Se,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Ve.beta||0,precision:2})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["交易次数 ",e.jsx(Se,{title:"策略在回测期间的总交易次数",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:ce.length})})]}),e.jsx(gs,{}),e.jsx(us,{defaultActiveKey:"1",items:Pt()}),e.jsxs("div",{style:{textAlign:"right",marginTop:16},children:[e.jsx(L,{icon:e.jsx(ka,{}),style:{marginRight:8},children:"导出报告"}),e.jsx(L,{icon:e.jsx(Da,{}),type:"primary",onClick:()=>{const s=new Date,c=s.toISOString().slice(0,10).replace(/-/g,""),m=s.toTimeString().slice(0,5).replace(":",""),C=`${(x==null?void 0:x.symbol)||"UNKNOWN"}_v${c}_${m}`;R(C),u(!0)},disabled:!f,children:"保存回测"})]})]})]}),e.jsx(Fe,{title:"保存回测",open:a,onOk:ls,onCancel:()=>{u(!1),R(""),ne("")},confirmLoading:h,okText:"保存",cancelText:"取消",children:e.jsxs(T,{layout:"vertical",children:[e.jsx(T.Item,{label:"回测名称",required:!0,help:"请输入一个描述性的回测名称",children:e.jsx(ke,{placeholder:"例如：MA交叉策略_AAPL_2024年回测",value:A,onChange:s=>R(s.target.value)})}),e.jsx(T.Item,{label:"回测描述",help:"可选：添加回测的详细描述",children:e.jsx(ke.TextArea,{placeholder:"例如：使用移动平均线交叉策略对AAPL进行回测，包含仓位控制...",value:X,onChange:s=>ne(s.target.value),rows:3})}),e.jsx(xt,{message:"保存信息",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"策略："}),P]}),e.jsxs("p",{children:[e.jsx("strong",{children:"股票："}),x==null?void 0:x.symbol," (",x==null?void 0:x.name,")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"回测期间："}),Ie[0].format("YYYY-MM-DD")," 至 ",Ie[1].format("YYYY-MM-DD")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"初始资金："}),"$",D.toLocaleString()]}),Object.keys(g).length>0&&e.jsxs("p",{children:[e.jsx("strong",{children:"策略参数："}),"短期均线 ",g.short_window||5,"天, 长期均线 ",g.long_window||20,"天"]})]}),type:"info",showIcon:!0})]})}),e.jsxs(Fe,{title:"策略参数设置",open:H,onOk:se,onCancel:()=>re(!1),width:800,children:[e.jsx(xt,{message:`当前策略: ${(st==null?void 0:st.name)||P}`,description:(st==null?void 0:st.description)||"策略参数配置",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(T,{layout:"vertical",children:[J.length>0?e.jsx(G,{gutter:16,children:J.map((s,c)=>e.jsx(y,{span:12,children:e.jsx(T.Item,{label:`${s.parameter_name}${s.description?` (${s.description})`:""}`,help:s.description,children:s.parameter_type==="int"?e.jsx(Et,{value:g[s.parameter_name]||s.min_value,onChange:m=>v(C=>fs(ms({},C),{[s.parameter_name]:m})),min:s.min_value,max:s.max_value,step:s.step_size,style:{width:"100%"}}):s.parameter_type==="float"?e.jsx(Et,{value:g[s.parameter_name]||s.min_value,onChange:m=>v(C=>fs(ms({},C),{[s.parameter_name]:m})),min:s.min_value,max:s.max_value,step:s.step_size,precision:2,style:{width:"100%"}}):s.parameter_type==="choice"?e.jsx(Ee,{value:g[s.parameter_name]!==void 0?g[s.parameter_name]:s.choices&&s.choices.length>0?s.choices[0]:void 0,onChange:m=>v(C=>fs(ms({},C),{[s.parameter_name]:m})),style:{width:"100%"},children:(s.choices||[]).map((m,C)=>e.jsx(Xt,{value:m,children:typeof m=="boolean"?m?"true":"false":String(m)},C))}):e.jsx(ke,{value:g[s.parameter_name]||"",onChange:m=>v(C=>fs(ms({},C),{[s.parameter_name]:m.target.value})),placeholder:`请输入${s.parameter_name}`})})},s.parameter_name))}):e.jsx(xt,{message:"暂无参数配置",description:"该策略暂未配置参数空间，将使用默认参数进行回测",type:"warning",showIcon:!0}),J.length>0&&e.jsx(xt,{message:"参数说明",description:e.jsx("div",{children:J.map((s,c)=>e.jsxs("p",{children:[e.jsxs("strong",{children:[s.parameter_name,"："]}),s.description,s.parameter_type==="int"||s.parameter_type==="float"?` (范围: ${s.min_value} - ${s.max_value}, 步长: ${s.step_size})`:s.parameter_type==="choice"?` (选项: ${(s.choices||[]).map(m=>typeof m=="boolean"?m?"true":"false":String(m)).join(", ")})`:""]},c))}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(De,{children:[e.jsx(L,{onClick:ae,children:"重置默认值"}),e.jsx(L,{type:"dashed",onClick:ve,children:"从优化导入"})]})]})]}),e.jsxs(Fe,{title:"选择优化结果",open:Ge,onCancel:()=>nt(!1),width:800,footer:null,children:[e.jsx(xt,{message:"选择要导入的优化结果",description:"以下是从参数优化中获得的最佳参数配置，按优化得分排序",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("div",{style:{maxHeight:400,overflowY:"auto"},children:Me.map((s,c)=>{var m;return e.jsxs(oe,{size:"small",style:{marginBottom:8},hoverable:!0,onClick:()=>at(s),children:[e.jsxs(G,{gutter:16,align:"middle",children:[e.jsx(y,{span:16,children:e.jsxs("div",{children:[e.jsx("strong",{children:s.job_name}),e.jsxs("div",{style:{fontSize:"12px",color:"#666",marginTop:4},children:[s.description&&`${s.description} • `,"完成时间: ",s.completed_at?I.utc(s.completed_at).tz("Asia/Shanghai").format("YYYY/MM/DD HH:mm:ss"):"未知"]})]})}),e.jsx(y,{span:4,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"14px",fontWeight:"bold",color:"#1890ff"},children:(m=s.best_score)==null?void 0:m.toFixed(4)}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:s.objective_function})]})}),e.jsx(y,{span:4,children:e.jsx("div",{style:{textAlign:"center"},children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:["试验次数: ",s.total_trials]})})})]}),e.jsxs("div",{style:{marginTop:8,fontSize:"12px"},children:[e.jsx("strong",{children:"关键参数:"}),e.jsxs("div",{style:{marginTop:4,maxHeight:"40px",overflow:"hidden"},children:[Object.entries(s.best_parameters||{}).slice(0,3).map(([C,U])=>e.jsxs(Pe,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[C==="short_window"?"短期":C==="long_window"?"长期":C==="min_reversal_points"?"反转点":C==="lookback_period"?"回望期":C==="signal_strength_threshold"?"信号阈值":C==="batch_count"?"批次数":C==="stop_loss_ratio"?"止损":C==="take_profit_ratio"?"止盈":C,": ",typeof U=="number"?U.toFixed(1):String(U)]},C)),Object.keys(s.best_parameters||{}).length>3&&e.jsxs(Pe,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",Object.keys(s.best_parameters||{}).length-3,"个"]})]})]})]},s.job_id)})}),Me.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"40px 0",color:"#999"},children:"暂无优化结果"})]})]})},yn=o.memo(gn);var jn=Object.defineProperty,bn=Object.defineProperties,vn=Object.getOwnPropertyDescriptors,da=Object.getOwnPropertySymbols,_n=Object.prototype.hasOwnProperty,wn=Object.prototype.propertyIsEnumerable,ua=(n,r,l)=>r in n?jn(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,xs=(n,r)=>{for(var l in r||(r={}))_n.call(r,l)&&ua(n,l,r[l]);if(da)for(var l of da(r))wn.call(r,l)&&ua(n,l,r[l]);return n},Is=(n,r)=>bn(n,vn(r)),It=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});I.extend($a);I.extend(Ia);I.tz.setDefault("Asia/Shanghai");const{Title:Sn,Text:Qe}=Nt,{Option:Vt}=Ee,{TabPane:pa}=us,kn=()=>{const[n,r]=o.useState([]),[l,b]=o.useState(null),[f,_]=o.useState([]),[D,z]=o.useState([]),[j,k]=o.useState(!1),Y=o.useRef(!1),[Q]=T.useForm(),[V,$e]=o.useState(!1),[Te,ue]=o.useState(!1),[Z,pe]=o.useState(!1),[P,O]=o.useState(null),[x,Re]=o.useState(null),[Ie,ie]=o.useState(!1),[Ye,Xe]=o.useState([]),[ce,et]=o.useState(!1),[te,Oe]=o.useState([]),[je,rt]=o.useState({}),[zt,ct]=o.useState([]),[Ve,He]=o.useState(!1),Ce=o.useCallback(()=>{const t=n.find(A=>A.id===l),a=(t==null?void 0:t.name)||"策略优化",h=Q.getFieldsValue().symbol||"AAPL",M=I().format("YYYYMMDD");return`${h}_${M}_${a}`},[l,n,Q]),gt=o.useCallback(()=>{if(!Ve){const t=Ce();Q.setFieldValue("name",t)}},[Ve,Ce,Q]),wt=()=>It(void 0,null,function*(){try{const t=yield q.get("/api/strategies");t.data&&t.data.data&&r(t.data.data)}catch(t){console.error("加载策略列表失败:",t),d.error("加载策略列表失败")}}),dt=()=>It(void 0,null,function*(){try{const t=yield q.get("/api/data/stocks");if(t.data&&Array.isArray(t.data)){const a=t.data.map(u=>({symbol:u.symbol,name:u.name}));ct(a)}}catch(t){console.error("加载股票列表失败:",t),ct([{symbol:"AAPL",name:"Apple Inc."},{symbol:"TSLA",name:"Tesla Inc."},{symbol:"MSFT",name:"Microsoft Corporation"},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"AMZN",name:"Amazon.com Inc."}])}}),ft=t=>It(void 0,null,function*(){try{const a=yield q.get(`/api/data/stock/symbol/${t}/date-range`);if(a.data&&a.data.status==="success"){const{min_date:u,max_date:h}=a.data.data;rt({min_date:u,max_date:h}),u&&h&&Q.setFieldsValue({start_date:I(u),end_date:I(h)})}}catch(a){console.error("获取股票数据范围失败:",a)}}),Ke=t=>{const a=I();let u,h=a;switch(t){case"recent1y":u=a.subtract(1,"year");break;case"recent3y":u=a.subtract(3,"year");break;case"recent5y":u=a.subtract(5,"year");break;case"recent6y":u=a.subtract(6,"year");break;case"recent7y":u=a.subtract(7,"year");break;case"recent8y":u=a.subtract(8,"year");break;case"recent9y":u=a.subtract(9,"year");break;case"recent10y":u=a.subtract(10,"year");break;case"full":je.min_date&&je.max_date?(u=I(je.min_date),h=I(je.max_date)):u=a.subtract(5,"year");break;default:u=a.subtract(1,"year")}Q.setFieldsValue({start_date:u,end_date:h})},yt=t=>It(void 0,null,function*(){try{const a=yield q.get(`/api/optimization/strategies/${t}/parameter-spaces`);a.data&&a.data.status==="success"&&_(a.data.data)}catch(a){console.error("加载参数空间失败:",a)}}),tt=t=>It(void 0,null,function*(){var a;try{k(!0);const u=t?{strategy_id:t}:{},h=yield q.get("/api/optimization/jobs",{params:u});if(h.data&&h.data.status==="success"){const M=Array.isArray((a=h.data.data)==null?void 0:a.jobs)?h.data.data.jobs:[];z(M),d.success("刷新成功")}else z([]),d.warning("没有找到优化任务")}catch(u){console.error("加载优化任务失败:",u),z([]),d.error("加载优化任务失败")}finally{k(!1)}}),Ue=t=>{b(t),yt(t),tt(t)},S=()=>{_([...f,{parameter_name:"",parameter_type:"float",min_value:0,max_value:1,step_size:.1,description:""}])},g=t=>{_(f.filter((a,u)=>u!==t))},v=(t,a,u)=>{const h=[...f];h[t]=Is(xs({},h[t]),{[a]:u}),_(h)},H=t=>{if(!Array.isArray(t))return!1;const a=t.map(M=>typeof M=="string"?M.toLowerCase():M),u=a.includes(!0)||a.includes("true"),h=a.includes(!1)||a.includes("false");return a.length===2&&u&&h},re=()=>It(void 0,null,function*(){if(!l){d.error("请先选择策略");return}try{k(!0),yield q.post(`/api/optimization/strategies/${l}/parameter-spaces`,f),d.success("参数空间保存成功"),$e(!1)}catch(t){console.error("保存参数空间失败:",t),d.error("保存参数空间失败")}finally{k(!1)}}),J=()=>It(void 0,null,function*(){var t;if(!l){d.error("请先选择策略");return}try{k(!0);const a=yield q.get(`/api/optimization/strategies/${l}/parameter-spec`),u=((t=a==null?void 0:a.data)==null?void 0:t.data)||[];if(!Array.isArray(u)||u.length===0){d.warning("未识别到策略参数");return}const h=[];for(const R of u){const X=R==null?void 0:R.name,ne=R==null?void 0:R.type,w=R==null?void 0:R.default;if(!(!X||!ne))if(ne==="integer"){const fe=typeof w=="number"?w:typeof w=="string"?parseFloat(w):10;let be=Math.floor((isNaN(fe)?10:fe)*.5),le=Math.ceil((isNaN(fe)?10:fe)*1.5);be<1&&(be=1),le<=be&&(le=be+1),h.push({parameter_name:X,parameter_type:"int",min_value:be,max_value:le,step_size:1,description:"自动识别（±50%范围）"})}else if(ne==="float"){const fe=typeof w=="number"?w:typeof w=="string"?parseFloat(w):1,be=isNaN(fe)?1:fe;let le=be*.5,ze=be*1.5;ze<=le&&(ze=le+(Math.abs(be)||1));const E=Math.max(1e-4,Math.abs(be)*.1||.1);h.push({parameter_name:X,parameter_type:"float",min_value:Number(le.toFixed(6)),max_value:Number(ze.toFixed(6)),step_size:Number(E.toFixed(6)),description:"自动识别（±50%范围）"})}else if(ne==="boolean")h.push({parameter_name:X,parameter_type:"choice",choices:[!0,!1],description:"自动识别（布尔类型）"});else if(ne==="string")h.push({parameter_name:X,parameter_type:"choice",choices:typeof w<"u"?[w]:[],description:"自动识别（字符串类型，请手动设置备选项）"});else continue}if(h.length===0){d.warning("未识别到可优化的数值型参数");return}const M=new Map((f||[]).map(R=>[R.parameter_name,R])),A=h.map(R=>{const X=M.get(R.parameter_name);if(X){const ne=!!X.description&&String(X.description).trim().length>0;return Is(xs({},R),{description:ne?X.description:R.description})}return R});for(const[R,X]of M.entries())A.some(ne=>ne.parameter_name===R)||A.push(X);_(A),d.success(`已自动识别 ${h.length} 个参数，请完善范围后保存`)}catch(a){console.error("自动识别策略参数失败:",a),d.error("自动识别策略参数失败")}finally{k(!1)}}),Ne=t=>It(void 0,null,function*(){try{k(!0),O(t),console.log("🔍 开始获取试验列表:",t.name);const a=performance.now();try{console.log("📊 尝试获取轻量级试验摘要...");const A=yield q.get(`/api/optimization/jobs/${t.id}/trials-summary`),R=performance.now();if(console.log(`✅ 轻量级试验摘要耗时: ${(R-a).toFixed(0)}ms`),A.data&&A.data.status==="success"){console.log(`📊 获取到 ${A.data.data.length} 个试验摘要`),Xe(A.data.data),ie(!0);return}}catch(A){console.warn("⚠️ 轻量级摘要API失败，使用完整数据:",A)}console.log("📋 获取完整试验数据...");const u=performance.now(),h=yield q.get(`/api/optimization/jobs/${t.id}/trials`),M=performance.now();console.log(`📊 完整试验数据耗时: ${(M-u).toFixed(0)}ms`),h.data&&h.data.status==="success"?(console.log(`📊 获取到 ${h.data.data.length} 个完整试验结果`),Xe(h.data.data),ie(!0)):d.error("获取试验数据失败")}catch(a){console.error("获取试验数据失败:",a),d.error("获取试验数据失败")}finally{k(!1)}}),st=(t,a=!1)=>It(void 0,null,function*(){var u,h;try{if(t.status==="running"&&!a){d.error("运行中的任务不能删除，请先停止任务");return}const M=a?`/api/optimization/jobs/${t.id}?force=true`:`/api/optimization/jobs/${t.id}`,A=yield q.delete(M);A.data&&A.data.status==="success"?(d.success(A.data.message||"删除成功"),yield tt()):d.error("删除失败")}catch(M){console.error("删除优化任务失败:",M);const A=((h=(u=M.response)==null?void 0:u.data)==null?void 0:h.detail)||M.message||"删除失败";d.error(A)}}),Be=t=>It(void 0,null,function*(){try{k(!0),O(t),console.log("🚀 开始获取任务详情:",t.name);const a=performance.now();if(t.best_parameters&&t.status==="completed"&&t.optimization_config){try{console.log("📊 尝试获取轻量级性能指标...");const X=yield q.get(`/api/optimization/jobs/${t.id}/best-performance`);if(X.data&&X.data.status==="success"){const ne=performance.now();console.log(`✅ 使用轻量级API，耗时: ${(ne-a).toFixed(0)}ms`);const w=X.data.data,fe={total_return:w.total_return,annual_return:w.annual_return,sharpe_ratio:w.sharpe_ratio,max_drawdown:w.max_drawdown,win_rate:w.win_rate,profit_factor:w.profit_factor,alpha:w.alpha,beta:w.beta,total_trades:w.total_trades,parameters:w.parameters,fromOptimization:!0,isLightweight:!0};Re(fe),pe(!0),k(!1);return}}catch(X){console.warn("⚠️ 轻量级API失败，尝试完整数据:",X)}try{console.log("📊 尝试获取完整回测结果...");const X=yield q.get(`/api/optimization/jobs/${t.id}/trials`);if(X.data&&X.data.status==="success"&&X.data.data.length>0){const ne=X.data.data[0];if(ne.backtest_results){const w=performance.now();console.log(`✅ 使用完整缓存结果，耗时: ${(w-a).toFixed(0)}ms`);const fe=Is(xs({},ne.backtest_results),{fromOptimization:!0});Re(fe),pe(!0),k(!1);return}else console.warn("⚠️ 最佳试验没有缓存的回测结果")}}catch(X){console.warn("❌ 无法获取优化试验数据，将重新运行回测:",X)}console.log("🔄 缓存未命中，重新运行回测...");const u=performance.now(),h=t.optimization_config.backtest_config,M={strategy_id:t.strategy_id,parameters:t.best_parameters,symbol:h.symbol,start_date:h.start_date,end_date:h.end_date,initial_capital:h.initial_capital};console.log("📋 回测请求参数:",M);const A=yield q.post("/api/strategies/backtest",M),R=performance.now();console.log(`⏱️ 重新回测耗时: ${(R-u).toFixed(0)}ms`),A.data&&A.data.status==="success"?Re(A.data.data):(console.error("回测失败:",A.data),d.error("回测失败，无法获取详细结果"))}else t.status==="completed"&&d.warning("优化配置信息不完整，无法重现回测结果");pe(!0)}catch(a){console.error("获取任务详情失败:",a),d.error("获取任务详情失败")}finally{k(!1)}}),Ge=t=>It(void 0,null,function*(){if(!l){d.error("请先选择策略");return}if(f.length===0){d.error("请先配置参数空间");return}try{k(!0);const a={strategy_id:l,name:t.name,description:t.description,parameter_spaces:f,objective_function:t.objective_function,n_trials:t.n_trials,timeout:t.timeout,backtest_config:{symbol:t.symbol,start_date:t.start_date.format("YYYY-MM-DD"),end_date:t.end_date.format("YYYY-MM-DD"),initial_capital:t.initial_capital}};yield q.post("/api/optimization/optimize",a),d.success("优化任务已启动"),ue(!1),Q.resetFields(),tt(l)}catch(a){console.error("启动优化任务失败:",a),d.error("启动优化任务失败")}finally{k(!1)}}),nt=t=>It(void 0,null,function*(){try{if(k(!0),t.backtest_results&&t.backtest_results.logs&&t.backtest_results.logs.length>0){console.log("📋 使用当前记录中的日志"),Oe(t.backtest_results.logs),et(!0);return}console.log("🔍 获取完整试验数据以获取日志...");const a=yield q.get(`/api/optimization/jobs/${P==null?void 0:P.id}/trials`);if(a.data&&a.data.status==="success"){const h=a.data.data.find(M=>M.trial_number===t.trial_number||M.id===t.id||M.parameters&&t.parameters&&JSON.stringify(M.parameters)===JSON.stringify(t.parameters));h&&h.backtest_results&&h.backtest_results.logs?(console.log(`📋 找到完整试验数据，日志条数: ${h.backtest_results.logs.length}`),Oe(h.backtest_results.logs),et(!0)):d.warning("该试验暂无日志数据")}else d.error("获取试验日志失败")}catch(a){console.error("获取试验日志失败:",a),d.error("获取试验日志失败")}finally{k(!1)}}),Me=[{title:"ID",dataIndex:"id",key:"id",width:50,align:"center"},{title:"任务名称",dataIndex:"name",key:"name",width:160,ellipsis:!0},{title:"策略",dataIndex:"strategy_id",key:"strategy",width:120,ellipsis:{showTitle:!1},render:t=>{const a=n.find(u=>u.id===t);return a?e.jsx(Se,{title:a.name,placement:"topLeft",children:e.jsx(Pe,{color:"blue",style:{margin:0,maxWidth:"100px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"inline-block",cursor:"pointer"},children:a.name})}):e.jsx(Qe,{type:"secondary",style:{fontSize:"12px"},children:"未知策略"})}},{title:"状态",dataIndex:"status",key:"status",width:70,align:"center",render:t=>{const u={running:{color:"processing",text:"运行中"},completed:{color:"success",text:"已完成"},failed:{color:"error",text:"失败"},cancelled:{color:"default",text:"已取消"}}[t]||{color:"default",text:t};return e.jsx(Pe,{color:u.color,children:u.text})}},{title:"进度",dataIndex:"progress",key:"progress",width:90,render:(t,a)=>{const u=`${a.completed_trials}/${a.total_trials}`,h=`${t.toFixed(1)}%`;return e.jsx(Se,{title:e.jsxs("div",{children:[e.jsxs("div",{children:["已完成试验: ",a.completed_trials]}),e.jsxs("div",{children:["总试验数: ",a.total_trials]}),e.jsxs("div",{children:["完成进度: ",t.toFixed(1),"%"]})]}),placement:"topLeft",children:e.jsxs("div",{style:{width:"80px",textAlign:"center"},children:[e.jsx(pr,{percent:t,size:"small",style:{marginBottom:"1px"},showInfo:!1}),e.jsxs("div",{style:{fontSize:"10px",color:"#666",lineHeight:"1.2"},children:[u," (",h,")"]})]})})}},{title:"最佳得分",dataIndex:"best_score",key:"best_score",width:100,align:"center",render:(t,a)=>{if(!t)return"-";const h={sharpe_ratio:"夏普比率",total_return:"总收益率",annual_return:"年化收益率"}[a.objective_function]||"得分";return e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",color:"#1890ff"},children:t.toFixed(4)}),e.jsx(Qe,{type:"secondary",style:{fontSize:"11px"},children:h})]})}},{title:"交易配置",dataIndex:"optimization_config",key:"trading_config",width:110,align:"center",render:t=>{if(!t||!t.backtest_config)return"-";const{symbol:a,initial_capital:u}=t.backtest_config;return e.jsxs("div",{children:[e.jsx(Pe,{color:"green",style:{marginBottom:"2px"},children:a}),e.jsxs("div",{style:{fontSize:"11px",color:"#666"},children:["¥",(u==null?void 0:u.toLocaleString())||"N/A"]})]})}},{title:"回测时间段",dataIndex:"optimization_config",key:"date_range",width:140,render:t=>{if(!t||!t.backtest_config)return"-";const{start_date:a,end_date:u}=t.backtest_config;return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a}),e.jsx("div",{style:{fontSize:"10px",color:"#999",margin:"2px 0"},children:"至"}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:u})]})}},{title:"最佳参数",dataIndex:"best_parameters",key:"best_parameters",width:200,render:t=>{if(!t)return"-";const a=Object.entries(t),u=3,h=a.slice(0,u),M=a.length-u;return e.jsxs("div",{style:{maxHeight:"60px",overflow:"hidden"},children:[h.map(([A,R])=>e.jsxs(Pe,{color:"blue",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[A==="short_window"?"短期":A==="long_window"?"长期":A==="min_reversal_points"?"反转点":A==="lookback_period"?"回望期":A==="signal_strength_threshold"?"信号阈值":A==="batch_count"?"批次数":A==="stop_loss_ratio"?"止损":A==="take_profit_ratio"?"止盈":A,": ",typeof R=="number"?R.toFixed(2):R]},A)),M>0&&e.jsxs(Pe,{color:"default",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",M,"个"]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:140,render:t=>{const a=I.utc(t).tz("Asia/Shanghai");return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px"},children:a.format("YYYY-MM-DD")}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a.format("HH:mm:ss")})]})}},{title:"操作",key:"action",width:100,align:"center",render:(t,a)=>{const u=I.utc(a.created_at).tz("Asia/Shanghai"),h=a.status==="running"&&I().diff(u,"hour")>=1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx(L,{type:"link",icon:e.jsx(qs,{}),onClick:()=>Be(a),size:"small",disabled:a.status!=="completed",style:{padding:"2px 8px",height:"auto",fontSize:"12px"},children:"查看回测"}),e.jsx(L,{type:"link",onClick:()=>Ne(a),size:"small",disabled:a.status!=="completed",style:{color:"#1890ff",padding:"2px 8px",height:"auto",fontSize:"12px"},children:"其他回测"}),e.jsx(hr,{title:"确认删除",description:h?`检测到异常状态，确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`:`确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`,onConfirm:()=>st(a,h),okText:"确定",cancelText:"取消",disabled:a.status==="running"&&!h,placement:"top",children:e.jsx(L,{danger:!0,size:"small",disabled:a.status==="running"&&!h,icon:e.jsx(ns,{}),style:xs({padding:"2px 8px",height:"auto",fontSize:"12px"},h&&{borderColor:"#ff7875",color:"#ff7875"}),children:h?"强制删除":"删除"})})]})}}];return o.useEffect(()=>{Y.current||(Y.current=!0,wt(),tt(),dt(),ft("AAPL"))},[]),e.jsxs("div",{style:{padding:"16px",height:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs(oe,{style:{marginBottom:"16px",flexShrink:0},children:[e.jsx(Sn,{level:3,style:{margin:"0 0 16px 0"},children:"策略参数优化"}),e.jsxs(G,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(y,{span:8,children:e.jsx(Ee,{placeholder:"选择策略",style:{width:"100%"},value:l,onChange:Ue,children:n.map(t=>e.jsx(Vt,{value:t.id,children:t.name},t.id))})}),e.jsx(y,{span:16,children:e.jsxs(De,{children:[e.jsx(L,{icon:e.jsx(js,{}),onClick:()=>$e(!0),disabled:!l,children:"配置参数空间"}),e.jsx(L,{type:"primary",icon:e.jsx(Ut,{}),onClick:()=>{ue(!0),He(!1),setTimeout(()=>gt(),100)},disabled:!l||f.length===0,children:"启动优化"}),e.jsx(L,{icon:e.jsx(Bs,{}),onClick:()=>{console.log("刷新按钮被点击"),tt(l||void 0)},children:"刷新"})]})})]})]}),e.jsx(oe,{title:"优化任务列表",style:{flex:1,display:"flex",flexDirection:"column",minHeight:0},styles:{body:{flex:1,padding:"16px",display:"flex",flexDirection:"column",minHeight:0}},children:e.jsx(Gt,{columns:Me,dataSource:D,rowKey:"id",loading:j,size:"small",scroll:{x:1200,y:"calc(100vh - 320px)"},pagination:{pageSize:it.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条记录`,size:"small",onChange:(t,a)=>{it.setCurrentPage(t),it.setPageSize(a||20)},onShowSizeChange:(t,a)=>{it.setPageSize(a)}},style:{flex:1}})}),e.jsxs(Fe,{title:"配置参数空间",open:V,onOk:re,onCancel:()=>$e(!1),width:900,confirmLoading:j,children:[e.jsx(xt,{message:"MA交叉策略参数优化指南",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"short_window"}),": 短期移动平均线周期，建议范围 3-15天"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"long_window"}),": 长期移动平均线周期，建议范围 10-60天"]}),e.jsx("p",{children:"注意：短期周期必须小于长期周期"})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(L,{type:"dashed",onClick:S,icon:e.jsx(Ma,{}),block:!0,children:"添加参数"})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsxs(De,{children:[e.jsx(L,{type:"link",onClick:()=>{_([{parameter_name:"short_window",parameter_type:"int",min_value:3,max_value:15,step_size:1,description:"短期移动平均线周期"},{parameter_name:"long_window",parameter_type:"int",min_value:10,max_value:60,step_size:5,description:"长期移动平均线周期"}])},children:"📊 使用MA策略推荐配置"}),e.jsx(L,{type:"link",onClick:J,children:"🔎 自动识别策略参数"})]})}),f.map((t,a)=>e.jsx(oe,{size:"small",style:{marginBottom:"8px"},children:e.jsxs(G,{gutter:[8,8],children:[e.jsx(y,{span:4,children:e.jsx(ke,{placeholder:"参数名",value:t.parameter_name,onChange:u=>v(a,"parameter_name",u.target.value)})}),e.jsx(y,{span:3,children:e.jsxs(Ee,{value:t.parameter_type==="choice"&&H(t.choices)?"boolean":t.parameter_type,onChange:u=>{const h=String(u);h==="boolean"?(v(a,"parameter_type","choice"),v(a,"choices",[!0,!1]),t.description||v(a,"description","布尔类型")):v(a,"parameter_type",h)},style:{width:"100%"},children:[e.jsx(Vt,{value:"int",children:"整数"}),e.jsx(Vt,{value:"float",children:"小数"}),e.jsx(Vt,{value:"choice",children:"选择"}),e.jsx(Vt,{value:"boolean",children:"布尔"})]})}),t.parameter_type!=="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(y,{span:3,children:e.jsx(Et,{placeholder:"最小值",value:t.min_value,onChange:u=>v(a,"min_value",u),style:{width:"100%"}})}),e.jsx(y,{span:3,children:e.jsx(Et,{placeholder:"最大值",value:t.max_value,onChange:u=>v(a,"max_value",u),style:{width:"100%"}})})]}),t.parameter_type==="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(y,{span:6,children:e.jsx(Ee,{mode:"tags",style:{width:"100%"},placeholder:"备选项（输入后回车添加）",value:(t.choices||[]).map(u=>typeof u=="boolean"?u?"true":"false":String(u)),onChange:u=>{const h=u.map(M=>{if(typeof M=="string"){const A=M.trim();if(A.toLowerCase()==="true")return!0;if(A.toLowerCase()==="false")return!1;const R=Number(A);return isNaN(R)?A:R}return M});v(a,"choices",h)}})}),e.jsx(y,{span:3,children:e.jsx(L,{onClick:()=>v(a,"choices",[!0,!1]),style:{width:"100%"},children:"填充布尔(True/False)"})})]}),e.jsx(y,{span:4,children:e.jsx(ke,{placeholder:"描述",value:t.description,onChange:u=>v(a,"description",u.target.value)})}),e.jsx(y,{span:2,children:e.jsx(L,{type:"text",danger:!0,icon:e.jsx(ns,{}),onClick:()=>g(a)})})]})},a))]}),e.jsxs(Fe,{title:"启动参数优化",open:Te,onOk:()=>Q.submit(),onCancel:()=>ue(!1),width:700,confirmLoading:j,children:[e.jsx(xt,{message:"优化说明",description:"系统将自动测试不同参数组合，找到最优的策略参数。建议先用较少试验次数快速测试。",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(T,{form:Q,onFinish:Ge,layout:"vertical",children:[e.jsx(T.Item,{name:"name",label:"任务名称",rules:[{required:!0,message:"请输入任务名称"}],children:e.jsx(ke,{placeholder:"如: AAPL_20240101_MA策略优化",onChange:t=>{t.target.value!==Ce()?He(!0):He(!1)}})}),e.jsx(T.Item,{name:"description",label:"任务描述",children:e.jsx(ke.TextArea,{placeholder:"描述此次优化的目的和预期...",rows:2})}),e.jsxs(G,{gutter:[16,16],children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"objective_function",label:"优化目标",initialValue:"sharpe_ratio",children:e.jsxs(Ee,{children:[e.jsx(Vt,{value:"sharpe_ratio",children:"夏普比率 (推荐)"}),e.jsx(Vt,{value:"total_return",children:"总收益率"}),e.jsx(Vt,{value:"annual_return",children:"年化收益率"})]})})}),e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"n_trials",label:"试验次数",initialValue:50,extra:"建议: 快速测试50次，详细优化100-200次",children:e.jsx(Et,{min:10,max:1e3,style:{width:"100%"}})})})]}),e.jsxs(G,{gutter:[16,16],children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"symbol",label:"交易品种",rules:[{required:!0,message:"请选择交易品种"}],initialValue:"AAPL",children:e.jsx(Ee,{placeholder:"选择股票代码",showSearch:!0,filterOption:(t,a)=>{var u,h;return((u=a==null?void 0:a.label)!=null?u:"").toLowerCase().includes(t.toLowerCase())||((h=a==null?void 0:a.value)!=null?h:"").toLowerCase().includes(t.toLowerCase())},onChange:t=>{t&&(ft(t),gt())},options:zt.map(t=>({value:t.symbol,label:`${t.symbol} - ${t.name}`}))})})}),e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"initial_capital",label:"初始资金",initialValue:1e5,children:e.jsx(Et,{min:1e3,style:{width:"100%"},formatter:t=>`¥ ${t}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:t=>t==null?void 0:t.replace(/¥\s?|(,*)/g,"")})})})]}),e.jsx(T.Item,{label:"快捷时间选择",children:e.jsxs(De,{wrap:!0,children:[e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent1y"),children:"最近1年"}),e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent3y"),children:"最近3年"}),e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent5y"),children:"最近5年"}),e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent6y"),children:"最近6年"}),e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent7y"),children:"最近7年"}),e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent8y"),children:"最近8年"}),e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent9y"),children:"最近9年"}),e.jsx(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("recent10y"),children:"最近10年"}),je.min_date&&je.max_date&&e.jsxs(L,{size:"small",icon:e.jsx(Yt,{}),onClick:()=>Ke("full"),type:"primary",children:["全部数据 (",je.min_date," ~ ",je.max_date,")"]})]})}),e.jsxs(G,{gutter:[16,16],children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"start_date",label:"开始日期",rules:[{required:!0,message:"请选择开始日期"}],initialValue:I("2023-01-01"),children:e.jsx(Wt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择开始日期"})})}),e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"end_date",label:"结束日期",rules:[{required:!0,message:"请选择结束日期"}],initialValue:I("2024-12-31"),children:e.jsx(Wt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择结束日期"})})})]}),e.jsx(xt,{message:"注意事项",description:e.jsxs("ul",{style:{margin:0,paddingLeft:"20px"},children:[e.jsx("li",{children:"确保已配置参数空间"}),e.jsx("li",{children:"优化过程可能需要几分钟到几小时"}),e.jsx("li",{children:"可以在任务列表中查看进度"})]}),type:"warning",showIcon:!0})]})]}),e.jsx(Fe,{title:"优化任务详情",open:Z,onCancel:()=>{pe(!1),O(null),Re(null)},footer:null,width:1e3,children:P&&e.jsxs("div",{children:[e.jsx(xt,{message:`任务状态: ${P.status==="completed"?"已完成":P.status}`,type:P.status==="completed"?"success":"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(us,{defaultActiveKey:"1",children:[e.jsxs(pa,{tab:"基本信息",children:[e.jsxs(G,{gutter:[16,16],children:[e.jsxs(y,{span:12,children:[e.jsx(Qe,{strong:!0,children:"任务名称: "}),e.jsx(Qe,{children:P.name})]}),e.jsxs(y,{span:12,children:[e.jsx(Qe,{strong:!0,children:"优化目标: "}),e.jsx(Qe,{children:P.objective_function==="sharpe_ratio"?"夏普比率":P.objective_function==="total_return"?"总收益率":P.objective_function==="annual_return"?"年化收益率":"未知"})]}),e.jsxs(y,{span:12,children:[e.jsx(Qe,{strong:!0,children:"试验次数: "}),e.jsxs(Qe,{children:[P.completed_trials,"/",P.total_trials]})]}),e.jsxs(y,{span:12,children:[e.jsx(Qe,{strong:!0,children:"最佳得分: "}),e.jsx(Qe,{children:P.best_score?P.best_score.toFixed(4):"-"})]})]}),P.optimization_config&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Qe,{strong:!0,children:"回测配置:"}),e.jsxs(G,{gutter:[16,8],style:{marginTop:"8px"},children:[e.jsxs(y,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"交易品种: "}),e.jsx(Pe,{color:"green",children:P.optimization_config.backtest_config.symbol})]}),e.jsxs(y,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"初始资金: "}),e.jsxs(Pe,{color:"blue",children:["¥",P.optimization_config.backtest_config.initial_capital.toLocaleString()]})]}),e.jsxs(y,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"开始日期: "}),e.jsx(Pe,{children:P.optimization_config.backtest_config.start_date})]}),e.jsxs(y,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"结束日期: "}),e.jsx(Pe,{children:P.optimization_config.backtest_config.end_date})]})]})]}),P.best_parameters&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Qe,{strong:!0,children:"最优参数组合:"}),e.jsx("div",{style:{marginTop:"8px",maxHeight:"120px",overflowY:"auto"},children:Object.entries(P.best_parameters).map(([t,a])=>e.jsxs(Pe,{color:"blue",style:{marginBottom:"4px",marginRight:"4px",fontSize:"11px",padding:"2px 6px"},children:[t==="short_window"?"短期均线":t==="long_window"?"长期均线":t==="min_reversal_points"?"反转点数":t==="lookback_period"?"回望周期":t==="min_price_change"?"最小价格变化":t==="signal_strength_threshold"?"信号强度阈值":t==="max_trading_range"?"最大交易范围":t==="batch_count"?"分批次数":t==="batch_interval"?"分批间隔":t==="position_size_per_batch"?"分批仓位":t==="stop_loss_ratio"?"止损比例":t==="take_profit_ratio"?"止盈比例":t==="rsi_oversold"?"RSI超卖":t==="rsi_overbought"?"RSI超买":t==="volume_threshold"?"成交量阈值":t==="max_extremums"?"最大极值点":t==="min_extremum_distance"?"极值点距离":t,": ",typeof a=="number"?a.toFixed(2):a]},t))})]})]},"1"),e.jsx(pa,{tab:"回测结果",children:x?e.jsxs("div",{children:[e.jsxs(G,{gutter:[16,16],children:[e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"总收益率",value:x.total_return*100,precision:2,suffix:"%",valueStyle:{color:x.total_return>=0?"#3f8600":"#cf1322"}})})}),e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"年化收益率",value:x.annual_return*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"最大回撤",value:x.max_drawdown*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"夏普比率",value:x.sharpe_ratio,precision:3,valueStyle:{color:x.sharpe_ratio>=1?"#3f8600":"#cf1322"}})})})]}),e.jsxs(G,{gutter:[16,16],style:{marginTop:"16px"},children:[e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"胜率",value:x.win_rate*100,precision:2,suffix:"%",valueStyle:{color:x.win_rate>=.5?"#3f8600":"#cf1322"}})})}),e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"盈亏比",value:x.profit_factor,precision:2,valueStyle:{color:x.profit_factor>=1?"#3f8600":"#cf1322"}})})}),e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"交易次数",value:x.trades?x.trades.length:0,valueStyle:{color:"#1890ff"}})})}),e.jsx(y,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(ge,{title:"Alpha",value:x.alpha,precision:4,valueStyle:{color:x.alpha>=0?"#3f8600":"#cf1322"}})})})]}),e.jsx(xt,{message:"参数说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"夏普比率"}),": 风险调整后收益，",">"," 1.0为优秀，",">"," 2.0为卓越"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"胜率"}),": 盈利交易占总交易的比例，",">"," 50%为良好"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏比"}),": 平均盈利/平均亏损，",">"," 1.0表示盈利大于亏损"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Alpha"}),": 相对于市场的超额收益，",">"," 0表示跑赢市场"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]}):e.jsx("div",{style:{textAlign:"center",padding:"40px"},children:e.jsx(Qe,{type:"secondary",children:"加载回测结果中..."})})},"2")]})]})}),e.jsx(Fe,{title:"所有回测试验结果",open:Ie,onCancel:()=>{ie(!1),Xe([]),O(null)},footer:null,width:1e3,children:P&&e.jsxs("div",{children:[e.jsx(xt,{message:`任务: ${P.name} - 共${Ye.length}个试验，按得分降序排列`,type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx(Gt,{dataSource:Ye,rowKey:t=>t.id||t.trial_number||Math.random(),pagination:!1,size:"small",scroll:{y:400},columns:[{title:"排名",key:"rank",width:60,render:(t,a,u)=>{const h=a.rank||u+1;return e.jsx(Pe,{color:h===1?"gold":h===2?"silver":h===3?"orange":"default",children:h})}},{title:"得分",dataIndex:"objective_value",key:"objective_value",width:100,render:t=>e.jsx(Qe,{strong:!0,style:{color:"#1890ff"},children:t?t.toFixed(4):"-"}),sorter:(t,a)=>(t.objective_value||0)-(a.objective_value||0),defaultSortOrder:"descend"},{title:"参数组合",dataIndex:"parameters",key:"parameters",width:200,render:t=>e.jsx("div",{children:Object.entries(t||{}).map(([a,u])=>e.jsxs(Pe,{color:"blue",style:{marginBottom:"2px"},children:[a==="short_window"?"短期":a==="long_window"?"长期":a,": ",u]},a))})},{title:"年化收益",dataIndex:"annual_return",key:"annual_return",width:90,render:t=>{if(t==null)return"-";const a=t>=0?"#3f8600":"#cf1322";return e.jsxs(Qe,{style:{color:a,fontWeight:"bold"},children:[(t*100).toFixed(1),"%"]})}},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",width:90,render:t=>t==null?"-":e.jsxs(Qe,{style:{color:"#3f8600",fontWeight:"bold"},children:[(Math.abs(t)*100).toFixed(1),"%"]})},{title:"交易次数",dataIndex:"total_trades",key:"total_trades",width:80,render:t=>e.jsx(Qe,{type:"secondary",children:t||0})},{title:"执行时间",dataIndex:"execution_time",key:"execution_time",width:80,render:t=>e.jsx(Qe,{type:"secondary",children:t?`${(t*1e3).toFixed(0)}ms`:"-"})},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:150,render:t=>t?I.utc(t).tz("Asia/Shanghai").format("HH:mm:ss"):"-"},{title:"日志",key:"logs",width:80,render:(t,a)=>e.jsx(Se,{title:"查看日志",children:e.jsx(L,{type:"text",size:"small",icon:e.jsx(Ms,{}),onClick:()=>nt(a),style:{color:"#1890ff"}})})}]}),e.jsx(xt,{message:"说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"排名"}),": 按优化目标得分排序，金牌为最佳结果"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"得分"}),": ",P.objective_function==="sharpe_ratio"?"夏普比率":P.objective_function==="total_return"?"总收益率":P.objective_function==="annual_return"?"年化收益率":"优化目标","得分"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"参数组合"}),": 该试验使用的策略参数"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]})}),e.jsx(Fe,{title:"试验日志",open:ce,onCancel:()=>et(!1),footer:null,width:800,style:{top:20},children:e.jsx("div",{style:{maxHeight:"600px",overflow:"auto"},children:te&&te.length>0?e.jsx("div",{style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px"},children:te.map((t,a)=>{var u;const h=M=>{switch(M==null?void 0:M.toUpperCase()){case"ERROR":return"#ff4d4f";case"WARNING":return"#faad14";case"DEBUG":return"#722ed1";case"INFO":default:return"#1890ff"}};return e.jsxs("div",{style:{marginBottom:"4px",padding:"2px 4px",backgroundColor:"#f5f5f5",borderRadius:"2px"},children:[e.jsx("span",{style:{color:"#666",marginRight:"8px"},children:t.timestamp?I(t.timestamp).format("HH:mm:ss.SSS"):""}),e.jsxs("span",{style:{color:h(t.level),fontWeight:"bold",marginRight:"8px",minWidth:"60px",display:"inline-block"},children:["[",((u=t.level)==null?void 0:u.toUpperCase())||"INFO","]"]}),e.jsx("span",{style:{color:"#333"},children:t.message})]},a)})}):e.jsx("div",{style:{textAlign:"center",padding:"40px",color:"#999"},children:"暂无日志数据"})})})]})},$n=o.memo(kn);var In=Object.defineProperty,Cn=Object.defineProperties,Dn=Object.getOwnPropertyDescriptors,ha=Object.getOwnPropertySymbols,zn=Object.prototype.hasOwnProperty,Mn=Object.prototype.propertyIsEnumerable,ma=(n,r,l)=>r in n?In(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,An=(n,r)=>{for(var l in r||(r={}))zn.call(r,l)&&ma(n,l,r[l]);if(ha)for(var l of ha(r))Mn.call(r,l)&&ma(n,l,r[l]);return n},Ln=(n,r)=>Cn(n,Dn(r)),vt=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});const{RangePicker:Pn}=Wt,{Option:ot}=Ee,{Text:_t}=Nt,Fn={deepseek:"#3b7ddd",qwen:"#52c41a",kimi:"#faad14"},fa=["#3b7ddd","#52c41a","#fa8c16","#13c2c2","#eb2f96"],xa=["你是一个专注于股票量化交易的金融大模型，充当价格预测引擎。","","你的任务是根据输入的K线数据、账户状态和最近成交记录，预测下一根K线的收盘价，并用一句话说明主要原因。","","要求：","1）第一部分输出一个数字作为预测收盘价；","2）第二部分用一句话总结主要原因，可以与数字在同一行，用逗号分隔；","3）数字应为合理的价格水平，不为负数，尽量接近当前价格量级；","4）可以保留2到6位小数；","5）充分利用给出的周期、买入/卖出阈值、止损和止盈参数来判断趋势和风险；","6）只使用输入的数据进行推断，不要编造外部信息或新闻；","7）如果历史数据较少，也要给出尽可能稳健的预测，而不是报错。"].join(`
`),On=()=>{var n,r,l;const[b]=T.useForm(),[f,_]=o.useState([]),[D,z]=o.useState(!1),[j,k]=o.useState(!1),[Y,Q]=o.useState(null),[V,$e]=o.useState([]),[Te,ue]=o.useState(!1),[Z,pe]=o.useState({}),[P,O]=o.useState({}),[x,Re]=o.useState([]),[Ie,ie]=o.useState([]),[Ye,Xe]=o.useState(!1),[ce,et]=o.useState("deepseek"),[te,Oe]=o.useState(""),[je,rt]=o.useState(!1),[zt,ct]=o.useState(!1),[Ve,He]=o.useState(!1),[Ce,gt]=o.useState(null),[wt,dt]=o.useState([]),[ft,Ke]=o.useState(!1),[yt,tt]=o.useState(1),[Ue,S]=o.useState(50),[g,v]=o.useState(0),[H,re]=o.useState(),[J,Ne]=o.useState(),[st,Be]=o.useState(""),[Ge,nt]=o.useState(),[Me,t]=o.useState(null),[a,u]=o.useState(!1),[h,M]=o.useState(""),[A,R]=o.useState(null),X=T.useWatch("data_source",b)||"database",ne=o.useMemo(()=>X==="database"?[{value:"1d",label:"日线"}]:[{value:"1m",label:"1分钟"},{value:"5m",label:"5分钟"},{value:"15m",label:"15分钟"},{value:"30m",label:"30分钟"},{value:"60m",label:"60分钟"}],[X]),w=o.useMemo(()=>{const p=new Set;return Object.keys(Z||{}).forEach($=>p.add($)),Object.keys(P||{}).forEach($=>p.add($)),V.forEach($=>p.add($.model_type)),Array.from(p)},[Z,P,V]),fe=p=>{const $=w.indexOf(p);return Fn[p]||fa[($>=0?$:0)%fa.length]},be=()=>vt(void 0,null,function*(){z(!0);try{const $=(yield q.get("/api/ai-investment/runs")).data||[];return _($),$}catch(p){d.error((p==null?void 0:p.message)||"获取AI投资运行列表失败")}finally{z(!1)}}),le=p=>vt(void 0,null,function*(){ue(!0);try{const F=(yield q.get(`/api/ai-investment/run/${p}/records`)).data||[];return $e(F),F}catch($){d.error(($==null?void 0:$.message)||"获取AI投资预测明细失败")}finally{ue(!1)}}),ze=p=>vt(void 0,null,function*(){yield le(p.id)}),E=(p,...$)=>vt(void 0,[p,...$],function*(F,ye=yt,Ae=Ue,se){var ae,ve,at;Ke(!0);try{const Le={page:ye,size:Ae},jt=(ae=se==null?void 0:se.level)!=null?ae:H,Pt=(ve=se==null?void 0:se.category)!=null?ve:J,s=(at=se==null?void 0:se.keyword)!=null?at:st,c=(se==null?void 0:se.recordId)!==void 0?se.recordId:Ge;jt&&(Le.level=jt),Pt&&(Le.category=Pt),s&&(Le.keyword=s),c!==void 0&&(Le.record_id=c);const m=yield q.get(`/api/ai-investment/run/${F}/logs`,{params:Le});dt(m.data.items||[]),v(m.data.total||0),tt(ye),S(Ae),(se==null?void 0:se.level)!==void 0&&re(se.level),(se==null?void 0:se.category)!==void 0&&Ne(se.category),(se==null?void 0:se.keyword)!==void 0&&Be(se.keyword||""),(se==null?void 0:se.recordId)!==void 0&&nt(se.recordId)}catch(Le){d.error((Le==null?void 0:Le.message)||"获取运行日志失败")}finally{Ke(!1)}}),ee=p=>vt(void 0,null,function*(){rt(!0);try{const F=(yield q.get("/api/ai-investment/prompt-settings",{params:{model_type:p}})).data||[];F.length>0?Oe(F[0].system_prompt||""):Oe(xa)}catch($){d.error(($==null?void 0:$.message)||"加载AI提示词失败"),Oe(xa)}finally{rt(!1)}});o.useEffect(()=>{be(),ee(ce),(()=>vt(void 0,null,function*(){Xe(!0);try{const $=yield bs();ie($)}catch{}finally{Xe(!1)}}))()},[]),o.useEffect(()=>{b.getFieldValue("frequency")||(X==="database"?b.setFieldsValue({frequency:"1d"}):b.setFieldsValue({frequency:"1m"}))},[X,b]),o.useEffect(()=>{ee(ce)},[ce]);const qe=()=>vt(void 0,null,function*(){var p,$,F,ye,Ae,se,ae;try{const ve=yield b.validateFields(),at=ve.symbol,Le=ve.timeRange,jt=ve.models||[];if(!at||!Le||jt.length===0){d.warning("请填写股票代码、时间范围并选择至少一个模型");return}const Pt=Le[0].toDate().toISOString(),s=Le[1].toDate().toISOString(),c=ve.data_source||"database",m=ve.frequency||(c==="database"?"1d":"1m"),C={name:ve.name||void 0,symbol:at,start_time:Pt,end_time:s,data_source:c,frequency:m,models:jt,initial_capital:ve.initial_capital||1e5,buy_threshold:(p=ve.buy_threshold)!=null?p:.002,sell_threshold:($=ve.sell_threshold)!=null?$:-.002,stop_loss_pct:(F=ve.stop_loss_pct)!=null?F:.05,take_profit_pct:(ye=ve.take_profit_pct)!=null?ye:.1,window:ve.window||20,commission_rate:(Ae=ve.commission_rate)!=null?Ae:.0015,slippage_rate:(se=ve.slippage_rate)!=null?se:.001};k(!0);const U=yield q.post("/api/ai-investment/run",C);if(U.data&&U.data.status==="success"){d.success("AI实时投资回放完成");const de=U.data;pe(de.metrics||{}),O(de.equity_curves||{}),Re(de.price_series||[]);const i=yield be();if(de.run_id&&(yield le(de.run_id),i&&Array.isArray(i))){const N=i.find(he=>he.id===de.run_id)||null;Q(N)}}else d.error(((ae=U.data)==null?void 0:ae.message)||"AI投资回放失败")}catch(ve){if(ve!=null&&ve.errorFields)return;d.error((ve==null?void 0:ve.message)||"AI投资回放执行失败")}finally{k(!1)}}),Ze=()=>vt(void 0,null,function*(){var p,$,F,ye,Ae,se;try{const ae=yield b.validateFields(["symbol","timeRange","data_source","frequency","models","initial_capital","buy_threshold","sell_threshold","stop_loss_pct","take_profit_pct","window"]),ve=ae.symbol,at=ae.timeRange,Le=ae.models||[];if(!ve||!at||Le.length===0){d.warning("请先填写股票代码、时间范围并选择至少一个模型");return}const jt=at[0].toDate().toISOString(),Pt=at[1].toDate().toISOString(),s=ae.data_source||"database",c=ae.frequency||(s==="database"?"1d":"1m"),m={name:ae.name||void 0,symbol:ve,start_time:jt,end_time:Pt,data_source:s,frequency:c,models:Le,initial_capital:ae.initial_capital||1e5,buy_threshold:(p=ae.buy_threshold)!=null?p:.002,sell_threshold:($=ae.sell_threshold)!=null?$:-.002,stop_loss_pct:(F=ae.stop_loss_pct)!=null?F:.05,take_profit_pct:(ye=ae.take_profit_pct)!=null?ye:.1,window:ae.window||20,commission_rate:(Ae=ae.commission_rate)!=null?Ae:.0015,slippage_rate:(se=ae.slippage_rate)!=null?se:.001};u(!0);const U=(yield q.post("/api/ai-investment/estimate-calls",m)).data,de=`${U.formula} = ${U.per_model_calls}`,i=`当前选择 ${U.model_count} 个模型，理论最大AI调用次数约为 ${U.total_calls} 次。`;M(`调用次数估算公式：${de}。${i}`)}catch(ae){if(ae!=null&&ae.errorFields)return;d.error((ae==null?void 0:ae.message)||"预估AI调用次数失败")}finally{u(!1)}}),ut=()=>vt(void 0,null,function*(){if(!ce){d.warning("请选择需要配置提示词的模型");return}if(!te||!te.trim()){d.warning("请输入系统提示词内容");return}ct(!0);try{yield q.post("/api/ai-investment/prompt-settings",{model_type:ce,scene:"ai_investment",system_prompt:te}),d.success("提示词已保存")}catch(p){d.error((p==null?void 0:p.message)||"保存提示词失败")}finally{ct(!1)}}),xe=p=>{Q(p),ze(p)},lt=p=>vt(void 0,null,function*(){let $=null;try{$=(yield q.post(`/api/ai-investment/run/${p.id}/estimate-calls-resume`,{})).data}catch{}Fe.confirm({title:"确认继续运行？",content:e.jsxs("div",{children:[$?$.total_calls>0?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["按当前配置，理论最大 AI 调用次数约为"," ",e.jsx(_t,{strong:!0,children:$.total_calls})," 次。"]}),e.jsxs("p",{children:["每个模型约 ",e.jsx(_t,{strong:!0,children:$.per_model_calls})," 次，当前选择"," ",e.jsx(_t,{strong:!0,children:$.model_count})," 个模型。"]})]}):e.jsx("p",{children:"根据当前数据，续跑已无剩余预测步数。"}):e.jsx("p",{children:"暂时无法预估本次继续运行的 AI 调用次数。"}),e.jsx("p",{children:"确定要继续运行该任务吗？"})]}),onOk:()=>vt(void 0,null,function*(){R(p.id);try{const ye=(yield q.post(`/api/ai-investment/run/${p.id}/resume`,{name:`${p.name}-续跑`})).data;if(ye&&ye.status==="success"){d.success("续跑任务已完成");const se=(yield q.get(`/api/ai-investment/run/${p.id}`)).data;Q(Ln(An({},p),{name:se.name||p.name})),pe(se.metrics||{}),O(se.equity_curves||{}),Re(se.price_series||[]),yield ze(p);const ae=yield be();ae&&Array.isArray(ae)&&_(ae)}else d.error((ye==null?void 0:ye.message)||"续跑任务执行失败")}catch(F){d.error((F==null?void 0:F.message)||"续跑任务请求失败")}finally{R(null)}})})}),ls=p=>vt(void 0,null,function*(){try{const F=(yield q.get(`/api/ai-investment/run/${p.id}`)).data;if(F&&F.status==="success"){Q(p),pe(F.metrics||{}),O(F.equity_curves||{}),Re(F.price_series||[]);const ye=F.config||{},Ae=ye.start_time,se=yield le(p.id);let ae=ye.end_time;if(se&&se.length>0){const Le=se[se.length-1].timestamp;(!ae||I(ae).isBefore(Le))&&(ae=Le)}if(!ae){const Le=F.price_series||[];Le.length>0&&(ae=Le[Le.length-1].date)}!ae&&p.completed_at&&(ae=p.completed_at);const ve=Ae&&ae?[I(Ae),I(ae)]:void 0,at={name:F.name||p.name,symbol:F.symbol||p.symbol,data_source:F.data_source,frequency:F.frequency,models:Array.isArray(F.models)&&F.models.length>0?F.models:p.models,initial_capital:F.initial_capital,buy_threshold:ye.buy_threshold,sell_threshold:ye.sell_threshold,stop_loss_pct:ye.stop_loss_pct,take_profit_pct:ye.take_profit_pct,window:ye.window,commission_rate:ye.commission_rate,slippage_rate:ye.slippage_rate};ve&&(at.timeRange=ve),Object.keys(at).forEach(Le=>{const jt=at[Le];jt==null&&delete at[Le]}),Object.keys(at).length>0&&b.setFieldsValue(at),d.success("已载入历史运行结果")}else d.error((F==null?void 0:F.message)||"载入历史运行结果失败")}catch($){d.error(($==null?void 0:$.message)||"载入历史运行结果失败")}}),Ht=p=>vt(void 0,null,function*(){Fe.confirm({title:"确认删除该历史运行？",content:"删除后将无法恢复该运行记录及相关明细，是否继续？",okText:"删除",okType:"danger",cancelText:"取消",onOk:()=>vt(void 0,null,function*(){try{const F=(yield q.delete(`/api/ai-investment/run/${p.id}`)).data;if(F&&F.status==="success"){d.success("删除成功");const ye=yield be();Y&&Y.id===p.id&&(Q(null),$e([]),pe({}),O({}),Re([])),Ce&&Ce.id===p.id&&(He(!1),gt(null),dt([])),ye&&Array.isArray(ye)&&_(ye)}else d.error((F==null?void 0:F.message)||"删除失败")}catch($){d.error(($==null?void 0:$.message)||"删除运行记录失败")}})})}),We=p=>{gt(p),t(null),nt(void 0),re(void 0),Ne(void 0),Be(""),He(!0),E(p.id,1,Ue,{level:void 0,category:void 0,keyword:"",recordId:void 0})},ps=p=>{const $=f.find(F=>F.id===p.run_id)||Y;if(!$){d.warning("请先在左侧选择对应的运行记录");return}gt($),t(p),re(void 0),Ne("ai_call"),Be(""),nt(p.id),He(!0),E(p.run_id,1,Ue,{category:"ai_call",recordId:p.id})},Mt=o.useMemo(()=>{if(Me)return wt.find(p=>p.category==="ai_call")},[wt,Me]),vs=[{title:"名称",dataIndex:"name",key:"name",width:200,ellipsis:!0},{title:"股票代码",dataIndex:"symbol",key:"symbol",width:100},{title:"模型",dataIndex:"models",key:"models",width:140,render:p=>e.jsx(De,{size:"small",children:(p||[]).map($=>e.jsx(Pe,{children:$},$))})},{title:"状态",dataIndex:"status",key:"status",width:100,render:p=>e.jsx(Pe,{color:p==="completed"?"green":"blue",children:p})},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:180,render:p=>p?I(p).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:180,render:p=>p?I(p).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"操作",key:"action",width:220,render:(p,$)=>e.jsxs(De,{size:"small",children:[e.jsx(L,{size:"small",icon:e.jsx(Ks,{}),onClick:F=>{F.stopPropagation(),We($)},children:"查看日志"}),e.jsx(L,{size:"small",icon:e.jsx(mr,{}),loading:A===$.id,onClick:F=>{F.stopPropagation(),lt($)},children:"继续运行"}),e.jsx(L,{size:"small",icon:e.jsx(Ut,{}),onClick:F=>{F.stopPropagation(),ls($)},children:"载入结果"}),e.jsx(L,{size:"small",danger:!0,onClick:F=>{F.stopPropagation(),Ht($)},children:"删除"})]})}],_s=[{title:"时间",dataIndex:"timestamp",key:"timestamp",render:p=>p?I(p).format("YYYY-MM-DD HH:mm"):"-"},{title:"模型",dataIndex:"model_type",key:"model_type"},{title:"预测价格",dataIndex:"predicted_price",key:"predicted_price",render:p=>p.toFixed(4)},{title:"实际价格",dataIndex:"actual_price",key:"actual_price",render:p=>p.toFixed(4)},{title:"操作",dataIndex:"action",key:"action",render:p=>{let $="default",F=p;return p==="BUY"?($="red",F="买入"):p==="SELL"?($="green",F="卖出"):p==="HOLD"&&($="default",F="观望"),e.jsx(Pe,{color:$,children:F})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:160,ellipsis:!0,render:p=>p||"—"},{title:"持仓",dataIndex:"position",key:"position",render:p=>p.toFixed(2)},{title:"单笔收益",dataIndex:"pnl",key:"pnl",render:p=>p.toFixed(2)},{title:"累计收益",dataIndex:"cumulative_pnl",key:"cumulative_pnl",render:p=>p.toFixed(2)},{title:"账户权益",dataIndex:"equity",key:"equity",render:p=>p.toFixed(2)},{title:"操作",key:"action",render:(p,$)=>e.jsx(L,{size:"small",icon:e.jsx(Ks,{}),onClick:()=>ps($),children:"查看日志"})}],ws=o.useMemo(()=>{const p=[],$=[];return Object.keys(P||{}).forEach(F=>{const Ae=(P[F]||[]).map(se=>I(se.date).format("YYYY-MM-DD HH:mm"));Ae.length>$.length&&$.splice(0,$.length,...Ae)}),Object.keys(P||{}).forEach(F=>{const Ae=(P[F]||[]).map(ae=>ae.equity),se=fe(F);p.push({type:"line",name:F,data:Ae,smooth:!0,lineStyle:{color:se},itemStyle:{color:se}})}),{tooltip:{trigger:"axis"},legend:{top:0},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:$},yAxis:{type:"value",scale:!0,name:"账户权益"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:p}},[P]),Jt=o.useMemo(()=>{const p="YYYY-MM-DD HH:mm",$=[];if(x.length>0)x.forEach(m=>{$.push(I(m.date).format(p))});else if(V.length>0){const m=new Set;V.forEach(C=>{m.add(I(C.timestamp).format(p))}),Array.from(m).sort().forEach(C=>$.push(C))}if($.length===0)return{tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{top:0,data:[]},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:[]},yAxis:{type:"value",scale:!0,name:"价格"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:[]};const F=new Map;x.forEach(m=>{const C=I(m.date).format(p);F.set(C,m.close)}),F.size===0&&V.length>0&&V.forEach(m=>{const C=I(m.timestamp).format(p);F.has(C)||F.set(C,m.actual_price)});const ye=$.map(m=>{var C;return(C=F.get(m))!=null?C:null}),Ae=[];w.forEach(m=>{const C=V.filter(N=>N.model_type===m);if(C.length===0)return;const U=new Map;C.forEach(N=>{const he=I(N.timestamp).format(p);U.set(he,N.predicted_price)});const de=$.map(N=>{var he;return(he=U.get(N))!=null?he:null}),i=fe(m);Ae.push({type:"line",name:`${m}预测`,data:de,smooth:!0,lineStyle:{color:i},itemStyle:{color:i}})});const se=new Map;$.forEach((m,C)=>{se.set(m,C)});const ae=[],ve=[];V.forEach(m=>{var C,U;const de=I(m.timestamp).format(p),i=se.get(de);if(i===void 0)return;const N=(U=(C=m.actual_price)!=null?C:F.get(de))!=null?U:null;N!=null&&(m.action==="BUY"?ae.push({index:i,price:N}):m.action==="SELL"&&ve.push({index:i,price:N}))});const at=ae.map(m=>({name:"买入点",coord:[$[m.index],m.price],value:m.price,itemStyle:{color:"#f64034"},symbol:"circle",symbolSize:8,label:{show:!1}})),Le=ve.map(m=>({name:"卖出点",coord:[$[m.index],m.price],value:m.price,itemStyle:{color:"#00b46a"},symbol:"circle",symbolSize:8,label:{show:!1}})),jt=ae.map(m=>({name:"买入",coord:[$[m.index],m.price*1.02],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:22,label:{show:!0,formatter:"B",color:"#ffffff",position:"inside",fontSize:12,fontWeight:"bold"}})),Pt=ve.map(m=>({name:"卖出",coord:[$[m.index],m.price*.98],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:22,label:{show:!0,formatter:"S",color:"#ffffff",position:"inside",fontSize:12,fontWeight:"bold"}})),s=[...at,...Le,...jt,...Pt],c=[{type:"line",name:"实际收盘价",data:ye,smooth:!0,lineStyle:{color:"#666666"},itemStyle:{color:"#666666"},markPoint:{data:s}},...Ae];return{tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{top:0,data:c.map(m=>m.name)},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:$},yAxis:{type:"value",scale:!0,name:"价格"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:c}},[x,V,w]),Ss=o.useMemo(()=>Z?Object.keys(Z).map(p=>{var $,F,ye;const Ae=Z[p];return{model:p,total_return:($=Ae==null?void 0:Ae.total_return)!=null?$:0,max_drawdown:(F=Ae==null?void 0:Ae.max_drawdown)!=null?F:0,sharpe_ratio:(ye=Ae==null?void 0:Ae.sharpe_ratio)!=null?ye:0}}):[],[Z]),ks=[{title:"模型",dataIndex:"model",key:"model"},{title:"总收益率",dataIndex:"total_return",key:"total_return",render:p=>`${(p*100).toFixed(2)} %`},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:p=>`${(p*100).toFixed(2)} %`},{title:"夏普比率",dataIndex:"sharpe_ratio",key:"sharpe_ratio",render:p=>p.toFixed(2)}];return e.jsxs("div",{children:[e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:16,children:e.jsx(oe,{title:e.jsxs(De,{children:[e.jsx(Ut,{}),"AI实时投资跑数配置"]}),children:e.jsxs(T,{form:b,layout:"vertical",initialValues:{data_source:"database",frequency:"1d",models:["deepseek"],initial_capital:1e5,buy_threshold:.002,sell_threshold:-.002,stop_loss_pct:.05,take_profit_pct:.1,window:20,commission_rate:.0015,slippage_rate:.001},children:[e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"name",label:"运行名称",children:e.jsx(ke,{placeholder:"可选，例如：AAPL-日内回放"})})}),e.jsx(y,{span:12,children:X==="database"?e.jsx(T.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请选择股票代码"}],children:e.jsx(Ee,{showSearch:!0,placeholder:"从市场数据管理中选择股票",loading:Ye,optionFilterProp:"children",filterOption:(p,$)=>{var F;return String((F=$==null?void 0:$.children)!=null?F:"").toLowerCase().includes(p.toLowerCase())},children:Ie.map(p=>e.jsxs(ot,{value:p.symbol,children:[p.symbol,"（",p.name,"）"]},p.id))})}):e.jsx(T.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(ke,{placeholder:"例如：HK.00700"})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"timeRange",label:"时间范围",rules:[{required:!0,message:"请选择时间范围"}],children:e.jsx(Pn,{showTime:!0,style:{width:"100%"},presets:[{label:"最近3天",value:[I().subtract(3,"day"),I()]},{label:"最近一周",value:[I().subtract(7,"day"),I()]},{label:"最近两周",value:[I().subtract(14,"day"),I()]},{label:"最近3周",value:[I().subtract(21,"day"),I()]},{label:"最近一月",value:[I().subtract(1,"month"),I()]},{label:"最近3月",value:[I().subtract(3,"month"),I()]},{label:"最近半年",value:[I().subtract(6,"month"),I()]},{label:"最近一年",value:[I().subtract(1,"year"),I()]},{label:"最近两年",value:[I().subtract(2,"year"),I()]},{label:"最近3年",value:[I().subtract(3,"year"),I()]},{label:"最近5年",value:[I().subtract(5,"year"),I()]}],disabledDate:p=>p&&p>I().endOf("day")})})}),e.jsx(y,{span:12,children:e.jsx(T.Item,{name:"models",label:"AI模型",rules:[{required:!0,message:"请选择至少一个模型"}],children:e.jsxs(Ee,{mode:"multiple",placeholder:"支持多选，用于模型对比或加权",children:[e.jsx(ot,{value:"qwen",children:"千问"}),e.jsx(ot,{value:"kimi",children:"Kimi"}),e.jsx(ot,{value:"deepseek",children:"DeepSeek"})]})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:8,children:e.jsx(T.Item,{name:"data_source",label:"数据源",children:e.jsxs(Ee,{children:[e.jsx(ot,{value:"database",children:"市场数据管理(日线)"}),e.jsx(ot,{value:"futu",children:"富途 OpenAPI 实时"})]})})}),e.jsx(y,{span:8,children:e.jsx(T.Item,{name:"frequency",label:"数据频率",children:e.jsx(Ee,{children:ne.map(p=>e.jsx(ot,{value:p.value,children:p.label},p.value))})})}),e.jsx(y,{span:8,children:e.jsx(T.Item,{name:"initial_capital",label:"初始资金",children:e.jsx(ke,{type:"number",min:0})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:6,children:e.jsx(T.Item,{name:"buy_threshold",label:"买入阈值(预测涨幅)",children:e.jsx(ke,{type:"number",step:"0.001"})})}),e.jsx(y,{span:6,children:e.jsx(T.Item,{name:"sell_threshold",label:"卖出阈值(预测跌幅)",children:e.jsx(ke,{type:"number",step:"0.001"})})}),e.jsx(y,{span:6,children:e.jsx(T.Item,{name:"stop_loss_pct",label:"止损比例",children:e.jsx(ke,{type:"number",step:"0.01"})})}),e.jsx(y,{span:6,children:e.jsx(T.Item,{name:"take_profit_pct",label:"止盈比例",children:e.jsx(ke,{type:"number",step:"0.01"})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:6,children:e.jsx(T.Item,{name:"commission_rate",label:"手续费率",children:e.jsx(ke,{type:"number",step:"0.0001"})})}),e.jsx(y,{span:6,children:e.jsx(T.Item,{name:"slippage_rate",label:"滑点比例",children:e.jsx(ke,{type:"number",step:"0.0001"})})})]}),e.jsx(G,{gutter:16,children:e.jsx(y,{span:6,children:e.jsx(T.Item,{name:"window",label:"模型窗口长度",children:e.jsx(ke,{type:"number",min:2})})})}),e.jsxs(G,{justify:"space-between",align:"middle",children:[e.jsx(y,{children:e.jsxs(De,{direction:"vertical",size:4,children:[e.jsx(L,{size:"small",loading:a,onClick:Ze,children:"预估AI调用次数"}),h&&e.jsx(_t,{type:"danger",style:{maxWidth:480},children:h})]})}),e.jsx(y,{children:e.jsx(L,{type:"primary",icon:e.jsx(Ut,{}),loading:j,onClick:qe,children:"启动AI跑数"})})]})]})})}),e.jsx(y,{span:8,children:e.jsx(oe,{title:e.jsxs(De,{children:[e.jsx(Lt,{}),"历史运行"]}),children:e.jsx(ts,{rowKey:"id",loading:D,dataSource:f,columns:vs,size:"small",scroll:{x:!0},pagination:{pageSize:5},onRow:p=>({onClick:()=>xe(p)})})})})]}),e.jsxs(G,{gutter:16,style:{marginTop:16},children:[e.jsx(y,{span:12,children:e.jsx(oe,{title:"价格与模型预测（含买卖点）",children:e.jsx(Bt,{option:Jt,style:{height:540}})})}),e.jsx(y,{span:12,children:e.jsx(oe,{title:"账户权益曲线",children:e.jsx(Bt,{option:ws,style:{height:540}})})})]}),e.jsx(G,{gutter:16,style:{marginTop:16},children:e.jsx(y,{span:24,children:e.jsx(oe,{title:"预测明细",children:e.jsx(ts,{rowKey:(p,$)=>`${p.model_type}-${p.timestamp}-${$}`,loading:Te,dataSource:V,columns:_s,size:"small",pagination:{pageSize:10},scroll:{x:1200}})})})}),e.jsx(G,{gutter:16,style:{marginTop:16},children:e.jsx(y,{span:24,children:e.jsx(oe,{title:"模型绩效对比",children:e.jsx(ts,{rowKey:"model",dataSource:Ss,columns:ks,size:"small",pagination:!1})})})}),e.jsx(G,{gutter:16,style:{marginTop:16},children:e.jsx(y,{span:24,children:e.jsxs(oe,{title:"AI提示词设置",children:[e.jsx(G,{gutter:16,children:e.jsx(y,{span:8,children:e.jsxs(De,{children:[e.jsx("span",{children:"选择模型"}),e.jsxs(Ee,{style:{minWidth:160},value:ce,onChange:p=>et(p),children:[e.jsx(ot,{value:"deepseek",children:"DeepSeek"}),e.jsx(ot,{value:"qwen",children:"千问"}),e.jsx(ot,{value:"kimi",children:"Kimi"})]})]})})}),e.jsx(G,{style:{marginTop:16},children:e.jsx(y,{span:24,children:e.jsx(ke.TextArea,{value:te,onChange:p=>Oe(p.target.value),autoSize:{minRows:4,maxRows:20},style:{whiteSpace:"pre-wrap"},placeholder:"请输入系统提示词，将作为大模型的系统角色描述"})})}),e.jsx(G,{justify:"end",style:{marginTop:16},children:e.jsx(y,{children:e.jsxs(De,{children:[e.jsx(L,{onClick:()=>ee(ce),loading:je,children:"重新加载"}),e.jsx(L,{type:"primary",loading:zt,onClick:ut,children:"保存提示词"})]})})})]})})}),e.jsxs(Fe,{open:Ve,title:Ce?`运行日志 - ${Ce.name} (#${Ce.id}) · 共${g}条`:`运行日志 · 共${g}条`,onCancel:()=>He(!1),footer:null,width:960,children:[Me&&e.jsxs(oe,{size:"small",style:{marginBottom:16},children:[e.jsxs(G,{gutter:16,style:{marginBottom:8},children:[e.jsxs(y,{span:8,children:[e.jsx(_t,{strong:!0,children:"时间"}),e.jsx("div",{children:I(Me.timestamp).format("YYYY-MM-DD HH:mm")})]}),e.jsxs(y,{span:8,children:[e.jsx(_t,{strong:!0,children:"模型"}),e.jsx("div",{children:Me.model_type})]}),e.jsxs(y,{span:8,children:[e.jsx(_t,{strong:!0,children:"操作"}),e.jsx("div",{children:Me.action})]})]}),e.jsxs(G,{gutter:16,style:{marginBottom:12},children:[e.jsxs(y,{span:8,children:[e.jsx(_t,{strong:!0,children:"预测价格"}),e.jsx("div",{children:Me.predicted_price.toFixed(4)})]}),e.jsxs(y,{span:8,children:[e.jsx(_t,{strong:!0,children:"实际价格"}),e.jsx("div",{children:Me.actual_price.toFixed(4)})]}),e.jsxs(y,{span:8,children:[e.jsx(_t,{strong:!0,children:"账户权益"}),e.jsx("div",{children:Me.equity.toFixed(2)})]})]}),Me.prediction_reason&&e.jsx(G,{gutter:16,style:{marginBottom:12},children:e.jsxs(y,{span:24,children:[e.jsx(_t,{strong:!0,children:"预测原因"}),e.jsx("div",{children:Me.prediction_reason})]})}),Mt&&e.jsxs(e.Fragment,{children:[e.jsx(G,{gutter:16,style:{marginBottom:8},children:e.jsx(y,{span:24,children:e.jsx(_t,{strong:!0,children:"模型输入"})})}),e.jsx(G,{gutter:16,style:{marginBottom:12},children:e.jsxs(y,{span:24,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"System Prompt"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((n=Mt.ai_input)==null?void 0:n.system_prompt)||"无"})]})}),e.jsx(G,{gutter:16,style:{marginBottom:12},children:e.jsxs(y,{span:24,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"Prompt"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((r=Mt.ai_input)==null?void 0:r.prompt)||"无"})]})}),e.jsx(G,{gutter:16,style:{marginBottom:8},children:e.jsx(y,{span:24,children:e.jsx(_t,{strong:!0,children:"模型输出"})})}),e.jsxs(G,{gutter:16,children:[e.jsxs(y,{span:8,children:[e.jsx(_t,{strong:!0,children:"解析后的数值"}),e.jsx("div",{children:Mt.ai_output&&Mt.ai_output.value!==void 0?Mt.ai_output.value:"无"})]}),e.jsxs(y,{span:16,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"原始内容"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((l=Mt.ai_output)==null?void 0:l.content)||"无"})]})]})]})]}),e.jsxs(De,{style:{marginBottom:8},children:[e.jsxs(Ee,{allowClear:!0,placeholder:"级别",style:{width:120},value:H,onChange:p=>{Ce&&E(Ce.id,1,Ue,{level:p||void 0})},children:[e.jsx(ot,{value:"DEBUG",children:"DEBUG"}),e.jsx(ot,{value:"INFO",children:"INFO"}),e.jsx(ot,{value:"WARN",children:"WARN"}),e.jsx(ot,{value:"ERROR",children:"ERROR"})]}),e.jsxs(Ee,{allowClear:!0,placeholder:"类别",style:{width:140},value:J,onChange:p=>{Ce&&E(Ce.id,1,Ue,{category:p||void 0})},children:[e.jsx(ot,{value:"run",children:"运行"}),e.jsx(ot,{value:"ai_call",children:"AI调用"}),e.jsx(ot,{value:"trade",children:"买卖点"}),e.jsx(ot,{value:"system",children:"系统"})]}),e.jsx(ke.Search,{allowClear:!0,placeholder:"按关键字搜索",style:{width:260},value:st,onChange:p=>Be(p.target.value),onSearch:p=>{Ce&&E(Ce.id,1,Ue,{keyword:p})}}),e.jsxs("span",{children:["共 ",g," 条"]})]}),e.jsx(ts,{rowKey:"id",loading:ft,dataSource:wt,size:"small",pagination:{current:yt,pageSize:Ue,total:g,showSizeChanger:!0,onChange:(p,$)=>{Ce&&E(Ce.id,p,$)}},columns:[{title:"序号",key:"index",width:70,render:(p,$,F)=>(yt-1)*Ue+F+1},{title:"时间",dataIndex:"timestamp",key:"timestamp",width:180,render:p=>p?I(p).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"级别",dataIndex:"level",key:"level",width:80},{title:"类别",dataIndex:"category",key:"category",width:100},{title:"消息",dataIndex:"message",key:"message",ellipsis:!0},{title:"AI输入",key:"ai_input",width:160,render:(p,$)=>$.ai_input?JSON.stringify($.ai_input):""},{title:"AI输出",key:"ai_output",width:160,render:(p,$)=>$.ai_output?JSON.stringify($.ai_output):""}],scroll:{x:900,y:400}})]})]})};var ga=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});const{Title:Nn,Text:Cs}=Nt,Tn=()=>{const n=Zt(),[r,l]=o.useState([]),[b,f]=o.useState(!1),_=o.useRef(!1),D=()=>ga(void 0,null,function*(){f(!0);try{const V=yield cs();console.log("获取到的策略数据:",V),l(V)}catch{d.error("获取策略列表失败")}finally{f(!1)}});o.useEffect(()=>{_.current||(_.current=!0,D())},[]);const z=()=>{n("/strategy/edit")},j=V=>{V&&n(`/strategy/edit/${V}`)},k=V=>ga(void 0,null,function*(){if(V)try{yield Na(V),d.success("策略删除成功"),D()}catch{d.error("删除策略失败")}}),Y=V=>{V&&n(`/backtest?strategy=${V}`)},Q=()=>b?e.jsx(rs,{tip:"加载中..."}):r.length===0?e.jsx(Us,{description:"暂无策略",image:Us.PRESENTED_IMAGE_SIMPLE}):e.jsx(Dt,{className:"strategy-list",itemLayout:"horizontal",dataSource:r,renderItem:V=>e.jsxs(Dt.Item,{className:"strategy-list-item",style:{padding:"16px",borderRadius:"8px",backgroundColor:"#f9f9f9",marginBottom:"12px",display:"flex",justifyContent:"space-between"},children:[e.jsxs("div",{style:{flex:1,overflow:"hidden"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"8px"},children:e.jsx(Cs,{strong:!0,style:{fontSize:"16px",marginRight:"8px"},children:V.name})}),e.jsx(Cs,{type:"secondary",style:{display:"block",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:V.description||"无描述"}),V.updated_at&&e.jsxs(Cs,{type:"secondary",style:{fontSize:"12px"},children:["最后更新: ",new Date(V.updated_at).toLocaleString()]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center"},children:e.jsxs(De,{children:[e.jsx(L,{type:"primary",icon:e.jsx(fr,{}),onClick:()=>Y(V.id),children:"回测"}),e.jsx(L,{icon:e.jsx(xr,{}),onClick:()=>j(V.id),children:"编辑"}),e.jsx(L,{danger:!0,icon:e.jsx(ns,{}),onClick:()=>k(V.id),children:"删除"})]})})]},V.id)});return e.jsx("div",{style:{padding:"20px"},children:e.jsxs(oe,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx(Nn,{level:4,style:{margin:0},children:"策略构建器"}),e.jsx(L,{type:"primary",icon:e.jsx(Ma,{}),onClick:z,children:"创建新策略"})]}),e.jsx(gs,{}),Q()]})})};var Ds=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});const{Title:Rn,Text:zs}=Nt,{TextArea:Yn}=ke,ya=()=>{const{id:n}=_a(),r=Zt(),[l]=T.useForm(),[b,f]=o.useState(""),[_,D]=o.useState(!1),[z,j]=o.useState(!1),[k,Y]=o.useState(!0),[Q,V]=o.useState(""),$e=`from .strategy_template import StrategyTemplate
import pandas as pd
import numpy as np
import logging

logger = logging.getLogger(__name__)

class MyStrategy(StrategyTemplate):
    """
    我的自定义策略
    """
    
    def __init__(self, parameters=None):
        """初始化策略"""
        default_params = {
            # 在这里定义策略参数和默认值
        }
        
        # 合并用户参数与默认参数
        if parameters:
            default_params.update(parameters)
            
        super().__init__("我的策略", default_params)
        
    def generate_signals(self) -> pd.DataFrame:
        """
        生成交易信号
        
        Returns:
            包含信号的DataFrame，包括:
            - signal: 交易信号 (1: 买入, -1: 卖出, 0: 不操作)
            - trigger_reason: 信号触发原因
        """
        if self.data is None or self.data.empty:
            logger.warning("未设置数据或数据为空，无法生成信号")
            return pd.DataFrame()
        
        # 获取数据
        df = self.data.copy()
        
        # 添加交易信号
        df['signal'] = 0
        df['trigger_reason'] = ''
        
        # TODO: 实现您的交易逻辑
        
        # 使用log函数记录策略执行过程（可选）
        self.log("开始生成交易信号", "INFO")
        self.log(f"数据行数: {len(df)}", "DEBUG")
        
        # 示例: 当价格上涨超过2%时买入
        price_change = df['close'].pct_change() * 100
        buy_signal = price_change > 2
        df.loc[buy_signal, 'signal'] = 1
        df.loc[buy_signal, 'trigger_reason'] = "价格上涨超过2%"
        
        # 记录买入信号数量
        buy_count = buy_signal.sum()
        if buy_count > 0:
            self.log(f"生成买入信号 {buy_count} 个", "INFO")
        
        # 示例: 当价格下跌超过2%时卖出
        sell_signal = price_change < -2
        df.loc[sell_signal, 'signal'] = -1
        df.loc[sell_signal, 'trigger_reason'] = "价格下跌超过2%"
        
        # 记录卖出信号数量
        sell_count = sell_signal.sum()
        if sell_count > 0:
            self.log(f"生成卖出信号 {sell_count} 个", "INFO")
        
        self.log("交易信号生成完成", "INFO")
        
        return df
`;o.useEffect(()=>{n?(Y(!1),Te(parseInt(n))):f($e)},[n]);const Te=P=>Ds(void 0,null,function*(){D(!0);try{const O=yield tn(P);O&&(l.setFieldsValue({name:O.name,description:O.description,parameters:O.parameters||{}}),f(O.code||$e),V(O.template||""))}catch{d.error("获取策略详情失败")}finally{D(!1)}}),ue=()=>Ds(void 0,null,function*(){try{const P=yield l.validateFields();D(!0);const O=P.parameters&&typeof P.parameters=="object"?P.parameters:{},x={name:P.name,description:P.description,code:b,parameters:O,template:Q};let Re;k?Re=yield sn(x):n&&(Re=yield an(parseInt(n),x)),Re&&(d.success(`策略${k?"创建":"更新"}成功`),k&&Re.id&&(r(`/strategy/edit/${Re.id}`),Y(!1)))}catch(P){P.message?d.error(P.message):d.error(`策略${k?"创建":"更新"}失败`)}finally{D(!1)}}),Z=()=>Ds(void 0,null,function*(){j(!0);try{const P=l.getFieldsValue(),O=P.parameters&&typeof P.parameters=="object"?P.parameters:{},x=yield rn(b,[],O);x&&!x.error?Fe.success({title:"策略代码验证通过",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码语法正确，可以正常运行。"}),x.signals&&e.jsxs("p",{children:["测试生成了 ",x.signals.length," 条数据记录。"]})]})}):Fe.error({title:"策略代码验证失败",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码存在问题，详细错误信息："}),e.jsx("pre",{style:{maxHeight:"300px",overflow:"auto"},children:x.error||"未知错误"})]})})}catch{d.error("测试策略代码失败")}finally{j(!1)}}),pe=()=>{r("/strategy")};return e.jsx("div",{style:{padding:"20px"},children:e.jsx(rs,{spinning:_,tip:"加载中...",children:e.jsx(oe,{children:e.jsxs(G,{gutter:[16,16],children:[e.jsx(y,{span:24,children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsxs(De,{children:[e.jsx(L,{icon:e.jsx(Aa,{}),onClick:pe,children:"返回"}),e.jsx(Rn,{level:4,style:{margin:0},children:k?"创建新策略":"编辑策略"})]}),e.jsxs(De,{children:[e.jsx(L,{type:"primary",icon:e.jsx(Da,{}),onClick:ue,loading:_,children:"保存"}),e.jsx(L,{icon:e.jsx(Ut,{}),onClick:Z,loading:z,children:"测试"})]})]})}),e.jsx(y,{span:24,children:e.jsxs(T,{form:l,layout:"vertical",children:[e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:12,children:e.jsx(T.Item,{label:"策略名称",name:"name",rules:[{required:!0,message:"请输入策略名称"}],children:e.jsx(ke,{placeholder:"请输入策略名称"})})}),e.jsx(y,{span:12,children:e.jsx(T.Item,{label:"策略描述",name:"description",children:e.jsx(Yn,{rows:1,placeholder:"请输入策略描述"})})})]}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:8,children:e.jsx(T.Item,{label:"分批建仓批次数 (batch_count)",name:["parameters","batch_count"],initialValue:1,children:e.jsx(ke,{type:"number",min:1})})}),e.jsx(y,{span:8,children:e.jsx(T.Item,{label:"批次间隔条数 (batch_interval_bars)",name:["parameters","batch_interval_bars"],initialValue:1,children:e.jsx(ke,{type:"number",min:1})})}),e.jsx(y,{span:8,children:e.jsx(T.Item,{label:"批次权重 (batch_weights)",name:["parameters","batch_weights"],tooltip:"可输入逗号分隔的数字，例如: 0.5,0.3,0.2（若为空则均分）",children:e.jsx(ke,{placeholder:"例如: 0.5,0.3,0.2 或 留空"})})})]})]})}),e.jsxs(y,{span:24,children:[e.jsx(gs,{orientation:"left",children:e.jsxs(De,{children:[e.jsx(As,{}),e.jsx(zs,{strong:!0,children:"策略代码"})]})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(xt,{message:"💡 策略日志功能",description:e.jsxs("div",{children:[e.jsxs("p",{children:["您可以在策略中使用 ",e.jsx("code",{children:"self.log(message, level)"})," 函数记录执行过程："]}),e.jsxs("ul",{style:{marginBottom:0},children:[e.jsxs("li",{children:[e.jsx("code",{children:'self.log("信息内容", "INFO")'})," - 记录一般信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("调试信息", "DEBUG")'})," - 记录调试信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("警告信息", "WARNING")'})," - 记录警告信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("错误信息", "ERROR")'})," - 记录错误信息"]})]}),e.jsx("p",{style:{marginTop:"8px",marginBottom:0},children:e.jsx(zs,{type:"secondary",children:'日志将在回测历史的"控制台"按钮中查看，帮助您调试和监控策略执行过程。'})})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}})}),e.jsx("div",{style:{border:"1px solid #d9d9d9",borderRadius:"2px"},children:e.jsx(jr,{width:"100%",height:"600",language:"python",theme:"vs-dark",value:b,onChange:f,options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,folding:!0,lineNumbers:"on",rulers:[80,120],minimap:{enabled:!0}}})}),e.jsx("div",{style:{marginTop:"8px"},children:e.jsx(zs,{type:"secondary",children:"注意：策略代码必须继承自StrategyTemplate基类，并实现generate_signals方法。"})})]})]})})})})};var Kt=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});Ls([Ps,Fs,Os,Ns,Ts,Rs,Ys,Es]);const{Title:Gn,Text:Ot}=Nt,Ct=n=>typeof n!="string"?String(n):n.includes("T")?n.split("T")[0]:n.includes(" ")?n.split(" ")[0]:n,En=o.memo(()=>{var n,r,l,b,f,_,D,z,j;const k=Zt(),[Y,Q]=o.useState(!1),[V,$e]=o.useState([]),[Te,ue]=o.useState([]),[Z,pe]=o.useState("all"),[P,O]=o.useState(!1),[x,Re]=o.useState(null),[Ie,ie]=o.useState(!1),[Ye,Xe]=o.useState("performance"),[ce,et]=o.useState(0),te=o.useRef(null),Oe=o.useRef(null),[je,rt]=o.useState(!1),zt=o.useRef(!1),ct=[{title:"日期",dataIndex:"date",key:"date",sorter:(t,a)=>{const u=new Date(t.date),h=new Date(a.date);return u.getTime()-h.getTime()}},{title:"方向",dataIndex:"action",key:"action",filters:[{text:"买入",value:"BUY"},{text:"卖出",value:"SELL"}],onFilter:(t,a)=>a.action===t,render:t=>{const a=t==="BUY"?"买入":t==="SELL"?"卖出":t;return e.jsx(Pe,{color:t==="BUY"?"red":"green",children:a})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:t=>e.jsx(Se,{title:t||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:t||"未记录"})})},{title:"期初资金",dataIndex:"before_cash",key:"before_cash",sorter:(t,a)=>t.before_cash-a.before_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"after_cash",key:"after_cash",sorter:(t,a)=>t.after_cash-a.after_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"价格",dataIndex:"price",key:"price",sorter:(t,a)=>{const u=t.price||0,h=a.price||0;return u-h},render:t=>{const a=parseFloat(t);return isNaN(a)?"-":a.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(t,a)=>t.shares-a.shares,render:t=>(parseInt(t)||0).toLocaleString()},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(t,a)=>t.value-a.value,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"手续费",dataIndex:"commission",key:"commission",sorter:(t,a)=>t.commission-a.commission,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(t,a)=>(t.position_size||0)-(a.position_size||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(t,a)=>(t.cumulative_position_ratio||0)-(a.cumulative_position_ratio||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}}],[Ve,He]=o.useState(!1),[Ce,gt]=o.useState(null),[wt,dt]=o.useState(!1),[ft]=T.useForm(),[Ke,yt]=o.useState(!1),[tt,Ue]=o.useState([]),S=()=>Kt(void 0,null,function*(){Q(!0);try{const t=yield q.get("/api/backtest-status/list");$e(t.data),ue(t.data)}catch(t){console.error("获取回测列表失败:",t),d.error("获取回测列表失败")}finally{Q(!1)}}),g=()=>Kt(void 0,null,function*(){if(V.length===0){d.warning("没有可更新的回测记录");return}Fe.confirm({title:"批量更新到最新K线",content:`确定要将所有 ${V.length} 个回测记录更新到最新的K线日期吗？此操作可能需要较长时间。`,okText:"确定更新",cancelText:"取消",onOk:()=>Kt(void 0,null,function*(){var t,a;rt(!0);let u=0,h=0;const M=[];try{for(const A of V)try{const R=yield q.post(`/api/backtest-status/${A.id}/update`,{update_to_date:null});R.data.status==="success"?(u++,console.log(`成功更新回测: ${A.name}`)):(h++,M.push({name:A.name,error:R.data.message||"更新失败"}),console.error(`更新回测失败: ${A.name}`,R.data.message))}catch(R){h++,M.push({name:A.name,error:((a=(t=R.response)==null?void 0:t.data)==null?void 0:a.detail)||R.message||"网络错误"}),console.error(`更新回测失败: ${A.name}`,R)}d.success(`批量更新完成！成功更新 ${u} 个回测，失败 ${h} 个`),S(),h>0&&Fe.info({title:"更新结果详情",content:e.jsxs("div",{children:[e.jsxs("p",{children:["成功更新: ",u," 个"]}),e.jsxs("p",{children:["更新失败: ",h," 个"]}),M.length>0&&e.jsxs("div",{children:[e.jsx("p",{children:"失败项目:"}),e.jsx("ul",{children:M.map((A,R)=>e.jsxs("li",{children:[A.name,": ",A.error]},R))})]})]}),width:500})}catch(A){console.error("批量更新失败:",A),d.error("批量更新失败，请重试")}finally{rt(!1)}})})}),v=t=>Kt(void 0,null,function*(){ie(!0);try{const a=yield q.get(`/api/backtest-status/${t}`);if(a.data.status==="success"){const u=a.data.data;u.results&&u.results.trades&&(u.results.trades=u.results.trades.sort((h,M)=>new Date(M.date).getTime()-new Date(h.date).getTime())),u.trade_records&&(u.trade_records=u.trade_records.sort((h,M)=>new Date(M.date).getTime()-new Date(h.date).getTime())),Re(u),O(!0)}else d.error("获取回测详情失败")}catch(a){console.error("获取回测详情失败:",a),d.error("获取回测详情失败")}finally{ie(!1)}}),H=t=>Kt(void 0,null,function*(){Fe.confirm({title:"确认删除",content:"此操作将永久删除该回测记录，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>Kt(void 0,null,function*(){try{const a=yield q.delete(`/api/backtest-status/${t}`);a.data.status==="success"?(d.success("删除成功"),S()):d.error(a.data.message||"删除失败")}catch(a){console.error("删除回测失败:",a),d.error("删除失败，请重试")}})})}),re=t=>{gt(t),ft.setFieldsValue({new_name:t.name,new_description:t.description||"",update_to_date:null}),He(!0)},J=t=>{yt(!0),Ue([]),q.get(`/api/backtest-status/${t.id}`).then(a=>{if(a.data&&a.data.status==="success"){const h=(a.data.data||{}).logs||[];Ue(h)}else{const u=t.logs||[];Ue(u)}}).catch(a=>{console.error("获取日志失败:",a),d.error("获取日志失败");const u=t.logs||[];Ue(u)})},Ne=()=>Kt(void 0,null,function*(){var t,a,u;if(Ce)try{const h=yield ft.validateFields();dt(!0);const M={new_name:h.new_name,new_description:h.new_description||"",update_to_date:h.update_to_date?h.update_to_date.format("YYYY-MM-DD"):void 0},A=yield q.post(`/api/backtest-status/${Ce.id}/update`,M);if(A.data.status==="success"){d.success("回测更新成功！"),He(!1),ft.resetFields(),S();const R=A.data.data;Fe.success({title:"更新成功",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"新回测名称:"})," ",R.new_backtest_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"更新日期范围:"})," ",R.update_range.start_date," 至 ",R.update_range.end_date]}),R.performance_metrics&&e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("strong",{children:"性能指标:"})}),e.jsxs("ul",{children:[e.jsxs("li",{children:["总收益率: ",(R.performance_metrics.total_return*100).toFixed(2),"%"]}),e.jsxs("li",{children:["最大回撤: ",(R.performance_metrics.max_drawdown*100).toFixed(2),"%"]}),e.jsxs("li",{children:["夏普比率: ",((t=R.performance_metrics.sharpe_ratio)==null?void 0:t.toFixed(2))||"N/A"]})]})]})]}),okText:"确定"})}else d.error(A.data.message||"更新失败")}catch(h){console.error("更新回测失败:",h),d.error(((u=(a=h.response)==null?void 0:a.data)==null?void 0:u.detail)||"更新失败，请重试")}finally{dt(!1)}}),st=[{title:"ID",dataIndex:"id",key:"id",width:60,fixed:"left",align:"center"},{title:"回测名称",dataIndex:"name",key:"name",width:180,fixed:"left",ellipsis:!0,render:t=>e.jsx(Se,{title:t,placement:"topLeft",children:e.jsx(Ot,{strong:!0,style:{color:"#1890ff"},children:t})})},{title:"策略",dataIndex:"strategy_name",key:"strategy_name",width:120,ellipsis:!0,render:t=>e.jsx(Se,{title:t||"未知策略",placement:"topLeft",children:e.jsx(Pe,{color:"blue",children:t||"未知"})})},{title:"自定义参数",key:"parameters",width:150,ellipsis:!0,render:(t,a)=>{const u=a.parameters;if(!u||Object.keys(u).length===0)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const h=u.parameters||{},M=Object.keys(h).length;if(M===0)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const R=Object.entries(h).slice(0,2).map(([ne,w])=>`${ne}:${w}`).join(", "),X=M>2?`${R}...`:R;return e.jsx(Se,{title:e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:"8px"},children:"策略参数:"}),Object.entries(h).map(([ne,w])=>e.jsxs("div",{style:{marginBottom:"4px"},children:[e.jsxs("span",{style:{color:"#1890ff"},children:[ne,":"]})," ",String(w)]},ne))]}),placement:"topLeft",children:e.jsx(Ot,{style:{color:"#722ed1",fontSize:"12px"},children:X})})}},{title:"股票",dataIndex:"instruments",key:"instruments",width:80,align:"center",render:t=>e.jsx(Pe,{color:"green",children:t.join(", ")})},{title:"回测期间",key:"date_range",width:160,align:"center",render:(t,a)=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:I(a.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#999"},children:["至 ",I(a.end_date).format("YYYY-MM-DD")]})]})},{title:"状态",dataIndex:"status",key:"status",width:80,align:"center",render:t=>{const u={running:{text:"运行中",color:"processing"},completed:{text:"已完成",color:"success"},failed:{text:"失败",color:"error"}}[t]||{text:t,color:"default"};return e.jsx(Pe,{color:u.color,children:u.text})}},{title:"年化收益率",key:"annual_return",width:100,align:"right",render:(t,a)=>{var u;const h=(u=a.performance_metrics)==null?void 0:u.annual_return;if(h!==void 0){const M=h>=0?"#ff4d4f":"#52c41a",A=h*100;return e.jsxs(Ot,{style:{color:M,fontWeight:"bold"},children:[A>=0?"+":"",A.toFixed(1),"%"]})}return e.jsx(Ot,{style:{color:"#999"},children:"-"})}},{title:"最大回撤",key:"max_drawdown",width:100,align:"right",render:(t,a)=>{var u;const h=(u=a.performance_metrics)==null?void 0:u.max_drawdown;if(h!==void 0){const M=Math.floor(h*100*100)/100;return e.jsxs(Ot,{style:{color:"#ff4d4f",fontWeight:"bold"},children:[M.toFixed(1),"%"]})}return e.jsx(Ot,{style:{color:"#999"},children:"-"})}},{title:"最近一次交易时间",key:"last_trade_time",width:160,align:"center",render:(t,a)=>{const u=a.trade_records||[];if(u.length===0)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const h=u[u.length-1],M=h==null?void 0:h.date,A=h==null?void 0:h.action,R=h==null?void 0:h.price;if(!M)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const X=A==="BUY"?"买入":A==="SELL"?"卖出":A||"未知",ne=A==="BUY"?"#ff4d4f":A==="SELL"?"#52c41a":"#999";return e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:I(M).format("MM-DD")}),e.jsx("div",{style:{color:ne,fontWeight:"bold",marginTop:"2px"},children:X}),R&&e.jsxs("div",{style:{color:"#666",fontSize:"11px",marginTop:"1px"},children:["$",parseFloat(R).toFixed(2)]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:120,align:"center",render:t=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{children:I(t).format("MM-DD")}),e.jsx("div",{style:{color:"#999"},children:I(t).format("HH:mm")})]})},{title:"操作",key:"actions",width:180,fixed:"right",render:(t,a)=>e.jsxs(De,{size:"small",children:[e.jsx(Se,{title:"查看详情",children:e.jsx(L,{type:"text",icon:e.jsx(qs,{}),onClick:()=>v(a.id),size:"small",style:{color:"#1890ff"}})}),e.jsx(Se,{title:"历史记录",children:e.jsx(L,{type:"text",icon:e.jsx(ds,{}),onClick:()=>k(`/backtest-history/${a.id}`),size:"small",style:{color:"#52c41a"}})}),e.jsx(Se,{title:"更新数据",children:e.jsx(L,{type:"text",icon:e.jsx(ss,{}),onClick:()=>re(a),size:"small",style:{color:"#faad14"}})}),e.jsx(Se,{title:"查看日志",children:e.jsx(L,{type:"text",icon:e.jsx(Ms,{}),onClick:()=>J(a),size:"small",style:{color:"#722ed1"}})}),e.jsx(Se,{title:"删除",children:e.jsx(L,{type:"text",danger:!0,icon:e.jsx(ns,{}),onClick:()=>H(a.id),size:"small"})})]})}],Be=(t,a,u)=>{if(!t||t.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const h=t.filter(E=>E&&E.date&&E.equity!==void 0&&!isNaN(Number(E.equity)));if(h.length===0)return{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};let M=[],A=[];const R=new Map;h.forEach((E,ee)=>{const qe=Ct(E.date);R.set(qe,ee)}),a&&a.length>0&&a.forEach(E=>{const ee=Ct(E.date),qe=R.get(ee);if(qe!==void 0){const Ze={name:E.action==="BUY"?"买入点":"卖出点",value:h[qe].equity,xAxis:qe,yAxis:h[qe].equity,itemStyle:{color:E.action==="BUY"?"#f64034":"#00b46a"}};E.action==="BUY"?M.push(Ze):A.push(Ze)}});let X=-1,ne=-1,w=0,fe="",be="",le=0,ze=0;if(h.length>0){let E=h[0].equity,ee=0,qe=0;for(let Ze=1;Ze<h.length;Ze++)h[Ze].equity>E?(E=h[Ze].equity,qe=Ze):(ee=(E-h[Ze].equity)/E*100,ee>w&&(w=ee,X=qe,ne=Ze,fe=h[qe].date,be=h[Ze].date,le=E,ze=h[Ze].equity));console.log(`最大回撤区间索引: ${X} - ${ne}`),console.log(`最大回撤: ${w.toFixed(2)}%, 从 ${fe} 到 ${be}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(E){if(Array.isArray(E)&&E.length>0){const qe=E[0].axisValue,Ze=E[0].data;for(let xe=0;xe<E.length;xe++)if(E[xe].componentType==="markArea")return`最大回撤: ${w.toFixed(2)}%<br/>
                        开始日期: ${fe}<br/>
                        最高点: ¥${le.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${be}<br/>
                        最低点: ¥${ze.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let ut="";for(let xe=0;xe<E.length;xe++){const lt=E[xe];if(lt.seriesName==="买入点"||lt.seriesName==="卖出点"){const ls=Ct(qe),Ht=a.find(We=>Ct(We.date)===ls&&(lt.seriesName==="买入点"&&We.action==="BUY"||lt.seriesName==="卖出点"&&We.action==="SELL"));if(Ht){const We=Ht.trigger_reason||"未记录原因";ut=`<br/><span style="color:${lt.color}">● ${lt.seriesName}</span>`,ut+=`<br/><span style="color:#555; font-size:12px">原因: ${We}</span>`}else ut=`<br/><span style="color:${lt.color}">● ${lt.seriesName}</span>`;break}}return`${qe}<br/>策略收益: ¥${parseFloat(Ze).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${ut}`}const ee=E.value;return`${E.name}: ¥${parseFloat(ee).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:h.map(E=>E.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:h.map(E=>E.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new za(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...M.map(E=>({name:"买入点",coord:[E.xAxis,E.yAxis],value:E.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...A.map(E=>({name:"卖出点",coord:[E.xAxis,E.yAxis],value:E.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${w.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[X>=0&&ne>=0?[{name:"最大回撤开始",xAxis:X,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:ne,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:h.map(()=>u),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:u,label:{formatter:"初始资金: ¥"+u.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(E){return`初始资金: ¥${u.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},Ge=(t,a)=>{if(!a||!Array.isArray(a)||a.length===0)return console.warn(`计算MA${t}失败: 数据无效`),[];const u=[];for(let h=0;h<a.length;h++){if(h<t-1){u.push("-");continue}let M=0,A=0;for(let R=0;R<t;R++){const X=a[h-R];if(X&&X.length>=4){const ne=Number(X[1]);!isNaN(ne)&&ne>0&&(M+=ne,A++)}}A>0?u.push((M/A).toFixed(2)):u.push("-")}return u},nt=(t,a)=>{var u;const h=`${((u=x==null?void 0:x.instruments)==null?void 0:u[0])||"股票"} K线图与交易信号`;if(!t||t.length===0)return{title:{text:h,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"}}};const M=t.map(w=>[w.date,w.open,w.close,w.low,w.high,w.volume]);let A=[],R=[];if(a&&a.length>0){const w=new Map;M.forEach((le,ze)=>{const E=Ct(le[0]);w.set(E,ze)}),A=a.filter(le=>le.action==="BUY").map(le=>{const ze=Ct(le.date),E=w.get(ze),ee=le.price||0;return E===void 0||ee<=0?null:{name:"买入",value:[E,ee],xAxis:E,yAxis:ee,itemStyle:{color:"#f64034"}}}).filter(le=>le!==null),R=a.filter(le=>le.action==="SELL").map(le=>{const ze=Ct(le.date),E=w.get(ze),ee=le.price||0;return E===void 0||ee<=0?null:{name:"卖出",value:[E,ee],xAxis:E,yAxis:ee,itemStyle:{color:"#00b46a"}}}).filter(le=>le!==null)}const X=M.map(w=>w[0]);let ne=[...A.map(w=>({name:"买入点",coord:[w.value[0],w.value[1]],value:w.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...R.map(w=>({name:"卖出点",coord:[w.value[0],w.value[1]],value:w.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...A.map(w=>{const fe=w.value[0],le=M[fe][4]*1.1;return{name:"买入标签",coord:[w.value[0],le],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...R.map(w=>{const fe=w.value[0],le=M[fe][4]*1.2;return{name:"卖出标签",coord:[w.value[0],le],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];return{title:{text:h,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(w){let fe="";if(Array.isArray(w)){const be=w[0].axisValue;fe=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${be}</div>`,w.forEach(ee=>{if(ee.seriesName==="K线"){if(ee.value&&ee.value.length>=4){const qe=Number(ee.value[1])||0,Ze=Number(ee.value[2])||0,ut=Number(ee.value[3])||0,xe=Number(ee.value[4])||0,lt=Ze>=qe?"#f64034":"#00b46a";fe+=`<div style="color:${lt};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${lt};">${qe.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${lt};">${Ze.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${lt};">${ut.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${lt};">${xe.toFixed(2)}</span><br/>
                  </div>`}}else if(ee.seriesName&&ee.seriesName.startsWith("MA")&&ee.value!=="-"){const Ze={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[ee.seriesName]||ee.color;try{const ut=typeof ee.value=="number"?parseFloat(ee.value.toString()).toFixed(3):parseFloat(ee.value||"0").toFixed(3);fe+=`<div style="color:${Ze};font-weight:bold;display:inline-block;margin-right:15px;">${ee.seriesName}：${ut}</div>`}catch(ut){console.warn("格式化MA值出错:",ut),fe+=`<div style="color:${Ze};font-weight:bold;display:inline-block;margin-right:15px;">${ee.seriesName}：0</div>`}}});const le=Ct(be),ze=a.find(ee=>ee.action==="BUY"&&Ct(ee.date)===le),E=a.find(ee=>ee.action==="SELL"&&Ct(ee.date)===le);if((ze||E)&&(fe+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),ze){const ee=ze.price||0,qe=ze.trigger_reason||"未记录原因";fe+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${ee.toFixed(2)}<br/>
                原因：${qe}
              </div>`}if(E){const ee=E.price||0,qe=E.trigger_reason||"未记录原因";fe+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${ee.toFixed(2)}<br/>
                原因：${qe}
              </div>`}}return fe}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:X,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:M.map(w=>[Number(w[1]),Number(w[2]),Number(w[3]),Number(w[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:ne,animation:!1,z:10}},{name:"MA5",type:"line",data:Ge(5,M.map(w=>[Number(w[1]),Number(w[2]),Number(w[3]),Number(w[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Ge(10,M.map(w=>[Number(w[1]),Number(w[2]),Number(w[3]),Number(w[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Ge(20,M.map(w=>[Number(w[1]),Number(w[2]),Number(w[3]),Number(w[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Ge(30,M.map(w=>[Number(w[1]),Number(w[2]),Number(w[3]),Number(w[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}},Me=o.useMemo(()=>{var t,a,u,h;return[{key:"1",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"绩效分析"]}),children:e.jsx(G,{gutter:16,children:e.jsx(y,{span:24,style:{marginBottom:16},children:e.jsx(Bt,{option:Be((x==null?void 0:x.equity_curve)||[],((t=x==null?void 0:x.results)==null?void 0:t.trades)||(x==null?void 0:x.trade_records)||[],(x==null?void 0:x.initial_capital)||1e5),style:{height:500},notMerge:!0,opts:{renderer:"canvas"}},`equity-chart-${ce}`)})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"K线与交易信号"]}),children:e.jsx(G,{gutter:16,children:e.jsx(y,{span:24,children:e.jsx(oe,{title:`${((a=x==null?void 0:x.instruments)==null?void 0:a[0])||"股票"}交易图表`,extra:e.jsxs(De,{children:[e.jsx(L,{type:"primary",size:"small",onClick:()=>{const M=document.querySelector(".kline-chart");if(M){const A=M.__echarts__;A&&A.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(L,{size:"small",onClick:()=>{var M;const A=((M=x==null?void 0:x.results)==null?void 0:M.trades)||(x==null?void 0:x.trade_records)||[],R=(x==null?void 0:x.equity_curve)||[];if(A.length>0&&R.length>0){const X=new Map;R.forEach((w,fe)=>{const be=Ct(w.date);X.set(be,fe)});const ne=[];if(A.forEach(w=>{const fe=Ct(w.date),be=X.get(fe);be!==void 0&&ne.push(be)}),ne.length>0){const w=Math.max(0,Math.min(...ne)-10),fe=Math.min(R.length-1,Math.max(...ne)+10),be=w/R.length*100,le=fe/R.length*100,ze=document.querySelector(".kline-chart");if(ze){const E=ze.__echarts__;E&&(E.dispatchAction({type:"dataZoom",start:be,end:le}),d.success(`已聚焦到交易区域，共显示 ${ne.length} 个交易点`))}}else d.info("未找到交易信号对应的K线数据点")}else d.info("没有交易记录或K线数据")},children:"聚焦交易"}),e.jsx(Se,{title:"只显示有交易的区域",children:e.jsx(Je,{})})]}),children:e.jsx(Bt,{className:"kline-chart",option:nt((x==null?void 0:x.equity_curve)||[],((u=x==null?void 0:x.results)==null?void 0:u.trades)||(x==null?void 0:x.trade_records)||[]),style:{height:600},notMerge:!0,opts:{renderer:"canvas"}},`kline-chart-${ce}`)})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Je,{}),"交易明细"]}),children:e.jsx(Gt,{dataSource:((h=x==null?void 0:x.results)==null?void 0:h.trades)||(x==null?void 0:x.trade_records)||[],columns:ct,rowKey:M=>`trade-${M.date}-${M.action}-${M.price}`,pagination:{pageSize:10},scroll:{x:!0}})}]},[x]);return o.useEffect(()=>{zt.current||(zt.current=!0,S())},[]),o.useEffect(()=>{if(Z==="all")ue(V);else{const t=V.filter(a=>a.strategy_name===Z);ue(t)}},[V,Z]),o.useEffect(()=>{if(P&&x){const t=setTimeout(()=>{te.current&&te.current.getEchartsInstance().resize(),Oe.current&&Oe.current.getEchartsInstance().resize(),et(u=>u+1)},500),a=()=>{te.current&&te.current.getEchartsInstance().resize(),Oe.current&&Oe.current.getEchartsInstance().resize()};return window.addEventListener("resize",a),()=>{clearTimeout(t),window.removeEventListener("resize",a)}}},[P,x]),e.jsxs("div",{style:{padding:"24px"},children:[e.jsx("style",{children:`
        .table-row-light {
          background-color: #fafafa;
        }
        .table-row-dark {
          background-color: #ffffff;
        }
        .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
          font-weight: 600 !important;
          text-align: center !important;
          white-space: nowrap !important;
        }
        .ant-table-tbody > tr:hover > td {
          background-color: #e6f7ff !important;
        }
        .ant-table-tbody > tr > td {
          padding: 8px 12px !important;
          border-bottom: 1px solid #f0f0f0 !important;
        }
        .ant-table-fixed-left .ant-table-thead > tr > th,
        .ant-table-fixed-right .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
        }
        .ant-table-fixed-left .ant-table-tbody > tr > td,
        .ant-table-fixed-right .ant-table-tbody > tr > td {
          background-color: inherit !important;
        }
      `}),e.jsx(oe,{title:e.jsxs(De,{children:[e.jsx(ds,{}),e.jsx("span",{children:"回测历史"})]}),extra:e.jsxs(De,{size:"middle",children:[e.jsx(De.Compact,{children:e.jsxs(Ee,{value:Z,onChange:pe,style:{width:180},placeholder:"选择策略筛选",allowClear:!0,size:"middle",suffixIcon:e.jsx(gr,{}),children:[e.jsx(Ee.Option,{value:"all",children:"全部策略"}),Array.from(new Set(V.map(t=>t.strategy_name).filter(Boolean))).map(t=>e.jsx(Ee.Option,{value:t,children:t},t))]})}),e.jsx(L,{icon:e.jsx(ss,{}),onClick:g,loading:je,type:"primary",children:"一键更新到最新K线"}),e.jsx(L,{icon:e.jsx(Bs,{}),onClick:S,loading:Y,children:"刷新"})]}),children:e.jsx(Gt,{columns:st,dataSource:Te,rowKey:"id",loading:Y,size:"small",bordered:!0,pagination:{pageSize:it.getPageSize(15),showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,a)=>`第 ${a[0]}-${a[1]} 条，共 ${t} 条`,pageSizeOptions:["10","15","20","50"],size:"small",onChange:(t,a)=>{it.setCurrentPage(t),it.setPageSize(a||15)},onShowSizeChange:(t,a)=>{it.setPageSize(a)}},scroll:{x:1550,y:"calc(100vh - 300px)"},rowClassName:(t,a)=>a%2===0?"table-row-light":"table-row-dark"})}),e.jsx(Fe,{title:"回测详情",open:P,onCancel:()=>{O(!1),Xe("performance")},footer:null,width:1200,destroyOnClose:!0,afterOpenChange:t=>{t&&setTimeout(()=>{te.current&&te.current.getEchartsInstance().resize(),Oe.current&&Oe.current.getEchartsInstance().resize()},100)},children:x&&e.jsxs("div",{children:[e.jsxs(pt,{title:"基本信息",bordered:!0,column:2,style:{marginBottom:24},children:[e.jsx(pt.Item,{label:"回测名称",children:x.name}),e.jsx(pt.Item,{label:"策略名称",children:((n=x.strategy_info)==null?void 0:n.name)||"-"}),e.jsxs(pt.Item,{label:"回测期间",children:[I(x.start_date).format("YYYY-MM-DD")," 至 ",I(x.end_date).format("YYYY-MM-DD")]}),e.jsxs(pt.Item,{label:"初始资金",children:["$",x.initial_capital.toLocaleString()]}),e.jsx(pt.Item,{label:"交易标的",children:x.instruments.join(", ")}),e.jsx(pt.Item,{label:"状态",children:e.jsx(Pe,{color:x.status==="completed"?"success":"processing",children:x.status==="completed"?"已完成":"运行中"})})]}),x.performance_metrics&&e.jsxs(oe,{title:"性能指标",style:{marginBottom:24},children:[e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["累计收益 ",e.jsx(Se,{title:"回测期间的总收益率",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:((f=(b=(r=x.performance_metrics)==null?void 0:r.total_return)!=null?b:(l=x.results)==null?void 0:l.total_return)!=null?f:0)*100,precision:2,valueStyle:{color:((j=(z=(_=x.performance_metrics)==null?void 0:_.total_return)!=null?z:(D=x.results)==null?void 0:D.total_return)!=null?j:0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(Se,{title:"策略的年化收益率",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:(x.performance_metrics.annual_return||0)*100,precision:2,valueStyle:{color:(x.performance_metrics.annual_return||0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(Se,{title:"策略的最大回撤幅度",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:x.performance_metrics.max_drawdown*100,precision:2,valueStyle:{color:"#ff4d4f"},suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(Se,{title:"风险调整后的收益指标",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:x.performance_metrics.sharpe_ratio,precision:2})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["胜率 ",e.jsx(Se,{title:"盈利交易占总交易的比例",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:x.performance_metrics.win_rate*100,precision:2,suffix:"%"})})]}),e.jsxs(G,{gutter:16,style:{marginTop:24},children:[e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(Se,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:x.performance_metrics.profit_factor||0,precision:2})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Alpha ",e.jsx(Se,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2,suffix:"%"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Beta ",e.jsx(Se,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["最近一次交易时间 ",e.jsx(Se,{title:"最后一次交易的时间和方向",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:(()=>{const t=x.trade_records||[];if(t.length===0)return"-";const a=t[t.length-1],u=a==null?void 0:a.date,h=a==null?void 0:a.action,M=a==null?void 0:a.price;if(!u)return"-";const A=h==="BUY"?"买入":h==="SELL"?"卖出":h||"未知",R=M?` @ $${parseFloat(M).toFixed(2)}`:"";return`${I(u).format("MM-DD")} (${A}${R})`})()})})]})]}),e.jsx(us,{defaultActiveKey:"1",items:Me})]})}),e.jsx(Fe,{title:"更新回测数据",open:Ve,onOk:Ne,onCancel:()=>{He(!1),ft.resetFields()},confirmLoading:wt,okText:"更新",cancelText:"取消",width:600,children:e.jsxs(T,{form:ft,layout:"vertical",style:{marginTop:16},children:[e.jsx(T.Item,{label:"新回测名称",name:"new_name",rules:[{required:!0,message:"请输入新回测名称"}],children:e.jsx(ke,{placeholder:"请输入新回测名称"})}),e.jsx(T.Item,{label:"更新到日期",name:"update_to_date",extra:"留空则自动更新到最新可用数据（通常是昨天）",children:e.jsx(Wt,{style:{width:"100%"},placeholder:"选择更新截止日期（可选）",format:"YYYY-MM-DD"})}),e.jsx(T.Item,{label:"回测描述",name:"new_description",extra:"可选：更新回测的描述信息",children:e.jsx(ke.TextArea,{placeholder:"请输入回测描述（可选）",rows:3})}),Ce&&e.jsx(xt,{message:"更新说明",description:e.jsxs("div",{children:[e.jsx("p",{children:"• 将基于原回测的配置（策略、参数、仓位配置等）重新运行回测"}),e.jsxs("p",{children:["• 起始日期保持原回测的起始日期：",Ce.start_date]}),e.jsx("p",{children:"• 结束日期将更新到您选择的日期，如不选择则自动更新到最新可用数据"}),e.jsx("p",{children:"• 将创建新的回测记录，原回测记录保持不变"})]}),type:"info",showIcon:!0,style:{marginBottom:16}})]})}),e.jsx(Fe,{title:"策略执行日志",open:Ke,onCancel:()=>yt(!1),footer:[e.jsx(L,{onClick:()=>yt(!1),children:"关闭"},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"500px",overflowY:"auto"},children:tt.length>0?e.jsx("div",{style:{fontFamily:"monospace",fontSize:"12px"},children:tt.map((t,a)=>e.jsxs("div",{style:{marginBottom:"8px",padding:"8px 12px",backgroundColor:t.level==="ERROR"?"#fff2f0":t.level==="WARNING"?"#fffbe6":t.level==="DEBUG"?"#f6ffed":"#fafafa",border:`1px solid ${t.level==="ERROR"?"#ffccc7":t.level==="WARNING"?"#ffe58f":t.level==="DEBUG"?"#d9f7be":"#d9d9d9"}`,borderRadius:"4px"},children:[e.jsxs("div",{style:{color:t.level==="ERROR"?"#cf1322":t.level==="WARNING"?"#d46b08":t.level==="DEBUG"?"#52c41a":"#595959",fontWeight:"bold",marginBottom:"4px"},children:["[",t.timestamp,"] ",t.level]}),e.jsx("div",{style:{color:"#262626",whiteSpace:"pre-wrap"},children:t.message})]},a))}):e.jsxs("div",{style:{textAlign:"center",color:"#999",padding:"40px 0"},children:[e.jsx(Ms,{style:{fontSize:"48px",marginBottom:"16px"}}),e.jsx("div",{children:"暂无策略执行日志"}),e.jsx("div",{style:{fontSize:"12px",marginTop:"8px"},children:"策略中可以使用 log() 函数记录执行过程"})]})})})]})});var is=(n,r,l)=>new Promise((b,f)=>{var _=j=>{try{z(l.next(j))}catch(k){f(k)}},D=j=>{try{z(l.throw(j))}catch(k){f(k)}},z=j=>j.done?b(j.value):Promise.resolve(j.value).then(_,D);z((l=l.apply(n,r)).next())});Ls([Ps,Fs,Os,Ns,Ts,Rs,Ys,Es]);const{Title:ja,Text:Bn}=Nt,qn=()=>{const{id:n}=_a(),r=Zt(),[l,b]=o.useState(!1),[f,_]=o.useState(null),[D,z]=o.useState([]),[j,k]=o.useState(!1),[Y,Q]=o.useState(null),[V,$e]=o.useState(!1),Te=()=>is(void 0,null,function*(){if(n){b(!0);try{const O=yield q.get(`/api/backtest-status/${n}`);O.data.status==="success"?_(O.data.data):d.error("获取回测状态失败")}catch(O){console.error("获取回测状态失败:",O),d.error("获取回测状态失败")}finally{b(!1)}}}),ue=()=>is(void 0,null,function*(){if(n){b(!0);try{const O=yield q.get(`/api/backtest-status/${n}/history`);z(O.data)}catch(O){console.error("获取回测历史失败:",O),d.error("获取回测历史失败")}finally{b(!1)}}}),Z=O=>is(void 0,null,function*(){$e(!0);try{const x=D.find(Re=>Re.id===O);x&&(Q(x),k(!0))}catch(x){console.error("获取历史记录详情失败:",x),d.error("获取历史记录详情失败")}finally{$e(!1)}}),pe=O=>is(void 0,null,function*(){n&&Fe.confirm({title:"确认删除",content:"此操作将永久删除该历史记录，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>is(void 0,null,function*(){try{const x=yield q.delete(`/api/backtest-status/${n}/history/${O}`);x.data.status==="success"?(d.success("删除成功"),Y&&Y.id===O&&(k(!1),Q(null)),ue()):d.error(x.data.message||"删除失败")}catch(x){console.error("删除历史记录失败:",x),d.error("删除失败，请重试")}})})}),P=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:"回测期间",key:"period",render:(O,x)=>e.jsxs("div",{children:[e.jsx("div",{children:I(x.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#666",fontSize:"12px"},children:["至 ",I(x.end_date).format("YYYY-MM-DD")]})]})},{title:"初始资金",dataIndex:"initial_capital",key:"initial_capital",render:O=>`$${O.toLocaleString()}`},{title:"状态",dataIndex:"status",key:"status",render:O=>e.jsx(Pe,{color:O==="completed"?"green":O==="running"?"blue":"red",children:O==="completed"?"已完成":O==="running"?"运行中":"失败"})},{title:"收益率",dataIndex:"total_return",key:"total_return",render:O=>e.jsxs("span",{style:{color:O>=0?"#52c41a":"#ff4d4f"},children:[O>=0?"+":"",O.toFixed(2),"%"]})},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:O=>e.jsxs("span",{style:{color:"#ff4d4f"},children:[O.toFixed(2),"%"]})},{title:"操作类型",dataIndex:"operation_type",key:"operation_type",render:O=>e.jsx(Pe,{color:O==="create"?"blue":"orange",children:O==="create"?"创建":O==="update"?"更新":"重新运行"})},{title:"创建时间",dataIndex:"created_at",key:"created_at",render:O=>I(O).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",render:(O,x)=>e.jsxs(De,{children:[e.jsx(L,{type:"link",icon:e.jsx(qs,{}),onClick:()=>Z(x.id),loading:V,children:"查看"}),e.jsx(L,{type:"link",danger:!0,icon:e.jsx(ns,{}),onClick:()=>pe(x.id),children:"删除"})]})}];return o.useEffect(()=>{Te(),ue()},[n]),f?e.jsxs("div",{style:{padding:"24px"},children:[e.jsx(oe,{style:{marginBottom:"16px"},children:e.jsxs(De,{children:[e.jsx(L,{icon:e.jsx(Aa,{}),onClick:()=>r("/backtest/history"),children:"返回列表"}),e.jsxs(ja,{level:3,style:{margin:0},children:[e.jsx(ds,{})," ",f.name," - 历史记录"]})]})}),e.jsx(oe,{title:"当前状态概览",style:{marginBottom:"16px"},children:e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:6,children:e.jsx(ge,{title:"策略名称",value:f.strategy_name||"未知"})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:"回测期间",value:`${I(f.start_date).format("YYYY-MM-DD")} 至 ${I(f.end_date).format("YYYY-MM-DD")}`})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:"初始资金",value:`$${f.initial_capital.toLocaleString()}`})}),e.jsx(y,{span:6,children:e.jsx(ge,{title:"当前收益率",value:f.total_return,precision:2,suffix:"%",valueStyle:{color:f.total_return>=0?"#52c41a":"#ff4d4f"}})})]})}),e.jsx(oe,{title:e.jsxs(De,{children:[e.jsx(ds,{}),e.jsx("span",{children:"历史记录"})]}),extra:e.jsx(L,{icon:e.jsx(Bs,{}),onClick:ue,loading:l,children:"刷新"}),children:e.jsx(ts,{columns:P,dataSource:D,rowKey:"id",loading:l,pagination:{pageSize:it.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:(O,x)=>`第 ${x[0]}-${x[1]} 条，共 ${O} 条`,onChange:(O,x)=>{it.setCurrentPage(O),it.setPageSize(x||20)},onShowSizeChange:(O,x)=>{it.setPageSize(x)}},scroll:{x:1200}})}),e.jsx(Fe,{title:"历史记录详情",open:j,onCancel:()=>k(!1),footer:[e.jsx(L,{onClick:()=>k(!1),children:"关闭"},"close")],width:800,children:Y&&e.jsxs("div",{children:[e.jsxs(pt,{bordered:!0,column:2,children:[e.jsx(pt.Item,{label:"记录ID",children:Y.id}),e.jsx(pt.Item,{label:"操作类型",children:e.jsx(Pe,{color:Y.operation_type==="create"?"blue":"orange",children:Y.operation_type==="create"?"创建":"更新"})}),e.jsxs(pt.Item,{label:"回测期间",span:2,children:[I(Y.start_date).format("YYYY-MM-DD")," 至 ",I(Y.end_date).format("YYYY-MM-DD")]}),e.jsxs(pt.Item,{label:"初始资金",children:["$",Y.initial_capital.toLocaleString()]}),e.jsx(pt.Item,{label:"状态",children:e.jsx(Pe,{color:Y.status==="completed"?"green":"red",children:Y.status==="completed"?"已完成":"失败"})}),e.jsx(pt.Item,{label:"收益率",children:e.jsxs("span",{style:{color:Y.total_return>=0?"#52c41a":"#ff4d4f"},children:[Y.total_return>=0?"+":"",Y.total_return.toFixed(2),"%"]})}),e.jsx(pt.Item,{label:"最大回撤",children:e.jsxs("span",{style:{color:"#ff4d4f"},children:[Y.max_drawdown.toFixed(2),"%"]})}),e.jsx(pt.Item,{label:"创建时间",children:I(Y.created_at).format("YYYY-MM-DD HH:mm:ss")}),e.jsx(pt.Item,{label:"完成时间",children:Y.completed_at?I(Y.completed_at).format("YYYY-MM-DD HH:mm:ss"):"未完成"})]}),Y.performance_metrics&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(ja,{level:5,children:"性能指标"}),e.jsxs(G,{gutter:16,children:[e.jsx(y,{span:8,children:e.jsx(ge,{title:"累计收益",value:Y.total_return!==void 0?Y.total_return:(Y.performance_metrics.total_return||0)*100,precision:2,suffix:"%"})}),e.jsx(y,{span:8,children:e.jsx(ge,{title:"夏普比率",value:Y.performance_metrics.sharpe_ratio||0,precision:3})}),e.jsx(y,{span:8,children:e.jsx(ge,{title:"波动率",value:Y.performance_metrics.volatility||0,precision:2,suffix:"%"})}),e.jsx(y,{span:8,children:e.jsx(ge,{title:"胜率",value:Y.performance_metrics.win_rate||0,precision:2,suffix:"%"})})]})]})]})})]}):e.jsx("div",{style:{padding:"24px"},children:e.jsx(oe,{loading:l,children:e.jsx("div",{style:{textAlign:"center",padding:"50px"},children:e.jsx(Bn,{children:"加载中..."})})})})};const{Content:Vn}=as,Hn=()=>e.jsx(La,{locale:Pa,theme:Fa,children:e.jsx(yr,{children:e.jsx(Va,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(as,{style:{minHeight:"100vh"},children:[e.jsx(_r,{}),e.jsxs(as,{children:[e.jsx(Sr,{}),e.jsx(as,{style:{padding:"24px"},children:e.jsx(Vn,{style:{padding:24,margin:0,minHeight:280,background:"#fff",borderRadius:"8px"},children:e.jsxs(Ha,{children:[e.jsx(kt,{path:"/",element:e.jsx(Ka,{to:"/dashboard",replace:!0})}),e.jsx(kt,{path:"/dashboard",element:e.jsx(Lr,{})}),e.jsx(kt,{path:"/data",element:e.jsx(Ea,{})}),e.jsx(kt,{path:"/strategy",element:e.jsx(Tn,{})}),e.jsx(kt,{path:"/strategy/edit",element:e.jsx(ya,{})}),e.jsx(kt,{path:"/strategy/edit/:id",element:e.jsx(ya,{})}),e.jsx(kt,{path:"/strategy/builder",element:e.jsx(Xr,{})}),e.jsx(kt,{path:"/backtest",element:e.jsx(yn,{})}),e.jsx(kt,{path:"/backtest/history",element:e.jsx(En,{})}),e.jsx(kt,{path:"/backtest-history/:id",element:e.jsx(qn,{})}),e.jsx(kt,{path:"/optimization",element:e.jsx($n,{})}),e.jsx(kt,{path:"/ai-investment",element:e.jsx(On,{})})]})})})]})]})})})});Ca.locale("en-gb");q.defaults.baseURL="http://localhost:8001";Ua.createRoot(document.getElementById("root")).render(e.jsx(Wa.StrictMode,{children:e.jsx(La,{locale:Pa,theme:Fa,children:e.jsx(Hn,{})})}));
