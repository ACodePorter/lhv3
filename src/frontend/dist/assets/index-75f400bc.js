import{k as e,L as Xt,r as o,u as Jt,l as ba,E as va,m as qa,n as _a,B as Va,o as Ha,p as St,N as Ka,q as Ua,R as Wa}from"./react-vendor-6f13ff9c.js";import{L as Lt,M as ts,B as P,G as Ga,z as rs,C as Za,D as wa,F as Sa,H as As,I as js,R as Ja,J as ds,K as ns,N as J,O as x,P as oe,Q as xe,T as Qa,U as Xa,V as er,W as tr,X as Dt,Y as Tt,Z as q,$ as ss,a0 as $,a1 as $e,a2 as F,a3 as Le,a4 as ka,a5 as as,a6 as us,a7 as Re,a8 as Hs,a9 as ks,aa as we,ab as Ye,ac as Gt,ad as sr,ae as d,af as ar,ag as rr,ah as nr,ai as ps,aj as lr,ak as $a,al as Ia,am as Ls,an as Ca,ao as Ps,ap as Fs,aq as Ns,ar as Os,as as Ts,at as Rs,au as or,av as ir,aw as cr,ax as Ys,ay as dr,az as Es,aA as Bt,aB as xt,aC as ur,aD as _e,aE as Je,aF as Wt,aG as gs,aH as Da,aI as za,aJ as Bs,aK as Ma,aL as Et,aM as Ms,aN as pr,aO as qs,aP as hr,aQ as Ks,aR as mr,aS as Us,aT as fr,aU as xr,aV as Aa,aW as gr,aX as ut,aY as La,aZ as Pa,a_ as yr}from"./vendor-7d963d80.js";import{M as jr}from"./monaco-313743a9.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const m of document.querySelectorAll('link[rel="modulepreload"]'))b(m);new MutationObserver(m=>{for(const w of m)if(w.type==="childList")for(const z of w.addedNodes)z.tagName==="LINK"&&z.rel==="modulepreload"&&b(z)}).observe(document,{childList:!0,subtree:!0});function l(m){const w={};return m.integrity&&(w.integrity=m.integrity),m.referrerPolicy&&(w.referrerPolicy=m.referrerPolicy),m.crossOrigin==="use-credentials"?w.credentials="include":m.crossOrigin==="anonymous"?w.credentials="omit":w.credentials="same-origin",w}function b(m){if(m.ep)return;m.ep=!0;const w=l(m);fetch(m.href,w)}})();const Fa={token:{colorPrimary:"#1890ff",borderRadius:8,colorBgContainer:"#ffffff",fontSize:12,fontSizeSM:11,fontSizeLG:14,fontSizeXL:16},components:{Table:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Card:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Button:{borderRadius:6,fontSize:12},Typography:{fontSize:12},Form:{fontSize:12},Input:{fontSize:12},Select:{fontSize:12},Menu:{fontSize:12}}},{Header:br}=rs,{useToken:vr}=Za,_r=()=>{const{token:n}=vr(),r=[{key:"/",icon:e.jsx(wa,{}),label:e.jsx(Xt,{to:"/",children:"首页"})},{key:"/data",icon:e.jsx(Sa,{}),label:e.jsx(Xt,{to:"/data",children:"数据管理"})},{key:"/strategy",icon:e.jsx(As,{}),label:e.jsx(Xt,{to:"/strategy",children:"策略编辑"})},{key:"/backtest",icon:e.jsx(Lt,{}),label:e.jsx(Xt,{to:"/backtest",children:"回测分析"})},{key:"/optimization",icon:e.jsx(js,{}),label:e.jsx(Xt,{to:"/optimization",children:"参数优化"})}];return e.jsxs(br,{style:{background:n.colorBgContainer,padding:"0 24px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx("div",{className:"header-nav-logo",children:e.jsxs(Xt,{to:"/",style:{color:n.colorPrimary,fontSize:"18px",fontWeight:"bold",display:"flex",alignItems:"center"},children:[e.jsx(Lt,{style:{marginRight:"8px",fontSize:"24px"}}),"量化交易系统"]})}),e.jsx(ts,{className:"header-nav-menu",mode:"horizontal",selectedKeys:[window.location.pathname],style:{flex:1,marginLeft:"40px",borderBottom:"none"},items:r}),e.jsx("div",{children:e.jsx(P,{icon:e.jsx(Ga,{}),type:"text",href:"https://github.com/yourusername/quant-trading-system",target:"_blank",rel:"noopener noreferrer",children:"GitHub"})})]})},{Sider:wr}=rs,Sr=()=>{const[n,r]=o.useState(!1),l=Jt(),b=ba(),m=[{key:"/",icon:e.jsx(wa,{}),label:"首页"},{key:"/data",icon:e.jsx(Sa,{}),label:"数据管理"},{key:"/strategy",icon:e.jsx(As,{}),label:"策略编辑"},{key:"/ai-investment",icon:e.jsx(Ja,{}),label:"AI实时投资跑数"},{key:"backtest",icon:e.jsx(Lt,{}),label:"回测管理",children:[{key:"/backtest",icon:e.jsx(Lt,{}),label:"回测分析"},{key:"/backtest/history",icon:e.jsx(ds,{}),label:"回测历史"}]},{key:"/optimization",icon:e.jsx(js,{}),label:"参数优化"}],w=z=>{l(z.key)};return e.jsxs(wr,{collapsible:!0,collapsed:n,onCollapse:z=>r(z),style:{background:"#fff"},width:200,children:[e.jsx("div",{className:"logo",style:{visibility:n?"hidden":"visible"},children:"量化交易系统"}),e.jsx(ts,{theme:"light",mode:"inline",selectedKeys:[b.pathname],items:m,onClick:w})]})};var kr=Object.defineProperty,$r=Object.defineProperties,Ir=Object.getOwnPropertyDescriptors,Ws=Object.getOwnPropertySymbols,Cr=Object.prototype.hasOwnProperty,Dr=Object.prototype.propertyIsEnumerable,Gs=(n,r,l)=>r in n?kr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,Zs=(n,r)=>{for(var l in r||(r={}))Cr.call(r,l)&&Gs(n,l,r[l]);if(Ws)for(var l of Ws(r))Dr.call(r,l)&&Gs(n,l,r[l]);return n},zr=(n,r)=>$r(n,Ir(r));const qt=o.memo(({option:n,loading:r=!1,height:l=400,lazyLoad:b=!0,threshold:m=.1,style:w,onChartReady:z,data:M,symbol:g,className:I,notMerge:R=!1,opts:X={renderer:"canvas"},onEvents:B})=>{const[Ie,Oe]=o.useState(!b),[pe,U]=o.useState(null),he=o.useRef(null),v=o.useRef(null),W=o.useMemo(()=>(ie,Te)=>{const Xe=[];for(let ce=0,et=Te.length;ce<et;ce++){if(ce<ie-1){Xe.push("-");continue}let te=0;for(let Pe=0;Pe<ie;Pe++)te+=Te[ce-Pe].close;Xe.push((te/ie).toFixed(2))}return Xe},[]),j=o.useMemo(()=>!M||M.length===0?{}:{backgroundColor:"#fff",title:{text:g,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:M.map(ie=>ie.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:M.map(ie=>ie.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:M.map(ie=>[ie.open,ie.close,ie.low,ie.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:W(5,M),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:W(10,M),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:M.map((ie,Te)=>[Te,ie.volume,ie.close>ie.open?1:-1])}]},[M,g,W]),Ve=o.useMemo(()=>{const ie=n||j;return!ie||Object.keys(ie).length===0?{}:zr(Zs({},ie),{animation:!1,progressive:1e3,progressiveThreshold:3e3,useUTC:!0})},[n,j]);o.useEffect(()=>{if(!b||Ie)return;const ie=he.current;if(ie)return v.current=new IntersectionObserver(Te=>{var Xe;const[ce]=Te;ce.isIntersecting&&(Oe(!0),(Xe=v.current)==null||Xe.disconnect())},{threshold:m}),v.current.observe(ie),()=>{var Te;(Te=v.current)==null||Te.disconnect()}},[b,Ie,m]);const Se=ie=>{U(ie),z==null||z(ie)};return b&&!Ie?e.jsx("div",{ref:he,style:Zs({height:l,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#fafafa",border:"1px dashed #d9d9d9"},w),children:e.jsxs("div",{style:{textAlign:"center",color:"#999"},children:[e.jsx("div",{children:"图表懒加载中..."}),e.jsx("div",{style:{fontSize:"12px",marginTop:"4px"},children:"滚动到此处将自动加载"})]})}):e.jsx("div",{ref:he,style:w,children:e.jsx(ns,{spinning:r,tip:"图表加载中...",children:e.jsx(va,{className:I,option:Ve,style:{height:l},onChartReady:Se,notMerge:R,opts:X,onEvents:B})})})});qt.displayName="OptimizedChart";const{Title:Mr,Paragraph:Ar}=Tt,Lr=o.memo(()=>{const n=o.useMemo(()=>[{name:"上证指数",value:3536.24,change:.84,color:"#f5222d"},{name:"深证成指",value:14672.16,change:1.26,color:"#f5222d"},{name:"创业板指",value:3213.84,change:1.78,color:"#f5222d"},{name:"恒生指数",value:26386.25,change:-.13,color:"#52c41a"}],[]),r=o.useMemo(()=>[{id:1,name:"移动平均交叉策略",symbol:"AAPL",return:12.5,date:"2023-09-15"},{id:2,name:"RSI策略",symbol:"MSFT",return:8.3,date:"2023-09-14"},{id:3,name:"MACD策略",symbol:"GOOGL",return:-2.1,date:"2023-09-13"},{id:4,name:"布林带策略",symbol:"AMZN",return:5.7,date:"2023-09-12"}],[]),l=o.useMemo(()=>({title:{text:"策略绩效比较",left:"center"},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{data:["移动平均交叉","RSI策略","MACD策略","布林带策略","沪深300"],bottom:10},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:["1月","2月","3月","4月","5月","6月","7月","8月","9月"]},yAxis:{type:"value",name:"累计收益率(%)",axisLabel:{formatter:"{value}%"}},series:[{name:"移动平均交叉",type:"line",data:[0,2.3,5.8,9.2,12.5,15.1,18.6,22.4,25.2]},{name:"RSI策略",type:"line",data:[0,1.5,3.8,6.2,8.5,10.1,12.6,14.4,16.2]},{name:"MACD策略",type:"line",data:[0,-1.3,1.8,3.2,5.5,8.1,10.6,13.4,15.2]},{name:"布林带策略",type:"line",data:[0,3.3,2.8,5.2,8.5,12.1,15.6,18.4,21.2]},{name:"沪深300",type:"line",data:[0,1.3,2.8,3.2,2.5,4.1,5.6,4.4,6.2],lineStyle:{type:"dashed"}}]}),[]),b=o.useMemo(()=>({title:{text:"最优资产配置",left:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:10,data:["股票","债券","商品","外汇","现金"]},series:[{name:"资产配置",type:"pie",radius:["50%","70%"],avoidLabelOverlap:!1,label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:"18",fontWeight:"bold"}},labelLine:{show:!1},data:[{value:45,name:"股票"},{value:25,name:"债券"},{value:15,name:"商品"},{value:10,name:"外汇"},{value:5,name:"现金"}]}]}),[]);return e.jsxs("div",{children:[e.jsx(Mr,{level:2,children:"仪表盘"}),e.jsx(Ar,{children:"欢迎使用量化交易系统，您可以在这里查看市场概况和您的策略表现。"}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(oe,{children:e.jsx(xe,{title:"本月最佳策略",value:"移动平均交叉",prefix:e.jsx(Qa,{}),valueStyle:{color:"#3f8600"}})})}),e.jsx(x,{span:6,children:e.jsx(oe,{children:e.jsx(xe,{title:"最佳策略收益",value:25.2,precision:2,valueStyle:{color:"#3f8600"},prefix:e.jsx(Xa,{}),suffix:"%"})})}),e.jsx(x,{span:6,children:e.jsx(oe,{children:e.jsx(xe,{title:"最差策略收益",value:-2.1,precision:2,valueStyle:{color:"#cf1322"},prefix:e.jsx(er,{}),suffix:"%"})})}),e.jsx(x,{span:6,children:e.jsx(oe,{children:e.jsx(xe,{title:"策略总数",value:8,prefix:e.jsx(tr,{})})})})]}),e.jsxs(J,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(x,{span:12,children:e.jsx(oe,{title:"主要市场指数",extra:e.jsx(P,{type:"link",children:"查看更多"}),children:e.jsx(Dt,{dataSource:n,renderItem:m=>e.jsxs(Dt.Item,{children:[e.jsx(Dt.Item.Meta,{title:m.name}),e.jsx("div",{children:m.value}),e.jsxs("div",{style:{color:m.color,marginLeft:"16px"},children:[m.change>0?"+":"",m.change,"%"]})]})})})}),e.jsx(x,{span:12,children:e.jsx(oe,{title:"最近的回测",extra:e.jsx(P,{type:"link",children:"查看全部"}),children:e.jsx(Dt,{dataSource:r,renderItem:m=>e.jsxs(Dt.Item,{children:[e.jsx(Dt.Item.Meta,{title:m.name,description:`${m.symbol} | ${m.date}`}),e.jsxs("div",{style:{color:m.return>0?"#3f8600":"#cf1322",fontWeight:"bold"},children:[m.return>0?"+":"",m.return,"%"]})]})})})})]}),e.jsxs(J,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(x,{span:16,children:e.jsx(oe,{title:"策略绩效比较",extra:e.jsx(P,{type:"link",icon:e.jsx(Lt,{}),children:"详细分析"}),children:e.jsx("div",{className:"chart-container",children:e.jsx(qt,{option:l,style:{height:"100%"}})})})}),e.jsx(x,{span:8,children:e.jsx(oe,{title:"最优资产配置",children:e.jsx("div",{className:"chart-container",children:e.jsx(qt,{option:b,style:{height:"100%"}})})})})]})]})});var Vt=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});const bs=()=>Vt(void 0,null,function*(){try{const n=yield q.get("/api/data/stocks");return n.data&&Array.isArray(n.data)?n.data.map(r=>({id:r.id.toString(),symbol:r.symbol,name:r.name,type:r.type||"未知",exchange:r.exchange,source_id:r.source_id,data_count:r.data_count||0,last_updated:r.last_updated,first_date:r.first_date,last_date:r.last_date})):[]}catch(n){throw console.error("获取交易品种列表失败:",n),n}}),Na=()=>Vt(void 0,null,function*(){try{const n=yield q.get("/api/data/list");return n.data&&Array.isArray(n.data)?n.data:[]}catch(n){throw console.error("获取数据源列表失败:",n),n}}),Pr=n=>Vt(void 0,null,function*(){try{const r=yield q.get(`/api/data/chart/${n}`);return r.data&&r.data.data?r.data:{data:[]}}catch(r){throw console.error("获取图表数据失败:",r),r}});function Fr(n){return Vt(this,null,function*(){try{console.log("保存策略数据:",JSON.stringify(n,null,2));let r;if(n.id?r=yield q.put(`/api/strategies/${n.id}`,n):r=yield q.post("/api/strategies",n),console.log("策略保存响应:",r.data),r.data&&r.data.status==="success")return r.data.data;if(r.data)return r.data;throw new Error("保存策略失败，返回数据格式错误")}catch(r){throw console.error("保存策略时发生错误:",r),r}})}const cs=()=>Vt(void 0,null,function*(){try{const n=yield q.get("/api/strategies");return n.data&&n.data.data?n.data.data:[]}catch(n){throw console.error("获取策略列表失败:",n),n}}),Js=n=>Vt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略数据")}catch(r){throw console.error(`获取策略(ID:${n})详情失败:`,r),r}}),Oa=n=>Vt(void 0,null,function*(){try{yield q.delete(`/api/strategies/${n}`)}catch(r){throw console.error(`删除策略(ID:${n})失败:`,r),r}}),Nr=n=>Vt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/templates/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略模板数据")}catch(r){throw console.error(`获取策略模板(ID:${n})详情失败:`,r),r}}),Or=n=>Vt(void 0,null,function*(){try{const r=yield q.get(`/api/data/stock/${n}/date-range`);if(r.data)return r.data;throw new Error("未找到股票日期范围数据")}catch(r){throw console.error(`获取股票(ID:${n})日期范围失败:`,r),r}}),Qs=(n,r,l=30)=>{const b=new Date;b.setTime(b.getTime()+l*24*60*60*1e3),document.cookie=`${n}=${r};expires=${b.toUTCString()};path=/`},Xs=n=>{const r=n+"=",l=document.cookie.split(";");for(let b=0;b<l.length;b++){let m=l[b];for(;m.charAt(0)===" ";)m=m.substring(1,m.length);if(m.indexOf(r)===0)return m.substring(r.length,m.length)}return null},it={setPageSize:n=>{Qs("data_management_page_size",n.toString())},getPageSize:(n=15)=>{const r=Xs("data_management_page_size");return r?parseInt(r,10):n},setCurrentPage:n=>{Qs("data_management_current_page",n.toString())},getCurrentPage:(n=1)=>{const r=Xs("data_management_current_page");return r?parseInt(r,10):n}};function Tr(n,r){const[l,b]=o.useState(n);return o.useEffect(()=>{const m=setTimeout(()=>{b(n)},r);return()=>{clearTimeout(m)}},[n,r]),l}var Rr=Object.defineProperty,Yr=Object.defineProperties,Er=Object.getOwnPropertyDescriptors,ys=Object.getOwnPropertySymbols,Ta=Object.prototype.hasOwnProperty,Ra=Object.prototype.propertyIsEnumerable,ea=(n,r,l)=>r in n?Rr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,hs=(n,r)=>{for(var l in r||(r={}))Ta.call(r,l)&&ea(n,l,r[l]);if(ys)for(var l of ys(r))Ra.call(r,l)&&ea(n,l,r[l]);return n},ta=(n,r)=>Yr(n,Er(r)),Br=(n,r)=>{var l={};for(var b in n)Ta.call(n,b)&&r.indexOf(b)<0&&(l[b]=n[b]);if(n!=null&&ys)for(var b of ys(n))r.indexOf(b)<0&&Ra.call(n,b)&&(l[b]=n[b]);return l};const Zt=o.memo(n=>{var r=n,{virtualScroll:l=!1,itemHeight:b=54,maxHeight:m=400,dataSource:w=[],columns:z=[]}=r,M=Br(r,["virtualScroll","itemHeight","maxHeight","dataSource","columns"]);const g=o.useMemo(()=>z.map(X=>ta(hs({},X),{ellipsis:X.ellipsis!==!1})),[z]),I=o.useMemo(()=>w||[],[w]),R=o.useMemo(()=>hs({size:"middle",scroll:{x:"max-content",y:m},pagination:hs({showSizeChanger:!0,showQuickJumper:!0,showTotal:(X,B)=>`第 ${B[0]}-${B[1]} 条，共 ${X} 条`},M.pagination)},M),[m,M]);return e.jsx("div",{className:"optimized-table-container",children:e.jsx(ss,ta(hs({},R),{columns:g,dataSource:I,className:`optimized-table ${M.className||""}`}))})});Zt.displayName="OptimizedTable";var qr=Object.defineProperty,Vr=Object.defineProperties,Hr=Object.getOwnPropertyDescriptors,sa=Object.getOwnPropertySymbols,Kr=Object.prototype.hasOwnProperty,Ur=Object.prototype.propertyIsEnumerable,aa=(n,r,l)=>r in n?qr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,ra=(n,r)=>{for(var l in r||(r={}))Kr.call(r,l)&&aa(n,l,r[l]);if(sa)for(var l of sa(r))Ur.call(r,l)&&aa(n,l,r[l]);return n},na=(n,r)=>Vr(n,Hr(r)),kt=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});const{Title:Wr,Text:Gr}=Tt,{Option:jt}=Ye,Ya=o.memo(({onSelect:n})=>{const r=o.useMemo(()=>[{label:"最近7天",days:7},{label:"最近30天",days:30},{label:"最近90天",days:90},{label:"最近180天",days:180},{label:"最近1年",days:365},{label:"最近2年",days:730},{label:"最近3年",days:1095},{label:"最近4年",days:1460},{label:"最近5年",days:1825},{label:"最近10年",days:3650},{label:"今年",type:"year"},{label:"去年",type:"lastYear"},{label:"本月",type:"month"},{label:"上月",type:"lastMonth"}],[]),l=o.useCallback(b=>{const m=$();let w,z;b.type==="year"?(w=m.startOf("year").format("YYYY-MM-DD"),z=m.format("YYYY-MM-DD")):b.type==="lastYear"?(w=m.subtract(1,"year").startOf("year").format("YYYY-MM-DD"),z=m.subtract(1,"year").endOf("year").format("YYYY-MM-DD")):b.type==="month"?(w=m.startOf("month").format("YYYY-MM-DD"),z=m.format("YYYY-MM-DD")):b.type==="lastMonth"?(w=m.subtract(1,"month").startOf("month").format("YYYY-MM-DD"),z=m.subtract(1,"month").endOf("month").format("YYYY-MM-DD")):(w=m.subtract(b.days,"day").format("YYYY-MM-DD"),z=m.format("YYYY-MM-DD")),n(w,z)},[n]);return e.jsx($e,{wrap:!0,children:r.map((b,m)=>e.jsx(P,{size:"small",onClick:()=>l(b),children:b.label},m))})});Ya.displayName="DateRangePresets";const la=(n,r)=>{const l=[];for(let b=0,m=r.length;b<m;b++){if(b<n-1){l.push("-");continue}let w=0;for(let z=0;z<n;z++)w+=r[b-z].close;l.push((w/n).toFixed(2))}return l},Ea=o.memo(()=>{const[n,r]=o.useState([]),[l,b]=o.useState([]),[m,w]=o.useState(!1),[z,M]=o.useState(!1),[g,I]=o.useState([]),[R]=F.useForm(),[X,B]=o.useState("fetch"),[Ie,Oe]=o.useState(!1),[pe,U]=o.useState(!1),he=o.useRef(!1),[v,W]=o.useState({current:it.getCurrentPage(),pageSize:it.getPageSize(),total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(k,f)=>`第 ${f[0]}-${f[1]} 条，共 ${k} 条`,pageSizeOptions:["10","15","20","50","100"]}),[j,Ve]=o.useState(!1),[Se,ie]=o.useState(null),[Te,Xe]=o.useState([]),[ce,et]=o.useState(!1),[te,Pe]=o.useState("");Tr(te,300);const ge=o.useCallback((...k)=>kt(void 0,[...k],function*(f=it.getCurrentPage(),_=it.getPageSize()){w(!0);try{const re=(yield bs()).map(G=>{var Fe;return{id:G.id.toString(),symbol:G.symbol,name:G.name,type:G.type||"未知",exchange:G.exchange,records:G.data_count||0,source:((Fe=G.source_id)==null?void 0:Fe.toString())||"未知",last_updated:G.last_updated?new Date(G.last_updated).toLocaleString():"未知",first_date:G.first_date||void 0,last_date:G.last_date||void 0}});W(G=>na(ra({},G),{current:f,pageSize:_,total:re.length})),r(re)}catch(V){console.error("获取数据列表失败:",V),d.error("获取数据列表失败，请检查网络连接")}finally{w(!1)}}),[]),rt=o.useCallback(()=>kt(void 0,null,function*(){try{const k=yield Na();if(b(k),X==="fetch"){const f=k.find(_=>_.name==="AkShare抓取");f&&R.setFieldsValue({source_id:f.id})}else if(X==="upload"){const f=k.find(_=>_.name==="用户上传");f&&R.setFieldsValue({source_id:f.id})}}catch(k){console.error("获取数据源列表失败:",k),d.error("获取数据源列表失败")}}),[X,R]),zt=o.useCallback(k=>{const{current:f,pageSize:_}=k;it.setCurrentPage(f),it.setPageSize(_),ge(f,_)},[ge]),ct=o.useCallback(k=>kt(void 0,null,function*(){w(!0);try{const f=yield q.get(`/api/data/download/${k}`,{responseType:"blob"}),_=window.URL.createObjectURL(new Blob([f.data])),V=document.createElement("a");V.href=_;const re=f.headers["content-disposition"];let G="stock_data.csv";if(re){const Fe=re.match(/filename="?(.+)"?/);Fe&&Fe.length===2&&(G=Fe[1])}V.setAttribute("download",G),document.body.appendChild(V),V.click(),document.body.removeChild(V),d.success("数据下载成功")}catch(f){console.error("下载失败:",f),d.error("下载失败，请重试")}finally{w(!1)}}),[]),[qe,We]=o.useState([]),ze=o.useCallback((k,f)=>kt(void 0,null,function*(){var _,V,re;We(G=>G.includes(k)?G:[...G,k]);try{const Fe=(_=(yield q.post(`/api/data/update/${k}/async`)).data)==null?void 0:_.task_id;if(!Fe){d.error("任务提交失败：未返回任务ID"),We(Ge=>Ge.filter(nt=>nt!==k));return}d.success(f?`${f}：更新任务已启动`:"更新任务已启动");const st=()=>kt(void 0,null,function*(){var Ge,nt;try{const Ne=yield q.get(`/api/data/update-tasks/${Fe}`),t=(Ge=Ne.data)==null?void 0:Ge.status,a=(nt=Ne.data)==null?void 0:nt.message;t==="completed"?(d.success(a||(f?`${f} 更新完成`:"更新完成")),clearInterval(Ee),yield ge(v.current,v.pageSize),We(u=>u.filter(p=>p!==k))):t==="failed"&&(d.error(a||(f?`${f} 更新失败`:"更新失败")),clearInterval(Ee),We(u=>u.filter(p=>p!==k)))}catch(Ne){console.error("查询任务状态失败:",Ne)}}),Ee=window.setInterval(st,2e3)}catch(G){console.error("提交异步更新失败:",G);const Fe=(re=(V=G.response)==null?void 0:V.data)==null?void 0:re.detail;d.error(Fe||"提交异步更新失败"),We(st=>st.filter(Ee=>Ee!==k))}}),[ge,v.current,v.pageSize]),bt=o.useMemo(()=>[{title:"代码",dataIndex:"symbol",key:"symbol",width:100},{title:"名称",dataIndex:"name",key:"name",width:120},{title:"类型",dataIndex:"type",key:"type",width:80,render:k=>e.jsx(Le,{color:"blue",children:k})},{title:"交易所",dataIndex:"exchange",key:"exchange",width:80},{title:"记录数",dataIndex:"records",key:"records",width:80,sorter:(k,f)=>k.records-f.records},{title:"数据时间范围",key:"date_range",width:200,render:(k,f)=>f.first_date&&f.last_date?e.jsx("div",{children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:[f.first_date," 至 ",f.last_date]})}):e.jsx("span",{style:{color:"#999"},children:"暂无数据"})},{title:"数据源",dataIndex:"source",key:"source",width:100},{title:"最后更新",dataIndex:"last_updated",key:"last_updated",width:150},{title:"操作",key:"action",width:360,render:(k,f)=>e.jsxs($e,{size:"small",children:[e.jsx(P,{type:"primary",icon:e.jsx(ka,{}),size:"small",onClick:()=>ct(f.id),children:"下载"}),e.jsx(P,{icon:e.jsx(Lt,{}),size:"small",onClick:()=>ft(f),children:"K线图"}),e.jsx(P,{icon:e.jsx(as,{}),size:"small",loading:qe.includes(f.id),disabled:qe.includes(f.id),onClick:()=>ze(f.id,f.symbol),children:"更新"}),e.jsx(P,{danger:!0,icon:e.jsx(us,{}),size:"small",onClick:()=>pt(f.id),children:"删除"})]})}],[ze,qe]),vt={onRemove:()=>{I([])},beforeUpload:k=>(He(k)&&I([k]),!1),fileList:g},pt=o.useCallback(k=>kt(void 0,null,function*(){Re.confirm({title:"确认删除",content:"此操作将永久删除该数据，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>kt(void 0,null,function*(){var f;w(!0);try{const _=yield q.delete(`/api/data/delete/${k}`);_.data&&_.data.status==="success"?(d.success(_.data.message||"删除成功"),ge()):d.error(((f=_.data)==null?void 0:f.message)||"删除失败")}catch(_){console.error("删除失败:",_),d.error("删除失败，请重试")}finally{w(!1)}})})}),[ge]),ft=o.useCallback(k=>kt(void 0,null,function*(){ie(k),Ve(!0),et(!0);try{const f=yield Pr(k.id);console.log("API响应数据:",f);const _=f.data||f||[];console.log("处理后的数据:",_),Xe(_)}catch(f){console.error("获取图表数据失败:",f),d.error("获取图表数据失败")}finally{et(!1)}}),[]),He=k=>{const f=k.type==="text/csv"||k.name&&k.name.endsWith(".csv");return f||d.error("只能上传CSV文件!"),f},gt=k=>kt(void 0,null,function*(){var f,_,V,re;if(g.length===0){d.error("请选择要上传的文件");return}const G=new FormData;G.append("file",g[0]);const Fe=new URLSearchParams({symbol:k.symbol,name:k.name,type:k.type,source_id:((f=k.source_id)==null?void 0:f.toString())||""});k.exchange&&Fe.append("exchange",k.exchange);const st=`/api/data/upload?${Fe.toString()}`;w(!0);try{const Ee=yield q.post(st,G,{headers:{"Content-Type":"multipart/form-data"}});Ee.data&&Ee.data.status==="success"?(d.success(Ee.data.message||"上传成功"),M(!1),R.resetFields(),I([]),ge(v.current,v.pageSize)):d.error(((_=Ee.data)==null?void 0:_.message)||"上传失败")}catch(Ee){console.error("上传失败:",Ee);const Ge=(re=(V=Ee.response)==null?void 0:V.data)==null?void 0:re.detail;Ge?typeof Ge=="object"?d.error(JSON.stringify(Ge)):d.error(Ge):d.error("上传失败，请重试")}finally{w(!1)}}),tt=k=>kt(void 0,null,function*(){var f,_,V;Oe(!0);try{const re={symbol:k.symbol,name:k.name,type:k.type,source_id:k.source_id,start_date:k.start_date?k.start_date.format("YYYY-MM-DD"):void 0,end_date:k.end_date?k.end_date.format("YYYY-MM-DD"):void 0},G=yield q.post("/api/data/fetch",re,{headers:{"Content-Type":"application/json"}});G.data&&G.data.status==="success"?(d.success(G.data.message||"数据抓取成功"),M(!1),R.resetFields(),ge(v.current,v.pageSize)):d.error(((f=G.data)==null?void 0:f.message)||"数据抓取失败")}catch(re){console.error("数据抓取失败:",re);const G=(V=(_=re.response)==null?void 0:_.data)==null?void 0:V.detail;G?typeof G=="object"?d.error(JSON.stringify(G)):d.error(G):d.error("数据抓取失败，请重试")}finally{Oe(!1)}}),Ke=o.useCallback(()=>{Re.confirm({title:"一键更新确认",content:"确定要更新所有股票的最新数据吗？此操作可能需要较长时间。",okText:"确定更新",cancelText:"取消",onOk:()=>kt(void 0,null,function*(){var k,f,_;U(!0);try{const re=(k=(yield q.post("/api/data/update-all/async")).data)==null?void 0:k.task_id;if(!re){d.error("任务提交失败：未返回任务ID"),U(!1);return}d.success("一键更新任务已启动");const G=()=>kt(void 0,null,function*(){var st,Ee,Ge,nt;try{const Ne=yield q.get(`/api/data/update-all-tasks/${re}`),t=(st=Ne.data)==null?void 0:st.status,a=(Ee=Ne.data)==null?void 0:Ee.message,u=(Ge=Ne.data)==null?void 0:Ge.processed,p=(nt=Ne.data)==null?void 0:nt.total;typeof u=="number"&&typeof p=="number"&&d.info(`一键更新进度：${u}/${p}`,1),t==="completed"?(clearInterval(Fe),U(!1),d.success(a||"一键更新完成"),yield ge(v.current,v.pageSize)):t==="failed"&&(clearInterval(Fe),U(!1),d.error(a||"一键更新失败"))}catch(Ne){console.error("查询一键更新任务状态失败:",Ne)}}),Fe=window.setInterval(G,2e3)}catch(V){console.error("一键更新任务提交失败:",V);const re=(_=(f=V.response)==null?void 0:f.data)==null?void 0:_.detail;d.error(re||"一键更新任务提交失败"),U(!1)}})})},[ge]);return o.useEffect(()=>{he.current||(he.current=!0,ge(),rt())},[ge,rt]),e.jsxs("div",{className:"data-management",children:[e.jsxs(oe,{children:[e.jsxs(J,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[e.jsx(x,{children:e.jsx(Wr,{level:4,children:"市场数据管理"})}),e.jsx(x,{children:e.jsxs($e,{children:[e.jsx(P,{type:"primary",icon:e.jsx(Hs,{}),onClick:()=>M(!0),children:"添加数据"}),e.jsx(P,{type:"primary",icon:e.jsx(as,{}),loading:pe,onClick:Ke,style:{backgroundColor:"#52c41a",borderColor:"#52c41a"},children:"一键更新"}),e.jsx(P,{icon:e.jsx(as,{}),onClick:()=>ge(v.current,v.pageSize),children:"刷新列表"})]})})]}),e.jsx(ns,{spinning:m,children:e.jsx(Zt,{columns:bt,dataSource:n,rowKey:"id",bordered:!0,size:"middle",pagination:v,onChange:zt})})]}),e.jsxs(Re,{title:"市场数据管理",open:z,onCancel:()=>M(!1),footer:null,width:600,children:[e.jsx("div",{style:{marginBottom:20,textAlign:"center"},children:e.jsxs(ks.Group,{value:X,onChange:k=>{if(B(k.target.value),R.resetFields(),k.target.value==="fetch"){const f=l.find(_=>_.name==="AkShare抓取");f&&R.setFieldsValue({source_id:f.id})}else if(k.target.value==="upload"){const f=l.find(_=>_.name==="用户上传");f&&R.setFieldsValue({source_id:f.id})}},buttonStyle:"solid",children:[e.jsx(ks.Button,{value:"fetch",children:"自动抓取"}),e.jsx(ks.Button,{value:"upload",children:"手动上传"})]})}),e.jsxs(F,{form:R,layout:"vertical",onFinish:X==="fetch"?tt:gt,children:[X==="fetch"&&e.jsxs(e.Fragment,{children:[e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(we,{placeholder:"例如: AAPL, 600519, TSLA"})}),e.jsx(F.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(we,{placeholder:"例如: 苹果公司, 贵州茅台"})}),e.jsx(F.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Ye,{placeholder:"选择类型",children:[e.jsx(jt,{value:"A股",children:"A股"}),e.jsx(jt,{value:"港股",children:"港股"}),e.jsx(jt,{value:"美股",children:"美股"}),e.jsx(jt,{value:"期货",children:"期货"}),e.jsx(jt,{value:"指数",children:"指数"}),e.jsx(jt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(F.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Ye,{placeholder:"选择数据源",disabled:!0,children:l.filter(k=>k.name==="AkShare抓取").map(k=>e.jsx(jt,{value:k.id,children:k.name},k.id))})}),e.jsxs(F.Item,{label:"日期范围",children:[e.jsx(Ya,{onSelect:(k,f)=>{R.setFieldsValue({start_date:$(k),end_date:$(f)})}}),e.jsxs(J,{gutter:8,children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"start_date",noStyle:!0,children:e.jsx(Gt,{placeholder:"选择开始日期",style:{width:"100%"},format:"YYYY-MM-DD"})})}),e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"end_date",noStyle:!0,children:e.jsx(Gt,{placeholder:"选择结束日期",style:{width:"100%"},format:"YYYY-MM-DD"})})})]})]}),e.jsx(F.Item,{children:e.jsxs($e,{children:[e.jsx(P,{type:"primary",htmlType:"submit",loading:Ie,icon:e.jsx(as,{}),children:"开始抓取"}),e.jsx(P,{onClick:()=>M(!1),children:"取消"})]})})]}),X==="upload"&&e.jsxs(e.Fragment,{children:[e.jsx(F.Item,{name:"file",label:"数据文件",rules:[{required:!0,message:"请选择要上传的CSV文件"}],children:e.jsxs(sr,na(ra({},vt),{children:[e.jsx(P,{icon:e.jsx(Hs,{}),children:"选择CSV文件"}),e.jsx(Gr,{type:"secondary",style:{marginLeft:8},children:"仅支持CSV格式的数据文件"})]}))}),e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(we,{placeholder:"例如: AAPL, 600000.SH"})}),e.jsx(F.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(we,{placeholder:"例如: 苹果公司, 浦发银行"})}),e.jsx(F.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Ye,{placeholder:"选择类型",children:[e.jsx(jt,{value:"A股",children:"A股"}),e.jsx(jt,{value:"港股",children:"港股"}),e.jsx(jt,{value:"美股",children:"美股"}),e.jsx(jt,{value:"期货",children:"期货"}),e.jsx(jt,{value:"指数",children:"指数"}),e.jsx(jt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(F.Item,{name:"exchange",label:"交易所",children:e.jsx(we,{placeholder:"例如: NYSE, SSE"})}),e.jsx(F.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Ye,{placeholder:"选择数据源",disabled:!0,children:l.filter(k=>k.name==="用户上传").map(k=>e.jsx(jt,{value:k.id,children:k.name},k.id))})}),e.jsx(F.Item,{children:e.jsxs($e,{children:[e.jsx(P,{type:"primary",htmlType:"submit",loading:m,children:"上传数据"}),e.jsx(P,{onClick:()=>M(!1),children:"取消"})]})})]})]})]}),e.jsx(Re,{title:Se?`${Se.name}(${Se.symbol}) K线图`:"K线图",open:j,onCancel:()=>Ve(!1),footer:null,width:800,children:e.jsx(ns,{spinning:ce,children:Te.length>0?e.jsx("div",{style:{height:"500px",width:"100%"},children:e.jsx(va,{option:{backgroundColor:"#fff",title:{text:Se==null?void 0:Se.symbol,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:Te.map(k=>k.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:Te.map(k=>k.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:Te.map(k=>[k.open,k.close,k.low,k.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:la(5,Te),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:la(10,Te),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:Te.map((k,f)=>[f,k.volume,k.close>k.open?1:-1])}]},style:{height:"100%",width:"100%"},opts:{renderer:"canvas"}})}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx("p",{children:"暂无数据可供显示"})})})})]})});Ea.displayName="DataManagement";var Nt=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});const{Title:Zr,Paragraph:Jr}=Tt,{confirm:Qr}=Re,Xr=()=>{const n=ba();Jt();const[r,l]=o.useState("visual"),[b,m]=o.useState(`# 策略示例：移动平均线交叉策略
import pandas as pd
import numpy as np
import talib

def initialize(context):
    """初始化策略参数"""
    context.params = {
        'symbol': '000300.SH',
        'short_period': 20,
        'long_period': 60
    }

def handle_data(context, data):
    """处理每个交易日的数据"""
    params = context.params
    df = data[params['symbol']]
    
    # 计算移动平均线
    df['short_ma'] = talib.SMA(df['close'], timeperiod=params['short_period'])
    df['long_ma'] = talib.SMA(df['close'], timeperiod=params['long_period'])
    
    # 生成交易信号
    df['signal'] = 0
    # 短均线上穿长均线，买入信号
    df.loc[(df['short_ma'] > df['long_ma']) & (df['short_ma'].shift(1) <= df['long_ma'].shift(1)), 'signal'] = 1
    # 短均线下穿长均线，卖出信号
    df.loc[(df['short_ma'] < df['long_ma']) & (df['short_ma'].shift(1) >= df['long_ma'].shift(1)), 'signal'] = -1
    
    return df['signal']
`),[w]=F.useForm(),[z,M]=o.useState([]),[g,I]=o.useState(!1),[R,X]=o.useState(null);o.useState(!1);const[B,Ie]=o.useState([]),[Oe,pe]=o.useState(!1),[U,he]=o.useState(""),[v,W]=o.useState([]),[j,Ve]=o.useState(!1),[Se,ie]=o.useState([{label:"移动平均线交叉策略",value:"ma_cross"},{label:"布林带策略",value:"bbands"},{label:"RSI策略",value:"rsi"},{label:"MACD策略",value:"macd"},{label:"趋势跟踪策略",value:"trend_following"},{label:"双均线策略",value:"dual_ma"}]),[Te,Xe]=o.useState({}),[ce,et]=o.useState(!1),[te,Pe]=o.useState(!1),ge=()=>new URLSearchParams(n.search).get("id"),[rt,zt]=o.useState(!1);o.useEffect(()=>{(()=>Nt(void 0,null,function*(){if(rt){const _=ge();_&&(!R||R.id!==_)&&(yield qe(_));return}zt(!0);try{yield Promise.all([We(),vt()]),yield ct()}catch(_){console.error("初始化数据加载失败:",_),d.error("数据加载失败，请刷新页面重试")}}))()},[n.search,rt]);const ct=()=>Nt(void 0,null,function*(){if(!Oe){pe(!0);try{const _=(yield cs()).filter(re=>!re.is_template);Ie(_),console.log("加载到策略列表:",_.length,"个策略");const V=ge();V?(!R||R.id!==V)&&(yield qe(V)):_.length>0&&!R&&(yield ze(_[0]))}catch(f){console.error("获取策略列表失败:",f),d.error("获取策略列表失败")}finally{pe(!1)}}}),qe=f=>Nt(void 0,null,function*(){const _={strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"};if(f)try{I(!0);const V=yield Js(f);X(V),V.code&&(l("code"),m(V.code));const re={strategyName:V.name,description:V.description,template:V.template||"ma_cross"};V.parameters&&(console.log("加载策略参数:",V.parameters),Object.assign(re,V.parameters)),console.log("设置表单值:",re),w.setFieldsValue(re)}catch(V){console.error("加载策略详情失败:",V),d.error("加载策略详情失败"),w.setFieldsValue(_)}finally{I(!1)}else w.setFieldsValue(_)}),We=()=>Nt(void 0,null,function*(){if(z.length>0)return z;I(!0);try{const f=yield bs();return M(f),f}catch(f){console.error("获取股票列表失败:",f)}finally{I(!1)}return[]}),ze=f=>Nt(void 0,null,function*(){if(f.id)try{I(!0);const _=yield Js(f.id);X(_),_.code?(l("code"),m(_.code)):l("visual");const V={strategyName:_.name,description:_.description,template:_.template||"ma_cross"};_.parameters&&(console.log("加载策略参数:",_.parameters),Object.assign(V,_.parameters)),console.log("设置表单值:",V),w.setFieldsValue(V),window.history.replaceState(null,"",`?id=${f.id}`)}catch(_){console.error("加载策略详情失败:",_),d.error("加载策略详情失败")}finally{I(!1)}}),bt=f=>{Qr({title:"确定要删除这个策略吗?",icon:e.jsx(lr,{}),content:"此操作不可撤销，删除后数据将无法恢复。",okText:"是的，删除",okType:"danger",cancelText:"取消",onOk(){return Nt(this,null,function*(){try{yield Oa(f.id),d.success("策略删除成功"),R&&R.id===f.id&&(X(null),w.resetFields(),w.setFieldsValue({strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"}),window.history.replaceState(null,"",window.location.pathname)),Oe||Nt(this,null,function*(){const re=(yield cs()).filter(G=>!G.is_template);Ie(re)})}catch(_){console.error("删除策略失败:",_),d.error("删除策略失败")}})}})};B.filter(f=>{var _,V;return((_=f.name)==null?void 0:_.toLowerCase().includes(U.toLowerCase()))||((V=f.description)==null?void 0:V.toLowerCase().includes(U.toLowerCase()))});const vt=()=>Nt(void 0,null,function*(){if(Se.length>0&&Se[0].value!=="ma_cross")return Se;try{const _=(yield cs()).filter(V=>V.is_template).map(V=>({label:V.name,value:V.id}));if(_.length>0)return ie(_),_}catch(f){console.error("获取策略模板失败:",f)}return Se}),pt=f=>Nt(void 0,null,function*(){try{const _=yield Nr(f);_&&(w.setFieldsValue({name:`自定义${_.name}`,description:_.description,code:_.code}),_.parameters&&Xe(_.parameters),d.success("模板加载成功"))}catch{d.error("加载模板失败")}}),ft=f=>{pt(f)},He={name:"",description:"",code:""},gt=f=>{et(!0),Fr(f).then(_=>Nt(void 0,null,function*(){if(d.success("策略保存成功"),_&&(X(_),window.history.replaceState(null,"",`?id=${_.id}`),!Oe)){const re=(yield cs()).filter(G=>!G.is_template);Ie(re)}})).catch(_=>{d.error("保存策略失败: "+_.message)}).finally(()=>{et(!1)})},tt=()=>{Pe(!0),setTimeout(()=>{d.success("策略测试成功"),Pe(!1)},1500)},Ke=f=>{w.resetFields(),d.success("已重置为"+f+"模板")},k=()=>[{key:"mine",label:"我的策略",children:e.jsx(Dt,{itemLayout:"horizontal",dataSource:B,loading:Oe,renderItem:f=>e.jsx(Dt.Item,{className:"strategy-list-item",actions:[e.jsx(P,{type:"link",size:"small",onClick:()=>ze(f),children:"编辑"},"edit"),e.jsx(P,{type:"link",danger:!0,size:"small",onClick:()=>bt(f),children:"删除"},"delete")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:f.name}),e.jsx("div",{className:"strategy-desc",children:f.description})]})})})},{key:"templates",label:"策略模板",children:e.jsx(Dt,{itemLayout:"horizontal",dataSource:v,loading:j,renderItem:f=>e.jsx(Dt.Item,{className:"strategy-list-item",actions:[e.jsx(P,{type:"link",size:"small",onClick:()=>ft(f.id),children:"使用"},"use")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:f.name}),e.jsx("div",{className:"strategy-desc",children:f.description})]})})})}];return e.jsxs("div",{className:"strategy-builder",children:[e.jsxs("div",{className:"page-header",style:{marginBottom:"20px"},children:[e.jsx(Zr,{level:2,children:"策略构建器"}),e.jsx(Jr,{children:"创建和测试您的交易策略"})]}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:18,children:e.jsx(oe,{title:"策略编辑器",bordered:!1,className:"editor-card",children:e.jsxs(F,{form:w,layout:"vertical",initialValues:He,onFinish:gt,children:[e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"name",label:"策略名称",rules:[{required:!0,message:"请输入策略名称"},{max:50,message:"策略名称不能超过50个字符"}],children:e.jsx(we,{placeholder:"请输入策略名称"})})}),e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"description",label:"策略描述",rules:[{max:200,message:"策略描述不能超过200个字符"}],children:e.jsx(we.TextArea,{placeholder:"请输入策略描述",autoSize:{minRows:1,maxRows:3}})})})]}),e.jsx(F.Item,{name:"code",label:"策略代码",rules:[{required:!0,message:"请输入策略代码"}],children:e.jsx(qa,{height:"450px",extensions:[ar()],onChange:f=>w.setFieldsValue({code:f})})}),e.jsx(F.Item,{children:e.jsxs($e,{children:[e.jsx(P,{type:"primary",htmlType:"submit",loading:ce,children:"保存策略"}),e.jsx(P,{type:"default",onClick:tt,loading:te,children:"测试策略"}),e.jsx(rr,{overlay:e.jsxs(ts,{children:[e.jsx(ts.Item,{onClick:()=>Ke("basic"),children:"基础策略模板"},"basic"),e.jsx(ts.Item,{onClick:()=>Ke("technical"),children:"技术指标策略"},"technical"),e.jsx(ts.Item,{onClick:()=>Ke("empty"),children:"空白策略"},"empty")]}),children:e.jsxs(P,{children:["重置模板 ",e.jsx(nr,{})]})})]})})]})})}),e.jsx(x,{span:6,children:e.jsx(oe,{title:"策略库",bordered:!1,className:"strategy-library-card",style:{marginBottom:"16px",height:"300px"},children:e.jsx(ps,{defaultActiveKey:"mine",items:k()})})})]})]})};var Rt=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});const Yt="http://localhost:8001/api",en=n=>Rt(void 0,null,function*(){var r;try{const l={};n&&(l.name=n);const b=yield q.get(`${Yt}/strategies`,{params:l});if(b.data&&b.data.status==="success")return b.data.data||[];throw new Error(((r=b.data)==null?void 0:r.message)||"获取策略列表失败")}catch(l){return d.error(`获取策略列表错误: ${l.message}`),[]}}),tn=n=>Rt(void 0,null,function*(){var r;try{const l=yield q.get(`${Yt}/strategies/${n}`);if(l.data&&l.data.status==="success")return l.data.data;throw new Error(((r=l.data)==null?void 0:r.message)||"获取策略详情失败")}catch(l){return d.error(`获取策略详情错误: ${l.message}`),null}}),sn=n=>Rt(void 0,null,function*(){var r;try{const l=yield q.post(`${Yt}/strategies`,n);if(l.data&&l.data.status==="success")return d.success("策略创建成功"),l.data.data;throw new Error(((r=l.data)==null?void 0:r.message)||"创建策略失败")}catch(l){return d.error(`创建策略错误: ${l.message}`),null}}),an=(n,r)=>Rt(void 0,null,function*(){var l;try{const b=yield q.put(`${Yt}/strategies/${n}`,r);if(b.data&&b.data.status==="success")return d.success("策略更新成功"),b.data.data;throw new Error(((l=b.data)==null?void 0:l.message)||"更新策略失败")}catch(b){return d.error(`更新策略错误: ${b.message}`),null}}),rn=(n,r,l)=>Rt(void 0,null,function*(){var b;try{const m={code:n,data:r||[],parameters:l||{}},w=yield q.post(`${Yt}/strategies/test`,m);if(w.data&&w.data.status==="success")return w.data.data;throw new Error(((b=w.data)==null?void 0:b.message)||"测试策略失败")}catch(m){return d.error(`测试策略错误: ${m.message}`),{error:m.message}}}),oa=(n,r,l,b,...m)=>Rt(void 0,[n,r,l,b,...m],function*(w,z,M,g,I=1e5,R={},X=.0015,B=.001,Ie="database",Oe=[]){var pe;try{const U={strategy_id:w,symbol:z,start_date:M,end_date:g,initial_capital:I,parameters:R,commission_rate:X,slippage_rate:B,data_source:Ie,features:Oe},he=yield q.post(`${Yt}/strategies/backtest`,U);if(he.data&&he.data.status==="success")return he.data.data;throw new Error(((pe=he.data)==null?void 0:pe.message)||"策略回测失败")}catch(U){return d.error(`策略回测错误: ${U.message}`),{error:U.message}}}),nn=(n,r,l,b,...m)=>Rt(void 0,[n,r,l,b,...m],function*(w,z,M,g,I=1e5,R={},X=.0015,B=.001,Ie="database",Oe=[]){var pe;try{const U={strategy_id:w,symbol:z,start_date:M,end_date:g,initial_capital:I,parameters:R,commission_rate:X,slippage_rate:B,data_source:Ie,features:Oe,force_refresh:!0},he=yield q.post(`${Yt}/strategies/backtest`,U);if(he.data&&he.data.status==="success")return he.data.data;throw new Error(((pe=he.data)==null?void 0:pe.message)||"策略回测失败")}catch(U){return d.error(`策略回测错误: ${U.message}`),{error:U.message}}}),ln=(n,r,l,b,...m)=>Rt(void 0,[n,r,l,b,...m],function*(w,z,M,g,I=1e5,R={},X=.0015,B=.001,Ie="database",Oe=[],pe="normal"){var U;try{const he=pe==="high"?1:0,v={strategy_id:w.toString(),symbol:z,start_date:M,end_date:g,initial_capital:I,parameters:R,commission_rate:X,slippage_rate:B,data_source:Ie,features:Oe,priority:he},W=yield q.post(`${Yt}/async/backtest/submit`,v);if(W.data&&W.data.task_id)return W.data;throw new Error(((U=W.data)==null?void 0:U.message)||"提交异步回测任务失败")}catch(he){throw d.error(`提交异步回测任务错误: ${he.message}`),he}}),on=n=>Rt(void 0,null,function*(){try{return(yield q.get(`${Yt}/async/backtest/status/${n}`)).data}catch(r){throw d.error(`获取任务状态错误: ${r.message}`),r}}),cn=n=>Rt(void 0,null,function*(){try{return(yield q.get(`${Yt}/async/backtest/result/${n}`)).data}catch(r){throw d.error(`获取回测结果错误: ${r.message}`),r}});var dn=Object.defineProperty,un=Object.defineProperties,pn=Object.getOwnPropertyDescriptors,ia=Object.getOwnPropertySymbols,hn=Object.prototype.hasOwnProperty,mn=Object.prototype.propertyIsEnumerable,ca=(n,r,l)=>r in n?dn(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,ms=(n,r)=>{for(var l in r||(r={}))hn.call(r,l)&&ca(n,l,r[l]);if(ia)for(var l of ia(r))mn.call(r,l)&&ca(n,l,r[l]);return n},fs=(n,r)=>un(n,pn(r)),At=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});$.extend($a);$.extend(Ia);$.tz.setDefault("Asia/Shanghai");Ls([Ps,Fs,Ns,Os,Ts,Rs,or,ir,cr,Ys,dr,Es]);Ca.locale("zh-cn");const{Title:fn,Paragraph:xn}=Tt,{Option:es}=Ye,gn=()=>{var n;const r=Jt(),[l,b]=o.useState(!1),[m,w]=o.useState(!1),[z,M]=o.useState(1e5),[g,I]=o.useState(.15),[R,X]=o.useState(.1),[B,Ie]=o.useState([]),[Oe,pe]=o.useState(!1),[U,he]=o.useState(1),[v,W]=o.useState("MA交叉策略"),[j,Ve]=o.useState(null),[Se,ie]=o.useState([$().subtract(1,"year").startOf("day"),$().endOf("day")]),[Te,Xe]=o.useState([]),[ce,et]=o.useState([]),[te,Pe]=o.useState([]),[ge,rt]=o.useState([]),[zt,ct]=o.useState([]),[qe,We]=o.useState({totalReturn:0,annualReturn:0,sharpeRatio:0,maxDrawdown:0,winRate:0,profitFactor:0,alpha:0,beta:0}),[ze,bt]=o.useState([]),[vt,pt]=o.useState(null),[ft,He]=o.useState([]),[gt,tt]=o.useState([]),Ke=o.useRef(null),k=o.useRef(!1),[f,_]=o.useState({}),[V,re]=o.useState(!1),[G,Fe]=o.useState([]),[st,Ee]=o.useState(null),[Ge,nt]=o.useState(!1),[Ne,t]=o.useState([]),[a,u]=o.useState(!1),[p,A]=o.useState(!1),[L,N]=o.useState(""),[Q,ne]=o.useState(""),[S,me]=o.useState(!1),[ke,le]=o.useState(null),[Ce,Y]=o.useState(""),[ee,Be]=o.useState(0),[Ze,dt]=o.useState(null),fe=s=>typeof s!="string"?String(s):s.includes("T")?s.split("T")[0]:s.includes(" ")?s.split(" ")[0]:/^\d{4}-\d{2}-\d{2}$/.test(s)?s:s.substring(0,10),lt=o.useCallback(s=>{if(!s||s.length===0)return[];const y=s.map((c,T)=>({key:T.toString(),date:fe(c.date),symbol:(j==null?void 0:j.symbol)||"",direction:c.action==="BUY"?"买入":"卖出",entryPrice:c.action==="BUY"?c.price:void 0,exitPrice:c.action==="SELL"?c.price:void 0,shares:c.shares,value:c.value,profitLoss:c.profit||0,returnPct:(c.profit_percent||0)*100,duration:c.holding_days||0,beforeCash:c.before_cash,afterCash:c.after_cash,beforeEquity:c.before_equity,afterEquity:c.after_equity,trigger_reason:c.trigger_reason,available_capital:c.available_capital,allocated_capital:c.allocated_capital,position_size:c.position_size,cumulative_position_ratio:c.cumulative_position_ratio,currentShares:0,currentAvgCost:0})).slice().sort((c,T)=>new Date(c.date).getTime()-new Date(T.date).getTime());let D=0,Z=0;return y.forEach(c=>{if(c.direction==="买入"){const T=c.entryPrice||0;Z+=c.shares*T,D+=c.shares}else if(c.direction==="卖出"){if(D>0){const T=c.shares/D;Z*=1-T}D-=c.shares}c.currentShares=D,c.currentAvgCost=D>0?Z/D:0}),y.sort((c,T)=>new Date(T.date).getTime()-new Date(c.date).getTime())},[j]),ls=()=>At(void 0,null,function*(){var s,i;if(!vt||!m){d.error("没有可保存的回测结果");return}if(!L.trim()){d.error("请输入回测名称");return}A(!0);try{const y=Se[0].format("YYYY-MM-DD"),D=Se[1].format("YYYY-MM-DD"),Z=yield oa(U,j.symbol,y,D,z,{save_backtest:!0,backtest_name:L,backtest_description:Q,parameters:f},g,R,"database",[]);if(Z.error){d.error(`保存失败: ${Z.error}`);return}Z.saved?(d.success("回测保存成功！"),u(!1),N(""),ne(""),Re.confirm({title:"保存成功",content:"回测已成功保存，是否查看回测历史？",okText:"查看历史",cancelText:"继续回测",onOk:()=>{r("/backtest/history")}})):d.error("保存失败，请重试")}catch(y){console.error("保存回测失败:",y),d.error(((i=(s=y.response)==null?void 0:s.data)==null?void 0:i.detail)||"保存失败，请重试")}finally{A(!1)}}),Kt=o.useCallback(()=>{console.log("清理轮询定时器，当前pollingIntervalRef.current:",Ue.current),Ue.current&&(clearInterval(Ue.current),Ue.current=null,dt(null),console.log("轮询定时器已清理"))},[]);o.useEffect(()=>()=>{Ue.current&&(clearInterval(Ue.current),Ue.current=null)},[]);const Ue=o.useRef(null),Pt=o.useCallback(s=>At(void 0,null,function*(){try{const i=yield on(s);if(console.log("任务状态:",i),Y(i.status),Be(i.progress||0),i.status==="completed"){console.log("任务已完成，准备清理轮询"),Ue.current&&(console.log("立即清理轮询定时器，ID:",Ue.current),clearInterval(Ue.current),Ue.current=null,dt(null));try{let y;if(i.result&&Object.keys(i.result).length>0?(console.log("从状态响应中获取结果，避免额外请求"),y=i.result):(console.log("状态响应中无结果，发起结果请求"),y=yield cn(s)),console.log("异步回测结果:",y),y&&y.status==="error")console.error("回测执行失败:",y.message),d.error(`回测失败: ${y.message}`);else{const D=y.data||y;console.log("提取的回测数据:",D),os(D),d.success("异步回测完成")}}catch(y){console.error("获取回测结果失败:",y),d.error(`获取回测结果失败: ${y.message}`)}pe(!1),le(null)}else i.status==="failed"&&(console.log("任务失败，准备清理轮询"),Ue.current&&(console.log("立即清理轮询定时器，ID:",Ue.current),clearInterval(Ue.current),Ue.current=null,dt(null)),pe(!1),le(null),d.error(`异步回测失败: ${i.error||"未知错误"}`))}catch(i){console.error("获取任务状态失败:",i)}}),[]),os=o.useCallback(s=>{var i,y,D,Z;if(s.error){d.error(`回测失败: ${s.error}`);return}if(console.log("回测结果:",s),console.log("回测结果关键字段:"),console.log("- total_return:",s.total_return),console.log("- annual_return:",s.annual_return),console.log("- sharpe_ratio:",s.sharpe_ratio),console.log("- max_drawdown:",s.max_drawdown),console.log("- win_rate:",s.win_rate),console.log("- profit_factor:",s.profit_factor),console.log("- trades 数量:",(i=s.trades)==null?void 0:i.length),console.log("- equity_curve 数量:",(y=s.equity_curve)==null?void 0:y.length),console.log("- drawdowns 数量:",(D=s.drawdowns)==null?void 0:D.length),s.trades||(s.trades=[],console.warn("未找到交易记录，设置为空数组")),s.equity_curve||(s.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),s.drawdowns||(s.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),We({totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0,alpha:(s.alpha||0)*100,beta:s.beta||0}),console.log("处理后的性能指标:",{totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0}),pt(s),s.trades&&s.trades.length>0){const de=lt(s.trades);et(de),He(de)}else et([]),He([]);if(s.equity_curve&&s.equity_curve.length>0){console.log("处理权益曲线数据:",s.equity_curve[0]);const de=s.equity_curve.map(T=>({date:fe(T.date),equity:T.equity}));rt(de),tt(de);const c=s.equity_curve.map(T=>{const je=fe(T.date),be=Number(T.open)||0,H=Number(T.close)||0,E=Number(T.low)||0,K=Number(T.high)||0,ue=Number(T.volume)||0;return[je,be,H,E,K,ue]});console.log("K线数据示例(前3条):",c.slice(0,3)),Pe(c)}else rt([]),tt([]),Pe([]);if(s.drawdowns&&s.drawdowns.length>0){const de=s.drawdowns.map(c=>({date:fe(c.date),drawdown:(c.drawdown||0)*100}));ct(de)}else ct([]);w(!0),(Z=Ke.current)==null||Z.scrollIntoView({behavior:"smooth"})},[fe,j]),vs=o.useCallback(()=>At(void 0,null,function*(){if(!U||!j||!Se[0]||!Se[1]){d.error("请选择策略、交易品种和回测周期");return}pe(!0),pt(null),w(!1);try{const s=Se[0].format("YYYY-MM-DD"),i=Se[1].format("YYYY-MM-DD");if(S){console.log("使用异步模式提交回测任务");const y=yield ln(U,j.symbol,s,i,z,{save_backtest:!1,parameters:f},g,R,"database",[],"normal");console.log("异步任务提交成功:",y),le(y.task_id),Y("pending"),Be(0);const D=setInterval(()=>{Pt(y.task_id)},2e3);Ue.current=D,dt(D),d.info("回测任务已提交，正在后台执行...")}else{console.log("使用同步模式执行回测");const y=yield oa(U,j.symbol,s,i,z,{save_backtest:!1,parameters:f},g,R,"database",[]);os(y),(()=>{d.success("回测完成")})(),pe(!1)}}catch(s){console.error("回测执行失败:",s),d.error(`回测失败: ${s.message||"未知错误"}`),pe(!1),le(null),Kt()}}),[U,j,Se,z,g,R,f,S,os,Pt,Kt]),_s=o.useCallback(()=>At(void 0,null,function*(){var s,i,y,D;if(!U||!j||!Se[0]||!Se[1]){d.error("请选择策略、交易品种和回测周期");return}pe(!0),pt(null),w(!1);try{const Z=Se[0].format("YYYY-MM-DD"),de=Se[1].format("YYYY-MM-DD"),c=yield nn(U,j.symbol,Z,de,z,{save_backtest:!1,parameters:f},g,R,"database",[]);if(c.error){d.error(`强制刷新回测失败: ${c.error}`);return}if(console.log("强制刷新回测结果:",c),console.log("回测结果关键字段:"),console.log("- total_return:",c.total_return),console.log("- annual_return:",c.annual_return),console.log("- sharpe_ratio:",c.sharpe_ratio),console.log("- max_drawdown:",c.max_drawdown),console.log("- win_rate:",c.win_rate),console.log("- profit_factor:",c.profit_factor),console.log("- trades 数量:",(s=c.trades)==null?void 0:s.length),console.log("- equity_curve 数量:",(i=c.equity_curve)==null?void 0:i.length),console.log("- drawdowns 数量:",(y=c.drawdowns)==null?void 0:y.length),c.trades||(c.trades=[],console.warn("未找到交易记录，设置为空数组")),c.equity_curve||(c.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),c.drawdowns||(c.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),We({totalReturn:(c.total_return||0)*100,annualReturn:(c.annual_return||0)*100,sharpeRatio:c.sharpe_ratio||0,maxDrawdown:(c.max_drawdown||0)*100,winRate:(c.win_rate||0)*100,profitFactor:c.profit_factor||0,alpha:(c.alpha||0)*100,beta:c.beta||0}),console.log("处理后的性能指标:",{totalReturn:(c.total_return||0)*100,annualReturn:(c.annual_return||0)*100,sharpeRatio:c.sharpe_ratio||0,maxDrawdown:(c.max_drawdown||0)*100,winRate:(c.win_rate||0)*100,profitFactor:c.profit_factor||0}),pt(c),c.trades&&c.trades.length>0){const je=lt(c.trades);et(je),He(je)}else et([]),He([]);if(c.equity_curve&&c.equity_curve.length>0){console.log("处理权益曲线数据:",c.equity_curve[0]);const je=c.equity_curve.map(H=>({date:fe(H.date),equity:H.equity}));rt(je),tt(je);const be=c.equity_curve.map(H=>{const E=fe(H.date),K=Number(H.open)||0,ue=Number(H.close)||0,ve=Number(H.low)||0,ht=Number(H.high)||0,_t=Number(H.volume)||0;return[E,K,ue,ve,ht,_t]});console.log("K线数据示例(前3条):",be.slice(0,3)),Pe(be)}else rt([]),tt([]),Pe([]);if(c.drawdowns&&c.drawdowns.length>0){const je=c.drawdowns.map(be=>({date:fe(be.date),drawdown:(be.drawdown||0)*100}));ct(je)}else ct([]);w(!0),(D=Ke.current)==null||D.scrollIntoView({behavior:"smooth"}),(()=>{d.success("强制刷新回测完成")})()}catch(Z){console.error("强制刷新回测执行失败:",Z),d.error(`强制刷新回测失败: ${Z.message||"未知错误"}`)}finally{pe(!1)}}),[U,j,Se,z,g,R,fe,et,He,Pe,rt,tt,ct,w,pt,We,pe]),ws=()=>{const s=j?`${j.name} (${j.symbol}) K线图与交易信号`:"K线图与交易信号";let i=[],y=[];if(!te||te.length===0)return console.warn("K线数据为空，无法生成图表"),{title:{text:s,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};if(ce.length>0&&te.length>0){if(console.log("准备标记交易信号，总交易记录：",ce.length),console.log("K线数据样本:",te.slice(0,3)),te.length>0){const H=te[0][0];console.log("K线日期格式示例:",{original:H,type:typeof H,split:typeof H=="string"?H.split("T"):null})}if(ce.length>0){const H=ce[0].date;console.log("交易记录日期格式示例:",{original:H,type:typeof H,split:typeof H=="string"?H.split("T"):null,split2:typeof H=="string"?H.split(" "):null})}const c=new Map,T=new Map;te.forEach((H,E)=>{const K=fe(H[0]);c.set(K,E),T.set(K,[Number(H[1]),Number(H[2]),Number(H[3]),Number(H[4])])}),console.log("日期索引映射创建完成，共计:",c.size),console.log("日期映射示例:",Array.from(c.entries()).slice(0,3));const je=ce.filter(H=>H.direction==="买入");console.log("买入记录:",je.length),i=je.map(H=>{const E=fe(H.date),K=c.get(E),ue=H.entryPrice||0;return K===void 0||ue<=0?(console.warn(`未找到买入日期 ${E} 对应的K线索引或价格无效`),null):(console.log(`买入日期匹配成功: ${E} -> 索引 ${K}, 价格 ${ue}`),{name:"买入",value:[K,ue],xAxis:K,yAxis:ue,itemStyle:{color:"#f64034"}})}).filter(H=>H!==null);const be=ce.filter(H=>H.direction==="卖出");console.log("卖出记录:",be.length),y=be.map(H=>{const E=fe(H.date),K=c.get(E),ue=H.exitPrice||0,ve=H.profitLoss||0;if(H.returnPct,K===void 0||ue<=0)return console.warn(`未找到卖出日期 ${E} 对应的K线索引或价格无效`),null;console.log(`卖出日期匹配成功: ${E} -> 索引 ${K}, 价格 ${ue}, 盈亏 ${ve}`);const ht=ve>=0?"#f64034":"#00b46a";return{name:"卖出",value:[K,ue],xAxis:K,yAxis:ue,itemStyle:{color:ht}}}).filter(H=>H!==null),console.log(`成功生成买入信号: ${i.length}/${je.length}`),console.log(`成功生成卖出信号: ${y.length}/${be.length}`)}const D=te.map(c=>c[0]);let Z=[];Z=[...i.map(c=>(c.value[0],{name:"买入点",coord:[c.value[0],c.value[1]],value:c.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...y.map(c=>({name:"卖出点",coord:[c.value[0],c.value[1]],value:c.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...i.map(c=>{const T=c.value[0],be=te[T][4]*1.1;return{name:"买入标签",coord:[c.value[0],be],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...y.map(c=>{const T=c.value[0],je=i.some(E=>{const K=E.value[0],ue=fe(te[K][0]),ve=fe(te[T][0]);return ue===ve}),be=te[T][4],H=je?be*1.2:be*1.1;return{name:"卖出标签",coord:[c.value[0],H],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];const de=[...i.map(c=>({name:"买入价格",coord:[c.value[0],c.value[1]*1.03],symbol:"none",label:{show:!0,formatter:`¥${c.value[1].toFixed(2)}`,fontSize:12,color:"#f64034",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"top",distance:8}})),...y.map(c=>{const T=c.value[0],je=te[T][0],be=ce.find(ve=>ve.direction==="卖出"&&fe(ve.date)===fe(je)),H=be&&be.profitLoss||0,E=be&&be.returnPct||0,K=H>=0?`+${H.toFixed(2)}`:`${H.toFixed(2)}`,ue=E>=0?`+${E.toFixed(2)}%`:`${E.toFixed(2)}%`;return{name:"卖出价格",coord:[c.value[0],c.value[1]*.97],symbol:"none",label:{show:!0,formatter:be?`¥${c.value[1].toFixed(2)}
${K}(${ue})`:`¥${c.value[1].toFixed(2)}`,fontSize:12,color:"#00b46a",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"bottom",distance:8}}})];return{title:{text:s,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(c){let T="";if(Array.isArray(c)){const je=c[0].axisValue;T=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${je}</div>`,c.forEach(K=>{if(K.seriesName==="K线"){if(K.value&&K.value.length>=4){const ue=Number(K.value[1])||0,ve=Number(K.value[2])||0,ht=Number(K.value[3])||0,_t=Number(K.value[4])||0,mt=ve>=ue?"#f64034":"#00b46a";T+=`<div style="color:${mt};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${mt};">${ue.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${mt};">${ve.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${mt};">${ht.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${mt};">${_t.toFixed(2)}</span><br/>
                  </div>`}}else if(K.seriesName&&K.seriesName.startsWith("MA")&&K.value!=="-"){const ve={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[K.seriesName]||K.color;try{const ht=typeof K.value=="number"?parseFloat(K.value.toString()).toFixed(3):parseFloat(K.value||"0").toFixed(3);T+=`<div style="color:${ve};font-weight:bold;display:inline-block;margin-right:15px;">${K.seriesName}：${ht}</div>`}catch(ht){console.warn("格式化MA值出错:",ht),T+=`<div style="color:${ve};font-weight:bold;display:inline-block;margin-right:15px;">${K.seriesName}：0</div>`}}});const be=fe(je),H=ce.find(K=>K.direction==="买入"&&fe(K.date)===be),E=ce.find(K=>K.direction==="卖出"&&fe(K.date)===be);if((H||E)&&(T+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),H){const K=H.entryPrice||0,ue=H.trigger_reason||"未记录原因";T+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${K.toFixed(2)}<br/>
                原因：${ue}
              </div>`}if(E){const K=E.exitPrice||0,ue=E.profitLoss||0,ve=E.returnPct||0,ht=E.trigger_reason||"未记录原因",_t=ue>=0?`+${ue.toFixed(2)}`:`${ue.toFixed(2)}`,mt=ve>=0?`+${ve.toFixed(2)}%`:`${ve.toFixed(2)}%`;T+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${K.toFixed(2)}<br/>
                盈亏：${_t} (${mt})<br/>
                原因：${ht}
              </div>`}}return T}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:D,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"},min:function(c){return Math.min(0,z*.8)},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:te.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:Z,animation:!1,z:10}},{name:"价格标签",type:"scatter",data:[],markPoint:{symbol:"none",data:de,animation:!1,z:9}},{name:"MA5",type:"line",data:Qt(5,te.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Qt(10,te.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Qt(20,te.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Qt(30,te.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}};function Qt(s,i){if(!i||!Array.isArray(i)||i.length===0)return console.warn(`计算MA${s}失败: 数据无效`),[];console.log(`MA${s}计算 - 输入数据示例:`,i.length>0?i.slice(0,3):"无数据");const y=[];for(let D=0;D<i.length;D++){if(D<s-1){y.push("-");continue}let Z=0,de=0;for(let c=0;c<s;c++){const T=i[D-c];if(T&&T.length>=4){const je=Number(T[1]);!isNaN(je)&&je>0&&(Z+=je,de++)}}de>0?y.push((Z/de).toFixed(2)):y.push("-")}return y.length>0&&console.log(`MA${s}计算结果示例:`,y.slice(0,5)),y}const Ss=[{title:"日期",dataIndex:"date",key:"date",sorter:(s,i)=>{const y=new Date(s.date),D=new Date(i.date);return y.getTime()-D.getTime()}},{title:"方向",dataIndex:"direction",key:"direction",filters:[{text:"买入",value:"买入"},{text:"卖出",value:"卖出"}],onFilter:(s,i)=>i.direction===s,render:s=>e.jsx(Le,{color:s==="买入"?"red":"green",children:s})},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:s=>e.jsx(_e,{title:s||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:s||"未记录"})})},{title:"期初资金",dataIndex:"beforeCash",key:"beforeCash",sorter:(s,i)=>s.beforeCash-i.beforeCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"afterCash",key:"afterCash",sorter:(s,i)=>s.afterCash-i.afterCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"入场价",dataIndex:"entryPrice",key:"entryPrice",sorter:(s,i)=>{const y=s.entryPrice||0,D=i.entryPrice||0;return y-D},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"出场价",dataIndex:"exitPrice",key:"exitPrice",sorter:(s,i)=>{const y=s.exitPrice||0,D=i.exitPrice||0;return y-D},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(s,i)=>s.shares-i.shares,render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前持仓(股)",dataIndex:"currentShares",key:"currentShares",sorter:(s,i)=>(s.currentShares||0)-(i.currentShares||0),render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前摊薄成本(元)",dataIndex:"currentAvgCost",key:"currentAvgCost",sorter:(s,i)=>(s.currentAvgCost||0)-(i.currentAvgCost||0),render:s=>{const i=parseFloat(s)||0;return i>0?i.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"-"}},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(s,i)=>s.value-i.value,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"盈亏",dataIndex:"profitLoss",key:"profitLoss",sorter:(s,i)=>s.profitLoss-i.profitLoss,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2)]}):e.jsx("span",{style:{color:"#52c41a"},children:i.toFixed(2)})}},{title:"收益率(%)",dataIndex:"returnPct",key:"returnPct",sorter:(s,i)=>s.returnPct-i.returnPct,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00%"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2),"%"]}):e.jsxs("span",{style:{color:"#52c41a"},children:[i.toFixed(2),"%"]})}},{title:"持仓天数",dataIndex:"duration",key:"duration",sorter:(s,i)=>s.duration-i.duration},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(s,i)=>(s.position_size||0)-(i.position_size||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(s,i)=>(s.cumulative_position_ratio||0)-(i.cumulative_position_ratio||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}}],h=()=>{if(console.log("生成权益曲线图表, 数据长度:",ge.length),!ge||ge.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const s=ge.filter(E=>E&&E.date&&E.equity!==void 0&&!isNaN(Number(E.equity)));if(s.length===0)return console.error("权益曲线数据无效:",ge.slice(0,3)),{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};console.log("有效数据点数量:",s.length),console.log("权益曲线数据范围:",s.length>0?`${s[0].date}(${s[0].equity}) ~ ${s[s.length-1].date}(${s[s.length-1].equity})`:"无数据");let i=[],y=[];const D=new Map;s.forEach((E,K)=>{const ue=fe(E.date);D.set(ue,K)}),ce.length>0&&(console.log("准备在权益曲线上标记交易点，总交易记录：",ce.length),ce.forEach(E=>{const K=fe(E.date),ue=D.get(K);if(ue!==void 0){const ve={name:E.direction==="买入"?"买入点":"卖出点",value:s[ue].equity,xAxis:ue,yAxis:s[ue].equity,itemStyle:{color:E.direction==="买入"?"#f64034":"#00b46a"}};E.direction==="买入"?i.push(ve):y.push(ve)}}));let Z=-1,de=-1,c=0,T="",je="",be=0,H=0;if(s.length>0&&qe.maxDrawdown>0){let E=s[0].equity,K=0,ue=0;for(let ve=1;ve<s.length;ve++)s[ve].equity>E?(E=s[ve].equity,ue=ve):(K=(E-s[ve].equity)/E*100,K>c&&(c=K,Z=ue,de=ve,T=s[ue].date,je=s[ve].date,be=E,H=s[ve].equity));console.log(`最大回测区间索引: ${Z} - ${de}`),console.log(`最大回测: ${c.toFixed(2)}%, 从 ${T} 到 ${je}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(E){if(Array.isArray(E)&&E.length>0){const ue=E[0].axisValue,ve=E[0].data;for(let _t=0;_t<E.length;_t++)if(E[_t].componentType==="markArea")return`最大回撤: ${c.toFixed(2)}%<br/>
                        开始日期: ${T}<br/>
                        最高点: ¥${be.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${je}<br/>
                        最低点: ¥${H.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let ht="";for(let _t=0;_t<E.length;_t++){const mt=E[_t];if(mt.seriesName==="买入点"||mt.seriesName==="卖出点"){const Ba=fe(ue),Vs=ce.find(is=>fe(is.date)===Ba&&(mt.seriesName==="买入点"&&is.direction==="买入"||mt.seriesName==="卖出点"&&is.direction==="卖出"));if(Vs){const is=Vs.trigger_reason||"未记录原因";ht=`<br/><span style="color:${mt.color}">● ${mt.seriesName}</span>`,ht+=`<br/><span style="color:#555; font-size:12px">原因: ${is}</span>`}else ht=`<br/><span style="color:${mt.color}">● ${mt.seriesName}</span>`;break}}return`${ue}<br/>策略收益: ¥${parseFloat(ve).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${ht}`}const K=E.value;return`${E.name}: ¥${parseFloat(K).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:s.map(E=>E.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:s.map(E=>E.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new za(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...i.map(E=>({name:"买入点",coord:[E.xAxis,E.yAxis],value:E.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...y.map(E=>({name:"卖出点",coord:[E.xAxis,E.yAxis],value:E.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${c.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[Z>=0&&de>=0?[{name:"最大回撤开始",xAxis:Z,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:de,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:s.map(()=>z),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:z,label:{formatter:"初始资金: ¥"+z.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(E){return`初始资金: ¥${z.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},C=()=>At(void 0,null,function*(){try{const s=yield en();if(console.log("从后端获取的策略列表:",s),s&&s.length>0)if(bt(s),!s.some(i=>i.id===U))he(s[0].id||1),W(s[0].name||"移动平均线交叉策略");else{const i=s.find(y=>y.id===U);i&&W(i.name)}else d.error("未找到策略列表，请先创建策略")}catch(s){console.error("获取策略列表失败:",s),d.error("获取策略列表失败，请检查网络连接")}});o.useEffect(()=>{k.current||(k.current=!0,De(),Ft(),C())},[]),o.useEffect(()=>{ze.length>0&&U&&Me(U)},[ze,U]);const O=s=>At(void 0,null,function*(){Ve(s);try{const i=yield Or(s.id);if(i.first_date&&i.last_date){const y=$(i.first_date).startOf("day"),D=$(i.last_date).endOf("day");ie([y,D]),d.success(`已自动设置回测周期：${i.first_date} 至 ${i.last_date}`)}}catch(i){console.error("获取股票日期范围失败:",i),d.warning("无法获取该股票的数据日期范围，请手动设置回测周期")}}),De=()=>At(void 0,null,function*(){pe(!0);try{const s=yield bs();Ie(s),s.length>0&&(yield O(s[0]))}catch(s){console.error("获取股票列表失败:",s)}finally{pe(!1)}}),Me=s=>At(void 0,null,function*(){try{const i=yield q.get(`/api/optimization/strategies/${s}/parameter-spaces`);if(i.data&&i.data.status==="success"){Fe(i.data.data);const y={};i.data.data.forEach(D=>{(D.parameter_type==="int"||D.parameter_type==="float")&&(y[D.parameter_name]=D.min_value)}),_(y)}}catch(i){console.error("加载参数空间失败:",i),Fe([]),_({})}}),se=()=>{re(!0)},ae=()=>{re(!1),d.success("参数设置已保存")},ye=()=>{const s={};G.forEach(i=>{(i.parameter_type==="int"||i.parameter_type==="float")&&(s[i.parameter_name]=i.min_value)}),_(s),d.success("参数已重置为默认值")},at=()=>At(void 0,null,function*(){try{const s=yield q.get(`/api/optimization/strategies/${U}/best-parameters`);s.data&&s.data.status==="success"&&s.data.data.length>0?(t(s.data.data),nt(!0)):d.warning("该策略暂无优化结果，请先进行参数优化")}catch(s){console.error("获取优化结果失败:",s),d.error("获取优化结果失败，请检查网络连接")}}),Ae=s=>{var i;_(s.best_parameters),nt(!1),re(!1),d.success(`已导入优化结果: ${s.job_name} (得分: ${(i=s.best_score)==null?void 0:i.toFixed(4)})`)},yt=s=>{he(s);const i=ze.find(y=>y.id===s);i&&(W(i.name),Ee(i)),Me(s)},Ft=()=>At(void 0,null,function*(){try{const s=yield Na();Xe(s)}catch(s){console.error("获取数据源列表失败:",s)}}),Mt=()=>[{key:"1",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"绩效分析"]}),children:e.jsx(J,{gutter:16,children:e.jsx(x,{span:24,style:{marginBottom:16},children:e.jsx(qt,{option:h(),style:{height:500}})})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"K线与交易信号"]}),children:e.jsx(J,{gutter:16,children:e.jsx(x,{span:24,children:e.jsx(oe,{title:j?`${j.name} (${j.symbol})交易图表`:"交易图表",extra:e.jsxs($e,{children:[e.jsx(P,{type:"primary",size:"small",onClick:()=>{const s=document.querySelector(".kline-chart");if(s){const i=s.__echarts__;i&&i.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(P,{size:"small",onClick:()=>{if(ce.length>0&&te.length>0){const s=new Map;te.forEach((y,D)=>{const Z=fe(y[0]);s.set(Z,D)});const i=[];if(ce.forEach(y=>{const D=fe(y.date),Z=s.get(D);Z!==void 0&&i.push(Z)}),console.log("找到的交易日期索引:",i),i.length>0){const y=Math.max(0,Math.min(...i)-10),D=Math.min(te.length-1,Math.max(...i)+10),Z=y/te.length*100,de=D/te.length*100;console.log(`设置缩放范围: ${Z.toFixed(2)}% - ${de.toFixed(2)}%`);const c=document.querySelector(".kline-chart");if(c){const T=c.__echarts__;T&&(T.dispatchAction({type:"dataZoom",start:Z,end:de}),(be=>{d.success(`已聚焦到交易区域，共显示 ${be} 个交易点`)})(i.length))}}else(()=>{d.info("未找到交易信号对应的K线数据点")})()}else(()=>{d.info("没有交易记录或K线数据")})()},children:"聚焦交易"}),e.jsx(_e,{title:"只显示有交易的区域",children:e.jsx(Je,{})})]}),children:e.jsx(qt,{className:"kline-chart",option:ws(),style:{height:600},notMerge:!0,opts:{renderer:"canvas"},onEvents:{click:s=>{if(s.componentType==="markPoint"){const y=s.name==="买入",D=s.data.coord[0],Z=te[D][0],de=y?"买入":"卖出",c=ce.find(T=>T.direction===de&&fe(T.date)===fe(Z));if(console.log(`点击了${de}标记，日期: ${Z}`,c),c){const T=c,je=y?"买入详情":"卖出详情",be=e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"日期:"})," ",T.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"价格:"})," ",y?T.entryPrice:T.exitPrice]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数量:"})," ",T.shares.toLocaleString()," 股"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"金额:"})," ",T.value.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),!y&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏:"})," ",T.profitLoss>=0?"+":"",T.profitLoss.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"收益率:"})," ",T.returnPct>=0?"+":"",T.returnPct.toFixed(2),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"持仓天数:"})," ",T.duration," 天"]})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易前资金:"})," ",T.beforeCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易后资金:"})," ",T.afterCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"触发原因:"})," ",T.trigger_reason||"未记录原因"]})]});Re.info({title:je,content:be,width:400})}else((je,be)=>{d.info(`未找到匹配的${je}交易记录，日期: ${be}`)})(de,Z)}}}})})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Je,{}),"交易明细"]}),children:e.jsx(Zt,{dataSource:ce,columns:Ss,pagination:{pageSize:10},scroll:{x:!0}})}];return e.jsxs("div",{children:[e.jsx(fn,{level:2,children:"回测分析"}),e.jsx(xn,{children:"回测您的交易策略，分析策略表现并优化参数。"}),e.jsx(oe,{children:e.jsx(ns,{spinning:Oe,children:e.jsxs(F,{layout:"vertical",children:[e.jsxs(J,{gutter:24,children:[e.jsx(x,{span:8,children:e.jsx(F.Item,{label:"策略选择",required:!0,children:e.jsxs(we.Group,{compact:!0,children:[e.jsx(Ye,{value:v,onChange:(s,i)=>{yt(Number(i.key))},placeholder:"选择策略",style:{width:"calc(100% - 80px)"},size:"middle",children:ze.map(s=>e.jsx(es,{value:s.name,children:s.name},s.id))}),e.jsx(P,{type:"primary",ghost:!0,onClick:se,style:{width:"80px"},icon:e.jsx(js,{}),size:"middle",children:"参数"})]})})}),e.jsx(x,{span:8,children:e.jsx(F.Item,{label:"交易品种",required:!0,children:e.jsx(Ye,{value:j==null?void 0:j.symbol,onChange:s=>At(void 0,null,function*(){const i=B.find(y=>y.symbol===s);i&&(yield O(i))}),placeholder:"选择交易品种",children:B.map(s=>{var i;return e.jsxs(es,{value:s.symbol,children:[s.name," (",s.symbol,") - ",((i=Te.find(y=>y.id===s.source_id))==null?void 0:i.name)||"未知数据源"]},s.id)})})})}),e.jsx(x,{span:8,children:e.jsx(F.Item,{label:"回测周期",required:!0,children:e.jsx(Gt.RangePicker,{value:Se,onChange:s=>{s&&s[0]&&s[1]&&ie([s[0].startOf("day"),s[1].endOf("day")])},style:{width:"100%"},placeholder:["开始日期","结束日期"],format:"YYYY-MM-DD",allowClear:!1,disabledDate:s=>s&&s>$().endOf("day"),presets:[{label:"Last 7 days",value:[$().subtract(7,"day"),$()]},{label:"Last 30 days",value:[$().subtract(30,"day"),$()]},{label:"Last 3 months",value:[$().subtract(3,"month"),$()]},{label:"Last 6 months",value:[$().subtract(6,"month"),$()]},{label:"Last 1 year",value:[$().subtract(1,"year"),$()]},{label:"Last 3 years",value:[$().subtract(3,"year"),$()]},{label:"Last 5 years",value:[$().subtract(5,"year"),$()]},{label:"Last 7 years",value:[$().subtract(7,"year"),$()]},{label:"Last 10 years",value:[$().subtract(10,"year"),$()]}]})})})]}),e.jsxs(J,{gutter:24,children:[e.jsx(x,{span:6,children:e.jsx(F.Item,{label:"初始资金",children:e.jsx(Bt,{value:z,onChange:s=>M(Number(s)||1e5),formatter:s=>`¥ ${s}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:s=>{if(s){const i=parseFloat(s.replace(/\¥\s?|(,*)/g,""));return isNaN(i)?z:i}return z},style:{width:"100%"}})})}),e.jsx(x,{span:6,children:e.jsx(F.Item,{label:"手续费率(%)",children:e.jsx(Bt,{value:g,onChange:s=>I(Number(s)||.15),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(x,{span:6,children:e.jsx(F.Item,{label:"滑点(%)",children:e.jsx(Bt,{value:R,onChange:s=>X(Number(s)||.1),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(x,{span:6,children:e.jsx(F.Item,{label:"基准",children:e.jsxs(Ye,{defaultValue:"SPY",placeholder:"选择基准",children:[e.jsx(es,{value:"SPY",children:"标普500ETF"}),e.jsx(es,{value:"QQQ",children:"纳斯达克ETF"}),e.jsx(es,{value:"DIA",children:"道琼斯ETF"})]})})})]}),j&&e.jsx(xt,{message:`已选择数据源: ${((n=Te.find(s=>s.id===j.source_id))==null?void 0:n.name)||"未知"}`,description:`回测将使用与数据管理中相同的数据源获取 ${j.symbol} 的历史数据`,type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(F.Item,{label:"执行模式",children:e.jsxs($e,{children:[e.jsx(ur,{checked:S,onChange:me,checkedChildren:"异步",unCheckedChildren:"同步"}),e.jsx(_e,{title:S?"异步模式：任务在后台执行，可以处理大数据量回测":"同步模式：立即返回结果，适合快速回测",children:e.jsx(Je,{style:{color:"#aaa"}})}),S&&ke&&e.jsxs(Le,{color:Ce==="completed"?"green":Ce==="failed"?"red":"blue",children:["任务状态: ",Ce==="pending"?"等待中":Ce==="running"?"执行中":Ce==="completed"?"已完成":Ce==="failed"?"失败":Ce,Ce==="running"&&` (${ee}%)`]})]})}),e.jsx(F.Item,{children:e.jsxs($e,{children:[e.jsx(P,{type:"primary",icon:e.jsx(Wt,{}),loading:l,onClick:vs,children:S?"提交异步回测":"运行回测"}),e.jsx(P,{type:"default",icon:e.jsx(Wt,{}),loading:l,onClick:_s,title:"强制刷新：清除缓存并重新运行回测",disabled:S,children:"强制刷新"})]})})]})})}),m&&e.jsxs(e.Fragment,{children:[e.jsx(gs,{}),e.jsxs(oe,{children:[e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["总收益率 ",e.jsx(_e,{title:"总收益率=最终资金/初始资金-1，反映策略总体收益情况",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.totalReturn,precision:2,valueStyle:{color:qe.totalReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(_e,{title:"年化收益率=（总收益率+1）^(365/天数)-1，反映策略年化增长速度",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.annualReturn,precision:2,valueStyle:{color:qe.annualReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(_e,{title:"最大回撤=历史最高点到最低点的最大跌幅，衡量风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Math.abs(qe.maxDrawdown),precision:2,valueStyle:{color:"#52c41a"},suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(_e,{title:"夏普比率=（年化收益率-无风险利率）/年化波动率，衡量单位风险收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.sharpeRatio,precision:2})})]}),e.jsx(J,{gutter:16,style:{marginTop:16},children:e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["胜率 ",e.jsx(_e,{title:"胜率=盈利交易次数/总交易次数",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.winRate,precision:2,suffix:"%"})})}),e.jsxs(J,{gutter:16,style:{marginTop:24},children:[e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(_e,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.profitFactor||0,precision:2})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["Alpha ",e.jsx(_e,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.alpha||0,precision:2,suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["Beta ",e.jsx(_e,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.beta||0,precision:2})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["交易次数 ",e.jsx(_e,{title:"策略在回测期间的总交易次数",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:ce.length})})]}),e.jsx(gs,{}),e.jsx(ps,{defaultActiveKey:"1",items:Mt()}),e.jsxs("div",{style:{textAlign:"right",marginTop:16},children:[e.jsx(P,{icon:e.jsx(ka,{}),style:{marginRight:8},children:"导出报告"}),e.jsx(P,{icon:e.jsx(Da,{}),type:"primary",onClick:()=>{const s=new Date,i=s.toISOString().slice(0,10).replace(/-/g,""),y=s.toTimeString().slice(0,5).replace(":",""),D=`${(j==null?void 0:j.symbol)||"UNKNOWN"}_v${i}_${y}`;N(D),u(!0)},disabled:!m,children:"保存回测"})]})]})]}),e.jsx(Re,{title:"保存回测",open:a,onOk:ls,onCancel:()=>{u(!1),N(""),ne("")},confirmLoading:p,okText:"保存",cancelText:"取消",children:e.jsxs(F,{layout:"vertical",children:[e.jsx(F.Item,{label:"回测名称",required:!0,help:"请输入一个描述性的回测名称",children:e.jsx(we,{placeholder:"例如：MA交叉策略_AAPL_2024年回测",value:L,onChange:s=>N(s.target.value)})}),e.jsx(F.Item,{label:"回测描述",help:"可选：添加回测的详细描述",children:e.jsx(we.TextArea,{placeholder:"例如：使用移动平均线交叉策略对AAPL进行回测，包含仓位控制...",value:Q,onChange:s=>ne(s.target.value),rows:3})}),e.jsx(xt,{message:"保存信息",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"策略："}),v]}),e.jsxs("p",{children:[e.jsx("strong",{children:"股票："}),j==null?void 0:j.symbol," (",j==null?void 0:j.name,")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"回测期间："}),Se[0].format("YYYY-MM-DD")," 至 ",Se[1].format("YYYY-MM-DD")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"初始资金："}),"$",z.toLocaleString()]}),Object.keys(f).length>0&&e.jsxs("p",{children:[e.jsx("strong",{children:"策略参数："}),"短期均线 ",f.short_window||5,"天, 长期均线 ",f.long_window||20,"天"]})]}),type:"info",showIcon:!0})]})}),e.jsxs(Re,{title:"策略参数设置",open:V,onOk:ae,onCancel:()=>re(!1),width:800,children:[e.jsx(xt,{message:`当前策略: ${(st==null?void 0:st.name)||v}`,description:(st==null?void 0:st.description)||"策略参数配置",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(F,{layout:"vertical",children:[G.length>0?e.jsx(J,{gutter:16,children:G.map((s,i)=>e.jsx(x,{span:12,children:e.jsx(F.Item,{label:`${s.parameter_name}${s.description?` (${s.description})`:""}`,help:s.description,children:s.parameter_type==="int"?e.jsx(Bt,{value:f[s.parameter_name]||s.min_value,onChange:y=>_(D=>fs(ms({},D),{[s.parameter_name]:y})),min:s.min_value,max:s.max_value,step:s.step_size,style:{width:"100%"}}):s.parameter_type==="float"?e.jsx(Bt,{value:f[s.parameter_name]||s.min_value,onChange:y=>_(D=>fs(ms({},D),{[s.parameter_name]:y})),min:s.min_value,max:s.max_value,step:s.step_size,precision:2,style:{width:"100%"}}):s.parameter_type==="choice"?e.jsx(Ye,{value:f[s.parameter_name]!==void 0?f[s.parameter_name]:s.choices&&s.choices.length>0?s.choices[0]:void 0,onChange:y=>_(D=>fs(ms({},D),{[s.parameter_name]:y})),style:{width:"100%"},children:(s.choices||[]).map((y,D)=>e.jsx(es,{value:y,children:typeof y=="boolean"?y?"true":"false":String(y)},D))}):e.jsx(we,{value:f[s.parameter_name]||"",onChange:y=>_(D=>fs(ms({},D),{[s.parameter_name]:y.target.value})),placeholder:`请输入${s.parameter_name}`})})},s.parameter_name))}):e.jsx(xt,{message:"暂无参数配置",description:"该策略暂未配置参数空间，将使用默认参数进行回测",type:"warning",showIcon:!0}),G.length>0&&e.jsx(xt,{message:"参数说明",description:e.jsx("div",{children:G.map((s,i)=>e.jsxs("p",{children:[e.jsxs("strong",{children:[s.parameter_name,"："]}),s.description,s.parameter_type==="int"||s.parameter_type==="float"?` (范围: ${s.min_value} - ${s.max_value}, 步长: ${s.step_size})`:s.parameter_type==="choice"?` (选项: ${(s.choices||[]).map(y=>typeof y=="boolean"?y?"true":"false":String(y)).join(", ")})`:""]},i))}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs($e,{children:[e.jsx(P,{onClick:ye,children:"重置默认值"}),e.jsx(P,{type:"dashed",onClick:at,children:"从优化导入"})]})]})]}),e.jsxs(Re,{title:"选择优化结果",open:Ge,onCancel:()=>nt(!1),width:800,footer:null,children:[e.jsx(xt,{message:"选择要导入的优化结果",description:"以下是从参数优化中获得的最佳参数配置，按优化得分排序",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("div",{style:{maxHeight:400,overflowY:"auto"},children:Ne.map((s,i)=>{var y;return e.jsxs(oe,{size:"small",style:{marginBottom:8},hoverable:!0,onClick:()=>Ae(s),children:[e.jsxs(J,{gutter:16,align:"middle",children:[e.jsx(x,{span:16,children:e.jsxs("div",{children:[e.jsx("strong",{children:s.job_name}),e.jsxs("div",{style:{fontSize:"12px",color:"#666",marginTop:4},children:[s.description&&`${s.description} • `,"完成时间: ",s.completed_at?$.utc(s.completed_at).tz("Asia/Shanghai").format("YYYY/MM/DD HH:mm:ss"):"未知"]})]})}),e.jsx(x,{span:4,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"14px",fontWeight:"bold",color:"#1890ff"},children:(y=s.best_score)==null?void 0:y.toFixed(4)}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:s.objective_function})]})}),e.jsx(x,{span:4,children:e.jsx("div",{style:{textAlign:"center"},children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:["试验次数: ",s.total_trials]})})})]}),e.jsxs("div",{style:{marginTop:8,fontSize:"12px"},children:[e.jsx("strong",{children:"关键参数:"}),e.jsxs("div",{style:{marginTop:4,maxHeight:"40px",overflow:"hidden"},children:[Object.entries(s.best_parameters||{}).slice(0,3).map(([D,Z])=>e.jsxs(Le,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[D==="short_window"?"短期":D==="long_window"?"长期":D==="min_reversal_points"?"反转点":D==="lookback_period"?"回望期":D==="signal_strength_threshold"?"信号阈值":D==="batch_count"?"批次数":D==="stop_loss_ratio"?"止损":D==="take_profit_ratio"?"止盈":D,": ",typeof Z=="number"?Z.toFixed(1):String(Z)]},D)),Object.keys(s.best_parameters||{}).length>3&&e.jsxs(Le,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",Object.keys(s.best_parameters||{}).length-3,"个"]})]})]})]},s.job_id)})}),Ne.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"40px 0",color:"#999"},children:"暂无优化结果"})]})]})},yn=o.memo(gn);var jn=Object.defineProperty,bn=Object.defineProperties,vn=Object.getOwnPropertyDescriptors,da=Object.getOwnPropertySymbols,_n=Object.prototype.hasOwnProperty,wn=Object.prototype.propertyIsEnumerable,ua=(n,r,l)=>r in n?jn(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,xs=(n,r)=>{for(var l in r||(r={}))_n.call(r,l)&&ua(n,l,r[l]);if(da)for(var l of da(r))wn.call(r,l)&&ua(n,l,r[l]);return n},$s=(n,r)=>bn(n,vn(r)),$t=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});$.extend($a);$.extend(Ia);$.tz.setDefault("Asia/Shanghai");const{Title:Sn,Text:Qe}=Tt,{Option:Ht}=Ye,{TabPane:pa}=ps,kn=()=>{const[n,r]=o.useState([]),[l,b]=o.useState(null),[m,w]=o.useState([]),[z,M]=o.useState([]),[g,I]=o.useState(!1),R=o.useRef(!1),[X]=F.useForm(),[B,Ie]=o.useState(!1),[Oe,pe]=o.useState(!1),[U,he]=o.useState(!1),[v,W]=o.useState(null),[j,Ve]=o.useState(null),[Se,ie]=o.useState(!1),[Te,Xe]=o.useState([]),[ce,et]=o.useState(!1),[te,Pe]=o.useState([]),[ge,rt]=o.useState({}),[zt,ct]=o.useState([]),[qe,We]=o.useState(!1),ze=o.useCallback(()=>{const t=n.find(L=>L.id===l),a=(t==null?void 0:t.name)||"策略优化",p=X.getFieldsValue().symbol||"AAPL",A=$().format("YYYYMMDD");return`${p}_${A}_${a}`},[l,n,X]),bt=o.useCallback(()=>{if(!qe){const t=ze();X.setFieldValue("name",t)}},[qe,ze,X]),vt=()=>$t(void 0,null,function*(){try{const t=yield q.get("/api/strategies");t.data&&t.data.data&&r(t.data.data)}catch(t){console.error("加载策略列表失败:",t),d.error("加载策略列表失败")}}),pt=()=>$t(void 0,null,function*(){try{const t=yield q.get("/api/data/stocks");if(t.data&&Array.isArray(t.data)){const a=t.data.map(u=>({symbol:u.symbol,name:u.name}));ct(a)}}catch(t){console.error("加载股票列表失败:",t),ct([{symbol:"AAPL",name:"Apple Inc."},{symbol:"TSLA",name:"Tesla Inc."},{symbol:"MSFT",name:"Microsoft Corporation"},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"AMZN",name:"Amazon.com Inc."}])}}),ft=t=>$t(void 0,null,function*(){try{const a=yield q.get(`/api/data/stock/symbol/${t}/date-range`);if(a.data&&a.data.status==="success"){const{min_date:u,max_date:p}=a.data.data;rt({min_date:u,max_date:p}),u&&p&&X.setFieldsValue({start_date:$(u),end_date:$(p)})}}catch(a){console.error("获取股票数据范围失败:",a)}}),He=t=>{const a=$();let u,p=a;switch(t){case"recent1y":u=a.subtract(1,"year");break;case"recent3y":u=a.subtract(3,"year");break;case"recent5y":u=a.subtract(5,"year");break;case"recent6y":u=a.subtract(6,"year");break;case"recent7y":u=a.subtract(7,"year");break;case"recent8y":u=a.subtract(8,"year");break;case"recent9y":u=a.subtract(9,"year");break;case"recent10y":u=a.subtract(10,"year");break;case"full":ge.min_date&&ge.max_date?(u=$(ge.min_date),p=$(ge.max_date)):u=a.subtract(5,"year");break;default:u=a.subtract(1,"year")}X.setFieldsValue({start_date:u,end_date:p})},gt=t=>$t(void 0,null,function*(){try{const a=yield q.get(`/api/optimization/strategies/${t}/parameter-spaces`);a.data&&a.data.status==="success"&&w(a.data.data)}catch(a){console.error("加载参数空间失败:",a)}}),tt=t=>$t(void 0,null,function*(){var a;try{I(!0);const u=t?{strategy_id:t}:{},p=yield q.get("/api/optimization/jobs",{params:u});if(p.data&&p.data.status==="success"){const A=Array.isArray((a=p.data.data)==null?void 0:a.jobs)?p.data.data.jobs:[];M(A),d.success("刷新成功")}else M([]),d.warning("没有找到优化任务")}catch(u){console.error("加载优化任务失败:",u),M([]),d.error("加载优化任务失败")}finally{I(!1)}}),Ke=t=>{b(t),gt(t),tt(t)},k=()=>{w([...m,{parameter_name:"",parameter_type:"float",min_value:0,max_value:1,step_size:.1,description:""}])},f=t=>{w(m.filter((a,u)=>u!==t))},_=(t,a,u)=>{const p=[...m];p[t]=$s(xs({},p[t]),{[a]:u}),w(p)},V=t=>{if(!Array.isArray(t))return!1;const a=t.map(A=>typeof A=="string"?A.toLowerCase():A),u=a.includes(!0)||a.includes("true"),p=a.includes(!1)||a.includes("false");return a.length===2&&u&&p},re=()=>$t(void 0,null,function*(){if(!l){d.error("请先选择策略");return}try{I(!0),yield q.post(`/api/optimization/strategies/${l}/parameter-spaces`,m),d.success("参数空间保存成功"),Ie(!1)}catch(t){console.error("保存参数空间失败:",t),d.error("保存参数空间失败")}finally{I(!1)}}),G=()=>$t(void 0,null,function*(){var t;if(!l){d.error("请先选择策略");return}try{I(!0);const a=yield q.get(`/api/optimization/strategies/${l}/parameter-spec`),u=((t=a==null?void 0:a.data)==null?void 0:t.data)||[];if(!Array.isArray(u)||u.length===0){d.warning("未识别到策略参数");return}const p=[];for(const N of u){const Q=N==null?void 0:N.name,ne=N==null?void 0:N.type,S=N==null?void 0:N.default;if(!(!Q||!ne))if(ne==="integer"){const me=typeof S=="number"?S:typeof S=="string"?parseFloat(S):10;let ke=Math.floor((isNaN(me)?10:me)*.5),le=Math.ceil((isNaN(me)?10:me)*1.5);ke<1&&(ke=1),le<=ke&&(le=ke+1),p.push({parameter_name:Q,parameter_type:"int",min_value:ke,max_value:le,step_size:1,description:"自动识别（±50%范围）"})}else if(ne==="float"){const me=typeof S=="number"?S:typeof S=="string"?parseFloat(S):1,ke=isNaN(me)?1:me;let le=ke*.5,Ce=ke*1.5;Ce<=le&&(Ce=le+(Math.abs(ke)||1));const Y=Math.max(1e-4,Math.abs(ke)*.1||.1);p.push({parameter_name:Q,parameter_type:"float",min_value:Number(le.toFixed(6)),max_value:Number(Ce.toFixed(6)),step_size:Number(Y.toFixed(6)),description:"自动识别（±50%范围）"})}else if(ne==="boolean")p.push({parameter_name:Q,parameter_type:"choice",choices:[!0,!1],description:"自动识别（布尔类型）"});else if(ne==="string")p.push({parameter_name:Q,parameter_type:"choice",choices:typeof S<"u"?[S]:[],description:"自动识别（字符串类型，请手动设置备选项）"});else continue}if(p.length===0){d.warning("未识别到可优化的数值型参数");return}const A=new Map((m||[]).map(N=>[N.parameter_name,N])),L=p.map(N=>{const Q=A.get(N.parameter_name);if(Q){const ne=!!Q.description&&String(Q.description).trim().length>0;return $s(xs({},N),{description:ne?Q.description:N.description})}return N});for(const[N,Q]of A.entries())L.some(ne=>ne.parameter_name===N)||L.push(Q);w(L),d.success(`已自动识别 ${p.length} 个参数，请完善范围后保存`)}catch(a){console.error("自动识别策略参数失败:",a),d.error("自动识别策略参数失败")}finally{I(!1)}}),Fe=t=>$t(void 0,null,function*(){try{I(!0),W(t),console.log("🔍 开始获取试验列表:",t.name);const a=performance.now();try{console.log("📊 尝试获取轻量级试验摘要...");const L=yield q.get(`/api/optimization/jobs/${t.id}/trials-summary`),N=performance.now();if(console.log(`✅ 轻量级试验摘要耗时: ${(N-a).toFixed(0)}ms`),L.data&&L.data.status==="success"){console.log(`📊 获取到 ${L.data.data.length} 个试验摘要`),Xe(L.data.data),ie(!0);return}}catch(L){console.warn("⚠️ 轻量级摘要API失败，使用完整数据:",L)}console.log("📋 获取完整试验数据...");const u=performance.now(),p=yield q.get(`/api/optimization/jobs/${t.id}/trials`),A=performance.now();console.log(`📊 完整试验数据耗时: ${(A-u).toFixed(0)}ms`),p.data&&p.data.status==="success"?(console.log(`📊 获取到 ${p.data.data.length} 个完整试验结果`),Xe(p.data.data),ie(!0)):d.error("获取试验数据失败")}catch(a){console.error("获取试验数据失败:",a),d.error("获取试验数据失败")}finally{I(!1)}}),st=(t,a=!1)=>$t(void 0,null,function*(){var u,p;try{if(t.status==="running"&&!a){d.error("运行中的任务不能删除，请先停止任务");return}const A=a?`/api/optimization/jobs/${t.id}?force=true`:`/api/optimization/jobs/${t.id}`,L=yield q.delete(A);L.data&&L.data.status==="success"?(d.success(L.data.message||"删除成功"),yield tt()):d.error("删除失败")}catch(A){console.error("删除优化任务失败:",A);const L=((p=(u=A.response)==null?void 0:u.data)==null?void 0:p.detail)||A.message||"删除失败";d.error(L)}}),Ee=t=>$t(void 0,null,function*(){try{I(!0),W(t),console.log("🚀 开始获取任务详情:",t.name);const a=performance.now();if(t.best_parameters&&t.status==="completed"&&t.optimization_config){try{console.log("📊 尝试获取轻量级性能指标...");const Q=yield q.get(`/api/optimization/jobs/${t.id}/best-performance`);if(Q.data&&Q.data.status==="success"){const ne=performance.now();console.log(`✅ 使用轻量级API，耗时: ${(ne-a).toFixed(0)}ms`);const S=Q.data.data,me={total_return:S.total_return,annual_return:S.annual_return,sharpe_ratio:S.sharpe_ratio,max_drawdown:S.max_drawdown,win_rate:S.win_rate,profit_factor:S.profit_factor,alpha:S.alpha,beta:S.beta,total_trades:S.total_trades,parameters:S.parameters,fromOptimization:!0,isLightweight:!0};Ve(me),he(!0),I(!1);return}}catch(Q){console.warn("⚠️ 轻量级API失败，尝试完整数据:",Q)}try{console.log("📊 尝试获取完整回测结果...");const Q=yield q.get(`/api/optimization/jobs/${t.id}/trials`);if(Q.data&&Q.data.status==="success"&&Q.data.data.length>0){const ne=Q.data.data[0];if(ne.backtest_results){const S=performance.now();console.log(`✅ 使用完整缓存结果，耗时: ${(S-a).toFixed(0)}ms`);const me=$s(xs({},ne.backtest_results),{fromOptimization:!0});Ve(me),he(!0),I(!1);return}else console.warn("⚠️ 最佳试验没有缓存的回测结果")}}catch(Q){console.warn("❌ 无法获取优化试验数据，将重新运行回测:",Q)}console.log("🔄 缓存未命中，重新运行回测...");const u=performance.now(),p=t.optimization_config.backtest_config,A={strategy_id:t.strategy_id,parameters:t.best_parameters,symbol:p.symbol,start_date:p.start_date,end_date:p.end_date,initial_capital:p.initial_capital};console.log("📋 回测请求参数:",A);const L=yield q.post("/api/strategies/backtest",A),N=performance.now();console.log(`⏱️ 重新回测耗时: ${(N-u).toFixed(0)}ms`),L.data&&L.data.status==="success"?Ve(L.data.data):(console.error("回测失败:",L.data),d.error("回测失败，无法获取详细结果"))}else t.status==="completed"&&d.warning("优化配置信息不完整，无法重现回测结果");he(!0)}catch(a){console.error("获取任务详情失败:",a),d.error("获取任务详情失败")}finally{I(!1)}}),Ge=t=>$t(void 0,null,function*(){if(!l){d.error("请先选择策略");return}if(m.length===0){d.error("请先配置参数空间");return}try{I(!0);const a={strategy_id:l,name:t.name,description:t.description,parameter_spaces:m,objective_function:t.objective_function,n_trials:t.n_trials,timeout:t.timeout,backtest_config:{symbol:t.symbol,start_date:t.start_date.format("YYYY-MM-DD"),end_date:t.end_date.format("YYYY-MM-DD"),initial_capital:t.initial_capital}};yield q.post("/api/optimization/optimize",a),d.success("优化任务已启动"),pe(!1),X.resetFields(),tt(l)}catch(a){console.error("启动优化任务失败:",a),d.error("启动优化任务失败")}finally{I(!1)}}),nt=t=>$t(void 0,null,function*(){try{if(I(!0),t.backtest_results&&t.backtest_results.logs&&t.backtest_results.logs.length>0){console.log("📋 使用当前记录中的日志"),Pe(t.backtest_results.logs),et(!0);return}console.log("🔍 获取完整试验数据以获取日志...");const a=yield q.get(`/api/optimization/jobs/${v==null?void 0:v.id}/trials`);if(a.data&&a.data.status==="success"){const p=a.data.data.find(A=>A.trial_number===t.trial_number||A.id===t.id||A.parameters&&t.parameters&&JSON.stringify(A.parameters)===JSON.stringify(t.parameters));p&&p.backtest_results&&p.backtest_results.logs?(console.log(`📋 找到完整试验数据，日志条数: ${p.backtest_results.logs.length}`),Pe(p.backtest_results.logs),et(!0)):d.warning("该试验暂无日志数据")}else d.error("获取试验日志失败")}catch(a){console.error("获取试验日志失败:",a),d.error("获取试验日志失败")}finally{I(!1)}}),Ne=[{title:"ID",dataIndex:"id",key:"id",width:50,align:"center"},{title:"任务名称",dataIndex:"name",key:"name",width:160,ellipsis:!0},{title:"策略",dataIndex:"strategy_id",key:"strategy",width:120,ellipsis:{showTitle:!1},render:t=>{const a=n.find(u=>u.id===t);return a?e.jsx(_e,{title:a.name,placement:"topLeft",children:e.jsx(Le,{color:"blue",style:{margin:0,maxWidth:"100px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"inline-block",cursor:"pointer"},children:a.name})}):e.jsx(Qe,{type:"secondary",style:{fontSize:"12px"},children:"未知策略"})}},{title:"状态",dataIndex:"status",key:"status",width:70,align:"center",render:t=>{const u={running:{color:"processing",text:"运行中"},completed:{color:"success",text:"已完成"},failed:{color:"error",text:"失败"},cancelled:{color:"default",text:"已取消"}}[t]||{color:"default",text:t};return e.jsx(Le,{color:u.color,children:u.text})}},{title:"进度",dataIndex:"progress",key:"progress",width:90,render:(t,a)=>{const u=`${a.completed_trials}/${a.total_trials}`,p=`${t.toFixed(1)}%`;return e.jsx(_e,{title:e.jsxs("div",{children:[e.jsxs("div",{children:["已完成试验: ",a.completed_trials]}),e.jsxs("div",{children:["总试验数: ",a.total_trials]}),e.jsxs("div",{children:["完成进度: ",t.toFixed(1),"%"]})]}),placement:"topLeft",children:e.jsxs("div",{style:{width:"80px",textAlign:"center"},children:[e.jsx(pr,{percent:t,size:"small",style:{marginBottom:"1px"},showInfo:!1}),e.jsxs("div",{style:{fontSize:"10px",color:"#666",lineHeight:"1.2"},children:[u," (",p,")"]})]})})}},{title:"最佳得分",dataIndex:"best_score",key:"best_score",width:100,align:"center",render:(t,a)=>{if(!t)return"-";const p={sharpe_ratio:"夏普比率",total_return:"总收益率",annual_return:"年化收益率"}[a.objective_function]||"得分";return e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",color:"#1890ff"},children:t.toFixed(4)}),e.jsx(Qe,{type:"secondary",style:{fontSize:"11px"},children:p})]})}},{title:"交易配置",dataIndex:"optimization_config",key:"trading_config",width:110,align:"center",render:t=>{if(!t||!t.backtest_config)return"-";const{symbol:a,initial_capital:u}=t.backtest_config;return e.jsxs("div",{children:[e.jsx(Le,{color:"green",style:{marginBottom:"2px"},children:a}),e.jsxs("div",{style:{fontSize:"11px",color:"#666"},children:["¥",(u==null?void 0:u.toLocaleString())||"N/A"]})]})}},{title:"回测时间段",dataIndex:"optimization_config",key:"date_range",width:140,render:t=>{if(!t||!t.backtest_config)return"-";const{start_date:a,end_date:u}=t.backtest_config;return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a}),e.jsx("div",{style:{fontSize:"10px",color:"#999",margin:"2px 0"},children:"至"}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:u})]})}},{title:"最佳参数",dataIndex:"best_parameters",key:"best_parameters",width:200,render:t=>{if(!t)return"-";const a=Object.entries(t),u=3,p=a.slice(0,u),A=a.length-u;return e.jsxs("div",{style:{maxHeight:"60px",overflow:"hidden"},children:[p.map(([L,N])=>e.jsxs(Le,{color:"blue",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[L==="short_window"?"短期":L==="long_window"?"长期":L==="min_reversal_points"?"反转点":L==="lookback_period"?"回望期":L==="signal_strength_threshold"?"信号阈值":L==="batch_count"?"批次数":L==="stop_loss_ratio"?"止损":L==="take_profit_ratio"?"止盈":L,": ",typeof N=="number"?N.toFixed(2):N]},L)),A>0&&e.jsxs(Le,{color:"default",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",A,"个"]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:140,render:t=>{const a=$.utc(t).tz("Asia/Shanghai");return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px"},children:a.format("YYYY-MM-DD")}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a.format("HH:mm:ss")})]})}},{title:"操作",key:"action",width:100,align:"center",render:(t,a)=>{const u=$.utc(a.created_at).tz("Asia/Shanghai"),p=a.status==="running"&&$().diff(u,"hour")>=1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx(P,{type:"link",icon:e.jsx(qs,{}),onClick:()=>Ee(a),size:"small",disabled:a.status!=="completed",style:{padding:"2px 8px",height:"auto",fontSize:"12px"},children:"查看回测"}),e.jsx(P,{type:"link",onClick:()=>Fe(a),size:"small",disabled:a.status!=="completed",style:{color:"#1890ff",padding:"2px 8px",height:"auto",fontSize:"12px"},children:"其他回测"}),e.jsx(hr,{title:"确认删除",description:p?`检测到异常状态，确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`:`确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`,onConfirm:()=>st(a,p),okText:"确定",cancelText:"取消",disabled:a.status==="running"&&!p,placement:"top",children:e.jsx(P,{danger:!0,size:"small",disabled:a.status==="running"&&!p,icon:e.jsx(us,{}),style:xs({padding:"2px 8px",height:"auto",fontSize:"12px"},p&&{borderColor:"#ff7875",color:"#ff7875"}),children:p?"强制删除":"删除"})})]})}}];return o.useEffect(()=>{R.current||(R.current=!0,vt(),tt(),pt(),ft("AAPL"))},[]),e.jsxs("div",{style:{padding:"16px",height:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs(oe,{style:{marginBottom:"16px",flexShrink:0},children:[e.jsx(Sn,{level:3,style:{margin:"0 0 16px 0"},children:"策略参数优化"}),e.jsxs(J,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(x,{span:8,children:e.jsx(Ye,{placeholder:"选择策略",style:{width:"100%"},value:l,onChange:Ke,children:n.map(t=>e.jsx(Ht,{value:t.id,children:t.name},t.id))})}),e.jsx(x,{span:16,children:e.jsxs($e,{children:[e.jsx(P,{icon:e.jsx(js,{}),onClick:()=>Ie(!0),disabled:!l,children:"配置参数空间"}),e.jsx(P,{type:"primary",icon:e.jsx(Wt,{}),onClick:()=>{pe(!0),We(!1),setTimeout(()=>bt(),100)},disabled:!l||m.length===0,children:"启动优化"}),e.jsx(P,{icon:e.jsx(Bs,{}),onClick:()=>{console.log("刷新按钮被点击"),tt(l||void 0)},children:"刷新"})]})})]})]}),e.jsx(oe,{title:"优化任务列表",style:{flex:1,display:"flex",flexDirection:"column",minHeight:0},styles:{body:{flex:1,padding:"16px",display:"flex",flexDirection:"column",minHeight:0}},children:e.jsx(Zt,{columns:Ne,dataSource:z,rowKey:"id",loading:g,size:"small",scroll:{x:1200,y:"calc(100vh - 320px)"},pagination:{pageSize:it.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条记录`,size:"small",onChange:(t,a)=>{it.setCurrentPage(t),it.setPageSize(a||20)},onShowSizeChange:(t,a)=>{it.setPageSize(a)}},style:{flex:1}})}),e.jsxs(Re,{title:"配置参数空间",open:B,onOk:re,onCancel:()=>Ie(!1),width:900,confirmLoading:g,children:[e.jsx(xt,{message:"MA交叉策略参数优化指南",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"short_window"}),": 短期移动平均线周期，建议范围 3-15天"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"long_window"}),": 长期移动平均线周期，建议范围 10-60天"]}),e.jsx("p",{children:"注意：短期周期必须小于长期周期"})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(P,{type:"dashed",onClick:k,icon:e.jsx(Ma,{}),block:!0,children:"添加参数"})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsxs($e,{children:[e.jsx(P,{type:"link",onClick:()=>{w([{parameter_name:"short_window",parameter_type:"int",min_value:3,max_value:15,step_size:1,description:"短期移动平均线周期"},{parameter_name:"long_window",parameter_type:"int",min_value:10,max_value:60,step_size:5,description:"长期移动平均线周期"}])},children:"📊 使用MA策略推荐配置"}),e.jsx(P,{type:"link",onClick:G,children:"🔎 自动识别策略参数"})]})}),m.map((t,a)=>e.jsx(oe,{size:"small",style:{marginBottom:"8px"},children:e.jsxs(J,{gutter:[8,8],children:[e.jsx(x,{span:4,children:e.jsx(we,{placeholder:"参数名",value:t.parameter_name,onChange:u=>_(a,"parameter_name",u.target.value)})}),e.jsx(x,{span:3,children:e.jsxs(Ye,{value:t.parameter_type==="choice"&&V(t.choices)?"boolean":t.parameter_type,onChange:u=>{const p=String(u);p==="boolean"?(_(a,"parameter_type","choice"),_(a,"choices",[!0,!1]),t.description||_(a,"description","布尔类型")):_(a,"parameter_type",p)},style:{width:"100%"},children:[e.jsx(Ht,{value:"int",children:"整数"}),e.jsx(Ht,{value:"float",children:"小数"}),e.jsx(Ht,{value:"choice",children:"选择"}),e.jsx(Ht,{value:"boolean",children:"布尔"})]})}),t.parameter_type!=="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(x,{span:3,children:e.jsx(Bt,{placeholder:"最小值",value:t.min_value,onChange:u=>_(a,"min_value",u),style:{width:"100%"}})}),e.jsx(x,{span:3,children:e.jsx(Bt,{placeholder:"最大值",value:t.max_value,onChange:u=>_(a,"max_value",u),style:{width:"100%"}})})]}),t.parameter_type==="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(x,{span:6,children:e.jsx(Ye,{mode:"tags",style:{width:"100%"},placeholder:"备选项（输入后回车添加）",value:(t.choices||[]).map(u=>typeof u=="boolean"?u?"true":"false":String(u)),onChange:u=>{const p=u.map(A=>{if(typeof A=="string"){const L=A.trim();if(L.toLowerCase()==="true")return!0;if(L.toLowerCase()==="false")return!1;const N=Number(L);return isNaN(N)?L:N}return A});_(a,"choices",p)}})}),e.jsx(x,{span:3,children:e.jsx(P,{onClick:()=>_(a,"choices",[!0,!1]),style:{width:"100%"},children:"填充布尔(True/False)"})})]}),e.jsx(x,{span:4,children:e.jsx(we,{placeholder:"描述",value:t.description,onChange:u=>_(a,"description",u.target.value)})}),e.jsx(x,{span:2,children:e.jsx(P,{type:"text",danger:!0,icon:e.jsx(us,{}),onClick:()=>f(a)})})]})},a))]}),e.jsxs(Re,{title:"启动参数优化",open:Oe,onOk:()=>X.submit(),onCancel:()=>pe(!1),width:700,confirmLoading:g,children:[e.jsx(xt,{message:"优化说明",description:"系统将自动测试不同参数组合，找到最优的策略参数。建议先用较少试验次数快速测试。",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(F,{form:X,onFinish:Ge,layout:"vertical",children:[e.jsx(F.Item,{name:"name",label:"任务名称",rules:[{required:!0,message:"请输入任务名称"}],children:e.jsx(we,{placeholder:"如: AAPL_20240101_MA策略优化",onChange:t=>{t.target.value!==ze()?We(!0):We(!1)}})}),e.jsx(F.Item,{name:"description",label:"任务描述",children:e.jsx(we.TextArea,{placeholder:"描述此次优化的目的和预期...",rows:2})}),e.jsxs(J,{gutter:[16,16],children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"objective_function",label:"优化目标",initialValue:"sharpe_ratio",children:e.jsxs(Ye,{children:[e.jsx(Ht,{value:"sharpe_ratio",children:"夏普比率 (推荐)"}),e.jsx(Ht,{value:"total_return",children:"总收益率"}),e.jsx(Ht,{value:"annual_return",children:"年化收益率"})]})})}),e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"n_trials",label:"试验次数",initialValue:50,extra:"建议: 快速测试50次，详细优化100-200次",children:e.jsx(Bt,{min:10,max:1e3,style:{width:"100%"}})})})]}),e.jsxs(J,{gutter:[16,16],children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"symbol",label:"交易品种",rules:[{required:!0,message:"请选择交易品种"}],initialValue:"AAPL",children:e.jsx(Ye,{placeholder:"选择股票代码",showSearch:!0,filterOption:(t,a)=>{var u,p;return((u=a==null?void 0:a.label)!=null?u:"").toLowerCase().includes(t.toLowerCase())||((p=a==null?void 0:a.value)!=null?p:"").toLowerCase().includes(t.toLowerCase())},onChange:t=>{t&&(ft(t),bt())},options:zt.map(t=>({value:t.symbol,label:`${t.symbol} - ${t.name}`}))})})}),e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"initial_capital",label:"初始资金",initialValue:1e5,children:e.jsx(Bt,{min:1e3,style:{width:"100%"},formatter:t=>`¥ ${t}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:t=>t==null?void 0:t.replace(/¥\s?|(,*)/g,"")})})})]}),e.jsx(F.Item,{label:"快捷时间选择",children:e.jsxs($e,{wrap:!0,children:[e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent1y"),children:"最近1年"}),e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent3y"),children:"最近3年"}),e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent5y"),children:"最近5年"}),e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent6y"),children:"最近6年"}),e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent7y"),children:"最近7年"}),e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent8y"),children:"最近8年"}),e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent9y"),children:"最近9年"}),e.jsx(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("recent10y"),children:"最近10年"}),ge.min_date&&ge.max_date&&e.jsxs(P,{size:"small",icon:e.jsx(Et,{}),onClick:()=>He("full"),type:"primary",children:["全部数据 (",ge.min_date," ~ ",ge.max_date,")"]})]})}),e.jsxs(J,{gutter:[16,16],children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"start_date",label:"开始日期",rules:[{required:!0,message:"请选择开始日期"}],initialValue:$("2023-01-01"),children:e.jsx(Gt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择开始日期"})})}),e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"end_date",label:"结束日期",rules:[{required:!0,message:"请选择结束日期"}],initialValue:$("2024-12-31"),children:e.jsx(Gt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择结束日期"})})})]}),e.jsx(xt,{message:"注意事项",description:e.jsxs("ul",{style:{margin:0,paddingLeft:"20px"},children:[e.jsx("li",{children:"确保已配置参数空间"}),e.jsx("li",{children:"优化过程可能需要几分钟到几小时"}),e.jsx("li",{children:"可以在任务列表中查看进度"})]}),type:"warning",showIcon:!0})]})]}),e.jsx(Re,{title:"优化任务详情",open:U,onCancel:()=>{he(!1),W(null),Ve(null)},footer:null,width:1e3,children:v&&e.jsxs("div",{children:[e.jsx(xt,{message:`任务状态: ${v.status==="completed"?"已完成":v.status}`,type:v.status==="completed"?"success":"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(ps,{defaultActiveKey:"1",children:[e.jsxs(pa,{tab:"基本信息",children:[e.jsxs(J,{gutter:[16,16],children:[e.jsxs(x,{span:12,children:[e.jsx(Qe,{strong:!0,children:"任务名称: "}),e.jsx(Qe,{children:v.name})]}),e.jsxs(x,{span:12,children:[e.jsx(Qe,{strong:!0,children:"优化目标: "}),e.jsx(Qe,{children:v.objective_function==="sharpe_ratio"?"夏普比率":v.objective_function==="total_return"?"总收益率":v.objective_function==="annual_return"?"年化收益率":"未知"})]}),e.jsxs(x,{span:12,children:[e.jsx(Qe,{strong:!0,children:"试验次数: "}),e.jsxs(Qe,{children:[v.completed_trials,"/",v.total_trials]})]}),e.jsxs(x,{span:12,children:[e.jsx(Qe,{strong:!0,children:"最佳得分: "}),e.jsx(Qe,{children:v.best_score?v.best_score.toFixed(4):"-"})]})]}),v.optimization_config&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Qe,{strong:!0,children:"回测配置:"}),e.jsxs(J,{gutter:[16,8],style:{marginTop:"8px"},children:[e.jsxs(x,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"交易品种: "}),e.jsx(Le,{color:"green",children:v.optimization_config.backtest_config.symbol})]}),e.jsxs(x,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"初始资金: "}),e.jsxs(Le,{color:"blue",children:["¥",v.optimization_config.backtest_config.initial_capital.toLocaleString()]})]}),e.jsxs(x,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"开始日期: "}),e.jsx(Le,{children:v.optimization_config.backtest_config.start_date})]}),e.jsxs(x,{span:12,children:[e.jsx(Qe,{type:"secondary",children:"结束日期: "}),e.jsx(Le,{children:v.optimization_config.backtest_config.end_date})]})]})]}),v.best_parameters&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Qe,{strong:!0,children:"最优参数组合:"}),e.jsx("div",{style:{marginTop:"8px",maxHeight:"120px",overflowY:"auto"},children:Object.entries(v.best_parameters).map(([t,a])=>e.jsxs(Le,{color:"blue",style:{marginBottom:"4px",marginRight:"4px",fontSize:"11px",padding:"2px 6px"},children:[t==="short_window"?"短期均线":t==="long_window"?"长期均线":t==="min_reversal_points"?"反转点数":t==="lookback_period"?"回望周期":t==="min_price_change"?"最小价格变化":t==="signal_strength_threshold"?"信号强度阈值":t==="max_trading_range"?"最大交易范围":t==="batch_count"?"分批次数":t==="batch_interval"?"分批间隔":t==="position_size_per_batch"?"分批仓位":t==="stop_loss_ratio"?"止损比例":t==="take_profit_ratio"?"止盈比例":t==="rsi_oversold"?"RSI超卖":t==="rsi_overbought"?"RSI超买":t==="volume_threshold"?"成交量阈值":t==="max_extremums"?"最大极值点":t==="min_extremum_distance"?"极值点距离":t,": ",typeof a=="number"?a.toFixed(2):a]},t))})]})]},"1"),e.jsx(pa,{tab:"回测结果",children:j?e.jsxs("div",{children:[e.jsxs(J,{gutter:[16,16],children:[e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"总收益率",value:j.total_return*100,precision:2,suffix:"%",valueStyle:{color:j.total_return>=0?"#3f8600":"#cf1322"}})})}),e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"年化收益率",value:j.annual_return*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"最大回撤",value:j.max_drawdown*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"夏普比率",value:j.sharpe_ratio,precision:3,valueStyle:{color:j.sharpe_ratio>=1?"#3f8600":"#cf1322"}})})})]}),e.jsxs(J,{gutter:[16,16],style:{marginTop:"16px"},children:[e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"胜率",value:j.win_rate*100,precision:2,suffix:"%",valueStyle:{color:j.win_rate>=.5?"#3f8600":"#cf1322"}})})}),e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"盈亏比",value:j.profit_factor,precision:2,valueStyle:{color:j.profit_factor>=1?"#3f8600":"#cf1322"}})})}),e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"交易次数",value:j.trades?j.trades.length:0,valueStyle:{color:"#1890ff"}})})}),e.jsx(x,{span:6,children:e.jsx(oe,{size:"small",children:e.jsx(xe,{title:"Alpha",value:j.alpha,precision:4,valueStyle:{color:j.alpha>=0?"#3f8600":"#cf1322"}})})})]}),e.jsx(xt,{message:"参数说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"夏普比率"}),": 风险调整后收益，",">"," 1.0为优秀，",">"," 2.0为卓越"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"胜率"}),": 盈利交易占总交易的比例，",">"," 50%为良好"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏比"}),": 平均盈利/平均亏损，",">"," 1.0表示盈利大于亏损"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Alpha"}),": 相对于市场的超额收益，",">"," 0表示跑赢市场"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]}):e.jsx("div",{style:{textAlign:"center",padding:"40px"},children:e.jsx(Qe,{type:"secondary",children:"加载回测结果中..."})})},"2")]})]})}),e.jsx(Re,{title:"所有回测试验结果",open:Se,onCancel:()=>{ie(!1),Xe([]),W(null)},footer:null,width:1e3,children:v&&e.jsxs("div",{children:[e.jsx(xt,{message:`任务: ${v.name} - 共${Te.length}个试验，按得分降序排列`,type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx(Zt,{dataSource:Te,rowKey:t=>t.id||t.trial_number||Math.random(),pagination:!1,size:"small",scroll:{y:400},columns:[{title:"排名",key:"rank",width:60,render:(t,a,u)=>{const p=a.rank||u+1;return e.jsx(Le,{color:p===1?"gold":p===2?"silver":p===3?"orange":"default",children:p})}},{title:"得分",dataIndex:"objective_value",key:"objective_value",width:100,render:t=>e.jsx(Qe,{strong:!0,style:{color:"#1890ff"},children:t?t.toFixed(4):"-"}),sorter:(t,a)=>(t.objective_value||0)-(a.objective_value||0),defaultSortOrder:"descend"},{title:"参数组合",dataIndex:"parameters",key:"parameters",width:200,render:t=>e.jsx("div",{children:Object.entries(t||{}).map(([a,u])=>e.jsxs(Le,{color:"blue",style:{marginBottom:"2px"},children:[a==="short_window"?"短期":a==="long_window"?"长期":a,": ",u]},a))})},{title:"年化收益",dataIndex:"annual_return",key:"annual_return",width:90,render:t=>{if(t==null)return"-";const a=t>=0?"#3f8600":"#cf1322";return e.jsxs(Qe,{style:{color:a,fontWeight:"bold"},children:[(t*100).toFixed(1),"%"]})}},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",width:90,render:t=>t==null?"-":e.jsxs(Qe,{style:{color:"#3f8600",fontWeight:"bold"},children:[(Math.abs(t)*100).toFixed(1),"%"]})},{title:"交易次数",dataIndex:"total_trades",key:"total_trades",width:80,render:t=>e.jsx(Qe,{type:"secondary",children:t||0})},{title:"执行时间",dataIndex:"execution_time",key:"execution_time",width:80,render:t=>e.jsx(Qe,{type:"secondary",children:t?`${(t*1e3).toFixed(0)}ms`:"-"})},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:150,render:t=>t?$.utc(t).tz("Asia/Shanghai").format("HH:mm:ss"):"-"},{title:"日志",key:"logs",width:80,render:(t,a)=>e.jsx(_e,{title:"查看日志",children:e.jsx(P,{type:"text",size:"small",icon:e.jsx(Ms,{}),onClick:()=>nt(a),style:{color:"#1890ff"}})})}]}),e.jsx(xt,{message:"说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"排名"}),": 按优化目标得分排序，金牌为最佳结果"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"得分"}),": ",v.objective_function==="sharpe_ratio"?"夏普比率":v.objective_function==="total_return"?"总收益率":v.objective_function==="annual_return"?"年化收益率":"优化目标","得分"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"参数组合"}),": 该试验使用的策略参数"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]})}),e.jsx(Re,{title:"试验日志",open:ce,onCancel:()=>et(!1),footer:null,width:800,style:{top:20},children:e.jsx("div",{style:{maxHeight:"600px",overflow:"auto"},children:te&&te.length>0?e.jsx("div",{style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px"},children:te.map((t,a)=>{var u;const p=A=>{switch(A==null?void 0:A.toUpperCase()){case"ERROR":return"#ff4d4f";case"WARNING":return"#faad14";case"DEBUG":return"#722ed1";case"INFO":default:return"#1890ff"}};return e.jsxs("div",{style:{marginBottom:"4px",padding:"2px 4px",backgroundColor:"#f5f5f5",borderRadius:"2px"},children:[e.jsx("span",{style:{color:"#666",marginRight:"8px"},children:t.timestamp?$(t.timestamp).format("HH:mm:ss.SSS"):""}),e.jsxs("span",{style:{color:p(t.level),fontWeight:"bold",marginRight:"8px",minWidth:"60px",display:"inline-block"},children:["[",((u=t.level)==null?void 0:u.toUpperCase())||"INFO","]"]}),e.jsx("span",{style:{color:"#333"},children:t.message})]},a)})}):e.jsx("div",{style:{textAlign:"center",padding:"40px",color:"#999"},children:"暂无日志数据"})})})]})},$n=o.memo(kn);var In=Object.defineProperty,Cn=Object.defineProperties,Dn=Object.getOwnPropertyDescriptors,ha=Object.getOwnPropertySymbols,zn=Object.prototype.hasOwnProperty,Mn=Object.prototype.propertyIsEnumerable,ma=(n,r,l)=>r in n?In(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l,An=(n,r)=>{for(var l in r||(r={}))zn.call(r,l)&&ma(n,l,r[l]);if(ha)for(var l of ha(r))Mn.call(r,l)&&ma(n,l,r[l]);return n},Ln=(n,r)=>Cn(n,Dn(r)),It=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});const{RangePicker:Pn}=Gt,{Option:ot}=Ye,{Text:wt}=Tt,Fn={deepseek:"#3b7ddd",qwen:"#52c41a",kimi:"#faad14"},fa=["#3b7ddd","#52c41a","#fa8c16","#13c2c2","#eb2f96"],xa=["你是一个专注于股票量化交易的金融大模型，充当价格预测引擎。","","你的任务是根据输入的K线数据、账户状态和最近成交记录，预测下一根K线的收盘价。","","要求：","1）只能输出一个数字，不要任何文字、解释、符号或单位；","2）数字应为合理的价格水平，不为负数，尽量接近当前价格量级；","3）可以保留2到6位小数；","4）充分利用给出的周期、买入/卖出阈值、止损和止盈参数来判断趋势和风险；","5）只使用输入的数据进行推断，不要编造外部信息或新闻；","6）如果历史数据较少，也要给出尽可能稳健的预测，而不是报错。"].join(`
`),Nn=()=>{var n,r,l;const[b]=F.useForm(),[m,w]=o.useState([]),[z,M]=o.useState(!1),[g,I]=o.useState(!1),[R,X]=o.useState(null),[B,Ie]=o.useState([]),[Oe,pe]=o.useState(!1),[U,he]=o.useState({}),[v,W]=o.useState({}),[j,Ve]=o.useState([]),[Se,ie]=o.useState([]),[Te,Xe]=o.useState(!1),[ce,et]=o.useState("deepseek"),[te,Pe]=o.useState(""),[ge,rt]=o.useState(!1),[zt,ct]=o.useState(!1),[qe,We]=o.useState(!1),[ze,bt]=o.useState(null),[vt,pt]=o.useState([]),[ft,He]=o.useState(!1),[gt,tt]=o.useState(1),[Ke,k]=o.useState(50),[f,_]=o.useState(0),[V,re]=o.useState(),[G,Fe]=o.useState(),[st,Ee]=o.useState(""),[Ge,nt]=o.useState(),[Ne,t]=o.useState(null),[a,u]=o.useState(!1),[p,A]=o.useState(""),[L,N]=o.useState(null),Q=F.useWatch("data_source",b)||"database",ne=o.useMemo(()=>Q==="database"?[{value:"1d",label:"日线"}]:[{value:"1m",label:"1分钟"},{value:"5m",label:"5分钟"},{value:"15m",label:"15分钟"},{value:"30m",label:"30分钟"},{value:"60m",label:"60分钟"}],[Q]),S=o.useMemo(()=>{const h=new Set;return Object.keys(U||{}).forEach(C=>h.add(C)),Object.keys(v||{}).forEach(C=>h.add(C)),B.forEach(C=>h.add(C.model_type)),Array.from(h)},[U,v,B]),me=h=>{const C=S.indexOf(h);return Fn[h]||fa[(C>=0?C:0)%fa.length]},ke=()=>It(void 0,null,function*(){M(!0);try{const C=(yield q.get("/api/ai-investment/runs")).data||[];return w(C),C}catch(h){d.error((h==null?void 0:h.message)||"获取AI投资运行列表失败")}finally{M(!1)}}),le=h=>It(void 0,null,function*(){pe(!0);try{const O=(yield q.get(`/api/ai-investment/run/${h}/records`)).data||[];return Ie(O),O}catch(C){d.error((C==null?void 0:C.message)||"获取AI投资预测明细失败")}finally{pe(!1)}}),Ce=h=>It(void 0,null,function*(){yield le(h.id)}),Y=(h,...C)=>It(void 0,[h,...C],function*(O,De=gt,Me=Ke,se){var ae,ye,at;He(!0);try{const Ae={page:De,size:Me},yt=(ae=se==null?void 0:se.level)!=null?ae:V,Ft=(ye=se==null?void 0:se.category)!=null?ye:G,Mt=(at=se==null?void 0:se.keyword)!=null?at:st,s=(se==null?void 0:se.recordId)!==void 0?se.recordId:Ge;yt&&(Ae.level=yt),Ft&&(Ae.category=Ft),Mt&&(Ae.keyword=Mt),s!==void 0&&(Ae.record_id=s);const i=yield q.get(`/api/ai-investment/run/${O}/logs`,{params:Ae});pt(i.data.items||[]),_(i.data.total||0),tt(De),k(Me),(se==null?void 0:se.level)!==void 0&&re(se.level),(se==null?void 0:se.category)!==void 0&&Fe(se.category),(se==null?void 0:se.keyword)!==void 0&&Ee(se.keyword||""),(se==null?void 0:se.recordId)!==void 0&&nt(se.recordId)}catch(Ae){d.error((Ae==null?void 0:Ae.message)||"获取运行日志失败")}finally{He(!1)}}),ee=h=>It(void 0,null,function*(){rt(!0);try{const O=(yield q.get("/api/ai-investment/prompt-settings",{params:{model_type:h}})).data||[];O.length>0?Pe(O[0].system_prompt||""):Pe(xa)}catch(C){d.error((C==null?void 0:C.message)||"加载AI提示词失败"),Pe(xa)}finally{rt(!1)}});o.useEffect(()=>{ke(),ee(ce),(()=>It(void 0,null,function*(){Xe(!0);try{const C=yield bs();ie(C)}catch{}finally{Xe(!1)}}))()},[]),o.useEffect(()=>{b.getFieldValue("frequency")||(Q==="database"?b.setFieldsValue({frequency:"1d"}):b.setFieldsValue({frequency:"1m"}))},[Q,b]),o.useEffect(()=>{ee(ce)},[ce]);const Be=()=>It(void 0,null,function*(){var h,C,O,De,Me,se,ae;try{const ye=yield b.validateFields(),at=ye.symbol,Ae=ye.timeRange,yt=ye.models||[];if(!at||!Ae||yt.length===0){d.warning("请填写股票代码、时间范围并选择至少一个模型");return}const Ft=Ae[0].toDate().toISOString(),Mt=Ae[1].toDate().toISOString(),s=ye.data_source||"database",i=ye.frequency||(s==="database"?"1d":"1m"),y={name:ye.name||void 0,symbol:at,start_time:Ft,end_time:Mt,data_source:s,frequency:i,models:yt,initial_capital:ye.initial_capital||1e5,buy_threshold:(h=ye.buy_threshold)!=null?h:.002,sell_threshold:(C=ye.sell_threshold)!=null?C:-.002,stop_loss_pct:(O=ye.stop_loss_pct)!=null?O:.05,take_profit_pct:(De=ye.take_profit_pct)!=null?De:.1,window:ye.window||20,commission_rate:(Me=ye.commission_rate)!=null?Me:.0015,slippage_rate:(se=ye.slippage_rate)!=null?se:.001};I(!0);const D=yield q.post("/api/ai-investment/run",y);if(D.data&&D.data.status==="success"){d.success("AI实时投资回放完成");const Z=D.data;he(Z.metrics||{}),W(Z.equity_curves||{}),Ve(Z.price_series||[]);const de=yield ke();if(Z.run_id&&(yield le(Z.run_id),de&&Array.isArray(de))){const c=de.find(T=>T.id===Z.run_id)||null;X(c)}}else d.error(((ae=D.data)==null?void 0:ae.message)||"AI投资回放失败")}catch(ye){if(ye!=null&&ye.errorFields)return;d.error((ye==null?void 0:ye.message)||"AI投资回放执行失败")}finally{I(!1)}}),Ze=()=>It(void 0,null,function*(){var h,C,O,De,Me,se;try{const ae=yield b.validateFields(["symbol","timeRange","data_source","frequency","models","initial_capital","buy_threshold","sell_threshold","stop_loss_pct","take_profit_pct","window"]),ye=ae.symbol,at=ae.timeRange,Ae=ae.models||[];if(!ye||!at||Ae.length===0){d.warning("请先填写股票代码、时间范围并选择至少一个模型");return}const yt=at[0].toDate().toISOString(),Ft=at[1].toDate().toISOString(),Mt=ae.data_source||"database",s=ae.frequency||(Mt==="database"?"1d":"1m"),i={name:ae.name||void 0,symbol:ye,start_time:yt,end_time:Ft,data_source:Mt,frequency:s,models:Ae,initial_capital:ae.initial_capital||1e5,buy_threshold:(h=ae.buy_threshold)!=null?h:.002,sell_threshold:(C=ae.sell_threshold)!=null?C:-.002,stop_loss_pct:(O=ae.stop_loss_pct)!=null?O:.05,take_profit_pct:(De=ae.take_profit_pct)!=null?De:.1,window:ae.window||20,commission_rate:(Me=ae.commission_rate)!=null?Me:.0015,slippage_rate:(se=ae.slippage_rate)!=null?se:.001};u(!0);const D=(yield q.post("/api/ai-investment/estimate-calls",i)).data,Z=`${D.formula} = ${D.per_model_calls}`,de=`当前选择 ${D.model_count} 个模型，理论最大AI调用次数约为 ${D.total_calls} 次。`;A(`调用次数估算公式：${Z}。${de}`)}catch(ae){if(ae!=null&&ae.errorFields)return;d.error((ae==null?void 0:ae.message)||"预估AI调用次数失败")}finally{u(!1)}}),dt=()=>It(void 0,null,function*(){if(!ce){d.warning("请选择需要配置提示词的模型");return}if(!te||!te.trim()){d.warning("请输入系统提示词内容");return}ct(!0);try{yield q.post("/api/ai-investment/prompt-settings",{model_type:ce,scene:"ai_investment",system_prompt:te}),d.success("提示词已保存")}catch(h){d.error((h==null?void 0:h.message)||"保存提示词失败")}finally{ct(!1)}}),fe=h=>{X(h),Ce(h)},lt=h=>It(void 0,null,function*(){let C=null;try{C=(yield q.post(`/api/ai-investment/run/${h.id}/estimate-calls-resume`,{})).data}catch{}Re.confirm({title:"确认继续运行？",content:e.jsxs("div",{children:[C?C.total_calls>0?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["按当前配置，理论最大 AI 调用次数约为"," ",e.jsx(wt,{strong:!0,children:C.total_calls})," 次。"]}),e.jsxs("p",{children:["每个模型约 ",e.jsx(wt,{strong:!0,children:C.per_model_calls})," 次，当前选择"," ",e.jsx(wt,{strong:!0,children:C.model_count})," 个模型。"]})]}):e.jsx("p",{children:"根据当前数据，续跑已无剩余预测步数。"}):e.jsx("p",{children:"暂时无法预估本次继续运行的 AI 调用次数。"}),e.jsx("p",{children:"确定要继续运行该任务吗？"})]}),onOk:()=>It(void 0,null,function*(){N(h.id);try{const De=(yield q.post(`/api/ai-investment/run/${h.id}/resume`,{name:`${h.name}-续跑`})).data;if(De&&De.status==="success"){d.success("续跑任务已完成");const se=(yield q.get(`/api/ai-investment/run/${h.id}`)).data;X(Ln(An({},h),{name:se.name||h.name})),he(se.metrics||{}),W(se.equity_curves||{}),Ve(se.price_series||[]),yield Ce(h);const ae=yield ke();ae&&Array.isArray(ae)&&w(ae)}else d.error((De==null?void 0:De.message)||"续跑任务执行失败")}catch(O){d.error((O==null?void 0:O.message)||"续跑任务请求失败")}finally{N(null)}})})}),ls=h=>It(void 0,null,function*(){try{const O=(yield q.get(`/api/ai-investment/run/${h.id}`)).data;if(O&&O.status==="success"){X(h),he(O.metrics||{}),W(O.equity_curves||{}),Ve(O.price_series||[]);const De=O.config||{},Me=De.start_time,se=yield le(h.id);let ae=De.end_time;if(se&&se.length>0){const Ae=se[se.length-1].timestamp;(!ae||$(ae).isBefore(Ae))&&(ae=Ae)}if(!ae){const Ae=O.price_series||[];Ae.length>0&&(ae=Ae[Ae.length-1].date)}!ae&&h.completed_at&&(ae=h.completed_at);const ye=Me&&ae?[$(Me),$(ae)]:void 0,at={name:O.name||h.name,symbol:O.symbol||h.symbol,data_source:O.data_source,frequency:O.frequency,models:Array.isArray(O.models)&&O.models.length>0?O.models:h.models,initial_capital:O.initial_capital,buy_threshold:De.buy_threshold,sell_threshold:De.sell_threshold,stop_loss_pct:De.stop_loss_pct,take_profit_pct:De.take_profit_pct,window:De.window,commission_rate:De.commission_rate,slippage_rate:De.slippage_rate};ye&&(at.timeRange=ye),Object.keys(at).forEach(Ae=>{const yt=at[Ae];yt==null&&delete at[Ae]}),Object.keys(at).length>0&&b.setFieldsValue(at),d.success("已载入历史运行结果")}else d.error((O==null?void 0:O.message)||"载入历史运行结果失败")}catch(C){d.error((C==null?void 0:C.message)||"载入历史运行结果失败")}}),Kt=h=>{bt(h),t(null),nt(void 0),re(void 0),Fe(void 0),Ee(""),We(!0),Y(h.id,1,Ke,{level:void 0,category:void 0,keyword:"",recordId:void 0})},Ue=h=>{const C=m.find(O=>O.id===h.run_id)||R;if(!C){d.warning("请先在左侧选择对应的运行记录");return}bt(C),t(h),re(void 0),Fe("ai_call"),Ee(""),nt(h.id),We(!0),Y(h.run_id,1,Ke,{category:"ai_call",recordId:h.id})},Pt=o.useMemo(()=>{if(Ne)return vt.find(h=>h.category==="ai_call")},[vt,Ne]),os=[{title:"名称",dataIndex:"name",key:"name",width:200,ellipsis:!0},{title:"股票代码",dataIndex:"symbol",key:"symbol",width:100},{title:"模型",dataIndex:"models",key:"models",width:140,render:h=>e.jsx($e,{size:"small",children:(h||[]).map(C=>e.jsx(Le,{children:C},C))})},{title:"状态",dataIndex:"status",key:"status",width:100,render:h=>e.jsx(Le,{color:h==="completed"?"green":"blue",children:h})},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:180,render:h=>h?$(h).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:180,render:h=>h?$(h).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"操作",key:"action",width:220,render:(h,C)=>e.jsxs($e,{size:"small",children:[e.jsx(P,{size:"small",icon:e.jsx(Ks,{}),onClick:O=>{O.stopPropagation(),Kt(C)},children:"查看日志"}),e.jsx(P,{size:"small",icon:e.jsx(mr,{}),loading:L===C.id,onClick:O=>{O.stopPropagation(),lt(C)},children:"继续运行"}),e.jsx(P,{size:"small",icon:e.jsx(Wt,{}),onClick:O=>{O.stopPropagation(),ls(C)},children:"载入结果"})]})}],vs=[{title:"时间",dataIndex:"timestamp",key:"timestamp",render:h=>h?$(h).format("YYYY-MM-DD HH:mm"):"-"},{title:"模型",dataIndex:"model_type",key:"model_type"},{title:"预测价格",dataIndex:"predicted_price",key:"predicted_price",render:h=>h.toFixed(4)},{title:"实际价格",dataIndex:"actual_price",key:"actual_price",render:h=>h.toFixed(4)},{title:"操作",dataIndex:"action",key:"action",render:h=>{let C="default",O=h;return h==="BUY"?(C="red",O="买入"):h==="SELL"?(C="green",O="卖出"):h==="HOLD"&&(C="default",O="观望"),e.jsx(Le,{color:C,children:O})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:160,ellipsis:!0,render:h=>h||"—"},{title:"持仓",dataIndex:"position",key:"position",render:h=>h.toFixed(2)},{title:"单笔收益",dataIndex:"pnl",key:"pnl",render:h=>h.toFixed(2)},{title:"累计收益",dataIndex:"cumulative_pnl",key:"cumulative_pnl",render:h=>h.toFixed(2)},{title:"账户权益",dataIndex:"equity",key:"equity",render:h=>h.toFixed(2)},{title:"操作",key:"action",render:(h,C)=>e.jsx(P,{size:"small",icon:e.jsx(Ks,{}),onClick:()=>Ue(C),children:"查看日志"})}],_s=o.useMemo(()=>{const h=[],C=[];return Object.keys(v||{}).forEach(O=>{const Me=(v[O]||[]).map(se=>$(se.date).format("YYYY-MM-DD HH:mm"));Me.length>C.length&&C.splice(0,C.length,...Me)}),Object.keys(v||{}).forEach(O=>{const Me=(v[O]||[]).map(ae=>ae.equity),se=me(O);h.push({type:"line",name:O,data:Me,smooth:!0,lineStyle:{color:se},itemStyle:{color:se}})}),{tooltip:{trigger:"axis"},legend:{top:0},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:C},yAxis:{type:"value",scale:!0,name:"账户权益"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:h}},[v]),ws=o.useMemo(()=>{const h="YYYY-MM-DD HH:mm",C=[];if(j.length>0)j.forEach(i=>{C.push($(i.date).format(h))});else if(B.length>0){const i=new Set;B.forEach(y=>{i.add($(y.timestamp).format(h))}),Array.from(i).sort().forEach(y=>C.push(y))}if(C.length===0)return{tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{top:0,data:[]},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:[]},yAxis:{type:"value",scale:!0,name:"价格"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:[]};const O=new Map;j.forEach(i=>{const y=$(i.date).format(h);O.set(y,i.close)}),O.size===0&&B.length>0&&B.forEach(i=>{const y=$(i.timestamp).format(h);O.has(y)||O.set(y,i.actual_price)});const De=C.map(i=>{var y;return(y=O.get(i))!=null?y:null}),Me=[];S.forEach(i=>{const y=B.filter(c=>c.model_type===i);if(y.length===0)return;const D=new Map;y.forEach(c=>{const T=$(c.timestamp).format(h);D.set(T,c.predicted_price)});const Z=C.map(c=>{var T;return(T=D.get(c))!=null?T:null}),de=me(i);Me.push({type:"line",name:`${i}预测`,data:Z,smooth:!0,lineStyle:{color:de},itemStyle:{color:de}})});const se=new Map;C.forEach((i,y)=>{se.set(i,y)});const ae=[],ye=[];B.forEach(i=>{var y,D;const Z=$(i.timestamp).format(h),de=se.get(Z);if(de===void 0)return;const c=(D=(y=i.actual_price)!=null?y:O.get(Z))!=null?D:null;c!=null&&(i.action==="BUY"?ae.push({index:de,price:c}):i.action==="SELL"&&ye.push({index:de,price:c}))});const at=ae.map(i=>({name:"买入点",coord:[C[i.index],i.price],value:i.price,itemStyle:{color:"#f64034"},symbol:"circle",symbolSize:8,label:{show:!1}})),Ae=ye.map(i=>({name:"卖出点",coord:[C[i.index],i.price],value:i.price,itemStyle:{color:"#00b46a"},symbol:"circle",symbolSize:8,label:{show:!1}})),yt=ae.map(i=>({name:"买入",coord:[C[i.index],i.price*1.02],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:22,label:{show:!0,formatter:"B",color:"#ffffff",position:"inside",fontSize:12,fontWeight:"bold"}})),Ft=ye.map(i=>({name:"卖出",coord:[C[i.index],i.price*.98],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:22,label:{show:!0,formatter:"S",color:"#ffffff",position:"inside",fontSize:12,fontWeight:"bold"}})),Mt=[...at,...Ae,...yt,...Ft],s=[{type:"line",name:"实际收盘价",data:De,smooth:!0,lineStyle:{color:"#666666"},itemStyle:{color:"#666666"},markPoint:{data:Mt}},...Me];return{tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{top:0,data:s.map(i=>i.name)},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:C},yAxis:{type:"value",scale:!0,name:"价格"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:s}},[j,B,S]),Qt=o.useMemo(()=>U?Object.keys(U).map(h=>{var C,O,De;const Me=U[h];return{model:h,total_return:(C=Me==null?void 0:Me.total_return)!=null?C:0,max_drawdown:(O=Me==null?void 0:Me.max_drawdown)!=null?O:0,sharpe_ratio:(De=Me==null?void 0:Me.sharpe_ratio)!=null?De:0}}):[],[U]),Ss=[{title:"模型",dataIndex:"model",key:"model"},{title:"总收益率",dataIndex:"total_return",key:"total_return",render:h=>`${(h*100).toFixed(2)} %`},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:h=>`${(h*100).toFixed(2)} %`},{title:"夏普比率",dataIndex:"sharpe_ratio",key:"sharpe_ratio",render:h=>h.toFixed(2)}];return e.jsxs("div",{children:[e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:16,children:e.jsx(oe,{title:e.jsxs($e,{children:[e.jsx(Wt,{}),"AI实时投资跑数配置"]}),children:e.jsxs(F,{form:b,layout:"vertical",initialValues:{data_source:"database",frequency:"1d",initial_capital:1e5,buy_threshold:.002,sell_threshold:-.002,stop_loss_pct:.05,take_profit_pct:.1,window:20,commission_rate:.0015,slippage_rate:.001},children:[e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"name",label:"运行名称",children:e.jsx(we,{placeholder:"可选，例如：AAPL-日内回放"})})}),e.jsx(x,{span:12,children:Q==="database"?e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请选择股票代码"}],children:e.jsx(Ye,{showSearch:!0,placeholder:"从市场数据管理中选择股票",loading:Te,optionFilterProp:"children",filterOption:(h,C)=>{var O;return String((O=C==null?void 0:C.children)!=null?O:"").toLowerCase().includes(h.toLowerCase())},children:Se.map(h=>e.jsxs(ot,{value:h.symbol,children:[h.symbol,"（",h.name,"）"]},h.id))})}):e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(we,{placeholder:"例如：HK.00700"})})})]}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"timeRange",label:"时间范围",rules:[{required:!0,message:"请选择时间范围"}],children:e.jsx(Pn,{showTime:!0,style:{width:"100%"},presets:[{label:"最近3天",value:[$().subtract(3,"day"),$()]},{label:"最近一周",value:[$().subtract(7,"day"),$()]},{label:"最近两周",value:[$().subtract(14,"day"),$()]},{label:"最近3周",value:[$().subtract(21,"day"),$()]},{label:"最近一月",value:[$().subtract(1,"month"),$()]},{label:"最近3月",value:[$().subtract(3,"month"),$()]},{label:"最近半年",value:[$().subtract(6,"month"),$()]},{label:"最近一年",value:[$().subtract(1,"year"),$()]},{label:"最近两年",value:[$().subtract(2,"year"),$()]},{label:"最近3年",value:[$().subtract(3,"year"),$()]},{label:"最近5年",value:[$().subtract(5,"year"),$()]}],disabledDate:h=>h&&h>$().endOf("day")})})}),e.jsx(x,{span:12,children:e.jsx(F.Item,{name:"models",label:"AI模型",rules:[{required:!0,message:"请选择至少一个模型"}],children:e.jsxs(Ye,{mode:"multiple",placeholder:"支持多选，用于模型对比或加权",children:[e.jsx(ot,{value:"qwen",children:"千问"}),e.jsx(ot,{value:"kimi",children:"Kimi"}),e.jsx(ot,{value:"deepseek",children:"DeepSeek"})]})})})]}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:8,children:e.jsx(F.Item,{name:"data_source",label:"数据源",children:e.jsxs(Ye,{children:[e.jsx(ot,{value:"database",children:"市场数据管理(日线)"}),e.jsx(ot,{value:"futu",children:"富途 OpenAPI 实时"})]})})}),e.jsx(x,{span:8,children:e.jsx(F.Item,{name:"frequency",label:"数据频率",children:e.jsx(Ye,{children:ne.map(h=>e.jsx(ot,{value:h.value,children:h.label},h.value))})})}),e.jsx(x,{span:8,children:e.jsx(F.Item,{name:"initial_capital",label:"初始资金",children:e.jsx(we,{type:"number",min:0})})})]}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(F.Item,{name:"buy_threshold",label:"买入阈值(预测涨幅)",children:e.jsx(we,{type:"number",step:"0.001"})})}),e.jsx(x,{span:6,children:e.jsx(F.Item,{name:"sell_threshold",label:"卖出阈值(预测跌幅)",children:e.jsx(we,{type:"number",step:"0.001"})})}),e.jsx(x,{span:6,children:e.jsx(F.Item,{name:"stop_loss_pct",label:"止损比例",children:e.jsx(we,{type:"number",step:"0.01"})})}),e.jsx(x,{span:6,children:e.jsx(F.Item,{name:"take_profit_pct",label:"止盈比例",children:e.jsx(we,{type:"number",step:"0.01"})})})]}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(F.Item,{name:"commission_rate",label:"手续费率",children:e.jsx(we,{type:"number",step:"0.0001"})})}),e.jsx(x,{span:6,children:e.jsx(F.Item,{name:"slippage_rate",label:"滑点比例",children:e.jsx(we,{type:"number",step:"0.0001"})})})]}),e.jsx(J,{gutter:16,children:e.jsx(x,{span:6,children:e.jsx(F.Item,{name:"window",label:"模型窗口长度",children:e.jsx(we,{type:"number",min:2})})})}),e.jsxs(J,{justify:"space-between",align:"middle",children:[e.jsx(x,{children:e.jsxs($e,{direction:"vertical",size:4,children:[e.jsx(P,{size:"small",loading:a,onClick:Ze,children:"预估AI调用次数"}),p&&e.jsx(wt,{type:"danger",style:{maxWidth:480},children:p})]})}),e.jsx(x,{children:e.jsx(P,{type:"primary",icon:e.jsx(Wt,{}),loading:g,onClick:Be,children:"启动AI跑数"})})]})]})})}),e.jsx(x,{span:8,children:e.jsx(oe,{title:e.jsxs($e,{children:[e.jsx(Lt,{}),"历史运行"]}),children:e.jsx(ss,{rowKey:"id",loading:z,dataSource:m,columns:os,size:"small",scroll:{x:!0},pagination:{pageSize:5},onRow:h=>({onClick:()=>fe(h)})})})})]}),e.jsxs(J,{gutter:16,style:{marginTop:16},children:[e.jsx(x,{span:12,children:e.jsx(oe,{title:"价格与模型预测（含买卖点）",children:e.jsx(qt,{option:ws,style:{height:540}})})}),e.jsx(x,{span:12,children:e.jsx(oe,{title:"账户权益曲线",children:e.jsx(qt,{option:_s,style:{height:540}})})})]}),e.jsx(J,{gutter:16,style:{marginTop:16},children:e.jsx(x,{span:24,children:e.jsx(oe,{title:"预测明细",children:e.jsx(ss,{rowKey:(h,C)=>`${h.model_type}-${h.timestamp}-${C}`,loading:Oe,dataSource:B,columns:vs,size:"small",pagination:{pageSize:10},scroll:{x:1200}})})})}),e.jsx(J,{gutter:16,style:{marginTop:16},children:e.jsx(x,{span:24,children:e.jsx(oe,{title:"模型绩效对比",children:e.jsx(ss,{rowKey:"model",dataSource:Qt,columns:Ss,size:"small",pagination:!1})})})}),e.jsx(J,{gutter:16,style:{marginTop:16},children:e.jsx(x,{span:24,children:e.jsxs(oe,{title:"AI提示词设置",children:[e.jsx(J,{gutter:16,children:e.jsx(x,{span:8,children:e.jsxs($e,{children:[e.jsx("span",{children:"选择模型"}),e.jsxs(Ye,{style:{minWidth:160},value:ce,onChange:h=>et(h),children:[e.jsx(ot,{value:"deepseek",children:"DeepSeek"}),e.jsx(ot,{value:"qwen",children:"千问"}),e.jsx(ot,{value:"kimi",children:"Kimi"})]})]})})}),e.jsx(J,{style:{marginTop:16},children:e.jsx(x,{span:24,children:e.jsx(we.TextArea,{value:te,onChange:h=>Pe(h.target.value),autoSize:{minRows:4,maxRows:20},style:{whiteSpace:"pre-wrap"},placeholder:"请输入系统提示词，将作为大模型的系统角色描述"})})}),e.jsx(J,{justify:"end",style:{marginTop:16},children:e.jsx(x,{children:e.jsxs($e,{children:[e.jsx(P,{onClick:()=>ee(ce),loading:ge,children:"重新加载"}),e.jsx(P,{type:"primary",loading:zt,onClick:dt,children:"保存提示词"})]})})})]})})}),e.jsxs(Re,{open:qe,title:ze?`运行日志 - ${ze.name} (#${ze.id}) · 共${f}条`:`运行日志 · 共${f}条`,onCancel:()=>We(!1),footer:null,width:960,children:[Ne&&e.jsxs(oe,{size:"small",style:{marginBottom:16},children:[e.jsxs(J,{gutter:16,style:{marginBottom:8},children:[e.jsxs(x,{span:8,children:[e.jsx(wt,{strong:!0,children:"时间"}),e.jsx("div",{children:$(Ne.timestamp).format("YYYY-MM-DD HH:mm")})]}),e.jsxs(x,{span:8,children:[e.jsx(wt,{strong:!0,children:"模型"}),e.jsx("div",{children:Ne.model_type})]}),e.jsxs(x,{span:8,children:[e.jsx(wt,{strong:!0,children:"操作"}),e.jsx("div",{children:Ne.action})]})]}),e.jsxs(J,{gutter:16,style:{marginBottom:12},children:[e.jsxs(x,{span:8,children:[e.jsx(wt,{strong:!0,children:"预测价格"}),e.jsx("div",{children:Ne.predicted_price.toFixed(4)})]}),e.jsxs(x,{span:8,children:[e.jsx(wt,{strong:!0,children:"实际价格"}),e.jsx("div",{children:Ne.actual_price.toFixed(4)})]}),e.jsxs(x,{span:8,children:[e.jsx(wt,{strong:!0,children:"账户权益"}),e.jsx("div",{children:Ne.equity.toFixed(2)})]})]}),Pt&&e.jsxs(e.Fragment,{children:[e.jsx(J,{gutter:16,style:{marginBottom:8},children:e.jsx(x,{span:24,children:e.jsx(wt,{strong:!0,children:"模型输入"})})}),e.jsx(J,{gutter:16,style:{marginBottom:12},children:e.jsxs(x,{span:24,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"System Prompt"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((n=Pt.ai_input)==null?void 0:n.system_prompt)||"无"})]})}),e.jsx(J,{gutter:16,style:{marginBottom:12},children:e.jsxs(x,{span:24,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"Prompt"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((r=Pt.ai_input)==null?void 0:r.prompt)||"无"})]})}),e.jsx(J,{gutter:16,style:{marginBottom:8},children:e.jsx(x,{span:24,children:e.jsx(wt,{strong:!0,children:"模型输出"})})}),e.jsxs(J,{gutter:16,children:[e.jsxs(x,{span:8,children:[e.jsx(wt,{strong:!0,children:"解析后的数值"}),e.jsx("div",{children:Pt.ai_output&&Pt.ai_output.value!==void 0?Pt.ai_output.value:"无"})]}),e.jsxs(x,{span:16,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"原始内容"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((l=Pt.ai_output)==null?void 0:l.content)||"无"})]})]})]})]}),e.jsxs($e,{style:{marginBottom:8},children:[e.jsxs(Ye,{allowClear:!0,placeholder:"级别",style:{width:120},value:V,onChange:h=>{ze&&Y(ze.id,1,Ke,{level:h||void 0})},children:[e.jsx(ot,{value:"DEBUG",children:"DEBUG"}),e.jsx(ot,{value:"INFO",children:"INFO"}),e.jsx(ot,{value:"WARN",children:"WARN"}),e.jsx(ot,{value:"ERROR",children:"ERROR"})]}),e.jsxs(Ye,{allowClear:!0,placeholder:"类别",style:{width:140},value:G,onChange:h=>{ze&&Y(ze.id,1,Ke,{category:h||void 0})},children:[e.jsx(ot,{value:"run",children:"运行"}),e.jsx(ot,{value:"ai_call",children:"AI调用"}),e.jsx(ot,{value:"trade",children:"买卖点"}),e.jsx(ot,{value:"system",children:"系统"})]}),e.jsx(we.Search,{allowClear:!0,placeholder:"按关键字搜索",style:{width:260},value:st,onChange:h=>Ee(h.target.value),onSearch:h=>{ze&&Y(ze.id,1,Ke,{keyword:h})}}),e.jsxs("span",{children:["共 ",f," 条"]})]}),e.jsx(ss,{rowKey:"id",loading:ft,dataSource:vt,size:"small",pagination:{current:gt,pageSize:Ke,total:f,showSizeChanger:!0,onChange:(h,C)=>{ze&&Y(ze.id,h,C)}},columns:[{title:"序号",key:"index",width:70,render:(h,C,O)=>(gt-1)*Ke+O+1},{title:"时间",dataIndex:"timestamp",key:"timestamp",width:180,render:h=>h?$(h).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"级别",dataIndex:"level",key:"level",width:80},{title:"类别",dataIndex:"category",key:"category",width:100},{title:"消息",dataIndex:"message",key:"message",ellipsis:!0},{title:"AI输入",key:"ai_input",width:160,render:(h,C)=>C.ai_input?JSON.stringify(C.ai_input):""},{title:"AI输出",key:"ai_output",width:160,render:(h,C)=>C.ai_output?JSON.stringify(C.ai_output):""}],scroll:{x:900,y:400}})]})]})};var ga=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});const{Title:On,Text:Is}=Tt,Tn=()=>{const n=Jt(),[r,l]=o.useState([]),[b,m]=o.useState(!1),w=o.useRef(!1),z=()=>ga(void 0,null,function*(){m(!0);try{const B=yield cs();console.log("获取到的策略数据:",B),l(B)}catch{d.error("获取策略列表失败")}finally{m(!1)}});o.useEffect(()=>{w.current||(w.current=!0,z())},[]);const M=()=>{n("/strategy/edit")},g=B=>{B&&n(`/strategy/edit/${B}`)},I=B=>ga(void 0,null,function*(){if(B)try{yield Oa(B),d.success("策略删除成功"),z()}catch{d.error("删除策略失败")}}),R=B=>{B&&n(`/backtest?strategy=${B}`)},X=()=>b?e.jsx(ns,{tip:"加载中..."}):r.length===0?e.jsx(Us,{description:"暂无策略",image:Us.PRESENTED_IMAGE_SIMPLE}):e.jsx(Dt,{className:"strategy-list",itemLayout:"horizontal",dataSource:r,renderItem:B=>e.jsxs(Dt.Item,{className:"strategy-list-item",style:{padding:"16px",borderRadius:"8px",backgroundColor:"#f9f9f9",marginBottom:"12px",display:"flex",justifyContent:"space-between"},children:[e.jsxs("div",{style:{flex:1,overflow:"hidden"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"8px"},children:e.jsx(Is,{strong:!0,style:{fontSize:"16px",marginRight:"8px"},children:B.name})}),e.jsx(Is,{type:"secondary",style:{display:"block",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:B.description||"无描述"}),B.updated_at&&e.jsxs(Is,{type:"secondary",style:{fontSize:"12px"},children:["最后更新: ",new Date(B.updated_at).toLocaleString()]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center"},children:e.jsxs($e,{children:[e.jsx(P,{type:"primary",icon:e.jsx(fr,{}),onClick:()=>R(B.id),children:"回测"}),e.jsx(P,{icon:e.jsx(xr,{}),onClick:()=>g(B.id),children:"编辑"}),e.jsx(P,{danger:!0,icon:e.jsx(us,{}),onClick:()=>I(B.id),children:"删除"})]})})]},B.id)});return e.jsx("div",{style:{padding:"20px"},children:e.jsxs(oe,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx(On,{level:4,style:{margin:0},children:"策略构建器"}),e.jsx(P,{type:"primary",icon:e.jsx(Ma,{}),onClick:M,children:"创建新策略"})]}),e.jsx(gs,{}),X()]})})};var Cs=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});const{Title:Rn,Text:Ds}=Tt,{TextArea:Yn}=we,ya=()=>{const{id:n}=_a(),r=Jt(),[l]=F.useForm(),[b,m]=o.useState(""),[w,z]=o.useState(!1),[M,g]=o.useState(!1),[I,R]=o.useState(!0),[X,B]=o.useState(""),Ie=`from .strategy_template import StrategyTemplate
import pandas as pd
import numpy as np
import logging

logger = logging.getLogger(__name__)

class MyStrategy(StrategyTemplate):
    """
    我的自定义策略
    """
    
    def __init__(self, parameters=None):
        """初始化策略"""
        default_params = {
            # 在这里定义策略参数和默认值
        }
        
        # 合并用户参数与默认参数
        if parameters:
            default_params.update(parameters)
            
        super().__init__("我的策略", default_params)
        
    def generate_signals(self) -> pd.DataFrame:
        """
        生成交易信号
        
        Returns:
            包含信号的DataFrame，包括:
            - signal: 交易信号 (1: 买入, -1: 卖出, 0: 不操作)
            - trigger_reason: 信号触发原因
        """
        if self.data is None or self.data.empty:
            logger.warning("未设置数据或数据为空，无法生成信号")
            return pd.DataFrame()
        
        # 获取数据
        df = self.data.copy()
        
        # 添加交易信号
        df['signal'] = 0
        df['trigger_reason'] = ''
        
        # TODO: 实现您的交易逻辑
        
        # 使用log函数记录策略执行过程（可选）
        self.log("开始生成交易信号", "INFO")
        self.log(f"数据行数: {len(df)}", "DEBUG")
        
        # 示例: 当价格上涨超过2%时买入
        price_change = df['close'].pct_change() * 100
        buy_signal = price_change > 2
        df.loc[buy_signal, 'signal'] = 1
        df.loc[buy_signal, 'trigger_reason'] = "价格上涨超过2%"
        
        # 记录买入信号数量
        buy_count = buy_signal.sum()
        if buy_count > 0:
            self.log(f"生成买入信号 {buy_count} 个", "INFO")
        
        # 示例: 当价格下跌超过2%时卖出
        sell_signal = price_change < -2
        df.loc[sell_signal, 'signal'] = -1
        df.loc[sell_signal, 'trigger_reason'] = "价格下跌超过2%"
        
        # 记录卖出信号数量
        sell_count = sell_signal.sum()
        if sell_count > 0:
            self.log(f"生成卖出信号 {sell_count} 个", "INFO")
        
        self.log("交易信号生成完成", "INFO")
        
        return df
`;o.useEffect(()=>{n?(R(!1),Oe(parseInt(n))):m(Ie)},[n]);const Oe=v=>Cs(void 0,null,function*(){z(!0);try{const W=yield tn(v);W&&(l.setFieldsValue({name:W.name,description:W.description,parameters:W.parameters||{}}),m(W.code||Ie),B(W.template||""))}catch{d.error("获取策略详情失败")}finally{z(!1)}}),pe=()=>Cs(void 0,null,function*(){try{const v=yield l.validateFields();z(!0);const W=v.parameters&&typeof v.parameters=="object"?v.parameters:{},j={name:v.name,description:v.description,code:b,parameters:W,template:X};let Ve;I?Ve=yield sn(j):n&&(Ve=yield an(parseInt(n),j)),Ve&&(d.success(`策略${I?"创建":"更新"}成功`),I&&Ve.id&&(r(`/strategy/edit/${Ve.id}`),R(!1)))}catch(v){v.message?d.error(v.message):d.error(`策略${I?"创建":"更新"}失败`)}finally{z(!1)}}),U=()=>Cs(void 0,null,function*(){g(!0);try{const v=l.getFieldsValue(),W=v.parameters&&typeof v.parameters=="object"?v.parameters:{},j=yield rn(b,[],W);j&&!j.error?Re.success({title:"策略代码验证通过",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码语法正确，可以正常运行。"}),j.signals&&e.jsxs("p",{children:["测试生成了 ",j.signals.length," 条数据记录。"]})]})}):Re.error({title:"策略代码验证失败",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码存在问题，详细错误信息："}),e.jsx("pre",{style:{maxHeight:"300px",overflow:"auto"},children:j.error||"未知错误"})]})})}catch{d.error("测试策略代码失败")}finally{g(!1)}}),he=()=>{r("/strategy")};return e.jsx("div",{style:{padding:"20px"},children:e.jsx(ns,{spinning:w,tip:"加载中...",children:e.jsx(oe,{children:e.jsxs(J,{gutter:[16,16],children:[e.jsx(x,{span:24,children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsxs($e,{children:[e.jsx(P,{icon:e.jsx(Aa,{}),onClick:he,children:"返回"}),e.jsx(Rn,{level:4,style:{margin:0},children:I?"创建新策略":"编辑策略"})]}),e.jsxs($e,{children:[e.jsx(P,{type:"primary",icon:e.jsx(Da,{}),onClick:pe,loading:w,children:"保存"}),e.jsx(P,{icon:e.jsx(Wt,{}),onClick:U,loading:M,children:"测试"})]})]})}),e.jsx(x,{span:24,children:e.jsxs(F,{form:l,layout:"vertical",children:[e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:12,children:e.jsx(F.Item,{label:"策略名称",name:"name",rules:[{required:!0,message:"请输入策略名称"}],children:e.jsx(we,{placeholder:"请输入策略名称"})})}),e.jsx(x,{span:12,children:e.jsx(F.Item,{label:"策略描述",name:"description",children:e.jsx(Yn,{rows:1,placeholder:"请输入策略描述"})})})]}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:8,children:e.jsx(F.Item,{label:"分批建仓批次数 (batch_count)",name:["parameters","batch_count"],initialValue:1,children:e.jsx(we,{type:"number",min:1})})}),e.jsx(x,{span:8,children:e.jsx(F.Item,{label:"批次间隔条数 (batch_interval_bars)",name:["parameters","batch_interval_bars"],initialValue:1,children:e.jsx(we,{type:"number",min:1})})}),e.jsx(x,{span:8,children:e.jsx(F.Item,{label:"批次权重 (batch_weights)",name:["parameters","batch_weights"],tooltip:"可输入逗号分隔的数字，例如: 0.5,0.3,0.2（若为空则均分）",children:e.jsx(we,{placeholder:"例如: 0.5,0.3,0.2 或 留空"})})})]})]})}),e.jsxs(x,{span:24,children:[e.jsx(gs,{orientation:"left",children:e.jsxs($e,{children:[e.jsx(As,{}),e.jsx(Ds,{strong:!0,children:"策略代码"})]})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(xt,{message:"💡 策略日志功能",description:e.jsxs("div",{children:[e.jsxs("p",{children:["您可以在策略中使用 ",e.jsx("code",{children:"self.log(message, level)"})," 函数记录执行过程："]}),e.jsxs("ul",{style:{marginBottom:0},children:[e.jsxs("li",{children:[e.jsx("code",{children:'self.log("信息内容", "INFO")'})," - 记录一般信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("调试信息", "DEBUG")'})," - 记录调试信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("警告信息", "WARNING")'})," - 记录警告信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("错误信息", "ERROR")'})," - 记录错误信息"]})]}),e.jsx("p",{style:{marginTop:"8px",marginBottom:0},children:e.jsx(Ds,{type:"secondary",children:'日志将在回测历史的"控制台"按钮中查看，帮助您调试和监控策略执行过程。'})})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}})}),e.jsx("div",{style:{border:"1px solid #d9d9d9",borderRadius:"2px"},children:e.jsx(jr,{width:"100%",height:"600",language:"python",theme:"vs-dark",value:b,onChange:m,options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,folding:!0,lineNumbers:"on",rulers:[80,120],minimap:{enabled:!0}}})}),e.jsx("div",{style:{marginTop:"8px"},children:e.jsx(Ds,{type:"secondary",children:"注意：策略代码必须继承自StrategyTemplate基类，并实现generate_signals方法。"})})]})]})})})})};var Ut=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});Ls([Ps,Fs,Ns,Os,Ts,Rs,Ys,Es]);const{Title:Gn,Text:Ot}=Tt,Ct=n=>typeof n!="string"?String(n):n.includes("T")?n.split("T")[0]:n.includes(" ")?n.split(" ")[0]:n,En=o.memo(()=>{var n,r,l,b,m,w,z,M,g;const I=Jt(),[R,X]=o.useState(!1),[B,Ie]=o.useState([]),[Oe,pe]=o.useState([]),[U,he]=o.useState("all"),[v,W]=o.useState(!1),[j,Ve]=o.useState(null),[Se,ie]=o.useState(!1),[Te,Xe]=o.useState("performance"),[ce,et]=o.useState(0),te=o.useRef(null),Pe=o.useRef(null),[ge,rt]=o.useState(!1),zt=o.useRef(!1),ct=[{title:"日期",dataIndex:"date",key:"date",sorter:(t,a)=>{const u=new Date(t.date),p=new Date(a.date);return u.getTime()-p.getTime()}},{title:"方向",dataIndex:"action",key:"action",filters:[{text:"买入",value:"BUY"},{text:"卖出",value:"SELL"}],onFilter:(t,a)=>a.action===t,render:t=>{const a=t==="BUY"?"买入":t==="SELL"?"卖出":t;return e.jsx(Le,{color:t==="BUY"?"red":"green",children:a})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:t=>e.jsx(_e,{title:t||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:t||"未记录"})})},{title:"期初资金",dataIndex:"before_cash",key:"before_cash",sorter:(t,a)=>t.before_cash-a.before_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"after_cash",key:"after_cash",sorter:(t,a)=>t.after_cash-a.after_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"价格",dataIndex:"price",key:"price",sorter:(t,a)=>{const u=t.price||0,p=a.price||0;return u-p},render:t=>{const a=parseFloat(t);return isNaN(a)?"-":a.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(t,a)=>t.shares-a.shares,render:t=>(parseInt(t)||0).toLocaleString()},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(t,a)=>t.value-a.value,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"手续费",dataIndex:"commission",key:"commission",sorter:(t,a)=>t.commission-a.commission,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(t,a)=>(t.position_size||0)-(a.position_size||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(t,a)=>(t.cumulative_position_ratio||0)-(a.cumulative_position_ratio||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}}],[qe,We]=o.useState(!1),[ze,bt]=o.useState(null),[vt,pt]=o.useState(!1),[ft]=F.useForm(),[He,gt]=o.useState(!1),[tt,Ke]=o.useState([]),k=()=>Ut(void 0,null,function*(){X(!0);try{const t=yield q.get("/api/backtest-status/list");Ie(t.data),pe(t.data)}catch(t){console.error("获取回测列表失败:",t),d.error("获取回测列表失败")}finally{X(!1)}}),f=()=>Ut(void 0,null,function*(){if(B.length===0){d.warning("没有可更新的回测记录");return}Re.confirm({title:"批量更新到最新K线",content:`确定要将所有 ${B.length} 个回测记录更新到最新的K线日期吗？此操作可能需要较长时间。`,okText:"确定更新",cancelText:"取消",onOk:()=>Ut(void 0,null,function*(){var t,a;rt(!0);let u=0,p=0;const A=[];try{for(const L of B)try{const N=yield q.post(`/api/backtest-status/${L.id}/update`,{update_to_date:null});N.data.status==="success"?(u++,console.log(`成功更新回测: ${L.name}`)):(p++,A.push({name:L.name,error:N.data.message||"更新失败"}),console.error(`更新回测失败: ${L.name}`,N.data.message))}catch(N){p++,A.push({name:L.name,error:((a=(t=N.response)==null?void 0:t.data)==null?void 0:a.detail)||N.message||"网络错误"}),console.error(`更新回测失败: ${L.name}`,N)}d.success(`批量更新完成！成功更新 ${u} 个回测，失败 ${p} 个`),k(),p>0&&Re.info({title:"更新结果详情",content:e.jsxs("div",{children:[e.jsxs("p",{children:["成功更新: ",u," 个"]}),e.jsxs("p",{children:["更新失败: ",p," 个"]}),A.length>0&&e.jsxs("div",{children:[e.jsx("p",{children:"失败项目:"}),e.jsx("ul",{children:A.map((L,N)=>e.jsxs("li",{children:[L.name,": ",L.error]},N))})]})]}),width:500})}catch(L){console.error("批量更新失败:",L),d.error("批量更新失败，请重试")}finally{rt(!1)}})})}),_=t=>Ut(void 0,null,function*(){ie(!0);try{const a=yield q.get(`/api/backtest-status/${t}`);if(a.data.status==="success"){const u=a.data.data;u.results&&u.results.trades&&(u.results.trades=u.results.trades.sort((p,A)=>new Date(A.date).getTime()-new Date(p.date).getTime())),u.trade_records&&(u.trade_records=u.trade_records.sort((p,A)=>new Date(A.date).getTime()-new Date(p.date).getTime())),Ve(u),W(!0)}else d.error("获取回测详情失败")}catch(a){console.error("获取回测详情失败:",a),d.error("获取回测详情失败")}finally{ie(!1)}}),V=t=>Ut(void 0,null,function*(){Re.confirm({title:"确认删除",content:"此操作将永久删除该回测记录，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>Ut(void 0,null,function*(){try{const a=yield q.delete(`/api/backtest-status/${t}`);a.data.status==="success"?(d.success("删除成功"),k()):d.error(a.data.message||"删除失败")}catch(a){console.error("删除回测失败:",a),d.error("删除失败，请重试")}})})}),re=t=>{bt(t),ft.setFieldsValue({new_name:t.name,new_description:t.description||"",update_to_date:null}),We(!0)},G=t=>{gt(!0),Ke([]),q.get(`/api/backtest-status/${t.id}`).then(a=>{if(a.data&&a.data.status==="success"){const p=(a.data.data||{}).logs||[];Ke(p)}else{const u=t.logs||[];Ke(u)}}).catch(a=>{console.error("获取日志失败:",a),d.error("获取日志失败");const u=t.logs||[];Ke(u)})},Fe=()=>Ut(void 0,null,function*(){var t,a,u;if(ze)try{const p=yield ft.validateFields();pt(!0);const A={new_name:p.new_name,new_description:p.new_description||"",update_to_date:p.update_to_date?p.update_to_date.format("YYYY-MM-DD"):void 0},L=yield q.post(`/api/backtest-status/${ze.id}/update`,A);if(L.data.status==="success"){d.success("回测更新成功！"),We(!1),ft.resetFields(),k();const N=L.data.data;Re.success({title:"更新成功",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"新回测名称:"})," ",N.new_backtest_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"更新日期范围:"})," ",N.update_range.start_date," 至 ",N.update_range.end_date]}),N.performance_metrics&&e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("strong",{children:"性能指标:"})}),e.jsxs("ul",{children:[e.jsxs("li",{children:["总收益率: ",(N.performance_metrics.total_return*100).toFixed(2),"%"]}),e.jsxs("li",{children:["最大回撤: ",(N.performance_metrics.max_drawdown*100).toFixed(2),"%"]}),e.jsxs("li",{children:["夏普比率: ",((t=N.performance_metrics.sharpe_ratio)==null?void 0:t.toFixed(2))||"N/A"]})]})]})]}),okText:"确定"})}else d.error(L.data.message||"更新失败")}catch(p){console.error("更新回测失败:",p),d.error(((u=(a=p.response)==null?void 0:a.data)==null?void 0:u.detail)||"更新失败，请重试")}finally{pt(!1)}}),st=[{title:"ID",dataIndex:"id",key:"id",width:60,fixed:"left",align:"center"},{title:"回测名称",dataIndex:"name",key:"name",width:180,fixed:"left",ellipsis:!0,render:t=>e.jsx(_e,{title:t,placement:"topLeft",children:e.jsx(Ot,{strong:!0,style:{color:"#1890ff"},children:t})})},{title:"策略",dataIndex:"strategy_name",key:"strategy_name",width:120,ellipsis:!0,render:t=>e.jsx(_e,{title:t||"未知策略",placement:"topLeft",children:e.jsx(Le,{color:"blue",children:t||"未知"})})},{title:"自定义参数",key:"parameters",width:150,ellipsis:!0,render:(t,a)=>{const u=a.parameters;if(!u||Object.keys(u).length===0)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const p=u.parameters||{},A=Object.keys(p).length;if(A===0)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const N=Object.entries(p).slice(0,2).map(([ne,S])=>`${ne}:${S}`).join(", "),Q=A>2?`${N}...`:N;return e.jsx(_e,{title:e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:"8px"},children:"策略参数:"}),Object.entries(p).map(([ne,S])=>e.jsxs("div",{style:{marginBottom:"4px"},children:[e.jsxs("span",{style:{color:"#1890ff"},children:[ne,":"]})," ",String(S)]},ne))]}),placement:"topLeft",children:e.jsx(Ot,{style:{color:"#722ed1",fontSize:"12px"},children:Q})})}},{title:"股票",dataIndex:"instruments",key:"instruments",width:80,align:"center",render:t=>e.jsx(Le,{color:"green",children:t.join(", ")})},{title:"回测期间",key:"date_range",width:160,align:"center",render:(t,a)=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:$(a.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#999"},children:["至 ",$(a.end_date).format("YYYY-MM-DD")]})]})},{title:"状态",dataIndex:"status",key:"status",width:80,align:"center",render:t=>{const u={running:{text:"运行中",color:"processing"},completed:{text:"已完成",color:"success"},failed:{text:"失败",color:"error"}}[t]||{text:t,color:"default"};return e.jsx(Le,{color:u.color,children:u.text})}},{title:"年化收益率",key:"annual_return",width:100,align:"right",render:(t,a)=>{var u;const p=(u=a.performance_metrics)==null?void 0:u.annual_return;if(p!==void 0){const A=p>=0?"#ff4d4f":"#52c41a",L=p*100;return e.jsxs(Ot,{style:{color:A,fontWeight:"bold"},children:[L>=0?"+":"",L.toFixed(1),"%"]})}return e.jsx(Ot,{style:{color:"#999"},children:"-"})}},{title:"最大回撤",key:"max_drawdown",width:100,align:"right",render:(t,a)=>{var u;const p=(u=a.performance_metrics)==null?void 0:u.max_drawdown;if(p!==void 0){const A=Math.floor(p*100*100)/100;return e.jsxs(Ot,{style:{color:"#ff4d4f",fontWeight:"bold"},children:[A.toFixed(1),"%"]})}return e.jsx(Ot,{style:{color:"#999"},children:"-"})}},{title:"最近一次交易时间",key:"last_trade_time",width:160,align:"center",render:(t,a)=>{const u=a.trade_records||[];if(u.length===0)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const p=u[u.length-1],A=p==null?void 0:p.date,L=p==null?void 0:p.action,N=p==null?void 0:p.price;if(!A)return e.jsx(Ot,{style:{color:"#999"},children:"-"});const Q=L==="BUY"?"买入":L==="SELL"?"卖出":L||"未知",ne=L==="BUY"?"#ff4d4f":L==="SELL"?"#52c41a":"#999";return e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:$(A).format("MM-DD")}),e.jsx("div",{style:{color:ne,fontWeight:"bold",marginTop:"2px"},children:Q}),N&&e.jsxs("div",{style:{color:"#666",fontSize:"11px",marginTop:"1px"},children:["$",parseFloat(N).toFixed(2)]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:120,align:"center",render:t=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{children:$(t).format("MM-DD")}),e.jsx("div",{style:{color:"#999"},children:$(t).format("HH:mm")})]})},{title:"操作",key:"actions",width:180,fixed:"right",render:(t,a)=>e.jsxs($e,{size:"small",children:[e.jsx(_e,{title:"查看详情",children:e.jsx(P,{type:"text",icon:e.jsx(qs,{}),onClick:()=>_(a.id),size:"small",style:{color:"#1890ff"}})}),e.jsx(_e,{title:"历史记录",children:e.jsx(P,{type:"text",icon:e.jsx(ds,{}),onClick:()=>I(`/backtest-history/${a.id}`),size:"small",style:{color:"#52c41a"}})}),e.jsx(_e,{title:"更新数据",children:e.jsx(P,{type:"text",icon:e.jsx(as,{}),onClick:()=>re(a),size:"small",style:{color:"#faad14"}})}),e.jsx(_e,{title:"查看日志",children:e.jsx(P,{type:"text",icon:e.jsx(Ms,{}),onClick:()=>G(a),size:"small",style:{color:"#722ed1"}})}),e.jsx(_e,{title:"删除",children:e.jsx(P,{type:"text",danger:!0,icon:e.jsx(us,{}),onClick:()=>V(a.id),size:"small"})})]})}],Ee=(t,a,u)=>{if(!t||t.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const p=t.filter(Y=>Y&&Y.date&&Y.equity!==void 0&&!isNaN(Number(Y.equity)));if(p.length===0)return{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};let A=[],L=[];const N=new Map;p.forEach((Y,ee)=>{const Be=Ct(Y.date);N.set(Be,ee)}),a&&a.length>0&&a.forEach(Y=>{const ee=Ct(Y.date),Be=N.get(ee);if(Be!==void 0){const Ze={name:Y.action==="BUY"?"买入点":"卖出点",value:p[Be].equity,xAxis:Be,yAxis:p[Be].equity,itemStyle:{color:Y.action==="BUY"?"#f64034":"#00b46a"}};Y.action==="BUY"?A.push(Ze):L.push(Ze)}});let Q=-1,ne=-1,S=0,me="",ke="",le=0,Ce=0;if(p.length>0){let Y=p[0].equity,ee=0,Be=0;for(let Ze=1;Ze<p.length;Ze++)p[Ze].equity>Y?(Y=p[Ze].equity,Be=Ze):(ee=(Y-p[Ze].equity)/Y*100,ee>S&&(S=ee,Q=Be,ne=Ze,me=p[Be].date,ke=p[Ze].date,le=Y,Ce=p[Ze].equity));console.log(`最大回撤区间索引: ${Q} - ${ne}`),console.log(`最大回撤: ${S.toFixed(2)}%, 从 ${me} 到 ${ke}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(Y){if(Array.isArray(Y)&&Y.length>0){const Be=Y[0].axisValue,Ze=Y[0].data;for(let fe=0;fe<Y.length;fe++)if(Y[fe].componentType==="markArea")return`最大回撤: ${S.toFixed(2)}%<br/>
                        开始日期: ${me}<br/>
                        最高点: ¥${le.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${ke}<br/>
                        最低点: ¥${Ce.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let dt="";for(let fe=0;fe<Y.length;fe++){const lt=Y[fe];if(lt.seriesName==="买入点"||lt.seriesName==="卖出点"){const ls=Ct(Be),Kt=a.find(Ue=>Ct(Ue.date)===ls&&(lt.seriesName==="买入点"&&Ue.action==="BUY"||lt.seriesName==="卖出点"&&Ue.action==="SELL"));if(Kt){const Ue=Kt.trigger_reason||"未记录原因";dt=`<br/><span style="color:${lt.color}">● ${lt.seriesName}</span>`,dt+=`<br/><span style="color:#555; font-size:12px">原因: ${Ue}</span>`}else dt=`<br/><span style="color:${lt.color}">● ${lt.seriesName}</span>`;break}}return`${Be}<br/>策略收益: ¥${parseFloat(Ze).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${dt}`}const ee=Y.value;return`${Y.name}: ¥${parseFloat(ee).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:p.map(Y=>Y.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:p.map(Y=>Y.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new za(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...A.map(Y=>({name:"买入点",coord:[Y.xAxis,Y.yAxis],value:Y.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...L.map(Y=>({name:"卖出点",coord:[Y.xAxis,Y.yAxis],value:Y.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${S.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[Q>=0&&ne>=0?[{name:"最大回撤开始",xAxis:Q,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:ne,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:p.map(()=>u),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:u,label:{formatter:"初始资金: ¥"+u.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(Y){return`初始资金: ¥${u.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},Ge=(t,a)=>{if(!a||!Array.isArray(a)||a.length===0)return console.warn(`计算MA${t}失败: 数据无效`),[];const u=[];for(let p=0;p<a.length;p++){if(p<t-1){u.push("-");continue}let A=0,L=0;for(let N=0;N<t;N++){const Q=a[p-N];if(Q&&Q.length>=4){const ne=Number(Q[1]);!isNaN(ne)&&ne>0&&(A+=ne,L++)}}L>0?u.push((A/L).toFixed(2)):u.push("-")}return u},nt=(t,a)=>{var u;const p=`${((u=j==null?void 0:j.instruments)==null?void 0:u[0])||"股票"} K线图与交易信号`;if(!t||t.length===0)return{title:{text:p,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"}}};const A=t.map(S=>[S.date,S.open,S.close,S.low,S.high,S.volume]);let L=[],N=[];if(a&&a.length>0){const S=new Map;A.forEach((le,Ce)=>{const Y=Ct(le[0]);S.set(Y,Ce)}),L=a.filter(le=>le.action==="BUY").map(le=>{const Ce=Ct(le.date),Y=S.get(Ce),ee=le.price||0;return Y===void 0||ee<=0?null:{name:"买入",value:[Y,ee],xAxis:Y,yAxis:ee,itemStyle:{color:"#f64034"}}}).filter(le=>le!==null),N=a.filter(le=>le.action==="SELL").map(le=>{const Ce=Ct(le.date),Y=S.get(Ce),ee=le.price||0;return Y===void 0||ee<=0?null:{name:"卖出",value:[Y,ee],xAxis:Y,yAxis:ee,itemStyle:{color:"#00b46a"}}}).filter(le=>le!==null)}const Q=A.map(S=>S[0]);let ne=[...L.map(S=>({name:"买入点",coord:[S.value[0],S.value[1]],value:S.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...N.map(S=>({name:"卖出点",coord:[S.value[0],S.value[1]],value:S.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...L.map(S=>{const me=S.value[0],le=A[me][4]*1.1;return{name:"买入标签",coord:[S.value[0],le],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...N.map(S=>{const me=S.value[0],le=A[me][4]*1.2;return{name:"卖出标签",coord:[S.value[0],le],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];return{title:{text:p,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(S){let me="";if(Array.isArray(S)){const ke=S[0].axisValue;me=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${ke}</div>`,S.forEach(ee=>{if(ee.seriesName==="K线"){if(ee.value&&ee.value.length>=4){const Be=Number(ee.value[1])||0,Ze=Number(ee.value[2])||0,dt=Number(ee.value[3])||0,fe=Number(ee.value[4])||0,lt=Ze>=Be?"#f64034":"#00b46a";me+=`<div style="color:${lt};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${lt};">${Be.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${lt};">${Ze.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${lt};">${dt.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${lt};">${fe.toFixed(2)}</span><br/>
                  </div>`}}else if(ee.seriesName&&ee.seriesName.startsWith("MA")&&ee.value!=="-"){const Ze={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[ee.seriesName]||ee.color;try{const dt=typeof ee.value=="number"?parseFloat(ee.value.toString()).toFixed(3):parseFloat(ee.value||"0").toFixed(3);me+=`<div style="color:${Ze};font-weight:bold;display:inline-block;margin-right:15px;">${ee.seriesName}：${dt}</div>`}catch(dt){console.warn("格式化MA值出错:",dt),me+=`<div style="color:${Ze};font-weight:bold;display:inline-block;margin-right:15px;">${ee.seriesName}：0</div>`}}});const le=Ct(ke),Ce=a.find(ee=>ee.action==="BUY"&&Ct(ee.date)===le),Y=a.find(ee=>ee.action==="SELL"&&Ct(ee.date)===le);if((Ce||Y)&&(me+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),Ce){const ee=Ce.price||0,Be=Ce.trigger_reason||"未记录原因";me+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${ee.toFixed(2)}<br/>
                原因：${Be}
              </div>`}if(Y){const ee=Y.price||0,Be=Y.trigger_reason||"未记录原因";me+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${ee.toFixed(2)}<br/>
                原因：${Be}
              </div>`}}return me}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:Q,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:A.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:ne,animation:!1,z:10}},{name:"MA5",type:"line",data:Ge(5,A.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Ge(10,A.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Ge(20,A.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Ge(30,A.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}},Ne=o.useMemo(()=>{var t,a,u,p;return[{key:"1",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"绩效分析"]}),children:e.jsx(J,{gutter:16,children:e.jsx(x,{span:24,style:{marginBottom:16},children:e.jsx(qt,{option:Ee((j==null?void 0:j.equity_curve)||[],((t=j==null?void 0:j.results)==null?void 0:t.trades)||(j==null?void 0:j.trade_records)||[],(j==null?void 0:j.initial_capital)||1e5),style:{height:500},notMerge:!0,opts:{renderer:"canvas"}},`equity-chart-${ce}`)})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(Lt,{}),"K线与交易信号"]}),children:e.jsx(J,{gutter:16,children:e.jsx(x,{span:24,children:e.jsx(oe,{title:`${((a=j==null?void 0:j.instruments)==null?void 0:a[0])||"股票"}交易图表`,extra:e.jsxs($e,{children:[e.jsx(P,{type:"primary",size:"small",onClick:()=>{const A=document.querySelector(".kline-chart");if(A){const L=A.__echarts__;L&&L.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(P,{size:"small",onClick:()=>{var A;const L=((A=j==null?void 0:j.results)==null?void 0:A.trades)||(j==null?void 0:j.trade_records)||[],N=(j==null?void 0:j.equity_curve)||[];if(L.length>0&&N.length>0){const Q=new Map;N.forEach((S,me)=>{const ke=Ct(S.date);Q.set(ke,me)});const ne=[];if(L.forEach(S=>{const me=Ct(S.date),ke=Q.get(me);ke!==void 0&&ne.push(ke)}),ne.length>0){const S=Math.max(0,Math.min(...ne)-10),me=Math.min(N.length-1,Math.max(...ne)+10),ke=S/N.length*100,le=me/N.length*100,Ce=document.querySelector(".kline-chart");if(Ce){const Y=Ce.__echarts__;Y&&(Y.dispatchAction({type:"dataZoom",start:ke,end:le}),d.success(`已聚焦到交易区域，共显示 ${ne.length} 个交易点`))}}else d.info("未找到交易信号对应的K线数据点")}else d.info("没有交易记录或K线数据")},children:"聚焦交易"}),e.jsx(_e,{title:"只显示有交易的区域",children:e.jsx(Je,{})})]}),children:e.jsx(qt,{className:"kline-chart",option:nt((j==null?void 0:j.equity_curve)||[],((u=j==null?void 0:j.results)==null?void 0:u.trades)||(j==null?void 0:j.trade_records)||[]),style:{height:600},notMerge:!0,opts:{renderer:"canvas"}},`kline-chart-${ce}`)})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Je,{}),"交易明细"]}),children:e.jsx(Zt,{dataSource:((p=j==null?void 0:j.results)==null?void 0:p.trades)||(j==null?void 0:j.trade_records)||[],columns:ct,rowKey:A=>`trade-${A.date}-${A.action}-${A.price}`,pagination:{pageSize:10},scroll:{x:!0}})}]},[j]);return o.useEffect(()=>{zt.current||(zt.current=!0,k())},[]),o.useEffect(()=>{if(U==="all")pe(B);else{const t=B.filter(a=>a.strategy_name===U);pe(t)}},[B,U]),o.useEffect(()=>{if(v&&j){const t=setTimeout(()=>{te.current&&te.current.getEchartsInstance().resize(),Pe.current&&Pe.current.getEchartsInstance().resize(),et(u=>u+1)},500),a=()=>{te.current&&te.current.getEchartsInstance().resize(),Pe.current&&Pe.current.getEchartsInstance().resize()};return window.addEventListener("resize",a),()=>{clearTimeout(t),window.removeEventListener("resize",a)}}},[v,j]),e.jsxs("div",{style:{padding:"24px"},children:[e.jsx("style",{children:`
        .table-row-light {
          background-color: #fafafa;
        }
        .table-row-dark {
          background-color: #ffffff;
        }
        .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
          font-weight: 600 !important;
          text-align: center !important;
          white-space: nowrap !important;
        }
        .ant-table-tbody > tr:hover > td {
          background-color: #e6f7ff !important;
        }
        .ant-table-tbody > tr > td {
          padding: 8px 12px !important;
          border-bottom: 1px solid #f0f0f0 !important;
        }
        .ant-table-fixed-left .ant-table-thead > tr > th,
        .ant-table-fixed-right .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
        }
        .ant-table-fixed-left .ant-table-tbody > tr > td,
        .ant-table-fixed-right .ant-table-tbody > tr > td {
          background-color: inherit !important;
        }
      `}),e.jsx(oe,{title:e.jsxs($e,{children:[e.jsx(ds,{}),e.jsx("span",{children:"回测历史"})]}),extra:e.jsxs($e,{size:"middle",children:[e.jsx($e.Compact,{children:e.jsxs(Ye,{value:U,onChange:he,style:{width:180},placeholder:"选择策略筛选",allowClear:!0,size:"middle",suffixIcon:e.jsx(gr,{}),children:[e.jsx(Ye.Option,{value:"all",children:"全部策略"}),Array.from(new Set(B.map(t=>t.strategy_name).filter(Boolean))).map(t=>e.jsx(Ye.Option,{value:t,children:t},t))]})}),e.jsx(P,{icon:e.jsx(as,{}),onClick:f,loading:ge,type:"primary",children:"一键更新到最新K线"}),e.jsx(P,{icon:e.jsx(Bs,{}),onClick:k,loading:R,children:"刷新"})]}),children:e.jsx(Zt,{columns:st,dataSource:Oe,rowKey:"id",loading:R,size:"small",bordered:!0,pagination:{pageSize:it.getPageSize(15),showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,a)=>`第 ${a[0]}-${a[1]} 条，共 ${t} 条`,pageSizeOptions:["10","15","20","50"],size:"small",onChange:(t,a)=>{it.setCurrentPage(t),it.setPageSize(a||15)},onShowSizeChange:(t,a)=>{it.setPageSize(a)}},scroll:{x:1550,y:"calc(100vh - 300px)"},rowClassName:(t,a)=>a%2===0?"table-row-light":"table-row-dark"})}),e.jsx(Re,{title:"回测详情",open:v,onCancel:()=>{W(!1),Xe("performance")},footer:null,width:1200,destroyOnClose:!0,afterOpenChange:t=>{t&&setTimeout(()=>{te.current&&te.current.getEchartsInstance().resize(),Pe.current&&Pe.current.getEchartsInstance().resize()},100)},children:j&&e.jsxs("div",{children:[e.jsxs(ut,{title:"基本信息",bordered:!0,column:2,style:{marginBottom:24},children:[e.jsx(ut.Item,{label:"回测名称",children:j.name}),e.jsx(ut.Item,{label:"策略名称",children:((n=j.strategy_info)==null?void 0:n.name)||"-"}),e.jsxs(ut.Item,{label:"回测期间",children:[$(j.start_date).format("YYYY-MM-DD")," 至 ",$(j.end_date).format("YYYY-MM-DD")]}),e.jsxs(ut.Item,{label:"初始资金",children:["$",j.initial_capital.toLocaleString()]}),e.jsx(ut.Item,{label:"交易标的",children:j.instruments.join(", ")}),e.jsx(ut.Item,{label:"状态",children:e.jsx(Le,{color:j.status==="completed"?"success":"processing",children:j.status==="completed"?"已完成":"运行中"})})]}),j.performance_metrics&&e.jsxs(oe,{title:"性能指标",style:{marginBottom:24},children:[e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["累计收益 ",e.jsx(_e,{title:"回测期间的总收益率",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:((m=(b=(r=j.performance_metrics)==null?void 0:r.total_return)!=null?b:(l=j.results)==null?void 0:l.total_return)!=null?m:0)*100,precision:2,valueStyle:{color:((g=(M=(w=j.performance_metrics)==null?void 0:w.total_return)!=null?M:(z=j.results)==null?void 0:z.total_return)!=null?g:0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(_e,{title:"策略的年化收益率",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:(j.performance_metrics.annual_return||0)*100,precision:2,valueStyle:{color:(j.performance_metrics.annual_return||0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(_e,{title:"策略的最大回撤幅度",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:j.performance_metrics.max_drawdown*100,precision:2,valueStyle:{color:"#ff4d4f"},suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(_e,{title:"风险调整后的收益指标",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:j.performance_metrics.sharpe_ratio,precision:2})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["胜率 ",e.jsx(_e,{title:"盈利交易占总交易的比例",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:j.performance_metrics.win_rate*100,precision:2,suffix:"%"})})]}),e.jsxs(J,{gutter:16,style:{marginTop:24},children:[e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(_e,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:j.performance_metrics.profit_factor||0,precision:2})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["Alpha ",e.jsx(_e,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2,suffix:"%"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["Beta ",e.jsx(_e,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:e.jsxs("span",{children:["最近一次交易时间 ",e.jsx(_e,{title:"最后一次交易的时间和方向",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:(()=>{const t=j.trade_records||[];if(t.length===0)return"-";const a=t[t.length-1],u=a==null?void 0:a.date,p=a==null?void 0:a.action,A=a==null?void 0:a.price;if(!u)return"-";const L=p==="BUY"?"买入":p==="SELL"?"卖出":p||"未知",N=A?` @ $${parseFloat(A).toFixed(2)}`:"";return`${$(u).format("MM-DD")} (${L}${N})`})()})})]})]}),e.jsx(ps,{defaultActiveKey:"1",items:Ne})]})}),e.jsx(Re,{title:"更新回测数据",open:qe,onOk:Fe,onCancel:()=>{We(!1),ft.resetFields()},confirmLoading:vt,okText:"更新",cancelText:"取消",width:600,children:e.jsxs(F,{form:ft,layout:"vertical",style:{marginTop:16},children:[e.jsx(F.Item,{label:"新回测名称",name:"new_name",rules:[{required:!0,message:"请输入新回测名称"}],children:e.jsx(we,{placeholder:"请输入新回测名称"})}),e.jsx(F.Item,{label:"更新到日期",name:"update_to_date",extra:"留空则自动更新到最新可用数据（通常是昨天）",children:e.jsx(Gt,{style:{width:"100%"},placeholder:"选择更新截止日期（可选）",format:"YYYY-MM-DD"})}),e.jsx(F.Item,{label:"回测描述",name:"new_description",extra:"可选：更新回测的描述信息",children:e.jsx(we.TextArea,{placeholder:"请输入回测描述（可选）",rows:3})}),ze&&e.jsx(xt,{message:"更新说明",description:e.jsxs("div",{children:[e.jsx("p",{children:"• 将基于原回测的配置（策略、参数、仓位配置等）重新运行回测"}),e.jsxs("p",{children:["• 起始日期保持原回测的起始日期：",ze.start_date]}),e.jsx("p",{children:"• 结束日期将更新到您选择的日期，如不选择则自动更新到最新可用数据"}),e.jsx("p",{children:"• 将创建新的回测记录，原回测记录保持不变"})]}),type:"info",showIcon:!0,style:{marginBottom:16}})]})}),e.jsx(Re,{title:"策略执行日志",open:He,onCancel:()=>gt(!1),footer:[e.jsx(P,{onClick:()=>gt(!1),children:"关闭"},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"500px",overflowY:"auto"},children:tt.length>0?e.jsx("div",{style:{fontFamily:"monospace",fontSize:"12px"},children:tt.map((t,a)=>e.jsxs("div",{style:{marginBottom:"8px",padding:"8px 12px",backgroundColor:t.level==="ERROR"?"#fff2f0":t.level==="WARNING"?"#fffbe6":t.level==="DEBUG"?"#f6ffed":"#fafafa",border:`1px solid ${t.level==="ERROR"?"#ffccc7":t.level==="WARNING"?"#ffe58f":t.level==="DEBUG"?"#d9f7be":"#d9d9d9"}`,borderRadius:"4px"},children:[e.jsxs("div",{style:{color:t.level==="ERROR"?"#cf1322":t.level==="WARNING"?"#d46b08":t.level==="DEBUG"?"#52c41a":"#595959",fontWeight:"bold",marginBottom:"4px"},children:["[",t.timestamp,"] ",t.level]}),e.jsx("div",{style:{color:"#262626",whiteSpace:"pre-wrap"},children:t.message})]},a))}):e.jsxs("div",{style:{textAlign:"center",color:"#999",padding:"40px 0"},children:[e.jsx(Ms,{style:{fontSize:"48px",marginBottom:"16px"}}),e.jsx("div",{children:"暂无策略执行日志"}),e.jsx("div",{style:{fontSize:"12px",marginTop:"8px"},children:"策略中可以使用 log() 函数记录执行过程"})]})})})]})});var zs=(n,r,l)=>new Promise((b,m)=>{var w=g=>{try{M(l.next(g))}catch(I){m(I)}},z=g=>{try{M(l.throw(g))}catch(I){m(I)}},M=g=>g.done?b(g.value):Promise.resolve(g.value).then(w,z);M((l=l.apply(n,r)).next())});Ls([Ps,Fs,Ns,Os,Ts,Rs,Ys,Es]);const{Title:ja,Text:Bn}=Tt,qn=()=>{const{id:n}=_a(),r=Jt(),[l,b]=o.useState(!1),[m,w]=o.useState(null),[z,M]=o.useState([]),[g,I]=o.useState(!1),[R,X]=o.useState(null),[B,Ie]=o.useState(!1),Oe=()=>zs(void 0,null,function*(){if(n){b(!0);try{const v=yield q.get(`/api/backtest-status/${n}`);v.data.status==="success"?w(v.data.data):d.error("获取回测状态失败")}catch(v){console.error("获取回测状态失败:",v),d.error("获取回测状态失败")}finally{b(!1)}}}),pe=()=>zs(void 0,null,function*(){if(n){b(!0);try{const v=yield q.get(`/api/backtest-status/${n}/history`);M(v.data)}catch(v){console.error("获取回测历史失败:",v),d.error("获取回测历史失败")}finally{b(!1)}}}),U=v=>zs(void 0,null,function*(){Ie(!0);try{const W=z.find(j=>j.id===v);W&&(X(W),I(!0))}catch(W){console.error("获取历史记录详情失败:",W),d.error("获取历史记录详情失败")}finally{Ie(!1)}}),he=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:"回测期间",key:"period",render:(v,W)=>e.jsxs("div",{children:[e.jsx("div",{children:$(W.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#666",fontSize:"12px"},children:["至 ",$(W.end_date).format("YYYY-MM-DD")]})]})},{title:"初始资金",dataIndex:"initial_capital",key:"initial_capital",render:v=>`$${v.toLocaleString()}`},{title:"状态",dataIndex:"status",key:"status",render:v=>e.jsx(Le,{color:v==="completed"?"green":v==="running"?"blue":"red",children:v==="completed"?"已完成":v==="running"?"运行中":"失败"})},{title:"收益率",dataIndex:"total_return",key:"total_return",render:v=>e.jsxs("span",{style:{color:v>=0?"#52c41a":"#ff4d4f"},children:[v>=0?"+":"",v.toFixed(2),"%"]})},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:v=>e.jsxs("span",{style:{color:"#ff4d4f"},children:[v.toFixed(2),"%"]})},{title:"操作类型",dataIndex:"operation_type",key:"operation_type",render:v=>e.jsx(Le,{color:v==="create"?"blue":"orange",children:v==="create"?"创建":v==="update"?"更新":"重新运行"})},{title:"创建时间",dataIndex:"created_at",key:"created_at",render:v=>$(v).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",render:(v,W)=>e.jsx($e,{children:e.jsx(P,{type:"link",icon:e.jsx(qs,{}),onClick:()=>U(W.id),loading:B,children:"查看"})})}];return o.useEffect(()=>{Oe(),pe()},[n]),m?e.jsxs("div",{style:{padding:"24px"},children:[e.jsx(oe,{style:{marginBottom:"16px"},children:e.jsxs($e,{children:[e.jsx(P,{icon:e.jsx(Aa,{}),onClick:()=>r("/backtest/history"),children:"返回列表"}),e.jsxs(ja,{level:3,style:{margin:0},children:[e.jsx(ds,{})," ",m.name," - 历史记录"]})]})}),e.jsx(oe,{title:"当前状态概览",style:{marginBottom:"16px"},children:e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:6,children:e.jsx(xe,{title:"策略名称",value:m.strategy_name||"未知"})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:"回测期间",value:`${$(m.start_date).format("YYYY-MM-DD")} 至 ${$(m.end_date).format("YYYY-MM-DD")}`})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:"初始资金",value:`$${m.initial_capital.toLocaleString()}`})}),e.jsx(x,{span:6,children:e.jsx(xe,{title:"当前收益率",value:m.total_return,precision:2,suffix:"%",valueStyle:{color:m.total_return>=0?"#52c41a":"#ff4d4f"}})})]})}),e.jsx(oe,{title:e.jsxs($e,{children:[e.jsx(ds,{}),e.jsx("span",{children:"历史记录"})]}),extra:e.jsx(P,{icon:e.jsx(Bs,{}),onClick:pe,loading:l,children:"刷新"}),children:e.jsx(ss,{columns:he,dataSource:z,rowKey:"id",loading:l,pagination:{pageSize:it.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:(v,W)=>`第 ${W[0]}-${W[1]} 条，共 ${v} 条`,onChange:(v,W)=>{it.setCurrentPage(v),it.setPageSize(W||20)},onShowSizeChange:(v,W)=>{it.setPageSize(W)}},scroll:{x:1200}})}),e.jsx(Re,{title:"历史记录详情",open:g,onCancel:()=>I(!1),footer:[e.jsx(P,{onClick:()=>I(!1),children:"关闭"},"close")],width:800,children:R&&e.jsxs("div",{children:[e.jsxs(ut,{bordered:!0,column:2,children:[e.jsx(ut.Item,{label:"记录ID",children:R.id}),e.jsx(ut.Item,{label:"操作类型",children:e.jsx(Le,{color:R.operation_type==="create"?"blue":"orange",children:R.operation_type==="create"?"创建":"更新"})}),e.jsxs(ut.Item,{label:"回测期间",span:2,children:[$(R.start_date).format("YYYY-MM-DD")," 至 ",$(R.end_date).format("YYYY-MM-DD")]}),e.jsxs(ut.Item,{label:"初始资金",children:["$",R.initial_capital.toLocaleString()]}),e.jsx(ut.Item,{label:"状态",children:e.jsx(Le,{color:R.status==="completed"?"green":"red",children:R.status==="completed"?"已完成":"失败"})}),e.jsx(ut.Item,{label:"收益率",children:e.jsxs("span",{style:{color:R.total_return>=0?"#52c41a":"#ff4d4f"},children:[R.total_return>=0?"+":"",R.total_return.toFixed(2),"%"]})}),e.jsx(ut.Item,{label:"最大回撤",children:e.jsxs("span",{style:{color:"#ff4d4f"},children:[R.max_drawdown.toFixed(2),"%"]})}),e.jsx(ut.Item,{label:"创建时间",children:$(R.created_at).format("YYYY-MM-DD HH:mm:ss")}),e.jsx(ut.Item,{label:"完成时间",children:R.completed_at?$(R.completed_at).format("YYYY-MM-DD HH:mm:ss"):"未完成"})]}),R.performance_metrics&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(ja,{level:5,children:"性能指标"}),e.jsxs(J,{gutter:16,children:[e.jsx(x,{span:8,children:e.jsx(xe,{title:"累计收益",value:R.total_return!==void 0?R.total_return:(R.performance_metrics.total_return||0)*100,precision:2,suffix:"%"})}),e.jsx(x,{span:8,children:e.jsx(xe,{title:"夏普比率",value:R.performance_metrics.sharpe_ratio||0,precision:3})}),e.jsx(x,{span:8,children:e.jsx(xe,{title:"波动率",value:R.performance_metrics.volatility||0,precision:2,suffix:"%"})}),e.jsx(x,{span:8,children:e.jsx(xe,{title:"胜率",value:R.performance_metrics.win_rate||0,precision:2,suffix:"%"})})]})]})]})})]}):e.jsx("div",{style:{padding:"24px"},children:e.jsx(oe,{loading:l,children:e.jsx("div",{style:{textAlign:"center",padding:"50px"},children:e.jsx(Bn,{children:"加载中..."})})})})};const{Content:Vn}=rs,Hn=()=>e.jsx(La,{locale:Pa,theme:Fa,children:e.jsx(yr,{children:e.jsx(Va,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(rs,{style:{minHeight:"100vh"},children:[e.jsx(_r,{}),e.jsxs(rs,{children:[e.jsx(Sr,{}),e.jsx(rs,{style:{padding:"24px"},children:e.jsx(Vn,{style:{padding:24,margin:0,minHeight:280,background:"#fff",borderRadius:"8px"},children:e.jsxs(Ha,{children:[e.jsx(St,{path:"/",element:e.jsx(Ka,{to:"/dashboard",replace:!0})}),e.jsx(St,{path:"/dashboard",element:e.jsx(Lr,{})}),e.jsx(St,{path:"/data",element:e.jsx(Ea,{})}),e.jsx(St,{path:"/strategy",element:e.jsx(Tn,{})}),e.jsx(St,{path:"/strategy/edit",element:e.jsx(ya,{})}),e.jsx(St,{path:"/strategy/edit/:id",element:e.jsx(ya,{})}),e.jsx(St,{path:"/strategy/builder",element:e.jsx(Xr,{})}),e.jsx(St,{path:"/backtest",element:e.jsx(yn,{})}),e.jsx(St,{path:"/backtest/history",element:e.jsx(En,{})}),e.jsx(St,{path:"/backtest-history/:id",element:e.jsx(qn,{})}),e.jsx(St,{path:"/optimization",element:e.jsx($n,{})}),e.jsx(St,{path:"/ai-investment",element:e.jsx(Nn,{})})]})})})]})]})})})});Ca.locale("en-gb");q.defaults.baseURL="http://localhost:8001";Ua.createRoot(document.getElementById("root")).render(e.jsx(Wa.StrictMode,{children:e.jsx(La,{locale:Pa,theme:Fa,children:e.jsx(Hn,{})})}));
