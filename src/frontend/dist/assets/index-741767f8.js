import{k as e,L as Xt,r as l,u as Qt,l as ya,E as ja,m as Ea,n as ba,B as Ba,o as qa,p as kt,N as Va,q as Ha,R as Ka}from"./react-vendor-6f13ff9c.js";import{L as Ft,M as ts,B as P,G as Ua,z as rs,C as Wa,D as va,F as _a,H as As,I as bs,R as Ga,J as ds,K as ns,N as Z,O as f,P as le,Q as ge,T as Za,U as Ja,V as Qa,W as Xa,X as Dt,Y as Rt,Z as q,$ as ss,a0 as I,a1 as De,a2 as F,a3 as Le,a4 as wa,a5 as as,a6 as us,a7 as Be,a8 as Hs,a9 as ks,aa as ke,ab as Ye,ac as Zt,ad as er,ae as d,af as tr,ag as sr,ah as ar,ai as ps,aj as rr,ak as Sa,al as ka,am as Ls,an as $a,ao as Ps,ap as Fs,aq as Ns,ar as Ts,as as Os,at as Ys,au as nr,av as lr,aw as or,ax as Rs,ay as ir,az as Es,aA as Vt,aB as gt,aC as cr,aD as Se,aE as Je,aF as Gt,aG as ys,aH as Ia,aI as Ca,aJ as Bs,aK as Da,aL as qt,aM as Ms,aN as dr,aO as qs,aP as ur,aQ as Ks,aR as pr,aS as Us,aT as hr,aU as mr,aV as za,aW as xr,aX as ut,aY as Ma,aZ as Aa,a_ as fr}from"./vendor-7d963d80.js";import{M as gr}from"./monaco-313743a9.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const m of document.querySelectorAll('link[rel="modulepreload"]'))j(m);new MutationObserver(m=>{for(const w of m)if(w.type==="childList")for(const D of w.addedNodes)D.tagName==="LINK"&&D.rel==="modulepreload"&&j(D)}).observe(document,{childList:!0,subtree:!0});function o(m){const w={};return m.integrity&&(w.integrity=m.integrity),m.referrerPolicy&&(w.referrerPolicy=m.referrerPolicy),m.crossOrigin==="use-credentials"?w.credentials="include":m.crossOrigin==="anonymous"?w.credentials="omit":w.credentials="same-origin",w}function j(m){if(m.ep)return;m.ep=!0;const w=o(m);fetch(m.href,w)}})();const La={token:{colorPrimary:"#1890ff",borderRadius:8,colorBgContainer:"#ffffff",fontSize:12,fontSizeSM:11,fontSizeLG:14,fontSizeXL:16},components:{Table:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Card:{colorBgContainer:"#ffffff",borderRadius:8,fontSize:12},Button:{borderRadius:6,fontSize:12},Typography:{fontSize:12},Form:{fontSize:12},Input:{fontSize:12},Select:{fontSize:12},Menu:{fontSize:12}}},{Header:yr}=rs,{useToken:jr}=Wa,br=()=>{const{token:n}=jr(),r=[{key:"/",icon:e.jsx(va,{}),label:e.jsx(Xt,{to:"/",children:"首页"})},{key:"/data",icon:e.jsx(_a,{}),label:e.jsx(Xt,{to:"/data",children:"数据管理"})},{key:"/strategy",icon:e.jsx(As,{}),label:e.jsx(Xt,{to:"/strategy",children:"策略编辑"})},{key:"/backtest",icon:e.jsx(Ft,{}),label:e.jsx(Xt,{to:"/backtest",children:"回测分析"})},{key:"/optimization",icon:e.jsx(bs,{}),label:e.jsx(Xt,{to:"/optimization",children:"参数优化"})}];return e.jsxs(yr,{style:{background:n.colorBgContainer,padding:"0 24px",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx("div",{className:"header-nav-logo",children:e.jsxs(Xt,{to:"/",style:{color:n.colorPrimary,fontSize:"18px",fontWeight:"bold",display:"flex",alignItems:"center"},children:[e.jsx(Ft,{style:{marginRight:"8px",fontSize:"24px"}}),"量化交易系统"]})}),e.jsx(ts,{className:"header-nav-menu",mode:"horizontal",selectedKeys:[window.location.pathname],style:{flex:1,marginLeft:"40px",borderBottom:"none"},items:r}),e.jsx("div",{children:e.jsx(P,{icon:e.jsx(Ua,{}),type:"text",href:"https://github.com/yourusername/quant-trading-system",target:"_blank",rel:"noopener noreferrer",children:"GitHub"})})]})},{Sider:vr}=rs,_r=()=>{const[n,r]=l.useState(!1),o=Qt(),j=ya(),m=[{key:"/",icon:e.jsx(va,{}),label:"首页"},{key:"/data",icon:e.jsx(_a,{}),label:"数据管理"},{key:"/strategy",icon:e.jsx(As,{}),label:"策略编辑"},{key:"/ai-investment",icon:e.jsx(Ga,{}),label:"AI实时投资跑数"},{key:"backtest",icon:e.jsx(Ft,{}),label:"回测管理",children:[{key:"/backtest",icon:e.jsx(Ft,{}),label:"回测分析"},{key:"/backtest/history",icon:e.jsx(ds,{}),label:"回测历史"}]},{key:"/optimization",icon:e.jsx(bs,{}),label:"参数优化"}],w=D=>{o(D.key)};return e.jsxs(vr,{collapsible:!0,collapsed:n,onCollapse:D=>r(D),style:{background:"#fff"},width:200,children:[e.jsx("div",{className:"logo",style:{visibility:n?"hidden":"visible"},children:"量化交易系统"}),e.jsx(ts,{theme:"light",mode:"inline",selectedKeys:[j.pathname],items:m,onClick:w})]})};var wr=Object.defineProperty,Sr=Object.defineProperties,kr=Object.getOwnPropertyDescriptors,Ws=Object.getOwnPropertySymbols,$r=Object.prototype.hasOwnProperty,Ir=Object.prototype.propertyIsEnumerable,Gs=(n,r,o)=>r in n?wr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o,Zs=(n,r)=>{for(var o in r||(r={}))$r.call(r,o)&&Gs(n,o,r[o]);if(Ws)for(var o of Ws(r))Ir.call(r,o)&&Gs(n,o,r[o]);return n},Cr=(n,r)=>Sr(n,kr(r));const Ht=l.memo(({option:n,loading:r=!1,height:o=400,lazyLoad:j=!0,threshold:m=.1,style:w,onChartReady:D,data:z,symbol:g,className:$,notMerge:T=!1,opts:Q={renderer:"canvas"},onEvents:B})=>{const[ze,Te]=l.useState(!j),[pe,U]=l.useState(null),he=l.useRef(null),b=l.useRef(null),W=l.useMemo(()=>(oe,Oe)=>{const et=[];for(let ie=0,tt=Oe.length;ie<tt;ie++){if(ie<oe-1){et.push("-");continue}let se=0;for(let Pe=0;Pe<oe;Pe++)se+=Oe[ie-Pe].close;et.push((se/oe).toFixed(2))}return et},[]),y=l.useMemo(()=>!z||z.length===0?{}:{backgroundColor:"#fff",title:{text:g,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:z.map(oe=>oe.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:z.map(oe=>oe.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:z.map(oe=>[oe.open,oe.close,oe.low,oe.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:W(5,z),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:W(10,z),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:z.map((oe,Oe)=>[Oe,oe.volume,oe.close>oe.open?1:-1])}]},[z,g,W]),Ve=l.useMemo(()=>{const oe=n||y;return!oe||Object.keys(oe).length===0?{}:Cr(Zs({},oe),{animation:!1,progressive:1e3,progressiveThreshold:3e3,useUTC:!0})},[n,y]);l.useEffect(()=>{if(!j||ze)return;const oe=he.current;if(oe)return b.current=new IntersectionObserver(Oe=>{var et;const[ie]=Oe;ie.isIntersecting&&(Te(!0),(et=b.current)==null||et.disconnect())},{threshold:m}),b.current.observe(oe),()=>{var Oe;(Oe=b.current)==null||Oe.disconnect()}},[j,ze,m]);const $e=oe=>{U(oe),D==null||D(oe)};return j&&!ze?e.jsx("div",{ref:he,style:Zs({height:o,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#fafafa",border:"1px dashed #d9d9d9"},w),children:e.jsxs("div",{style:{textAlign:"center",color:"#999"},children:[e.jsx("div",{children:"图表懒加载中..."}),e.jsx("div",{style:{fontSize:"12px",marginTop:"4px"},children:"滚动到此处将自动加载"})]})}):e.jsx("div",{ref:he,style:w,children:e.jsx(ns,{spinning:r,tip:"图表加载中...",children:e.jsx(ja,{className:$,option:Ve,style:{height:o},onChartReady:$e,notMerge:T,opts:Q,onEvents:B})})})});Ht.displayName="OptimizedChart";const{Title:Dr,Paragraph:zr}=Rt,Mr=l.memo(()=>{const n=l.useMemo(()=>[{name:"上证指数",value:3536.24,change:.84,color:"#f5222d"},{name:"深证成指",value:14672.16,change:1.26,color:"#f5222d"},{name:"创业板指",value:3213.84,change:1.78,color:"#f5222d"},{name:"恒生指数",value:26386.25,change:-.13,color:"#52c41a"}],[]),r=l.useMemo(()=>[{id:1,name:"移动平均交叉策略",symbol:"AAPL",return:12.5,date:"2023-09-15"},{id:2,name:"RSI策略",symbol:"MSFT",return:8.3,date:"2023-09-14"},{id:3,name:"MACD策略",symbol:"GOOGL",return:-2.1,date:"2023-09-13"},{id:4,name:"布林带策略",symbol:"AMZN",return:5.7,date:"2023-09-12"}],[]),o=l.useMemo(()=>({title:{text:"策略绩效比较",left:"center"},tooltip:{trigger:"axis",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{data:["移动平均交叉","RSI策略","MACD策略","布林带策略","沪深300"],bottom:10},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:["1月","2月","3月","4月","5月","6月","7月","8月","9月"]},yAxis:{type:"value",name:"累计收益率(%)",axisLabel:{formatter:"{value}%"}},series:[{name:"移动平均交叉",type:"line",data:[0,2.3,5.8,9.2,12.5,15.1,18.6,22.4,25.2]},{name:"RSI策略",type:"line",data:[0,1.5,3.8,6.2,8.5,10.1,12.6,14.4,16.2]},{name:"MACD策略",type:"line",data:[0,-1.3,1.8,3.2,5.5,8.1,10.6,13.4,15.2]},{name:"布林带策略",type:"line",data:[0,3.3,2.8,5.2,8.5,12.1,15.6,18.4,21.2]},{name:"沪深300",type:"line",data:[0,1.3,2.8,3.2,2.5,4.1,5.6,4.4,6.2],lineStyle:{type:"dashed"}}]}),[]),j=l.useMemo(()=>({title:{text:"最优资产配置",left:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:10,data:["股票","债券","商品","外汇","现金"]},series:[{name:"资产配置",type:"pie",radius:["50%","70%"],avoidLabelOverlap:!1,label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:"18",fontWeight:"bold"}},labelLine:{show:!1},data:[{value:45,name:"股票"},{value:25,name:"债券"},{value:15,name:"商品"},{value:10,name:"外汇"},{value:5,name:"现金"}]}]}),[]);return e.jsxs("div",{children:[e.jsx(Dr,{level:2,children:"仪表盘"}),e.jsx(zr,{children:"欢迎使用量化交易系统，您可以在这里查看市场概况和您的策略表现。"}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:6,children:e.jsx(le,{children:e.jsx(ge,{title:"本月最佳策略",value:"移动平均交叉",prefix:e.jsx(Za,{}),valueStyle:{color:"#3f8600"}})})}),e.jsx(f,{span:6,children:e.jsx(le,{children:e.jsx(ge,{title:"最佳策略收益",value:25.2,precision:2,valueStyle:{color:"#3f8600"},prefix:e.jsx(Ja,{}),suffix:"%"})})}),e.jsx(f,{span:6,children:e.jsx(le,{children:e.jsx(ge,{title:"最差策略收益",value:-2.1,precision:2,valueStyle:{color:"#cf1322"},prefix:e.jsx(Qa,{}),suffix:"%"})})}),e.jsx(f,{span:6,children:e.jsx(le,{children:e.jsx(ge,{title:"策略总数",value:8,prefix:e.jsx(Xa,{})})})})]}),e.jsxs(Z,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(f,{span:12,children:e.jsx(le,{title:"主要市场指数",extra:e.jsx(P,{type:"link",children:"查看更多"}),children:e.jsx(Dt,{dataSource:n,renderItem:m=>e.jsxs(Dt.Item,{children:[e.jsx(Dt.Item.Meta,{title:m.name}),e.jsx("div",{children:m.value}),e.jsxs("div",{style:{color:m.color,marginLeft:"16px"},children:[m.change>0?"+":"",m.change,"%"]})]})})})}),e.jsx(f,{span:12,children:e.jsx(le,{title:"最近的回测",extra:e.jsx(P,{type:"link",children:"查看全部"}),children:e.jsx(Dt,{dataSource:r,renderItem:m=>e.jsxs(Dt.Item,{children:[e.jsx(Dt.Item.Meta,{title:m.name,description:`${m.symbol} | ${m.date}`}),e.jsxs("div",{style:{color:m.return>0?"#3f8600":"#cf1322",fontWeight:"bold"},children:[m.return>0?"+":"",m.return,"%"]})]})})})})]}),e.jsxs(Z,{gutter:16,style:{marginTop:"16px"},children:[e.jsx(f,{span:16,children:e.jsx(le,{title:"策略绩效比较",extra:e.jsx(P,{type:"link",icon:e.jsx(Ft,{}),children:"详细分析"}),children:e.jsx("div",{className:"chart-container",children:e.jsx(Ht,{option:o,style:{height:"100%"}})})})}),e.jsx(f,{span:8,children:e.jsx(le,{title:"最优资产配置",children:e.jsx("div",{className:"chart-container",children:e.jsx(Ht,{option:j,style:{height:"100%"}})})})})]})]})});var Kt=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});const vs=()=>Kt(void 0,null,function*(){try{const n=yield q.get("/api/data/stocks");return n.data&&Array.isArray(n.data)?n.data.map(r=>({id:r.id.toString(),symbol:r.symbol,name:r.name,type:r.type||"未知",exchange:r.exchange,source_id:r.source_id,data_count:r.data_count||0,last_updated:r.last_updated,first_date:r.first_date,last_date:r.last_date})):[]}catch(n){throw console.error("获取交易品种列表失败:",n),n}}),Pa=()=>Kt(void 0,null,function*(){try{const n=yield q.get("/api/data/list");return n.data&&Array.isArray(n.data)?n.data:[]}catch(n){throw console.error("获取数据源列表失败:",n),n}}),Ar=n=>Kt(void 0,null,function*(){try{const r=yield q.get(`/api/data/chart/${n}`);return r.data&&r.data.data?r.data:{data:[]}}catch(r){throw console.error("获取图表数据失败:",r),r}});function Lr(n){return Kt(this,null,function*(){try{console.log("保存策略数据:",JSON.stringify(n,null,2));let r;if(n.id?r=yield q.put(`/api/strategies/${n.id}`,n):r=yield q.post("/api/strategies",n),console.log("策略保存响应:",r.data),r.data&&r.data.status==="success")return r.data.data;if(r.data)return r.data;throw new Error("保存策略失败，返回数据格式错误")}catch(r){throw console.error("保存策略时发生错误:",r),r}})}const cs=()=>Kt(void 0,null,function*(){try{const n=yield q.get("/api/strategies");return n.data&&n.data.data?n.data.data:[]}catch(n){throw console.error("获取策略列表失败:",n),n}}),Js=n=>Kt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略数据")}catch(r){throw console.error(`获取策略(ID:${n})详情失败:`,r),r}}),Fa=n=>Kt(void 0,null,function*(){try{yield q.delete(`/api/strategies/${n}`)}catch(r){throw console.error(`删除策略(ID:${n})失败:`,r),r}}),Pr=n=>Kt(void 0,null,function*(){try{const r=yield q.get(`/api/strategies/templates/${n}`);if(r.data&&r.data.data)return r.data.data;throw new Error("未找到策略模板数据")}catch(r){throw console.error(`获取策略模板(ID:${n})详情失败:`,r),r}}),Fr=n=>Kt(void 0,null,function*(){try{const r=yield q.get(`/api/data/stock/${n}/date-range`);if(r.data)return r.data;throw new Error("未找到股票日期范围数据")}catch(r){throw console.error(`获取股票(ID:${n})日期范围失败:`,r),r}}),Qs=(n,r,o=30)=>{const j=new Date;j.setTime(j.getTime()+o*24*60*60*1e3),document.cookie=`${n}=${r};expires=${j.toUTCString()};path=/`},Xs=n=>{const r=n+"=",o=document.cookie.split(";");for(let j=0;j<o.length;j++){let m=o[j];for(;m.charAt(0)===" ";)m=m.substring(1,m.length);if(m.indexOf(r)===0)return m.substring(r.length,m.length)}return null},it={setPageSize:n=>{Qs("data_management_page_size",n.toString())},getPageSize:(n=15)=>{const r=Xs("data_management_page_size");return r?parseInt(r,10):n},setCurrentPage:n=>{Qs("data_management_current_page",n.toString())},getCurrentPage:(n=1)=>{const r=Xs("data_management_current_page");return r?parseInt(r,10):n}};function Nr(n,r){const[o,j]=l.useState(n);return l.useEffect(()=>{const m=setTimeout(()=>{j(n)},r);return()=>{clearTimeout(m)}},[n,r]),o}var Tr=Object.defineProperty,Or=Object.defineProperties,Yr=Object.getOwnPropertyDescriptors,js=Object.getOwnPropertySymbols,Na=Object.prototype.hasOwnProperty,Ta=Object.prototype.propertyIsEnumerable,ea=(n,r,o)=>r in n?Tr(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o,ms=(n,r)=>{for(var o in r||(r={}))Na.call(r,o)&&ea(n,o,r[o]);if(js)for(var o of js(r))Ta.call(r,o)&&ea(n,o,r[o]);return n},ta=(n,r)=>Or(n,Yr(r)),Rr=(n,r)=>{var o={};for(var j in n)Na.call(n,j)&&r.indexOf(j)<0&&(o[j]=n[j]);if(n!=null&&js)for(var j of js(n))r.indexOf(j)<0&&Ta.call(n,j)&&(o[j]=n[j]);return o};const Jt=l.memo(n=>{var r=n,{virtualScroll:o=!1,itemHeight:j=54,maxHeight:m=400,dataSource:w=[],columns:D=[]}=r,z=Rr(r,["virtualScroll","itemHeight","maxHeight","dataSource","columns"]);const g=l.useMemo(()=>D.map(Q=>ta(ms({},Q),{ellipsis:Q.ellipsis!==!1})),[D]),$=l.useMemo(()=>w||[],[w]),T=l.useMemo(()=>ms({size:"middle",scroll:{x:"max-content",y:m},pagination:ms({showSizeChanger:!0,showQuickJumper:!0,showTotal:(Q,B)=>`第 ${B[0]}-${B[1]} 条，共 ${Q} 条`},z.pagination)},z),[m,z]);return e.jsx("div",{className:"optimized-table-container",children:e.jsx(ss,ta(ms({},T),{columns:g,dataSource:$,className:`optimized-table ${z.className||""}`}))})});Jt.displayName="OptimizedTable";var Er=Object.defineProperty,Br=Object.defineProperties,qr=Object.getOwnPropertyDescriptors,sa=Object.getOwnPropertySymbols,Vr=Object.prototype.hasOwnProperty,Hr=Object.prototype.propertyIsEnumerable,aa=(n,r,o)=>r in n?Er(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o,ra=(n,r)=>{for(var o in r||(r={}))Vr.call(r,o)&&aa(n,o,r[o]);if(sa)for(var o of sa(r))Hr.call(r,o)&&aa(n,o,r[o]);return n},na=(n,r)=>Br(n,qr(r)),$t=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});const{Title:Kr,Text:Ur}=Rt,{Option:jt}=Ye,Oa=l.memo(({onSelect:n})=>{const r=l.useMemo(()=>[{label:"最近7天",days:7},{label:"最近30天",days:30},{label:"最近90天",days:90},{label:"最近180天",days:180},{label:"最近1年",days:365},{label:"最近2年",days:730},{label:"最近3年",days:1095},{label:"最近4年",days:1460},{label:"最近5年",days:1825},{label:"最近10年",days:3650},{label:"今年",type:"year"},{label:"去年",type:"lastYear"},{label:"本月",type:"month"},{label:"上月",type:"lastMonth"}],[]),o=l.useCallback(j=>{const m=I();let w,D;j.type==="year"?(w=m.startOf("year").format("YYYY-MM-DD"),D=m.format("YYYY-MM-DD")):j.type==="lastYear"?(w=m.subtract(1,"year").startOf("year").format("YYYY-MM-DD"),D=m.subtract(1,"year").endOf("year").format("YYYY-MM-DD")):j.type==="month"?(w=m.startOf("month").format("YYYY-MM-DD"),D=m.format("YYYY-MM-DD")):j.type==="lastMonth"?(w=m.subtract(1,"month").startOf("month").format("YYYY-MM-DD"),D=m.subtract(1,"month").endOf("month").format("YYYY-MM-DD")):(w=m.subtract(j.days,"day").format("YYYY-MM-DD"),D=m.format("YYYY-MM-DD")),n(w,D)},[n]);return e.jsx(De,{wrap:!0,children:r.map((j,m)=>e.jsx(P,{size:"small",onClick:()=>o(j),children:j.label},m))})});Oa.displayName="DateRangePresets";const la=(n,r)=>{const o=[];for(let j=0,m=r.length;j<m;j++){if(j<n-1){o.push("-");continue}let w=0;for(let D=0;D<n;D++)w+=r[j-D].close;o.push((w/n).toFixed(2))}return o},Ya=l.memo(()=>{const[n,r]=l.useState([]),[o,j]=l.useState([]),[m,w]=l.useState(!1),[D,z]=l.useState(!1),[g,$]=l.useState([]),[T]=F.useForm(),[Q,B]=l.useState("fetch"),[ze,Te]=l.useState(!1),[pe,U]=l.useState(!1),he=l.useRef(!1),[b,W]=l.useState({current:it.getCurrentPage(),pageSize:it.getPageSize(),total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(k,x)=>`第 ${x[0]}-${x[1]} 条，共 ${k} 条`,pageSizeOptions:["10","15","20","50","100"]}),[y,Ve]=l.useState(!1),[$e,oe]=l.useState(null),[Oe,et]=l.useState([]),[ie,tt]=l.useState(!1),[se,Pe]=l.useState("");Nr(se,300);const ye=l.useCallback((...k)=>$t(void 0,[...k],function*(x=it.getCurrentPage(),_=it.getPageSize()){w(!0);try{const ne=(yield vs()).map(G=>{var Fe;return{id:G.id.toString(),symbol:G.symbol,name:G.name,type:G.type||"未知",exchange:G.exchange,records:G.data_count||0,source:((Fe=G.source_id)==null?void 0:Fe.toString())||"未知",last_updated:G.last_updated?new Date(G.last_updated).toLocaleString():"未知",first_date:G.first_date||void 0,last_date:G.last_date||void 0}});W(G=>na(ra({},G),{current:x,pageSize:_,total:ne.length})),r(ne)}catch(V){console.error("获取数据列表失败:",V),d.error("获取数据列表失败，请检查网络连接")}finally{w(!1)}}),[]),rt=l.useCallback(()=>$t(void 0,null,function*(){try{const k=yield Pa();if(j(k),Q==="fetch"){const x=k.find(_=>_.name==="AkShare抓取");x&&T.setFieldsValue({source_id:x.id})}else if(Q==="upload"){const x=k.find(_=>_.name==="用户上传");x&&T.setFieldsValue({source_id:x.id})}}catch(k){console.error("获取数据源列表失败:",k),d.error("获取数据源列表失败")}}),[Q,T]),zt=l.useCallback(k=>{const{current:x,pageSize:_}=k;it.setCurrentPage(x),it.setPageSize(_),ye(x,_)},[ye]),ct=l.useCallback(k=>$t(void 0,null,function*(){w(!0);try{const x=yield q.get(`/api/data/download/${k}`,{responseType:"blob"}),_=window.URL.createObjectURL(new Blob([x.data])),V=document.createElement("a");V.href=_;const ne=x.headers["content-disposition"];let G="stock_data.csv";if(ne){const Fe=ne.match(/filename="?(.+)"?/);Fe&&Fe.length===2&&(G=Fe[1])}V.setAttribute("download",G),document.body.appendChild(V),V.click(),document.body.removeChild(V),d.success("数据下载成功")}catch(x){console.error("下载失败:",x),d.error("下载失败，请重试")}finally{w(!1)}}),[]),[qe,We]=l.useState([]),Ae=l.useCallback((k,x)=>$t(void 0,null,function*(){var _,V,ne;We(G=>G.includes(k)?G:[...G,k]);try{const Fe=(_=(yield q.post(`/api/data/update/${k}/async`)).data)==null?void 0:_.task_id;if(!Fe){d.error("任务提交失败：未返回任务ID"),We(Ge=>Ge.filter(nt=>nt!==k));return}d.success(x?`${x}：更新任务已启动`:"更新任务已启动");const at=()=>$t(void 0,null,function*(){var Ge,nt;try{const Ne=yield q.get(`/api/data/update-tasks/${Fe}`),t=(Ge=Ne.data)==null?void 0:Ge.status,a=(nt=Ne.data)==null?void 0:nt.message;t==="completed"?(d.success(a||(x?`${x} 更新完成`:"更新完成")),clearInterval(Re),yield ye(b.current,b.pageSize),We(u=>u.filter(p=>p!==k))):t==="failed"&&(d.error(a||(x?`${x} 更新失败`:"更新失败")),clearInterval(Re),We(u=>u.filter(p=>p!==k)))}catch(Ne){console.error("查询任务状态失败:",Ne)}}),Re=window.setInterval(at,2e3)}catch(G){console.error("提交异步更新失败:",G);const Fe=(ne=(V=G.response)==null?void 0:V.data)==null?void 0:ne.detail;d.error(Fe||"提交异步更新失败"),We(at=>at.filter(Re=>Re!==k))}}),[ye,b.current,b.pageSize]),bt=l.useMemo(()=>[{title:"代码",dataIndex:"symbol",key:"symbol",width:100},{title:"名称",dataIndex:"name",key:"name",width:120},{title:"类型",dataIndex:"type",key:"type",width:80,render:k=>e.jsx(Le,{color:"blue",children:k})},{title:"交易所",dataIndex:"exchange",key:"exchange",width:80},{title:"记录数",dataIndex:"records",key:"records",width:80,sorter:(k,x)=>k.records-x.records},{title:"数据时间范围",key:"date_range",width:200,render:(k,x)=>x.first_date&&x.last_date?e.jsx("div",{children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:[x.first_date," 至 ",x.last_date]})}):e.jsx("span",{style:{color:"#999"},children:"暂无数据"})},{title:"数据源",dataIndex:"source",key:"source",width:100},{title:"最后更新",dataIndex:"last_updated",key:"last_updated",width:150},{title:"操作",key:"action",width:360,render:(k,x)=>e.jsxs(De,{size:"small",children:[e.jsx(P,{type:"primary",icon:e.jsx(wa,{}),size:"small",onClick:()=>ct(x.id),children:"下载"}),e.jsx(P,{icon:e.jsx(Ft,{}),size:"small",onClick:()=>ft(x),children:"K线图"}),e.jsx(P,{icon:e.jsx(as,{}),size:"small",loading:qe.includes(x.id),disabled:qe.includes(x.id),onClick:()=>Ae(x.id,x.symbol),children:"更新"}),e.jsx(P,{danger:!0,icon:e.jsx(us,{}),size:"small",onClick:()=>pt(x.id),children:"删除"})]})}],[Ae,qe]),vt={onRemove:()=>{$([])},beforeUpload:k=>(He(k)&&$([k]),!1),fileList:g},pt=l.useCallback(k=>$t(void 0,null,function*(){Be.confirm({title:"确认删除",content:"此操作将永久删除该数据，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>$t(void 0,null,function*(){var x;w(!0);try{const _=yield q.delete(`/api/data/delete/${k}`);_.data&&_.data.status==="success"?(d.success(_.data.message||"删除成功"),ye()):d.error(((x=_.data)==null?void 0:x.message)||"删除失败")}catch(_){console.error("删除失败:",_),d.error("删除失败，请重试")}finally{w(!1)}})})}),[ye]),ft=l.useCallback(k=>$t(void 0,null,function*(){oe(k),Ve(!0),tt(!0);try{const x=yield Ar(k.id);console.log("API响应数据:",x);const _=x.data||x||[];console.log("处理后的数据:",_),et(_)}catch(x){console.error("获取图表数据失败:",x),d.error("获取图表数据失败")}finally{tt(!1)}}),[]),He=k=>{const x=k.type==="text/csv"||k.name&&k.name.endsWith(".csv");return x||d.error("只能上传CSV文件!"),x},yt=k=>$t(void 0,null,function*(){var x,_,V,ne;if(g.length===0){d.error("请选择要上传的文件");return}const G=new FormData;G.append("file",g[0]);const Fe=new URLSearchParams({symbol:k.symbol,name:k.name,type:k.type,source_id:((x=k.source_id)==null?void 0:x.toString())||""});k.exchange&&Fe.append("exchange",k.exchange);const at=`/api/data/upload?${Fe.toString()}`;w(!0);try{const Re=yield q.post(at,G,{headers:{"Content-Type":"multipart/form-data"}});Re.data&&Re.data.status==="success"?(d.success(Re.data.message||"上传成功"),z(!1),T.resetFields(),$([]),ye(b.current,b.pageSize)):d.error(((_=Re.data)==null?void 0:_.message)||"上传失败")}catch(Re){console.error("上传失败:",Re);const Ge=(ne=(V=Re.response)==null?void 0:V.data)==null?void 0:ne.detail;Ge?typeof Ge=="object"?d.error(JSON.stringify(Ge)):d.error(Ge):d.error("上传失败，请重试")}finally{w(!1)}}),st=k=>$t(void 0,null,function*(){var x,_,V;Te(!0);try{const ne={symbol:k.symbol,name:k.name,type:k.type,source_id:k.source_id,start_date:k.start_date?k.start_date.format("YYYY-MM-DD"):void 0,end_date:k.end_date?k.end_date.format("YYYY-MM-DD"):void 0},G=yield q.post("/api/data/fetch",ne,{headers:{"Content-Type":"application/json"}});G.data&&G.data.status==="success"?(d.success(G.data.message||"数据抓取成功"),z(!1),T.resetFields(),ye(b.current,b.pageSize)):d.error(((x=G.data)==null?void 0:x.message)||"数据抓取失败")}catch(ne){console.error("数据抓取失败:",ne);const G=(V=(_=ne.response)==null?void 0:_.data)==null?void 0:V.detail;G?typeof G=="object"?d.error(JSON.stringify(G)):d.error(G):d.error("数据抓取失败，请重试")}finally{Te(!1)}}),Ke=l.useCallback(()=>{Be.confirm({title:"一键更新确认",content:"确定要更新所有股票的最新数据吗？此操作可能需要较长时间。",okText:"确定更新",cancelText:"取消",onOk:()=>$t(void 0,null,function*(){var k,x,_;U(!0);try{const ne=(k=(yield q.post("/api/data/update-all/async")).data)==null?void 0:k.task_id;if(!ne){d.error("任务提交失败：未返回任务ID"),U(!1);return}d.success("一键更新任务已启动");const G=()=>$t(void 0,null,function*(){var at,Re,Ge,nt;try{const Ne=yield q.get(`/api/data/update-all-tasks/${ne}`),t=(at=Ne.data)==null?void 0:at.status,a=(Re=Ne.data)==null?void 0:Re.message,u=(Ge=Ne.data)==null?void 0:Ge.processed,p=(nt=Ne.data)==null?void 0:nt.total;typeof u=="number"&&typeof p=="number"&&d.info(`一键更新进度：${u}/${p}`,1),t==="completed"?(clearInterval(Fe),U(!1),d.success(a||"一键更新完成"),yield ye(b.current,b.pageSize)):t==="failed"&&(clearInterval(Fe),U(!1),d.error(a||"一键更新失败"))}catch(Ne){console.error("查询一键更新任务状态失败:",Ne)}}),Fe=window.setInterval(G,2e3)}catch(V){console.error("一键更新任务提交失败:",V);const ne=(_=(x=V.response)==null?void 0:x.data)==null?void 0:_.detail;d.error(ne||"一键更新任务提交失败"),U(!1)}})})},[ye]);return l.useEffect(()=>{he.current||(he.current=!0,ye(),rt())},[ye,rt]),e.jsxs("div",{className:"data-management",children:[e.jsxs(le,{children:[e.jsxs(Z,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[e.jsx(f,{children:e.jsx(Kr,{level:4,children:"市场数据管理"})}),e.jsx(f,{children:e.jsxs(De,{children:[e.jsx(P,{type:"primary",icon:e.jsx(Hs,{}),onClick:()=>z(!0),children:"添加数据"}),e.jsx(P,{type:"primary",icon:e.jsx(as,{}),loading:pe,onClick:Ke,style:{backgroundColor:"#52c41a",borderColor:"#52c41a"},children:"一键更新"}),e.jsx(P,{icon:e.jsx(as,{}),onClick:()=>ye(b.current,b.pageSize),children:"刷新列表"})]})})]}),e.jsx(ns,{spinning:m,children:e.jsx(Jt,{columns:bt,dataSource:n,rowKey:"id",bordered:!0,size:"middle",pagination:b,onChange:zt})})]}),e.jsxs(Be,{title:"市场数据管理",open:D,onCancel:()=>z(!1),footer:null,width:600,children:[e.jsx("div",{style:{marginBottom:20,textAlign:"center"},children:e.jsxs(ks.Group,{value:Q,onChange:k=>{if(B(k.target.value),T.resetFields(),k.target.value==="fetch"){const x=o.find(_=>_.name==="AkShare抓取");x&&T.setFieldsValue({source_id:x.id})}else if(k.target.value==="upload"){const x=o.find(_=>_.name==="用户上传");x&&T.setFieldsValue({source_id:x.id})}},buttonStyle:"solid",children:[e.jsx(ks.Button,{value:"fetch",children:"自动抓取"}),e.jsx(ks.Button,{value:"upload",children:"手动上传"})]})}),e.jsxs(F,{form:T,layout:"vertical",onFinish:Q==="fetch"?st:yt,children:[Q==="fetch"&&e.jsxs(e.Fragment,{children:[e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(ke,{placeholder:"例如: AAPL, 600519, TSLA"})}),e.jsx(F.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(ke,{placeholder:"例如: 苹果公司, 贵州茅台"})}),e.jsx(F.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Ye,{placeholder:"选择类型",children:[e.jsx(jt,{value:"A股",children:"A股"}),e.jsx(jt,{value:"港股",children:"港股"}),e.jsx(jt,{value:"美股",children:"美股"}),e.jsx(jt,{value:"期货",children:"期货"}),e.jsx(jt,{value:"指数",children:"指数"}),e.jsx(jt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(F.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Ye,{placeholder:"选择数据源",disabled:!0,children:o.filter(k=>k.name==="AkShare抓取").map(k=>e.jsx(jt,{value:k.id,children:k.name},k.id))})}),e.jsxs(F.Item,{label:"日期范围",children:[e.jsx(Oa,{onSelect:(k,x)=>{T.setFieldsValue({start_date:I(k),end_date:I(x)})}}),e.jsxs(Z,{gutter:8,children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"start_date",noStyle:!0,children:e.jsx(Zt,{placeholder:"选择开始日期",style:{width:"100%"},format:"YYYY-MM-DD"})})}),e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"end_date",noStyle:!0,children:e.jsx(Zt,{placeholder:"选择结束日期",style:{width:"100%"},format:"YYYY-MM-DD"})})})]})]}),e.jsx(F.Item,{children:e.jsxs(De,{children:[e.jsx(P,{type:"primary",htmlType:"submit",loading:ze,icon:e.jsx(as,{}),children:"开始抓取"}),e.jsx(P,{onClick:()=>z(!1),children:"取消"})]})})]}),Q==="upload"&&e.jsxs(e.Fragment,{children:[e.jsx(F.Item,{name:"file",label:"数据文件",rules:[{required:!0,message:"请选择要上传的CSV文件"}],children:e.jsxs(er,na(ra({},vt),{children:[e.jsx(P,{icon:e.jsx(Hs,{}),children:"选择CSV文件"}),e.jsx(Ur,{type:"secondary",style:{marginLeft:8},children:"仅支持CSV格式的数据文件"})]}))}),e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(ke,{placeholder:"例如: AAPL, 600000.SH"})}),e.jsx(F.Item,{name:"name",label:"股票名称",rules:[{required:!0,message:"请输入股票名称"}],children:e.jsx(ke,{placeholder:"例如: 苹果公司, 浦发银行"})}),e.jsx(F.Item,{name:"type",label:"类型",rules:[{required:!0,message:"请选择类型"}],children:e.jsxs(Ye,{placeholder:"选择类型",children:[e.jsx(jt,{value:"A股",children:"A股"}),e.jsx(jt,{value:"港股",children:"港股"}),e.jsx(jt,{value:"美股",children:"美股"}),e.jsx(jt,{value:"期货",children:"期货"}),e.jsx(jt,{value:"指数",children:"指数"}),e.jsx(jt,{value:"加密货币",children:"加密货币"})]})}),e.jsx(F.Item,{name:"exchange",label:"交易所",children:e.jsx(ke,{placeholder:"例如: NYSE, SSE"})}),e.jsx(F.Item,{name:"source_id",label:"数据源",rules:[{required:!0,message:"请选择数据源"}],children:e.jsx(Ye,{placeholder:"选择数据源",disabled:!0,children:o.filter(k=>k.name==="用户上传").map(k=>e.jsx(jt,{value:k.id,children:k.name},k.id))})}),e.jsx(F.Item,{children:e.jsxs(De,{children:[e.jsx(P,{type:"primary",htmlType:"submit",loading:m,children:"上传数据"}),e.jsx(P,{onClick:()=>z(!1),children:"取消"})]})})]})]})]}),e.jsx(Be,{title:$e?`${$e.name}(${$e.symbol}) K线图`:"K线图",open:y,onCancel:()=>Ve(!1),footer:null,width:800,children:e.jsx(ns,{spinning:ie,children:Oe.length>0?e.jsx("div",{style:{height:"500px",width:"100%"},children:e.jsx(ja,{option:{backgroundColor:"#fff",title:{text:$e==null?void 0:$e.symbol,left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold"},subtextStyle:{color:"#888"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.8)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"}},legend:{data:["K线","MA5","MA10"],top:35,selected:{K线:!0,MA5:!0,MA10:!0}},toolbox:{feature:{dataZoom:{yAxisIndex:[0,1]},brush:{type:["lineX","clear"]},restore:{},saveAsImage:{}}},brush:{xAxisIndex:"all",brushLink:"all",outOfBrush:{colorAlpha:.1}},grid:[{left:"10%",right:"10%",top:80,height:"60%"},{left:"10%",right:"10%",top:"75%",height:"15%"}],xAxis:[{type:"category",data:Oe.map(k=>k.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax",axisPointer:{z:100}},{type:"category",gridIndex:1,data:Oe.map(k=>k.time),scale:!0,boundaryGap:!1,axisLine:{onZero:!1},axisTick:{show:!1},splitLine:{show:!1},axisLabel:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"}],yAxis:[{scale:!0,splitArea:{show:!0},splitLine:{show:!0}},{scale:!0,gridIndex:1,splitNumber:2,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1}}],dataZoom:[{type:"inside",xAxisIndex:[0,1],start:50,end:100},{show:!0,xAxisIndex:[0,1],type:"slider",bottom:10,start:50,end:100}],visualMap:{show:!1,seriesIndex:3,dimension:2,pieces:[{value:1,color:"#ef232a"},{value:-1,color:"#14b143"}]},series:[{name:"K线",type:"candlestick",data:Oe.map(k=>[k.open,k.close,k.low,k.high]),itemStyle:{color:"#ef232a",color0:"#14b143",borderColor:"#ef232a",borderColor0:"#14b143"}},{name:"MA5",type:"line",data:la(5,Oe),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"MA10",type:"line",data:la(10,Oe),smooth:!0,lineStyle:{width:1,opacity:.7}},{name:"成交量",type:"bar",xAxisIndex:1,yAxisIndex:1,data:Oe.map((k,x)=>[x,k.volume,k.close>k.open?1:-1])}]},style:{height:"100%",width:"100%"},opts:{renderer:"canvas"}})}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx("p",{children:"暂无数据可供显示"})})})})]})});Ya.displayName="DataManagement";var Tt=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});const{Title:Wr,Paragraph:Gr}=Rt,{confirm:Zr}=Be,Jr=()=>{const n=ya();Qt();const[r,o]=l.useState("visual"),[j,m]=l.useState(`# 策略示例：移动平均线交叉策略
import pandas as pd
import numpy as np
import talib

def initialize(context):
    """初始化策略参数"""
    context.params = {
        'symbol': '000300.SH',
        'short_period': 20,
        'long_period': 60
    }

def handle_data(context, data):
    """处理每个交易日的数据"""
    params = context.params
    df = data[params['symbol']]
    
    # 计算移动平均线
    df['short_ma'] = talib.SMA(df['close'], timeperiod=params['short_period'])
    df['long_ma'] = talib.SMA(df['close'], timeperiod=params['long_period'])
    
    # 生成交易信号
    df['signal'] = 0
    # 短均线上穿长均线，买入信号
    df.loc[(df['short_ma'] > df['long_ma']) & (df['short_ma'].shift(1) <= df['long_ma'].shift(1)), 'signal'] = 1
    # 短均线下穿长均线，卖出信号
    df.loc[(df['short_ma'] < df['long_ma']) & (df['short_ma'].shift(1) >= df['long_ma'].shift(1)), 'signal'] = -1
    
    return df['signal']
`),[w]=F.useForm(),[D,z]=l.useState([]),[g,$]=l.useState(!1),[T,Q]=l.useState(null);l.useState(!1);const[B,ze]=l.useState([]),[Te,pe]=l.useState(!1),[U,he]=l.useState(""),[b,W]=l.useState([]),[y,Ve]=l.useState(!1),[$e,oe]=l.useState([{label:"移动平均线交叉策略",value:"ma_cross"},{label:"布林带策略",value:"bbands"},{label:"RSI策略",value:"rsi"},{label:"MACD策略",value:"macd"},{label:"趋势跟踪策略",value:"trend_following"},{label:"双均线策略",value:"dual_ma"}]),[Oe,et]=l.useState({}),[ie,tt]=l.useState(!1),[se,Pe]=l.useState(!1),ye=()=>new URLSearchParams(n.search).get("id"),[rt,zt]=l.useState(!1);l.useEffect(()=>{(()=>Tt(void 0,null,function*(){if(rt){const _=ye();_&&(!T||T.id!==_)&&(yield qe(_));return}zt(!0);try{yield Promise.all([We(),vt()]),yield ct()}catch(_){console.error("初始化数据加载失败:",_),d.error("数据加载失败，请刷新页面重试")}}))()},[n.search,rt]);const ct=()=>Tt(void 0,null,function*(){if(!Te){pe(!0);try{const _=(yield cs()).filter(ne=>!ne.is_template);ze(_),console.log("加载到策略列表:",_.length,"个策略");const V=ye();V?(!T||T.id!==V)&&(yield qe(V)):_.length>0&&!T&&(yield Ae(_[0]))}catch(x){console.error("获取策略列表失败:",x),d.error("获取策略列表失败")}finally{pe(!1)}}}),qe=x=>Tt(void 0,null,function*(){const _={strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"};if(x)try{$(!0);const V=yield Js(x);Q(V),V.code&&(o("code"),m(V.code));const ne={strategyName:V.name,description:V.description,template:V.template||"ma_cross"};V.parameters&&(console.log("加载策略参数:",V.parameters),Object.assign(ne,V.parameters)),console.log("设置表单值:",ne),w.setFieldsValue(ne)}catch(V){console.error("加载策略详情失败:",V),d.error("加载策略详情失败"),w.setFieldsValue(_)}finally{$(!1)}else w.setFieldsValue(_)}),We=()=>Tt(void 0,null,function*(){if(D.length>0)return D;$(!0);try{const x=yield vs();return z(x),x}catch(x){console.error("获取股票列表失败:",x)}finally{$(!1)}return[]}),Ae=x=>Tt(void 0,null,function*(){if(x.id)try{$(!0);const _=yield Js(x.id);Q(_),_.code?(o("code"),m(_.code)):o("visual");const V={strategyName:_.name,description:_.description,template:_.template||"ma_cross"};_.parameters&&(console.log("加载策略参数:",_.parameters),Object.assign(V,_.parameters)),console.log("设置表单值:",V),w.setFieldsValue(V),window.history.replaceState(null,"",`?id=${x.id}`)}catch(_){console.error("加载策略详情失败:",_),d.error("加载策略详情失败")}finally{$(!1)}}),bt=x=>{Zr({title:"确定要删除这个策略吗?",icon:e.jsx(rr,{}),content:"此操作不可撤销，删除后数据将无法恢复。",okText:"是的，删除",okType:"danger",cancelText:"取消",onOk(){return Tt(this,null,function*(){try{yield Fa(x.id),d.success("策略删除成功"),T&&T.id===x.id&&(Q(null),w.resetFields(),w.setFieldsValue({strategyName:"新策略",description:"请输入策略描述",template:"ma_cross",symbol:"000300.SH",timeframe:"D",shortPeriod:20,longPeriod:60,positionSizing:"all_in"}),window.history.replaceState(null,"",window.location.pathname)),Te||Tt(this,null,function*(){const ne=(yield cs()).filter(G=>!G.is_template);ze(ne)})}catch(_){console.error("删除策略失败:",_),d.error("删除策略失败")}})}})};B.filter(x=>{var _,V;return((_=x.name)==null?void 0:_.toLowerCase().includes(U.toLowerCase()))||((V=x.description)==null?void 0:V.toLowerCase().includes(U.toLowerCase()))});const vt=()=>Tt(void 0,null,function*(){if($e.length>0&&$e[0].value!=="ma_cross")return $e;try{const _=(yield cs()).filter(V=>V.is_template).map(V=>({label:V.name,value:V.id}));if(_.length>0)return oe(_),_}catch(x){console.error("获取策略模板失败:",x)}return $e}),pt=x=>Tt(void 0,null,function*(){try{const _=yield Pr(x);_&&(w.setFieldsValue({name:`自定义${_.name}`,description:_.description,code:_.code}),_.parameters&&et(_.parameters),d.success("模板加载成功"))}catch{d.error("加载模板失败")}}),ft=x=>{pt(x)},He={name:"",description:"",code:""},yt=x=>{tt(!0),Lr(x).then(_=>Tt(void 0,null,function*(){if(d.success("策略保存成功"),_&&(Q(_),window.history.replaceState(null,"",`?id=${_.id}`),!Te)){const ne=(yield cs()).filter(G=>!G.is_template);ze(ne)}})).catch(_=>{d.error("保存策略失败: "+_.message)}).finally(()=>{tt(!1)})},st=()=>{Pe(!0),setTimeout(()=>{d.success("策略测试成功"),Pe(!1)},1500)},Ke=x=>{w.resetFields(),d.success("已重置为"+x+"模板")},k=()=>[{key:"mine",label:"我的策略",children:e.jsx(Dt,{itemLayout:"horizontal",dataSource:B,loading:Te,renderItem:x=>e.jsx(Dt.Item,{className:"strategy-list-item",actions:[e.jsx(P,{type:"link",size:"small",onClick:()=>Ae(x),children:"编辑"},"edit"),e.jsx(P,{type:"link",danger:!0,size:"small",onClick:()=>bt(x),children:"删除"},"delete")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:x.name}),e.jsx("div",{className:"strategy-desc",children:x.description})]})})})},{key:"templates",label:"策略模板",children:e.jsx(Dt,{itemLayout:"horizontal",dataSource:b,loading:y,renderItem:x=>e.jsx(Dt.Item,{className:"strategy-list-item",actions:[e.jsx(P,{type:"link",size:"small",onClick:()=>ft(x.id),children:"使用"},"use")],children:e.jsxs("div",{className:"strategy-list-content",children:[e.jsx("div",{className:"strategy-name",children:x.name}),e.jsx("div",{className:"strategy-desc",children:x.description})]})})})}];return e.jsxs("div",{className:"strategy-builder",children:[e.jsxs("div",{className:"page-header",style:{marginBottom:"20px"},children:[e.jsx(Wr,{level:2,children:"策略构建器"}),e.jsx(Gr,{children:"创建和测试您的交易策略"})]}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:18,children:e.jsx(le,{title:"策略编辑器",bordered:!1,className:"editor-card",children:e.jsxs(F,{form:w,layout:"vertical",initialValues:He,onFinish:yt,children:[e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"name",label:"策略名称",rules:[{required:!0,message:"请输入策略名称"},{max:50,message:"策略名称不能超过50个字符"}],children:e.jsx(ke,{placeholder:"请输入策略名称"})})}),e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"description",label:"策略描述",rules:[{max:200,message:"策略描述不能超过200个字符"}],children:e.jsx(ke.TextArea,{placeholder:"请输入策略描述",autoSize:{minRows:1,maxRows:3}})})})]}),e.jsx(F.Item,{name:"code",label:"策略代码",rules:[{required:!0,message:"请输入策略代码"}],children:e.jsx(Ea,{height:"450px",extensions:[tr()],onChange:x=>w.setFieldsValue({code:x})})}),e.jsx(F.Item,{children:e.jsxs(De,{children:[e.jsx(P,{type:"primary",htmlType:"submit",loading:ie,children:"保存策略"}),e.jsx(P,{type:"default",onClick:st,loading:se,children:"测试策略"}),e.jsx(sr,{overlay:e.jsxs(ts,{children:[e.jsx(ts.Item,{onClick:()=>Ke("basic"),children:"基础策略模板"},"basic"),e.jsx(ts.Item,{onClick:()=>Ke("technical"),children:"技术指标策略"},"technical"),e.jsx(ts.Item,{onClick:()=>Ke("empty"),children:"空白策略"},"empty")]}),children:e.jsxs(P,{children:["重置模板 ",e.jsx(ar,{})]})})]})})]})})}),e.jsx(f,{span:6,children:e.jsx(le,{title:"策略库",bordered:!1,className:"strategy-library-card",style:{marginBottom:"16px",height:"300px"},children:e.jsx(ps,{defaultActiveKey:"mine",items:k()})})})]})]})};var Et=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});const Bt="http://localhost:8001/api",Qr=n=>Et(void 0,null,function*(){var r;try{const o={};n&&(o.name=n);const j=yield q.get(`${Bt}/strategies`,{params:o});if(j.data&&j.data.status==="success")return j.data.data||[];throw new Error(((r=j.data)==null?void 0:r.message)||"获取策略列表失败")}catch(o){return d.error(`获取策略列表错误: ${o.message}`),[]}}),Xr=n=>Et(void 0,null,function*(){var r;try{const o=yield q.get(`${Bt}/strategies/${n}`);if(o.data&&o.data.status==="success")return o.data.data;throw new Error(((r=o.data)==null?void 0:r.message)||"获取策略详情失败")}catch(o){return d.error(`获取策略详情错误: ${o.message}`),null}}),en=n=>Et(void 0,null,function*(){var r;try{const o=yield q.post(`${Bt}/strategies`,n);if(o.data&&o.data.status==="success")return d.success("策略创建成功"),o.data.data;throw new Error(((r=o.data)==null?void 0:r.message)||"创建策略失败")}catch(o){return d.error(`创建策略错误: ${o.message}`),null}}),tn=(n,r)=>Et(void 0,null,function*(){var o;try{const j=yield q.put(`${Bt}/strategies/${n}`,r);if(j.data&&j.data.status==="success")return d.success("策略更新成功"),j.data.data;throw new Error(((o=j.data)==null?void 0:o.message)||"更新策略失败")}catch(j){return d.error(`更新策略错误: ${j.message}`),null}}),sn=(n,r,o)=>Et(void 0,null,function*(){var j;try{const m={code:n,data:r||[],parameters:o||{}},w=yield q.post(`${Bt}/strategies/test`,m);if(w.data&&w.data.status==="success")return w.data.data;throw new Error(((j=w.data)==null?void 0:j.message)||"测试策略失败")}catch(m){return d.error(`测试策略错误: ${m.message}`),{error:m.message}}}),oa=(n,r,o,j,...m)=>Et(void 0,[n,r,o,j,...m],function*(w,D,z,g,$=1e5,T={},Q=.0015,B=.001,ze="database",Te=[]){var pe;try{const U={strategy_id:w,symbol:D,start_date:z,end_date:g,initial_capital:$,parameters:T,commission_rate:Q,slippage_rate:B,data_source:ze,features:Te},he=yield q.post(`${Bt}/strategies/backtest`,U);if(he.data&&he.data.status==="success")return he.data.data;throw new Error(((pe=he.data)==null?void 0:pe.message)||"策略回测失败")}catch(U){return d.error(`策略回测错误: ${U.message}`),{error:U.message}}}),an=(n,r,o,j,...m)=>Et(void 0,[n,r,o,j,...m],function*(w,D,z,g,$=1e5,T={},Q=.0015,B=.001,ze="database",Te=[]){var pe;try{const U={strategy_id:w,symbol:D,start_date:z,end_date:g,initial_capital:$,parameters:T,commission_rate:Q,slippage_rate:B,data_source:ze,features:Te,force_refresh:!0},he=yield q.post(`${Bt}/strategies/backtest`,U);if(he.data&&he.data.status==="success")return he.data.data;throw new Error(((pe=he.data)==null?void 0:pe.message)||"策略回测失败")}catch(U){return d.error(`策略回测错误: ${U.message}`),{error:U.message}}}),rn=(n,r,o,j,...m)=>Et(void 0,[n,r,o,j,...m],function*(w,D,z,g,$=1e5,T={},Q=.0015,B=.001,ze="database",Te=[],pe="normal"){var U;try{const he=pe==="high"?1:0,b={strategy_id:w.toString(),symbol:D,start_date:z,end_date:g,initial_capital:$,parameters:T,commission_rate:Q,slippage_rate:B,data_source:ze,features:Te,priority:he},W=yield q.post(`${Bt}/async/backtest/submit`,b);if(W.data&&W.data.task_id)return W.data;throw new Error(((U=W.data)==null?void 0:U.message)||"提交异步回测任务失败")}catch(he){throw d.error(`提交异步回测任务错误: ${he.message}`),he}}),nn=n=>Et(void 0,null,function*(){try{return(yield q.get(`${Bt}/async/backtest/status/${n}`)).data}catch(r){throw d.error(`获取任务状态错误: ${r.message}`),r}}),ln=n=>Et(void 0,null,function*(){try{return(yield q.get(`${Bt}/async/backtest/result/${n}`)).data}catch(r){throw d.error(`获取回测结果错误: ${r.message}`),r}});var on=Object.defineProperty,cn=Object.defineProperties,dn=Object.getOwnPropertyDescriptors,ia=Object.getOwnPropertySymbols,un=Object.prototype.hasOwnProperty,pn=Object.prototype.propertyIsEnumerable,ca=(n,r,o)=>r in n?on(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o,xs=(n,r)=>{for(var o in r||(r={}))un.call(r,o)&&ca(n,o,r[o]);if(ia)for(var o of ia(r))pn.call(r,o)&&ca(n,o,r[o]);return n},fs=(n,r)=>cn(n,dn(r)),Lt=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});I.extend(Sa);I.extend(ka);I.tz.setDefault("Asia/Shanghai");Ls([Ps,Fs,Ns,Ts,Os,Ys,nr,lr,or,Rs,ir,Es]);$a.locale("zh-cn");const{Title:hn,Paragraph:mn}=Rt,{Option:es}=Ye,xn=()=>{var n;const r=Qt(),[o,j]=l.useState(!1),[m,w]=l.useState(!1),[D,z]=l.useState(1e5),[g,$]=l.useState(.15),[T,Q]=l.useState(.1),[B,ze]=l.useState([]),[Te,pe]=l.useState(!1),[U,he]=l.useState(1),[b,W]=l.useState("MA交叉策略"),[y,Ve]=l.useState(null),[$e,oe]=l.useState([I().subtract(1,"year").startOf("day"),I().endOf("day")]),[Oe,et]=l.useState([]),[ie,tt]=l.useState([]),[se,Pe]=l.useState([]),[ye,rt]=l.useState([]),[zt,ct]=l.useState([]),[qe,We]=l.useState({totalReturn:0,annualReturn:0,sharpeRatio:0,maxDrawdown:0,winRate:0,profitFactor:0,alpha:0,beta:0}),[Ae,bt]=l.useState([]),[vt,pt]=l.useState(null),[ft,He]=l.useState([]),[yt,st]=l.useState([]),Ke=l.useRef(null),k=l.useRef(!1),[x,_]=l.useState({}),[V,ne]=l.useState(!1),[G,Fe]=l.useState([]),[at,Re]=l.useState(null),[Ge,nt]=l.useState(!1),[Ne,t]=l.useState([]),[a,u]=l.useState(!1),[p,M]=l.useState(!1),[C,N]=l.useState(""),[X,re]=l.useState(""),[S,de]=l.useState(!1),[Me,ae]=l.useState(null),[Ie,E]=l.useState(""),[ee,Ee]=l.useState(0),[Ze,dt]=l.useState(null),me=s=>typeof s!="string"?String(s):s.includes("T")?s.split("T")[0]:s.includes(" ")?s.split(" ")[0]:/^\d{4}-\d{2}-\d{2}$/.test(s)?s:s.substring(0,10),lt=l.useCallback(s=>{if(!s||s.length===0)return[];const v=s.map((c,R)=>({key:R.toString(),date:me(c.date),symbol:(y==null?void 0:y.symbol)||"",direction:c.action==="BUY"?"买入":"卖出",entryPrice:c.action==="BUY"?c.price:void 0,exitPrice:c.action==="SELL"?c.price:void 0,shares:c.shares,value:c.value,profitLoss:c.profit||0,returnPct:(c.profit_percent||0)*100,duration:c.holding_days||0,beforeCash:c.before_cash,afterCash:c.after_cash,beforeEquity:c.before_equity,afterEquity:c.after_equity,trigger_reason:c.trigger_reason,available_capital:c.available_capital,allocated_capital:c.allocated_capital,position_size:c.position_size,cumulative_position_ratio:c.cumulative_position_ratio,currentShares:0,currentAvgCost:0})).slice().sort((c,R)=>new Date(c.date).getTime()-new Date(R.date).getTime());let A=0,J=0;return v.forEach(c=>{if(c.direction==="买入"){const R=c.entryPrice||0;J+=c.shares*R,A+=c.shares}else if(c.direction==="卖出"){if(A>0){const R=c.shares/A;J*=1-R}A-=c.shares}c.currentShares=A,c.currentAvgCost=A>0?J/A:0}),v.sort((c,R)=>new Date(R.date).getTime()-new Date(c.date).getTime())},[y]),ls=()=>Lt(void 0,null,function*(){var s,i;if(!vt||!m){d.error("没有可保存的回测结果");return}if(!C.trim()){d.error("请输入回测名称");return}M(!0);try{const v=$e[0].format("YYYY-MM-DD"),A=$e[1].format("YYYY-MM-DD"),J=yield oa(U,y.symbol,v,A,D,{save_backtest:!0,backtest_name:C,backtest_description:X,parameters:x},g,T,"database",[]);if(J.error){d.error(`保存失败: ${J.error}`);return}J.saved?(d.success("回测保存成功！"),u(!1),N(""),re(""),Be.confirm({title:"保存成功",content:"回测已成功保存，是否查看回测历史？",okText:"查看历史",cancelText:"继续回测",onOk:()=>{r("/backtest/history")}})):d.error("保存失败，请重试")}catch(v){console.error("保存回测失败:",v),d.error(((i=(s=v.response)==null?void 0:s.data)==null?void 0:i.detail)||"保存失败，请重试")}finally{M(!1)}}),_t=l.useCallback(()=>{console.log("清理轮询定时器，当前pollingIntervalRef.current:",Ue.current),Ue.current&&(clearInterval(Ue.current),Ue.current=null,dt(null),console.log("轮询定时器已清理"))},[]);l.useEffect(()=>()=>{Ue.current&&(clearInterval(Ue.current),Ue.current=null)},[]);const Ue=l.useRef(null),hs=l.useCallback(s=>Lt(void 0,null,function*(){try{const i=yield nn(s);if(console.log("任务状态:",i),E(i.status),Ee(i.progress||0),i.status==="completed"){console.log("任务已完成，准备清理轮询"),Ue.current&&(console.log("立即清理轮询定时器，ID:",Ue.current),clearInterval(Ue.current),Ue.current=null,dt(null));try{let v;if(i.result&&Object.keys(i.result).length>0?(console.log("从状态响应中获取结果，避免额外请求"),v=i.result):(console.log("状态响应中无结果，发起结果请求"),v=yield ln(s)),console.log("异步回测结果:",v),v&&v.status==="error")console.error("回测执行失败:",v.message),d.error(`回测失败: ${v.message}`);else{const A=v.data||v;console.log("提取的回测数据:",A),os(A),d.success("异步回测完成")}}catch(v){console.error("获取回测结果失败:",v),d.error(`获取回测结果失败: ${v.message}`)}pe(!1),ae(null)}else i.status==="failed"&&(console.log("任务失败，准备清理轮询"),Ue.current&&(console.log("立即清理轮询定时器，ID:",Ue.current),clearInterval(Ue.current),Ue.current=null,dt(null)),pe(!1),ae(null),d.error(`异步回测失败: ${i.error||"未知错误"}`))}catch(i){console.error("获取任务状态失败:",i)}}),[]),os=l.useCallback(s=>{var i,v,A,J;if(s.error){d.error(`回测失败: ${s.error}`);return}if(console.log("回测结果:",s),console.log("回测结果关键字段:"),console.log("- total_return:",s.total_return),console.log("- annual_return:",s.annual_return),console.log("- sharpe_ratio:",s.sharpe_ratio),console.log("- max_drawdown:",s.max_drawdown),console.log("- win_rate:",s.win_rate),console.log("- profit_factor:",s.profit_factor),console.log("- trades 数量:",(i=s.trades)==null?void 0:i.length),console.log("- equity_curve 数量:",(v=s.equity_curve)==null?void 0:v.length),console.log("- drawdowns 数量:",(A=s.drawdowns)==null?void 0:A.length),s.trades||(s.trades=[],console.warn("未找到交易记录，设置为空数组")),s.equity_curve||(s.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),s.drawdowns||(s.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),We({totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0,alpha:(s.alpha||0)*100,beta:s.beta||0}),console.log("处理后的性能指标:",{totalReturn:(s.total_return||0)*100,annualReturn:(s.annual_return||0)*100,sharpeRatio:s.sharpe_ratio||0,maxDrawdown:(s.max_drawdown||0)*100,winRate:(s.win_rate||0)*100,profitFactor:s.profit_factor||0}),pt(s),s.trades&&s.trades.length>0){const je=lt(s.trades);tt(je),He(je)}else tt([]),He([]);if(s.equity_curve&&s.equity_curve.length>0){console.log("处理权益曲线数据:",s.equity_curve[0]);const je=s.equity_curve.map(R=>({date:me(R.date),equity:R.equity}));rt(je),st(je);const c=s.equity_curve.map(R=>{const ve=me(R.date),_e=Number(R.open)||0,H=Number(R.close)||0,Y=Number(R.low)||0,K=Number(R.high)||0,ue=Number(R.volume)||0;return[ve,_e,H,Y,K,ue]});console.log("K线数据示例(前3条):",c.slice(0,3)),Pe(c)}else rt([]),st([]),Pe([]);if(s.drawdowns&&s.drawdowns.length>0){const je=s.drawdowns.map(c=>({date:me(c.date),drawdown:(c.drawdown||0)*100}));ct(je)}else ct([]);w(!0),(J=Ke.current)==null||J.scrollIntoView({behavior:"smooth"})},[me,y]),_s=l.useCallback(()=>Lt(void 0,null,function*(){if(!U||!y||!$e[0]||!$e[1]){d.error("请选择策略、交易品种和回测周期");return}pe(!0),pt(null),w(!1);try{const s=$e[0].format("YYYY-MM-DD"),i=$e[1].format("YYYY-MM-DD");if(S){console.log("使用异步模式提交回测任务");const v=yield rn(U,y.symbol,s,i,D,{save_backtest:!1,parameters:x},g,T,"database",[],"normal");console.log("异步任务提交成功:",v),ae(v.task_id),E("pending"),Ee(0);const A=setInterval(()=>{hs(v.task_id)},2e3);Ue.current=A,dt(A),d.info("回测任务已提交，正在后台执行...")}else{console.log("使用同步模式执行回测");const v=yield oa(U,y.symbol,s,i,D,{save_backtest:!1,parameters:x},g,T,"database",[]);os(v),(()=>{d.success("回测完成")})(),pe(!1)}}catch(s){console.error("回测执行失败:",s),d.error(`回测失败: ${s.message||"未知错误"}`),pe(!1),ae(null),_t()}}),[U,y,$e,D,g,T,x,S,os,hs,_t]),ws=l.useCallback(()=>Lt(void 0,null,function*(){var s,i,v,A;if(!U||!y||!$e[0]||!$e[1]){d.error("请选择策略、交易品种和回测周期");return}pe(!0),pt(null),w(!1);try{const J=$e[0].format("YYYY-MM-DD"),je=$e[1].format("YYYY-MM-DD"),c=yield an(U,y.symbol,J,je,D,{save_backtest:!1,parameters:x},g,T,"database",[]);if(c.error){d.error(`强制刷新回测失败: ${c.error}`);return}if(console.log("强制刷新回测结果:",c),console.log("回测结果关键字段:"),console.log("- total_return:",c.total_return),console.log("- annual_return:",c.annual_return),console.log("- sharpe_ratio:",c.sharpe_ratio),console.log("- max_drawdown:",c.max_drawdown),console.log("- win_rate:",c.win_rate),console.log("- profit_factor:",c.profit_factor),console.log("- trades 数量:",(s=c.trades)==null?void 0:s.length),console.log("- equity_curve 数量:",(i=c.equity_curve)==null?void 0:i.length),console.log("- drawdowns 数量:",(v=c.drawdowns)==null?void 0:v.length),c.trades||(c.trades=[],console.warn("未找到交易记录，设置为空数组")),c.equity_curve||(c.equity_curve=[],console.warn("未找到权益曲线数据，设置为空数组")),c.drawdowns||(c.drawdowns=[],console.warn("未找到回撤数据，设置为空数组")),We({totalReturn:(c.total_return||0)*100,annualReturn:(c.annual_return||0)*100,sharpeRatio:c.sharpe_ratio||0,maxDrawdown:(c.max_drawdown||0)*100,winRate:(c.win_rate||0)*100,profitFactor:c.profit_factor||0,alpha:(c.alpha||0)*100,beta:c.beta||0}),console.log("处理后的性能指标:",{totalReturn:(c.total_return||0)*100,annualReturn:(c.annual_return||0)*100,sharpeRatio:c.sharpe_ratio||0,maxDrawdown:(c.max_drawdown||0)*100,winRate:(c.win_rate||0)*100,profitFactor:c.profit_factor||0}),pt(c),c.trades&&c.trades.length>0){const ve=lt(c.trades);tt(ve),He(ve)}else tt([]),He([]);if(c.equity_curve&&c.equity_curve.length>0){console.log("处理权益曲线数据:",c.equity_curve[0]);const ve=c.equity_curve.map(H=>({date:me(H.date),equity:H.equity}));rt(ve),st(ve);const _e=c.equity_curve.map(H=>{const Y=me(H.date),K=Number(H.open)||0,ue=Number(H.close)||0,we=Number(H.low)||0,mt=Number(H.high)||0,wt=Number(H.volume)||0;return[Y,K,ue,we,mt,wt]});console.log("K线数据示例(前3条):",_e.slice(0,3)),Pe(_e)}else rt([]),st([]),Pe([]);if(c.drawdowns&&c.drawdowns.length>0){const ve=c.drawdowns.map(_e=>({date:me(_e.date),drawdown:(_e.drawdown||0)*100}));ct(ve)}else ct([]);w(!0),(A=Ke.current)==null||A.scrollIntoView({behavior:"smooth"}),(()=>{d.success("强制刷新回测完成")})()}catch(J){console.error("强制刷新回测执行失败:",J),d.error(`强制刷新回测失败: ${J.message||"未知错误"}`)}finally{pe(!1)}}),[U,y,$e,D,g,T,me,tt,He,Pe,rt,st,ct,w,pt,We,pe]),Ss=()=>{const s=y?`${y.name} (${y.symbol}) K线图与交易信号`:"K线图与交易信号";let i=[],v=[];if(!se||se.length===0)return console.warn("K线数据为空，无法生成图表"),{title:{text:s,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};if(ie.length>0&&se.length>0){if(console.log("准备标记交易信号，总交易记录：",ie.length),console.log("K线数据样本:",se.slice(0,3)),se.length>0){const H=se[0][0];console.log("K线日期格式示例:",{original:H,type:typeof H,split:typeof H=="string"?H.split("T"):null})}if(ie.length>0){const H=ie[0].date;console.log("交易记录日期格式示例:",{original:H,type:typeof H,split:typeof H=="string"?H.split("T"):null,split2:typeof H=="string"?H.split(" "):null})}const c=new Map,R=new Map;se.forEach((H,Y)=>{const K=me(H[0]);c.set(K,Y),R.set(K,[Number(H[1]),Number(H[2]),Number(H[3]),Number(H[4])])}),console.log("日期索引映射创建完成，共计:",c.size),console.log("日期映射示例:",Array.from(c.entries()).slice(0,3));const ve=ie.filter(H=>H.direction==="买入");console.log("买入记录:",ve.length),i=ve.map(H=>{const Y=me(H.date),K=c.get(Y),ue=H.entryPrice||0;return K===void 0||ue<=0?(console.warn(`未找到买入日期 ${Y} 对应的K线索引或价格无效`),null):(console.log(`买入日期匹配成功: ${Y} -> 索引 ${K}, 价格 ${ue}`),{name:"买入",value:[K,ue],xAxis:K,yAxis:ue,itemStyle:{color:"#f64034"}})}).filter(H=>H!==null);const _e=ie.filter(H=>H.direction==="卖出");console.log("卖出记录:",_e.length),v=_e.map(H=>{const Y=me(H.date),K=c.get(Y),ue=H.exitPrice||0,we=H.profitLoss||0;if(H.returnPct,K===void 0||ue<=0)return console.warn(`未找到卖出日期 ${Y} 对应的K线索引或价格无效`),null;console.log(`卖出日期匹配成功: ${Y} -> 索引 ${K}, 价格 ${ue}, 盈亏 ${we}`);const mt=we>=0?"#f64034":"#00b46a";return{name:"卖出",value:[K,ue],xAxis:K,yAxis:ue,itemStyle:{color:mt}}}).filter(H=>H!==null),console.log(`成功生成买入信号: ${i.length}/${ve.length}`),console.log(`成功生成卖出信号: ${v.length}/${_e.length}`)}const A=se.map(c=>c[0]);let J=[];J=[...i.map(c=>(c.value[0],{name:"买入点",coord:[c.value[0],c.value[1]],value:c.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...v.map(c=>({name:"卖出点",coord:[c.value[0],c.value[1]],value:c.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...i.map(c=>{const R=c.value[0],_e=se[R][4]*1.1;return{name:"买入标签",coord:[c.value[0],_e],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...v.map(c=>{const R=c.value[0],ve=i.some(Y=>{const K=Y.value[0],ue=me(se[K][0]),we=me(se[R][0]);return ue===we}),_e=se[R][4],H=ve?_e*1.2:_e*1.1;return{name:"卖出标签",coord:[c.value[0],H],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];const je=[...i.map(c=>({name:"买入价格",coord:[c.value[0],c.value[1]*1.03],symbol:"none",label:{show:!0,formatter:`¥${c.value[1].toFixed(2)}`,fontSize:12,color:"#f64034",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"top",distance:8}})),...v.map(c=>{const R=c.value[0],ve=se[R][0],_e=ie.find(we=>we.direction==="卖出"&&me(we.date)===me(ve)),H=_e&&_e.profitLoss||0,Y=_e&&_e.returnPct||0,K=H>=0?`+${H.toFixed(2)}`:`${H.toFixed(2)}`,ue=Y>=0?`+${Y.toFixed(2)}%`:`${Y.toFixed(2)}%`;return{name:"卖出价格",coord:[c.value[0],c.value[1]*.97],symbol:"none",label:{show:!0,formatter:_e?`¥${c.value[1].toFixed(2)}
${K}(${ue})`:`¥${c.value[1].toFixed(2)}`,fontSize:12,color:"#00b46a",backgroundColor:"rgba(255,255,255,0.7)",padding:[2,4],borderRadius:2,position:"bottom",distance:8}}})];return{title:{text:s,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(c){let R="";if(Array.isArray(c)){const ve=c[0].axisValue;R=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${ve}</div>`,c.forEach(K=>{if(K.seriesName==="K线"){if(K.value&&K.value.length>=4){const ue=Number(K.value[1])||0,we=Number(K.value[2])||0,mt=Number(K.value[3])||0,wt=Number(K.value[4])||0,xt=we>=ue?"#f64034":"#00b46a";R+=`<div style="color:${xt};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${xt};">${ue.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${xt};">${we.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${xt};">${mt.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${xt};">${wt.toFixed(2)}</span><br/>
                  </div>`}}else if(K.seriesName&&K.seriesName.startsWith("MA")&&K.value!=="-"){const we={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[K.seriesName]||K.color;try{const mt=typeof K.value=="number"?parseFloat(K.value.toString()).toFixed(3):parseFloat(K.value||"0").toFixed(3);R+=`<div style="color:${we};font-weight:bold;display:inline-block;margin-right:15px;">${K.seriesName}：${mt}</div>`}catch(mt){console.warn("格式化MA值出错:",mt),R+=`<div style="color:${we};font-weight:bold;display:inline-block;margin-right:15px;">${K.seriesName}：0</div>`}}});const _e=me(ve),H=ie.find(K=>K.direction==="买入"&&me(K.date)===_e),Y=ie.find(K=>K.direction==="卖出"&&me(K.date)===_e);if((H||Y)&&(R+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),H){const K=H.entryPrice||0,ue=H.trigger_reason||"未记录原因";R+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${K.toFixed(2)}<br/>
                原因：${ue}
              </div>`}if(Y){const K=Y.exitPrice||0,ue=Y.profitLoss||0,we=Y.returnPct||0,mt=Y.trigger_reason||"未记录原因",wt=ue>=0?`+${ue.toFixed(2)}`:`${ue.toFixed(2)}`,xt=we>=0?`+${we.toFixed(2)}%`:`${we.toFixed(2)}%`;R+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${K.toFixed(2)}<br/>
                盈亏：${wt} (${xt})<br/>
                原因：${mt}
              </div>`}}return R}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:A,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"},min:function(c){return Math.min(0,D*.8)},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:se.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:J,animation:!1,z:10}},{name:"价格标签",type:"scatter",data:[],markPoint:{symbol:"none",data:je,animation:!1,z:9}},{name:"MA5",type:"line",data:h(5,se.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:h(10,se.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:h(20,se.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:h(30,se.map(c=>[Number(c[1]),Number(c[2]),Number(c[3]),Number(c[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}};function h(s,i){if(!i||!Array.isArray(i)||i.length===0)return console.warn(`计算MA${s}失败: 数据无效`),[];console.log(`MA${s}计算 - 输入数据示例:`,i.length>0?i.slice(0,3):"无数据");const v=[];for(let A=0;A<i.length;A++){if(A<s-1){v.push("-");continue}let J=0,je=0;for(let c=0;c<s;c++){const R=i[A-c];if(R&&R.length>=4){const ve=Number(R[1]);!isNaN(ve)&&ve>0&&(J+=ve,je++)}}je>0?v.push((J/je).toFixed(2)):v.push("-")}return v.length>0&&console.log(`MA${s}计算结果示例:`,v.slice(0,5)),v}const L=[{title:"日期",dataIndex:"date",key:"date",sorter:(s,i)=>{const v=new Date(s.date),A=new Date(i.date);return v.getTime()-A.getTime()}},{title:"方向",dataIndex:"direction",key:"direction",filters:[{text:"买入",value:"买入"},{text:"卖出",value:"卖出"}],onFilter:(s,i)=>i.direction===s,render:s=>e.jsx(Le,{color:s==="买入"?"red":"green",children:s})},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:s=>e.jsx(Se,{title:s||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:s||"未记录"})})},{title:"期初资金",dataIndex:"beforeCash",key:"beforeCash",sorter:(s,i)=>s.beforeCash-i.beforeCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"afterCash",key:"afterCash",sorter:(s,i)=>s.afterCash-i.afterCash,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"入场价",dataIndex:"entryPrice",key:"entryPrice",sorter:(s,i)=>{const v=s.entryPrice||0,A=i.entryPrice||0;return v-A},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"出场价",dataIndex:"exitPrice",key:"exitPrice",sorter:(s,i)=>{const v=s.exitPrice||0,A=i.exitPrice||0;return v-A},render:s=>{const i=parseFloat(s);return isNaN(i)?"-":i.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(s,i)=>s.shares-i.shares,render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前持仓(股)",dataIndex:"currentShares",key:"currentShares",sorter:(s,i)=>(s.currentShares||0)-(i.currentShares||0),render:s=>(parseInt(s)||0).toLocaleString()},{title:"当前摊薄成本(元)",dataIndex:"currentAvgCost",key:"currentAvgCost",sorter:(s,i)=>(s.currentAvgCost||0)-(i.currentAvgCost||0),render:s=>{const i=parseFloat(s)||0;return i>0?i.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"-"}},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(s,i)=>s.value-i.value,render:s=>(parseFloat(s)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"盈亏",dataIndex:"profitLoss",key:"profitLoss",sorter:(s,i)=>s.profitLoss-i.profitLoss,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2)]}):e.jsx("span",{style:{color:"#52c41a"},children:i.toFixed(2)})}},{title:"收益率(%)",dataIndex:"returnPct",key:"returnPct",sorter:(s,i)=>s.returnPct-i.returnPct,render:s=>{const i=parseFloat(s);return isNaN(i)?e.jsx("span",{children:"0.00%"}):i>=0?e.jsxs("span",{style:{color:"#f5222d"},children:["+",i.toFixed(2),"%"]}):e.jsxs("span",{style:{color:"#52c41a"},children:[i.toFixed(2),"%"]})}},{title:"持仓天数",dataIndex:"duration",key:"duration",sorter:(s,i)=>s.duration-i.duration},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(s,i)=>(s.position_size||0)-(i.position_size||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(s,i)=>(s.cumulative_position_ratio||0)-(i.cumulative_position_ratio||0),render:s=>{const i=parseFloat(s);return isNaN(i)||i===0?e.jsx("span",{children:"0.00%"}):e.jsxs("span",{children:[(i*100).toFixed(2),"%"]})}}],O=()=>{if(console.log("生成权益曲线图表, 数据长度:",ye.length),!ye||ye.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const s=ye.filter(Y=>Y&&Y.date&&Y.equity!==void 0&&!isNaN(Number(Y.equity)));if(s.length===0)return console.error("权益曲线数据无效:",ye.slice(0,3)),{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};console.log("有效数据点数量:",s.length),console.log("权益曲线数据范围:",s.length>0?`${s[0].date}(${s[0].equity}) ~ ${s[s.length-1].date}(${s[s.length-1].equity})`:"无数据");let i=[],v=[];const A=new Map;s.forEach((Y,K)=>{const ue=me(Y.date);A.set(ue,K)}),ie.length>0&&(console.log("准备在权益曲线上标记交易点，总交易记录：",ie.length),ie.forEach(Y=>{const K=me(Y.date),ue=A.get(K);if(ue!==void 0){const we={name:Y.direction==="买入"?"买入点":"卖出点",value:s[ue].equity,xAxis:ue,yAxis:s[ue].equity,itemStyle:{color:Y.direction==="买入"?"#f64034":"#00b46a"}};Y.direction==="买入"?i.push(we):v.push(we)}}));let J=-1,je=-1,c=0,R="",ve="",_e=0,H=0;if(s.length>0&&qe.maxDrawdown>0){let Y=s[0].equity,K=0,ue=0;for(let we=1;we<s.length;we++)s[we].equity>Y?(Y=s[we].equity,ue=we):(K=(Y-s[we].equity)/Y*100,K>c&&(c=K,J=ue,je=we,R=s[ue].date,ve=s[we].date,_e=Y,H=s[we].equity));console.log(`最大回测区间索引: ${J} - ${je}`),console.log(`最大回测: ${c.toFixed(2)}%, 从 ${R} 到 ${ve}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(Y){if(Array.isArray(Y)&&Y.length>0){const ue=Y[0].axisValue,we=Y[0].data;for(let wt=0;wt<Y.length;wt++)if(Y[wt].componentType==="markArea")return`最大回撤: ${c.toFixed(2)}%<br/>
                        开始日期: ${R}<br/>
                        最高点: ¥${_e.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${ve}<br/>
                        最低点: ¥${H.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let mt="";for(let wt=0;wt<Y.length;wt++){const xt=Y[wt];if(xt.seriesName==="买入点"||xt.seriesName==="卖出点"){const Ra=me(ue),Vs=ie.find(is=>me(is.date)===Ra&&(xt.seriesName==="买入点"&&is.direction==="买入"||xt.seriesName==="卖出点"&&is.direction==="卖出"));if(Vs){const is=Vs.trigger_reason||"未记录原因";mt=`<br/><span style="color:${xt.color}">● ${xt.seriesName}</span>`,mt+=`<br/><span style="color:#555; font-size:12px">原因: ${is}</span>`}else mt=`<br/><span style="color:${xt.color}">● ${xt.seriesName}</span>`;break}}return`${ue}<br/>策略收益: ¥${parseFloat(we).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${mt}`}const K=Y.value;return`${Y.name}: ¥${parseFloat(K).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:s.map(Y=>Y.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:s.map(Y=>Y.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new Ca(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...i.map(Y=>({name:"买入点",coord:[Y.xAxis,Y.yAxis],value:Y.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...v.map(Y=>({name:"卖出点",coord:[Y.xAxis,Y.yAxis],value:Y.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${c.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[J>=0&&je>=0?[{name:"最大回撤开始",xAxis:J,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:je,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:s.map(()=>D),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:D,label:{formatter:"初始资金: ¥"+D.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(Y){return`初始资金: ¥${D.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},be=()=>Lt(void 0,null,function*(){try{const s=yield Qr();if(console.log("从后端获取的策略列表:",s),s&&s.length>0)if(bt(s),!s.some(i=>i.id===U))he(s[0].id||1),W(s[0].name||"移动平均线交叉策略");else{const i=s.find(v=>v.id===U);i&&W(i.name)}else d.error("未找到策略列表，请先创建策略")}catch(s){console.error("获取策略列表失败:",s),d.error("获取策略列表失败，请检查网络连接")}});l.useEffect(()=>{k.current||(k.current=!0,ce(),St(),be())},[]),l.useEffect(()=>{Ae.length>0&&U&&xe(U)},[Ae,U]);const Ce=s=>Lt(void 0,null,function*(){Ve(s);try{const i=yield Fr(s.id);if(i.first_date&&i.last_date){const v=I(i.first_date).startOf("day"),A=I(i.last_date).endOf("day");oe([v,A]),d.success(`已自动设置回测周期：${i.first_date} 至 ${i.last_date}`)}}catch(i){console.error("获取股票日期范围失败:",i),d.warning("无法获取该股票的数据日期范围，请手动设置回测周期")}}),ce=()=>Lt(void 0,null,function*(){pe(!0);try{const s=yield vs();ze(s),s.length>0&&(yield Ce(s[0]))}catch(s){console.error("获取股票列表失败:",s)}finally{pe(!1)}}),xe=s=>Lt(void 0,null,function*(){try{const i=yield q.get(`/api/optimization/strategies/${s}/parameter-spaces`);if(i.data&&i.data.status==="success"){Fe(i.data.data);const v={};i.data.data.forEach(A=>{(A.parameter_type==="int"||A.parameter_type==="float")&&(v[A.parameter_name]=A.min_value)}),_(v)}}catch(i){console.error("加载参数空间失败:",i),Fe([]),_({})}}),fe=()=>{ne(!0)},ht=()=>{ne(!1),d.success("参数设置已保存")},Qe=()=>{const s={};G.forEach(i=>{(i.parameter_type==="int"||i.parameter_type==="float")&&(s[i.parameter_name]=i.min_value)}),_(s),d.success("参数已重置为默认值")},Mt=()=>Lt(void 0,null,function*(){try{const s=yield q.get(`/api/optimization/strategies/${U}/best-parameters`);s.data&&s.data.status==="success"&&s.data.data.length>0?(t(s.data.data),nt(!0)):d.warning("该策略暂无优化结果，请先进行参数优化")}catch(s){console.error("获取优化结果失败:",s),d.error("获取优化结果失败，请检查网络连接")}}),Nt=s=>{var i;_(s.best_parameters),nt(!1),ne(!1),d.success(`已导入优化结果: ${s.job_name} (得分: ${(i=s.best_score)==null?void 0:i.toFixed(4)})`)},At=s=>{he(s);const i=Ae.find(v=>v.id===s);i&&(W(i.name),Re(i)),xe(s)},St=()=>Lt(void 0,null,function*(){try{const s=yield Pa();et(s)}catch(s){console.error("获取数据源列表失败:",s)}}),te=()=>[{key:"1",label:e.jsxs("span",{children:[e.jsx(Ft,{}),"绩效分析"]}),children:e.jsx(Z,{gutter:16,children:e.jsx(f,{span:24,style:{marginBottom:16},children:e.jsx(Ht,{option:O(),style:{height:500}})})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(Ft,{}),"K线与交易信号"]}),children:e.jsx(Z,{gutter:16,children:e.jsx(f,{span:24,children:e.jsx(le,{title:y?`${y.name} (${y.symbol})交易图表`:"交易图表",extra:e.jsxs(De,{children:[e.jsx(P,{type:"primary",size:"small",onClick:()=>{const s=document.querySelector(".kline-chart");if(s){const i=s.__echarts__;i&&i.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(P,{size:"small",onClick:()=>{if(ie.length>0&&se.length>0){const s=new Map;se.forEach((v,A)=>{const J=me(v[0]);s.set(J,A)});const i=[];if(ie.forEach(v=>{const A=me(v.date),J=s.get(A);J!==void 0&&i.push(J)}),console.log("找到的交易日期索引:",i),i.length>0){const v=Math.max(0,Math.min(...i)-10),A=Math.min(se.length-1,Math.max(...i)+10),J=v/se.length*100,je=A/se.length*100;console.log(`设置缩放范围: ${J.toFixed(2)}% - ${je.toFixed(2)}%`);const c=document.querySelector(".kline-chart");if(c){const R=c.__echarts__;R&&(R.dispatchAction({type:"dataZoom",start:J,end:je}),(_e=>{d.success(`已聚焦到交易区域，共显示 ${_e} 个交易点`)})(i.length))}}else(()=>{d.info("未找到交易信号对应的K线数据点")})()}else(()=>{d.info("没有交易记录或K线数据")})()},children:"聚焦交易"}),e.jsx(Se,{title:"只显示有交易的区域",children:e.jsx(Je,{})})]}),children:e.jsx(Ht,{className:"kline-chart",option:Ss(),style:{height:600},notMerge:!0,opts:{renderer:"canvas"},onEvents:{click:s=>{if(s.componentType==="markPoint"){const v=s.name==="买入",A=s.data.coord[0],J=se[A][0],je=v?"买入":"卖出",c=ie.find(R=>R.direction===je&&me(R.date)===me(J));if(console.log(`点击了${je}标记，日期: ${J}`,c),c){const R=c,ve=v?"买入详情":"卖出详情",_e=e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"日期:"})," ",R.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"价格:"})," ",v?R.entryPrice:R.exitPrice]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数量:"})," ",R.shares.toLocaleString()," 股"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"金额:"})," ",R.value.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),!v&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏:"})," ",R.profitLoss>=0?"+":"",R.profitLoss.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"收益率:"})," ",R.returnPct>=0?"+":"",R.returnPct.toFixed(2),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"持仓天数:"})," ",R.duration," 天"]})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易前资金:"})," ",R.beforeCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"交易后资金:"})," ",R.afterCash.toLocaleString("zh-CN",{minimumFractionDigits:2})," 元"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"触发原因:"})," ",R.trigger_reason||"未记录原因"]})]});Be.info({title:ve,content:_e,width:400})}else((ve,_e)=>{d.info(`未找到匹配的${ve}交易记录，日期: ${_e}`)})(je,J)}}}})})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Je,{}),"交易明细"]}),children:e.jsx(Jt,{dataSource:ie,columns:L,pagination:{pageSize:10},scroll:{x:!0}})}];return e.jsxs("div",{children:[e.jsx(hn,{level:2,children:"回测分析"}),e.jsx(mn,{children:"回测您的交易策略，分析策略表现并优化参数。"}),e.jsx(le,{children:e.jsx(ns,{spinning:Te,children:e.jsxs(F,{layout:"vertical",children:[e.jsxs(Z,{gutter:24,children:[e.jsx(f,{span:8,children:e.jsx(F.Item,{label:"策略选择",required:!0,children:e.jsxs(ke.Group,{compact:!0,children:[e.jsx(Ye,{value:b,onChange:(s,i)=>{At(Number(i.key))},placeholder:"选择策略",style:{width:"calc(100% - 80px)"},size:"middle",children:Ae.map(s=>e.jsx(es,{value:s.name,children:s.name},s.id))}),e.jsx(P,{type:"primary",ghost:!0,onClick:fe,style:{width:"80px"},icon:e.jsx(bs,{}),size:"middle",children:"参数"})]})})}),e.jsx(f,{span:8,children:e.jsx(F.Item,{label:"交易品种",required:!0,children:e.jsx(Ye,{value:y==null?void 0:y.symbol,onChange:s=>Lt(void 0,null,function*(){const i=B.find(v=>v.symbol===s);i&&(yield Ce(i))}),placeholder:"选择交易品种",children:B.map(s=>{var i;return e.jsxs(es,{value:s.symbol,children:[s.name," (",s.symbol,") - ",((i=Oe.find(v=>v.id===s.source_id))==null?void 0:i.name)||"未知数据源"]},s.id)})})})}),e.jsx(f,{span:8,children:e.jsx(F.Item,{label:"回测周期",required:!0,children:e.jsx(Zt.RangePicker,{value:$e,onChange:s=>{s&&s[0]&&s[1]&&oe([s[0].startOf("day"),s[1].endOf("day")])},style:{width:"100%"},placeholder:["开始日期","结束日期"],format:"YYYY-MM-DD",allowClear:!1,disabledDate:s=>s&&s>I().endOf("day"),presets:[{label:"Last 7 days",value:[I().subtract(7,"day"),I()]},{label:"Last 30 days",value:[I().subtract(30,"day"),I()]},{label:"Last 3 months",value:[I().subtract(3,"month"),I()]},{label:"Last 6 months",value:[I().subtract(6,"month"),I()]},{label:"Last 1 year",value:[I().subtract(1,"year"),I()]},{label:"Last 3 years",value:[I().subtract(3,"year"),I()]},{label:"Last 5 years",value:[I().subtract(5,"year"),I()]},{label:"Last 7 years",value:[I().subtract(7,"year"),I()]},{label:"Last 10 years",value:[I().subtract(10,"year"),I()]}]})})})]}),e.jsxs(Z,{gutter:24,children:[e.jsx(f,{span:6,children:e.jsx(F.Item,{label:"初始资金",children:e.jsx(Vt,{value:D,onChange:s=>z(Number(s)||1e5),formatter:s=>`¥ ${s}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:s=>{if(s){const i=parseFloat(s.replace(/\¥\s?|(,*)/g,""));return isNaN(i)?D:i}return D},style:{width:"100%"}})})}),e.jsx(f,{span:6,children:e.jsx(F.Item,{label:"手续费率(%)",children:e.jsx(Vt,{value:g,onChange:s=>$(Number(s)||.15),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(f,{span:6,children:e.jsx(F.Item,{label:"滑点(%)",children:e.jsx(Vt,{value:T,onChange:s=>Q(Number(s)||.1),min:0,max:10,step:.01,style:{width:"100%"}})})}),e.jsx(f,{span:6,children:e.jsx(F.Item,{label:"基准",children:e.jsxs(Ye,{defaultValue:"SPY",placeholder:"选择基准",children:[e.jsx(es,{value:"SPY",children:"标普500ETF"}),e.jsx(es,{value:"QQQ",children:"纳斯达克ETF"}),e.jsx(es,{value:"DIA",children:"道琼斯ETF"})]})})})]}),y&&e.jsx(gt,{message:`已选择数据源: ${((n=Oe.find(s=>s.id===y.source_id))==null?void 0:n.name)||"未知"}`,description:`回测将使用与数据管理中相同的数据源获取 ${y.symbol} 的历史数据`,type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(F.Item,{label:"执行模式",children:e.jsxs(De,{children:[e.jsx(cr,{checked:S,onChange:de,checkedChildren:"异步",unCheckedChildren:"同步"}),e.jsx(Se,{title:S?"异步模式：任务在后台执行，可以处理大数据量回测":"同步模式：立即返回结果，适合快速回测",children:e.jsx(Je,{style:{color:"#aaa"}})}),S&&Me&&e.jsxs(Le,{color:Ie==="completed"?"green":Ie==="failed"?"red":"blue",children:["任务状态: ",Ie==="pending"?"等待中":Ie==="running"?"执行中":Ie==="completed"?"已完成":Ie==="failed"?"失败":Ie,Ie==="running"&&` (${ee}%)`]})]})}),e.jsx(F.Item,{children:e.jsxs(De,{children:[e.jsx(P,{type:"primary",icon:e.jsx(Gt,{}),loading:o,onClick:_s,children:S?"提交异步回测":"运行回测"}),e.jsx(P,{type:"default",icon:e.jsx(Gt,{}),loading:o,onClick:ws,title:"强制刷新：清除缓存并重新运行回测",disabled:S,children:"强制刷新"})]})})]})})}),m&&e.jsxs(e.Fragment,{children:[e.jsx(ys,{}),e.jsxs(le,{children:[e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["总收益率 ",e.jsx(Se,{title:"总收益率=最终资金/初始资金-1，反映策略总体收益情况",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.totalReturn,precision:2,valueStyle:{color:qe.totalReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(Se,{title:"年化收益率=（总收益率+1）^(365/天数)-1，反映策略年化增长速度",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.annualReturn,precision:2,valueStyle:{color:qe.annualReturn>=0?"#f5222d":"#52c41a"},suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(Se,{title:"最大回撤=历史最高点到最低点的最大跌幅，衡量风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:Math.abs(qe.maxDrawdown),precision:2,valueStyle:{color:"#52c41a"},suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(Se,{title:"夏普比率=（年化收益率-无风险利率）/年化波动率，衡量单位风险收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.sharpeRatio,precision:2})})]}),e.jsx(Z,{gutter:16,style:{marginTop:16},children:e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["胜率 ",e.jsx(Se,{title:"胜率=盈利交易次数/总交易次数",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.winRate,precision:2,suffix:"%"})})}),e.jsxs(Z,{gutter:16,style:{marginTop:24},children:[e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(Se,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.profitFactor||0,precision:2})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Alpha ",e.jsx(Se,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.alpha||0,precision:2,suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Beta ",e.jsx(Se,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:qe.beta||0,precision:2})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["交易次数 ",e.jsx(Se,{title:"策略在回测期间的总交易次数",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:ie.length})})]}),e.jsx(ys,{}),e.jsx(ps,{defaultActiveKey:"1",items:te()}),e.jsxs("div",{style:{textAlign:"right",marginTop:16},children:[e.jsx(P,{icon:e.jsx(wa,{}),style:{marginRight:8},children:"导出报告"}),e.jsx(P,{icon:e.jsx(Ia,{}),type:"primary",onClick:()=>{const s=new Date,i=s.toISOString().slice(0,10).replace(/-/g,""),v=s.toTimeString().slice(0,5).replace(":",""),A=`${(y==null?void 0:y.symbol)||"UNKNOWN"}_v${i}_${v}`;N(A),u(!0)},disabled:!m,children:"保存回测"})]})]})]}),e.jsx(Be,{title:"保存回测",open:a,onOk:ls,onCancel:()=>{u(!1),N(""),re("")},confirmLoading:p,okText:"保存",cancelText:"取消",children:e.jsxs(F,{layout:"vertical",children:[e.jsx(F.Item,{label:"回测名称",required:!0,help:"请输入一个描述性的回测名称",children:e.jsx(ke,{placeholder:"例如：MA交叉策略_AAPL_2024年回测",value:C,onChange:s=>N(s.target.value)})}),e.jsx(F.Item,{label:"回测描述",help:"可选：添加回测的详细描述",children:e.jsx(ke.TextArea,{placeholder:"例如：使用移动平均线交叉策略对AAPL进行回测，包含仓位控制...",value:X,onChange:s=>re(s.target.value),rows:3})}),e.jsx(gt,{message:"保存信息",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"策略："}),b]}),e.jsxs("p",{children:[e.jsx("strong",{children:"股票："}),y==null?void 0:y.symbol," (",y==null?void 0:y.name,")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"回测期间："}),$e[0].format("YYYY-MM-DD")," 至 ",$e[1].format("YYYY-MM-DD")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"初始资金："}),"$",D.toLocaleString()]}),Object.keys(x).length>0&&e.jsxs("p",{children:[e.jsx("strong",{children:"策略参数："}),"短期均线 ",x.short_window||5,"天, 长期均线 ",x.long_window||20,"天"]})]}),type:"info",showIcon:!0})]})}),e.jsxs(Be,{title:"策略参数设置",open:V,onOk:ht,onCancel:()=>ne(!1),width:800,children:[e.jsx(gt,{message:`当前策略: ${(at==null?void 0:at.name)||b}`,description:(at==null?void 0:at.description)||"策略参数配置",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(F,{layout:"vertical",children:[G.length>0?e.jsx(Z,{gutter:16,children:G.map((s,i)=>e.jsx(f,{span:12,children:e.jsx(F.Item,{label:`${s.parameter_name}${s.description?` (${s.description})`:""}`,help:s.description,children:s.parameter_type==="int"?e.jsx(Vt,{value:x[s.parameter_name]||s.min_value,onChange:v=>_(A=>fs(xs({},A),{[s.parameter_name]:v})),min:s.min_value,max:s.max_value,step:s.step_size,style:{width:"100%"}}):s.parameter_type==="float"?e.jsx(Vt,{value:x[s.parameter_name]||s.min_value,onChange:v=>_(A=>fs(xs({},A),{[s.parameter_name]:v})),min:s.min_value,max:s.max_value,step:s.step_size,precision:2,style:{width:"100%"}}):s.parameter_type==="choice"?e.jsx(Ye,{value:x[s.parameter_name]!==void 0?x[s.parameter_name]:s.choices&&s.choices.length>0?s.choices[0]:void 0,onChange:v=>_(A=>fs(xs({},A),{[s.parameter_name]:v})),style:{width:"100%"},children:(s.choices||[]).map((v,A)=>e.jsx(es,{value:v,children:typeof v=="boolean"?v?"true":"false":String(v)},A))}):e.jsx(ke,{value:x[s.parameter_name]||"",onChange:v=>_(A=>fs(xs({},A),{[s.parameter_name]:v.target.value})),placeholder:`请输入${s.parameter_name}`})})},s.parameter_name))}):e.jsx(gt,{message:"暂无参数配置",description:"该策略暂未配置参数空间，将使用默认参数进行回测",type:"warning",showIcon:!0}),G.length>0&&e.jsx(gt,{message:"参数说明",description:e.jsx("div",{children:G.map((s,i)=>e.jsxs("p",{children:[e.jsxs("strong",{children:[s.parameter_name,"："]}),s.description,s.parameter_type==="int"||s.parameter_type==="float"?` (范围: ${s.min_value} - ${s.max_value}, 步长: ${s.step_size})`:s.parameter_type==="choice"?` (选项: ${(s.choices||[]).map(v=>typeof v=="boolean"?v?"true":"false":String(v)).join(", ")})`:""]},i))}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(De,{children:[e.jsx(P,{onClick:Qe,children:"重置默认值"}),e.jsx(P,{type:"dashed",onClick:Mt,children:"从优化导入"})]})]})]}),e.jsxs(Be,{title:"选择优化结果",open:Ge,onCancel:()=>nt(!1),width:800,footer:null,children:[e.jsx(gt,{message:"选择要导入的优化结果",description:"以下是从参数优化中获得的最佳参数配置，按优化得分排序",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("div",{style:{maxHeight:400,overflowY:"auto"},children:Ne.map((s,i)=>{var v;return e.jsxs(le,{size:"small",style:{marginBottom:8},hoverable:!0,onClick:()=>Nt(s),children:[e.jsxs(Z,{gutter:16,align:"middle",children:[e.jsx(f,{span:16,children:e.jsxs("div",{children:[e.jsx("strong",{children:s.job_name}),e.jsxs("div",{style:{fontSize:"12px",color:"#666",marginTop:4},children:[s.description&&`${s.description} • `,"完成时间: ",s.completed_at?I.utc(s.completed_at).tz("Asia/Shanghai").format("YYYY/MM/DD HH:mm:ss"):"未知"]})]})}),e.jsx(f,{span:4,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"14px",fontWeight:"bold",color:"#1890ff"},children:(v=s.best_score)==null?void 0:v.toFixed(4)}),e.jsx("div",{style:{fontSize:"12px",color:"#666"},children:s.objective_function})]})}),e.jsx(f,{span:4,children:e.jsx("div",{style:{textAlign:"center"},children:e.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:["试验次数: ",s.total_trials]})})})]}),e.jsxs("div",{style:{marginTop:8,fontSize:"12px"},children:[e.jsx("strong",{children:"关键参数:"}),e.jsxs("div",{style:{marginTop:4,maxHeight:"40px",overflow:"hidden"},children:[Object.entries(s.best_parameters||{}).slice(0,3).map(([A,J])=>e.jsxs(Le,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[A==="short_window"?"短期":A==="long_window"?"长期":A==="min_reversal_points"?"反转点":A==="lookback_period"?"回望期":A==="signal_strength_threshold"?"信号阈值":A==="batch_count"?"批次数":A==="stop_loss_ratio"?"止损":A==="take_profit_ratio"?"止盈":A,": ",typeof J=="number"?J.toFixed(1):String(J)]},A)),Object.keys(s.best_parameters||{}).length>3&&e.jsxs(Le,{style:{margin:"1px 2px 1px 0",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",Object.keys(s.best_parameters||{}).length-3,"个"]})]})]})]},s.job_id)})}),Ne.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"40px 0",color:"#999"},children:"暂无优化结果"})]})]})},fn=l.memo(xn);var gn=Object.defineProperty,yn=Object.defineProperties,jn=Object.getOwnPropertyDescriptors,da=Object.getOwnPropertySymbols,bn=Object.prototype.hasOwnProperty,vn=Object.prototype.propertyIsEnumerable,ua=(n,r,o)=>r in n?gn(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o,gs=(n,r)=>{for(var o in r||(r={}))bn.call(r,o)&&ua(n,o,r[o]);if(da)for(var o of da(r))vn.call(r,o)&&ua(n,o,r[o]);return n},$s=(n,r)=>yn(n,jn(r)),It=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});I.extend(Sa);I.extend(ka);I.tz.setDefault("Asia/Shanghai");const{Title:_n,Text:Xe}=Rt,{Option:Ut}=Ye,{TabPane:pa}=ps,wn=()=>{const[n,r]=l.useState([]),[o,j]=l.useState(null),[m,w]=l.useState([]),[D,z]=l.useState([]),[g,$]=l.useState(!1),T=l.useRef(!1),[Q]=F.useForm(),[B,ze]=l.useState(!1),[Te,pe]=l.useState(!1),[U,he]=l.useState(!1),[b,W]=l.useState(null),[y,Ve]=l.useState(null),[$e,oe]=l.useState(!1),[Oe,et]=l.useState([]),[ie,tt]=l.useState(!1),[se,Pe]=l.useState([]),[ye,rt]=l.useState({}),[zt,ct]=l.useState([]),[qe,We]=l.useState(!1),Ae=l.useCallback(()=>{const t=n.find(C=>C.id===o),a=(t==null?void 0:t.name)||"策略优化",p=Q.getFieldsValue().symbol||"AAPL",M=I().format("YYYYMMDD");return`${p}_${M}_${a}`},[o,n,Q]),bt=l.useCallback(()=>{if(!qe){const t=Ae();Q.setFieldValue("name",t)}},[qe,Ae,Q]),vt=()=>It(void 0,null,function*(){try{const t=yield q.get("/api/strategies");t.data&&t.data.data&&r(t.data.data)}catch(t){console.error("加载策略列表失败:",t),d.error("加载策略列表失败")}}),pt=()=>It(void 0,null,function*(){try{const t=yield q.get("/api/data/stocks");if(t.data&&Array.isArray(t.data)){const a=t.data.map(u=>({symbol:u.symbol,name:u.name}));ct(a)}}catch(t){console.error("加载股票列表失败:",t),ct([{symbol:"AAPL",name:"Apple Inc."},{symbol:"TSLA",name:"Tesla Inc."},{symbol:"MSFT",name:"Microsoft Corporation"},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"AMZN",name:"Amazon.com Inc."}])}}),ft=t=>It(void 0,null,function*(){try{const a=yield q.get(`/api/data/stock/symbol/${t}/date-range`);if(a.data&&a.data.status==="success"){const{min_date:u,max_date:p}=a.data.data;rt({min_date:u,max_date:p}),u&&p&&Q.setFieldsValue({start_date:I(u),end_date:I(p)})}}catch(a){console.error("获取股票数据范围失败:",a)}}),He=t=>{const a=I();let u,p=a;switch(t){case"recent1y":u=a.subtract(1,"year");break;case"recent3y":u=a.subtract(3,"year");break;case"recent5y":u=a.subtract(5,"year");break;case"recent6y":u=a.subtract(6,"year");break;case"recent7y":u=a.subtract(7,"year");break;case"recent8y":u=a.subtract(8,"year");break;case"recent9y":u=a.subtract(9,"year");break;case"recent10y":u=a.subtract(10,"year");break;case"full":ye.min_date&&ye.max_date?(u=I(ye.min_date),p=I(ye.max_date)):u=a.subtract(5,"year");break;default:u=a.subtract(1,"year")}Q.setFieldsValue({start_date:u,end_date:p})},yt=t=>It(void 0,null,function*(){try{const a=yield q.get(`/api/optimization/strategies/${t}/parameter-spaces`);a.data&&a.data.status==="success"&&w(a.data.data)}catch(a){console.error("加载参数空间失败:",a)}}),st=t=>It(void 0,null,function*(){var a;try{$(!0);const u=t?{strategy_id:t}:{},p=yield q.get("/api/optimization/jobs",{params:u});if(p.data&&p.data.status==="success"){const M=Array.isArray((a=p.data.data)==null?void 0:a.jobs)?p.data.data.jobs:[];z(M),d.success("刷新成功")}else z([]),d.warning("没有找到优化任务")}catch(u){console.error("加载优化任务失败:",u),z([]),d.error("加载优化任务失败")}finally{$(!1)}}),Ke=t=>{j(t),yt(t),st(t)},k=()=>{w([...m,{parameter_name:"",parameter_type:"float",min_value:0,max_value:1,step_size:.1,description:""}])},x=t=>{w(m.filter((a,u)=>u!==t))},_=(t,a,u)=>{const p=[...m];p[t]=$s(gs({},p[t]),{[a]:u}),w(p)},V=t=>{if(!Array.isArray(t))return!1;const a=t.map(M=>typeof M=="string"?M.toLowerCase():M),u=a.includes(!0)||a.includes("true"),p=a.includes(!1)||a.includes("false");return a.length===2&&u&&p},ne=()=>It(void 0,null,function*(){if(!o){d.error("请先选择策略");return}try{$(!0),yield q.post(`/api/optimization/strategies/${o}/parameter-spaces`,m),d.success("参数空间保存成功"),ze(!1)}catch(t){console.error("保存参数空间失败:",t),d.error("保存参数空间失败")}finally{$(!1)}}),G=()=>It(void 0,null,function*(){var t;if(!o){d.error("请先选择策略");return}try{$(!0);const a=yield q.get(`/api/optimization/strategies/${o}/parameter-spec`),u=((t=a==null?void 0:a.data)==null?void 0:t.data)||[];if(!Array.isArray(u)||u.length===0){d.warning("未识别到策略参数");return}const p=[];for(const N of u){const X=N==null?void 0:N.name,re=N==null?void 0:N.type,S=N==null?void 0:N.default;if(!(!X||!re))if(re==="integer"){const de=typeof S=="number"?S:typeof S=="string"?parseFloat(S):10;let Me=Math.floor((isNaN(de)?10:de)*.5),ae=Math.ceil((isNaN(de)?10:de)*1.5);Me<1&&(Me=1),ae<=Me&&(ae=Me+1),p.push({parameter_name:X,parameter_type:"int",min_value:Me,max_value:ae,step_size:1,description:"自动识别（±50%范围）"})}else if(re==="float"){const de=typeof S=="number"?S:typeof S=="string"?parseFloat(S):1,Me=isNaN(de)?1:de;let ae=Me*.5,Ie=Me*1.5;Ie<=ae&&(Ie=ae+(Math.abs(Me)||1));const E=Math.max(1e-4,Math.abs(Me)*.1||.1);p.push({parameter_name:X,parameter_type:"float",min_value:Number(ae.toFixed(6)),max_value:Number(Ie.toFixed(6)),step_size:Number(E.toFixed(6)),description:"自动识别（±50%范围）"})}else if(re==="boolean")p.push({parameter_name:X,parameter_type:"choice",choices:[!0,!1],description:"自动识别（布尔类型）"});else if(re==="string")p.push({parameter_name:X,parameter_type:"choice",choices:typeof S<"u"?[S]:[],description:"自动识别（字符串类型，请手动设置备选项）"});else continue}if(p.length===0){d.warning("未识别到可优化的数值型参数");return}const M=new Map((m||[]).map(N=>[N.parameter_name,N])),C=p.map(N=>{const X=M.get(N.parameter_name);if(X){const re=!!X.description&&String(X.description).trim().length>0;return $s(gs({},N),{description:re?X.description:N.description})}return N});for(const[N,X]of M.entries())C.some(re=>re.parameter_name===N)||C.push(X);w(C),d.success(`已自动识别 ${p.length} 个参数，请完善范围后保存`)}catch(a){console.error("自动识别策略参数失败:",a),d.error("自动识别策略参数失败")}finally{$(!1)}}),Fe=t=>It(void 0,null,function*(){try{$(!0),W(t),console.log("🔍 开始获取试验列表:",t.name);const a=performance.now();try{console.log("📊 尝试获取轻量级试验摘要...");const C=yield q.get(`/api/optimization/jobs/${t.id}/trials-summary`),N=performance.now();if(console.log(`✅ 轻量级试验摘要耗时: ${(N-a).toFixed(0)}ms`),C.data&&C.data.status==="success"){console.log(`📊 获取到 ${C.data.data.length} 个试验摘要`),et(C.data.data),oe(!0);return}}catch(C){console.warn("⚠️ 轻量级摘要API失败，使用完整数据:",C)}console.log("📋 获取完整试验数据...");const u=performance.now(),p=yield q.get(`/api/optimization/jobs/${t.id}/trials`),M=performance.now();console.log(`📊 完整试验数据耗时: ${(M-u).toFixed(0)}ms`),p.data&&p.data.status==="success"?(console.log(`📊 获取到 ${p.data.data.length} 个完整试验结果`),et(p.data.data),oe(!0)):d.error("获取试验数据失败")}catch(a){console.error("获取试验数据失败:",a),d.error("获取试验数据失败")}finally{$(!1)}}),at=(t,a=!1)=>It(void 0,null,function*(){var u,p;try{if(t.status==="running"&&!a){d.error("运行中的任务不能删除，请先停止任务");return}const M=a?`/api/optimization/jobs/${t.id}?force=true`:`/api/optimization/jobs/${t.id}`,C=yield q.delete(M);C.data&&C.data.status==="success"?(d.success(C.data.message||"删除成功"),yield st()):d.error("删除失败")}catch(M){console.error("删除优化任务失败:",M);const C=((p=(u=M.response)==null?void 0:u.data)==null?void 0:p.detail)||M.message||"删除失败";d.error(C)}}),Re=t=>It(void 0,null,function*(){try{$(!0),W(t),console.log("🚀 开始获取任务详情:",t.name);const a=performance.now();if(t.best_parameters&&t.status==="completed"&&t.optimization_config){try{console.log("📊 尝试获取轻量级性能指标...");const X=yield q.get(`/api/optimization/jobs/${t.id}/best-performance`);if(X.data&&X.data.status==="success"){const re=performance.now();console.log(`✅ 使用轻量级API，耗时: ${(re-a).toFixed(0)}ms`);const S=X.data.data,de={total_return:S.total_return,annual_return:S.annual_return,sharpe_ratio:S.sharpe_ratio,max_drawdown:S.max_drawdown,win_rate:S.win_rate,profit_factor:S.profit_factor,alpha:S.alpha,beta:S.beta,total_trades:S.total_trades,parameters:S.parameters,fromOptimization:!0,isLightweight:!0};Ve(de),he(!0),$(!1);return}}catch(X){console.warn("⚠️ 轻量级API失败，尝试完整数据:",X)}try{console.log("📊 尝试获取完整回测结果...");const X=yield q.get(`/api/optimization/jobs/${t.id}/trials`);if(X.data&&X.data.status==="success"&&X.data.data.length>0){const re=X.data.data[0];if(re.backtest_results){const S=performance.now();console.log(`✅ 使用完整缓存结果，耗时: ${(S-a).toFixed(0)}ms`);const de=$s(gs({},re.backtest_results),{fromOptimization:!0});Ve(de),he(!0),$(!1);return}else console.warn("⚠️ 最佳试验没有缓存的回测结果")}}catch(X){console.warn("❌ 无法获取优化试验数据，将重新运行回测:",X)}console.log("🔄 缓存未命中，重新运行回测...");const u=performance.now(),p=t.optimization_config.backtest_config,M={strategy_id:t.strategy_id,parameters:t.best_parameters,symbol:p.symbol,start_date:p.start_date,end_date:p.end_date,initial_capital:p.initial_capital};console.log("📋 回测请求参数:",M);const C=yield q.post("/api/strategies/backtest",M),N=performance.now();console.log(`⏱️ 重新回测耗时: ${(N-u).toFixed(0)}ms`),C.data&&C.data.status==="success"?Ve(C.data.data):(console.error("回测失败:",C.data),d.error("回测失败，无法获取详细结果"))}else t.status==="completed"&&d.warning("优化配置信息不完整，无法重现回测结果");he(!0)}catch(a){console.error("获取任务详情失败:",a),d.error("获取任务详情失败")}finally{$(!1)}}),Ge=t=>It(void 0,null,function*(){if(!o){d.error("请先选择策略");return}if(m.length===0){d.error("请先配置参数空间");return}try{$(!0);const a={strategy_id:o,name:t.name,description:t.description,parameter_spaces:m,objective_function:t.objective_function,n_trials:t.n_trials,timeout:t.timeout,backtest_config:{symbol:t.symbol,start_date:t.start_date.format("YYYY-MM-DD"),end_date:t.end_date.format("YYYY-MM-DD"),initial_capital:t.initial_capital}};yield q.post("/api/optimization/optimize",a),d.success("优化任务已启动"),pe(!1),Q.resetFields(),st(o)}catch(a){console.error("启动优化任务失败:",a),d.error("启动优化任务失败")}finally{$(!1)}}),nt=t=>It(void 0,null,function*(){try{if($(!0),t.backtest_results&&t.backtest_results.logs&&t.backtest_results.logs.length>0){console.log("📋 使用当前记录中的日志"),Pe(t.backtest_results.logs),tt(!0);return}console.log("🔍 获取完整试验数据以获取日志...");const a=yield q.get(`/api/optimization/jobs/${b==null?void 0:b.id}/trials`);if(a.data&&a.data.status==="success"){const p=a.data.data.find(M=>M.trial_number===t.trial_number||M.id===t.id||M.parameters&&t.parameters&&JSON.stringify(M.parameters)===JSON.stringify(t.parameters));p&&p.backtest_results&&p.backtest_results.logs?(console.log(`📋 找到完整试验数据，日志条数: ${p.backtest_results.logs.length}`),Pe(p.backtest_results.logs),tt(!0)):d.warning("该试验暂无日志数据")}else d.error("获取试验日志失败")}catch(a){console.error("获取试验日志失败:",a),d.error("获取试验日志失败")}finally{$(!1)}}),Ne=[{title:"ID",dataIndex:"id",key:"id",width:50,align:"center"},{title:"任务名称",dataIndex:"name",key:"name",width:160,ellipsis:!0},{title:"策略",dataIndex:"strategy_id",key:"strategy",width:120,ellipsis:{showTitle:!1},render:t=>{const a=n.find(u=>u.id===t);return a?e.jsx(Se,{title:a.name,placement:"topLeft",children:e.jsx(Le,{color:"blue",style:{margin:0,maxWidth:"100px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"inline-block",cursor:"pointer"},children:a.name})}):e.jsx(Xe,{type:"secondary",style:{fontSize:"12px"},children:"未知策略"})}},{title:"状态",dataIndex:"status",key:"status",width:70,align:"center",render:t=>{const u={running:{color:"processing",text:"运行中"},completed:{color:"success",text:"已完成"},failed:{color:"error",text:"失败"},cancelled:{color:"default",text:"已取消"}}[t]||{color:"default",text:t};return e.jsx(Le,{color:u.color,children:u.text})}},{title:"进度",dataIndex:"progress",key:"progress",width:90,render:(t,a)=>{const u=`${a.completed_trials}/${a.total_trials}`,p=`${t.toFixed(1)}%`;return e.jsx(Se,{title:e.jsxs("div",{children:[e.jsxs("div",{children:["已完成试验: ",a.completed_trials]}),e.jsxs("div",{children:["总试验数: ",a.total_trials]}),e.jsxs("div",{children:["完成进度: ",t.toFixed(1),"%"]})]}),placement:"topLeft",children:e.jsxs("div",{style:{width:"80px",textAlign:"center"},children:[e.jsx(dr,{percent:t,size:"small",style:{marginBottom:"1px"},showInfo:!1}),e.jsxs("div",{style:{fontSize:"10px",color:"#666",lineHeight:"1.2"},children:[u," (",p,")"]})]})})}},{title:"最佳得分",dataIndex:"best_score",key:"best_score",width:100,align:"center",render:(t,a)=>{if(!t)return"-";const p={sharpe_ratio:"夏普比率",total_return:"总收益率",annual_return:"年化收益率"}[a.objective_function]||"得分";return e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",color:"#1890ff"},children:t.toFixed(4)}),e.jsx(Xe,{type:"secondary",style:{fontSize:"11px"},children:p})]})}},{title:"交易配置",dataIndex:"optimization_config",key:"trading_config",width:110,align:"center",render:t=>{if(!t||!t.backtest_config)return"-";const{symbol:a,initial_capital:u}=t.backtest_config;return e.jsxs("div",{children:[e.jsx(Le,{color:"green",style:{marginBottom:"2px"},children:a}),e.jsxs("div",{style:{fontSize:"11px",color:"#666"},children:["¥",(u==null?void 0:u.toLocaleString())||"N/A"]})]})}},{title:"回测时间段",dataIndex:"optimization_config",key:"date_range",width:140,render:t=>{if(!t||!t.backtest_config)return"-";const{start_date:a,end_date:u}=t.backtest_config;return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a}),e.jsx("div",{style:{fontSize:"10px",color:"#999",margin:"2px 0"},children:"至"}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:u})]})}},{title:"最佳参数",dataIndex:"best_parameters",key:"best_parameters",width:200,render:t=>{if(!t)return"-";const a=Object.entries(t),u=3,p=a.slice(0,u),M=a.length-u;return e.jsxs("div",{style:{maxHeight:"60px",overflow:"hidden"},children:[p.map(([C,N])=>e.jsxs(Le,{color:"blue",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:[C==="short_window"?"短期":C==="long_window"?"长期":C==="min_reversal_points"?"反转点":C==="lookback_period"?"回望期":C==="signal_strength_threshold"?"信号阈值":C==="batch_count"?"批次数":C==="stop_loss_ratio"?"止损":C==="take_profit_ratio"?"止盈":C,": ",typeof N=="number"?N.toFixed(2):N]},C)),M>0&&e.jsxs(Le,{color:"default",style:{marginBottom:"2px",fontSize:"10px",padding:"1px 4px",lineHeight:"16px"},children:["+",M,"个"]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:140,render:t=>{const a=I.utc(t).tz("Asia/Shanghai");return e.jsxs("div",{style:{lineHeight:"1.2"},children:[e.jsx("div",{style:{fontSize:"11px"},children:a.format("YYYY-MM-DD")}),e.jsx("div",{style:{fontSize:"11px",color:"#666"},children:a.format("HH:mm:ss")})]})}},{title:"操作",key:"action",width:100,align:"center",render:(t,a)=>{const u=I.utc(a.created_at).tz("Asia/Shanghai"),p=a.status==="running"&&I().diff(u,"hour")>=1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx(P,{type:"link",icon:e.jsx(qs,{}),onClick:()=>Re(a),size:"small",disabled:a.status!=="completed",style:{padding:"2px 8px",height:"auto",fontSize:"12px"},children:"查看回测"}),e.jsx(P,{type:"link",onClick:()=>Fe(a),size:"small",disabled:a.status!=="completed",style:{color:"#1890ff",padding:"2px 8px",height:"auto",fontSize:"12px"},children:"其他回测"}),e.jsx(ur,{title:"确认删除",description:p?`检测到异常状态，确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`:`确定要删除优化任务 "${a.name}" 吗？此操作不可恢复。`,onConfirm:()=>at(a,p),okText:"确定",cancelText:"取消",disabled:a.status==="running"&&!p,placement:"top",children:e.jsx(P,{danger:!0,size:"small",disabled:a.status==="running"&&!p,icon:e.jsx(us,{}),style:gs({padding:"2px 8px",height:"auto",fontSize:"12px"},p&&{borderColor:"#ff7875",color:"#ff7875"}),children:p?"强制删除":"删除"})})]})}}];return l.useEffect(()=>{T.current||(T.current=!0,vt(),st(),pt(),ft("AAPL"))},[]),e.jsxs("div",{style:{padding:"16px",height:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs(le,{style:{marginBottom:"16px",flexShrink:0},children:[e.jsx(_n,{level:3,style:{margin:"0 0 16px 0"},children:"策略参数优化"}),e.jsxs(Z,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(f,{span:8,children:e.jsx(Ye,{placeholder:"选择策略",style:{width:"100%"},value:o,onChange:Ke,children:n.map(t=>e.jsx(Ut,{value:t.id,children:t.name},t.id))})}),e.jsx(f,{span:16,children:e.jsxs(De,{children:[e.jsx(P,{icon:e.jsx(bs,{}),onClick:()=>ze(!0),disabled:!o,children:"配置参数空间"}),e.jsx(P,{type:"primary",icon:e.jsx(Gt,{}),onClick:()=>{pe(!0),We(!1),setTimeout(()=>bt(),100)},disabled:!o||m.length===0,children:"启动优化"}),e.jsx(P,{icon:e.jsx(Bs,{}),onClick:()=>{console.log("刷新按钮被点击"),st(o||void 0)},children:"刷新"})]})})]})]}),e.jsx(le,{title:"优化任务列表",style:{flex:1,display:"flex",flexDirection:"column",minHeight:0},styles:{body:{flex:1,padding:"16px",display:"flex",flexDirection:"column",minHeight:0}},children:e.jsx(Jt,{columns:Ne,dataSource:D,rowKey:"id",loading:g,size:"small",scroll:{x:1200,y:"calc(100vh - 320px)"},pagination:{pageSize:it.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条记录`,size:"small",onChange:(t,a)=>{it.setCurrentPage(t),it.setPageSize(a||20)},onShowSizeChange:(t,a)=>{it.setPageSize(a)}},style:{flex:1}})}),e.jsxs(Be,{title:"配置参数空间",open:B,onOk:ne,onCancel:()=>ze(!1),width:900,confirmLoading:g,children:[e.jsx(gt,{message:"MA交叉策略参数优化指南",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"short_window"}),": 短期移动平均线周期，建议范围 3-15天"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"long_window"}),": 长期移动平均线周期，建议范围 10-60天"]}),e.jsx("p",{children:"注意：短期周期必须小于长期周期"})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(P,{type:"dashed",onClick:k,icon:e.jsx(Da,{}),block:!0,children:"添加参数"})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsxs(De,{children:[e.jsx(P,{type:"link",onClick:()=>{w([{parameter_name:"short_window",parameter_type:"int",min_value:3,max_value:15,step_size:1,description:"短期移动平均线周期"},{parameter_name:"long_window",parameter_type:"int",min_value:10,max_value:60,step_size:5,description:"长期移动平均线周期"}])},children:"📊 使用MA策略推荐配置"}),e.jsx(P,{type:"link",onClick:G,children:"🔎 自动识别策略参数"})]})}),m.map((t,a)=>e.jsx(le,{size:"small",style:{marginBottom:"8px"},children:e.jsxs(Z,{gutter:[8,8],children:[e.jsx(f,{span:4,children:e.jsx(ke,{placeholder:"参数名",value:t.parameter_name,onChange:u=>_(a,"parameter_name",u.target.value)})}),e.jsx(f,{span:3,children:e.jsxs(Ye,{value:t.parameter_type==="choice"&&V(t.choices)?"boolean":t.parameter_type,onChange:u=>{const p=String(u);p==="boolean"?(_(a,"parameter_type","choice"),_(a,"choices",[!0,!1]),t.description||_(a,"description","布尔类型")):_(a,"parameter_type",p)},style:{width:"100%"},children:[e.jsx(Ut,{value:"int",children:"整数"}),e.jsx(Ut,{value:"float",children:"小数"}),e.jsx(Ut,{value:"choice",children:"选择"}),e.jsx(Ut,{value:"boolean",children:"布尔"})]})}),t.parameter_type!=="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(f,{span:3,children:e.jsx(Vt,{placeholder:"最小值",value:t.min_value,onChange:u=>_(a,"min_value",u),style:{width:"100%"}})}),e.jsx(f,{span:3,children:e.jsx(Vt,{placeholder:"最大值",value:t.max_value,onChange:u=>_(a,"max_value",u),style:{width:"100%"}})})]}),t.parameter_type==="choice"&&e.jsxs(e.Fragment,{children:[e.jsx(f,{span:6,children:e.jsx(Ye,{mode:"tags",style:{width:"100%"},placeholder:"备选项（输入后回车添加）",value:(t.choices||[]).map(u=>typeof u=="boolean"?u?"true":"false":String(u)),onChange:u=>{const p=u.map(M=>{if(typeof M=="string"){const C=M.trim();if(C.toLowerCase()==="true")return!0;if(C.toLowerCase()==="false")return!1;const N=Number(C);return isNaN(N)?C:N}return M});_(a,"choices",p)}})}),e.jsx(f,{span:3,children:e.jsx(P,{onClick:()=>_(a,"choices",[!0,!1]),style:{width:"100%"},children:"填充布尔(True/False)"})})]}),e.jsx(f,{span:4,children:e.jsx(ke,{placeholder:"描述",value:t.description,onChange:u=>_(a,"description",u.target.value)})}),e.jsx(f,{span:2,children:e.jsx(P,{type:"text",danger:!0,icon:e.jsx(us,{}),onClick:()=>x(a)})})]})},a))]}),e.jsxs(Be,{title:"启动参数优化",open:Te,onOk:()=>Q.submit(),onCancel:()=>pe(!1),width:700,confirmLoading:g,children:[e.jsx(gt,{message:"优化说明",description:"系统将自动测试不同参数组合，找到最优的策略参数。建议先用较少试验次数快速测试。",type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(F,{form:Q,onFinish:Ge,layout:"vertical",children:[e.jsx(F.Item,{name:"name",label:"任务名称",rules:[{required:!0,message:"请输入任务名称"}],children:e.jsx(ke,{placeholder:"如: AAPL_20240101_MA策略优化",onChange:t=>{t.target.value!==Ae()?We(!0):We(!1)}})}),e.jsx(F.Item,{name:"description",label:"任务描述",children:e.jsx(ke.TextArea,{placeholder:"描述此次优化的目的和预期...",rows:2})}),e.jsxs(Z,{gutter:[16,16],children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"objective_function",label:"优化目标",initialValue:"sharpe_ratio",children:e.jsxs(Ye,{children:[e.jsx(Ut,{value:"sharpe_ratio",children:"夏普比率 (推荐)"}),e.jsx(Ut,{value:"total_return",children:"总收益率"}),e.jsx(Ut,{value:"annual_return",children:"年化收益率"})]})})}),e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"n_trials",label:"试验次数",initialValue:50,extra:"建议: 快速测试50次，详细优化100-200次",children:e.jsx(Vt,{min:10,max:1e3,style:{width:"100%"}})})})]}),e.jsxs(Z,{gutter:[16,16],children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"symbol",label:"交易品种",rules:[{required:!0,message:"请选择交易品种"}],initialValue:"AAPL",children:e.jsx(Ye,{placeholder:"选择股票代码",showSearch:!0,filterOption:(t,a)=>{var u,p;return((u=a==null?void 0:a.label)!=null?u:"").toLowerCase().includes(t.toLowerCase())||((p=a==null?void 0:a.value)!=null?p:"").toLowerCase().includes(t.toLowerCase())},onChange:t=>{t&&(ft(t),bt())},options:zt.map(t=>({value:t.symbol,label:`${t.symbol} - ${t.name}`}))})})}),e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"initial_capital",label:"初始资金",initialValue:1e5,children:e.jsx(Vt,{min:1e3,style:{width:"100%"},formatter:t=>`¥ ${t}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:t=>t==null?void 0:t.replace(/¥\s?|(,*)/g,"")})})})]}),e.jsx(F.Item,{label:"快捷时间选择",children:e.jsxs(De,{wrap:!0,children:[e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent1y"),children:"最近1年"}),e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent3y"),children:"最近3年"}),e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent5y"),children:"最近5年"}),e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent6y"),children:"最近6年"}),e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent7y"),children:"最近7年"}),e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent8y"),children:"最近8年"}),e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent9y"),children:"最近9年"}),e.jsx(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("recent10y"),children:"最近10年"}),ye.min_date&&ye.max_date&&e.jsxs(P,{size:"small",icon:e.jsx(qt,{}),onClick:()=>He("full"),type:"primary",children:["全部数据 (",ye.min_date," ~ ",ye.max_date,")"]})]})}),e.jsxs(Z,{gutter:[16,16],children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"start_date",label:"开始日期",rules:[{required:!0,message:"请选择开始日期"}],initialValue:I("2023-01-01"),children:e.jsx(Zt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择开始日期"})})}),e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"end_date",label:"结束日期",rules:[{required:!0,message:"请选择结束日期"}],initialValue:I("2024-12-31"),children:e.jsx(Zt,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"选择结束日期"})})})]}),e.jsx(gt,{message:"注意事项",description:e.jsxs("ul",{style:{margin:0,paddingLeft:"20px"},children:[e.jsx("li",{children:"确保已配置参数空间"}),e.jsx("li",{children:"优化过程可能需要几分钟到几小时"}),e.jsx("li",{children:"可以在任务列表中查看进度"})]}),type:"warning",showIcon:!0})]})]}),e.jsx(Be,{title:"优化任务详情",open:U,onCancel:()=>{he(!1),W(null),Ve(null)},footer:null,width:1e3,children:b&&e.jsxs("div",{children:[e.jsx(gt,{message:`任务状态: ${b.status==="completed"?"已完成":b.status}`,type:b.status==="completed"?"success":"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsxs(ps,{defaultActiveKey:"1",children:[e.jsxs(pa,{tab:"基本信息",children:[e.jsxs(Z,{gutter:[16,16],children:[e.jsxs(f,{span:12,children:[e.jsx(Xe,{strong:!0,children:"任务名称: "}),e.jsx(Xe,{children:b.name})]}),e.jsxs(f,{span:12,children:[e.jsx(Xe,{strong:!0,children:"优化目标: "}),e.jsx(Xe,{children:b.objective_function==="sharpe_ratio"?"夏普比率":b.objective_function==="total_return"?"总收益率":b.objective_function==="annual_return"?"年化收益率":"未知"})]}),e.jsxs(f,{span:12,children:[e.jsx(Xe,{strong:!0,children:"试验次数: "}),e.jsxs(Xe,{children:[b.completed_trials,"/",b.total_trials]})]}),e.jsxs(f,{span:12,children:[e.jsx(Xe,{strong:!0,children:"最佳得分: "}),e.jsx(Xe,{children:b.best_score?b.best_score.toFixed(4):"-"})]})]}),b.optimization_config&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Xe,{strong:!0,children:"回测配置:"}),e.jsxs(Z,{gutter:[16,8],style:{marginTop:"8px"},children:[e.jsxs(f,{span:12,children:[e.jsx(Xe,{type:"secondary",children:"交易品种: "}),e.jsx(Le,{color:"green",children:b.optimization_config.backtest_config.symbol})]}),e.jsxs(f,{span:12,children:[e.jsx(Xe,{type:"secondary",children:"初始资金: "}),e.jsxs(Le,{color:"blue",children:["¥",b.optimization_config.backtest_config.initial_capital.toLocaleString()]})]}),e.jsxs(f,{span:12,children:[e.jsx(Xe,{type:"secondary",children:"开始日期: "}),e.jsx(Le,{children:b.optimization_config.backtest_config.start_date})]}),e.jsxs(f,{span:12,children:[e.jsx(Xe,{type:"secondary",children:"结束日期: "}),e.jsx(Le,{children:b.optimization_config.backtest_config.end_date})]})]})]}),b.best_parameters&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(Xe,{strong:!0,children:"最优参数组合:"}),e.jsx("div",{style:{marginTop:"8px",maxHeight:"120px",overflowY:"auto"},children:Object.entries(b.best_parameters).map(([t,a])=>e.jsxs(Le,{color:"blue",style:{marginBottom:"4px",marginRight:"4px",fontSize:"11px",padding:"2px 6px"},children:[t==="short_window"?"短期均线":t==="long_window"?"长期均线":t==="min_reversal_points"?"反转点数":t==="lookback_period"?"回望周期":t==="min_price_change"?"最小价格变化":t==="signal_strength_threshold"?"信号强度阈值":t==="max_trading_range"?"最大交易范围":t==="batch_count"?"分批次数":t==="batch_interval"?"分批间隔":t==="position_size_per_batch"?"分批仓位":t==="stop_loss_ratio"?"止损比例":t==="take_profit_ratio"?"止盈比例":t==="rsi_oversold"?"RSI超卖":t==="rsi_overbought"?"RSI超买":t==="volume_threshold"?"成交量阈值":t==="max_extremums"?"最大极值点":t==="min_extremum_distance"?"极值点距离":t,": ",typeof a=="number"?a.toFixed(2):a]},t))})]})]},"1"),e.jsx(pa,{tab:"回测结果",children:y?e.jsxs("div",{children:[e.jsxs(Z,{gutter:[16,16],children:[e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"总收益率",value:y.total_return*100,precision:2,suffix:"%",valueStyle:{color:y.total_return>=0?"#3f8600":"#cf1322"}})})}),e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"年化收益率",value:y.annual_return*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"最大回撤",value:y.max_drawdown*100,precision:2,suffix:"%",valueStyle:{color:"#3f8600"}})})}),e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"夏普比率",value:y.sharpe_ratio,precision:3,valueStyle:{color:y.sharpe_ratio>=1?"#3f8600":"#cf1322"}})})})]}),e.jsxs(Z,{gutter:[16,16],style:{marginTop:"16px"},children:[e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"胜率",value:y.win_rate*100,precision:2,suffix:"%",valueStyle:{color:y.win_rate>=.5?"#3f8600":"#cf1322"}})})}),e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"盈亏比",value:y.profit_factor,precision:2,valueStyle:{color:y.profit_factor>=1?"#3f8600":"#cf1322"}})})}),e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"交易次数",value:y.trades?y.trades.length:0,valueStyle:{color:"#1890ff"}})})}),e.jsx(f,{span:6,children:e.jsx(le,{size:"small",children:e.jsx(ge,{title:"Alpha",value:y.alpha,precision:4,valueStyle:{color:y.alpha>=0?"#3f8600":"#cf1322"}})})})]}),e.jsx(gt,{message:"参数说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"夏普比率"}),": 风险调整后收益，",">"," 1.0为优秀，",">"," 2.0为卓越"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"胜率"}),": 盈利交易占总交易的比例，",">"," 50%为良好"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"盈亏比"}),": 平均盈利/平均亏损，",">"," 1.0表示盈利大于亏损"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Alpha"}),": 相对于市场的超额收益，",">"," 0表示跑赢市场"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]}):e.jsx("div",{style:{textAlign:"center",padding:"40px"},children:e.jsx(Xe,{type:"secondary",children:"加载回测结果中..."})})},"2")]})]})}),e.jsx(Be,{title:"所有回测试验结果",open:$e,onCancel:()=>{oe(!1),et([]),W(null)},footer:null,width:1e3,children:b&&e.jsxs("div",{children:[e.jsx(gt,{message:`任务: ${b.name} - 共${Oe.length}个试验，按得分降序排列`,type:"info",showIcon:!0,style:{marginBottom:"16px"}}),e.jsx(Jt,{dataSource:Oe,rowKey:t=>t.id||t.trial_number||Math.random(),pagination:!1,size:"small",scroll:{y:400},columns:[{title:"排名",key:"rank",width:60,render:(t,a,u)=>{const p=a.rank||u+1;return e.jsx(Le,{color:p===1?"gold":p===2?"silver":p===3?"orange":"default",children:p})}},{title:"得分",dataIndex:"objective_value",key:"objective_value",width:100,render:t=>e.jsx(Xe,{strong:!0,style:{color:"#1890ff"},children:t?t.toFixed(4):"-"}),sorter:(t,a)=>(t.objective_value||0)-(a.objective_value||0),defaultSortOrder:"descend"},{title:"参数组合",dataIndex:"parameters",key:"parameters",width:200,render:t=>e.jsx("div",{children:Object.entries(t||{}).map(([a,u])=>e.jsxs(Le,{color:"blue",style:{marginBottom:"2px"},children:[a==="short_window"?"短期":a==="long_window"?"长期":a,": ",u]},a))})},{title:"年化收益",dataIndex:"annual_return",key:"annual_return",width:90,render:t=>{if(t==null)return"-";const a=t>=0?"#3f8600":"#cf1322";return e.jsxs(Xe,{style:{color:a,fontWeight:"bold"},children:[(t*100).toFixed(1),"%"]})}},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",width:90,render:t=>t==null?"-":e.jsxs(Xe,{style:{color:"#3f8600",fontWeight:"bold"},children:[(Math.abs(t)*100).toFixed(1),"%"]})},{title:"交易次数",dataIndex:"total_trades",key:"total_trades",width:80,render:t=>e.jsx(Xe,{type:"secondary",children:t||0})},{title:"执行时间",dataIndex:"execution_time",key:"execution_time",width:80,render:t=>e.jsx(Xe,{type:"secondary",children:t?`${(t*1e3).toFixed(0)}ms`:"-"})},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:150,render:t=>t?I.utc(t).tz("Asia/Shanghai").format("HH:mm:ss"):"-"},{title:"日志",key:"logs",width:80,render:(t,a)=>e.jsx(Se,{title:"查看日志",children:e.jsx(P,{type:"text",size:"small",icon:e.jsx(Ms,{}),onClick:()=>nt(a),style:{color:"#1890ff"}})})}]}),e.jsx(gt,{message:"说明",description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"排名"}),": 按优化目标得分排序，金牌为最佳结果"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"得分"}),": ",b.objective_function==="sharpe_ratio"?"夏普比率":b.objective_function==="total_return"?"总收益率":b.objective_function==="annual_return"?"年化收益率":"优化目标","得分"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"参数组合"}),": 该试验使用的策略参数"]})]}),type:"info",showIcon:!0,style:{marginTop:"16px"}})]})}),e.jsx(Be,{title:"试验日志",open:ie,onCancel:()=>tt(!1),footer:null,width:800,style:{top:20},children:e.jsx("div",{style:{maxHeight:"600px",overflow:"auto"},children:se&&se.length>0?e.jsx("div",{style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px"},children:se.map((t,a)=>{var u;const p=M=>{switch(M==null?void 0:M.toUpperCase()){case"ERROR":return"#ff4d4f";case"WARNING":return"#faad14";case"DEBUG":return"#722ed1";case"INFO":default:return"#1890ff"}};return e.jsxs("div",{style:{marginBottom:"4px",padding:"2px 4px",backgroundColor:"#f5f5f5",borderRadius:"2px"},children:[e.jsx("span",{style:{color:"#666",marginRight:"8px"},children:t.timestamp?I(t.timestamp).format("HH:mm:ss.SSS"):""}),e.jsxs("span",{style:{color:p(t.level),fontWeight:"bold",marginRight:"8px",minWidth:"60px",display:"inline-block"},children:["[",((u=t.level)==null?void 0:u.toUpperCase())||"INFO","]"]}),e.jsx("span",{style:{color:"#333"},children:t.message})]},a)})}):e.jsx("div",{style:{textAlign:"center",padding:"40px",color:"#999"},children:"暂无日志数据"})})})]})},Sn=l.memo(wn);var Pt=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});const{RangePicker:kn}=Zt,{Option:ot}=Ye,{Text:Ot}=Rt,$n={deepseek:"#3b7ddd",qwen:"#52c41a",kimi:"#faad14"},ha=["#3b7ddd","#52c41a","#fa8c16","#13c2c2","#eb2f96"],ma=["你是一个专注于股票量化交易的金融大模型，充当价格预测引擎。","","你的任务是根据输入的K线数据、账户状态和最近成交记录，预测下一根K线的收盘价。","","要求：","1）只能输出一个数字，不要任何文字、解释、符号或单位；","2）数字应为合理的价格水平，不为负数，尽量接近当前价格量级；","3）可以保留2到6位小数；","4）充分利用给出的周期、买入/卖出阈值、止损和止盈参数来判断趋势和风险；","5）只使用输入的数据进行推断，不要编造外部信息或新闻；","6）如果历史数据较少，也要给出尽可能稳健的预测，而不是报错。"].join(`
`),In=()=>{var n,r,o;const[j]=F.useForm(),[m,w]=l.useState([]),[D,z]=l.useState(!1),[g,$]=l.useState(!1),[T,Q]=l.useState(null),[B,ze]=l.useState([]),[Te,pe]=l.useState(!1),[U,he]=l.useState({}),[b,W]=l.useState({}),[y,Ve]=l.useState([]),[$e,oe]=l.useState([]),[Oe,et]=l.useState(!1),[ie,tt]=l.useState("deepseek"),[se,Pe]=l.useState(""),[ye,rt]=l.useState(!1),[zt,ct]=l.useState(!1),[qe,We]=l.useState(!1),[Ae,bt]=l.useState(null),[vt,pt]=l.useState([]),[ft,He]=l.useState(!1),[yt,st]=l.useState(1),[Ke,k]=l.useState(50),[x,_]=l.useState(0),[V,ne]=l.useState(),[G,Fe]=l.useState(),[at,Re]=l.useState(""),[Ge,nt]=l.useState(),[Ne,t]=l.useState(null),[a,u]=l.useState(!1),[p,M]=l.useState(""),C=F.useWatch("data_source",j)||"database",N=l.useMemo(()=>C==="database"?[{value:"1d",label:"日线"}]:[{value:"1m",label:"1分钟"},{value:"5m",label:"5分钟"},{value:"15m",label:"15分钟"},{value:"30m",label:"30分钟"},{value:"60m",label:"60分钟"}],[C]),X=l.useMemo(()=>{const h=new Set;return Object.keys(U||{}).forEach(L=>h.add(L)),Object.keys(b||{}).forEach(L=>h.add(L)),B.forEach(L=>h.add(L.model_type)),Array.from(h)},[U,b,B]),re=h=>{const L=X.indexOf(h);return $n[h]||ha[(L>=0?L:0)%ha.length]},S=()=>Pt(void 0,null,function*(){z(!0);try{const L=(yield q.get("/api/ai-investment/runs")).data||[];return w(L),L}catch(h){d.error((h==null?void 0:h.message)||"获取AI投资运行列表失败")}finally{z(!1)}}),de=h=>Pt(void 0,null,function*(){pe(!0);try{const L=yield q.get(`/api/ai-investment/run/${h}/records`);ze(L.data||[])}catch(L){d.error((L==null?void 0:L.message)||"获取AI投资预测明细失败")}finally{pe(!1)}}),Me=h=>Pt(void 0,null,function*(){yield de(h.id)}),ae=(h,...L)=>Pt(void 0,[h,...L],function*(O,be=yt,Ce=Ke,ce){var xe,fe,ht;He(!0);try{const Qe={page:be,size:Ce},Mt=(xe=ce==null?void 0:ce.level)!=null?xe:V,Nt=(fe=ce==null?void 0:ce.category)!=null?fe:G,At=(ht=ce==null?void 0:ce.keyword)!=null?ht:at,St=(ce==null?void 0:ce.recordId)!==void 0?ce.recordId:Ge;Mt&&(Qe.level=Mt),Nt&&(Qe.category=Nt),At&&(Qe.keyword=At),St!==void 0&&(Qe.record_id=St);const te=yield q.get(`/api/ai-investment/run/${O}/logs`,{params:Qe});pt(te.data.items||[]),_(te.data.total||0),st(be),k(Ce),(ce==null?void 0:ce.level)!==void 0&&ne(ce.level),(ce==null?void 0:ce.category)!==void 0&&Fe(ce.category),(ce==null?void 0:ce.keyword)!==void 0&&Re(ce.keyword||""),(ce==null?void 0:ce.recordId)!==void 0&&nt(ce.recordId)}catch(Qe){d.error((Qe==null?void 0:Qe.message)||"获取运行日志失败")}finally{He(!1)}}),Ie=h=>Pt(void 0,null,function*(){rt(!0);try{const O=(yield q.get("/api/ai-investment/prompt-settings",{params:{model_type:h}})).data||[];O.length>0?Pe(O[0].system_prompt||""):Pe(ma)}catch(L){d.error((L==null?void 0:L.message)||"加载AI提示词失败"),Pe(ma)}finally{rt(!1)}});l.useEffect(()=>{S(),Ie(ie),(()=>Pt(void 0,null,function*(){et(!0);try{const L=yield vs();oe(L)}catch{}finally{et(!1)}}))()},[]),l.useEffect(()=>{j.getFieldValue("frequency")||(C==="database"?j.setFieldsValue({frequency:"1d"}):j.setFieldsValue({frequency:"1m"}))},[C,j]),l.useEffect(()=>{Ie(ie)},[ie]);const E=()=>Pt(void 0,null,function*(){var h,L,O,be,Ce,ce,xe;try{const fe=yield j.validateFields(),ht=fe.symbol,Qe=fe.timeRange,Mt=fe.models||[];if(!ht||!Qe||Mt.length===0){d.warning("请填写股票代码、时间范围并选择至少一个模型");return}const Nt=Qe[0].toDate().toISOString(),At=Qe[1].toDate().toISOString(),St=fe.data_source||"database",te=fe.frequency||(St==="database"?"1d":"1m"),s={name:fe.name||void 0,symbol:ht,start_time:Nt,end_time:At,data_source:St,frequency:te,models:Mt,initial_capital:fe.initial_capital||1e5,buy_threshold:(h=fe.buy_threshold)!=null?h:.002,sell_threshold:(L=fe.sell_threshold)!=null?L:-.002,stop_loss_pct:(O=fe.stop_loss_pct)!=null?O:.05,take_profit_pct:(be=fe.take_profit_pct)!=null?be:.1,window:fe.window||20,commission_rate:(Ce=fe.commission_rate)!=null?Ce:.0015,slippage_rate:(ce=fe.slippage_rate)!=null?ce:.001};$(!0);const i=yield q.post("/api/ai-investment/run",s);if(i.data&&i.data.status==="success"){d.success("AI实时投资回放完成");const v=i.data;he(v.metrics||{}),W(v.equity_curves||{}),Ve(v.price_series||[]);const A=yield S();if(v.run_id&&(yield de(v.run_id),A&&Array.isArray(A))){const J=A.find(je=>je.id===v.run_id)||null;Q(J)}}else d.error(((xe=i.data)==null?void 0:xe.message)||"AI投资回放失败")}catch(fe){if(fe!=null&&fe.errorFields)return;d.error((fe==null?void 0:fe.message)||"AI投资回放执行失败")}finally{$(!1)}}),ee=()=>Pt(void 0,null,function*(){var h,L,O,be,Ce,ce;try{const xe=yield j.validateFields(["symbol","timeRange","data_source","frequency","models","initial_capital","buy_threshold","sell_threshold","stop_loss_pct","take_profit_pct","window"]),fe=xe.symbol,ht=xe.timeRange,Qe=xe.models||[];if(!fe||!ht||Qe.length===0){d.warning("请先填写股票代码、时间范围并选择至少一个模型");return}const Mt=ht[0].toDate().toISOString(),Nt=ht[1].toDate().toISOString(),At=xe.data_source||"database",St=xe.frequency||(At==="database"?"1d":"1m"),te={name:xe.name||void 0,symbol:fe,start_time:Mt,end_time:Nt,data_source:At,frequency:St,models:Qe,initial_capital:xe.initial_capital||1e5,buy_threshold:(h=xe.buy_threshold)!=null?h:.002,sell_threshold:(L=xe.sell_threshold)!=null?L:-.002,stop_loss_pct:(O=xe.stop_loss_pct)!=null?O:.05,take_profit_pct:(be=xe.take_profit_pct)!=null?be:.1,window:xe.window||20,commission_rate:(Ce=xe.commission_rate)!=null?Ce:.0015,slippage_rate:(ce=xe.slippage_rate)!=null?ce:.001};u(!0);const i=(yield q.post("/api/ai-investment/estimate-calls",te)).data,v=`${i.formula} = ${i.per_model_calls}`,A=`当前选择 ${i.model_count} 个模型，理论最大AI调用次数约为 ${i.total_calls} 次。`;M(`调用次数估算公式：${v}。${A}`)}catch(xe){if(xe!=null&&xe.errorFields)return;d.error((xe==null?void 0:xe.message)||"预估AI调用次数失败")}finally{u(!1)}}),Ee=()=>Pt(void 0,null,function*(){if(!ie){d.warning("请选择需要配置提示词的模型");return}if(!se||!se.trim()){d.warning("请输入系统提示词内容");return}ct(!0);try{yield q.post("/api/ai-investment/prompt-settings",{model_type:ie,scene:"ai_investment",system_prompt:se}),d.success("提示词已保存")}catch(h){d.error((h==null?void 0:h.message)||"保存提示词失败")}finally{ct(!1)}}),Ze=h=>{Q(h),Me(h)},dt=h=>Pt(void 0,null,function*(){var L;try{const O=yield q.post(`/api/ai-investment/run/${h.id}/resume`,{name:`${h.name}-续跑`});if(O.data&&O.data.status==="success"){d.success("续跑任务已完成");const be=O.data;he(be.metrics||{}),W(be.equity_curves||{}),Ve(be.price_series||[]);const Ce=yield S();if(be.run_id&&(yield de(be.run_id),Ce&&Array.isArray(Ce))){const ce=Ce.find(xe=>xe.id===be.run_id)||null;Q(ce)}}else d.error(((L=O.data)==null?void 0:L.message)||"续跑任务执行失败")}catch(O){d.error((O==null?void 0:O.message)||"续跑任务请求失败")}}),me=h=>Pt(void 0,null,function*(){try{const O=(yield q.get(`/api/ai-investment/run/${h.id}`)).data;if(O&&O.status==="success"){Q(h),he(O.metrics||{}),W(O.equity_curves||{}),Ve(O.price_series||[]);const be=O.config||{},Ce=be.start_time,ce=be.end_time,xe=Ce&&ce?[I(Ce),I(ce)]:void 0,fe={name:O.name||h.name,symbol:O.symbol||h.symbol,data_source:O.data_source,frequency:O.frequency,models:Array.isArray(O.models)&&O.models.length>0?O.models:h.models,initial_capital:O.initial_capital,buy_threshold:be.buy_threshold,sell_threshold:be.sell_threshold,stop_loss_pct:be.stop_loss_pct,take_profit_pct:be.take_profit_pct,window:be.window,commission_rate:be.commission_rate,slippage_rate:be.slippage_rate};xe&&(fe.timeRange=xe),Object.keys(fe).forEach(ht=>{const Qe=fe[ht];Qe==null&&delete fe[ht]}),Object.keys(fe).length>0&&j.setFieldsValue(fe),yield Me(h),d.success("已载入历史运行结果")}else d.error((O==null?void 0:O.message)||"载入历史运行结果失败")}catch(L){d.error((L==null?void 0:L.message)||"载入历史运行结果失败")}}),lt=h=>{bt(h),t(null),nt(void 0),ne(void 0),Fe(void 0),Re(""),We(!0),ae(h.id,1,Ke,{level:void 0,category:void 0,keyword:"",recordId:void 0})},ls=h=>{if(!T){d.warning("请先在左侧选择对应的运行记录");return}bt(T),t(h),ne(void 0),Fe("ai_call"),Re(""),nt(h.id),We(!0),ae(T.id,1,Ke,{category:"ai_call",recordId:h.id})},_t=l.useMemo(()=>{if(Ne)return vt.find(h=>h.category==="ai_call")},[vt,Ne]),Ue=[{title:"名称",dataIndex:"name",key:"name",width:200,ellipsis:!0},{title:"股票代码",dataIndex:"symbol",key:"symbol",width:100},{title:"模型",dataIndex:"models",key:"models",width:140,render:h=>e.jsx(De,{size:"small",children:(h||[]).map(L=>e.jsx(Le,{children:L},L))})},{title:"状态",dataIndex:"status",key:"status",width:100,render:h=>e.jsx(Le,{color:h==="completed"?"green":"blue",children:h})},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:180,render:h=>h?I(h).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"完成时间",dataIndex:"completed_at",key:"completed_at",width:180,render:h=>h?I(h).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"操作",key:"action",width:220,render:(h,L)=>e.jsxs(De,{size:"small",children:[e.jsx(P,{size:"small",icon:e.jsx(Ks,{}),onClick:O=>{O.stopPropagation(),lt(L)},children:"查看日志"}),e.jsx(P,{size:"small",icon:e.jsx(pr,{}),onClick:O=>{O.stopPropagation(),dt(L)},children:"继续运行"}),e.jsx(P,{size:"small",icon:e.jsx(Gt,{}),onClick:O=>{O.stopPropagation(),me(L)},children:"载入结果"})]})}],hs=[{title:"时间",dataIndex:"timestamp",key:"timestamp",render:h=>h?I(h).format("YYYY-MM-DD HH:mm"):"-"},{title:"模型",dataIndex:"model_type",key:"model_type"},{title:"预测价格",dataIndex:"predicted_price",key:"predicted_price",render:h=>h.toFixed(4)},{title:"实际价格",dataIndex:"actual_price",key:"actual_price",render:h=>h.toFixed(4)},{title:"操作",dataIndex:"action",key:"action",render:h=>{let L="default",O=h;return h==="BUY"?(L="red",O="买入"):h==="SELL"?(L="green",O="卖出"):h==="HOLD"&&(L="default",O="观望"),e.jsx(Le,{color:L,children:O})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:160,ellipsis:!0,render:h=>h||"—"},{title:"持仓",dataIndex:"position",key:"position",render:h=>h.toFixed(2)},{title:"单笔收益",dataIndex:"pnl",key:"pnl",render:h=>h.toFixed(2)},{title:"累计收益",dataIndex:"cumulative_pnl",key:"cumulative_pnl",render:h=>h.toFixed(2)},{title:"账户权益",dataIndex:"equity",key:"equity",render:h=>h.toFixed(2)},{title:"操作",key:"action",render:(h,L)=>e.jsx(P,{size:"small",icon:e.jsx(Ks,{}),onClick:()=>ls(L),children:"查看日志"})}],os=l.useMemo(()=>{const h=[],L=[];return Object.keys(b||{}).forEach(O=>{const Ce=(b[O]||[]).map(ce=>I(ce.date).format("YYYY-MM-DD HH:mm"));Ce.length>L.length&&L.splice(0,L.length,...Ce)}),Object.keys(b||{}).forEach(O=>{const Ce=(b[O]||[]).map(xe=>xe.equity),ce=re(O);h.push({type:"line",name:O,data:Ce,smooth:!0,lineStyle:{color:ce},itemStyle:{color:ce}})}),{tooltip:{trigger:"axis"},legend:{top:0},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:L},yAxis:{type:"value",scale:!0,name:"账户权益"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:h}},[b]),_s=l.useMemo(()=>{const h="YYYY-MM-DD HH:mm",L=[];if(y.length>0)y.forEach(te=>{L.push(I(te.date).format(h))});else if(B.length>0){const te=new Set;B.forEach(s=>{te.add(I(s.timestamp).format(h))}),Array.from(te).sort().forEach(s=>L.push(s))}if(L.length===0)return{tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{top:0,data:[]},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:[]},yAxis:{type:"value",scale:!0,name:"价格"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:[]};const O=new Map;y.forEach(te=>{const s=I(te.date).format(h);O.set(s,te.close)}),O.size===0&&B.length>0&&B.forEach(te=>{const s=I(te.timestamp).format(h);O.has(s)||O.set(s,te.actual_price)});const be=L.map(te=>{var s;return(s=O.get(te))!=null?s:null}),Ce=[];X.forEach(te=>{const s=B.filter(J=>J.model_type===te);if(s.length===0)return;const i=new Map;s.forEach(J=>{const je=I(J.timestamp).format(h);i.set(je,J.predicted_price)});const v=L.map(J=>{var je;return(je=i.get(J))!=null?je:null}),A=re(te);Ce.push({type:"line",name:`${te}预测`,data:v,smooth:!0,lineStyle:{color:A},itemStyle:{color:A}})});const ce=new Map;L.forEach((te,s)=>{ce.set(te,s)});const xe=[],fe=[];B.forEach(te=>{var s,i;const v=I(te.timestamp).format(h),A=ce.get(v);if(A===void 0)return;const J=(i=(s=te.actual_price)!=null?s:O.get(v))!=null?i:null;J!=null&&(te.action==="BUY"?xe.push({index:A,price:J}):te.action==="SELL"&&fe.push({index:A,price:J}))});const ht=xe.map(te=>({name:"买入点",coord:[L[te.index],te.price],value:te.price,itemStyle:{color:"#f64034"},symbol:"circle",symbolSize:8,label:{show:!1}})),Qe=fe.map(te=>({name:"卖出点",coord:[L[te.index],te.price],value:te.price,itemStyle:{color:"#00b46a"},symbol:"circle",symbolSize:8,label:{show:!1}})),Mt=xe.map(te=>({name:"买入",coord:[L[te.index],te.price*1.02],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:22,label:{show:!0,formatter:"B",color:"#ffffff",position:"inside",fontSize:12,fontWeight:"bold"}})),Nt=fe.map(te=>({name:"卖出",coord:[L[te.index],te.price*.98],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:22,label:{show:!0,formatter:"S",color:"#ffffff",position:"inside",fontSize:12,fontWeight:"bold"}})),At=[...ht,...Qe,...Mt,...Nt],St=[{type:"line",name:"实际收盘价",data:be,smooth:!0,lineStyle:{color:"#666666"},itemStyle:{color:"#666666"},markPoint:{data:At}},...Ce];return{tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{top:0,data:St.map(te=>te.name)},grid:{left:50,right:30,top:40,bottom:80},xAxis:{type:"category",data:L},yAxis:{type:"value",scale:!0,name:"价格"},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:20,start:0,end:100}],series:St}},[y,B,X]),ws=l.useMemo(()=>U?Object.keys(U).map(h=>{var L,O,be;const Ce=U[h];return{model:h,total_return:(L=Ce==null?void 0:Ce.total_return)!=null?L:0,max_drawdown:(O=Ce==null?void 0:Ce.max_drawdown)!=null?O:0,sharpe_ratio:(be=Ce==null?void 0:Ce.sharpe_ratio)!=null?be:0}}):[],[U]),Ss=[{title:"模型",dataIndex:"model",key:"model"},{title:"总收益率",dataIndex:"total_return",key:"total_return",render:h=>`${(h*100).toFixed(2)} %`},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:h=>`${(h*100).toFixed(2)} %`},{title:"夏普比率",dataIndex:"sharpe_ratio",key:"sharpe_ratio",render:h=>h.toFixed(2)}];return e.jsxs("div",{children:[e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:16,children:e.jsx(le,{title:e.jsxs(De,{children:[e.jsx(Gt,{}),"AI实时投资跑数配置"]}),children:e.jsxs(F,{form:j,layout:"vertical",initialValues:{data_source:"database",frequency:"1d",initial_capital:1e5,buy_threshold:.002,sell_threshold:-.002,stop_loss_pct:.05,take_profit_pct:.1,window:20,commission_rate:.0015,slippage_rate:.001},children:[e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"name",label:"运行名称",children:e.jsx(ke,{placeholder:"可选，例如：AAPL-日内回放"})})}),e.jsx(f,{span:12,children:C==="database"?e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请选择股票代码"}],children:e.jsx(Ye,{showSearch:!0,placeholder:"从市场数据管理中选择股票",loading:Oe,optionFilterProp:"children",filterOption:(h,L)=>{var O;return String((O=L==null?void 0:L.children)!=null?O:"").toLowerCase().includes(h.toLowerCase())},children:$e.map(h=>e.jsxs(ot,{value:h.symbol,children:[h.symbol,"（",h.name,"）"]},h.id))})}):e.jsx(F.Item,{name:"symbol",label:"股票代码",rules:[{required:!0,message:"请输入股票代码"}],children:e.jsx(ke,{placeholder:"例如：HK.00700"})})})]}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"timeRange",label:"时间范围",rules:[{required:!0,message:"请选择时间范围"}],children:e.jsx(kn,{showTime:!0,style:{width:"100%"},presets:[{label:"最近3天",value:[I().subtract(3,"day"),I()]},{label:"最近一周",value:[I().subtract(7,"day"),I()]},{label:"最近两周",value:[I().subtract(14,"day"),I()]},{label:"最近3周",value:[I().subtract(21,"day"),I()]},{label:"最近一月",value:[I().subtract(1,"month"),I()]},{label:"最近3月",value:[I().subtract(3,"month"),I()]},{label:"最近半年",value:[I().subtract(6,"month"),I()]},{label:"最近一年",value:[I().subtract(1,"year"),I()]},{label:"最近两年",value:[I().subtract(2,"year"),I()]},{label:"最近3年",value:[I().subtract(3,"year"),I()]},{label:"最近5年",value:[I().subtract(5,"year"),I()]}],disabledDate:h=>h&&h>I().endOf("day")})})}),e.jsx(f,{span:12,children:e.jsx(F.Item,{name:"models",label:"AI模型",rules:[{required:!0,message:"请选择至少一个模型"}],children:e.jsxs(Ye,{mode:"multiple",placeholder:"支持多选，用于模型对比或加权",children:[e.jsx(ot,{value:"qwen",children:"千问"}),e.jsx(ot,{value:"kimi",children:"Kimi"}),e.jsx(ot,{value:"deepseek",children:"DeepSeek"})]})})})]}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:8,children:e.jsx(F.Item,{name:"data_source",label:"数据源",children:e.jsxs(Ye,{children:[e.jsx(ot,{value:"database",children:"市场数据管理(日线)"}),e.jsx(ot,{value:"futu",children:"富途 OpenAPI 实时"})]})})}),e.jsx(f,{span:8,children:e.jsx(F.Item,{name:"frequency",label:"数据频率",children:e.jsx(Ye,{children:N.map(h=>e.jsx(ot,{value:h.value,children:h.label},h.value))})})}),e.jsx(f,{span:8,children:e.jsx(F.Item,{name:"initial_capital",label:"初始资金",children:e.jsx(ke,{type:"number",min:0})})})]}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:6,children:e.jsx(F.Item,{name:"buy_threshold",label:"买入阈值(预测涨幅)",children:e.jsx(ke,{type:"number",step:"0.001"})})}),e.jsx(f,{span:6,children:e.jsx(F.Item,{name:"sell_threshold",label:"卖出阈值(预测跌幅)",children:e.jsx(ke,{type:"number",step:"0.001"})})}),e.jsx(f,{span:6,children:e.jsx(F.Item,{name:"stop_loss_pct",label:"止损比例",children:e.jsx(ke,{type:"number",step:"0.01"})})}),e.jsx(f,{span:6,children:e.jsx(F.Item,{name:"take_profit_pct",label:"止盈比例",children:e.jsx(ke,{type:"number",step:"0.01"})})})]}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:6,children:e.jsx(F.Item,{name:"commission_rate",label:"手续费率",children:e.jsx(ke,{type:"number",step:"0.0001"})})}),e.jsx(f,{span:6,children:e.jsx(F.Item,{name:"slippage_rate",label:"滑点比例",children:e.jsx(ke,{type:"number",step:"0.0001"})})})]}),e.jsx(Z,{gutter:16,children:e.jsx(f,{span:6,children:e.jsx(F.Item,{name:"window",label:"模型窗口长度",children:e.jsx(ke,{type:"number",min:2})})})}),e.jsxs(Z,{justify:"space-between",align:"middle",children:[e.jsx(f,{children:e.jsxs(De,{direction:"vertical",size:4,children:[e.jsx(P,{size:"small",loading:a,onClick:ee,children:"预估AI调用次数"}),p&&e.jsx(Ot,{type:"danger",style:{maxWidth:480},children:p})]})}),e.jsx(f,{children:e.jsx(P,{type:"primary",icon:e.jsx(Gt,{}),loading:g,onClick:E,children:"启动AI跑数"})})]})]})})}),e.jsx(f,{span:8,children:e.jsx(le,{title:e.jsxs(De,{children:[e.jsx(Ft,{}),"历史运行"]}),children:e.jsx(ss,{rowKey:"id",loading:D,dataSource:m,columns:Ue,size:"small",scroll:{x:!0},pagination:{pageSize:5},onRow:h=>({onClick:()=>Ze(h)})})})})]}),e.jsxs(Z,{gutter:16,style:{marginTop:16},children:[e.jsx(f,{span:12,children:e.jsx(le,{title:"价格与模型预测（含买卖点）",children:e.jsx(Ht,{option:_s,style:{height:540}})})}),e.jsx(f,{span:12,children:e.jsx(le,{title:"账户权益曲线",children:e.jsx(Ht,{option:os,style:{height:540}})})})]}),e.jsx(Z,{gutter:16,style:{marginTop:16},children:e.jsx(f,{span:24,children:e.jsx(le,{title:"预测明细",children:e.jsx(ss,{rowKey:(h,L)=>`${h.model_type}-${h.timestamp}-${L}`,loading:Te,dataSource:B,columns:hs,size:"small",pagination:{pageSize:10},scroll:{x:1200}})})})}),e.jsx(Z,{gutter:16,style:{marginTop:16},children:e.jsx(f,{span:24,children:e.jsx(le,{title:"模型绩效对比",children:e.jsx(ss,{rowKey:"model",dataSource:ws,columns:Ss,size:"small",pagination:!1})})})}),e.jsx(Z,{gutter:16,style:{marginTop:16},children:e.jsx(f,{span:24,children:e.jsxs(le,{title:"AI提示词设置",children:[e.jsx(Z,{gutter:16,children:e.jsx(f,{span:8,children:e.jsxs(De,{children:[e.jsx("span",{children:"选择模型"}),e.jsxs(Ye,{style:{minWidth:160},value:ie,onChange:h=>tt(h),children:[e.jsx(ot,{value:"deepseek",children:"DeepSeek"}),e.jsx(ot,{value:"qwen",children:"千问"}),e.jsx(ot,{value:"kimi",children:"Kimi"})]})]})})}),e.jsx(Z,{style:{marginTop:16},children:e.jsx(f,{span:24,children:e.jsx(ke.TextArea,{value:se,onChange:h=>Pe(h.target.value),autoSize:{minRows:4,maxRows:20},style:{whiteSpace:"pre-wrap"},placeholder:"请输入系统提示词，将作为大模型的系统角色描述"})})}),e.jsx(Z,{justify:"end",style:{marginTop:16},children:e.jsx(f,{children:e.jsxs(De,{children:[e.jsx(P,{onClick:()=>Ie(ie),loading:ye,children:"重新加载"}),e.jsx(P,{type:"primary",loading:zt,onClick:Ee,children:"保存提示词"})]})})})]})})}),e.jsxs(Be,{open:qe,title:Ae?`运行日志 - ${Ae.name} (#${Ae.id}) · 共${x}条`:`运行日志 · 共${x}条`,onCancel:()=>We(!1),footer:null,width:960,children:[Ne&&e.jsxs(le,{size:"small",style:{marginBottom:16},children:[e.jsxs(Z,{gutter:16,style:{marginBottom:8},children:[e.jsxs(f,{span:8,children:[e.jsx(Ot,{strong:!0,children:"时间"}),e.jsx("div",{children:I(Ne.timestamp).format("YYYY-MM-DD HH:mm")})]}),e.jsxs(f,{span:8,children:[e.jsx(Ot,{strong:!0,children:"模型"}),e.jsx("div",{children:Ne.model_type})]}),e.jsxs(f,{span:8,children:[e.jsx(Ot,{strong:!0,children:"操作"}),e.jsx("div",{children:Ne.action})]})]}),e.jsxs(Z,{gutter:16,style:{marginBottom:12},children:[e.jsxs(f,{span:8,children:[e.jsx(Ot,{strong:!0,children:"预测价格"}),e.jsx("div",{children:Ne.predicted_price.toFixed(4)})]}),e.jsxs(f,{span:8,children:[e.jsx(Ot,{strong:!0,children:"实际价格"}),e.jsx("div",{children:Ne.actual_price.toFixed(4)})]}),e.jsxs(f,{span:8,children:[e.jsx(Ot,{strong:!0,children:"账户权益"}),e.jsx("div",{children:Ne.equity.toFixed(2)})]})]}),_t&&e.jsxs(e.Fragment,{children:[e.jsx(Z,{gutter:16,style:{marginBottom:8},children:e.jsx(f,{span:24,children:e.jsx(Ot,{strong:!0,children:"模型输入"})})}),e.jsx(Z,{gutter:16,style:{marginBottom:12},children:e.jsxs(f,{span:24,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"System Prompt"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((n=_t.ai_input)==null?void 0:n.system_prompt)||"无"})]})}),e.jsx(Z,{gutter:16,style:{marginBottom:12},children:e.jsxs(f,{span:24,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"Prompt"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((r=_t.ai_input)==null?void 0:r.prompt)||"无"})]})}),e.jsx(Z,{gutter:16,style:{marginBottom:8},children:e.jsx(f,{span:24,children:e.jsx(Ot,{strong:!0,children:"模型输出"})})}),e.jsxs(Z,{gutter:16,children:[e.jsxs(f,{span:8,children:[e.jsx(Ot,{strong:!0,children:"解析后的数值"}),e.jsx("div",{children:_t.ai_output&&_t.ai_output.value!==void 0?_t.ai_output.value:"无"})]}),e.jsxs(f,{span:16,children:[e.jsx("div",{style:{fontSize:12,color:"#888"},children:"原始内容"}),e.jsx("div",{style:{border:"1px solid #f0f0f0",borderRadius:4,padding:8,maxHeight:120,overflow:"auto",marginTop:4,whiteSpace:"pre-wrap",background:"#fafafa"},children:((o=_t.ai_output)==null?void 0:o.content)||"无"})]})]})]})]}),e.jsxs(De,{style:{marginBottom:8},children:[e.jsxs(Ye,{allowClear:!0,placeholder:"级别",style:{width:120},value:V,onChange:h=>{Ae&&ae(Ae.id,1,Ke,{level:h||void 0})},children:[e.jsx(ot,{value:"DEBUG",children:"DEBUG"}),e.jsx(ot,{value:"INFO",children:"INFO"}),e.jsx(ot,{value:"WARN",children:"WARN"}),e.jsx(ot,{value:"ERROR",children:"ERROR"})]}),e.jsxs(Ye,{allowClear:!0,placeholder:"类别",style:{width:140},value:G,onChange:h=>{Ae&&ae(Ae.id,1,Ke,{category:h||void 0})},children:[e.jsx(ot,{value:"run",children:"运行"}),e.jsx(ot,{value:"ai_call",children:"AI调用"}),e.jsx(ot,{value:"trade",children:"买卖点"}),e.jsx(ot,{value:"system",children:"系统"})]}),e.jsx(ke.Search,{allowClear:!0,placeholder:"按关键字搜索",style:{width:260},value:at,onChange:h=>Re(h.target.value),onSearch:h=>{Ae&&ae(Ae.id,1,Ke,{keyword:h})}}),e.jsxs("span",{children:["共 ",x," 条"]})]}),e.jsx(ss,{rowKey:"id",loading:ft,dataSource:vt,size:"small",pagination:{current:yt,pageSize:Ke,total:x,showSizeChanger:!0,onChange:(h,L)=>{Ae&&ae(Ae.id,h,L)}},columns:[{title:"序号",key:"index",width:70,render:(h,L,O)=>(yt-1)*Ke+O+1},{title:"时间",dataIndex:"timestamp",key:"timestamp",width:180,render:h=>h?I(h).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"级别",dataIndex:"level",key:"level",width:80},{title:"类别",dataIndex:"category",key:"category",width:100},{title:"消息",dataIndex:"message",key:"message",ellipsis:!0},{title:"AI输入",key:"ai_input",width:160,render:(h,L)=>L.ai_input?JSON.stringify(L.ai_input):""},{title:"AI输出",key:"ai_output",width:160,render:(h,L)=>L.ai_output?JSON.stringify(L.ai_output):""}],scroll:{x:900,y:400}})]})]})};var xa=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});const{Title:Cn,Text:Is}=Rt,Dn=()=>{const n=Qt(),[r,o]=l.useState([]),[j,m]=l.useState(!1),w=l.useRef(!1),D=()=>xa(void 0,null,function*(){m(!0);try{const B=yield cs();console.log("获取到的策略数据:",B),o(B)}catch{d.error("获取策略列表失败")}finally{m(!1)}});l.useEffect(()=>{w.current||(w.current=!0,D())},[]);const z=()=>{n("/strategy/edit")},g=B=>{B&&n(`/strategy/edit/${B}`)},$=B=>xa(void 0,null,function*(){if(B)try{yield Fa(B),d.success("策略删除成功"),D()}catch{d.error("删除策略失败")}}),T=B=>{B&&n(`/backtest?strategy=${B}`)},Q=()=>j?e.jsx(ns,{tip:"加载中..."}):r.length===0?e.jsx(Us,{description:"暂无策略",image:Us.PRESENTED_IMAGE_SIMPLE}):e.jsx(Dt,{className:"strategy-list",itemLayout:"horizontal",dataSource:r,renderItem:B=>e.jsxs(Dt.Item,{className:"strategy-list-item",style:{padding:"16px",borderRadius:"8px",backgroundColor:"#f9f9f9",marginBottom:"12px",display:"flex",justifyContent:"space-between"},children:[e.jsxs("div",{style:{flex:1,overflow:"hidden"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"8px"},children:e.jsx(Is,{strong:!0,style:{fontSize:"16px",marginRight:"8px"},children:B.name})}),e.jsx(Is,{type:"secondary",style:{display:"block",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:B.description||"无描述"}),B.updated_at&&e.jsxs(Is,{type:"secondary",style:{fontSize:"12px"},children:["最后更新: ",new Date(B.updated_at).toLocaleString()]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center"},children:e.jsxs(De,{children:[e.jsx(P,{type:"primary",icon:e.jsx(hr,{}),onClick:()=>T(B.id),children:"回测"}),e.jsx(P,{icon:e.jsx(mr,{}),onClick:()=>g(B.id),children:"编辑"}),e.jsx(P,{danger:!0,icon:e.jsx(us,{}),onClick:()=>$(B.id),children:"删除"})]})})]},B.id)});return e.jsx("div",{style:{padding:"20px"},children:e.jsxs(le,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsx(Cn,{level:4,style:{margin:0},children:"策略构建器"}),e.jsx(P,{type:"primary",icon:e.jsx(Da,{}),onClick:z,children:"创建新策略"})]}),e.jsx(ys,{}),Q()]})})};var Cs=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});const{Title:zn,Text:Ds}=Rt,{TextArea:Mn}=ke,fa=()=>{const{id:n}=ba(),r=Qt(),[o]=F.useForm(),[j,m]=l.useState(""),[w,D]=l.useState(!1),[z,g]=l.useState(!1),[$,T]=l.useState(!0),[Q,B]=l.useState(""),ze=`from .strategy_template import StrategyTemplate
import pandas as pd
import numpy as np
import logging

logger = logging.getLogger(__name__)

class MyStrategy(StrategyTemplate):
    """
    我的自定义策略
    """
    
    def __init__(self, parameters=None):
        """初始化策略"""
        default_params = {
            # 在这里定义策略参数和默认值
        }
        
        # 合并用户参数与默认参数
        if parameters:
            default_params.update(parameters)
            
        super().__init__("我的策略", default_params)
        
    def generate_signals(self) -> pd.DataFrame:
        """
        生成交易信号
        
        Returns:
            包含信号的DataFrame，包括:
            - signal: 交易信号 (1: 买入, -1: 卖出, 0: 不操作)
            - trigger_reason: 信号触发原因
        """
        if self.data is None or self.data.empty:
            logger.warning("未设置数据或数据为空，无法生成信号")
            return pd.DataFrame()
        
        # 获取数据
        df = self.data.copy()
        
        # 添加交易信号
        df['signal'] = 0
        df['trigger_reason'] = ''
        
        # TODO: 实现您的交易逻辑
        
        # 使用log函数记录策略执行过程（可选）
        self.log("开始生成交易信号", "INFO")
        self.log(f"数据行数: {len(df)}", "DEBUG")
        
        # 示例: 当价格上涨超过2%时买入
        price_change = df['close'].pct_change() * 100
        buy_signal = price_change > 2
        df.loc[buy_signal, 'signal'] = 1
        df.loc[buy_signal, 'trigger_reason'] = "价格上涨超过2%"
        
        # 记录买入信号数量
        buy_count = buy_signal.sum()
        if buy_count > 0:
            self.log(f"生成买入信号 {buy_count} 个", "INFO")
        
        # 示例: 当价格下跌超过2%时卖出
        sell_signal = price_change < -2
        df.loc[sell_signal, 'signal'] = -1
        df.loc[sell_signal, 'trigger_reason'] = "价格下跌超过2%"
        
        # 记录卖出信号数量
        sell_count = sell_signal.sum()
        if sell_count > 0:
            self.log(f"生成卖出信号 {sell_count} 个", "INFO")
        
        self.log("交易信号生成完成", "INFO")
        
        return df
`;l.useEffect(()=>{n?(T(!1),Te(parseInt(n))):m(ze)},[n]);const Te=b=>Cs(void 0,null,function*(){D(!0);try{const W=yield Xr(b);W&&(o.setFieldsValue({name:W.name,description:W.description,parameters:W.parameters||{}}),m(W.code||ze),B(W.template||""))}catch{d.error("获取策略详情失败")}finally{D(!1)}}),pe=()=>Cs(void 0,null,function*(){try{const b=yield o.validateFields();D(!0);const W=b.parameters&&typeof b.parameters=="object"?b.parameters:{},y={name:b.name,description:b.description,code:j,parameters:W,template:Q};let Ve;$?Ve=yield en(y):n&&(Ve=yield tn(parseInt(n),y)),Ve&&(d.success(`策略${$?"创建":"更新"}成功`),$&&Ve.id&&(r(`/strategy/edit/${Ve.id}`),T(!1)))}catch(b){b.message?d.error(b.message):d.error(`策略${$?"创建":"更新"}失败`)}finally{D(!1)}}),U=()=>Cs(void 0,null,function*(){g(!0);try{const b=o.getFieldsValue(),W=b.parameters&&typeof b.parameters=="object"?b.parameters:{},y=yield sn(j,[],W);y&&!y.error?Be.success({title:"策略代码验证通过",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码语法正确，可以正常运行。"}),y.signals&&e.jsxs("p",{children:["测试生成了 ",y.signals.length," 条数据记录。"]})]})}):Be.error({title:"策略代码验证失败",content:e.jsxs("div",{children:[e.jsx("p",{children:"策略代码存在问题，详细错误信息："}),e.jsx("pre",{style:{maxHeight:"300px",overflow:"auto"},children:y.error||"未知错误"})]})})}catch{d.error("测试策略代码失败")}finally{g(!1)}}),he=()=>{r("/strategy")};return e.jsx("div",{style:{padding:"20px"},children:e.jsx(ns,{spinning:w,tip:"加载中...",children:e.jsx(le,{children:e.jsxs(Z,{gutter:[16,16],children:[e.jsx(f,{span:24,children:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},children:[e.jsxs(De,{children:[e.jsx(P,{icon:e.jsx(za,{}),onClick:he,children:"返回"}),e.jsx(zn,{level:4,style:{margin:0},children:$?"创建新策略":"编辑策略"})]}),e.jsxs(De,{children:[e.jsx(P,{type:"primary",icon:e.jsx(Ia,{}),onClick:pe,loading:w,children:"保存"}),e.jsx(P,{icon:e.jsx(Gt,{}),onClick:U,loading:z,children:"测试"})]})]})}),e.jsx(f,{span:24,children:e.jsxs(F,{form:o,layout:"vertical",children:[e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:12,children:e.jsx(F.Item,{label:"策略名称",name:"name",rules:[{required:!0,message:"请输入策略名称"}],children:e.jsx(ke,{placeholder:"请输入策略名称"})})}),e.jsx(f,{span:12,children:e.jsx(F.Item,{label:"策略描述",name:"description",children:e.jsx(Mn,{rows:1,placeholder:"请输入策略描述"})})})]}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:8,children:e.jsx(F.Item,{label:"分批建仓批次数 (batch_count)",name:["parameters","batch_count"],initialValue:1,children:e.jsx(ke,{type:"number",min:1})})}),e.jsx(f,{span:8,children:e.jsx(F.Item,{label:"批次间隔条数 (batch_interval_bars)",name:["parameters","batch_interval_bars"],initialValue:1,children:e.jsx(ke,{type:"number",min:1})})}),e.jsx(f,{span:8,children:e.jsx(F.Item,{label:"批次权重 (batch_weights)",name:["parameters","batch_weights"],tooltip:"可输入逗号分隔的数字，例如: 0.5,0.3,0.2（若为空则均分）",children:e.jsx(ke,{placeholder:"例如: 0.5,0.3,0.2 或 留空"})})})]})]})}),e.jsxs(f,{span:24,children:[e.jsx(ys,{orientation:"left",children:e.jsxs(De,{children:[e.jsx(As,{}),e.jsx(Ds,{strong:!0,children:"策略代码"})]})}),e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(gt,{message:"💡 策略日志功能",description:e.jsxs("div",{children:[e.jsxs("p",{children:["您可以在策略中使用 ",e.jsx("code",{children:"self.log(message, level)"})," 函数记录执行过程："]}),e.jsxs("ul",{style:{marginBottom:0},children:[e.jsxs("li",{children:[e.jsx("code",{children:'self.log("信息内容", "INFO")'})," - 记录一般信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("调试信息", "DEBUG")'})," - 记录调试信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("警告信息", "WARNING")'})," - 记录警告信息"]}),e.jsxs("li",{children:[e.jsx("code",{children:'self.log("错误信息", "ERROR")'})," - 记录错误信息"]})]}),e.jsx("p",{style:{marginTop:"8px",marginBottom:0},children:e.jsx(Ds,{type:"secondary",children:'日志将在回测历史的"控制台"按钮中查看，帮助您调试和监控策略执行过程。'})})]}),type:"info",showIcon:!0,style:{marginBottom:"16px"}})}),e.jsx("div",{style:{border:"1px solid #d9d9d9",borderRadius:"2px"},children:e.jsx(gr,{width:"100%",height:"600",language:"python",theme:"vs-dark",value:j,onChange:m,options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,folding:!0,lineNumbers:"on",rulers:[80,120],minimap:{enabled:!0}}})}),e.jsx("div",{style:{marginTop:"8px"},children:e.jsx(Ds,{type:"secondary",children:"注意：策略代码必须继承自StrategyTemplate基类，并实现generate_signals方法。"})})]})]})})})})};var Wt=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});Ls([Ps,Fs,Ns,Ts,Os,Ys,Rs,Es]);const{Title:Rn,Text:Yt}=Rt,Ct=n=>typeof n!="string"?String(n):n.includes("T")?n.split("T")[0]:n.includes(" ")?n.split(" ")[0]:n,An=l.memo(()=>{var n,r,o,j,m,w,D,z,g;const $=Qt(),[T,Q]=l.useState(!1),[B,ze]=l.useState([]),[Te,pe]=l.useState([]),[U,he]=l.useState("all"),[b,W]=l.useState(!1),[y,Ve]=l.useState(null),[$e,oe]=l.useState(!1),[Oe,et]=l.useState("performance"),[ie,tt]=l.useState(0),se=l.useRef(null),Pe=l.useRef(null),[ye,rt]=l.useState(!1),zt=l.useRef(!1),ct=[{title:"日期",dataIndex:"date",key:"date",sorter:(t,a)=>{const u=new Date(t.date),p=new Date(a.date);return u.getTime()-p.getTime()}},{title:"方向",dataIndex:"action",key:"action",filters:[{text:"买入",value:"BUY"},{text:"卖出",value:"SELL"}],onFilter:(t,a)=>a.action===t,render:t=>{const a=t==="BUY"?"买入":t==="SELL"?"卖出":t;return e.jsx(Le,{color:t==="BUY"?"red":"green",children:a})}},{title:"触发原因",dataIndex:"trigger_reason",key:"trigger_reason",width:120,ellipsis:!0,render:t=>e.jsx(Se,{title:t||"未记录",placement:"topLeft",children:e.jsx("span",{style:{maxWidth:100,display:"inline-block",overflow:"hidden",textOverflow:"ellipsis",verticalAlign:"middle",whiteSpace:"nowrap"},children:t||"未记录"})})},{title:"期初资金",dataIndex:"before_cash",key:"before_cash",sorter:(t,a)=>t.before_cash-a.before_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"期末资金",dataIndex:"after_cash",key:"after_cash",sorter:(t,a)=>t.after_cash-a.after_cash,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"价格",dataIndex:"price",key:"price",sorter:(t,a)=>{const u=t.price||0,p=a.price||0;return u-p},render:t=>{const a=parseFloat(t);return isNaN(a)?"-":a.toFixed(2)}},{title:"数量(股)",dataIndex:"shares",key:"shares",sorter:(t,a)=>t.shares-a.shares,render:t=>(parseInt(t)||0).toLocaleString()},{title:"金额(元)",dataIndex:"value",key:"value",sorter:(t,a)=>t.value-a.value,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"手续费",dataIndex:"commission",key:"commission",sorter:(t,a)=>t.commission-a.commission,render:t=>(parseFloat(t)||0).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})},{title:"仓位比例",dataIndex:"position_size",key:"position_size",sorter:(t,a)=>(t.position_size||0)-(a.position_size||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}},{title:"累计仓位",dataIndex:"cumulative_position_ratio",key:"cumulative_position_ratio",sorter:(t,a)=>(t.cumulative_position_ratio||0)-(a.cumulative_position_ratio||0),render:t=>{const a=parseFloat(t)||0;return a>0?`${(a*100).toFixed(1)}%`:"-"}}],[qe,We]=l.useState(!1),[Ae,bt]=l.useState(null),[vt,pt]=l.useState(!1),[ft]=F.useForm(),[He,yt]=l.useState(!1),[st,Ke]=l.useState([]),k=()=>Wt(void 0,null,function*(){Q(!0);try{const t=yield q.get("/api/backtest-status/list");ze(t.data),pe(t.data)}catch(t){console.error("获取回测列表失败:",t),d.error("获取回测列表失败")}finally{Q(!1)}}),x=()=>Wt(void 0,null,function*(){if(B.length===0){d.warning("没有可更新的回测记录");return}Be.confirm({title:"批量更新到最新K线",content:`确定要将所有 ${B.length} 个回测记录更新到最新的K线日期吗？此操作可能需要较长时间。`,okText:"确定更新",cancelText:"取消",onOk:()=>Wt(void 0,null,function*(){var t,a;rt(!0);let u=0,p=0;const M=[];try{for(const C of B)try{const N=yield q.post(`/api/backtest-status/${C.id}/update`,{update_to_date:null});N.data.status==="success"?(u++,console.log(`成功更新回测: ${C.name}`)):(p++,M.push({name:C.name,error:N.data.message||"更新失败"}),console.error(`更新回测失败: ${C.name}`,N.data.message))}catch(N){p++,M.push({name:C.name,error:((a=(t=N.response)==null?void 0:t.data)==null?void 0:a.detail)||N.message||"网络错误"}),console.error(`更新回测失败: ${C.name}`,N)}d.success(`批量更新完成！成功更新 ${u} 个回测，失败 ${p} 个`),k(),p>0&&Be.info({title:"更新结果详情",content:e.jsxs("div",{children:[e.jsxs("p",{children:["成功更新: ",u," 个"]}),e.jsxs("p",{children:["更新失败: ",p," 个"]}),M.length>0&&e.jsxs("div",{children:[e.jsx("p",{children:"失败项目:"}),e.jsx("ul",{children:M.map((C,N)=>e.jsxs("li",{children:[C.name,": ",C.error]},N))})]})]}),width:500})}catch(C){console.error("批量更新失败:",C),d.error("批量更新失败，请重试")}finally{rt(!1)}})})}),_=t=>Wt(void 0,null,function*(){oe(!0);try{const a=yield q.get(`/api/backtest-status/${t}`);if(a.data.status==="success"){const u=a.data.data;u.results&&u.results.trades&&(u.results.trades=u.results.trades.sort((p,M)=>new Date(M.date).getTime()-new Date(p.date).getTime())),u.trade_records&&(u.trade_records=u.trade_records.sort((p,M)=>new Date(M.date).getTime()-new Date(p.date).getTime())),Ve(u),W(!0)}else d.error("获取回测详情失败")}catch(a){console.error("获取回测详情失败:",a),d.error("获取回测详情失败")}finally{oe(!1)}}),V=t=>Wt(void 0,null,function*(){Be.confirm({title:"确认删除",content:"此操作将永久删除该回测记录，是否继续？",okText:"确认",okType:"danger",cancelText:"取消",onOk:()=>Wt(void 0,null,function*(){try{const a=yield q.delete(`/api/backtest-status/${t}`);a.data.status==="success"?(d.success("删除成功"),k()):d.error(a.data.message||"删除失败")}catch(a){console.error("删除回测失败:",a),d.error("删除失败，请重试")}})})}),ne=t=>{bt(t),ft.setFieldsValue({new_name:t.name,new_description:t.description||"",update_to_date:null}),We(!0)},G=t=>{yt(!0),Ke([]),q.get(`/api/backtest-status/${t.id}`).then(a=>{if(a.data&&a.data.status==="success"){const p=(a.data.data||{}).logs||[];Ke(p)}else{const u=t.logs||[];Ke(u)}}).catch(a=>{console.error("获取日志失败:",a),d.error("获取日志失败");const u=t.logs||[];Ke(u)})},Fe=()=>Wt(void 0,null,function*(){var t,a,u;if(Ae)try{const p=yield ft.validateFields();pt(!0);const M={new_name:p.new_name,new_description:p.new_description||"",update_to_date:p.update_to_date?p.update_to_date.format("YYYY-MM-DD"):void 0},C=yield q.post(`/api/backtest-status/${Ae.id}/update`,M);if(C.data.status==="success"){d.success("回测更新成功！"),We(!1),ft.resetFields(),k();const N=C.data.data;Be.success({title:"更新成功",content:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"新回测名称:"})," ",N.new_backtest_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"更新日期范围:"})," ",N.update_range.start_date," 至 ",N.update_range.end_date]}),N.performance_metrics&&e.jsxs("div",{children:[e.jsx("p",{children:e.jsx("strong",{children:"性能指标:"})}),e.jsxs("ul",{children:[e.jsxs("li",{children:["总收益率: ",(N.performance_metrics.total_return*100).toFixed(2),"%"]}),e.jsxs("li",{children:["最大回撤: ",(N.performance_metrics.max_drawdown*100).toFixed(2),"%"]}),e.jsxs("li",{children:["夏普比率: ",((t=N.performance_metrics.sharpe_ratio)==null?void 0:t.toFixed(2))||"N/A"]})]})]})]}),okText:"确定"})}else d.error(C.data.message||"更新失败")}catch(p){console.error("更新回测失败:",p),d.error(((u=(a=p.response)==null?void 0:a.data)==null?void 0:u.detail)||"更新失败，请重试")}finally{pt(!1)}}),at=[{title:"ID",dataIndex:"id",key:"id",width:60,fixed:"left",align:"center"},{title:"回测名称",dataIndex:"name",key:"name",width:180,fixed:"left",ellipsis:!0,render:t=>e.jsx(Se,{title:t,placement:"topLeft",children:e.jsx(Yt,{strong:!0,style:{color:"#1890ff"},children:t})})},{title:"策略",dataIndex:"strategy_name",key:"strategy_name",width:120,ellipsis:!0,render:t=>e.jsx(Se,{title:t||"未知策略",placement:"topLeft",children:e.jsx(Le,{color:"blue",children:t||"未知"})})},{title:"自定义参数",key:"parameters",width:150,ellipsis:!0,render:(t,a)=>{const u=a.parameters;if(!u||Object.keys(u).length===0)return e.jsx(Yt,{style:{color:"#999"},children:"-"});const p=u.parameters||{},M=Object.keys(p).length;if(M===0)return e.jsx(Yt,{style:{color:"#999"},children:"-"});const N=Object.entries(p).slice(0,2).map(([re,S])=>`${re}:${S}`).join(", "),X=M>2?`${N}...`:N;return e.jsx(Se,{title:e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold",marginBottom:"8px"},children:"策略参数:"}),Object.entries(p).map(([re,S])=>e.jsxs("div",{style:{marginBottom:"4px"},children:[e.jsxs("span",{style:{color:"#1890ff"},children:[re,":"]})," ",String(S)]},re))]}),placement:"topLeft",children:e.jsx(Yt,{style:{color:"#722ed1",fontSize:"12px"},children:X})})}},{title:"股票",dataIndex:"instruments",key:"instruments",width:80,align:"center",render:t=>e.jsx(Le,{color:"green",children:t.join(", ")})},{title:"回测期间",key:"date_range",width:160,align:"center",render:(t,a)=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:I(a.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#999"},children:["至 ",I(a.end_date).format("YYYY-MM-DD")]})]})},{title:"状态",dataIndex:"status",key:"status",width:80,align:"center",render:t=>{const u={running:{text:"运行中",color:"processing"},completed:{text:"已完成",color:"success"},failed:{text:"失败",color:"error"}}[t]||{text:t,color:"default"};return e.jsx(Le,{color:u.color,children:u.text})}},{title:"年化收益率",key:"annual_return",width:100,align:"right",render:(t,a)=>{var u;const p=(u=a.performance_metrics)==null?void 0:u.annual_return;if(p!==void 0){const M=p>=0?"#ff4d4f":"#52c41a",C=p*100;return e.jsxs(Yt,{style:{color:M,fontWeight:"bold"},children:[C>=0?"+":"",C.toFixed(1),"%"]})}return e.jsx(Yt,{style:{color:"#999"},children:"-"})}},{title:"最大回撤",key:"max_drawdown",width:100,align:"right",render:(t,a)=>{var u;const p=(u=a.performance_metrics)==null?void 0:u.max_drawdown;if(p!==void 0){const M=Math.floor(p*100*100)/100;return e.jsxs(Yt,{style:{color:"#ff4d4f",fontWeight:"bold"},children:[M.toFixed(1),"%"]})}return e.jsx(Yt,{style:{color:"#999"},children:"-"})}},{title:"最近一次交易时间",key:"last_trade_time",width:160,align:"center",render:(t,a)=>{const u=a.trade_records||[];if(u.length===0)return e.jsx(Yt,{style:{color:"#999"},children:"-"});const p=u[u.length-1],M=p==null?void 0:p.date,C=p==null?void 0:p.action,N=p==null?void 0:p.price;if(!M)return e.jsx(Yt,{style:{color:"#999"},children:"-"});const X=C==="BUY"?"买入":C==="SELL"?"卖出":C||"未知",re=C==="BUY"?"#ff4d4f":C==="SELL"?"#52c41a":"#999";return e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{style:{fontWeight:"bold"},children:I(M).format("MM-DD")}),e.jsx("div",{style:{color:re,fontWeight:"bold",marginTop:"2px"},children:X}),N&&e.jsxs("div",{style:{color:"#666",fontSize:"11px",marginTop:"1px"},children:["$",parseFloat(N).toFixed(2)]})]})}},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:120,align:"center",render:t=>e.jsxs("div",{style:{fontSize:"12px",lineHeight:"1.4"},children:[e.jsx("div",{children:I(t).format("MM-DD")}),e.jsx("div",{style:{color:"#999"},children:I(t).format("HH:mm")})]})},{title:"操作",key:"actions",width:180,fixed:"right",render:(t,a)=>e.jsxs(De,{size:"small",children:[e.jsx(Se,{title:"查看详情",children:e.jsx(P,{type:"text",icon:e.jsx(qs,{}),onClick:()=>_(a.id),size:"small",style:{color:"#1890ff"}})}),e.jsx(Se,{title:"历史记录",children:e.jsx(P,{type:"text",icon:e.jsx(ds,{}),onClick:()=>$(`/backtest-history/${a.id}`),size:"small",style:{color:"#52c41a"}})}),e.jsx(Se,{title:"更新数据",children:e.jsx(P,{type:"text",icon:e.jsx(as,{}),onClick:()=>ne(a),size:"small",style:{color:"#faad14"}})}),e.jsx(Se,{title:"查看日志",children:e.jsx(P,{type:"text",icon:e.jsx(Ms,{}),onClick:()=>G(a),size:"small",style:{color:"#722ed1"}})}),e.jsx(Se,{title:"删除",children:e.jsx(P,{type:"text",danger:!0,icon:e.jsx(us,{}),onClick:()=>V(a.id),size:"small"})})]})}],Re=(t,a,u)=>{if(!t||t.length===0)return{title:{text:"策略收益曲线 (无数据)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};const p=t.filter(E=>E&&E.date&&E.equity!==void 0&&!isNaN(Number(E.equity)));if(p.length===0)return{title:{text:"策略收益曲线 (数据无效)",left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}}};let M=[],C=[];const N=new Map;p.forEach((E,ee)=>{const Ee=Ct(E.date);N.set(Ee,ee)}),a&&a.length>0&&a.forEach(E=>{const ee=Ct(E.date),Ee=N.get(ee);if(Ee!==void 0){const Ze={name:E.action==="BUY"?"买入点":"卖出点",value:p[Ee].equity,xAxis:Ee,yAxis:p[Ee].equity,itemStyle:{color:E.action==="BUY"?"#f64034":"#00b46a"}};E.action==="BUY"?M.push(Ze):C.push(Ze)}});let X=-1,re=-1,S=0,de="",Me="",ae=0,Ie=0;if(p.length>0){let E=p[0].equity,ee=0,Ee=0;for(let Ze=1;Ze<p.length;Ze++)p[Ze].equity>E?(E=p[Ze].equity,Ee=Ze):(ee=(E-p[Ze].equity)/E*100,ee>S&&(S=ee,X=Ee,re=Ze,de=p[Ee].date,Me=p[Ze].date,ae=E,Ie=p[Ze].equity));console.log(`最大回撤区间索引: ${X} - ${re}`),console.log(`最大回撤: ${S.toFixed(2)}%, 从 ${de} 到 ${Me}`)}return{title:{text:"策略收益曲线",left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",formatter:function(E){if(Array.isArray(E)&&E.length>0){const Ee=E[0].axisValue,Ze=E[0].data;for(let me=0;me<E.length;me++)if(E[me].componentType==="markArea")return`最大回撤: ${S.toFixed(2)}%<br/>
                        开始日期: ${de}<br/>
                        最高点: ¥${ae.toLocaleString("zh-CN",{minimumFractionDigits:2})}<br/>
                        结束日期: ${Me}<br/>
                        最低点: ¥${Ie.toLocaleString("zh-CN",{minimumFractionDigits:2})}`;let dt="";for(let me=0;me<E.length;me++){const lt=E[me];if(lt.seriesName==="买入点"||lt.seriesName==="卖出点"){const ls=Ct(Ee),_t=a.find(Ue=>Ct(Ue.date)===ls&&(lt.seriesName==="买入点"&&Ue.action==="BUY"||lt.seriesName==="卖出点"&&Ue.action==="SELL"));if(_t){const Ue=_t.trigger_reason||"未记录原因";dt=`<br/><span style="color:${lt.color}">● ${lt.seriesName}</span>`,dt+=`<br/><span style="color:#555; font-size:12px">原因: ${Ue}</span>`}else dt=`<br/><span style="color:${lt.color}">● ${lt.seriesName}</span>`;break}}return`${Ee}<br/>策略收益: ¥${parseFloat(Ze).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}${dt}`}const ee=E.value;return`${E.name}: ¥${parseFloat(ee).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`},axisPointer:{type:"cross",label:{backgroundColor:"#555"}}},legend:{data:["策略收益","初始资金"],bottom:10,itemWidth:25,itemHeight:14,itemGap:30,textStyle:{fontSize:14},icon:"roundRect",selectedMode:!1},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:p.map(E=>E.date)},yAxis:{type:"value",name:"资金",axisLabel:{formatter:"¥{value}"}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"策略收益",type:"line",data:p.map(E=>E.equity),smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#3b7ddd"},areaStyle:{color:new Ca(0,0,0,1,[{offset:0,color:"rgba(59, 125, 221, 0.25)"},{offset:1,color:"rgba(59, 125, 221, 0.03)"}]),opacity:1},markPoint:{data:[...M.map(E=>({name:"买入点",coord:[E.xAxis,E.yAxis],value:E.value,itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:24,label:{formatter:"B",color:"#fff",position:"inside"}})),...C.map(E=>({name:"卖出点",coord:[E.xAxis,E.yAxis],value:E.value,itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:24,label:{formatter:"S",color:"#fff",position:"inside"}}))],symbolSize:24},markArea:{itemStyle:{color:"rgba(255, 173, 177, 0.2)",borderColor:"#f5222d",borderWidth:1},label:{show:!0,position:"top",formatter:`最大回撤: ${S.toFixed(2)}%`,color:"#f5222d",fontSize:12,fontWeight:"bold"},data:[X>=0&&re>=0?[{name:"最大回撤开始",xAxis:X,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}},{name:"最大回撤结束",xAxis:re,itemStyle:{color:"rgba(255, 173, 177, 0.2)"}}]:[]]}},{name:"初始资金",type:"line",data:p.map(()=>u),symbol:"none",lineStyle:{width:2,type:"solid",color:"#888"},markLine:{silent:!0,lineStyle:{color:"#888",width:2,type:"solid"},data:[{yAxis:u,label:{formatter:"初始资金: ¥"+u.toLocaleString(),position:"start",distance:[0,-20],color:"#888",fontSize:12,fontWeight:"bold",backgroundColor:"rgba(255,255,255,0.9)",padding:[4,8],borderColor:"#888",borderWidth:1,borderRadius:4}}]},tooltip:{formatter:function(E){return`初始资金: ¥${u.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`}}}]}},Ge=(t,a)=>{if(!a||!Array.isArray(a)||a.length===0)return console.warn(`计算MA${t}失败: 数据无效`),[];const u=[];for(let p=0;p<a.length;p++){if(p<t-1){u.push("-");continue}let M=0,C=0;for(let N=0;N<t;N++){const X=a[p-N];if(X&&X.length>=4){const re=Number(X[1]);!isNaN(re)&&re>0&&(M+=re,C++)}}C>0?u.push((M/C).toFixed(2)):u.push("-")}return u},nt=(t,a)=>{var u;const p=`${((u=y==null?void 0:y.instruments)==null?void 0:u[0])||"股票"} K线图与交易信号`;if(!t||t.length===0)return{title:{text:p,left:"center"},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[]},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"}}};const M=t.map(S=>[S.date,S.open,S.close,S.low,S.high,S.volume]);let C=[],N=[];if(a&&a.length>0){const S=new Map;M.forEach((ae,Ie)=>{const E=Ct(ae[0]);S.set(E,Ie)}),C=a.filter(ae=>ae.action==="BUY").map(ae=>{const Ie=Ct(ae.date),E=S.get(Ie),ee=ae.price||0;return E===void 0||ee<=0?null:{name:"买入",value:[E,ee],xAxis:E,yAxis:ee,itemStyle:{color:"#f64034"}}}).filter(ae=>ae!==null),N=a.filter(ae=>ae.action==="SELL").map(ae=>{const Ie=Ct(ae.date),E=S.get(Ie),ee=ae.price||0;return E===void 0||ee<=0?null:{name:"卖出",value:[E,ee],xAxis:E,yAxis:ee,itemStyle:{color:"#00b46a"}}}).filter(ae=>ae!==null)}const X=M.map(S=>S[0]);let re=[...C.map(S=>({name:"买入点",coord:[S.value[0],S.value[1]],value:S.value[1],itemStyle:{color:"#f64034",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...N.map(S=>({name:"卖出点",coord:[S.value[0],S.value[1]],value:S.value[1],itemStyle:{color:"#00b46a",borderColor:"#ffffff",borderWidth:1,shadowBlur:2,shadowColor:"rgba(0,0,0,0.3)"},symbol:"circle",symbolSize:8,label:{show:!1}})),...C.map(S=>{const de=S.value[0],ae=M[de][4]*1.1;return{name:"买入标签",coord:[S.value[0],ae],itemStyle:{color:"#f64034"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"B",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}}),...N.map(S=>{const de=S.value[0],ae=M[de][4]*1.2;return{name:"卖出标签",coord:[S.value[0],ae],itemStyle:{color:"#00b46a"},symbol:"pin",symbolSize:25,symbolOffset:[0,"50%"],label:{show:!0,formatter:"S",fontSize:12,fontWeight:"bold",color:"#ffffff",position:"inside"}}})];return{title:{text:p,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#555"}},backgroundColor:"rgba(255, 255, 255, 0.9)",borderWidth:1,borderColor:"#ccc",padding:10,textStyle:{color:"#333"},formatter:function(S){let de="";if(Array.isArray(S)){const Me=S[0].axisValue;de=`<div style="font-weight:bold;margin-bottom:5px;color:#333;font-size:14px;">${Me}</div>`,S.forEach(ee=>{if(ee.seriesName==="K线"){if(ee.value&&ee.value.length>=4){const Ee=Number(ee.value[1])||0,Ze=Number(ee.value[2])||0,dt=Number(ee.value[3])||0,me=Number(ee.value[4])||0,lt=Ze>=Ee?"#f64034":"#00b46a";de+=`<div style="color:${lt};line-height:1.5;margin-bottom:8px;font-weight:bold;">
                    开盘：<span style="float:right;color:${lt};">${Ee.toFixed(2)}</span><br/>
                    收盘：<span style="float:right;color:${lt};">${Ze.toFixed(2)}</span><br/>
                    最低：<span style="float:right;color:${lt};">${dt.toFixed(2)}</span><br/>
                    最高：<span style="float:right;color:${lt};">${me.toFixed(2)}</span><br/>
                  </div>`}}else if(ee.seriesName&&ee.seriesName.startsWith("MA")&&ee.value!=="-"){const Ze={MA5:"#f7b500",MA10:"#2196F3",MA20:"#8067dc",MA30:"#00b46a",MA60:"#7cb305",MA120:"#eb2f96"}[ee.seriesName]||ee.color;try{const dt=typeof ee.value=="number"?parseFloat(ee.value.toString()).toFixed(3):parseFloat(ee.value||"0").toFixed(3);de+=`<div style="color:${Ze};font-weight:bold;display:inline-block;margin-right:15px;">${ee.seriesName}：${dt}</div>`}catch(dt){console.warn("格式化MA值出错:",dt),de+=`<div style="color:${Ze};font-weight:bold;display:inline-block;margin-right:15px;">${ee.seriesName}：0</div>`}}});const ae=Ct(Me),Ie=a.find(ee=>ee.action==="BUY"&&Ct(ee.date)===ae),E=a.find(ee=>ee.action==="SELL"&&Ct(ee.date)===ae);if((Ie||E)&&(de+='<div style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px;"></div>'),Ie){const ee=Ie.price||0,Ee=Ie.trigger_reason||"未记录原因";de+=`<div style="color:#f64034;font-weight:bold;margin-top:3px;">
                买入(B)：¥${ee.toFixed(2)}<br/>
                原因：${Ee}
              </div>`}if(E){const ee=E.price||0,Ee=E.trigger_reason||"未记录原因";de+=`<div style="color:#00b46a;font-weight:bold;margin-top:3px;">
                卖出(S)：¥${ee.toFixed(2)}<br/>
                原因：${Ee}
              </div>`}}return de}},legend:{data:["K线","MA5","MA10","MA20","MA30"],bottom:10,selected:{MA10:!1,MA30:!1},textStyle:{color:"#333"},itemGap:20},grid:{left:"3%",right:"4%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:X,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},splitNumber:20,min:"dataMin",max:"dataMax"},yAxis:{type:"value",name:"价格",axisLabel:{formatter:"¥{value}"},scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:60,start:0,end:100}],series:[{name:"K线",type:"candlestick",data:M.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])]),itemStyle:{color:"#f64034",color0:"#00b46a",borderColor:"#f64034",borderColor0:"#00b46a"},markPoint:{data:re,animation:!1,z:10}},{name:"MA5",type:"line",data:Ge(5,M.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#f7b500"}},{name:"MA10",type:"line",data:Ge(10,M.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#2196F3"}},{name:"MA20",type:"line",data:Ge(20,M.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#8067dc"}},{name:"MA30",type:"line",data:Ge(30,M.map(S=>[Number(S[1]),Number(S[2]),Number(S[3]),Number(S[4])])),smooth:!0,lineStyle:{width:1,color:"#00b46a"}}]}},Ne=l.useMemo(()=>{var t,a,u,p;return[{key:"1",label:e.jsxs("span",{children:[e.jsx(Ft,{}),"绩效分析"]}),children:e.jsx(Z,{gutter:16,children:e.jsx(f,{span:24,style:{marginBottom:16},children:e.jsx(Ht,{option:Re((y==null?void 0:y.equity_curve)||[],((t=y==null?void 0:y.results)==null?void 0:t.trades)||(y==null?void 0:y.trade_records)||[],(y==null?void 0:y.initial_capital)||1e5),style:{height:500},notMerge:!0,opts:{renderer:"canvas"}},`equity-chart-${ie}`)})})},{key:"3",label:e.jsxs("span",{children:[e.jsx(Ft,{}),"K线与交易信号"]}),children:e.jsx(Z,{gutter:16,children:e.jsx(f,{span:24,children:e.jsx(le,{title:`${((a=y==null?void 0:y.instruments)==null?void 0:a[0])||"股票"}交易图表`,extra:e.jsxs(De,{children:[e.jsx(P,{type:"primary",size:"small",onClick:()=>{const M=document.querySelector(".kline-chart");if(M){const C=M.__echarts__;C&&C.dispatchAction({type:"dataZoom",start:0,end:100})}},children:"重置缩放"}),e.jsx(P,{size:"small",onClick:()=>{var M;const C=((M=y==null?void 0:y.results)==null?void 0:M.trades)||(y==null?void 0:y.trade_records)||[],N=(y==null?void 0:y.equity_curve)||[];if(C.length>0&&N.length>0){const X=new Map;N.forEach((S,de)=>{const Me=Ct(S.date);X.set(Me,de)});const re=[];if(C.forEach(S=>{const de=Ct(S.date),Me=X.get(de);Me!==void 0&&re.push(Me)}),re.length>0){const S=Math.max(0,Math.min(...re)-10),de=Math.min(N.length-1,Math.max(...re)+10),Me=S/N.length*100,ae=de/N.length*100,Ie=document.querySelector(".kline-chart");if(Ie){const E=Ie.__echarts__;E&&(E.dispatchAction({type:"dataZoom",start:Me,end:ae}),d.success(`已聚焦到交易区域，共显示 ${re.length} 个交易点`))}}else d.info("未找到交易信号对应的K线数据点")}else d.info("没有交易记录或K线数据")},children:"聚焦交易"}),e.jsx(Se,{title:"只显示有交易的区域",children:e.jsx(Je,{})})]}),children:e.jsx(Ht,{className:"kline-chart",option:nt((y==null?void 0:y.equity_curve)||[],((u=y==null?void 0:y.results)==null?void 0:u.trades)||(y==null?void 0:y.trade_records)||[]),style:{height:600},notMerge:!0,opts:{renderer:"canvas"}},`kline-chart-${ie}`)})})})},{key:"2",label:e.jsxs("span",{children:[e.jsx(Je,{}),"交易明细"]}),children:e.jsx(Jt,{dataSource:((p=y==null?void 0:y.results)==null?void 0:p.trades)||(y==null?void 0:y.trade_records)||[],columns:ct,rowKey:M=>`trade-${M.date}-${M.action}-${M.price}`,pagination:{pageSize:10},scroll:{x:!0}})}]},[y]);return l.useEffect(()=>{zt.current||(zt.current=!0,k())},[]),l.useEffect(()=>{if(U==="all")pe(B);else{const t=B.filter(a=>a.strategy_name===U);pe(t)}},[B,U]),l.useEffect(()=>{if(b&&y){const t=setTimeout(()=>{se.current&&se.current.getEchartsInstance().resize(),Pe.current&&Pe.current.getEchartsInstance().resize(),tt(u=>u+1)},500),a=()=>{se.current&&se.current.getEchartsInstance().resize(),Pe.current&&Pe.current.getEchartsInstance().resize()};return window.addEventListener("resize",a),()=>{clearTimeout(t),window.removeEventListener("resize",a)}}},[b,y]),e.jsxs("div",{style:{padding:"24px"},children:[e.jsx("style",{children:`
        .table-row-light {
          background-color: #fafafa;
        }
        .table-row-dark {
          background-color: #ffffff;
        }
        .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
          font-weight: 600 !important;
          text-align: center !important;
          white-space: nowrap !important;
        }
        .ant-table-tbody > tr:hover > td {
          background-color: #e6f7ff !important;
        }
        .ant-table-tbody > tr > td {
          padding: 8px 12px !important;
          border-bottom: 1px solid #f0f0f0 !important;
        }
        .ant-table-fixed-left .ant-table-thead > tr > th,
        .ant-table-fixed-right .ant-table-thead > tr > th {
          background-color: #f5f5f5 !important;
        }
        .ant-table-fixed-left .ant-table-tbody > tr > td,
        .ant-table-fixed-right .ant-table-tbody > tr > td {
          background-color: inherit !important;
        }
      `}),e.jsx(le,{title:e.jsxs(De,{children:[e.jsx(ds,{}),e.jsx("span",{children:"回测历史"})]}),extra:e.jsxs(De,{size:"middle",children:[e.jsx(De.Compact,{children:e.jsxs(Ye,{value:U,onChange:he,style:{width:180},placeholder:"选择策略筛选",allowClear:!0,size:"middle",suffixIcon:e.jsx(xr,{}),children:[e.jsx(Ye.Option,{value:"all",children:"全部策略"}),Array.from(new Set(B.map(t=>t.strategy_name).filter(Boolean))).map(t=>e.jsx(Ye.Option,{value:t,children:t},t))]})}),e.jsx(P,{icon:e.jsx(as,{}),onClick:x,loading:ye,type:"primary",children:"一键更新到最新K线"}),e.jsx(P,{icon:e.jsx(Bs,{}),onClick:k,loading:T,children:"刷新"})]}),children:e.jsx(Jt,{columns:at,dataSource:Te,rowKey:"id",loading:T,size:"small",bordered:!0,pagination:{pageSize:it.getPageSize(15),showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,a)=>`第 ${a[0]}-${a[1]} 条，共 ${t} 条`,pageSizeOptions:["10","15","20","50"],size:"small",onChange:(t,a)=>{it.setCurrentPage(t),it.setPageSize(a||15)},onShowSizeChange:(t,a)=>{it.setPageSize(a)}},scroll:{x:1550,y:"calc(100vh - 300px)"},rowClassName:(t,a)=>a%2===0?"table-row-light":"table-row-dark"})}),e.jsx(Be,{title:"回测详情",open:b,onCancel:()=>{W(!1),et("performance")},footer:null,width:1200,destroyOnClose:!0,afterOpenChange:t=>{t&&setTimeout(()=>{se.current&&se.current.getEchartsInstance().resize(),Pe.current&&Pe.current.getEchartsInstance().resize()},100)},children:y&&e.jsxs("div",{children:[e.jsxs(ut,{title:"基本信息",bordered:!0,column:2,style:{marginBottom:24},children:[e.jsx(ut.Item,{label:"回测名称",children:y.name}),e.jsx(ut.Item,{label:"策略名称",children:((n=y.strategy_info)==null?void 0:n.name)||"-"}),e.jsxs(ut.Item,{label:"回测期间",children:[I(y.start_date).format("YYYY-MM-DD")," 至 ",I(y.end_date).format("YYYY-MM-DD")]}),e.jsxs(ut.Item,{label:"初始资金",children:["$",y.initial_capital.toLocaleString()]}),e.jsx(ut.Item,{label:"交易标的",children:y.instruments.join(", ")}),e.jsx(ut.Item,{label:"状态",children:e.jsx(Le,{color:y.status==="completed"?"success":"processing",children:y.status==="completed"?"已完成":"运行中"})})]}),y.performance_metrics&&e.jsxs(le,{title:"性能指标",style:{marginBottom:24},children:[e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["累计收益 ",e.jsx(Se,{title:"回测期间的总收益率",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:((m=(j=(r=y.performance_metrics)==null?void 0:r.total_return)!=null?j:(o=y.results)==null?void 0:o.total_return)!=null?m:0)*100,precision:2,valueStyle:{color:((g=(z=(w=y.performance_metrics)==null?void 0:w.total_return)!=null?z:(D=y.results)==null?void 0:D.total_return)!=null?g:0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["年化收益率 ",e.jsx(Se,{title:"策略的年化收益率",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:(y.performance_metrics.annual_return||0)*100,precision:2,valueStyle:{color:(y.performance_metrics.annual_return||0)>=0?"#ff4d4f":"#52c41a"},suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["最大回撤 ",e.jsx(Se,{title:"策略的最大回撤幅度",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.max_drawdown*100,precision:2,valueStyle:{color:"#ff4d4f"},suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["夏普比率 ",e.jsx(Se,{title:"风险调整后的收益指标",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.sharpe_ratio,precision:2})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["胜率 ",e.jsx(Se,{title:"盈利交易占总交易的比例",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.win_rate*100,precision:2,suffix:"%"})})]}),e.jsxs(Z,{gutter:16,style:{marginTop:24},children:[e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["盈亏比 ",e.jsx(Se,{title:"盈亏比=所有盈利交易收益总和/所有亏损交易亏损总和",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:y.performance_metrics.profit_factor||0,precision:2})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Alpha ",e.jsx(Se,{title:"Alpha=策略超越基准的年化收益，反映主动收益",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2,suffix:"%"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["Beta ",e.jsx(Se,{title:"Beta=策略与基准的相关性，衡量系统性风险",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:0,precision:2})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:e.jsxs("span",{children:["最近一次交易时间 ",e.jsx(Se,{title:"最后一次交易的时间和方向",children:e.jsx(Je,{style:{fontSize:14,color:"#aaa"}})})]}),value:(()=>{const t=y.trade_records||[];if(t.length===0)return"-";const a=t[t.length-1],u=a==null?void 0:a.date,p=a==null?void 0:a.action,M=a==null?void 0:a.price;if(!u)return"-";const C=p==="BUY"?"买入":p==="SELL"?"卖出":p||"未知",N=M?` @ $${parseFloat(M).toFixed(2)}`:"";return`${I(u).format("MM-DD")} (${C}${N})`})()})})]})]}),e.jsx(ps,{defaultActiveKey:"1",items:Ne})]})}),e.jsx(Be,{title:"更新回测数据",open:qe,onOk:Fe,onCancel:()=>{We(!1),ft.resetFields()},confirmLoading:vt,okText:"更新",cancelText:"取消",width:600,children:e.jsxs(F,{form:ft,layout:"vertical",style:{marginTop:16},children:[e.jsx(F.Item,{label:"新回测名称",name:"new_name",rules:[{required:!0,message:"请输入新回测名称"}],children:e.jsx(ke,{placeholder:"请输入新回测名称"})}),e.jsx(F.Item,{label:"更新到日期",name:"update_to_date",extra:"留空则自动更新到最新可用数据（通常是昨天）",children:e.jsx(Zt,{style:{width:"100%"},placeholder:"选择更新截止日期（可选）",format:"YYYY-MM-DD"})}),e.jsx(F.Item,{label:"回测描述",name:"new_description",extra:"可选：更新回测的描述信息",children:e.jsx(ke.TextArea,{placeholder:"请输入回测描述（可选）",rows:3})}),Ae&&e.jsx(gt,{message:"更新说明",description:e.jsxs("div",{children:[e.jsx("p",{children:"• 将基于原回测的配置（策略、参数、仓位配置等）重新运行回测"}),e.jsxs("p",{children:["• 起始日期保持原回测的起始日期：",Ae.start_date]}),e.jsx("p",{children:"• 结束日期将更新到您选择的日期，如不选择则自动更新到最新可用数据"}),e.jsx("p",{children:"• 将创建新的回测记录，原回测记录保持不变"})]}),type:"info",showIcon:!0,style:{marginBottom:16}})]})}),e.jsx(Be,{title:"策略执行日志",open:He,onCancel:()=>yt(!1),footer:[e.jsx(P,{onClick:()=>yt(!1),children:"关闭"},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"500px",overflowY:"auto"},children:st.length>0?e.jsx("div",{style:{fontFamily:"monospace",fontSize:"12px"},children:st.map((t,a)=>e.jsxs("div",{style:{marginBottom:"8px",padding:"8px 12px",backgroundColor:t.level==="ERROR"?"#fff2f0":t.level==="WARNING"?"#fffbe6":t.level==="DEBUG"?"#f6ffed":"#fafafa",border:`1px solid ${t.level==="ERROR"?"#ffccc7":t.level==="WARNING"?"#ffe58f":t.level==="DEBUG"?"#d9f7be":"#d9d9d9"}`,borderRadius:"4px"},children:[e.jsxs("div",{style:{color:t.level==="ERROR"?"#cf1322":t.level==="WARNING"?"#d46b08":t.level==="DEBUG"?"#52c41a":"#595959",fontWeight:"bold",marginBottom:"4px"},children:["[",t.timestamp,"] ",t.level]}),e.jsx("div",{style:{color:"#262626",whiteSpace:"pre-wrap"},children:t.message})]},a))}):e.jsxs("div",{style:{textAlign:"center",color:"#999",padding:"40px 0"},children:[e.jsx(Ms,{style:{fontSize:"48px",marginBottom:"16px"}}),e.jsx("div",{children:"暂无策略执行日志"}),e.jsx("div",{style:{fontSize:"12px",marginTop:"8px"},children:"策略中可以使用 log() 函数记录执行过程"})]})})})]})});var zs=(n,r,o)=>new Promise((j,m)=>{var w=g=>{try{z(o.next(g))}catch($){m($)}},D=g=>{try{z(o.throw(g))}catch($){m($)}},z=g=>g.done?j(g.value):Promise.resolve(g.value).then(w,D);z((o=o.apply(n,r)).next())});Ls([Ps,Fs,Ns,Ts,Os,Ys,Rs,Es]);const{Title:ga,Text:Ln}=Rt,Pn=()=>{const{id:n}=ba(),r=Qt(),[o,j]=l.useState(!1),[m,w]=l.useState(null),[D,z]=l.useState([]),[g,$]=l.useState(!1),[T,Q]=l.useState(null),[B,ze]=l.useState(!1),Te=()=>zs(void 0,null,function*(){if(n){j(!0);try{const b=yield q.get(`/api/backtest-status/${n}`);b.data.status==="success"?w(b.data.data):d.error("获取回测状态失败")}catch(b){console.error("获取回测状态失败:",b),d.error("获取回测状态失败")}finally{j(!1)}}}),pe=()=>zs(void 0,null,function*(){if(n){j(!0);try{const b=yield q.get(`/api/backtest-status/${n}/history`);z(b.data)}catch(b){console.error("获取回测历史失败:",b),d.error("获取回测历史失败")}finally{j(!1)}}}),U=b=>zs(void 0,null,function*(){ze(!0);try{const W=D.find(y=>y.id===b);W&&(Q(W),$(!0))}catch(W){console.error("获取历史记录详情失败:",W),d.error("获取历史记录详情失败")}finally{ze(!1)}}),he=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:"回测期间",key:"period",render:(b,W)=>e.jsxs("div",{children:[e.jsx("div",{children:I(W.start_date).format("YYYY-MM-DD")}),e.jsxs("div",{style:{color:"#666",fontSize:"12px"},children:["至 ",I(W.end_date).format("YYYY-MM-DD")]})]})},{title:"初始资金",dataIndex:"initial_capital",key:"initial_capital",render:b=>`$${b.toLocaleString()}`},{title:"状态",dataIndex:"status",key:"status",render:b=>e.jsx(Le,{color:b==="completed"?"green":b==="running"?"blue":"red",children:b==="completed"?"已完成":b==="running"?"运行中":"失败"})},{title:"收益率",dataIndex:"total_return",key:"total_return",render:b=>e.jsxs("span",{style:{color:b>=0?"#52c41a":"#ff4d4f"},children:[b>=0?"+":"",b.toFixed(2),"%"]})},{title:"最大回撤",dataIndex:"max_drawdown",key:"max_drawdown",render:b=>e.jsxs("span",{style:{color:"#ff4d4f"},children:[b.toFixed(2),"%"]})},{title:"操作类型",dataIndex:"operation_type",key:"operation_type",render:b=>e.jsx(Le,{color:b==="create"?"blue":"orange",children:b==="create"?"创建":b==="update"?"更新":"重新运行"})},{title:"创建时间",dataIndex:"created_at",key:"created_at",render:b=>I(b).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",render:(b,W)=>e.jsx(De,{children:e.jsx(P,{type:"link",icon:e.jsx(qs,{}),onClick:()=>U(W.id),loading:B,children:"查看"})})}];return l.useEffect(()=>{Te(),pe()},[n]),m?e.jsxs("div",{style:{padding:"24px"},children:[e.jsx(le,{style:{marginBottom:"16px"},children:e.jsxs(De,{children:[e.jsx(P,{icon:e.jsx(za,{}),onClick:()=>r("/backtest/history"),children:"返回列表"}),e.jsxs(ga,{level:3,style:{margin:0},children:[e.jsx(ds,{})," ",m.name," - 历史记录"]})]})}),e.jsx(le,{title:"当前状态概览",style:{marginBottom:"16px"},children:e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:6,children:e.jsx(ge,{title:"策略名称",value:m.strategy_name||"未知"})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:"回测期间",value:`${I(m.start_date).format("YYYY-MM-DD")} 至 ${I(m.end_date).format("YYYY-MM-DD")}`})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:"初始资金",value:`$${m.initial_capital.toLocaleString()}`})}),e.jsx(f,{span:6,children:e.jsx(ge,{title:"当前收益率",value:m.total_return,precision:2,suffix:"%",valueStyle:{color:m.total_return>=0?"#52c41a":"#ff4d4f"}})})]})}),e.jsx(le,{title:e.jsxs(De,{children:[e.jsx(ds,{}),e.jsx("span",{children:"历史记录"})]}),extra:e.jsx(P,{icon:e.jsx(Bs,{}),onClick:pe,loading:o,children:"刷新"}),children:e.jsx(ss,{columns:he,dataSource:D,rowKey:"id",loading:o,pagination:{pageSize:it.getPageSize(20),showSizeChanger:!0,showQuickJumper:!0,showTotal:(b,W)=>`第 ${W[0]}-${W[1]} 条，共 ${b} 条`,onChange:(b,W)=>{it.setCurrentPage(b),it.setPageSize(W||20)},onShowSizeChange:(b,W)=>{it.setPageSize(W)}},scroll:{x:1200}})}),e.jsx(Be,{title:"历史记录详情",open:g,onCancel:()=>$(!1),footer:[e.jsx(P,{onClick:()=>$(!1),children:"关闭"},"close")],width:800,children:T&&e.jsxs("div",{children:[e.jsxs(ut,{bordered:!0,column:2,children:[e.jsx(ut.Item,{label:"记录ID",children:T.id}),e.jsx(ut.Item,{label:"操作类型",children:e.jsx(Le,{color:T.operation_type==="create"?"blue":"orange",children:T.operation_type==="create"?"创建":"更新"})}),e.jsxs(ut.Item,{label:"回测期间",span:2,children:[I(T.start_date).format("YYYY-MM-DD")," 至 ",I(T.end_date).format("YYYY-MM-DD")]}),e.jsxs(ut.Item,{label:"初始资金",children:["$",T.initial_capital.toLocaleString()]}),e.jsx(ut.Item,{label:"状态",children:e.jsx(Le,{color:T.status==="completed"?"green":"red",children:T.status==="completed"?"已完成":"失败"})}),e.jsx(ut.Item,{label:"收益率",children:e.jsxs("span",{style:{color:T.total_return>=0?"#52c41a":"#ff4d4f"},children:[T.total_return>=0?"+":"",T.total_return.toFixed(2),"%"]})}),e.jsx(ut.Item,{label:"最大回撤",children:e.jsxs("span",{style:{color:"#ff4d4f"},children:[T.max_drawdown.toFixed(2),"%"]})}),e.jsx(ut.Item,{label:"创建时间",children:I(T.created_at).format("YYYY-MM-DD HH:mm:ss")}),e.jsx(ut.Item,{label:"完成时间",children:T.completed_at?I(T.completed_at).format("YYYY-MM-DD HH:mm:ss"):"未完成"})]}),T.performance_metrics&&e.jsxs("div",{style:{marginTop:"16px"},children:[e.jsx(ga,{level:5,children:"性能指标"}),e.jsxs(Z,{gutter:16,children:[e.jsx(f,{span:8,children:e.jsx(ge,{title:"累计收益",value:T.total_return!==void 0?T.total_return:(T.performance_metrics.total_return||0)*100,precision:2,suffix:"%"})}),e.jsx(f,{span:8,children:e.jsx(ge,{title:"夏普比率",value:T.performance_metrics.sharpe_ratio||0,precision:3})}),e.jsx(f,{span:8,children:e.jsx(ge,{title:"波动率",value:T.performance_metrics.volatility||0,precision:2,suffix:"%"})}),e.jsx(f,{span:8,children:e.jsx(ge,{title:"胜率",value:T.performance_metrics.win_rate||0,precision:2,suffix:"%"})})]})]})]})})]}):e.jsx("div",{style:{padding:"24px"},children:e.jsx(le,{loading:o,children:e.jsx("div",{style:{textAlign:"center",padding:"50px"},children:e.jsx(Ln,{children:"加载中..."})})})})};const{Content:Fn}=rs,Nn=()=>e.jsx(Ma,{locale:Aa,theme:La,children:e.jsx(fr,{children:e.jsx(Ba,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(rs,{style:{minHeight:"100vh"},children:[e.jsx(br,{}),e.jsxs(rs,{children:[e.jsx(_r,{}),e.jsx(rs,{style:{padding:"24px"},children:e.jsx(Fn,{style:{padding:24,margin:0,minHeight:280,background:"#fff",borderRadius:"8px"},children:e.jsxs(qa,{children:[e.jsx(kt,{path:"/",element:e.jsx(Va,{to:"/dashboard",replace:!0})}),e.jsx(kt,{path:"/dashboard",element:e.jsx(Mr,{})}),e.jsx(kt,{path:"/data",element:e.jsx(Ya,{})}),e.jsx(kt,{path:"/strategy",element:e.jsx(Dn,{})}),e.jsx(kt,{path:"/strategy/edit",element:e.jsx(fa,{})}),e.jsx(kt,{path:"/strategy/edit/:id",element:e.jsx(fa,{})}),e.jsx(kt,{path:"/strategy/builder",element:e.jsx(Jr,{})}),e.jsx(kt,{path:"/backtest",element:e.jsx(fn,{})}),e.jsx(kt,{path:"/backtest/history",element:e.jsx(An,{})}),e.jsx(kt,{path:"/backtest-history/:id",element:e.jsx(Pn,{})}),e.jsx(kt,{path:"/optimization",element:e.jsx(Sn,{})}),e.jsx(kt,{path:"/ai-investment",element:e.jsx(In,{})})]})})})]})]})})})});$a.locale("en-gb");q.defaults.baseURL="http://localhost:8001";Ha.createRoot(document.getElementById("root")).render(e.jsx(Ka.StrictMode,{children:e.jsx(Ma,{locale:Aa,theme:La,children:e.jsx(Nn,{})})}));
